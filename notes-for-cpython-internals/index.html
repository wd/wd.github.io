<!doctype html><html lang=en><head><title>Notes for CPython Internals &ndash; wd and cc</title>
<meta name=description content="Good good study, day day up!"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://wdicc.com/css/palettes/base16-dark.css><link rel=stylesheet href=https://wdicc.com/css/risotto.css><link rel=stylesheet href=https://wdicc.com/css/custom.css><link rel=icon href=https://wdicc.com/favicon.ico></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><h1 class=page__logo><a href=https://wdicc.com/ class=page__logo-inner>wd and cc</a></h1><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/posts/ title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=" title>Search</a></li><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/atom.xml title>subscribe</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Notes for CPython Internals</h1></header><div class=content__body><p>视频地址<a href="https://www.youtube.com/watch?list=PLzV58Zm8FuBL6OAv1Yu6AwXZrnsFbbR0S&amp;index=1">这里</a>。</p><div id=outline-container-headline-1 class=outline-3><h3 id=headline-1>Python 源码</h3><div id=outline-text-headline-1 class=outline-text-3><p><code>Include/opcode.h</code> 里面定义了所有 opcode。 <code>Modules</code> 里面是一些 c 实现的模块， <code>Lib</code> 里面是用 python 实现的模块。 <code>Objects</code> 里面是部分 python 对象对应的 c 实现。</p><p><code>Python</code> 目录里面是 python core， <code>Python/ceval.c</code> 里面定义了 python interpreter 主要的循环，找那个 <code>for(;;)</code> 就可以，这个循环里面有一个巨长的 <code>switch (opcode)</code> 。</p></div></div><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>Opcode 和 interpreter 循环</h3><div id=outline-text-headline-2 class=outline-text-3><p>test.py</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>y <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>print(x <span style=color:#f92672>+</span> y)</span></span></code></pre></div></div><p>使用内置的 <code>compile(source, filename, 'exec')</code> 函数可以把代码编译成 <code>code object</code> , code object 有一个 <code>co_code</code> 属性，里面包含了代码的 bytecode。</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;</span> c <span style=color:#f92672>=</span> compile(open(<span style=color:#e6db74>&#39;test.py&#39;</span>)<span style=color:#f92672>.</span>read(), <span style=color:#e6db74>&#39;test.py&#39;</span>, <span style=color:#e6db74>&#39;exec&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>code object <span style=color:#f92672>&lt;</span>module<span style=color:#f92672>&gt;</span> at <span style=color:#ae81ff>0x102daed20</span>, file <span style=color:#e6db74>&#34;test.py&#34;</span>, line <span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> c<span style=color:#f92672>.</span>co_code
</span></span><span style=display:flex><span><span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;d</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>Z</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>d</span><span style=color:#ae81ff>\x01</span><span style=color:#e6db74>Z</span><span style=color:#ae81ff>\x01</span><span style=color:#e6db74>e</span><span style=color:#ae81ff>\x02</span><span style=color:#e6db74>e</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>e</span><span style=color:#ae81ff>\x01\x17\x00\x83\x01\x01\x00</span><span style=color:#e6db74>d</span><span style=color:#ae81ff>\x02</span><span style=color:#e6db74>S</span><span style=color:#ae81ff>\x00</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> [co <span style=color:#66d9ef>for</span> co <span style=color:#f92672>in</span> c<span style=color:#f92672>.</span>co_code]
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>90</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>90</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>101</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>101</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>101</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>131</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>83</span>, <span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> len(c<span style=color:#f92672>.</span>co_code)
</span></span><span style=display:flex><span><span style=color:#ae81ff>24</span></span></span></code></pre></div></div><p>使用内置的 <code>dis</code> 模块可以直观的看到 opcode。我看<a href=https://docs.python.org/3/library/dis.html>文档</a>说的 3.6 以后每个 code 是 2 个字节。</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ python -m dis test.py
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>1</span>           <span style=color:#ae81ff>0</span> LOAD_CONST               <span style=color:#ae81ff>0</span> <span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>2</span> STORE_NAME               <span style=color:#ae81ff>0</span> <span style=color:#f92672>(</span>x<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span>           <span style=color:#ae81ff>4</span> LOAD_CONST               <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>6</span> STORE_NAME               <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>y<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>3</span>           <span style=color:#ae81ff>8</span> LOAD_NAME                <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>print<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>10</span> LOAD_NAME                <span style=color:#ae81ff>0</span> <span style=color:#f92672>(</span>x<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>12</span> LOAD_NAME                <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>y<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>14</span> BINARY_ADD
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>16</span> CALL_FUNCTION            <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>18</span> POP_TOP
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>20</span> LOAD_CONST               <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>None<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>22</span> RETURN_VALUE</span></span></code></pre></div></div><blockquote><p>Changed in version 3.6: Use 2 bytes for each instruction. Previously the number of bytes varied by instruction.</p></blockquote><p>对应 <code>LOAD_CONST</code> 的 opcode 是 <code>100</code> ，这个可以到 <code>Include/opcode.h</code> 里面查。</p><p>我看 2.7 里面 <code>Python/ceval.c</code> 的 <code>PyEval_EvalFrameEx</code> 这个函数是包含那个死循环的函数，而 3.7 里面是 <code>_PyEval_EvalFrameDefault</code> ，这里面主要包含了那个 <code>for(;;)</code> 循环，输入一个 <code>PyFrameObject</code> ，然后一个个 opcode 处理。 <code>PyObject **stack_pointer; /* Next free slot in value stack */</code> 定义了 value stack，然后这后面定义了一堆的宏，方便写代码。。。后面就是从栈上取到 opcode，取到 oparg ，不同的 opcode 的 arg 数量也不一样，在 opcode.h 里面有定义。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    first_instr <span style=color:#f92672>=</span> (_Py_CODEUNIT <span style=color:#f92672>*</span>) <span style=color:#a6e22e>PyBytes_AS_STRING</span>(co<span style=color:#f92672>-&gt;</span>co_code);
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>    next_instr <span style=color:#f92672>=</span> first_instr;
</span></span><span style=display:flex><span>....
</span></span><span style=display:flex><span>            opcode <span style=color:#f92672>=</span> <span style=color:#a6e22e>_Py_OPCODE</span>(<span style=color:#f92672>*</span>next_instr);</span></span></code></pre></div></div><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define PREDICT(op) \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    do{ \
</span></span></span><span style=display:flex><span><span style=color:#75715e>        _Py_CODEUNIT word = *next_instr; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>        opcode = _Py_OPCODE(word); \
</span></span></span><span style=display:flex><span><span style=color:#75715e>        if (opcode == op){ \
</span></span></span><span style=display:flex><span><span style=color:#75715e>            oparg = _Py_OPARG(word); \
</span></span></span><span style=display:flex><span><span style=color:#75715e>            next_instr++; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>            goto PRED_##op; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>        } \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    } while(0)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define PREDICTED(op)           PRED_##op:</span></span></span></code></pre></div></div><p>opcode 就是从 co_code 里面取到的 bytecode，oparg 类似从 co_code 里面循环取，直到遇到下一个 opcode。</p><p>每个 opcode 可能经过的流程是：</p><ul><li>从 oparg 取变量的值放到 value stack，给下一个 opcode 使用。</li><li>从 value stack 取数据。</li><li>使用 c 的方法做一些运算。</li><li>增减引用计数。</li><li>把结果放回到 value stack。</li></ul><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    co <span style=color:#f92672>=</span> f<span style=color:#f92672>-&gt;</span>f_code;
</span></span><span style=display:flex><span>    names <span style=color:#f92672>=</span> co<span style=color:#f92672>-&gt;</span>co_names;
</span></span><span style=display:flex><span>    consts <span style=color:#f92672>=</span> co<span style=color:#f92672>-&gt;</span>co_consts;
</span></span><span style=display:flex><span>    fastlocals <span style=color:#f92672>=</span> f<span style=color:#f92672>-&gt;</span>f_localsplus;
</span></span><span style=display:flex><span>    freevars <span style=color:#f92672>=</span> f<span style=color:#f92672>-&gt;</span>f_localsplus <span style=color:#f92672>+</span> co<span style=color:#f92672>-&gt;</span>co_nlocals;</span></span></code></pre></div></div><p>从这里能看到 <code>PyFrameObject</code> 包含了 code object，还包含了一些其他的，看着像是变量信息。</p><p>这个网站 <a href="http://www.pythontutor.com/visualize.html#code=def%2520foo%2528%2529%253A%250A%2520%2520%2520%2520x%2520%253D%25201%250A%2520%2520%2520%2520print%25281%2529%250A%2520%2520%2520%2520%250Afoo%2528%2529&amp;cumulative=false&amp;curInstr=4&amp;heapPrimitives=nevernest&amp;mode=display&amp;origin=opt-frontend.js&amp;py=3&amp;rawInputLstJSON=%255B%255D&amp;textReferences=false">pythontutor.com</a> 可以可视化的观看 python 代码执行的情况，和各个 Frame 以及作用域的变量的情况。同时居然还有 Java Tutor, C Tutor, C++ Tutor, JavaScript Tutor, Ruby Tutor 。</p><p>Function 变量（使用 def xxx 创建的变量），实际是对某一个 function object 的引用，里面 code object 似乎应该是 immutable 的，所以相同的代码实际上只需要一个 code object 就可以了。</p><p>在 <code>Include/code.h</code> 里面有 <code>PyCodeObject</code> 的定义。包括了参数数量，代码 bytecode，本地变量信息什么的。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    PyObject_HEAD
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> co_argcount;            <span style=color:#75715e>/* #arguments, except *args */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> co_kwonlyargcount;      <span style=color:#75715e>/* #keyword only arguments */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> co_nlocals;             <span style=color:#75715e>/* #local variables */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> co_stacksize;           <span style=color:#75715e>/* #entries needed for evaluation stack */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> co_flags;               <span style=color:#75715e>/* CO_..., see below */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> co_firstlineno;         <span style=color:#75715e>/* first source line number */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>co_code;          <span style=color:#75715e>/* instruction opcodes */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>co_consts;        <span style=color:#75715e>/* list (constants used) */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>co_names;         <span style=color:#75715e>/* list of strings (names used) */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>co_varnames;      <span style=color:#75715e>/* tuple of strings (local variable names) */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>co_freevars;      <span style=color:#75715e>/* tuple of strings (free variable names) */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>co_cellvars;      <span style=color:#75715e>/* tuple of strings (cell variable names) */</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* The rest aren&#39;t used in either hash or comparisons, except for co_name,
</span></span></span><span style=display:flex><span><span style=color:#75715e>       used in both. This is done to preserve the name and line number
</span></span></span><span style=display:flex><span><span style=color:#75715e>       for tracebacks and debuggers; otherwise, constant de-duplication
</span></span></span><span style=display:flex><span><span style=color:#75715e>       would collapse identical functions/lambdas defined on different lines.
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>    Py_ssize_t <span style=color:#f92672>*</span>co_cell2arg;    <span style=color:#75715e>/* Maps cell vars which are arguments. */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>co_filename;      <span style=color:#75715e>/* unicode (where it was loaded from) */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>co_name;          <span style=color:#75715e>/* unicode (name, for reference) */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>co_lnotab;        <span style=color:#75715e>/* string (encoding addr&lt;-&gt;lineno mapping) See
</span></span></span><span style=display:flex><span><span style=color:#75715e>                                   Objects/lnotab_notes.txt for details. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>co_zombieframe;       <span style=color:#75715e>/* for optimization only (see frameobject.c) */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>co_weakreflist;   <span style=color:#75715e>/* to support weakrefs to code objects */</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Scratch space for extra data relating to the code object.
</span></span></span><span style=display:flex><span><span style=color:#75715e>       Type is a void* to keep the format private in codeobject.c to force
</span></span></span><span style=display:flex><span><span style=color:#75715e>       people to go through the proper APIs. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>co_extra;
</span></span><span style=display:flex><span>} PyCodeObject;</span></span></code></pre></div></div><p>在 <code>Include/frameobject.h</code> 里面有 <code>PyFrameObject</code> 的定义。可以看到包含了一个 <code>PyCodeObject</code> ，还有 <code>*f_globals</code> <code>*f_locals</code> 变量表，每个 frame 有自己的全局本地变量表。 <code>f_back</code> 是上一个 frame 的信息，frame stack 是一个链表。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>ypedef <span style=color:#66d9ef>struct</span> _frame {
</span></span><span style=display:flex><span>    PyObject_VAR_HEAD
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> _frame <span style=color:#f92672>*</span>f_back;      <span style=color:#75715e>/* previous frame, or NULL */</span>
</span></span><span style=display:flex><span>    PyCodeObject <span style=color:#f92672>*</span>f_code;       <span style=color:#75715e>/* code segment */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>f_builtins;       <span style=color:#75715e>/* builtin symbol table (PyDictObject) */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>f_globals;        <span style=color:#75715e>/* global symbol table (PyDictObject) */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>f_locals;         <span style=color:#75715e>/* local symbol table (any mapping) */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>**</span>f_valuestack;    <span style=color:#75715e>/* points after the last local */</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Next free slot in f_valuestack.  Frame creation sets to f_valuestack.
</span></span></span><span style=display:flex><span><span style=color:#75715e>       Frame evaluation usually NULLs it, but a frame that yields sets it
</span></span></span><span style=display:flex><span><span style=color:#75715e>       to the current stack top. */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>**</span>f_stacktop;
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>f_trace;          <span style=color:#75715e>/* Trace function */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> f_trace_lines;         <span style=color:#75715e>/* Emit per-line trace events? */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> f_trace_opcodes;       <span style=color:#75715e>/* Emit per-opcode trace events? */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Borrowed reference to a generator, or NULL */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>f_gen;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> f_lasti;                <span style=color:#75715e>/* Last instruction if called */</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Call PyFrame_GetLineNumber() instead of reading this field
</span></span></span><span style=display:flex><span><span style=color:#75715e>       directly.  As of 2.3 f_lineno is only valid when tracing is
</span></span></span><span style=display:flex><span><span style=color:#75715e>       active (i.e. when f_trace is set).  At other times we use
</span></span></span><span style=display:flex><span><span style=color:#75715e>       PyCode_Addr2Line to calculate the line from the current
</span></span></span><span style=display:flex><span><span style=color:#75715e>       bytecode index. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> f_lineno;               <span style=color:#75715e>/* Current line number */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> f_iblock;               <span style=color:#75715e>/* index in f_blockstack */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> f_executing;           <span style=color:#75715e>/* whether the frame is still executing */</span>
</span></span><span style=display:flex><span>    PyTryBlock f_blockstack[CO_MAXBLOCKS]; <span style=color:#75715e>/* for try and loop blocks */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>f_localsplus[<span style=color:#ae81ff>1</span>];  <span style=color:#75715e>/* locals+stack, dynamically sized */</span>
</span></span><span style=display:flex><span>} PyFrameObject;</span></span></code></pre></div></div><p>所以 <code>PyObject * PyEval_EvalFrameEx(PyFrameObject *f, int throwflag)</code> 接收一个 <code>PyFrameObject</code> 参数，然后处理这个 frame 里面的 bytecodes，然后 return 一个 <code>PyObject</code> 。</p><p>code object 包含代码的字节码，和一些内部的常量信息。function 包含 code object 以及一些环境信息，比如全局变量什么的，就像是一个普通不可变对象。 frame 包含 code object 以及一些环境信息，还有参数信息，是运行时的，同一个 function 可以有不同的 frame ，比如写一个递归函数， function 就那一个，但是每次递归都会产生不同的 frame。frame 很像是一个 function object 的实例，当然实际还有一个 global frame。</p><p>2.7 里面，对于 <code>CALL_FUNCTION</code> 这个 code，会执行 <code>fast_function</code> 这个函数，会使用 <code>PyFrame_New()</code> 创建新的 frame，以及会从 frame 的 stack 复制参数到本地的 stack 创建局部变量。3.7 里面似乎变了。</p></div></div><div id=outline-container-headline-3 class=outline-3><h3 id=headline-3>PyObject</h3><div id=outline-text-headline-3 class=outline-text-3><p>python 3.7 <a href=https://docs.python.org/3/c-api/long.html>没有 PyIntObject 了</a>，2.7 似乎还有。</p><blockquote><p>All integers are implemented as “long” integer objects of arbitrary size.</p></blockquote><p>所以 int 的 add 方法实现是在 <code>Objects/longobject.c</code> 里面。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> PyLongObject <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>x_add</span>(PyLongObject <span style=color:#f92672>*</span>a, PyLongObject <span style=color:#f92672>*</span>b)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Py_ssize_t size_a <span style=color:#f92672>=</span> <span style=color:#a6e22e>Py_ABS</span>(<span style=color:#a6e22e>Py_SIZE</span>(a)), size_b <span style=color:#f92672>=</span> <span style=color:#a6e22e>Py_ABS</span>(<span style=color:#a6e22e>Py_SIZE</span>(b));
</span></span><span style=display:flex><span>    PyLongObject <span style=color:#f92672>*</span>z;
</span></span><span style=display:flex><span>    Py_ssize_t i;
</span></span><span style=display:flex><span>    digit carry <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Ensure a is the larger of the two: */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (size_a <span style=color:#f92672>&lt;</span> size_b) {
</span></span><span style=display:flex><span>        { PyLongObject <span style=color:#f92672>*</span>temp <span style=color:#f92672>=</span> a; a <span style=color:#f92672>=</span> b; b <span style=color:#f92672>=</span> temp; }
</span></span><span style=display:flex><span>        { Py_ssize_t size_temp <span style=color:#f92672>=</span> size_a;
</span></span><span style=display:flex><span>            size_a <span style=color:#f92672>=</span> size_b;
</span></span><span style=display:flex><span>            size_b <span style=color:#f92672>=</span> size_temp; }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    z <span style=color:#f92672>=</span> <span style=color:#a6e22e>_PyLong_New</span>(size_a<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (z <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> size_b; <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>        carry <span style=color:#f92672>+=</span> a<span style=color:#f92672>-&gt;</span>ob_digit[i] <span style=color:#f92672>+</span> b<span style=color:#f92672>-&gt;</span>ob_digit[i];
</span></span><span style=display:flex><span>        z<span style=color:#f92672>-&gt;</span>ob_digit[i] <span style=color:#f92672>=</span> carry <span style=color:#f92672>&amp;</span> PyLong_MASK;
</span></span><span style=display:flex><span>        carry <span style=color:#f92672>&gt;&gt;=</span> PyLong_SHIFT;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (; i <span style=color:#f92672>&lt;</span> size_a; <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>        carry <span style=color:#f92672>+=</span> a<span style=color:#f92672>-&gt;</span>ob_digit[i];
</span></span><span style=display:flex><span>        z<span style=color:#f92672>-&gt;</span>ob_digit[i] <span style=color:#f92672>=</span> carry <span style=color:#f92672>&amp;</span> PyLong_MASK;
</span></span><span style=display:flex><span>        carry <span style=color:#f92672>&gt;&gt;=</span> PyLong_SHIFT;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    z<span style=color:#f92672>-&gt;</span>ob_digit[i] <span style=color:#f92672>=</span> carry;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>long_normalize</span>(z);
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>python 里面万物皆对象，每一个对象都是 <code>PyObject</code> 的子类型。在 <code>Include/object.h</code> 里面有 <code>PyObject</code> 和 <code>PyVarObject</code> 的定义。每个 <code>PyObject</code> 都有一个 refcnt 和 type ，不同的 type 还会有不同的扩展字段。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define _PyObject_HEAD_EXTRA
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _object {
</span></span><span style=display:flex><span>    _PyObject_HEAD_EXTRA
</span></span><span style=display:flex><span>    Py_ssize_t ob_refcnt;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> _typeobject <span style=color:#f92672>*</span>ob_type;
</span></span><span style=display:flex><span>} PyObject;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    PyObject ob_base;
</span></span><span style=display:flex><span>    Py_ssize_t ob_size; <span style=color:#75715e>/* Number of items in variable part */</span>
</span></span><span style=display:flex><span>} PyVarObject;</span></span></code></pre></div></div><p>这个文件前面部分有一些注释，可以一看。每个对象都有一个引用计数字段和 type 字段。引用计数给垃圾回收用的。type 字段定义这具体是个什么类型的数据。对象一旦创建地址和大小就不会变了，这样就让引用一个对象变得简单了，因为不需要因为对象大小改变而需要挪动地方改变地址，这样也不用需要更新所有引用这个地址的变量的引用地址。</p><blockquote><p>An object has a 'reference count' that is increased or decreased when a
pointer to the object is copied or deleted; when the reference count
reaches zero there are no references to the object left and it can be
removed from the heap.</p><p>An object has a 'type' that determines what it represents and what kind
of data it contains. An object's type is fixed when it is created.
Types themselves are represented as objects; an object contains a
pointer to the corresponding type object. The type itself has a type
pointer pointing to the object representing the type 'type', which
contains a pointer to itself!).</p><p>Objects do not float around in memory; once allocated an object keeps
the same size and address. Objects that must hold variable-size data
can contain pointers to variable-size parts of the object. Not all
objects of the same type have the same size; but the size cannot change
after allocation. (These restrictions are made so a reference to an
object can be simply a pointer – moving an object would require
updating all the pointers, and changing an object's size would require
moving it if there was another object right next to it.)</p><p>Objects are always accessed through pointers of the type 'PyObject *'.
The type 'PyObject' is a structure that only contains the reference count
and the type pointer. The actual memory allocated for an object
contains other data that can only be accessed after casting the pointer
to a pointer to a longer structure type. This longer type must start
with the reference count and type fields; the macro PyObject_HEAD should be
used for this (to accommodate for future changes). The implementation
of a particular object type can cast the object pointer to the proper
type and back.</p><p>A standard interface exists for objects that contain an array of items
whose size is determined when the object is allocated.</p></blockquote><p>在 <code>Include/longobject.h</code> 和 <code>Include/longintrepr.h</code> 里面定义了 <code>PyLongObject</code> ，在 <code>PyObject</code> 多了一个 size 和一个 value 字段。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define PyObject_VAR_HEAD      PyVarObject ob_base;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> _longobject {
</span></span><span style=display:flex><span>    PyObject_VAR_HEAD
</span></span><span style=display:flex><span>    digit ob_digit[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _longobject PyLongObject; <span style=color:#75715e>/* Revealed in longintrepr.h */</span></span></span></code></pre></div></div><p>2.7 里面有 <code>PyStringObject</code> ，但是 3.7 里面没有了，后面都是基于 3.7 的代码的。</p><p>我猜是使用 <code>PyUnicodeObject</code> 的。 <code>PyASCIIObject</code> 有一些字段（内容比较长，下面有删节），有一个 <code>interned</code> 表示这个是不是内部提前缓存了，比如常用的字串 'hello' 这个对象会提前生成好。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    PyObject_HEAD
</span></span><span style=display:flex><span>    Py_ssize_t length;          <span style=color:#75715e>/* Number of code points in the string */</span>
</span></span><span style=display:flex><span>    Py_hash_t hash;             <span style=color:#75715e>/* Hash value; -1 if not set */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>           SSTATE_NOT_INTERNED (0)
</span></span></span><span style=display:flex><span><span style=color:#75715e>           SSTATE_INTERNED_MORTAL (1)
</span></span></span><span style=display:flex><span><span style=color:#75715e>           SSTATE_INTERNED_IMMORTAL (2)
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>           If interned != SSTATE_NOT_INTERNED, the two references from the
</span></span></span><span style=display:flex><span><span style=color:#75715e>           dictionary to this object are *not* counted in ob_refcnt.
</span></span></span><span style=display:flex><span><span style=color:#75715e>         */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> interned:<span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>       <span style=color:#75715e>/* Character size:
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>           - PyUnicode_WCHAR_KIND (0):
</span></span></span><span style=display:flex><span><span style=color:#75715e>           - PyUnicode_1BYTE_KIND (1):
</span></span></span><span style=display:flex><span><span style=color:#75715e>           - PyUnicode_2BYTE_KIND (2):
</span></span></span><span style=display:flex><span><span style=color:#75715e>           - PyUnicode_4BYTE_KIND (4):
</span></span></span><span style=display:flex><span><span style=color:#75715e>        */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> kind:<span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> compact:<span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> ascii:<span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> ready:<span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>:</span><span style=color:#ae81ff>24</span>;
</span></span><span style=display:flex><span>   } state;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>wchar_t</span> <span style=color:#f92672>*</span>wstr;              <span style=color:#75715e>/* wchar_t representation (null-terminated) */</span>
</span></span><span style=display:flex><span>} PyASCIIObject;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span><span style=color:#75715e>/* Non-ASCII strings allocated through PyUnicode_New use the
</span></span></span><span style=display:flex><span><span style=color:#75715e>   PyCompactUnicodeObject structure. state.compact is set, and the data
</span></span></span><span style=display:flex><span><span style=color:#75715e>   immediately follow the structure. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    PyASCIIObject _base;
</span></span><span style=display:flex><span>    Py_ssize_t utf8_length;     <span style=color:#75715e>/* Number of bytes in utf8, excluding the
</span></span></span><span style=display:flex><span><span style=color:#75715e>                                 * terminating \0. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>utf8;                 <span style=color:#75715e>/* UTF-8 representation (null-terminated) */</span>
</span></span><span style=display:flex><span>    Py_ssize_t wstr_length;     <span style=color:#75715e>/* Number of code points in wstr, possible
</span></span></span><span style=display:flex><span><span style=color:#75715e>                                 * surrogates count as two code points. */</span>
</span></span><span style=display:flex><span>} PyCompactUnicodeObject;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* Strings allocated through PyUnicode_FromUnicode(NULL, len) use the
</span></span></span><span style=display:flex><span><span style=color:#75715e>   PyUnicodeObject structure. The actual string data is initially in the wstr
</span></span></span><span style=display:flex><span><span style=color:#75715e>   block, and copied into the data block using _PyUnicode_Ready. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    PyCompactUnicodeObject _base;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>any;
</span></span><span style=display:flex><span>        Py_UCS1 <span style=color:#f92672>*</span>latin1;
</span></span><span style=display:flex><span>        Py_UCS2 <span style=color:#f92672>*</span>ucs2;
</span></span><span style=display:flex><span>        Py_UCS4 <span style=color:#f92672>*</span>ucs4;
</span></span><span style=display:flex><span>    } data;                     <span style=color:#75715e>/* Canonical, smallest-form Unicode buffer */</span>
</span></span><span style=display:flex><span>} PyUnicodeObject;</span></span></code></pre></div></div><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;hello&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> b<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;hello&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a <span style=color:#f92672>is</span> b
</span></span><span style=display:flex><span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> id(a)
</span></span><span style=display:flex><span><span style=color:#ae81ff>4439401168</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> id(b)
</span></span><span style=display:flex><span><span style=color:#ae81ff>4439401168</span></span></span></code></pre></div></div><p>对于字符串 <code>==</code> 操作， <code>COMPARE_OP</code> 从 <code>Python/ceval.c</code> 里面，然后调用 <code>cmp_outcome</code> 然后调用 <code>Objects/object.c</code> 里面的 <code>PyObject_RichCompare -> do_richcompare</code> 。然后会调用 <code>v->ob_type->tp_richcompare</code> ，然后会到 <code>Objects/unicodeobject.c</code> 里面的 <code>PyUnicode_RichCompare</code></p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>        <span style=color:#a6e22e>TARGET</span>(COMPARE_OP) {
</span></span><span style=display:flex><span>            PyObject <span style=color:#f92672>*</span>right <span style=color:#f92672>=</span> <span style=color:#a6e22e>POP</span>();
</span></span><span style=display:flex><span>            PyObject <span style=color:#f92672>*</span>left <span style=color:#f92672>=</span> <span style=color:#a6e22e>TOP</span>();
</span></span><span style=display:flex><span>            PyObject <span style=color:#f92672>*</span>res <span style=color:#f92672>=</span> <span style=color:#a6e22e>cmp_outcome</span>(oparg, left, right);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Py_DECREF</span>(left);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Py_DECREF</span>(right);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>SET_TOP</span>(res);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (res <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>goto</span> error;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>PREDICT</span>(POP_JUMP_IF_FALSE);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>PREDICT</span>(POP_JUMP_IF_TRUE);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>DISPATCH</span>();
</span></span><span style=display:flex><span>        }</span></span></code></pre></div></div><p>会先比较地址，然后使用 <code>unicode_compare_eq</code> 这个会先比较长度，如果长度一样，继续使用 <code>PyUnicode_KIND</code> 比较下 <code>kind</code> ， kind 可以看前面 struct 里面定义的， 然后会使用 <code>memcmp</code> 。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>PyObject <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PyUnicode_RichCompare</span>(PyObject <span style=color:#f92672>*</span>left, PyObject <span style=color:#f92672>*</span>right, <span style=color:#66d9ef>int</span> op)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> result;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>PyUnicode_Check</span>(left) <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>PyUnicode_Check</span>(right))
</span></span><span style=display:flex><span>        Py_RETURN_NOTIMPLEMENTED;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>PyUnicode_READY</span>(left) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PyUnicode_READY</span>(right) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (left <span style=color:#f92672>==</span> right) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (op) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Py_EQ:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Py_LE:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Py_GE:
</span></span><span style=display:flex><span>            <span style=color:#75715e>/* a string is equal to itself */</span>
</span></span><span style=display:flex><span>            Py_RETURN_TRUE;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Py_NE:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Py_LT:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> Py_GT:
</span></span><span style=display:flex><span>            Py_RETURN_FALSE;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>PyErr_BadArgument</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (op <span style=color:#f92672>==</span> Py_EQ <span style=color:#f92672>||</span> op <span style=color:#f92672>==</span> Py_NE) {
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> <span style=color:#a6e22e>unicode_compare_eq</span>(left, right);
</span></span><span style=display:flex><span>        result <span style=color:#f92672>^=</span> (op <span style=color:#f92672>==</span> Py_NE);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>PyBool_FromLong</span>(result);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        result <span style=color:#f92672>=</span> <span style=color:#a6e22e>unicode_compare</span>(left, right);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Py_RETURN_RICHCOMPARE</span>(result, <span style=color:#ae81ff>0</span>, op);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>对于 code object 也有一个 <code>code_richcompare</code> ，会逐个比较 name, argcount, locales, constants 等等。</p></div></div><div id=outline-container-headline-4 class=outline-3><h3 id=headline-4>Code Object, Function Object, closures</h3><div id=outline-text-headline-4 class=outline-text-3><p><code>PyFunctionObject</code> 定义在 <code>Include/funcobject.h</code> 里面。 code 是一个 code object，globals 是全局变量，defaults 是默认参数。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    PyObject_HEAD
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func_code;        <span style=color:#75715e>/* A code object, the __code__ attribute */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func_globals;     <span style=color:#75715e>/* A dictionary (other mappings won&#39;t do) */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func_defaults;    <span style=color:#75715e>/* NULL or a tuple */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func_kwdefaults;  <span style=color:#75715e>/* NULL or a dict */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func_closure;     <span style=color:#75715e>/* NULL or a tuple of cell objects */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func_doc;         <span style=color:#75715e>/* The __doc__ attribute, can be anything */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func_name;        <span style=color:#75715e>/* The __name__ attribute, a string object */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func_dict;        <span style=color:#75715e>/* The __dict__ attribute, a dict or NULL */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func_weakreflist; <span style=color:#75715e>/* List of weak references */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func_module;      <span style=color:#75715e>/* The __module__ attribute, can be anything */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func_annotations; <span style=color:#75715e>/* Annotations, a dict or NULL */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func_qualname;    <span style=color:#75715e>/* The qualified name */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Invariant:
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *     func_closure contains the bindings for func_code-&gt;co_freevars, so
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *     PyTuple_Size(func_closure) == PyCode_GetNumFree(func_code)
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *     (func_closure may be NULL if PyCode_GetNumFree(func_code) == 0).
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>} PyFunctionObject;</span></span></code></pre></div></div><p>使用 <code>PyFunction_New</code> 创建 <code>PyFunctionObject</code> ，可以看到输入是 code object 和 global 环境。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>PyObject <span style=color:#f92672>*</span> <span style=color:#a6e22e>PyFunction_New</span>(PyObject <span style=color:#f92672>*</span>code, PyObject <span style=color:#f92672>*</span>globals)</span></span></code></pre></div></div><p>对 function object 的一些属性的定义，有的是只读的，有的可以修改。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> PyMemberDef func_memberlist[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;__closure__&#34;</span>,   T_OBJECT,     <span style=color:#a6e22e>OFF</span>(func_closure),
</span></span><span style=display:flex><span>     RESTRICTED<span style=color:#f92672>|</span>READONLY},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;__doc__&#34;</span>,       T_OBJECT,     <span style=color:#a6e22e>OFF</span>(func_doc), PY_WRITE_RESTRICTED},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;__globals__&#34;</span>,   T_OBJECT,     <span style=color:#a6e22e>OFF</span>(func_globals),
</span></span><span style=display:flex><span>     RESTRICTED<span style=color:#f92672>|</span>READONLY},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;__module__&#34;</span>,    T_OBJECT,     <span style=color:#a6e22e>OFF</span>(func_module), PY_WRITE_RESTRICTED},
</span></span><span style=display:flex><span>    {NULL}  <span style=color:#75715e>/* Sentinel */</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> PyGetSetDef func_getsetlist[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;__code__&#34;</span>, (getter)func_get_code, (setter)func_set_code},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;__defaults__&#34;</span>, (getter)func_get_defaults,
</span></span><span style=display:flex><span>     (setter)func_set_defaults},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;__kwdefaults__&#34;</span>, (getter)func_get_kwdefaults,
</span></span><span style=display:flex><span>     (setter)func_set_kwdefaults},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;__annotations__&#34;</span>, (getter)func_get_annotations,
</span></span><span style=display:flex><span>     (setter)func_set_annotations},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;__dict__&#34;</span>, PyObject_GenericGetDict, PyObject_GenericSetDict},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;__name__&#34;</span>, (getter)func_get_name, (setter)func_set_name},
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;__qualname__&#34;</span>, (getter)func_get_qualname, (setter)func_set_qualname},
</span></span><span style=display:flex><span>    {NULL} <span style=color:#75715e>/* Sentinel */</span>
</span></span><span style=display:flex><span>};</span></span></code></pre></div></div><p><code>tp_call</code> 是函数被 call 的时候调用的，对应的是 <code>function_call</code> 这个方法，这里面会继续调用 <code>Objects/call.c</code> 里面的 <code>_PyFunction_FastCallDict</code> 继续调用 <code>Python/ceval.c</code> 的 <code>_PyEval_EvalCodeWithName -> PyEval_EvalFrameEx</code> ，最终回到了 <code>PyEval_EvalFrameEx</code> 这个调用。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>function_call</span>(PyObject <span style=color:#f92672>*</span>func, PyObject <span style=color:#f92672>*</span>args, PyObject <span style=color:#f92672>*</span>kwargs)</span></span></code></pre></div></div><p>test.py 如下</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>x <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>foo</span>(x):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>bar</span>(y):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> bar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>b1 <span style=color:#f92672>=</span> foo(<span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>b2 <span style=color:#f92672>=</span> foo(<span style=color:#ae81ff>20</span>)</span></span></code></pre></div></div><p><a href="http://www.pythontutor.com/visualize.html#code=x%2520%253D%252050%250A%250Adef%2520foo%2528x%2529%253A%250A%2520%2520%2520%2520def%2520bar%2528y%2529%253A%250A%2520%2520%2520%2520%2520%2520%2520%2520return%2520x%2520%252B%2520y%250A%2520%2520%2520%2520return%2520bar%250A%250Ab1%2520%253D%2520foo%252810%2529%250Ab2%2520%253D%2520foo%252820%2529&amp;cumulative=false&amp;curInstr=10&amp;heapPrimitives=nevernest&amp;mode=display&amp;origin=opt-frontend.js&amp;py=3&amp;rawInputLstJSON=%255B%255D&amp;textReferences=false">可视化</a>，可以看到每次函数调用都会创建一个 frame，并且 closure 因为引用了外函数的局部变量，会导致外部函数不能回收（灰色的部分）。</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> test
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> dis
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> dis<span style=color:#f92672>.</span>dis(test)
</span></span><span style=display:flex><span>Disassembly of b1:
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>5</span>           <span style=color:#ae81ff>0</span> LOAD_DEREF               <span style=color:#ae81ff>0</span> (x)
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>2</span> LOAD_FAST                <span style=color:#ae81ff>0</span> (y)
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>4</span> BINARY_ADD
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>6</span> RETURN_VALUE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Disassembly of b2:
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>5</span>           <span style=color:#ae81ff>0</span> LOAD_DEREF               <span style=color:#ae81ff>0</span> (x)
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>2</span> LOAD_FAST                <span style=color:#ae81ff>0</span> (y)
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>4</span> BINARY_ADD
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>6</span> RETURN_VALUE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Disassembly of foo:
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>4</span>           <span style=color:#ae81ff>0</span> LOAD_CLOSURE             <span style=color:#ae81ff>0</span> (x)
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>2</span> BUILD_TUPLE              <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>4</span> LOAD_CONST               <span style=color:#ae81ff>1</span> (<span style=color:#f92672>&lt;</span>code object bar at <span style=color:#ae81ff>0x10eae4420</span>, file <span style=color:#e6db74>&#34;/Users/wd/t/test.py&#34;</span>, line <span style=color:#ae81ff>4</span><span style=color:#f92672>&gt;</span>)
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>6</span> LOAD_CONST               <span style=color:#ae81ff>2</span> (<span style=color:#e6db74>&#39;foo.&lt;locals&gt;.bar&#39;</span>)
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>8</span> MAKE_FUNCTION            <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>10</span> STORE_FAST               <span style=color:#ae81ff>1</span> (bar)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>6</span>          <span style=color:#ae81ff>12</span> LOAD_FAST                <span style=color:#ae81ff>1</span> (bar)
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>14</span> RETURN_VALUE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Disassembly of <span style=color:#f92672>&lt;</span>code object bar at <span style=color:#ae81ff>0x10eae4420</span>, file <span style=color:#e6db74>&#34;/Users/wd/t/test.py&#34;</span>, line <span style=color:#ae81ff>4</span><span style=color:#f92672>&gt;</span>:
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>5</span>           <span style=color:#ae81ff>0</span> LOAD_DEREF               <span style=color:#ae81ff>0</span> (x)
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>2</span> LOAD_FAST                <span style=color:#ae81ff>0</span> (y)
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>4</span> BINARY_ADD
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>6</span> RETURN_VALUE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> test<span style=color:#f92672>.</span>b1
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>function foo<span style=color:#f92672>.&lt;</span>locals<span style=color:#f92672>&gt;.</span>bar at <span style=color:#ae81ff>0x10eb1c378</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> test<span style=color:#f92672>.</span>b2
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>function foo<span style=color:#f92672>.&lt;</span>locals<span style=color:#f92672>&gt;.</span>bar at <span style=color:#ae81ff>0x10eb1c400</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> test<span style=color:#f92672>.</span>b1 <span style=color:#f92672>==</span> test<span style=color:#f92672>.</span>b2
</span></span><span style=display:flex><span><span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> test<span style=color:#f92672>.</span>b1<span style=color:#f92672>.</span>__code__
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>code object bar at <span style=color:#ae81ff>0x10eae4420</span>, file <span style=color:#e6db74>&#34;/Users/wd/t/test.py&#34;</span>, line <span style=color:#ae81ff>4</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> test<span style=color:#f92672>.</span>b1<span style=color:#f92672>.</span>__code__ <span style=color:#f92672>==</span> test<span style=color:#f92672>.</span>b2<span style=color:#f92672>.</span>__code__
</span></span><span style=display:flex><span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> test<span style=color:#f92672>.</span>b1<span style=color:#f92672>.</span>__code__ <span style=color:#f92672>is</span> test<span style=color:#f92672>.</span>b2<span style=color:#f92672>.</span>__code__
</span></span><span style=display:flex><span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> test<span style=color:#f92672>.</span>b1<span style=color:#f92672>.</span>__closure__[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>cell_contents
</span></span><span style=display:flex><span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> test<span style=color:#f92672>.</span>b2<span style=color:#f92672>.</span>__closure__[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>cell_contents
</span></span><span style=display:flex><span><span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> test<span style=color:#f92672>.</span>b1<span style=color:#f92672>.</span>__code__<span style=color:#f92672>.</span>co_freevars
</span></span><span style=display:flex><span>(<span style=color:#e6db74>&#39;x&#39;</span>,)</span></span></code></pre></div></div><p>code 里面包含 x 这个 freevar，参考前面 PyFunctionObject 的定义，里面有一段 <code>func_closure contains the bindings for func_code->co_freevars</code> 。</p><p>上面这个例子里面，x 是通过 <code>LOAD_DEREF</code> 里面调用 <code>PyCell_GET</code> 取到的，是从那个 cell 里面取到的。感觉似乎是意思是说，普通 function 和 closure 的区别是 closure 包含了一个 <code>__closure__</code> 属性里面包含了对变量的引用。</p></div></div><div id=outline-container-headline-5 class=outline-3><h3 id=headline-5>Iterators</h3><div id=outline-text-headline-5 class=outline-text-3><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> i <span style=color:#f92672>=</span> a<span style=color:#f92672>.</span>__iter__()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> i
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>list_iterator object at <span style=color:#ae81ff>0x10819a0b8</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> j <span style=color:#f92672>=</span> a<span style=color:#f92672>.</span>__iter__()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> j
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>list_iterator object at <span style=color:#ae81ff>0x10819a1d0</span><span style=color:#f92672>&gt;</span></span></span></code></pre></div></div><p>i 和 j 分别是不同的 iterator object。下面是 test.py</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>a <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;a&#39;</span>, <span style=color:#e6db74>&#39;b&#39;</span>, <span style=color:#e6db74>&#39;c&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> e <span style=color:#f92672>in</span> a:
</span></span><span style=display:flex><span>    print(e)</span></span></code></pre></div></div><p>这个是字节码，GET_ITER 生成一个 iterator object，这个会调用 <code>Objects/abstract.c</code> 里面的 <code>PyObject_GetIter</code> 。</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  1           0 LOAD_CONST               0 (&#39;a&#39;)
</span></span><span style=display:flex><span>              2 LOAD_CONST               1 (&#39;b&#39;)
</span></span><span style=display:flex><span>              4 LOAD_CONST               2 (&#39;c&#39;)
</span></span><span style=display:flex><span>              6 BUILD_LIST               3
</span></span><span style=display:flex><span>              8 STORE_NAME               0 (a)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  2          10 SETUP_LOOP              20 (to 32)
</span></span><span style=display:flex><span>             12 LOAD_NAME                0 (a)
</span></span><span style=display:flex><span>             14 GET_ITER
</span></span><span style=display:flex><span>        &gt;&gt;   16 FOR_ITER                12 (to 30)
</span></span><span style=display:flex><span>             18 STORE_NAME               1 (e)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  3          20 LOAD_NAME                2 (print)
</span></span><span style=display:flex><span>             22 LOAD_NAME                1 (e)
</span></span><span style=display:flex><span>             24 CALL_FUNCTION            1
</span></span><span style=display:flex><span>             26 POP_TOP
</span></span><span style=display:flex><span>             28 JUMP_ABSOLUTE           16
</span></span><span style=display:flex><span>        &gt;&gt;   30 POP_BLOCK
</span></span><span style=display:flex><span>        &gt;&gt;   32 LOAD_CONST               3 (None)
</span></span><span style=display:flex><span>             34 RETURN_VALUE</span></span></code></pre></div></div><p>首先会看看是不是有 <code>tp_iter</code> 定义，内置的 sequance 对象没有，然后会使用 <code>PySeqIter_New</code> 生成 sequance object.</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>PyObject <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PyObject_GetIter</span>(PyObject <span style=color:#f92672>*</span>o)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    PyTypeObject <span style=color:#f92672>*</span>t <span style=color:#f92672>=</span> o<span style=color:#f92672>-&gt;</span>ob_type;
</span></span><span style=display:flex><span>    getiterfunc f;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    f <span style=color:#f92672>=</span> t<span style=color:#f92672>-&gt;</span>tp_iter;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (f <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>PySequence_Check</span>(o))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>PySeqIter_New</span>(o);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>type_error</span>(<span style=color:#e6db74>&#34;&#39;%.200s&#39; object is not iterable&#34;</span>, o);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        PyObject <span style=color:#f92672>*</span>res <span style=color:#f92672>=</span> (<span style=color:#f92672>*</span>f)(o);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (res <span style=color:#f92672>!=</span> NULL <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>PyIter_Check</span>(res)) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>PyErr_Format</span>(PyExc_TypeError,
</span></span><span style=display:flex><span>                         <span style=color:#e6db74>&#34;iter() returned non-iterator &#34;</span>
</span></span><span style=display:flex><span>                         <span style=color:#e6db74>&#34;of type &#39;%.100s&#39;&#34;</span>,
</span></span><span style=display:flex><span>                         res<span style=color:#f92672>-&gt;</span>ob_type<span style=color:#f92672>-&gt;</span>tp_name);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Py_DECREF</span>(res);
</span></span><span style=display:flex><span>            res <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> res;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>这个 object 里面，it_index 初始化的时候指向了 0 ，it_seq 指向那个输入的 seq。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    PyObject_HEAD
</span></span><span style=display:flex><span>    Py_ssize_t it_index;
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>it_seq; <span style=color:#75715e>/* Set to NULL when iterator is exhausted */</span>
</span></span><span style=display:flex><span>} seqiterobject;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PyObject <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PySeqIter_New</span>(PyObject <span style=color:#f92672>*</span>seq)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    seqiterobject <span style=color:#f92672>*</span>it;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>PySequence_Check</span>(seq)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PyErr_BadInternalCall</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    it <span style=color:#f92672>=</span> <span style=color:#a6e22e>PyObject_GC_New</span>(seqiterobject, <span style=color:#f92672>&amp;</span>PySeqIter_Type);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (it <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>    it<span style=color:#f92672>-&gt;</span>it_index <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Py_INCREF</span>(seq);
</span></span><span style=display:flex><span>    it<span style=color:#f92672>-&gt;</span>it_seq <span style=color:#f92672>=</span> seq;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_PyObject_GC_TRACK</span>(it);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (PyObject <span style=color:#f92672>*</span>)it;
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>迭代的时候，主要调用的是 <code>FOR_ITER</code> ，会调用 <code>tp_iternext</code> ，对于列表来说是 <code>Objects/iterobject.c</code> 里面的 <code>iter_iternext</code> 方法。里面主要就是 <code>PySequence_GetItem(seq, it->it_index)</code> 会根据 index 获取元素，成功之后还会自增 index。如果 result 是 NULL 会把 it_seq 设置为 NULL，然后返回一个 NULL。 <code>FOR_ITER</code> 遇到 NULL 会根据代码有无 try except 决定是抛异常还是到 expect 处理。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>tatic PyObject <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>iter_iternext</span>(PyObject <span style=color:#f92672>*</span>iterator)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    seqiterobject <span style=color:#f92672>*</span>it;
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>seq;
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>result;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>(<span style=color:#a6e22e>PySeqIter_Check</span>(iterator));
</span></span><span style=display:flex><span>    it <span style=color:#f92672>=</span> (seqiterobject <span style=color:#f92672>*</span>)iterator;
</span></span><span style=display:flex><span>    seq <span style=color:#f92672>=</span> it<span style=color:#f92672>-&gt;</span>it_seq;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (seq <span style=color:#f92672>==</span> NULL)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (it<span style=color:#f92672>-&gt;</span>it_index <span style=color:#f92672>==</span> PY_SSIZE_T_MAX) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PyErr_SetString</span>(PyExc_OverflowError,
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;iter index too large&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> <span style=color:#a6e22e>PySequence_GetItem</span>(seq, it<span style=color:#f92672>-&gt;</span>it_index);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (result <span style=color:#f92672>!=</span> NULL) {
</span></span><span style=display:flex><span>        it<span style=color:#f92672>-&gt;</span>it_index<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>PyErr_ExceptionMatches</span>(PyExc_IndexError) <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PyErr_ExceptionMatches</span>(PyExc_StopIteration))
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PyErr_Clear</span>();
</span></span><span style=display:flex><span>        it<span style=color:#f92672>-&gt;</span>it_seq <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Py_DECREF</span>(seq);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> NULL;
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>如果是自己实现一个可迭代的对象，需要实现 <code>__iter__</code> 方法，提供一个返回 iter object 的方法，返回的这个 object 需要有 <code>__next__</code> 方法（python2 是 <code>next</code> 方法）。还需要注意适当的时候抛出 <code>StopIteration</code> 异常。</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Counter</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, low, high):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>cur <span style=color:#f92672>=</span> low
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>high <span style=color:#f92672>=</span> high
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __iter__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __next__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>cur <span style=color:#f92672>&gt;</span> self<span style=color:#f92672>.</span>high:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>StopIteration</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>cur <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>cur <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span></span></span></code></pre></div></div><p>主要的字节码如下，类似内置的支持迭代的对象，也会有 GET_ITER 和 FOR_ITER ，还内置的并没有区别。</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>  1           0 LOAD_BUILD_CLASS
</span></span><span style=display:flex><span>              2 LOAD_CONST               0 (&lt;code object Counter at 0x108e494b0, file &#34;test.py&#34;, line 1&gt;)
</span></span><span style=display:flex><span>              4 LOAD_CONST               1 (&#39;Counter&#39;)
</span></span><span style=display:flex><span>              6 MAKE_FUNCTION            0
</span></span><span style=display:flex><span>              8 LOAD_CONST               1 (&#39;Counter&#39;)
</span></span><span style=display:flex><span>             10 LOAD_NAME                0 (object)
</span></span><span style=display:flex><span>             12 CALL_FUNCTION            3
</span></span><span style=display:flex><span>             14 STORE_NAME               1 (Counter)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> 16          16 LOAD_NAME                1 (Counter)
</span></span><span style=display:flex><span>             18 LOAD_CONST               2 (3)
</span></span><span style=display:flex><span>             20 LOAD_CONST               3 (6)
</span></span><span style=display:flex><span>             22 CALL_FUNCTION            2
</span></span><span style=display:flex><span>             24 STORE_NAME               2 (a)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> 17          26 SETUP_LOOP              20 (to 48)
</span></span><span style=display:flex><span>             28 LOAD_NAME                2 (a)
</span></span><span style=display:flex><span>             30 GET_ITER
</span></span><span style=display:flex><span>        &gt;&gt;   32 FOR_ITER                12 (to 46)
</span></span><span style=display:flex><span>             34 STORE_NAME               3 (elt)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> 18          36 LOAD_NAME                4 (print)
</span></span><span style=display:flex><span>             38 LOAD_NAME                3 (elt)
</span></span><span style=display:flex><span>             40 CALL_FUNCTION            1
</span></span><span style=display:flex><span>             42 POP_TOP
</span></span><span style=display:flex><span>             44 JUMP_ABSOLUTE           32
</span></span><span style=display:flex><span>        &gt;&gt;   46 POP_BLOCK
</span></span><span style=display:flex><span>        &gt;&gt;   48 LOAD_CONST               4 (None)
</span></span><span style=display:flex><span>             50 RETURN_VALUE</span></span></code></pre></div></div></div></div><div id=outline-container-headline-6 class=outline-3><h3 id=headline-6>User-defined classes and objects</h3><div id=outline-text-headline-6 class=outline-text-3><p>python 对象的属性是存在一个字典里面，所以可以方便的任意增减。</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> test <span style=color:#f92672>import</span> Counter
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a  <span style=color:#f92672>=</span> Counter(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>Counter object at <span style=color:#ae81ff>0x10d7fa0b8</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a<span style=color:#f92672>.</span>__dict__
</span></span><span style=display:flex><span>{<span style=color:#e6db74>&#39;cur&#39;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;high&#39;</span>: <span style=color:#ae81ff>3</span>}
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a<span style=color:#f92672>.</span>ff <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a<span style=color:#f92672>.</span>__dict__
</span></span><span style=display:flex><span>{<span style=color:#e6db74>&#39;cur&#39;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;high&#39;</span>: <span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#39;ff&#39;</span>: <span style=color:#ae81ff>3</span>}
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#66d9ef>del</span> a<span style=color:#f92672>.</span>ff
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> a<span style=color:#f92672>.</span>__dict__
</span></span><span style=display:flex><span>{<span style=color:#e6db74>&#39;cur&#39;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;high&#39;</span>: <span style=color:#ae81ff>3</span>}</span></span></code></pre></div></div><p>创建对象的时候是使用 <code>LOAD_BUILD_CLASS</code> 。</p><blockquote><p>Pushes builtins.__build_class__() onto the stack. It is later called by CALL_FUNCTION to construct a class.</p></blockquote><p>然后 python 3 没有 <code>PyClassObject</code> 了，迁移到了 <code>PyTypeObject</code> ，在 <code>Objects/object.h</code> 里面定义。下面两个是 <code>PyMethodObject</code> 和 <code>PyInstanceMethodObject</code> 。类实例化的时候，会调用 <code>tp_new -> method_new -> PyMethod_New</code> ，然后会返回一个 <code>PyMethodObject</code> 。这样对应的还有一套 <code>tp_new -> instancemethod_new -> PyInstanceMethod_New</code> ，返回的是 <code>PyInstanceMethodObject</code> 。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    PyObject_HEAD
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>im_func;   <span style=color:#75715e>/* The callable object implementing the method */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>im_self;   <span style=color:#75715e>/* The instance it is bound to */</span>
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>im_weakreflist; <span style=color:#75715e>/* List of weak references */</span>
</span></span><span style=display:flex><span>} PyMethodObject;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    PyObject_HEAD
</span></span><span style=display:flex><span>    PyObject <span style=color:#f92672>*</span>func;
</span></span><span style=display:flex><span>} PyInstanceMethodObject;</span></span></code></pre></div></div><p>这两个的区别代码里面有简单的写了一句，还不是特别清楚是什么具体区别，看着感觉像是实例方法和类方法的区别。 <code>PyMethod_New</code> 返回的是一个带了 self, weakreflist 这些内容的对象。 <code>PyInstanceMethod_New</code> 只是返回了一个方法。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* Method objects are used for bound instance methods returned by
</span></span></span><span style=display:flex><span><span style=color:#75715e>   instancename.methodname. ClassName.methodname returns an ordinary
</span></span></span><span style=display:flex><span><span style=color:#75715e>   function.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>PyObject <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PyMethod_New</span>(PyObject <span style=color:#f92672>*</span>func, PyObject <span style=color:#f92672>*</span>self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// instance method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>PyInstanceMethod_New</span>(PyObject <span style=color:#f92672>*</span>func) {</span></span></code></pre></div></div><p>给前面的 Counter 加一个 <code>test</code> 方法，看下面的 bound method 和 unbound method 应该就是上面的 PyMethod 和 PyInstancemethod 的区别吧。</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>from</span> test <span style=color:#f92672>import</span> Counter
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> Counter
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#a6e22e>test</span><span style=color:#f92672>.</span>Counter<span style=color:#e6db74>&#39;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> dir(Counter)
</span></span><span style=display:flex><span>[<span style=color:#e6db74>&#39;__class__&#39;</span>, <span style=color:#e6db74>&#39;__delattr__&#39;</span>, <span style=color:#e6db74>&#39;__dict__&#39;</span>, <span style=color:#e6db74>&#39;__dir__&#39;</span>, <span style=color:#e6db74>&#39;__doc__&#39;</span>, <span style=color:#e6db74>&#39;__eq__&#39;</span>, <span style=color:#e6db74>&#39;__format__&#39;</span>, <span style=color:#e6db74>&#39;__ge__&#39;</span>, <span style=color:#e6db74>&#39;__getattribute__&#39;</span>, <span style=color:#e6db74>&#39;__gt__&#39;</span>, <span style=color:#e6db74>&#39;__hash__&#39;</span>, <span style=color:#e6db74>&#39;__init__&#39;</span>, <span style=color:#e6db74>&#39;__init_subclass__&#39;</span>, <span style=color:#e6db74>&#39;__iter__&#39;</span>, <span style=color:#e6db74>&#39;__le__&#39;</span>, <span style=color:#e6db74>&#39;__lt__&#39;</span>, <span style=color:#e6db74>&#39;__module__&#39;</span>, <span style=color:#e6db74>&#39;__ne__&#39;</span>, <span style=color:#e6db74>&#39;__new__&#39;</span>, <span style=color:#e6db74>&#39;__next__&#39;</span>, <span style=color:#e6db74>&#39;__reduce__&#39;</span>, <span style=color:#e6db74>&#39;__reduce_ex__&#39;</span>, <span style=color:#e6db74>&#39;__repr__&#39;</span>, <span style=color:#e6db74>&#39;__setattr__&#39;</span>, <span style=color:#e6db74>&#39;__sizeof__&#39;</span>, <span style=color:#e6db74>&#39;__str__&#39;</span>, <span style=color:#e6db74>&#39;__subclasshook__&#39;</span>, <span style=color:#e6db74>&#39;__weakref__&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> Counter<span style=color:#f92672>.</span>__dict__
</span></span><span style=display:flex><span>mappingproxy({<span style=color:#e6db74>&#39;__module__&#39;</span>: <span style=color:#e6db74>&#39;test&#39;</span>, <span style=color:#e6db74>&#39;__init__&#39;</span>: <span style=color:#f92672>&lt;</span>function Counter<span style=color:#f92672>.</span>__init__ at <span style=color:#ae81ff>0x102043378</span><span style=color:#f92672>&gt;</span>, <span style=color:#e6db74>&#39;__iter__&#39;</span>: <span style=color:#f92672>&lt;</span>function Counter<span style=color:#f92672>.</span>__iter__ at <span style=color:#ae81ff>0x102043400</span><span style=color:#f92672>&gt;</span>, <span style=color:#e6db74>&#39;__next__&#39;</span>: <span style=color:#f92672>&lt;</span>function Counter<span style=color:#f92672>.</span>__next__ at <span style=color:#ae81ff>0x102043488</span><span style=color:#f92672>&gt;</span>, <span style=color:#e6db74>&#39;__dict__&#39;</span>: <span style=color:#f92672>&lt;</span>attribute <span style=color:#e6db74>&#39;__dict__&#39;</span> of <span style=color:#e6db74>&#39;Counter&#39;</span> objects<span style=color:#f92672>&gt;</span>, <span style=color:#e6db74>&#39;__weakref__&#39;</span>: <span style=color:#f92672>&lt;</span>attribute <span style=color:#e6db74>&#39;__weakref__&#39;</span> of <span style=color:#e6db74>&#39;Counter&#39;</span> objects<span style=color:#f92672>&gt;</span>, <span style=color:#e6db74>&#39;__doc__&#39;</span>: <span style=color:#66d9ef>None</span>})
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> counter <span style=color:#f92672>=</span> Counter(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> counter<span style=color:#f92672>.</span>__dict__
</span></span><span style=display:flex><span>{<span style=color:#e6db74>&#39;cur&#39;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;high&#39;</span>: <span style=color:#ae81ff>3</span>}
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> dir(counter)
</span></span><span style=display:flex><span>[<span style=color:#e6db74>&#39;__class__&#39;</span>, <span style=color:#e6db74>&#39;__delattr__&#39;</span>, <span style=color:#e6db74>&#39;__dict__&#39;</span>, <span style=color:#e6db74>&#39;__dir__&#39;</span>, <span style=color:#e6db74>&#39;__doc__&#39;</span>, <span style=color:#e6db74>&#39;__eq__&#39;</span>, <span style=color:#e6db74>&#39;__format__&#39;</span>, <span style=color:#e6db74>&#39;__ge__&#39;</span>, <span style=color:#e6db74>&#39;__getattribute__&#39;</span>, <span style=color:#e6db74>&#39;__gt__&#39;</span>, <span style=color:#e6db74>&#39;__hash__&#39;</span>, <span style=color:#e6db74>&#39;__init__&#39;</span>, <span style=color:#e6db74>&#39;__init_subclass__&#39;</span>, <span style=color:#e6db74>&#39;__iter__&#39;</span>, <span style=color:#e6db74>&#39;__le__&#39;</span>, <span style=color:#e6db74>&#39;__lt__&#39;</span>, <span style=color:#e6db74>&#39;__module__&#39;</span>, <span style=color:#e6db74>&#39;__ne__&#39;</span>, <span style=color:#e6db74>&#39;__new__&#39;</span>, <span style=color:#e6db74>&#39;__next__&#39;</span>, <span style=color:#e6db74>&#39;__reduce__&#39;</span>, <span style=color:#e6db74>&#39;__reduce_ex__&#39;</span>, <span style=color:#e6db74>&#39;__repr__&#39;</span>, <span style=color:#e6db74>&#39;__setattr__&#39;</span>, <span style=color:#e6db74>&#39;__sizeof__&#39;</span>, <span style=color:#e6db74>&#39;__str__&#39;</span>, <span style=color:#e6db74>&#39;__subclasshook__&#39;</span>, <span style=color:#e6db74>&#39;__weakref__&#39;</span>, <span style=color:#e6db74>&#39;cur&#39;</span>, <span style=color:#e6db74>&#39;high&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> Counter<span style=color:#f92672>.</span>test
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>function Counter<span style=color:#f92672>.</span>test at <span style=color:#ae81ff>0x10bbc7488</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> counter<span style=color:#f92672>.</span>test
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;</span>bound method Counter<span style=color:#f92672>.</span>test of <span style=color:#f92672>&lt;</span>test<span style=color:#f92672>.</span>Counter object at <span style=color:#ae81ff>0x10bbc30f0</span><span style=color:#f92672>&gt;&gt;</span></span></span></code></pre></div></div></div></div><div id=outline-container-headline-7 class=outline-3><h3 id=headline-7>Generators</h3><div id=outline-text-headline-7 class=outline-text-3><p>Python3 文档关于 interator 的说明，主要是 <code>__next__()</code> 和 <code>__iter__()</code> 方法，前面那个例子里面有。</p><blockquote><p>An object representing a stream of data. Repeated calls to the iterator’s __next__() method (or passing it to the built-in function next()) return successive items in the stream. When no more data are available a StopIteration exception is raised instead. At this point, the iterator object is exhausted and any further calls to its __next__() method just raise StopIteration again. Iterators are required to have an __iter__() method that returns the iterator object itself so every iterator is also iterable and may be used in most places where other iterables are accepted. One notable exception is code which attempts multiple iteration passes. A container object (such as a list) produces a fresh new iterator each time you pass it to the iter() function or use it in a for loop. Attempting this with an iterator will just return the same exhausted iterator object used in the previous iteration pass, making it appear like an empty container.</p></blockquote><p>Generator 的说明，主要是使用 yield 返回一系列数据。</p><blockquote><p>A function which returns a generator iterator. It looks like a normal function except that it contains yield expressions for producing a series of values usable in a for-loop or that can be retrieved one at a time with the next() function.</p><p>Usually refers to a generator function, but may refer to a generator iterator in some contexts. In cases where the intended meaning isn’t clear, using the full terms avoids ambiguity.</p></blockquote><p>test.py 如下，这个也一样可以实现类似前面 Counter 类的功能。使用了生成器。</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>counter</span>(low, high):
</span></span><span style=display:flex><span>    cur <span style=color:#f92672>=</span> low
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> cur <span style=color:#f92672>&lt;</span> high:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>yield</span> cur
</span></span><span style=display:flex><span>        cur <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>c <span style=color:#f92672>=</span> counter(<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> elt <span style=color:#f92672>in</span> c:
</span></span><span style=display:flex><span>    print(elt)</span></span></code></pre></div></div><p>这个是 counter 方法的字节码。 <code>YIELD_VALUE</code> 是核心。</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>Disassembly of <span style=color:#f92672>&lt;</span>code object counter at <span style=color:#ae81ff>0x10c778c90</span>, file <span style=color:#e6db74>&#34;test.py&#34;</span>, line <span style=color:#ae81ff>1</span><span style=color:#f92672>&gt;</span>:
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>2</span>           <span style=color:#ae81ff>0</span> LOAD_FAST                <span style=color:#ae81ff>0</span> (low)
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>2</span> STORE_FAST               <span style=color:#ae81ff>2</span> (cur)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>3</span>           <span style=color:#ae81ff>4</span> SETUP_LOOP              <span style=color:#ae81ff>26</span> (to <span style=color:#ae81ff>32</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>&gt;&gt;</span>    <span style=color:#ae81ff>6</span> LOAD_FAST                <span style=color:#ae81ff>2</span> (cur)
</span></span><span style=display:flex><span>              <span style=color:#ae81ff>8</span> LOAD_FAST                <span style=color:#ae81ff>1</span> (high)
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>10</span> COMPARE_OP               <span style=color:#ae81ff>0</span> (<span style=color:#f92672>&lt;</span>)
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>12</span> POP_JUMP_IF_FALSE       <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>4</span>          <span style=color:#ae81ff>14</span> LOAD_FAST                <span style=color:#ae81ff>2</span> (cur)
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>16</span> YIELD_VALUE
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>18</span> POP_TOP
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ae81ff>5</span>          <span style=color:#ae81ff>20</span> LOAD_FAST                <span style=color:#ae81ff>2</span> (cur)
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>22</span> LOAD_CONST               <span style=color:#ae81ff>1</span> (<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>24</span> INPLACE_ADD
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>26</span> STORE_FAST               <span style=color:#ae81ff>2</span> (cur)
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>28</span> JUMP_ABSOLUTE            <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&gt;&gt;</span>   <span style=color:#ae81ff>30</span> POP_BLOCK
</span></span><span style=display:flex><span>        <span style=color:#f92672>&gt;&gt;</span>   <span style=color:#ae81ff>32</span> LOAD_CONST               <span style=color:#ae81ff>0</span> (<span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>             <span style=color:#ae81ff>34</span> RETURN_VALUE</span></span></code></pre></div></div><p><code>PyGenObject</code> 的定义在 <code>Include/genobject.h</code> 里面。可以看到这个对象包含了自己的 <code>_frame</code> ，因为每次调用需要考虑到上次调用的时候 frame 包含的变量信息。 <code>_code</code> 是对应的 code object。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define _PyGenObject_HEAD(prefix)                                           \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    PyObject_HEAD                                                           \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    </span><span style=color:#75715e>/* Note: gi_frame can be NULL if the generator is &#34;finished&#34; */</span><span style=color:#75715e>         \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    struct _frame *prefix##_frame;                                          \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    </span><span style=color:#75715e>/* True if generator is being executed. */</span><span style=color:#75715e>                              \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    char prefix##_running;                                                  \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    </span><span style=color:#75715e>/* The code object backing the generator */</span><span style=color:#75715e>                             \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    PyObject *prefix##_code;                                                \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    </span><span style=color:#75715e>/* List of weak reference. */</span><span style=color:#75715e>                                           \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    PyObject *prefix##_weakreflist;                                         \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    </span><span style=color:#75715e>/* Name of the generator. */</span><span style=color:#75715e>                                            \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    PyObject *prefix##_name;                                                \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    </span><span style=color:#75715e>/* Qualified name of the generator. */</span><span style=color:#75715e>                                  \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    PyObject *prefix##_qualname;                                            \
</span></span></span><span style=display:flex><span><span style=color:#75715e>    _PyErr_StackItem prefix##_exc_state;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* The gi_ prefix is intended to remind of generator-iterator. */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_PyGenObject_HEAD</span>(gi)
</span></span><span style=display:flex><span>} PyGenObject;</span></span></code></pre></div></div><p>通过 tp_iter 获取 inter 的时候，会通过 <code>PyObject_SelfIter</code> 返回 object 自己。 <code>tp_iternext</code> 会调用 <code>gen_iternext -> gen_send_ex</code> 实际就是调用 send 方法。send 方法接受 args 参数，会作为 yield 语句的返回值。下面代码，执行前会设置 running 为 1，然后在 frame f 上面执行代码，执行完毕之后，设置 running 为 0。</p><div class="src src-c"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>gen_send_ex</span>(PyGenObject <span style=color:#f92672>*</span>gen, PyObject <span style=color:#f92672>*</span>arg, <span style=color:#66d9ef>int</span> exc, <span style=color:#66d9ef>int</span> closing) {
</span></span><span style=display:flex><span>.....
</span></span><span style=display:flex><span>    gen<span style=color:#f92672>-&gt;</span>gi_running <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    gen<span style=color:#f92672>-&gt;</span>gi_exc_state.previous_item <span style=color:#f92672>=</span> tstate<span style=color:#f92672>-&gt;</span>exc_info;
</span></span><span style=display:flex><span>    tstate<span style=color:#f92672>-&gt;</span>exc_info <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>gen<span style=color:#f92672>-&gt;</span>gi_exc_state;
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> <span style=color:#a6e22e>PyEval_EvalFrameEx</span>(f, exc);
</span></span><span style=display:flex><span>    tstate<span style=color:#f92672>-&gt;</span>exc_info <span style=color:#f92672>=</span> gen<span style=color:#f92672>-&gt;</span>gi_exc_state.previous_item;
</span></span><span style=display:flex><span>    gen<span style=color:#f92672>-&gt;</span>gi_exc_state.previous_item <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>    gen<span style=color:#f92672>-&gt;</span>gi_running <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>....
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://wdicc.com/favicon.ico alt=Logo><h1 class=about__title>Happy every day!</h1><p class=about__description>Good good study, day day up!</p></div><ul class=aside__social-links><li><a href=https://github.com/wd rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2019-09-05</p><hr>On this page:<nav id=TableOfContents><ul><li><a href=#headline-1>Python 源码</a></li><li><a href=#headline-2>Opcode 和 interpreter 循环</a></li><li><a href=#headline-3>PyObject</a></li><li><a href=#headline-4>Code Object, Function Object, closures</a></li><li><a href=#headline-5>Iterators</a></li><li><a href=#headline-6>User-defined classes and objects</a></li><li><a href=#headline-7>Generators</a></li></ul></nav></div></section><footer class=page__footer><p><br><span class=active>$ echo $LANG<br><b>zh_CN</b></span><br></p><br><br><p class=copyright>wd © 2025</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>