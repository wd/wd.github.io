<!doctype html><html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>Notes for CPython Internals - wd and cc</title><link rel=icon type=image/png href=/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="Notes for CPython Internals">
<meta property="og:description" content="视频地址这里。 Python 源码 Include/opcode.h 里面定义了所有 opcode。 Modules 里面是一些 c 实现的模块， Lib 里面是用 python 实现的模块。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://wdicc.com/notes-for-cpython-internals/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2019-09-05T12:43:42+08:00">
<meta property="article:modified_time" content="2019-09-05T12:43:42+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Notes for CPython Internals">
<meta name=twitter:description content="视频地址这里。 Python 源码 Include/opcode.h 里面定义了所有 opcode。 Modules 里面是一些 c 实现的模块， Lib 里面是用 python 实现的模块。">
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel=stylesheet>
<link rel=stylesheet type=text/css media=screen href=https://wdicc.com/css/normalize.css>
<link rel=stylesheet type=text/css media=screen href=https://wdicc.com/css/main.css>
<link rel=stylesheet type=text/css href=https://wdicc.com//light-syntax.css media="(prefers-color-scheme: light)"><link rel=stylesheet type=text/css href=https://wdicc.com/css/dark.css media="(prefers-color-scheme: dark)">
<link rel=stylesheet type=text/css href=https://wdicc.com//dark-syntax.css media="(prefers-color-scheme: dark)">
<script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script>
<script src=https://wdicc.com/js/main.js></script>
</head>
<body>
<div class="container wrapper post">
<div class=header>
<h1 class=site-title><a href=https://wdicc.com/>wd and cc</a></h1>
<div class=site-description><h2>&mdash; Happy every day</h2><nav class="nav social">
<ul class=flat><a href=https://github.com/wd title=Github><i data-feather=github></i></a><a href=https://twitter.com/wdicc1413 title=Twitter><i data-feather=twitter></i></a></ul>
</nav>
</div>
<nav class=nav>
<ul class=flat>
<li>
<a href=/>Home</a>
</li>
<li>
<a href=/post>All posts</a>
</li>
<li>
<a href=/tags>Tags</a>
</li>
<li>
<a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&q=">Search</a>
</li>
<li>
<a href=/atom.xml>Subscribe</a>
</li>
</ul>
</nav>
</div>
<div class=post-header>
<h1 class=title>Notes for CPython Internals</h1>
<div class=meta>Posted at &mdash; Sep 5, 2019</div>
</div>
<div class=post-header>
<nav id=TableOfContents>
<ul>
<li><a href=#headline-1>Python 源码</a>
</li>
<li><a href=#headline-2>Opcode 和 interpreter 循环</a>
</li>
<li><a href=#headline-3>PyObject </a>
</li>
<li><a href=#headline-4>Code Object, Function Object, closures</a>
</li>
<li><a href=#headline-5>Iterators</a>
</li>
<li><a href=#headline-6>User-defined classes and objects</a>
</li>
<li><a href=#headline-7>Generators</a>
</li>
</ul>
</nav>
</div>
<div class=markdown>
<p>视频地址<a href="https://www.youtube.com/watch?list=PLzV58Zm8FuBL6OAv1Yu6AwXZrnsFbbR0S&index=1">这里</a>。</p>
<div id=outline-container-headline-1 class=outline-3>
<h3 id=headline-1>
Python 源码
</h3>
<div id=outline-text-headline-1 class=outline-text-3>
<p>
<code>Include/opcode.h</code> 里面定义了所有 opcode。 <code>Modules</code> 里面是一些 c 实现的模块， <code>Lib</code> 里面是用 python 实现的模块。 <code>Objects</code> 里面是部分 python 对象对应的 c 实现。</p>
<p>
<code>Python</code> 目录里面是 python core， <code>Python/ceval.c</code> 里面定义了 python interpreter 主要的循环，找那个 <code>for(;;)</code> 就可以，这个循环里面有一个巨长的 <code>switch (opcode)</code> 。</p>
</div>
</div>
<div id=outline-container-headline-2 class=outline-3>
<h3 id=headline-2>
Opcode 和 interpreter 循环
</h3>
<div id=outline-text-headline-2 class=outline-text-3>
<p>
test.py</p>
<div class="src src-python">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>x</span> <span class=o>=</span> <span class=mi>1</span>
<span class=n>y</span> <span class=o>=</span> <span class=mi>2</span>
<span class=nb>print</span><span class=p>(</span><span class=n>x</span> <span class=o>+</span> <span class=n>y</span><span class=p>)</span></code></pre></div>
</div>
<p>
使用内置的 <code>compile(source, filename, 'exec')</code> 函数可以把代码编译成 <code>code object</code> , code object 有一个 <code>co_code</code> 属性，里面包含了代码的 bytecode。</p>
<div class="src src-python">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=o>&gt;&gt;</span> <span class=n>c</span> <span class=o>=</span> <span class=nb>compile</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=s1>&#39;test.py&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>(),</span> <span class=s1>&#39;test.py&#39;</span><span class=p>,</span> <span class=s1>&#39;exec&#39;</span><span class=p>)</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>c</span>
<span class=o>&lt;</span><span class=n>code</span> <span class=nb>object</span> <span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span> <span class=n>at</span> <span class=mh>0x102daed20</span><span class=p>,</span> <span class=n>file</span> <span class=s2>&#34;test.py&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>1</span><span class=o>&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>c</span><span class=o>.</span><span class=n>co_code</span>
<span class=sa>b</span><span class=s1>&#39;d</span><span class=se>\x00</span><span class=s1>Z</span><span class=se>\x00</span><span class=s1>d</span><span class=se>\x01</span><span class=s1>Z</span><span class=se>\x01</span><span class=s1>e</span><span class=se>\x02</span><span class=s1>e</span><span class=se>\x00</span><span class=s1>e</span><span class=se>\x01\x17\x00\x83\x01\x01\x00</span><span class=s1>d</span><span class=se>\x02</span><span class=s1>S</span><span class=se>\x00</span><span class=s1>&#39;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=p>[</span><span class=n>co</span> <span class=k>for</span> <span class=n>co</span> <span class=ow>in</span> <span class=n>c</span><span class=o>.</span><span class=n>co_code</span><span class=p>]</span>
<span class=p>[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>90</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>90</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>101</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>101</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>101</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>23</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>131</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>83</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
<span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>co_code</span><span class=p>)</span>
<span class=mi>24</span></code></pre></div>
</div>
<p>
使用内置的 <code>dis</code> 模块可以直观的看到 opcode。我看<a href=https://docs.python.org/3/library/dis.html>文档</a>说的 3.6 以后每个 code 是 2 个字节。</p>
<div class="src src-shell">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ python -m dis test.py
  <span class=m>1</span>           <span class=m>0</span> LOAD_CONST               <span class=m>0</span> <span class=o>(</span>1<span class=o>)</span>
              <span class=m>2</span> STORE_NAME               <span class=m>0</span> <span class=o>(</span>x<span class=o>)</span>

  <span class=m>2</span>           <span class=m>4</span> LOAD_CONST               <span class=m>1</span> <span class=o>(</span>2<span class=o>)</span>
              <span class=m>6</span> STORE_NAME               <span class=m>1</span> <span class=o>(</span>y<span class=o>)</span>

  <span class=m>3</span>           <span class=m>8</span> LOAD_NAME                <span class=m>2</span> <span class=o>(</span>print<span class=o>)</span>
             <span class=m>10</span> LOAD_NAME                <span class=m>0</span> <span class=o>(</span>x<span class=o>)</span>
             <span class=m>12</span> LOAD_NAME                <span class=m>1</span> <span class=o>(</span>y<span class=o>)</span>
             <span class=m>14</span> BINARY_ADD
             <span class=m>16</span> CALL_FUNCTION            <span class=m>1</span>
             <span class=m>18</span> POP_TOP
             <span class=m>20</span> LOAD_CONST               <span class=m>2</span> <span class=o>(</span>None<span class=o>)</span>
             <span class=m>22</span> RETURN_VALUE</code></pre></div>
</div>
<blockquote>
<p>Changed in version 3.6: Use 2 bytes for each instruction. Previously the number of bytes varied by instruction.</p>
</blockquote>
<p>
对应 <code>LOAD_CONST</code> 的 opcode 是 <code>100</code> ，这个可以到 <code>Include/opcode.h</code> 里面查。</p>
<p>
我看 2.7 里面 <code>Python/ceval.c</code> 的 <code>PyEval_EvalFrameEx</code> 这个函数是包含那个死循环的函数，而 3.7 里面是 <code>_PyEval_EvalFrameDefault</code> ，这里面主要包含了那个 <code>for(;;)</code> 循环，输入一个 <code>PyFrameObject</code> ，然后一个个 opcode 处理。 <code>PyObject **stack_pointer; /* Next free slot in value stack */</code> 定义了 value stack，然后这后面定义了一堆的宏，方便写代码。。。后面就是从栈上取到 opcode，取到 oparg ，不同的 opcode 的 arg 数量也不一样，在 opcode.h 里面有定义。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c>    <span class=n>first_instr</span> <span class=o>=</span> <span class=p>(</span><span class=n>_Py_CODEUNIT</span> <span class=o>*</span><span class=p>)</span> <span class=n>PyBytes_AS_STRING</span><span class=p>(</span><span class=n>co</span><span class=o>-&gt;</span><span class=n>co_code</span><span class=p>);</span>
<span class=p>...</span>
    <span class=n>next_instr</span> <span class=o>=</span> <span class=n>first_instr</span><span class=p>;</span>
<span class=p>....</span>
            <span class=n>opcode</span> <span class=o>=</span> <span class=n>_Py_OPCODE</span><span class=p>(</span><span class=o>*</span><span class=n>next_instr</span><span class=p>);</span></code></pre></div>
</div>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define PREDICT(op) \
</span><span class=cp>    do{ \
</span><span class=cp>        _Py_CODEUNIT word = *next_instr; \
</span><span class=cp>        opcode = _Py_OPCODE(word); \
</span><span class=cp>        if (opcode == op){ \
</span><span class=cp>            oparg = _Py_OPARG(word); \
</span><span class=cp>            next_instr++; \
</span><span class=cp>            goto PRED_##op; \
</span><span class=cp>        } \
</span><span class=cp>    } while(0)
</span><span class=cp>#endif
</span><span class=cp>#define PREDICTED(op)           PRED_##op:</span></code></pre></div>
</div>
<p>
opcode 就是从 co_code 里面取到的 bytecode，oparg 类似从 co_code 里面循环取，直到遇到下一个 opcode。</p>
<p>
每个 opcode 可能经过的流程是：</p>
<ul>
<li>
<p>从 oparg 取变量的值放到 value stack，给下一个 opcode 使用。</p>
</li>
<li>
<p>从 value stack 取数据。</p>
</li>
<li>
<p>使用 c 的方法做一些运算。</p>
</li>
<li>
<p>增减引用计数。</p>
</li>
<li>
<p>把结果放回到 value stack。</p>
</li>
</ul>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c>    <span class=n>co</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>f_code</span><span class=p>;</span>
    <span class=n>names</span> <span class=o>=</span> <span class=n>co</span><span class=o>-&gt;</span><span class=n>co_names</span><span class=p>;</span>
    <span class=n>consts</span> <span class=o>=</span> <span class=n>co</span><span class=o>-&gt;</span><span class=n>co_consts</span><span class=p>;</span>
    <span class=n>fastlocals</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>f_localsplus</span><span class=p>;</span>
    <span class=n>freevars</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>f_localsplus</span> <span class=o>+</span> <span class=n>co</span><span class=o>-&gt;</span><span class=n>co_nlocals</span><span class=p>;</span></code></pre></div>
</div>
<p>
从这里能看到 <code>PyFrameObject</code> 包含了 code object，还包含了一些其他的，看着像是变量信息。</p>
<p>
这个网站 <a href="http://www.pythontutor.com/visualize.html#code=def%2520foo%2528%2529%253A%250A%2520%2520%2520%2520x%2520%253D%25201%250A%2520%2520%2520%2520print%25281%2529%250A%2520%2520%2520%2520%250Afoo%2528%2529&cumulative=false&curInstr=4&heapPrimitives=nevernest&mode=display&origin=opt-frontend.js&py=3&rawInputLstJSON=%255B%255D&textReferences=false">pythontutor.com</a> 可以可视化的观看 python 代码执行的情况，和各个 Frame 以及作用域的变量的情况。同时居然还有 Java Tutor, C Tutor, C++ Tutor, JavaScript Tutor, Ruby Tutor 。</p>
<p>
Function 变量（使用 def xxx 创建的变量），实际是对某一个 function object 的引用，里面 code object 似乎应该是 immutable 的，所以相同的代码实际上只需要一个 code object 就可以了。</p>
<p>
在 <code>Include/code.h</code> 里面有 <code>PyCodeObject</code> 的定义。包括了参数数量，代码 bytecode，本地变量信息什么的。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
    <span class=n>PyObject_HEAD</span>
    <span class=kt>int</span> <span class=n>co_argcount</span><span class=p>;</span>            <span class=cm>/* #arguments, except *args */</span>
    <span class=kt>int</span> <span class=n>co_kwonlyargcount</span><span class=p>;</span>      <span class=cm>/* #keyword only arguments */</span>
    <span class=kt>int</span> <span class=n>co_nlocals</span><span class=p>;</span>             <span class=cm>/* #local variables */</span>
    <span class=kt>int</span> <span class=n>co_stacksize</span><span class=p>;</span>           <span class=cm>/* #entries needed for evaluation stack */</span>
    <span class=kt>int</span> <span class=n>co_flags</span><span class=p>;</span>               <span class=cm>/* CO_..., see below */</span>
    <span class=kt>int</span> <span class=n>co_firstlineno</span><span class=p>;</span>         <span class=cm>/* first source line number */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>co_code</span><span class=p>;</span>          <span class=cm>/* instruction opcodes */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>co_consts</span><span class=p>;</span>        <span class=cm>/* list (constants used) */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>co_names</span><span class=p>;</span>         <span class=cm>/* list of strings (names used) */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>co_varnames</span><span class=p>;</span>      <span class=cm>/* tuple of strings (local variable names) */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>co_freevars</span><span class=p>;</span>      <span class=cm>/* tuple of strings (free variable names) */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>co_cellvars</span><span class=p>;</span>      <span class=cm>/* tuple of strings (cell variable names) */</span>
    <span class=cm>/* The rest aren&#39;t used in either hash or comparisons, except for co_name,
</span><span class=cm>       used in both. This is done to preserve the name and line number
</span><span class=cm>       for tracebacks and debuggers; otherwise, constant de-duplication
</span><span class=cm>       would collapse identical functions/lambdas defined on different lines.
</span><span class=cm>    */</span>
    <span class=n>Py_ssize_t</span> <span class=o>*</span><span class=n>co_cell2arg</span><span class=p>;</span>    <span class=cm>/* Maps cell vars which are arguments. */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>co_filename</span><span class=p>;</span>      <span class=cm>/* unicode (where it was loaded from) */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>co_name</span><span class=p>;</span>          <span class=cm>/* unicode (name, for reference) */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>co_lnotab</span><span class=p>;</span>        <span class=cm>/* string (encoding addr&lt;-&gt;lineno mapping) See
</span><span class=cm>                                   Objects/lnotab_notes.txt for details. */</span>
    <span class=kt>void</span> <span class=o>*</span><span class=n>co_zombieframe</span><span class=p>;</span>       <span class=cm>/* for optimization only (see frameobject.c) */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>co_weakreflist</span><span class=p>;</span>   <span class=cm>/* to support weakrefs to code objects */</span>
    <span class=cm>/* Scratch space for extra data relating to the code object.
</span><span class=cm>       Type is a void* to keep the format private in codeobject.c to force
</span><span class=cm>       people to go through the proper APIs. */</span>
    <span class=kt>void</span> <span class=o>*</span><span class=n>co_extra</span><span class=p>;</span>
<span class=p>}</span> <span class=n>PyCodeObject</span><span class=p>;</span></code></pre></div>
</div>
<p>
在 <code>Include/frameobject.h</code> 里面有 <code>PyFrameObject</code> 的定义。可以看到包含了一个 <code>PyCodeObject</code> ，还有 <code>*f_globals</code> <code>*f_locals</code> 变量表，每个 frame 有自己的全局本地变量表。 <code>f_back</code> 是上一个 frame 的信息，frame stack 是一个链表。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>ypedef</span> <span class=k>struct</span> <span class=n>_frame</span> <span class=p>{</span>
    <span class=n>PyObject_VAR_HEAD</span>
    <span class=k>struct</span> <span class=n>_frame</span> <span class=o>*</span><span class=n>f_back</span><span class=p>;</span>      <span class=cm>/* previous frame, or NULL */</span>
    <span class=n>PyCodeObject</span> <span class=o>*</span><span class=n>f_code</span><span class=p>;</span>       <span class=cm>/* code segment */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>f_builtins</span><span class=p>;</span>       <span class=cm>/* builtin symbol table (PyDictObject) */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>f_globals</span><span class=p>;</span>        <span class=cm>/* global symbol table (PyDictObject) */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>f_locals</span><span class=p>;</span>         <span class=cm>/* local symbol table (any mapping) */</span>
    <span class=n>PyObject</span> <span class=o>**</span><span class=n>f_valuestack</span><span class=p>;</span>    <span class=cm>/* points after the last local */</span>
    <span class=cm>/* Next free slot in f_valuestack.  Frame creation sets to f_valuestack.
</span><span class=cm>       Frame evaluation usually NULLs it, but a frame that yields sets it
</span><span class=cm>       to the current stack top. */</span>
    <span class=n>PyObject</span> <span class=o>**</span><span class=n>f_stacktop</span><span class=p>;</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>f_trace</span><span class=p>;</span>          <span class=cm>/* Trace function */</span>
    <span class=kt>char</span> <span class=n>f_trace_lines</span><span class=p>;</span>         <span class=cm>/* Emit per-line trace events? */</span>
    <span class=kt>char</span> <span class=n>f_trace_opcodes</span><span class=p>;</span>       <span class=cm>/* Emit per-opcode trace events? */</span>

    <span class=cm>/* Borrowed reference to a generator, or NULL */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>f_gen</span><span class=p>;</span>

    <span class=kt>int</span> <span class=n>f_lasti</span><span class=p>;</span>                <span class=cm>/* Last instruction if called */</span>
    <span class=cm>/* Call PyFrame_GetLineNumber() instead of reading this field
</span><span class=cm>       directly.  As of 2.3 f_lineno is only valid when tracing is
</span><span class=cm>       active (i.e. when f_trace is set).  At other times we use
</span><span class=cm>       PyCode_Addr2Line to calculate the line from the current
</span><span class=cm>       bytecode index. */</span>
    <span class=kt>int</span> <span class=n>f_lineno</span><span class=p>;</span>               <span class=cm>/* Current line number */</span>
    <span class=kt>int</span> <span class=n>f_iblock</span><span class=p>;</span>               <span class=cm>/* index in f_blockstack */</span>
    <span class=kt>char</span> <span class=n>f_executing</span><span class=p>;</span>           <span class=cm>/* whether the frame is still executing */</span>
    <span class=n>PyTryBlock</span> <span class=n>f_blockstack</span><span class=p>[</span><span class=n>CO_MAXBLOCKS</span><span class=p>];</span> <span class=cm>/* for try and loop blocks */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>f_localsplus</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>  <span class=cm>/* locals+stack, dynamically sized */</span>
<span class=p>}</span> <span class=n>PyFrameObject</span><span class=p>;</span></code></pre></div>
</div>
<p>
所以 <code>PyObject * PyEval_EvalFrameEx(PyFrameObject *f, int throwflag)</code> 接收一个 <code>PyFrameObject</code> 参数，然后处理这个 frame 里面的 bytecodes，然后 return 一个 <code>PyObject</code> 。</p>
<p>
code object 包含代码的字节码，和一些内部的常量信息。function 包含 code object 以及一些环境信息，比如全局变量什么的，就像是一个普通不可变对象。 frame 包含 code object 以及一些环境信息，还有参数信息，是运行时的，同一个 function 可以有不同的 frame ，比如写一个递归函数， function 就那一个，但是每次递归都会产生不同的 frame。frame 很像是一个 function object 的实例，当然实际还有一个 global frame。</p>
<p>
2.7 里面，对于 <code>CALL_FUNCTION</code> 这个 code，会执行 <code>fast_function</code> 这个函数，会使用 <code>PyFrame_New()</code> 创建新的 frame，以及会从 frame 的 stack 复制参数到本地的 stack 创建局部变量。3.7 里面似乎变了。</p>
</div>
</div>
<div id=outline-container-headline-3 class=outline-3>
<h3 id=headline-3>
PyObject
</h3>
<div id=outline-text-headline-3 class=outline-text-3>
<p>
python 3.7 <a href=https://docs.python.org/3/c-api/long.html>没有 PyIntObject 了</a>，2.7 似乎还有。</p>
<blockquote>
<p>All integers are implemented as “long” integer objects of arbitrary size.</p>
</blockquote>
<p>
所以 int 的 add 方法实现是在 <code>Objects/longobject.c</code> 里面。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>static</span> <span class=n>PyLongObject</span> <span class=o>*</span>
<span class=nf>x_add</span><span class=p>(</span><span class=n>PyLongObject</span> <span class=o>*</span><span class=n>a</span><span class=p>,</span> <span class=n>PyLongObject</span> <span class=o>*</span><span class=n>b</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>Py_ssize_t</span> <span class=n>size_a</span> <span class=o>=</span> <span class=n>Py_ABS</span><span class=p>(</span><span class=n>Py_SIZE</span><span class=p>(</span><span class=n>a</span><span class=p>)),</span> <span class=n>size_b</span> <span class=o>=</span> <span class=n>Py_ABS</span><span class=p>(</span><span class=n>Py_SIZE</span><span class=p>(</span><span class=n>b</span><span class=p>));</span>
    <span class=n>PyLongObject</span> <span class=o>*</span><span class=n>z</span><span class=p>;</span>
    <span class=n>Py_ssize_t</span> <span class=n>i</span><span class=p>;</span>
    <span class=n>digit</span> <span class=n>carry</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

    <span class=cm>/* Ensure a is the larger of the two: */</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>size_a</span> <span class=o>&lt;</span> <span class=n>size_b</span><span class=p>)</span> <span class=p>{</span>
        <span class=p>{</span> <span class=n>PyLongObject</span> <span class=o>*</span><span class=n>temp</span> <span class=o>=</span> <span class=n>a</span><span class=p>;</span> <span class=n>a</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span> <span class=n>b</span> <span class=o>=</span> <span class=n>temp</span><span class=p>;</span> <span class=p>}</span>
        <span class=p>{</span> <span class=n>Py_ssize_t</span> <span class=n>size_temp</span> <span class=o>=</span> <span class=n>size_a</span><span class=p>;</span>
            <span class=n>size_a</span> <span class=o>=</span> <span class=n>size_b</span><span class=p>;</span>
            <span class=n>size_b</span> <span class=o>=</span> <span class=n>size_temp</span><span class=p>;</span> <span class=p>}</span>
    <span class=p>}</span>
    <span class=n>z</span> <span class=o>=</span> <span class=n>_PyLong_New</span><span class=p>(</span><span class=n>size_a</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>z</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
        <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size_b</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>carry</span> <span class=o>+=</span> <span class=n>a</span><span class=o>-&gt;</span><span class=n>ob_digit</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+</span> <span class=n>b</span><span class=o>-&gt;</span><span class=n>ob_digit</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
        <span class=n>z</span><span class=o>-&gt;</span><span class=n>ob_digit</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>carry</span> <span class=o>&amp;</span> <span class=n>PyLong_MASK</span><span class=p>;</span>
        <span class=n>carry</span> <span class=o>&gt;&gt;=</span> <span class=n>PyLong_SHIFT</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>for</span> <span class=p>(;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size_a</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>carry</span> <span class=o>+=</span> <span class=n>a</span><span class=o>-&gt;</span><span class=n>ob_digit</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
        <span class=n>z</span><span class=o>-&gt;</span><span class=n>ob_digit</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>carry</span> <span class=o>&amp;</span> <span class=n>PyLong_MASK</span><span class=p>;</span>
        <span class=n>carry</span> <span class=o>&gt;&gt;=</span> <span class=n>PyLong_SHIFT</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>z</span><span class=o>-&gt;</span><span class=n>ob_digit</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>carry</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>long_normalize</span><span class=p>(</span><span class=n>z</span><span class=p>);</span>
<span class=p>}</span></code></pre></div>
</div>
<p>
python 里面万物皆对象，每一个对象都是 <code>PyObject</code> 的子类型。在 <code>Include/object.h</code> 里面有 <code>PyObject</code> 和 <code>PyVarObject</code> 的定义。每个 <code>PyObject</code> 都有一个 refcnt 和 type ，不同的 type 还会有不同的扩展字段。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define _PyObject_HEAD_EXTRA
</span><span class=cp></span><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_object</span> <span class=p>{</span>
    <span class=n>_PyObject_HEAD_EXTRA</span>
    <span class=n>Py_ssize_t</span> <span class=n>ob_refcnt</span><span class=p>;</span>
    <span class=k>struct</span> <span class=n>_typeobject</span> <span class=o>*</span><span class=n>ob_type</span><span class=p>;</span>
<span class=p>}</span> <span class=n>PyObject</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
    <span class=n>PyObject</span> <span class=n>ob_base</span><span class=p>;</span>
    <span class=n>Py_ssize_t</span> <span class=n>ob_size</span><span class=p>;</span> <span class=cm>/* Number of items in variable part */</span>
<span class=p>}</span> <span class=n>PyVarObject</span><span class=p>;</span></code></pre></div>
</div>
<p>
这个文件前面部分有一些注释，可以一看。每个对象都有一个引用计数字段和 type 字段。引用计数给垃圾回收用的。type 字段定义这具体是个什么类型的数据。对象一旦创建地址和大小就不会变了，这样就让引用一个对象变得简单了，因为不需要因为对象大小改变而需要挪动地方改变地址，这样也不用需要更新所有引用这个地址的变量的引用地址。</p>
<blockquote>
<p>An object has a 'reference count' that is increased or decreased when a
pointer to the object is copied or deleted; when the reference count
reaches zero there are no references to the object left and it can be
removed from the heap.</p>
<p>
An object has a 'type' that determines what it represents and what kind
of data it contains. An object's type is fixed when it is created.
Types themselves are represented as objects; an object contains a
pointer to the corresponding type object. The type itself has a type
pointer pointing to the object representing the type 'type', which
contains a pointer to itself!).</p>
<p>
Objects do not float around in memory; once allocated an object keeps
the same size and address. Objects that must hold variable-size data
can contain pointers to variable-size parts of the object. Not all
objects of the same type have the same size; but the size cannot change
after allocation. (These restrictions are made so a reference to an
object can be simply a pointer – moving an object would require
updating all the pointers, and changing an object's size would require
moving it if there was another object right next to it.)</p>
<p>
Objects are always accessed through pointers of the type 'PyObject *'.
The type 'PyObject' is a structure that only contains the reference count
and the type pointer. The actual memory allocated for an object
contains other data that can only be accessed after casting the pointer
to a pointer to a longer structure type. This longer type must start
with the reference count and type fields; the macro PyObject_HEAD should be
used for this (to accommodate for future changes). The implementation
of a particular object type can cast the object pointer to the proper
type and back.</p>
<p>
A standard interface exists for objects that contain an array of items
whose size is determined when the object is allocated.</p>
</blockquote>
<p>
在 <code>Include/longobject.h</code> 和 <code>Include/longintrepr.h</code> 里面定义了 <code>PyLongObject</code> ，在 <code>PyObject</code> 多了一个 size 和一个 value 字段。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define PyObject_VAR_HEAD      PyVarObject ob_base;
</span><span class=cp></span>
<span class=k>struct</span> <span class=n>_longobject</span> <span class=p>{</span>
    <span class=n>PyObject_VAR_HEAD</span>
    <span class=n>digit</span> <span class=n>ob_digit</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
<span class=p>};</span>

<span class=k>typedef</span> <span class=k>struct</span> <span class=n>_longobject</span> <span class=n>PyLongObject</span><span class=p>;</span> <span class=cm>/* Revealed in longintrepr.h */</span></code></pre></div>
</div>
<p>
2.7 里面有 <code>PyStringObject</code> ，但是 3.7 里面没有了，后面都是基于 3.7 的代码的。</p>
<p>
我猜是使用 <code>PyUnicodeObject</code> 的。 <code>PyASCIIObject</code> 有一些字段（内容比较长，下面有删节），有一个 <code>interned</code> 表示这个是不是内部提前缓存了，比如常用的字串 'hello' 这个对象会提前生成好。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
    <span class=n>PyObject_HEAD</span>
    <span class=n>Py_ssize_t</span> <span class=n>length</span><span class=p>;</span>          <span class=cm>/* Number of code points in the string */</span>
    <span class=n>Py_hash_t</span> <span class=n>hash</span><span class=p>;</span>             <span class=cm>/* Hash value; -1 if not set */</span>
    <span class=k>struct</span> <span class=p>{</span>
        <span class=cm>/*
</span><span class=cm>           SSTATE_NOT_INTERNED (0)
</span><span class=cm>           SSTATE_INTERNED_MORTAL (1)
</span><span class=cm>           SSTATE_INTERNED_IMMORTAL (2)
</span><span class=cm>
</span><span class=cm>           If interned != SSTATE_NOT_INTERNED, the two references from the
</span><span class=cm>           dictionary to this object are *not* counted in ob_refcnt.
</span><span class=cm>         */</span>
        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>interned</span><span class=p>:</span><span class=mi>2</span><span class=p>;</span>
       <span class=cm>/* Character size:
</span><span class=cm>
</span><span class=cm>           - PyUnicode_WCHAR_KIND (0):
</span><span class=cm>           - PyUnicode_1BYTE_KIND (1):
</span><span class=cm>           - PyUnicode_2BYTE_KIND (2):
</span><span class=cm>           - PyUnicode_4BYTE_KIND (4):
</span><span class=cm>        */</span>
        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>kind</span><span class=p>:</span><span class=mi>3</span><span class=p>;</span>
        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>compact</span><span class=p>:</span><span class=mi>1</span><span class=p>;</span>
        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>ascii</span><span class=p>:</span><span class=mi>1</span><span class=p>;</span>
        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>ready</span><span class=p>:</span><span class=mi>1</span><span class=p>;</span>
        <span class=kt>unsigned</span> <span class=kt>int</span> <span class=o>:</span><span class=mi>24</span><span class=p>;</span>
   <span class=p>}</span> <span class=n>state</span><span class=p>;</span>
    <span class=n>wchar_t</span> <span class=o>*</span><span class=n>wstr</span><span class=p>;</span>              <span class=cm>/* wchar_t representation (null-terminated) */</span>
<span class=p>}</span> <span class=n>PyASCIIObject</span><span class=p>;</span>
        
<span class=cm>/* Non-ASCII strings allocated through PyUnicode_New use the
</span><span class=cm>   PyCompactUnicodeObject structure. state.compact is set, and the data
</span><span class=cm>   immediately follow the structure. */</span>
<span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
    <span class=n>PyASCIIObject</span> <span class=n>_base</span><span class=p>;</span>
    <span class=n>Py_ssize_t</span> <span class=n>utf8_length</span><span class=p>;</span>     <span class=cm>/* Number of bytes in utf8, excluding the
</span><span class=cm>                                 * terminating \0. */</span>
    <span class=kt>char</span> <span class=o>*</span><span class=n>utf8</span><span class=p>;</span>                 <span class=cm>/* UTF-8 representation (null-terminated) */</span>
    <span class=n>Py_ssize_t</span> <span class=n>wstr_length</span><span class=p>;</span>     <span class=cm>/* Number of code points in wstr, possible
</span><span class=cm>                                 * surrogates count as two code points. */</span>
<span class=p>}</span> <span class=n>PyCompactUnicodeObject</span><span class=p>;</span>

<span class=cm>/* Strings allocated through PyUnicode_FromUnicode(NULL, len) use the
</span><span class=cm>   PyUnicodeObject structure. The actual string data is initially in the wstr
</span><span class=cm>   block, and copied into the data block using _PyUnicode_Ready. */</span>
<span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
    <span class=n>PyCompactUnicodeObject</span> <span class=n>_base</span><span class=p>;</span>
    <span class=k>union</span> <span class=p>{</span>
        <span class=kt>void</span> <span class=o>*</span><span class=n>any</span><span class=p>;</span>
        <span class=n>Py_UCS1</span> <span class=o>*</span><span class=n>latin1</span><span class=p>;</span>
        <span class=n>Py_UCS2</span> <span class=o>*</span><span class=n>ucs2</span><span class=p>;</span>
        <span class=n>Py_UCS4</span> <span class=o>*</span><span class=n>ucs4</span><span class=p>;</span>
    <span class=p>}</span> <span class=n>data</span><span class=p>;</span>                     <span class=cm>/* Canonical, smallest-form Unicode buffer */</span>
<span class=p>}</span> <span class=n>PyUnicodeObject</span><span class=p>;</span></code></pre></div>
</div>
<div class="src src-python">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=o>=</span><span class=s1>&#39;hello&#39;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>b</span><span class=o>=</span><span class=s1>&#39;hello&#39;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=ow>is</span> <span class=n>b</span>
<span class=kc>True</span>
<span class=o>&gt;&gt;&gt;</span> <span class=nb>id</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
<span class=mi>4439401168</span>
<span class=o>&gt;&gt;&gt;</span> <span class=nb>id</span><span class=p>(</span><span class=n>b</span><span class=p>)</span>
<span class=mi>4439401168</span></code></pre></div>
</div>
<p>
对于字符串 <code>==</code> 操作， <code>COMPARE_OP</code> 从 <code>Python/ceval.c</code> 里面，然后调用 <code>cmp_outcome</code> 然后调用 <code>Objects/object.c</code> 里面的 <code>PyObject_RichCompare -> do_richcompare</code> 。然后会调用 <code>v->ob_type->tp_richcompare</code> ，然后会到 <code>Objects/unicodeobject.c</code> 里面的 <code>PyUnicode_RichCompare</code> </p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c>        <span class=n>TARGET</span><span class=p>(</span><span class=n>COMPARE_OP</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>PyObject</span> <span class=o>*</span><span class=n>right</span> <span class=o>=</span> <span class=n>POP</span><span class=p>();</span>
            <span class=n>PyObject</span> <span class=o>*</span><span class=n>left</span> <span class=o>=</span> <span class=n>TOP</span><span class=p>();</span>
            <span class=n>PyObject</span> <span class=o>*</span><span class=n>res</span> <span class=o>=</span> <span class=n>cmp_outcome</span><span class=p>(</span><span class=n>oparg</span><span class=p>,</span> <span class=n>left</span><span class=p>,</span> <span class=n>right</span><span class=p>);</span>
            <span class=n>Py_DECREF</span><span class=p>(</span><span class=n>left</span><span class=p>);</span>
            <span class=n>Py_DECREF</span><span class=p>(</span><span class=n>right</span><span class=p>);</span>
            <span class=n>SET_TOP</span><span class=p>(</span><span class=n>res</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>res</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
                <span class=k>goto</span> <span class=n>error</span><span class=p>;</span>
            <span class=n>PREDICT</span><span class=p>(</span><span class=n>POP_JUMP_IF_FALSE</span><span class=p>);</span>
            <span class=n>PREDICT</span><span class=p>(</span><span class=n>POP_JUMP_IF_TRUE</span><span class=p>);</span>
            <span class=n>DISPATCH</span><span class=p>();</span>
        <span class=p>}</span></code></pre></div>
</div>
<p>
会先比较地址，然后使用 <code>unicode_compare_eq</code> 这个会先比较长度，如果长度一样，继续使用 <code>PyUnicode_KIND</code> 比较下 <code>kind</code> ， kind 可以看前面 struct 里面定义的， 然后会使用 <code>memcmp</code> 。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>PyObject</span> <span class=o>*</span>
<span class=nf>PyUnicode_RichCompare</span><span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=n>left</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>right</span><span class=p>,</span> <span class=kt>int</span> <span class=n>op</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>int</span> <span class=n>result</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>PyUnicode_Check</span><span class=p>(</span><span class=n>left</span><span class=p>)</span> <span class=o>||</span> <span class=o>!</span><span class=n>PyUnicode_Check</span><span class=p>(</span><span class=n>right</span><span class=p>))</span>
        <span class=n>Py_RETURN_NOTIMPLEMENTED</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>PyUnicode_READY</span><span class=p>(</span><span class=n>left</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=o>||</span>
        <span class=n>PyUnicode_READY</span><span class=p>(</span><span class=n>right</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
        <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>left</span> <span class=o>==</span> <span class=n>right</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>switch</span> <span class=p>(</span><span class=n>op</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>case</span> <span class=nl>Py_EQ</span><span class=p>:</span>
        <span class=k>case</span> <span class=nl>Py_LE</span><span class=p>:</span>
        <span class=k>case</span> <span class=nl>Py_GE</span><span class=p>:</span>
            <span class=cm>/* a string is equal to itself */</span>
            <span class=n>Py_RETURN_TRUE</span><span class=p>;</span>
        <span class=k>case</span> <span class=nl>Py_NE</span><span class=p>:</span>
        <span class=k>case</span> <span class=nl>Py_LT</span><span class=p>:</span>
        <span class=k>case</span> <span class=nl>Py_GT</span><span class=p>:</span>
            <span class=n>Py_RETURN_FALSE</span><span class=p>;</span>
        <span class=k>default</span><span class=o>:</span>
            <span class=n>PyErr_BadArgument</span><span class=p>();</span>
            <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>op</span> <span class=o>==</span> <span class=n>Py_EQ</span> <span class=o>||</span> <span class=n>op</span> <span class=o>==</span> <span class=n>Py_NE</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>unicode_compare_eq</span><span class=p>(</span><span class=n>left</span><span class=p>,</span> <span class=n>right</span><span class=p>);</span>
        <span class=n>result</span> <span class=o>^=</span> <span class=p>(</span><span class=n>op</span> <span class=o>==</span> <span class=n>Py_NE</span><span class=p>);</span>
        <span class=k>return</span> <span class=n>PyBool_FromLong</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=p>{</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>unicode_compare</span><span class=p>(</span><span class=n>left</span><span class=p>,</span> <span class=n>right</span><span class=p>);</span>
        <span class=n>Py_RETURN_RICHCOMPARE</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>op</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span></code></pre></div>
</div>
<p>
对于 code object 也有一个 <code>code_richcompare</code> ，会逐个比较 name, argcount, locales, constants 等等。</p>
</div>
</div>
<div id=outline-container-headline-4 class=outline-3>
<h3 id=headline-4>
Code Object, Function Object, closures
</h3>
<div id=outline-text-headline-4 class=outline-text-3>
<p>
<code>PyFunctionObject</code> 定义在 <code>Include/funcobject.h</code> 里面。 code 是一个 code object，globals 是全局变量，defaults 是默认参数。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
    <span class=n>PyObject_HEAD</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func_code</span><span class=p>;</span>        <span class=cm>/* A code object, the __code__ attribute */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func_globals</span><span class=p>;</span>     <span class=cm>/* A dictionary (other mappings won&#39;t do) */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func_defaults</span><span class=p>;</span>    <span class=cm>/* NULL or a tuple */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func_kwdefaults</span><span class=p>;</span>  <span class=cm>/* NULL or a dict */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func_closure</span><span class=p>;</span>     <span class=cm>/* NULL or a tuple of cell objects */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func_doc</span><span class=p>;</span>         <span class=cm>/* The __doc__ attribute, can be anything */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func_name</span><span class=p>;</span>        <span class=cm>/* The __name__ attribute, a string object */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func_dict</span><span class=p>;</span>        <span class=cm>/* The __dict__ attribute, a dict or NULL */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func_weakreflist</span><span class=p>;</span> <span class=cm>/* List of weak references */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func_module</span><span class=p>;</span>      <span class=cm>/* The __module__ attribute, can be anything */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func_annotations</span><span class=p>;</span> <span class=cm>/* Annotations, a dict or NULL */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func_qualname</span><span class=p>;</span>    <span class=cm>/* The qualified name */</span>

    <span class=cm>/* Invariant:
</span><span class=cm>     *     func_closure contains the bindings for func_code-&gt;co_freevars, so
</span><span class=cm>     *     PyTuple_Size(func_closure) == PyCode_GetNumFree(func_code)
</span><span class=cm>     *     (func_closure may be NULL if PyCode_GetNumFree(func_code) == 0).
</span><span class=cm>     */</span>
<span class=p>}</span> <span class=n>PyFunctionObject</span><span class=p>;</span></code></pre></div>
</div>
<p>
使用 <code>PyFunction_New</code> 创建 <code>PyFunctionObject</code> ，可以看到输入是 code object 和 global 环境。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>PyObject</span> <span class=o>*</span> <span class=n>PyFunction_New</span><span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=n>code</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>globals</span><span class=p>)</span></code></pre></div>
</div>
<p>
对 function object 的一些属性的定义，有的是只读的，有的可以修改。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>static</span> <span class=n>PyMemberDef</span> <span class=n>func_memberlist</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
    <span class=p>{</span><span class=s>&#34;__closure__&#34;</span><span class=p>,</span>   <span class=n>T_OBJECT</span><span class=p>,</span>     <span class=n>OFF</span><span class=p>(</span><span class=n>func_closure</span><span class=p>),</span>
     <span class=n>RESTRICTED</span><span class=o>|</span><span class=n>READONLY</span><span class=p>},</span>
    <span class=p>{</span><span class=s>&#34;__doc__&#34;</span><span class=p>,</span>       <span class=n>T_OBJECT</span><span class=p>,</span>     <span class=n>OFF</span><span class=p>(</span><span class=n>func_doc</span><span class=p>),</span> <span class=n>PY_WRITE_RESTRICTED</span><span class=p>},</span>
    <span class=p>{</span><span class=s>&#34;__globals__&#34;</span><span class=p>,</span>   <span class=n>T_OBJECT</span><span class=p>,</span>     <span class=n>OFF</span><span class=p>(</span><span class=n>func_globals</span><span class=p>),</span>
     <span class=n>RESTRICTED</span><span class=o>|</span><span class=n>READONLY</span><span class=p>},</span>
    <span class=p>{</span><span class=s>&#34;__module__&#34;</span><span class=p>,</span>    <span class=n>T_OBJECT</span><span class=p>,</span>     <span class=n>OFF</span><span class=p>(</span><span class=n>func_module</span><span class=p>),</span> <span class=n>PY_WRITE_RESTRICTED</span><span class=p>},</span>
    <span class=p>{</span><span class=nb>NULL</span><span class=p>}</span>  <span class=cm>/* Sentinel */</span>
<span class=p>};</span>

<span class=k>static</span> <span class=n>PyGetSetDef</span> <span class=n>func_getsetlist</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
    <span class=p>{</span><span class=s>&#34;__code__&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>getter</span><span class=p>)</span><span class=n>func_get_code</span><span class=p>,</span> <span class=p>(</span><span class=n>setter</span><span class=p>)</span><span class=n>func_set_code</span><span class=p>},</span>
    <span class=p>{</span><span class=s>&#34;__defaults__&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>getter</span><span class=p>)</span><span class=n>func_get_defaults</span><span class=p>,</span>
     <span class=p>(</span><span class=n>setter</span><span class=p>)</span><span class=n>func_set_defaults</span><span class=p>},</span>
    <span class=p>{</span><span class=s>&#34;__kwdefaults__&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>getter</span><span class=p>)</span><span class=n>func_get_kwdefaults</span><span class=p>,</span>
     <span class=p>(</span><span class=n>setter</span><span class=p>)</span><span class=n>func_set_kwdefaults</span><span class=p>},</span>
    <span class=p>{</span><span class=s>&#34;__annotations__&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>getter</span><span class=p>)</span><span class=n>func_get_annotations</span><span class=p>,</span>
     <span class=p>(</span><span class=n>setter</span><span class=p>)</span><span class=n>func_set_annotations</span><span class=p>},</span>
    <span class=p>{</span><span class=s>&#34;__dict__&#34;</span><span class=p>,</span> <span class=n>PyObject_GenericGetDict</span><span class=p>,</span> <span class=n>PyObject_GenericSetDict</span><span class=p>},</span>
    <span class=p>{</span><span class=s>&#34;__name__&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>getter</span><span class=p>)</span><span class=n>func_get_name</span><span class=p>,</span> <span class=p>(</span><span class=n>setter</span><span class=p>)</span><span class=n>func_set_name</span><span class=p>},</span>
    <span class=p>{</span><span class=s>&#34;__qualname__&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>getter</span><span class=p>)</span><span class=n>func_get_qualname</span><span class=p>,</span> <span class=p>(</span><span class=n>setter</span><span class=p>)</span><span class=n>func_set_qualname</span><span class=p>},</span>
    <span class=p>{</span><span class=nb>NULL</span><span class=p>}</span> <span class=cm>/* Sentinel */</span>
<span class=p>};</span></code></pre></div>
</div>
<p>
<code>tp_call</code> 是函数被 call 的时候调用的，对应的是 <code>function_call</code> 这个方法，这里面会继续调用 <code>Objects/call.c</code> 里面的 <code>_PyFunction_FastCallDict</code> 继续调用 <code>Python/ceval.c</code> 的 <code>_PyEval_EvalCodeWithName -> PyEval_EvalFrameEx</code> ，最终回到了 <code>PyEval_EvalFrameEx</code> 这个调用。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>function_call</span><span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=n>func</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>kwargs</span><span class=p>)</span></code></pre></div>
</div>
<p>
test.py 如下</p>
<div class="src src-python">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>x</span> <span class=o>=</span> <span class=mi>50</span>

<span class=k>def</span> <span class=nf>foo</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
    <span class=k>def</span> <span class=nf>bar</span><span class=p>(</span><span class=n>y</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>x</span> <span class=o>+</span> <span class=n>y</span>
    <span class=k>return</span> <span class=n>bar</span>

<span class=n>b1</span> <span class=o>=</span> <span class=n>foo</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
<span class=n>b2</span> <span class=o>=</span> <span class=n>foo</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span></code></pre></div>
</div>
<p>
<a href="http://www.pythontutor.com/visualize.html#code=x%2520%253D%252050%250A%250Adef%2520foo%2528x%2529%253A%250A%2520%2520%2520%2520def%2520bar%2528y%2529%253A%250A%2520%2520%2520%2520%2520%2520%2520%2520return%2520x%2520%252B%2520y%250A%2520%2520%2520%2520return%2520bar%250A%250Ab1%2520%253D%2520foo%252810%2529%250Ab2%2520%253D%2520foo%252820%2529&cumulative=false&curInstr=10&heapPrimitives=nevernest&mode=display&origin=opt-frontend.js&py=3&rawInputLstJSON=%255B%255D&textReferences=false">可视化</a>，可以看到每次函数调用都会创建一个 frame，并且 closure 因为引用了外函数的局部变量，会导致外部函数不能回收（灰色的部分）。</p>
<div class="src src-python">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>test</span>
<span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>dis</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>dis</span><span class=o>.</span><span class=n>dis</span><span class=p>(</span><span class=n>test</span><span class=p>)</span>
<span class=n>Disassembly</span> <span class=n>of</span> <span class=n>b1</span><span class=p>:</span>
  <span class=mi>5</span>           <span class=mi>0</span> <span class=n>LOAD_DEREF</span>               <span class=mi>0</span> <span class=p>(</span><span class=n>x</span><span class=p>)</span>
              <span class=mi>2</span> <span class=n>LOAD_FAST</span>                <span class=mi>0</span> <span class=p>(</span><span class=n>y</span><span class=p>)</span>
              <span class=mi>4</span> <span class=n>BINARY_ADD</span>
              <span class=mi>6</span> <span class=n>RETURN_VALUE</span>

<span class=n>Disassembly</span> <span class=n>of</span> <span class=n>b2</span><span class=p>:</span>
  <span class=mi>5</span>           <span class=mi>0</span> <span class=n>LOAD_DEREF</span>               <span class=mi>0</span> <span class=p>(</span><span class=n>x</span><span class=p>)</span>
              <span class=mi>2</span> <span class=n>LOAD_FAST</span>                <span class=mi>0</span> <span class=p>(</span><span class=n>y</span><span class=p>)</span>
              <span class=mi>4</span> <span class=n>BINARY_ADD</span>
              <span class=mi>6</span> <span class=n>RETURN_VALUE</span>

<span class=n>Disassembly</span> <span class=n>of</span> <span class=n>foo</span><span class=p>:</span>
  <span class=mi>4</span>           <span class=mi>0</span> <span class=n>LOAD_CLOSURE</span>             <span class=mi>0</span> <span class=p>(</span><span class=n>x</span><span class=p>)</span>
              <span class=mi>2</span> <span class=n>BUILD_TUPLE</span>              <span class=mi>1</span>
              <span class=mi>4</span> <span class=n>LOAD_CONST</span>               <span class=mi>1</span> <span class=p>(</span><span class=o>&lt;</span><span class=n>code</span> <span class=nb>object</span> <span class=n>bar</span> <span class=n>at</span> <span class=mh>0x10eae4420</span><span class=p>,</span> <span class=n>file</span> <span class=s2>&#34;/Users/wd/t/test.py&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>4</span><span class=o>&gt;</span><span class=p>)</span>
              <span class=mi>6</span> <span class=n>LOAD_CONST</span>               <span class=mi>2</span> <span class=p>(</span><span class=s1>&#39;foo.&lt;locals&gt;.bar&#39;</span><span class=p>)</span>
              <span class=mi>8</span> <span class=n>MAKE_FUNCTION</span>            <span class=mi>8</span>
             <span class=mi>10</span> <span class=n>STORE_FAST</span>               <span class=mi>1</span> <span class=p>(</span><span class=n>bar</span><span class=p>)</span>

  <span class=mi>6</span>          <span class=mi>12</span> <span class=n>LOAD_FAST</span>                <span class=mi>1</span> <span class=p>(</span><span class=n>bar</span><span class=p>)</span>
             <span class=mi>14</span> <span class=n>RETURN_VALUE</span>

<span class=n>Disassembly</span> <span class=n>of</span> <span class=o>&lt;</span><span class=n>code</span> <span class=nb>object</span> <span class=n>bar</span> <span class=n>at</span> <span class=mh>0x10eae4420</span><span class=p>,</span> <span class=n>file</span> <span class=s2>&#34;/Users/wd/t/test.py&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>4</span><span class=o>&gt;</span><span class=p>:</span>
  <span class=mi>5</span>           <span class=mi>0</span> <span class=n>LOAD_DEREF</span>               <span class=mi>0</span> <span class=p>(</span><span class=n>x</span><span class=p>)</span>
              <span class=mi>2</span> <span class=n>LOAD_FAST</span>                <span class=mi>0</span> <span class=p>(</span><span class=n>y</span><span class=p>)</span>
              <span class=mi>4</span> <span class=n>BINARY_ADD</span>
              <span class=mi>6</span> <span class=n>RETURN_VALUE</span>

<span class=o>&gt;&gt;&gt;</span> <span class=n>test</span><span class=o>.</span><span class=n>b1</span>
<span class=o>&lt;</span><span class=n>function</span> <span class=n>foo</span><span class=o>.&lt;</span><span class=nb>locals</span><span class=o>&gt;.</span><span class=n>bar</span> <span class=n>at</span> <span class=mh>0x10eb1c378</span><span class=o>&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>test</span><span class=o>.</span><span class=n>b2</span>
<span class=o>&lt;</span><span class=n>function</span> <span class=n>foo</span><span class=o>.&lt;</span><span class=nb>locals</span><span class=o>&gt;.</span><span class=n>bar</span> <span class=n>at</span> <span class=mh>0x10eb1c400</span><span class=o>&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>test</span><span class=o>.</span><span class=n>b1</span> <span class=o>==</span> <span class=n>test</span><span class=o>.</span><span class=n>b2</span>
<span class=kc>False</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>test</span><span class=o>.</span><span class=n>b1</span><span class=o>.</span><span class=vm>__code__</span>
<span class=o>&lt;</span><span class=n>code</span> <span class=nb>object</span> <span class=n>bar</span> <span class=n>at</span> <span class=mh>0x10eae4420</span><span class=p>,</span> <span class=n>file</span> <span class=s2>&#34;/Users/wd/t/test.py&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>4</span><span class=o>&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>test</span><span class=o>.</span><span class=n>b1</span><span class=o>.</span><span class=vm>__code__</span> <span class=o>==</span> <span class=n>test</span><span class=o>.</span><span class=n>b2</span><span class=o>.</span><span class=vm>__code__</span>
<span class=kc>True</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>test</span><span class=o>.</span><span class=n>b1</span><span class=o>.</span><span class=vm>__code__</span> <span class=ow>is</span> <span class=n>test</span><span class=o>.</span><span class=n>b2</span><span class=o>.</span><span class=vm>__code__</span>
<span class=kc>True</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>test</span><span class=o>.</span><span class=n>b1</span><span class=o>.</span><span class=vm>__closure__</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>cell_contents</span>
<span class=mi>10</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>test</span><span class=o>.</span><span class=n>b2</span><span class=o>.</span><span class=vm>__closure__</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>cell_contents</span>
<span class=mi>20</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>test</span><span class=o>.</span><span class=n>b1</span><span class=o>.</span><span class=vm>__code__</span><span class=o>.</span><span class=n>co_freevars</span>
<span class=p>(</span><span class=s1>&#39;x&#39;</span><span class=p>,)</span></code></pre></div>
</div>
<p>
code 里面包含 x 这个 freevar，参考前面 PyFunctionObject 的定义，里面有一段 <code>func_closure contains the bindings for func_code->co_freevars</code> 。</p>
<p>
上面这个例子里面，x 是通过 <code>LOAD_DEREF</code> 里面调用 <code>PyCell_GET</code> 取到的，是从那个 cell 里面取到的。感觉似乎是意思是说，普通 function 和 closure 的区别是 closure 包含了一个 <code>__closure__</code> 属性里面包含了对变量的引用。</p>
</div>
</div>
<div id=outline-container-headline-5 class=outline-3>
<h3 id=headline-5>
Iterators
</h3>
<div id=outline-text-headline-5 class=outline-text-3>
<div class="src src-python">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>]</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>a</span>
<span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>a</span><span class=o>.</span><span class=fm>__iter__</span><span class=p>()</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>i</span>
<span class=o>&lt;</span><span class=n>list_iterator</span> <span class=nb>object</span> <span class=n>at</span> <span class=mh>0x10819a0b8</span><span class=o>&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>j</span> <span class=o>=</span> <span class=n>a</span><span class=o>.</span><span class=fm>__iter__</span><span class=p>()</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>j</span>
<span class=o>&lt;</span><span class=n>list_iterator</span> <span class=nb>object</span> <span class=n>at</span> <span class=mh>0x10819a1d0</span><span class=o>&gt;</span></code></pre></div>
</div>
<p>
i 和 j 分别是不同的 iterator object。下面是 test.py</p>
<div class="src src-python">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>a</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>]</span>
<span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>a</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span></code></pre></div>
</div>
<p>
这个是字节码，GET_ITER 生成一个 iterator object，这个会调用 <code>Objects/abstract.c</code> 里面的 <code>PyObject_GetIter</code> 。</p>
<div class="src src-text">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text>  1           0 LOAD_CONST               0 (&#39;a&#39;)
              2 LOAD_CONST               1 (&#39;b&#39;)
              4 LOAD_CONST               2 (&#39;c&#39;)
              6 BUILD_LIST               3
              8 STORE_NAME               0 (a)

  2          10 SETUP_LOOP              20 (to 32)
             12 LOAD_NAME                0 (a)
             14 GET_ITER
        &gt;&gt;   16 FOR_ITER                12 (to 30)
             18 STORE_NAME               1 (e)

  3          20 LOAD_NAME                2 (print)
             22 LOAD_NAME                1 (e)
             24 CALL_FUNCTION            1
             26 POP_TOP
             28 JUMP_ABSOLUTE           16
        &gt;&gt;   30 POP_BLOCK
        &gt;&gt;   32 LOAD_CONST               3 (None)
             34 RETURN_VALUE</code></pre></div>
</div>
<p>
首先会看看是不是有 <code>tp_iter</code> 定义，内置的 sequance 对象没有，然后会使用 <code>PySeqIter_New</code> 生成 sequance object.</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>PyObject</span> <span class=o>*</span>
<span class=nf>PyObject_GetIter</span><span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=n>o</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>PyTypeObject</span> <span class=o>*</span><span class=n>t</span> <span class=o>=</span> <span class=n>o</span><span class=o>-&gt;</span><span class=n>ob_type</span><span class=p>;</span>
    <span class=n>getiterfunc</span> <span class=n>f</span><span class=p>;</span>

    <span class=n>f</span> <span class=o>=</span> <span class=n>t</span><span class=o>-&gt;</span><span class=n>tp_iter</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>f</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>PySequence_Check</span><span class=p>(</span><span class=n>o</span><span class=p>))</span>
            <span class=k>return</span> <span class=n>PySeqIter_New</span><span class=p>(</span><span class=n>o</span><span class=p>);</span>
        <span class=k>return</span> <span class=n>type_error</span><span class=p>(</span><span class=s>&#34;&#39;%.200s&#39; object is not iterable&#34;</span><span class=p>,</span> <span class=n>o</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=p>{</span>
        <span class=n>PyObject</span> <span class=o>*</span><span class=n>res</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=n>f</span><span class=p>)(</span><span class=n>o</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>res</span> <span class=o>!=</span> <span class=nb>NULL</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>PyIter_Check</span><span class=p>(</span><span class=n>res</span><span class=p>))</span> <span class=p>{</span>
            <span class=n>PyErr_Format</span><span class=p>(</span><span class=n>PyExc_TypeError</span><span class=p>,</span>
                         <span class=s>&#34;iter() returned non-iterator &#34;</span>
                         <span class=s>&#34;of type &#39;%.100s&#39;&#34;</span><span class=p>,</span>
                         <span class=n>res</span><span class=o>-&gt;</span><span class=n>ob_type</span><span class=o>-&gt;</span><span class=n>tp_name</span><span class=p>);</span>
            <span class=n>Py_DECREF</span><span class=p>(</span><span class=n>res</span><span class=p>);</span>
            <span class=n>res</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span></code></pre></div>
</div>
<p>
这个 object 里面，it_index 初始化的时候指向了 0 ，it_seq 指向那个输入的 seq。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
    <span class=n>PyObject_HEAD</span>
    <span class=n>Py_ssize_t</span> <span class=n>it_index</span><span class=p>;</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>it_seq</span><span class=p>;</span> <span class=cm>/* Set to NULL when iterator is exhausted */</span>
<span class=p>}</span> <span class=n>seqiterobject</span><span class=p>;</span>

<span class=n>PyObject</span> <span class=o>*</span>
<span class=nf>PySeqIter_New</span><span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=n>seq</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>seqiterobject</span> <span class=o>*</span><span class=n>it</span><span class=p>;</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>PySequence_Check</span><span class=p>(</span><span class=n>seq</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>PyErr_BadInternalCall</span><span class=p>();</span>
        <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>it</span> <span class=o>=</span> <span class=n>PyObject_GC_New</span><span class=p>(</span><span class=n>seqiterobject</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>PySeqIter_Type</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>it</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
        <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=n>it</span><span class=o>-&gt;</span><span class=n>it_index</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=n>Py_INCREF</span><span class=p>(</span><span class=n>seq</span><span class=p>);</span>
    <span class=n>it</span><span class=o>-&gt;</span><span class=n>it_seq</span> <span class=o>=</span> <span class=n>seq</span><span class=p>;</span>
    <span class=n>_PyObject_GC_TRACK</span><span class=p>(</span><span class=n>it</span><span class=p>);</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=p>)</span><span class=n>it</span><span class=p>;</span>
<span class=p>}</span></code></pre></div>
</div>
<p>
迭代的时候，主要调用的是 <code>FOR_ITER</code> ，会调用 <code>tp_iternext</code> ，对于列表来说是 <code>Objects/iterobject.c</code> 里面的 <code>iter_iternext</code> 方法。里面主要就是 <code>PySequence_GetItem(seq, it->it_index)</code> 会根据 index 获取元素，成功之后还会自增 index。如果 result 是 NULL 会把 it_seq 设置为 NULL，然后返回一个 NULL。 <code>FOR_ITER</code> 遇到 NULL 会根据代码有无 try except 决定是抛异常还是到 expect 处理。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>tatic</span> <span class=n>PyObject</span> <span class=o>*</span>
<span class=nf>iter_iternext</span><span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=n>iterator</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>seqiterobject</span> <span class=o>*</span><span class=n>it</span><span class=p>;</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>seq</span><span class=p>;</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>result</span><span class=p>;</span>

    <span class=n>assert</span><span class=p>(</span><span class=n>PySeqIter_Check</span><span class=p>(</span><span class=n>iterator</span><span class=p>));</span>
    <span class=n>it</span> <span class=o>=</span> <span class=p>(</span><span class=n>seqiterobject</span> <span class=o>*</span><span class=p>)</span><span class=n>iterator</span><span class=p>;</span>
    <span class=n>seq</span> <span class=o>=</span> <span class=n>it</span><span class=o>-&gt;</span><span class=n>it_seq</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>seq</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
        <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>it</span><span class=o>-&gt;</span><span class=n>it_index</span> <span class=o>==</span> <span class=n>PY_SSIZE_T_MAX</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>PyErr_SetString</span><span class=p>(</span><span class=n>PyExc_OverflowError</span><span class=p>,</span>
                        <span class=s>&#34;iter index too large&#34;</span><span class=p>);</span>
        <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>result</span> <span class=o>=</span> <span class=n>PySequence_GetItem</span><span class=p>(</span><span class=n>seq</span><span class=p>,</span> <span class=n>it</span><span class=o>-&gt;</span><span class=n>it_index</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>it</span><span class=o>-&gt;</span><span class=n>it_index</span><span class=o>++</span><span class=p>;</span>
        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>PyErr_ExceptionMatches</span><span class=p>(</span><span class=n>PyExc_IndexError</span><span class=p>)</span> <span class=o>||</span>
        <span class=n>PyErr_ExceptionMatches</span><span class=p>(</span><span class=n>PyExc_StopIteration</span><span class=p>))</span>
    <span class=p>{</span>
        <span class=n>PyErr_Clear</span><span class=p>();</span>
        <span class=n>it</span><span class=o>-&gt;</span><span class=n>it_seq</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=n>Py_DECREF</span><span class=p>(</span><span class=n>seq</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
<span class=p>}</span></code></pre></div>
</div>
<p>
如果是自己实现一个可迭代的对象，需要实现 <code>__iter__</code> 方法，提供一个返回 iter object 的方法，返回的这个 object 需要有 <code>__next__</code> 方法（python2 是 <code>next</code> 方法）。还需要注意适当的时候抛出 <code>StopIteration</code> 异常。</p>
<div class="src src-python">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>class</span> <span class=nc>Counter</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>low</span><span class=p>,</span> <span class=n>high</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>cur</span> <span class=o>=</span> <span class=n>low</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>high</span> <span class=o>=</span> <span class=n>high</span>

    <span class=k>def</span> <span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=bp>self</span>

    <span class=k>def</span> <span class=fm>__next__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>high</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>StopIteration</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>cur</span> <span class=o>+=</span> <span class=mi>1</span>
            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur</span> <span class=o>-</span> <span class=mi>1</span></code></pre></div>
</div>
<p>
主要的字节码如下，类似内置的支持迭代的对象，也会有 GET_ITER 和 FOR_ITER ，还内置的并没有区别。</p>
<div class="src src-text">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text>  1           0 LOAD_BUILD_CLASS
              2 LOAD_CONST               0 (&lt;code object Counter at 0x108e494b0, file &#34;test.py&#34;, line 1&gt;)
              4 LOAD_CONST               1 (&#39;Counter&#39;)
              6 MAKE_FUNCTION            0
              8 LOAD_CONST               1 (&#39;Counter&#39;)
             10 LOAD_NAME                0 (object)
             12 CALL_FUNCTION            3
             14 STORE_NAME               1 (Counter)

 16          16 LOAD_NAME                1 (Counter)
             18 LOAD_CONST               2 (3)
             20 LOAD_CONST               3 (6)
             22 CALL_FUNCTION            2
             24 STORE_NAME               2 (a)

 17          26 SETUP_LOOP              20 (to 48)
             28 LOAD_NAME                2 (a)
             30 GET_ITER
        &gt;&gt;   32 FOR_ITER                12 (to 46)
             34 STORE_NAME               3 (elt)

 18          36 LOAD_NAME                4 (print)
             38 LOAD_NAME                3 (elt)
             40 CALL_FUNCTION            1
             42 POP_TOP
             44 JUMP_ABSOLUTE           32
        &gt;&gt;   46 POP_BLOCK
        &gt;&gt;   48 LOAD_CONST               4 (None)
             50 RETURN_VALUE</code></pre></div>
</div>
</div>
</div>
<div id=outline-container-headline-6 class=outline-3>
<h3 id=headline-6>
User-defined classes and objects
</h3>
<div id=outline-text-headline-6 class=outline-text-3>
<p>
python 对象的属性是存在一个字典里面，所以可以方便的任意增减。</p>
<div class="src src-python">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>test</span> <span class=kn>import</span> <span class=n>Counter</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>a</span>  <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>3</span><span class=p>)</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>a</span>
<span class=o>&lt;</span><span class=n>Counter</span> <span class=nb>object</span> <span class=n>at</span> <span class=mh>0x10d7fa0b8</span><span class=o>&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=o>.</span><span class=vm>__dict__</span>
<span class=p>{</span><span class=s1>&#39;cur&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>}</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=o>.</span><span class=n>ff</span> <span class=o>=</span> <span class=mi>3</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=o>.</span><span class=vm>__dict__</span>
<span class=p>{</span><span class=s1>&#39;cur&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=s1>&#39;ff&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>}</span>
<span class=o>&gt;&gt;&gt;</span> <span class=k>del</span> <span class=n>a</span><span class=o>.</span><span class=n>ff</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=o>.</span><span class=vm>__dict__</span>
<span class=p>{</span><span class=s1>&#39;cur&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>}</span></code></pre></div>
</div>
<p>
创建对象的时候是使用 <code>LOAD_BUILD_CLASS</code> 。</p>
<blockquote>
<p>Pushes builtins.__build_class__() onto the stack. It is later called by CALL_FUNCTION to construct a class.</p>
</blockquote>
<p>
然后 python 3 没有 <code>PyClassObject</code> 了，迁移到了 <code>PyTypeObject</code> ，在 <code>Objects/object.h</code> 里面定义。下面两个是 <code>PyMethodObject</code> 和 <code>PyInstanceMethodObject</code> 。类实例化的时候，会调用 <code>tp_new -> method_new -> PyMethod_New</code> ，然后会返回一个 <code>PyMethodObject</code> 。这样对应的还有一套 <code>tp_new -> instancemethod_new -> PyInstanceMethod_New</code> ，返回的是 <code>PyInstanceMethodObject</code> 。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
    <span class=n>PyObject_HEAD</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>im_func</span><span class=p>;</span>   <span class=cm>/* The callable object implementing the method */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>im_self</span><span class=p>;</span>   <span class=cm>/* The instance it is bound to */</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>im_weakreflist</span><span class=p>;</span> <span class=cm>/* List of weak references */</span>
<span class=p>}</span> <span class=n>PyMethodObject</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
    <span class=n>PyObject_HEAD</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>func</span><span class=p>;</span>
<span class=p>}</span> <span class=n>PyInstanceMethodObject</span><span class=p>;</span></code></pre></div>
</div>
<p>
这两个的区别代码里面有简单的写了一句，还不是特别清楚是什么具体区别，看着感觉像是实例方法和类方法的区别。 <code>PyMethod_New</code> 返回的是一个带了 self, weakreflist 这些内容的对象。 <code>PyInstanceMethod_New</code> 只是返回了一个方法。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cm>/* Method objects are used for bound instance methods returned by
</span><span class=cm>   instancename.methodname. ClassName.methodname returns an ordinary
</span><span class=cm>   function.
</span><span class=cm> */</span>
<span class=n>PyObject</span> <span class=o>*</span>
<span class=nf>PyMethod_New</span><span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=n>func</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>self</span><span class=p>)</span>


<span class=c1>// instance method
</span><span class=c1></span><span class=n>PyInstanceMethod_New</span><span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=n>func</span><span class=p>)</span> <span class=p>{</span></code></pre></div>
</div>
<p>
给前面的 Counter 加一个 <code>test</code> 方法，看下面的 bound method 和 unbound method 应该就是上面的 PyMethod 和 PyInstancemethod 的区别吧。</p>
<div class="src src-python">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>test</span> <span class=kn>import</span> <span class=n>Counter</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>Counter</span>
<span class=o>&lt;</span><span class=k>class</span> <span class=err>&#39;</span><span class=nc>test</span><span class=o>.</span><span class=n>Counter</span><span class=s1>&#39;&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=nb>dir</span><span class=p>(</span><span class=n>Counter</span><span class=p>)</span>
<span class=p>[</span><span class=s1>&#39;__class__&#39;</span><span class=p>,</span> <span class=s1>&#39;__delattr__&#39;</span><span class=p>,</span> <span class=s1>&#39;__dict__&#39;</span><span class=p>,</span> <span class=s1>&#39;__dir__&#39;</span><span class=p>,</span> <span class=s1>&#39;__doc__&#39;</span><span class=p>,</span> <span class=s1>&#39;__eq__&#39;</span><span class=p>,</span> <span class=s1>&#39;__format__&#39;</span><span class=p>,</span> <span class=s1>&#39;__ge__&#39;</span><span class=p>,</span> <span class=s1>&#39;__getattribute__&#39;</span><span class=p>,</span> <span class=s1>&#39;__gt__&#39;</span><span class=p>,</span> <span class=s1>&#39;__hash__&#39;</span><span class=p>,</span> <span class=s1>&#39;__init__&#39;</span><span class=p>,</span> <span class=s1>&#39;__init_subclass__&#39;</span><span class=p>,</span> <span class=s1>&#39;__iter__&#39;</span><span class=p>,</span> <span class=s1>&#39;__le__&#39;</span><span class=p>,</span> <span class=s1>&#39;__lt__&#39;</span><span class=p>,</span> <span class=s1>&#39;__module__&#39;</span><span class=p>,</span> <span class=s1>&#39;__ne__&#39;</span><span class=p>,</span> <span class=s1>&#39;__new__&#39;</span><span class=p>,</span> <span class=s1>&#39;__next__&#39;</span><span class=p>,</span> <span class=s1>&#39;__reduce__&#39;</span><span class=p>,</span> <span class=s1>&#39;__reduce_ex__&#39;</span><span class=p>,</span> <span class=s1>&#39;__repr__&#39;</span><span class=p>,</span> <span class=s1>&#39;__setattr__&#39;</span><span class=p>,</span> <span class=s1>&#39;__sizeof__&#39;</span><span class=p>,</span> <span class=s1>&#39;__str__&#39;</span><span class=p>,</span> <span class=s1>&#39;__subclasshook__&#39;</span><span class=p>,</span> <span class=s1>&#39;__weakref__&#39;</span><span class=p>]</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>Counter</span><span class=o>.</span><span class=vm>__dict__</span>
<span class=n>mappingproxy</span><span class=p>({</span><span class=s1>&#39;__module__&#39;</span><span class=p>:</span> <span class=s1>&#39;test&#39;</span><span class=p>,</span> <span class=s1>&#39;__init__&#39;</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>function</span> <span class=n>Counter</span><span class=o>.</span><span class=fm>__init__</span> <span class=n>at</span> <span class=mh>0x102043378</span><span class=o>&gt;</span><span class=p>,</span> <span class=s1>&#39;__iter__&#39;</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>function</span> <span class=n>Counter</span><span class=o>.</span><span class=fm>__iter__</span> <span class=n>at</span> <span class=mh>0x102043400</span><span class=o>&gt;</span><span class=p>,</span> <span class=s1>&#39;__next__&#39;</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>function</span> <span class=n>Counter</span><span class=o>.</span><span class=fm>__next__</span> <span class=n>at</span> <span class=mh>0x102043488</span><span class=o>&gt;</span><span class=p>,</span> <span class=s1>&#39;__dict__&#39;</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>attribute</span> <span class=s1>&#39;__dict__&#39;</span> <span class=n>of</span> <span class=s1>&#39;Counter&#39;</span> <span class=n>objects</span><span class=o>&gt;</span><span class=p>,</span> <span class=s1>&#39;__weakref__&#39;</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>attribute</span> <span class=s1>&#39;__weakref__&#39;</span> <span class=n>of</span> <span class=s1>&#39;Counter&#39;</span> <span class=n>objects</span><span class=o>&gt;</span><span class=p>,</span> <span class=s1>&#39;__doc__&#39;</span><span class=p>:</span> <span class=kc>None</span><span class=p>})</span>
<span class=o>&gt;&gt;&gt;</span>
<span class=o>&gt;&gt;&gt;</span>
<span class=o>&gt;&gt;&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>counter</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>3</span><span class=p>)</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>counter</span><span class=o>.</span><span class=vm>__dict__</span>
<span class=p>{</span><span class=s1>&#39;cur&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>}</span>
<span class=o>&gt;&gt;&gt;</span> <span class=nb>dir</span><span class=p>(</span><span class=n>counter</span><span class=p>)</span>
<span class=p>[</span><span class=s1>&#39;__class__&#39;</span><span class=p>,</span> <span class=s1>&#39;__delattr__&#39;</span><span class=p>,</span> <span class=s1>&#39;__dict__&#39;</span><span class=p>,</span> <span class=s1>&#39;__dir__&#39;</span><span class=p>,</span> <span class=s1>&#39;__doc__&#39;</span><span class=p>,</span> <span class=s1>&#39;__eq__&#39;</span><span class=p>,</span> <span class=s1>&#39;__format__&#39;</span><span class=p>,</span> <span class=s1>&#39;__ge__&#39;</span><span class=p>,</span> <span class=s1>&#39;__getattribute__&#39;</span><span class=p>,</span> <span class=s1>&#39;__gt__&#39;</span><span class=p>,</span> <span class=s1>&#39;__hash__&#39;</span><span class=p>,</span> <span class=s1>&#39;__init__&#39;</span><span class=p>,</span> <span class=s1>&#39;__init_subclass__&#39;</span><span class=p>,</span> <span class=s1>&#39;__iter__&#39;</span><span class=p>,</span> <span class=s1>&#39;__le__&#39;</span><span class=p>,</span> <span class=s1>&#39;__lt__&#39;</span><span class=p>,</span> <span class=s1>&#39;__module__&#39;</span><span class=p>,</span> <span class=s1>&#39;__ne__&#39;</span><span class=p>,</span> <span class=s1>&#39;__new__&#39;</span><span class=p>,</span> <span class=s1>&#39;__next__&#39;</span><span class=p>,</span> <span class=s1>&#39;__reduce__&#39;</span><span class=p>,</span> <span class=s1>&#39;__reduce_ex__&#39;</span><span class=p>,</span> <span class=s1>&#39;__repr__&#39;</span><span class=p>,</span> <span class=s1>&#39;__setattr__&#39;</span><span class=p>,</span> <span class=s1>&#39;__sizeof__&#39;</span><span class=p>,</span> <span class=s1>&#39;__str__&#39;</span><span class=p>,</span> <span class=s1>&#39;__subclasshook__&#39;</span><span class=p>,</span> <span class=s1>&#39;__weakref__&#39;</span><span class=p>,</span> <span class=s1>&#39;cur&#39;</span><span class=p>,</span> <span class=s1>&#39;high&#39;</span><span class=p>]</span>
<span class=o>&gt;&gt;&gt;</span>
<span class=o>&gt;&gt;&gt;</span>
<span class=o>&gt;&gt;&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>Counter</span><span class=o>.</span><span class=n>test</span>
<span class=o>&lt;</span><span class=n>function</span> <span class=n>Counter</span><span class=o>.</span><span class=n>test</span> <span class=n>at</span> <span class=mh>0x10bbc7488</span><span class=o>&gt;</span>
<span class=o>&gt;&gt;&gt;</span> <span class=n>counter</span><span class=o>.</span><span class=n>test</span>
<span class=o>&lt;</span><span class=n>bound</span> <span class=n>method</span> <span class=n>Counter</span><span class=o>.</span><span class=n>test</span> <span class=n>of</span> <span class=o>&lt;</span><span class=n>test</span><span class=o>.</span><span class=n>Counter</span> <span class=nb>object</span> <span class=n>at</span> <span class=mh>0x10bbc30f0</span><span class=o>&gt;&gt;</span></code></pre></div>
</div>
</div>
</div>
<div id=outline-container-headline-7 class=outline-3>
<h3 id=headline-7>
Generators
</h3>
<div id=outline-text-headline-7 class=outline-text-3>
<p>
Python3 文档关于 interator 的说明，主要是 <code>__next__()</code> 和 <code>__iter__()</code> 方法，前面那个例子里面有。</p>
<blockquote>
<p>An object representing a stream of data. Repeated calls to the iterator’s __next__() method (or passing it to the built-in function next()) return successive items in the stream. When no more data are available a StopIteration exception is raised instead. At this point, the iterator object is exhausted and any further calls to its __next__() method just raise StopIteration again. Iterators are required to have an __iter__() method that returns the iterator object itself so every iterator is also iterable and may be used in most places where other iterables are accepted. One notable exception is code which attempts multiple iteration passes. A container object (such as a list) produces a fresh new iterator each time you pass it to the iter() function or use it in a for loop. Attempting this with an iterator will just return the same exhausted iterator object used in the previous iteration pass, making it appear like an empty container.</p>
</blockquote>
<p>
Generator 的说明，主要是使用 yield 返回一系列数据。</p>
<blockquote>
<p>A function which returns a generator iterator. It looks like a normal function except that it contains yield expressions for producing a series of values usable in a for-loop or that can be retrieved one at a time with the next() function.</p>
<p>
Usually refers to a generator function, but may refer to a generator iterator in some contexts. In cases where the intended meaning isn’t clear, using the full terms avoids ambiguity.</p>
</blockquote>
<p>
test.py 如下，这个也一样可以实现类似前面 Counter 类的功能。使用了生成器。</p>
<div class="src src-python">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>counter</span><span class=p>(</span><span class=n>low</span><span class=p>,</span> <span class=n>high</span><span class=p>):</span>
    <span class=n>cur</span> <span class=o>=</span> <span class=n>low</span>
    <span class=k>while</span> <span class=n>cur</span> <span class=o>&lt;</span> <span class=n>high</span><span class=p>:</span>
        <span class=k>yield</span> <span class=n>cur</span>
        <span class=n>cur</span> <span class=o>+=</span> <span class=mi>1</span>

<span class=n>c</span> <span class=o>=</span> <span class=n>counter</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
<span class=k>for</span> <span class=n>elt</span> <span class=ow>in</span> <span class=n>c</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>elt</span><span class=p>)</span></code></pre></div>
</div>
<p>
这个是 counter 方法的字节码。 <code>YIELD_VALUE</code> 是核心。</p>
<div class="src src-python">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>Disassembly</span> <span class=n>of</span> <span class=o>&lt;</span><span class=n>code</span> <span class=nb>object</span> <span class=n>counter</span> <span class=n>at</span> <span class=mh>0x10c778c90</span><span class=p>,</span> <span class=n>file</span> <span class=s2>&#34;test.py&#34;</span><span class=p>,</span> <span class=n>line</span> <span class=mi>1</span><span class=o>&gt;</span><span class=p>:</span>
  <span class=mi>2</span>           <span class=mi>0</span> <span class=n>LOAD_FAST</span>                <span class=mi>0</span> <span class=p>(</span><span class=n>low</span><span class=p>)</span>
              <span class=mi>2</span> <span class=n>STORE_FAST</span>               <span class=mi>2</span> <span class=p>(</span><span class=n>cur</span><span class=p>)</span>

  <span class=mi>3</span>           <span class=mi>4</span> <span class=n>SETUP_LOOP</span>              <span class=mi>26</span> <span class=p>(</span><span class=n>to</span> <span class=mi>32</span><span class=p>)</span>
        <span class=o>&gt;&gt;</span>    <span class=mi>6</span> <span class=n>LOAD_FAST</span>                <span class=mi>2</span> <span class=p>(</span><span class=n>cur</span><span class=p>)</span>
              <span class=mi>8</span> <span class=n>LOAD_FAST</span>                <span class=mi>1</span> <span class=p>(</span><span class=n>high</span><span class=p>)</span>
             <span class=mi>10</span> <span class=n>COMPARE_OP</span>               <span class=mi>0</span> <span class=p>(</span><span class=o>&lt;</span><span class=p>)</span>
             <span class=mi>12</span> <span class=n>POP_JUMP_IF_FALSE</span>       <span class=mi>30</span>

  <span class=mi>4</span>          <span class=mi>14</span> <span class=n>LOAD_FAST</span>                <span class=mi>2</span> <span class=p>(</span><span class=n>cur</span><span class=p>)</span>
             <span class=mi>16</span> <span class=n>YIELD_VALUE</span>
             <span class=mi>18</span> <span class=n>POP_TOP</span>

  <span class=mi>5</span>          <span class=mi>20</span> <span class=n>LOAD_FAST</span>                <span class=mi>2</span> <span class=p>(</span><span class=n>cur</span><span class=p>)</span>
             <span class=mi>22</span> <span class=n>LOAD_CONST</span>               <span class=mi>1</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
             <span class=mi>24</span> <span class=n>INPLACE_ADD</span>
             <span class=mi>26</span> <span class=n>STORE_FAST</span>               <span class=mi>2</span> <span class=p>(</span><span class=n>cur</span><span class=p>)</span>
             <span class=mi>28</span> <span class=n>JUMP_ABSOLUTE</span>            <span class=mi>6</span>
        <span class=o>&gt;&gt;</span>   <span class=mi>30</span> <span class=n>POP_BLOCK</span>
        <span class=o>&gt;&gt;</span>   <span class=mi>32</span> <span class=n>LOAD_CONST</span>               <span class=mi>0</span> <span class=p>(</span><span class=kc>None</span><span class=p>)</span>
             <span class=mi>34</span> <span class=n>RETURN_VALUE</span></code></pre></div>
</div>
<p>
<code>PyGenObject</code> 的定义在 <code>Include/genobject.h</code> 里面。可以看到这个对象包含了自己的 <code>_frame</code> ，因为每次调用需要考虑到上次调用的时候 frame 包含的变量信息。 <code>_code</code> 是对应的 code object。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cp>#define _PyGenObject_HEAD(prefix)                                           \
</span><span class=cp>    PyObject_HEAD                                                           \
</span><span class=cp>    </span><span class=cm>/* Note: gi_frame can be NULL if the generator is &#34;finished&#34; */</span><span class=cp>         \
</span><span class=cp>    struct _frame *prefix##_frame;                                          \
</span><span class=cp>    </span><span class=cm>/* True if generator is being executed. */</span><span class=cp>                              \
</span><span class=cp>    char prefix##_running;                                                  \
</span><span class=cp>    </span><span class=cm>/* The code object backing the generator */</span><span class=cp>                             \
</span><span class=cp>    PyObject *prefix##_code;                                                \
</span><span class=cp>    </span><span class=cm>/* List of weak reference. */</span><span class=cp>                                           \
</span><span class=cp>    PyObject *prefix##_weakreflist;                                         \
</span><span class=cp>    </span><span class=cm>/* Name of the generator. */</span><span class=cp>                                            \
</span><span class=cp>    PyObject *prefix##_name;                                                \
</span><span class=cp>    </span><span class=cm>/* Qualified name of the generator. */</span><span class=cp>                                  \
</span><span class=cp>    PyObject *prefix##_qualname;                                            \
</span><span class=cp>    _PyErr_StackItem prefix##_exc_state;
</span><span class=cp></span>
<span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
    <span class=cm>/* The gi_ prefix is intended to remind of generator-iterator. */</span>
    <span class=n>_PyGenObject_HEAD</span><span class=p>(</span><span class=n>gi</span><span class=p>)</span>
<span class=p>}</span> <span class=n>PyGenObject</span><span class=p>;</span></code></pre></div>
</div>
<p>
通过 tp_iter 获取 inter 的时候，会通过 <code>PyObject_SelfIter</code> 返回 object 自己。 <code>tp_iternext</code> 会调用 <code>gen_iternext -> gen_send_ex</code> 实际就是调用 send 方法。send 方法接受 args 参数，会作为 yield 语句的返回值。下面代码，执行前会设置 running 为 1，然后在 frame f 上面执行代码，执行完毕之后，设置 running 为 0。</p>
<div class="src src-c">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>gen_send_ex</span><span class=p>(</span><span class=n>PyGenObject</span> <span class=o>*</span><span class=n>gen</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>arg</span><span class=p>,</span> <span class=kt>int</span> <span class=n>exc</span><span class=p>,</span> <span class=kt>int</span> <span class=n>closing</span><span class=p>)</span> <span class=p>{</span>
<span class=p>.....</span>
    <span class=n>gen</span><span class=o>-&gt;</span><span class=n>gi_running</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=n>gen</span><span class=o>-&gt;</span><span class=n>gi_exc_state</span><span class=p>.</span><span class=n>previous_item</span> <span class=o>=</span> <span class=n>tstate</span><span class=o>-&gt;</span><span class=n>exc_info</span><span class=p>;</span>
    <span class=n>tstate</span><span class=o>-&gt;</span><span class=n>exc_info</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>gen</span><span class=o>-&gt;</span><span class=n>gi_exc_state</span><span class=p>;</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>PyEval_EvalFrameEx</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>exc</span><span class=p>);</span>
    <span class=n>tstate</span><span class=o>-&gt;</span><span class=n>exc_info</span> <span class=o>=</span> <span class=n>gen</span><span class=o>-&gt;</span><span class=n>gi_exc_state</span><span class=p>.</span><span class=n>previous_item</span><span class=p>;</span>
    <span class=n>gen</span><span class=o>-&gt;</span><span class=n>gi_exc_state</span><span class=p>.</span><span class=n>previous_item</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=n>gen</span><span class=o>-&gt;</span><span class=n>gi_running</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>....</span>
<span class=p>}</span></code></pre></div>
</div>
</div>
</div>
</div>
<div class=post-tags>
<nav class="nav tags">
<ul class=flat>
<li><a href=/tags/python>python</a></li>
<li><a href=/tags/cpython>cpython</a></li>
</ul>
</nav>
</div>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='wdicc',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by
Disqus.</a></noscript>
<a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<div class="footer wrapper">
<nav class=nav>
<div> Copyright © 2020 wd. All Rights Reserved | <a href=https://github.com/vividvilla/ezhil>Ezhil theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div>
</nav>
</div>
<script>feather.replace()</script>
</body>
</html>