<!doctype html><html lang=en><head><title>python 的 decorator 学习 &ndash; wd and cc</title>
<meta name=description content="Good good study, day day up!"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://wdicc.com/css/palettes/base16-dark.css><link rel=stylesheet href=https://wdicc.com/css/risotto.css><link rel=stylesheet href=https://wdicc.com/css/custom.css><link rel=icon href=https://wdicc.com/favicon.ico></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><h1 class=page__logo><a href=https://wdicc.com/ class=page__logo-inner>wd and cc</a></h1><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/posts/ title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=" title>Search</a></li><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/atom.xml title>subscribe</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>python 的 decorator 学习</h1></header><div class=content__body><p>最近学习了一下 python 的 decorator（装饰器），看的是这篇，<a href=http://coolshell.cn/articles/11265.html>Python修饰器的函数式编程</a>， 觉得挺有意思的，写点东西记录一下。</p><p>装饰器简单讲就是返回一个函数的函数/类。看个简单的例子。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -*- coding: utf-8 -*-</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>dec1</span>(fn):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;inside dec1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>():
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;inside wrapper&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> fn()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@dec1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>f1</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;inside f1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;begin exec&#39;</span>)
</span></span><span style=display:flex><span>    f1()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;end exec&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行结果:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># inside dec1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># begin exec</span>
</span></span><span style=display:flex><span><span style=color:#75715e># inside wrapper</span>
</span></span><span style=display:flex><span><span style=color:#75715e># inside f1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># end exec</span>
</span></span></code></pre></div><p>看上面例子能看到，装饰器生效有 2 个步骤，第一个是装饰，第二个是执行。上面装饰器的效果，和下面的代码的效果是一样。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -*- coding: utf-8 -*-</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>dec1</span>(fn):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;inside dec1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>():
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;inside wrapper&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> fn()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> wrapper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># @dec1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>f1</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;inside f1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;begin exec&#39;</span>)
</span></span><span style=display:flex><span>    dec1(f1)()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;end exec&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行结果:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># begin exec</span>
</span></span><span style=display:flex><span><span style=color:#75715e># inside dec1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># inside wrapper</span>
</span></span><span style=display:flex><span><span style=color:#75715e># inside f1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># end exec</span>
</span></span></code></pre></div><p>可以看到除了 「begin/end exec」，其他部分执行结果是一样的。所以理解装饰器，就把 <code>@dec1</code> 换成 <code>dec1(fn)()</code> 这么理解就可以了。</p><p>有时候会看到类也可以作为装饰器使用。其实理解起来也类似。举个例子。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -*- coding: utf-8 -*-</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>dec1</span>(object):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, fn):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;inside dec1&#39;</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>fn <span style=color:#f92672>=</span> fn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __call__(self):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;inside wrapper&#39;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>fn()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@dec1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>f1</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;inside f1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;begin exec&#39;</span>)
</span></span><span style=display:flex><span>    f1()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;end exec&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行结果:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># inside dec1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># begin exec</span>
</span></span><span style=display:flex><span><span style=color:#75715e># inside wrapper</span>
</span></span><span style=display:flex><span><span style=color:#75715e># inside f1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># end exec</span>
</span></span></code></pre></div><p>这里和上面类似，把 <code>@dec1</code> 理解成 <code>dec1(fn)()</code>，不过是这里的 <code>dec1</code> 是个类，那么 <code>dec1(fn)</code> 其实是调用的 <code>dec1.__init__(fn)</code>，那么后续的 <code>dec1(fn)()</code> 就是调用产生的对象的 <code>dec1.__call__()</code> 了。</p><p>有时候还能看到加了参数的装饰器。加了参数的是怎么回事呢。再看下面的例子。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -*- coding: utf-8 -*-</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>dec1</span>(name):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;inside dec1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>real_dec1</span>(fn):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wrapper</span>():
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#39;inside wrapper&#39;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> fn()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> wrapper
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> real_dec1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@dec1</span>(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;1&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>f1</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;inside f1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;begin exec&#39;</span>)
</span></span><span style=display:flex><span>    f1()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;end exec&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 执行结果:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># inside dec1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># begin exec</span>
</span></span><span style=display:flex><span><span style=color:#75715e># inside wrapper</span>
</span></span><span style=display:flex><span><span style=color:#75715e># inside f1</span>
</span></span><span style=display:flex><span><span style=color:#75715e># end exec</span>
</span></span></code></pre></div><p>看懂了没有，就是多了个嵌套而已。遇到加了参数的，那就是把之前的没有参数的部分返回回来就可以了。等价的例子就不贴了，这个等价于 <code>dec1(name='1')(fn)()</code>。</p><p>如果是类装饰器，并且有参数，那等价于 <code>dec1(name='1')(fn)()</code>，其中 <code>__init__(self, name)</code> 先处理第一层参数，然后 <code>__call__(fn)</code> 处理第二层，然后需要在 <code>__call__</code> 里面再定义一个 wrapper 返回。</p><p>说明白没有？呵呵。</p><p>补充一点新的知识，来自于<a href="https://www.youtube.com/watch?v=MjHpMCIvwsY&amp;list=PLPbTDk1hBo3y_yzy0ZIx_0PKlUiQ0WXG7&amp;index=9">这个视频</a>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@mydeco</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(a, b):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> a <span style=color:#f92672>+</span> b
</span></span></code></pre></div><p>上面这个等价于下面这个</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(a, b):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> a <span style=color:#f92672>+</span> b
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>add <span style=color:#f92672>=</span> mydeco(add)
</span></span></code></pre></div><p>这里面三个 callable</p><ol><li>被装饰的函数 add</li><li>mydeco 装饰方法</li><li>装饰方法返回的方法</li></ol><p>装饰器可以做的事情：</p><ol><li>timing，统计函数执行的时间。</li><li>控制函数 60 秒执行一次。通过在 dec 方法内记录一个最后执行时间实现。</li><li>类似上面的，可以任意指定限制的时间。只需要在上面的函数上面再套一层就可以。</li><li>实现结果记忆。同样的输入，总是同样的输出，那可以按照输入参数记录执行结果，下次相同参数就不用再次执行了。</li><li>给对象增加属性。可以装饰某给对象，然后增加一些属性，比如定制一下 <code>__repr__</code> 输出更好的内容。</li><li>类似的，可以装饰某个对象，然后给他增加一些属性，比如增加一个 <code>__create_at</code> 这样的属性记录一下实例创建时间。</li></ol></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://wdicc.com/favicon.ico alt=Logo><h1 class=about__title>Happy every day!</h1><p class=about__description>Good good study, day day up!</p></div><ul class=aside__social-links><li><a href=https://github.com/wd rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2016-10-21</p></div></section><footer class=page__footer><p><br><span class=active>$ echo $LANG<br><b>zh_CN</b></span><br></p><br><br><p class=copyright>wd © 2025</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>