<!doctype html><html lang=zh-CN><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Bloat and Query Speed in PostgreSQL | wd and cc</title>
<link rel=canonical href=https://wdicc.com/bloat-and-query-speed-in-postgresql/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Bloat and Query Speed in PostgreSQL"><meta property="og:description" content="内容反义自 https://www.citusdata.com/blog/2016/11/04/autovacuum-not-the-enemy/ pg 的 mvcc 会导致表索引的 bloat 就不多说了。说一下不合理处理这种 bloat 害处是啥。 首先肯定是会浪费空间。"><meta property="og:type" content="article"><meta property="og:url" content="https://wdicc.com/bloat-and-query-speed-in-postgresql/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-12-09T12:12:21+08:00"><meta property="article:modified_time" content="2016-12-09T12:12:21+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Bloat and Query Speed in PostgreSQL"><meta name=twitter:description content="内容反义自 https://www.citusdata.com/blog/2016/11/04/autovacuum-not-the-enemy/ pg 的 mvcc 会导致表索引的 bloat 就不多说了。说一下不合理处理这种 bloat 害处是啥。 首先肯定是会浪费空间。"><link rel=stylesheet href=https://wdicc.com/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><link rel=stylesheet href=https://wdicc.com/wdicc.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://wdicc.com/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://wdicc.com/full-page-write-in-postgresql/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=https://wdicc.com/release-some-staff-at-github/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&text=Bloat%20and%20Query%20Speed%20in%20PostgreSQL" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&title=Bloat%20and%20Query%20Speed%20in%20PostgreSQL" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&is_video=false&description=Bloat%20and%20Query%20Speed%20in%20PostgreSQL" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Bloat%20and%20Query%20Speed%20in%20PostgreSQL&body=Check out this article: https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&title=Bloat%20and%20Query%20Speed%20in%20PostgreSQL" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&title=Bloat%20and%20Query%20Speed%20in%20PostgreSQL" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&name=Bloat%20and%20Query%20Speed%20in%20PostgreSQL&description=%e5%86%85%e5%ae%b9%e5%8f%8d%e4%b9%89%e8%87%aa%20https%3a%2f%2fwww.citusdata.com%2fblog%2f2016%2f11%2f04%2fautovacuum-not-the-enemy%2f%20pg%20%e7%9a%84%20mvcc%20%e4%bc%9a%e5%af%bc%e8%87%b4%e8%a1%a8%e7%b4%a2%e5%bc%95%e7%9a%84%20bloat%20%e5%b0%b1%e4%b8%8d%e5%a4%9a%e8%af%b4%e4%ba%86%e3%80%82%e8%af%b4%e4%b8%80%e4%b8%8b%e4%b8%8d%e5%90%88%e7%90%86%e5%a4%84%e7%90%86%e8%bf%99%e7%a7%8d%20bloat%20%e5%ae%b3%e5%a4%84%e6%98%af%e5%95%a5%e3%80%82%20%e9%a6%96%e5%85%88%e8%82%af%e5%ae%9a%e6%98%af%e4%bc%9a%e6%b5%aa%e8%b4%b9%e7%a9%ba%e9%97%b4%e3%80%82" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&t=Bloat%20and%20Query%20Speed%20in%20PostgreSQL" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Bloat and Query Speed in PostgreSQL</h1><div class=meta><span class=author itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>wd</span></span><div class=postdate><time datetime="2016-12-09 12:12:21 +0800 +0800" itemprop=datePublished>2016-12-09</time></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/postgresql rel=tag>postgresql</a></div></div></header><div id=toc><nav id=TableOfContents></nav></div><div class=content itemprop=articleBody><p>内容反义自 <a href=https://www.citusdata.com/blog/2016/11/04/autovacuum-not-the-enemy/>https://www.citusdata.com/blog/2016/11/04/autovacuum-not-the-enemy/</a></p><p>pg 的 mvcc 会导致表索引的 bloat 就不多说了。说一下不合理处理这种 bloat 害处是啥。</p><p>首先肯定是会浪费空间。然后也会影响查询速度。表和索引存储的时候都是 8kB 一个 page，如果一个查询一些行，数据库会加载这些 pages 到内存。一个 page 里面的 dead rows 越多，在加载的时候就越浪费 I/O。例如全表扫描会加载所有的 dead rows。</p><p>Bloat 还会导致热门的查询会一下塞满内存。会导致相同的 live rows 需要更多 pages。This causes swapping and makes certain query plans and algorithms ineligible for execution.</p><p>还有一个影响是，pg 的系统表也会有可能 bloat，因为他们也是表。导致这个的一种情况是频繁的创建和删除临时表。这个进一步会导致一些管理命令执行变慢，甚至比如 <code>\d</code> 这种命令。</p><p>索引也有可能会 bloat。索引是 tuple 标识和数据之间的一个映射。这些标识指向的是某个 page 里面的 offset。每个 tuple 都是一个独立的对象，需要自己的索引条目。更新一行的时候总是会创建这行的新的索引条目。</p><p>索引的 bloat 的影响比 table 小一点。索引里面指向 dead tuple 的可以直接标记为 dead. 这会使得索引膨胀，但是不会导致不必要的堆查找。同时更新堆中的 tuples 不影响已经索引的列，使用一种叫做 HOT 的技术来把指向 dead tuples 的指针指向新的。这允许查询可以通过这些指针复用旧的索引条目。(Also updates to tuples in the heap that do not affect the indexed column(s) use a technique called HOT to provide pointers from the dead tuple to its replacement. This allows queries to reuses old index entries by following pointers across the heap.) (没太看明白.)</p><p>索引 bloat 的问题还是应该需要重视。例如 btree 索引是由二叉树组成()。叶子节点包含值和 tuple 标识（应该是指在 data file 的 offset）。随机更新因为会重用 page，所以可以保持 btree 维持一个良好的形状。但是，如果是单侧更新，会导致大量的空页。</p><p>The size considerations of index bloat are still significant. For instance a btree index consists of binary tree of pages (the same sized pages as you find holding tuples in the heap). The leaf node pages contain values and tuple identifiers. Uniform random table updates tend to keep a btree index in pretty good shape because it can reuse pages. However lopsided inserts/updates affecting one side of the tree while preserving a few straggling entries can lead to lots of mostly empty pages.</p></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&text=Bloat%20and%20Query%20Speed%20in%20PostgreSQL" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&title=Bloat%20and%20Query%20Speed%20in%20PostgreSQL" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&is_video=false&description=Bloat%20and%20Query%20Speed%20in%20PostgreSQL" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Bloat%20and%20Query%20Speed%20in%20PostgreSQL&body=Check out this article: https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&title=Bloat%20and%20Query%20Speed%20in%20PostgreSQL" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&title=Bloat%20and%20Query%20Speed%20in%20PostgreSQL" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&name=Bloat%20and%20Query%20Speed%20in%20PostgreSQL&description=%e5%86%85%e5%ae%b9%e5%8f%8d%e4%b9%89%e8%87%aa%20https%3a%2f%2fwww.citusdata.com%2fblog%2f2016%2f11%2f04%2fautovacuum-not-the-enemy%2f%20pg%20%e7%9a%84%20mvcc%20%e4%bc%9a%e5%af%bc%e8%87%b4%e8%a1%a8%e7%b4%a2%e5%bc%95%e7%9a%84%20bloat%20%e5%b0%b1%e4%b8%8d%e5%a4%9a%e8%af%b4%e4%ba%86%e3%80%82%e8%af%b4%e4%b8%80%e4%b8%8b%e4%b8%8d%e5%90%88%e7%90%86%e5%a4%84%e7%90%86%e8%bf%99%e7%a7%8d%20bloat%20%e5%ae%b3%e5%a4%84%e6%98%af%e5%95%a5%e3%80%82%20%e9%a6%96%e5%85%88%e8%82%af%e5%ae%9a%e6%98%af%e4%bc%9a%e6%b5%aa%e8%b4%b9%e7%a9%ba%e9%97%b4%e3%80%82" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwdicc.com%2fbloat-and-query-speed-in-postgresql%2f&t=Bloat%20and%20Query%20Speed%20in%20PostgreSQL" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2024 wd and cc</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>