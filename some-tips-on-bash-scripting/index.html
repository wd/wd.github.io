<!doctype html><html lang=en><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://wdicc.com/favicon.ico><title>Some tips for bash scripting | wd and cc</title><meta name=title content="Some tips for bash scripting"><meta name=description content="最近几天写了一些 bash 脚本，又有些心得，记录一下。
获取当前路径的绝对路径
比较常见的需求可能是获取相对路径，这样方便程序复制到其他目录也可以运行。使用 $(dirname $0) 就可以获取相对路径，不过这里说的是绝对路径。
其实也简单，相对路径加上当前目录，那不就是绝对路径么。不过是，有时候 $(dirname $0) 取到的也可能是绝对路径（一般期望相对路径的程序也能跑通，所以不大关心）。"><meta name=keywords content="web,"><meta property="og:url" content="https://wdicc.com/some-tips-on-bash-scripting/"><meta property="og:site_name" content="wd and cc"><meta property="og:title" content="Some tips for bash scripting"><meta property="og:description" content="最近几天写了一些 bash 脚本，又有些心得，记录一下。
获取当前路径的绝对路径 比较常见的需求可能是获取相对路径，这样方便程序复制到其他目录也可以运行。使用 $(dirname $0) 就可以获取相对路径，不过这里说的是绝对路径。
其实也简单，相对路径加上当前目录，那不就是绝对路径么。不过是，有时候 $(dirname $0) 取到的也可能是绝对路径（一般期望相对路径的程序也能跑通，所以不大关心）。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-12-02T19:43:00+08:00"><meta property="article:modified_time" content="2012-12-02T19:43:00+08:00"><meta property="article:tag" content="Web"><meta name=twitter:card content="summary"><meta name=twitter:title content="Some tips for bash scripting"><meta name=twitter:description content="最近几天写了一些 bash 脚本，又有些心得，记录一下。
获取当前路径的绝对路径 比较常见的需求可能是获取相对路径，这样方便程序复制到其他目录也可以运行。使用 $(dirname $0) 就可以获取相对路径，不过这里说的是绝对路径。
其实也简单，相对路径加上当前目录，那不就是绝对路径么。不过是，有时候 $(dirname $0) 取到的也可能是绝对路径（一般期望相对路径的程序也能跑通，所以不大关心）。"><meta itemprop=name content="Some tips for bash scripting"><meta itemprop=description content="最近几天写了一些 bash 脚本，又有些心得，记录一下。
获取当前路径的绝对路径 比较常见的需求可能是获取相对路径，这样方便程序复制到其他目录也可以运行。使用 $(dirname $0) 就可以获取相对路径，不过这里说的是绝对路径。
其实也简单，相对路径加上当前目录，那不就是绝对路径么。不过是，有时候 $(dirname $0) 取到的也可能是绝对路径（一般期望相对路径的程序也能跑通，所以不大关心）。"><meta itemprop=datePublished content="2012-12-02T19:43:00+08:00"><meta itemprop=dateModified content="2012-12-02T19:43:00+08:00"><meta itemprop=wordCount content="861"><meta itemprop=keywords content="Web"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--code-background-color:#f2f2f2;--code-color:#222;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--code-background-color:#000;--code-color:#ddd;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px}blockquote{border-left:1px solid #999;color:var(--code-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{padding:1px 15px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>wd and cc</h2></a><p>-- Good good study, day day up!</p><nav><a href=/>Home</a>
<a href=/posts/>Posts</a>
<a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a>
<a href=/tags/>Tags</a>
<a href=/atom.xml>subscribe</a></nav></header><main><h1>Some tips for bash scripting</h1><p><i><time datetime=2012-12-02>02 Dec, 2012
</time></i><a href=https://wdicc.com/tags/web/>#Web</a></p><content><p>最近几天写了一些 bash 脚本，又有些心得，记录一下。</p><h2 id=获取当前路径的绝对路径>获取当前路径的绝对路径</h2><p>比较常见的需求可能是获取相对路径，这样方便程序复制到其他目录也可以运行。使用 <code>$(dirname $0)</code> 就可以获取相对路径，不过这里说的是绝对路径。</p><p>其实也简单，相对路径加上当前目录，那不就是绝对路径么。不过是，有时候 <code>$(dirname $0)</code> 取到的也可能是绝对路径（一般期望相对路径的程序也能跑通，所以不大关心）。</p><p>可以用下面的做法，大意是先判断一下获取到的路径是不是 <code>/</code> 开头，如果是，那就不处理，如果不是，那就把当前的路径附加上去得到一个绝对路径。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#bb60d5>PG_DIR</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;</span><span style=color:#007020;font-weight:700>$(</span>dirname <span style=color:#bb60d5>$0</span><span style=color:#007020;font-weight:700>)</span><span style=color:#4070a0>/../&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$PG_DIR</span><span style=color:#4070a0>&#34;</span> | grep -q ^/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#007020;font-weight:700>if</span> <span style=color:#666>[</span> <span style=color:#bb60d5>$?</span> -ne <span style=color:#40a070>0</span> <span style=color:#666>]</span>;<span style=color:#007020;font-weight:700>then</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>        <span style=color:#bb60d5>PG_DIR</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;</span><span style=color:#007020;font-weight:700>$(</span><span style=color:#007020>pwd</span><span style=color:#007020;font-weight:700>)</span><span style=color:#4070a0>/</span><span style=color:#bb60d5>$PG_DIR</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#007020;font-weight:700>fi</span>
</span></span></code></pre></div><h2 id=使用-getopt-获取命令行参数>使用 getopt 获取命令行参数</h2><p>获取参数比较常见的做法是取 <code>$1</code> <code>$2</code> 这些，不过不太专业，这里说的是类似于 <code>--prefix=/path/to/install -v</code> 这种。</p><p>bash 本身提供了一个内部命令 <code>getopts</code> 来做这个事情，不过那个只能支持 short_opts，就是类似 <code>-v</code> 这种，不支持长的。</p><p>getopt 是一个 GNU 程序，他支持 long_opts。下面是个例子。代码基本来自网上。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#bb60d5>ARGS</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span>getopt -a -o h -l initdb::,help -- <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$@</span><span style=color:#4070a0>&#34;</span><span style=color:#007020;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#666>[</span> <span style=color:#bb60d5>$?</span> -ne <span style=color:#40a070>0</span> <span style=color:#666>]</span> <span style=color:#666>&amp;&amp;</span> usage
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#007020>eval</span> <span style=color:#007020>set</span> -- <span style=color:#4070a0>&#34;</span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>ARGS</span><span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#007020;font-weight:700>while</span> <span style=color:#007020>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#007020;font-weight:700>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#007020;font-weight:700>case</span> <span style=color:#bb60d5>$1</span> in
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                --initdb<span style=color:#666>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                        initdb <span style=color:#bb60d5>$2</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>                        ;;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>                -h|--help<span style=color:#666>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                        usage;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>                        ;;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>                --<span style=color:#666>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>                        <span style=color:#007020>shift</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>                        <span style=color:#007020>break</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>                        ;;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#007020;font-weight:700>esac</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#007020>shift</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#007020;font-weight:700>done</span>
</span></span></code></pre></div><p>解释一下上面的参数的含义:</p><ul><li><code>-o</code> 参数指定的就是短参数，我试过，貌似还得指定至少一个短参数。</li><li><code>-l</code> 参数指定的就是长参数。</li><li>多个参数用逗号 <code>,</code> 分隔。</li><li>参数后面跟一个冒号 <code>:</code> 表示这个参数(option)必须要给一个参数(argument)，类似上面的 <code>--prefix=/path/to/install</code> 这种。</li><li>参数后面跟2个冒号 <code>::</code> 表示这个参数后面的参数可有可无。比如例子里面的 <code>--initdb</code></li></ul><h2 id=find-exec-提示-no-such-file-or-directory>find exec 提示 No such file or directory</h2><p>这个是之前用来日志删除的一个程序，大概命令类似 <code>find ./ -name '2012*' -exec rm -r {} \;</code>，后来总发现报 <code>No such file or directory</code> 这个错误，可是去看的时候，发现那些目录也被删掉了。开始觉得可能是有其他人的程序也在删除这个目录，问了一圈结果没人删。</p><p>后来经过测试琢磨找到原因了，在于这个命令的执行思路大概是先去找那个名字的文件或者目录，然后挨个执行后面的命令。那么，如果找到的既有上级目录，也有下级文件的时候，如果目录先被删掉了，那删文件的时候可不就是 <code>No such file or directory</code> 么。</p><p>好在 find 提供了一个参数 <code>-prune</code></p><pre tabindex=0><code>       -prune True; if the file is a directory, do not descend into it. If -depth is given, false; no effect.  Because -delete implies -depth, you can-
              not usefully use -prune and -delete together.
</code></pre></content><div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//wdicc.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>