<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, viewport-fit=cover, initial-scale=1">
    <title>Upgrade to React 16.3 | wd and cc</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <header>

  
  
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://wdicc.com/">/home/wd and cc</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/tags/">~/tags</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/resume/">~/resume</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">~/search</a>
      </li>
      

      
      
      <li class="pull-right">
        <a href="/atom.xml">~/subscribe</a>
      </li>
      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">Upgrade to React 16.3</span></h1>

<h2 class="date">2018/10/22</h2>
<p class="terms">
  
  
  
  
  Tags: <a href="/tags/javascript">javascript</a> <a href="/tags/react">react</a> 
  
  
</p>
</div>












<main>

<p>
随着 React native 升级，React 也升级到了 16.5 了。原来的改成新的生命周期了。
</p>
<div class="src src-javascript">
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#080;font-weight:bold">class</span> ExampleComponent <span style="color:#080;font-weight:bold">extends</span> React.Component {
  <span style="color:#080;font-weight:bold">static</span> getDerivedStateFromProps(nextProps, prevState) {
    <span style="color:#888">// Called after a component is instantiated or before it receives new props.
</span><span style="color:#888"></span>    <span style="color:#888">// Return an object to update state in response to prop changes.
</span><span style="color:#888"></span>    <span style="color:#888">// Return null to indicate no change to state.
</span><span style="color:#888"></span>  }

  UNSAFE_componentWillMount() {
    <span style="color:#888">// New name for componentWillMount()
</span><span style="color:#888"></span>    <span style="color:#888">// Indicates that this method can be unsafe for async rendering.
</span><span style="color:#888"></span>    <span style="color:#888">// Prefer componentDidMount() instead.
</span><span style="color:#888"></span>  }

  UNSAFE_componentWillUpdate(nextProps, nextState) {
    <span style="color:#888">// New name for componentWillUpdate()
</span><span style="color:#888"></span>    <span style="color:#888">// Indicates that this method can be unsafe for async rendering.
</span><span style="color:#888"></span>    <span style="color:#888">// Prefer componentDidUpdate() instead.
</span><span style="color:#888"></span>  }

  UNSAFE_componentWillReceiveProps(nextProps) {
    <span style="color:#888">// New name for componentWillReceiveProps()
</span><span style="color:#888"></span>    <span style="color:#888">// Indicates that this method can be unsafe for async rendering.
</span><span style="color:#888"></span>    <span style="color:#888">// Prefer static getDerivedStateFromProps() instead.
</span><span style="color:#888"></span>  }
}
</code></pre></td></tr></table>
</div>
</div>
</div>
<p>
React 在后面的版本里面，这几个方法都会被加上 <code class="verbatim">UNSAFE_</code> ，直到被移除。
</p>
<p>
我们在 <code class="verbatim">componentWillReceiveProps</code> 里面主要是做了一个事情是根据后端反的数据来更新界面内容。因为我们用了 redux + saga，所以需要在这里做这个事情，如果是通过回调来更新数据的话，就不用这么麻烦了，直接在回调里面设置 state 就可以了。
</p>
<p>
因为在 <code class="verbatim">getDerivedStateFromProps</code> 里面不让接触现在的 <code class="verbatim">this.props</code> ，所以也不能简单的把原来 <code class="verbatim">componentWillReceiveProps</code> 的代码直接复制过来用。解决思路下面的链接都提到了很多，我自己总结有那几个。
</p>
<h2 id="headline-1">
和 prevState 做比较
</h2>
<p>
比如想象一个页面有两个按钮，一个点了之后会 setState 为 <code class="verbatim">test1</code> ，另一个按钮点了之后，会通过网络请求更新 store，然后更新 props 为 <code class="verbatim">test2</code> ，那这个时候只需要和当前的 state 做比较就可以决定是不是要设置新的 state 了。
</p>
<h2 id="headline-2">
把 preProps 保存到 state 然后和 prevState 做比较
</h2>
<p>
这么做基本就和原来使用 <code class="verbatim">componentWillReceiveProps</code> 基本一样了。没什么好说的了。
</p>
<h2 id="headline-3">
在 render 里面综合 state 和 props 的值
</h2>
<p>
比如有时候页面显示的是用户录入和 props 的数据综合的，那可以在 render 里面做这个合并的工作。
</p>
<h2 id="headline-4">
参考链接
</h2>
<ul>
<li>
<p>
<a href="https://github.com/reactjs/rfcs/blob/master/text/0006-static-lifecycle-methods.md#common-problems">React 关于新的生命周期的 rfc</a>
</p>
</li>
<li>
<p>
<a href="https://reactjs.org/docs/react-component.html#unsafe_componentwillreceiveprops">关于使用场景比较多升级的时候处理比较麻烦的 componentWillReceiveProps 方法</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/reactjs/reactjs.org/issues/721">关于 componentWillReceiveProps 方法和 getDerivedStateFromProps 的讨论</a>
</p>
</li>
<li>
<p>
<a href="https://zhuanlan.zhihu.com/p/33925435">关于新的生命周期国内人的中文解释</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/fi3ework/blog/issues/37">另一篇国人的解释</a>
</p>
</li>
<li>
<p>
<a href="https://reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html">React 官方关于 getDerivedStateFromProps 使用的一些建议</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/reactjs/rfcs/pull/40">关于为啥不在 getDerivedStateFromProps 里面加一个 prevProps 的讨论</a>
</p>
</li>
</ul>

</main>


<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</section>


    
     <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = '';
            this.page.identifier = '';
        };

        (function() {
          var d = document, s = d.createElement('script');
          s.src = '//wdicc.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
     </script>
    





    <footer style="clear:both">
      
      <hr/>
      Theme from <a href="https://github.com/wd/hugo-classic">hugo-classic</a> fork from <a href="https://github.com/goodroot/hugo-classic">Github</a>
      
    </footer>
  </body>
</html>

