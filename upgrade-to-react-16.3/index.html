<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Upgrade to React 16.3 - wd and cc</title><link rel=icon type=image/png href=/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Upgrade to React 16.3"><meta property="og:description" content="随着 React native 升级，React 也升级到了 16.5 了。原来的改成新的生命周期了。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17"><meta property="og:type" content="article"><meta property="og:url" content="https://wdicc.com/upgrade-to-react-16.3/"><meta property="article:published_time" content="2018-10-22T16:21:30+08:00"><meta property="article:modified_time" content="2018-10-22T16:21:30+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Upgrade to React 16.3"><meta name=twitter:description content="随着 React native 升级，React 也升级到了 16.5 了。原来的改成新的生命周期了。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17"><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://wdicc.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://wdicc.com/css/main.css><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=https://wdicc.com/js/main.js></script></head><body><div class="container wrapper post"><div class=header><base href=https://wdicc.com/><h1 class=site-title><a href=https://wdicc.com/>wd and cc</a></h1><div class=site-description><h2>&mdash; Happy every day</h2><nav class="nav social"><ul class=flat><a href=https://github.com/wd title=Github><i data-feather=github></i></a><a href=https://twitter.com/wd title=Twitter><i data-feather=twitter></i></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/post>All posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></nav></div><div class=post-header><h1 class=title>Upgrade to React 16.3</h1><div class=meta>Posted at &mdash; Oct 22, 2018</div></div><div class=post-header><nav id=TableOfContents><ul><li><a href=#headline-1>和 prevState 做比较</a></li><li><a href=#headline-2>把 preProps 保存到 state 然后和 prevState 做比较</a></li><li><a href=#headline-3>在 render 里面综合 state 和 props 的值</a></li><li><a href=#headline-4>参考链接</a></li></ul></nav></div><div class=markdown><p>随着 React native 升级，React 也升级到了 16.5 了。原来的改成新的生命周期了。</p><div class="src src-javascript"><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#080;font-weight:700>class</span> ExampleComponent <span style=color:#080;font-weight:700>extends</span> React.Component {
  <span style=color:#080;font-weight:700>static</span> getDerivedStateFromProps(nextProps, prevState) {
    <span style=color:#888>// Called after a component is instantiated or before it receives new props.
</span><span style=color:#888></span>    <span style=color:#888>// Return an object to update state in response to prop changes.
</span><span style=color:#888></span>    <span style=color:#888>// Return null to indicate no change to state.
</span><span style=color:#888></span>  }

  UNSAFE_componentWillMount() {
    <span style=color:#888>// New name for componentWillMount()
</span><span style=color:#888></span>    <span style=color:#888>// Indicates that this method can be unsafe for async rendering.
</span><span style=color:#888></span>    <span style=color:#888>// Prefer componentDidMount() instead.
</span><span style=color:#888></span>  }

  UNSAFE_componentWillUpdate(nextProps, nextState) {
    <span style=color:#888>// New name for componentWillUpdate()
</span><span style=color:#888></span>    <span style=color:#888>// Indicates that this method can be unsafe for async rendering.
</span><span style=color:#888></span>    <span style=color:#888>// Prefer componentDidUpdate() instead.
</span><span style=color:#888></span>  }

  UNSAFE_componentWillReceiveProps(nextProps) {
    <span style=color:#888>// New name for componentWillReceiveProps()
</span><span style=color:#888></span>    <span style=color:#888>// Indicates that this method can be unsafe for async rendering.
</span><span style=color:#888></span>    <span style=color:#888>// Prefer static getDerivedStateFromProps() instead.
</span><span style=color:#888></span>  }
}
</code></pre></td></tr></table></div></div></div><p>React 在后面的版本里面，这几个方法都会被加上 <code class=verbatim>UNSAFE_</code> ，直到被移除。</p><p>我们在 <code class=verbatim>componentWillReceiveProps</code> 里面主要是做了一个事情是根据后端反的数据来更新界面内容。因为我们用了 redux + saga，所以需要在这里做这个事情，如果是通过回调来更新数据的话，就不用这么麻烦了，直接在回调里面设置 state 就可以了。</p><p>因为在 <code class=verbatim>getDerivedStateFromProps</code> 里面不让接触现在的 <code class=verbatim>this.props</code> ，所以也不能简单的把原来 <code class=verbatim>componentWillReceiveProps</code> 的代码直接复制过来用。解决思路下面的链接都提到了很多，我自己总结有那几个。</p><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>和 prevState 做比较</h2><div id=outline-text-headline-1 class=outline-text-2><p>比如想象一个页面有两个按钮，一个点了之后会 setState 为 <code class=verbatim>test1</code> ，另一个按钮点了之后，会通过网络请求更新 store，然后更新 props 为 <code class=verbatim>test2</code> ，那这个时候只需要和当前的 state 做比较就可以决定是不是要设置新的 state 了。</p></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>把 preProps 保存到 state 然后和 prevState 做比较</h2><div id=outline-text-headline-2 class=outline-text-2><p>这么做基本就和原来使用 <code class=verbatim>componentWillReceiveProps</code> 基本一样了。没什么好说的了。</p></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>在 render 里面综合 state 和 props 的值</h2><div id=outline-text-headline-3 class=outline-text-2><p>比如有时候页面显示的是用户录入和 props 的数据综合的，那可以在 render 里面做这个合并的工作。</p></div></div><div id=outline-container-headline-4 class=outline-2><h2 id=headline-4>参考链接</h2><div id=outline-text-headline-4 class=outline-text-2><ul><li><p><a href=https://github.com/reactjs/rfcs/blob/master/text/0006-static-lifecycle-methods.md#common-problems>React 关于新的生命周期的 rfc</a></p></li><li><p><a href=https://reactjs.org/docs/react-component.html#unsafe_componentwillreceiveprops>关于使用场景比较多升级的时候处理比较麻烦的 componentWillReceiveProps 方法</a></p></li><li><p><a href=https://github.com/reactjs/reactjs.org/issues/721>关于 componentWillReceiveProps 方法和 getDerivedStateFromProps 的讨论</a></p></li><li><p><a href=https://zhuanlan.zhihu.com/p/33925435>关于新的生命周期国内人的中文解释</a></p></li><li><p><a href=https://github.com/fi3ework/blog/issues/37>另一篇国人的解释</a></p></li><li><p><a href=https://reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html>React 官方关于 getDerivedStateFromProps 使用的一些建议</a></p></li><li><p><a href=https://github.com/reactjs/rfcs/pull/40>关于为啥不在 getDerivedStateFromProps 里面加一个 prevProps 的讨论</a></p></li></ul></div></div></div><div class=post-tags><nav class="nav tags"><ul class=flat><li><a href=/tags/javascript>javascript</a></li><li><a href=/tags/react>react</a></li></ul></nav></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")
return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='wdicc';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by
Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div class="footer wrapper"><nav class=nav><div>Copyright © 2020 wd. All Rights Reserved | <a href=https://github.com/vividvilla/ezhil>Ezhil theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></nav></div><script>feather.replace()</script></body></html>