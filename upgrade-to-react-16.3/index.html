<!doctype html><html lang=en><head><title>Upgrade to React 16.3 &ndash; wd and cc</title>
<meta name=description content="Good good study, day day up!"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://wdicc.com/css/palettes/base16-dark.css><link rel=stylesheet href=https://wdicc.com/css/risotto.css><link rel=stylesheet href=https://wdicc.com/css/custom.css><link rel=icon href=https://wdicc.com/favicon.ico></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><h1 class=page__logo><a href=https://wdicc.com/ class=page__logo-inner>wd and cc</a></h1><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/posts/ title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=" title>Search</a></li><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/atom.xml title>subscribe</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Upgrade to React 16.3</h1></header><div class=content__body><p>随着 React native 升级，React 也升级到了 16.5 了。原来的改成新的生命周期了。</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExampleComponent</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>Component</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#a6e22e>getDerivedStateFromProps</span>(<span style=color:#a6e22e>nextProps</span>, <span style=color:#a6e22e>prevState</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Called after a component is instantiated or before it receives new props.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Return an object to update state in response to prop changes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Return null to indicate no change to state.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>UNSAFE_componentWillMount</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// New name for componentWillMount()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Indicates that this method can be unsafe for async rendering.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Prefer componentDidMount() instead.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>UNSAFE_componentWillUpdate</span>(<span style=color:#a6e22e>nextProps</span>, <span style=color:#a6e22e>nextState</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// New name for componentWillUpdate()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Indicates that this method can be unsafe for async rendering.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Prefer componentDidUpdate() instead.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>UNSAFE_componentWillReceiveProps</span>(<span style=color:#a6e22e>nextProps</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// New name for componentWillReceiveProps()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Indicates that this method can be unsafe for async rendering.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Prefer static getDerivedStateFromProps() instead.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>React 在后面的版本里面，这几个方法都会被加上 <code class=verbatim>UNSAFE_</code> ，直到被移除。</p><p>我们在 <code class=verbatim>componentWillReceiveProps</code> 里面主要是做了一个事情是根据后端反的数据来更新界面内容。因为我们用了 redux + saga，所以需要在这里做这个事情，如果是通过回调来更新数据的话，就不用这么麻烦了，直接在回调里面设置 state 就可以了。</p><p>因为在 <code class=verbatim>getDerivedStateFromProps</code> 里面不让接触现在的 <code class=verbatim>this.props</code> ，所以也不能简单的把原来 <code class=verbatim>componentWillReceiveProps</code> 的代码直接复制过来用。解决思路下面的链接都提到了很多，我自己总结有那几个。</p><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>和 prevState 做比较</h2><div id=outline-text-headline-1 class=outline-text-2><p>比如想象一个页面有两个按钮，一个点了之后会 setState 为 <code class=verbatim>test1</code> ，另一个按钮点了之后，会通过网络请求更新 store，然后更新 props 为 <code class=verbatim>test2</code> ，那这个时候只需要和当前的 state 做比较就可以决定是不是要设置新的 state 了。</p></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>把 preProps 保存到 state 然后和 prevState 做比较</h2><div id=outline-text-headline-2 class=outline-text-2><p>这么做基本就和原来使用 <code class=verbatim>componentWillReceiveProps</code> 基本一样了。没什么好说的了。</p></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>在 render 里面综合 state 和 props 的值</h2><div id=outline-text-headline-3 class=outline-text-2><p>比如有时候页面显示的是用户录入和 props 的数据综合的，那可以在 render 里面做这个合并的工作。</p></div></div><div id=outline-container-headline-4 class=outline-2><h2 id=headline-4>参考链接</h2><div id=outline-text-headline-4 class=outline-text-2><ul><li><a href=https://github.com/reactjs/rfcs/blob/master/text/0006-static-lifecycle-methods.md#common-problems>React 关于新的生命周期的 rfc</a></li><li><a href=https://reactjs.org/docs/react-component.html#unsafe_componentwillreceiveprops>关于使用场景比较多升级的时候处理比较麻烦的 componentWillReceiveProps 方法</a></li><li><a href=https://github.com/reactjs/reactjs.org/issues/721>关于 componentWillReceiveProps 方法和 getDerivedStateFromProps 的讨论</a></li><li><a href=https://zhuanlan.zhihu.com/p/33925435>关于新的生命周期国内人的中文解释</a></li><li><a href=https://github.com/fi3ework/blog/issues/37>另一篇国人的解释</a></li><li><a href=https://reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html>React 官方关于 getDerivedStateFromProps 使用的一些建议</a></li><li><a href=https://github.com/reactjs/rfcs/pull/40>关于为啥不在 getDerivedStateFromProps 里面加一个 prevProps 的讨论</a></li></ul></div></div></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://wdicc.com/favicon.ico alt=Logo><h1 class=about__title>Happy every day!</h1><p class=about__description>Good good study, day day up!</p></div><ul class=aside__social-links><li><a href=https://github.com/wd rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2018-10-22</p><hr>On this page:<nav id=TableOfContents><ul><li><a href=#headline-1>和 prevState 做比较</a></li><li><a href=#headline-2>把 preProps 保存到 state 然后和 prevState 做比较</a></li><li><a href=#headline-3>在 render 里面综合 state 和 props 的值</a></li><li><a href=#headline-4>参考链接</a></li></ul></nav></div></section><footer class=page__footer><p><br><span class=active>$ echo $LANG<br><b>zh_CN</b></span><br></p><br><br><p class=copyright>wd © 2025</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>