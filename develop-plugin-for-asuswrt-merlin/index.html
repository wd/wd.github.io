<!doctype html><html lang=en><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://wdicc.com/favicon.ico><title>Develop Plugin for Asuswrt Merlin | wd and cc</title><meta name=title content="Develop Plugin for Asuswrt Merlin"><meta name=description content="换华硕路由器之后，一直用的是梅林（merlin）的固件（rom）。基于这个固件，有一个 koolshare 的团队做了很多插件，并且做了一个通用的软件中心，可以方便的管理插件，还挺不错的。

打算用 v2ray 的时候，就想着如何才能无缝替换掉 ss。因为 v2ray 在路由器上面跑效率不高内存占用比较高，ss 作者开始说不打算支持 v2ray。后来研究了 ss 原理之后发现替换很简单，只需要具备 2 个功能就可以，一个是可以支持 socks 代理，一个是可以透明转发流量的端口。这两个协议在 v2ray 都支持，所以要做的其实就是在启动 ss 相应软件的时候启动 v2ray 的就可以了。"><meta name=keywords content="merlin,koolshare,asuswrt,"><meta property="og:url" content="https://wdicc.com/develop-plugin-for-asuswrt-merlin/"><meta property="og:site_name" content="wd and cc"><meta property="og:title" content="Develop Plugin for Asuswrt Merlin"><meta property="og:description" content="换华硕路由器之后，一直用的是梅林（merlin）的固件（rom）。基于这个固件，有一个 koolshare 的团队做了很多插件，并且做了一个通用的软件中心，可以方便的管理插件，还挺不错的。
打算用 v2ray 的时候，就想着如何才能无缝替换掉 ss。因为 v2ray 在路由器上面跑效率不高内存占用比较高，ss 作者开始说不打算支持 v2ray。后来研究了 ss 原理之后发现替换很简单，只需要具备 2 个功能就可以，一个是可以支持 socks 代理，一个是可以透明转发流量的端口。这两个协议在 v2ray 都支持，所以要做的其实就是在启动 ss 相应软件的时候启动 v2ray 的就可以了。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-05-13T08:03:28+08:00"><meta property="article:modified_time" content="2018-05-13T08:03:28+08:00"><meta property="article:tag" content="Merlin"><meta property="article:tag" content="Koolshare"><meta property="article:tag" content="Asuswrt"><meta name=twitter:card content="summary"><meta name=twitter:title content="Develop Plugin for Asuswrt Merlin"><meta name=twitter:description content="换华硕路由器之后，一直用的是梅林（merlin）的固件（rom）。基于这个固件，有一个 koolshare 的团队做了很多插件，并且做了一个通用的软件中心，可以方便的管理插件，还挺不错的。
打算用 v2ray 的时候，就想着如何才能无缝替换掉 ss。因为 v2ray 在路由器上面跑效率不高内存占用比较高，ss 作者开始说不打算支持 v2ray。后来研究了 ss 原理之后发现替换很简单，只需要具备 2 个功能就可以，一个是可以支持 socks 代理，一个是可以透明转发流量的端口。这两个协议在 v2ray 都支持，所以要做的其实就是在启动 ss 相应软件的时候启动 v2ray 的就可以了。"><meta itemprop=name content="Develop Plugin for Asuswrt Merlin"><meta itemprop=description content="换华硕路由器之后，一直用的是梅林（merlin）的固件（rom）。基于这个固件，有一个 koolshare 的团队做了很多插件，并且做了一个通用的软件中心，可以方便的管理插件，还挺不错的。
打算用 v2ray 的时候，就想着如何才能无缝替换掉 ss。因为 v2ray 在路由器上面跑效率不高内存占用比较高，ss 作者开始说不打算支持 v2ray。后来研究了 ss 原理之后发现替换很简单，只需要具备 2 个功能就可以，一个是可以支持 socks 代理，一个是可以透明转发流量的端口。这两个协议在 v2ray 都支持，所以要做的其实就是在启动 ss 相应软件的时候启动 v2ray 的就可以了。"><meta itemprop=datePublished content="2018-05-13T08:03:28+08:00"><meta itemprop=dateModified content="2018-05-13T08:03:28+08:00"><meta itemprop=wordCount content="2016"><meta itemprop=keywords content="Merlin,Koolshare,Asuswrt"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--code-background-color:#f2f2f2;--code-color:#222;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--code-background-color:#000;--code-color:#ddd;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px}blockquote{border-left:1px solid #999;color:var(--code-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto !important}.highlight,.code{padding:1px 15px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>wd and cc</h2></a><p>-- Good good study, day day up!</p><nav><a href=/>Home</a>
<a href=/posts/>Posts</a>
<a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a>
<a href=/tags/>Tags</a>
<a href=/atom.xml>subscribe</a></nav></header><main><h1>Develop Plugin for Asuswrt Merlin</h1><p><i><time datetime=2018-05-13>13 May, 2018
</time></i><a href=https://wdicc.com/tags/merlin/>#Merlin</a>
<a href=https://wdicc.com/tags/koolshare/>#Koolshare</a>
<a href=https://wdicc.com/tags/asuswrt/>#Asuswrt</a></p><content><p>换华硕路由器之后，一直用的是梅林（merlin）的固件（rom）。基于这个固件，有一个 <a href=http://koolshare.cn/forum-96-1.html>koolshare</a> 的团队做了很多插件，并且做了一个通用的软件中心，可以方便的管理插件，还挺不错的。</p><p>打算用 v2ray 的时候，就想着如何才能无缝替换掉 ss。因为 v2ray 在路由器上面跑效率不高内存占用比较高，ss 作者开始说不打算支持 v2ray。后来研究了 ss 原理之后发现替换很简单，只需要具备 2 个功能就可以，一个是可以支持 socks 代理，一个是可以透明转发流量的端口。这两个协议在 v2ray 都支持，所以要做的其实就是在启动 ss 相应软件的时候启动 v2ray 的就可以了。</p><p>基于这个逻辑写了一个<a href=https://gist.github.com/wd/e0bc83b33ce63506a9bdbc3b81658c52>文档</a> ，能弄明白的话，自己用应该也够了。后来一时兴起，做了一个<a href=https://gist.github.com/wd/1445e3fcf0c9bc535a6e70d2de1d1624>改进版</a>。这个版本基本上就傻瓜化了。做的时候对基于 merlin 开发有了一些经验记录一下，发现讲这个的东西不多。</p><div id=outline-container-headline-1 class=outline-2><h2 id=headline-1>一些基础知识</h2><div id=outline-text-headline-1 class=outline-text-2><p>路由器上面的内容是只读的，修改之后重启就会重置。但是 JFFS 分区里面的内容是会保留的。想要保存数据有两个方法。</p><ol><li>存一个文件放到 JFFS 分区上面。</li><li>通过 <code class=verbatim>dbus</code> 命令储存。(这个命令具体会把数据存哪里我还没仔细看。)</li></ol><p>文件方式没什么好说的，储存和读取解析需要你自己做。 <code class=verbatim>dbus</code> 命令提供了 key-value 的形式储存数据，可以通过例如 <code class=verbatim>dbus list v2ray</code> 列出来所有 <code class=verbatim>v2ray</code> 开头的 key 的情况，执行 <code class=verbatim>dbus</code> 命令不带参数会有使用方法提示。</p><p>一般开发插件还有一个设置也需要开启，就是允许执行 JFFS 的自定义脚本。这个指的是路由器启动的时候，自动执行 <code class=verbatim>/jffs/scripts/</code> 下面的一些文件，也并不是任意文件都会执行，merlin 自己的 <a href=https://github.com/RMerl/asuswrt-merlin/wiki/User-scripts>wiki</a> 有比较详细的说明。</p><p>所以实际上一个插件的工作方式实际上是这样</p><ol><li>路由器启动</li><li>读取 dbus 配置的数据</li><li>执行 <code class=verbatim>/jffs/scripts/</code> 目录下面相应的脚本</li><li>这些脚本里面会执行你的插件的脚本</li><li>你的脚本会读取 dbus 配置的数据，以及读取你存储的文件</li><li>不管是你的界面还是脚本有新的数据需要保存，通过 dbus 或者文件存下来</li></ol><p>每次路由器启动都是这样一个从头初始化的过程。</p></div></div><div id=outline-container-headline-2 class=outline-2><h2 id=headline-2>基于 koolshare 软件中心的离线包</h2><div id=outline-text-headline-2 class=outline-text-2><p>我开发是基于 koolshare 软件中心的，他提供了一个离线安装的功能，以及很多好用的小工具，可以方便开发。想支持离线安装，需要你提供一个 <a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/install.sh>install.sh</a>，你上传的包的名字必须是 <code class=verbatim>name.tar.gz</code> ， <code>name</code> 名字还得和解压之后的目录名字对应，有些人多次下载系统可能会给他改成 <code class=verbatim>name(1).tar.gz</code> 这种会失败。</p><p><code class=verbatim>install.sh</code> 里面底部定义的那几个 <code class=verbatim>softcenter_module_v2ray_</code> 开头的配置是给软件中心用的。 <code class=verbatim>home_url</code> 是软件中心里面点击你插件的图标的时候打开的页面。</p><p>安装离线包的时候不会自动处理 <code class=verbatim>uninstall.sh</code> ，需要你自己把这个放到<a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/install.sh#L61>对应地方</a>，并且需要有对的名字。</p><p>整个安装完全是你自己控制自己要做的事情。卸载也一样，需要自己删除自己复制的脚本文件和产生的数据等。</p></div></div><div id=outline-container-headline-3 class=outline-2><h2 id=headline-3>界面功能</h2><div id=outline-text-headline-3 class=outline-text-2><p>merlin 的界面文件是 <code class=verbatim>.asp</code> 结尾，里面唯一相关的标记是类似这样的 <code class=verbatim>&lt;% nvram_get("firmver"); %></code> ，不记得是不是 asp 语法里面的东西了。基本上都是一些 js 和 html 的东西。</p><div id=outline-container-headline-4 class=outline-3><h3 id=headline-4>初始化</h3><div id=outline-text-headline-4 class=outline-text-3><p>一般是在界面的 body 的 onload 方法里面执行<a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/webs/Module_v2ray.asp#L463>自己的函数</a>。<a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/webs/Module_v2ray.asp#L500>这里</a>是预留左侧系统原有的导航按钮的地方。</p></div></div><div id=outline-container-headline-5 class=outline-3><h3 id=headline-5>保存配置</h3><div id=outline-text-headline-5 class=outline-text-3><p>界面里面可以通过 post 给 <code class=verbatim>applydb.cgi</code> 的方式保存给 dbus，类似<a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/webs/Module_v2ray.asp#L251>这里</a>。先把表单里面的值都读出来做适当的处理，然后存到 <code class=verbatim>dbus</code> 这个变量里面， <code class=verbatim>SystemCmd</code> 定义的是执行 post 的之后需要执行的脚本。 <code class=verbatim>action_mode</code> 是执行脚本之后界面的动作。</p><p>这个里面你的脚本会被调用，你需要处理的事情，比如保存配置到文件什么的就可以在这里做了。</p><p>这里有一个问题是执行命令的时候，不能得到执行的结果反馈。</p></div></div><div id=outline-container-headline-6 class=outline-3><h3 id=headline-6>执行命令的时候显示反馈</h3><div id=outline-text-headline-6 class=outline-text-3><p>上面保存配置是通过 ajax 异步执行的，ajax 的执行结果立刻就会反馈，脚本调用也是异步的，调用脚本的执行结果需要你自己想办法获取。</p><p>类似我<a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/webs/Module_v2ray.asp#L300>这里</a>，在 ajax 执行成功之后获取执行的结果。先显示一个图层，在里面再<a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/webs/Module_v2ray.asp#L305>无限执行另外一个 ajax</a>，把 ajax 的执行结果放到刚才那个图层里面，这样用户就可以看到了。然后通过检查结果里面是否<a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/webs/Module_v2ray.asp#L316>包含特定字符</a>来判断脚本是不是执行完毕。</p><p>ajax 请求的是一个 <a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/webs/Module_v2ray.asp#L307>url</a>，这个 url 对应的文件是<a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/res/v2ray_status.htm>这个</a>。里面其实很简单，就是把 <code class=verbatim>/tmp/v2ray_status.log</code> 的内容显示出来。</p><p>所以通过这个方式，上面的脚本自需要把想要反馈的内容放到这个 log 文件就可以了，整个逻辑就这样。我这里为了简单所有的脚本执行都复用了这个 log 文件，所以为了避免被上次执行的命令影响，每次执行脚本写入这个文件前都先把这个文件里面的历史数据清楚掉。</p></div></div><div id=outline-container-headline-7 class=outline-3><h3 id=headline-7>其他命令执行结果的方式</h3><div id=outline-text-headline-7 class=outline-text-3><p>merlin 还提供了一个 <code class=verbatim>apply.cgi</code> 可以执行脚本，例如<a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/webs/Module_v2ray.asp#L136>这里</a>。我忘记是不是同步执行的了，好像是命令执行完毕之后才会执行 ajax 的回调。</p><p>依然还是通过请求刚才那个 <code class=verbatim>/res/v2ray_status.html</code> 文件来<a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/webs/Module_v2ray.asp#L147>取结果</a>。</p><p>这里还不有一个坑，如果长时间没有从登录界面进入过路由器管理界面，那执行这个可能会遇到获取到的数据是一个 html 的到 Login 页面的 redirect。</p></div></div><div id=outline-container-headline-8 class=outline-3><h3 id=headline-8>读取保存的数据</h3><div id=outline-text-headline-8 class=outline-text-3><div id=outline-container-headline-9 class=outline-4><h4 id=headline-9>通过 js 读取</h4><div id=outline-text-headline-9 class=outline-text-4><div class="src src-html"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>&lt;<span style=color:#062873;font-weight:700>script</span> <span style=color:#4070a0>type</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;text/javascript&#34;</span> <span style=color:#4070a0>src</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;/dbconf?p=v2ray&amp;v=&lt;% uptime(); %&gt;&#34;</span>&gt;&lt;/<span style=color:#062873;font-weight:700>script</span>&gt;</span></span></code></pre></div></div><p>那个 p 会只显示匹配那个前缀的数据。上面这个 url 直接打开看看就知道了，会产生一个 <code class=verbatim>db_v2ray</code> 这个变量。在界面里面就可以使用例如 <code class=verbatim>db_v2ray["v2ray_module_version"]</code> 来获取 dbus 的数据了。</p></div></div><div id=outline-container-headline-10 class=outline-4><h4 id=headline-10>通过页面标签获取</h4><div id=outline-text-headline-10 class=outline-text-4><div class="src src-html"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>&lt;<span style=color:#062873;font-weight:700>input</span> <span style=color:#4070a0>type</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;hidden&#34;</span> <span style=color:#4070a0>id</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;ss_basic_enable&#34;</span> <span style=color:#4070a0>name</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;ss_basic_enable&#34;</span> <span style=color:#4070a0>value</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;&lt;% dbus_get_def(&#34;</span><span style=color:#4070a0>ss_basic_enable</span><span>&#34;,</span> <span>&#34;&#34;);</span> <span>%</span>&gt;&#34;/&gt;</span></span></code></pre></div></div><p>例如上面这个，通过 <code class=verbatim>&lt;% dbus_get_def()/></code> 这样的标签就可以获取到相应的变量。</p></div></div></div></div></div></div><div id=outline-container-headline-11 class=outline-2><h2 id=headline-11>Cron</h2><div id=outline-text-headline-11 class=outline-text-2><p>如果想要定时执行一些任务，可以添加 cron。merlin 管理界面的用户不一定都是 admin，所以 cron 的用户也不一定是什么，可以用 <code class=verbatim>cru</code> <a href=https://github.com/wd/koolshare_plugin_v2ray/blob/master/scripts/v2ray_watchdog.sh#L91>命令</a>来管理 cron。</p></div></div><div id=outline-container-headline-12 class=outline-2><h2 id=headline-12>自己的启动脚本</h2><div id=outline-text-headline-12 class=outline-text-2><p>前面也说过，可以放到<a href=https://github.com/RMerl/asuswrt-merlin/wiki/User-scripts>这些对应的脚本</a>里面。</p></div></div></content><div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//wdicc.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>