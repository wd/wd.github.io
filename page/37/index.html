<!DOCTYPE HTML>
<html>
<head>
	<meta name="generator" content="Hugo 0.19" />
	<meta charset="utf-8">
    
    
    <title>wd and cc</title>
    <meta name="author" content="wd">
    <meta name="description" content="">
    <meta name="keywords" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link href="https://wdicc.com/index.xml" rel="alternate" title="wd and cc" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/css/custom.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='//fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    

    <script type="text/javascript" src="/js/jquery-tapir.js"></script>

    

    <link rel="stylesheet" href="/css/hljs.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>


<body>
    <div id="wrapper">
        <header id="header" class="inner">
<h1 class="animated bounceInDown">
    <div id="headerbg">
        wd and cc
    </div>
</h1>

<span class="subtitle">happy every day</span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
    
    
    <li>
    <a href="https://github.com/wd" class="github" title="Github"></a>
    </li>
    
    
    
    
    
    <li>
    <a href="http://www.twitter.com/wd" class="twitter" title="Twitter"></a>
    </li>
    
    
    
    
    
</ul>


<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
	<li id="ajax"><a href="/tags/index.html">Tags</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    <li>
    <div id="dark">
        <form action="//www.google.com.hk/search" method="get" accept-charset="UTF-8" id="search">
            <input type="hidden" name="sitesearch" value="https://wdicc.com/" />
            <input type="text" name="q" results="0" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
</ul>

</header>

<div id="toload">

    <div id="content" class="inner">
        




    
    <script id="dsq-count-scr" src="//wdicc.disqus.com/count.js" async></script>
    




  <article class="post">
    <h2 class="title"> 
        <a href="/stop-and-start-script-for-apache-and-weblogic/">启动停止weblogic和apache的脚本</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-05-09T00:00:00.000&#43;00:00' itemprop="datePublished">2006-05-09</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>


</div>
    </div>
        apache和weblogic做桥接之后，启动的时候要先启动weblogic，后启动apache，停止的时候要先停止apache，后停止weblogic，这<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/stop-and-start-script-for-apache-and-weblogic/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/portmap/">端口映射</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-05-09T00:00:00.000&#43;00:00' itemprop="datePublished">2006-05-09</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/iptables">iptables</a>

<a href="/tags/other">other</a>


</div>
    </div>
        ★ 需求<br />

1 只有一个ip，怎么让多台电脑上网？<br />

只讲一下主机是双网卡的时候怎么解决。windows下面可以使用winroute、wingate或者系统自带的共享网络连接的功能，都可以实现共享上网。linux下面使用iptables一句话就可以实现。<br />

至于主机是单网卡怎么解决，自己研究研究吧。我只在win下面尝试过用wingate，可是及其不稳定。<br />

2 怎么将某个端口映射给内网？<br />

内网某台电脑提供了服务，怎么让外网的用户可以访问呢？某些对外的服务可能会在内网的多台电脑上面提供，这时就需要做端口映射来让这些服务器让外网可以访问。<br />

<br><!--more-->★ 解决方法<br />

1 共享上网<br />

1) 按照下图连接电脑。<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;isp<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gw(用来做网关的电脑，双网卡)<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hub(or switch)<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---------------------------<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;&nbsp; | ........ | &nbsp; &nbsp; &nbsp; |<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pc1 &nbsp; pc2 ......&nbsp; pcx &nbsp;&nbsp; pcy<br />

gw一个网卡接isp，ip设置为isp告诉你的。另外一个网卡接hub，ip设置为一个内网ip，例如192.168.0.1。<br />

2) 在gw上面执行如下脚本。<br />
#------------script start--------<br />
#!/bin/sh<br />

IPT="/sbin/iptables"<br />

# Internet Interface<br />
INET_IFACE="ethx"<br />
INET_ADDRESS="x.x.x.x"<br />

# Local Interface Information<br />
LOCAL_IFACE="ethy"<br />
LOCAL_IP="192.168.0.1"<br />
LOCAL_NET="192.168.0.0/24"<br />
LOCAL_BCAST="192.168.0.255"<br />

#修改从外网网卡出去的包的源地址，好让外网返回的包能正确回来。<br />
$IPT -t nat -A POSTROUTING -o $INET_IFACE -j SNAT --to-source $INET_ADDRESS<br />

#打开系统的转发功能<br />
echo "1" &gt; /proc/sys/net/ipv4/ip_forward<br />

#----------script end----------<br />

这样内网的电脑做如下设置后就应该可以上网了。<br />

ip：&nbsp; 192.168.0.x<br />
网关: 192.168.0.1<br />
dns:&nbsp; 和gw的设置一样<br />

这时的服务器已经具备一个网关的功能，不过内网的电脑想要上网，都必须手动设置ip，想做到自动获取，可以<br />

2 端口映射<br />

端口映射需要做的其实就是修改对方发过来包的目的地址和端口，然后帮忙转发一下，并且转发的同时修改一下源地址，好让被转发的电脑认为是gw发的包，处理完毕之后好能正常返回gw，然后由gw在负责转发给外网的ip。端口转发需要用到iptables的nat表，上面这些操作是在PREROUTING和POSTROUTING链之间完成的。<br />

1) 映射到外网ip<br />
整个过程可以参考下图。<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;eth0(外网网卡) &nbsp; &nbsp;<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;________________________<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|<br />
 &nbsp; &nbsp;&nbsp; gw的80端口 &nbsp; &nbsp; &nbsp;&nbsp; 修改目标地址(DNAT) &nbsp; &nbsp; &nbsp; 修改源地址(SNAT)<br />
外网ip----------&gt;PREROUTING------------&gt;POSTROUTING------------&gt;外网ip<br />

所以，例如我们要将对gw 80端口的访问都转发到外网的202.202.202.202这台电脑上面，只需要在上面的脚本中添加下面的语句即可。<br />

# 修改从外网进来的对80端口访问的数据包的目的地址<br />
$IPT -t nat -A PREROUTING -p tcp -i $INET_IFACE --destination-port 80 \<br />
 &nbsp; &nbsp; -j DNAT --to-destination 202.202.202.202<br />

那么，你可能要问，按照上面的说法，这样只修改了目的地址，还要修改源地址啊，这样包才能正确返回到gw。问的好，不过其实我们已经做了这个设置了，聪明的你可能已经想到了，就是上面让内网ip可以上网的那个脚本里的一句语句已经实现了这个功能。<br />

#修改从外网网卡出去的包的源地址，好让外网返回的包能正确回来。<br />
$IPT -t nat -A POSTROUTING -o $INET_IFACE -j SNAT --to-source $INET_ADDRESS<br />

就是上面这句，他把所有从外网网卡出去的包的源地址都修改了，当然也包括去往202.202.202.202的80端口的包。<br />

2) 映射到内网ip<br />
整个过程可以参考下图。<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;eth0(外网网卡) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;eth0(内网网卡)<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;________________________ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_______________________<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |<br />
 &nbsp; &nbsp;&nbsp; gw的80端口 &nbsp; &nbsp; &nbsp;&nbsp; 修改目标地址(DNAT) &nbsp; &nbsp; &nbsp; 修改源地址(SNAT) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 修改源地址(SNAT)<br />
外网ip----------&gt;PREROUTING------------&gt;POSTROUTING------------&gt;PREROUTING-----------&gt;POSTROUTING-----------&gt;内网ip<br />

所以，例如我们要映射80端口到内网的192.168.1.80这台电脑上面，只需要在上面的脚本中添加下面的语句即可。<br />

# 修改从外网进来的对80端口访问的数据包的目的地址<br />
$IPT -t nat -A PREROUTING -p tcp -i $INET_IFACE --destination-port 80 \<br />
 &nbsp; &nbsp; -j DNAT --to-destination 192.168.1.80<br />
 &nbsp; &nbsp; <br />
# 修改从内网网卡出去的所有数据包源地址<br />
$IPT -t nat -A POSTROUTING -o $LOCAL_IFACE \<br />
 &nbsp; &nbsp; -j SNAT --to-source $LOCAL_IP<br />

这个比上面多了一句，意思相信你已经明白了吧。因为访问内网ip的时候走了内网网卡，所以还需要对从内网网卡出去的包修改一下源地址。<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/portmap/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/178-accident/">178事故</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-04-30T00:00:00.000&#43;00:00' itemprop="datePublished">2006-04-30</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>

<a href="/tags/route">route</a>

<a href="/tags/%E8%B7%AF%E7%94%B1">路由</a>


</div>
    </div>
        ★ 由来<br />

做服务器间相互备份的时候，到某两台服务器的时候，暂且称为A、B吧，发现他们之间不能互通，查看了ip，内网ip都是一个网段的，查看防火墙，端口也都是打开的，更加离奇的是，通过rsync从B访问A的时候，提示对方拒绝连接，同时在A上面用tcpdump监听相应端口，发现没有任何数据来往，而在A上面同时用tcpdump监听，却发现发出的请求对方都有回应。这个就太离奇了，到底是怎么回事呢？在A上面查看ip设置，注意到A有三个网卡，一个公网，两个内网ip，两个内网ip分别是10.x.x.0/24网段和192.168.0.0/24网段的，而B上面只有两块网卡，一个公网ip，一个内网ip，内网是192.168.0.0/24网段的，此时突然想起来A上面有snmpd监控，查看了一下，发现A的192.168.0.0/24 网段根本从来就没有任何流量，所以就断定肯定是网线插错了。打电话给机房也不太可能，就想着自己修改一下服务器的ip好了，反正是内网ip，即使修改出问题也不会出现连不上的情况，这样至少我远程还可以继续维护。这样，恶梦开始了。。。。<br />

<br><!--more-->★ 解决问题<br />

修改ip是比较简单的，rh下面/etc/sysconfig/network-scripts下面几个文件修改了就好，虽然是修改内网ip，我还是对旧的配置文件做了备份，修改之后，重启了一下网络。<br />

#service network restart<br />

这里也有个小问题，不知道ssh怎么做到重启网络居然可以不掉线的。<br />

重启网络之后，查看了一下ip，已经修改过来了，然后重新查看监控，发现192.168网段的网卡也有流量了，说明修改好了。再次尝试从B执行rsync从A同步数据，发现仍然连不上，A上的tcpdump仍然没有数据，B上面的仍然有回应，rsync的出错提示依然没变。这个问题太奇怪了，无意中发现在B上面监听的时候发现返回数据的主机名似乎不是A的，查看之后发现确实不是，再看同机房的服务器，发现有一台的内网ip和A的192网段的ip一样，B访问的其实是那台电脑的，那台没有开rsyc服务，所以连不上了。至此B访问A有回应的问题知道原因，那么就尝试修改一下A的192网段的ip看看。修改到另外一个ip之后，连接B，发现仍然连不上，从B也连不到A，都提示no route，可是查看route表，似乎没问题啊。到底怎么回事呢？此时突然想起来一个问题，他们不会不在一个机房吧。。。赶紧查看服务器托管信息，确定他们确实不在一起，所以访问不通是正常的。这样问题算找到原因了。<br />

★ 新的问题<br />

上面问题解决大概也没用多少时间，10多分钟的样子吧。正准备休息一下的时候，其他技术人员过来抱怨，说有客户反映A服务器连不上了。我看了一下我的监控，没发现问题。通过沟通之后才知道，客户访问的时候是通过内网ip来访问的，也就是10网段的ip（我的监控只能监控外网ip）。而我因为不知道情况不是刚刚修改了ip么，这也简单，改回去不就行了，况且我修改之前还做了备份呢，这里还庆幸了一下我自己想的周到。<br />

覆盖回去，重启了一下网络，然后让他去测试一下。测试发现依然连不上，我开始觉得有点奇怪了，不是都改回去了么，想起来之前还修改过防火墙，就去恢复了防火墙设置，发现还是不行。用tcpdump监控发现似乎有10网段的ip过来访问，但是似乎没有反馈回去的数据，检查apache的日志发现没有相关的记录。而apache用公网ip访问没有任何问题。<br />

此时就陷入了一个困境，因为我没有办法测试内网是不是还通了。其实这是我经验不足造成的，tcpdump既然能看到10网段过来的ip，那么就说明外面的内网ip连接我们这里是没问题的，那也就说明是我们服务器的问题，不会是网络的问题。<br />

此后将防火墙清空也没有效果，tcpdump监控也一直是只有进来的，没有出去的。其实多次强调只有进来的没有出去的，我也在怀疑是不是服务器拒绝连接了？但是我手里只有这一台服务器，没有办法测试使用内网ip通过别的服务器是否能正常登陆，通过本地访问外网ip是一切正常的，可以看到apache中的日志。<br />

这个时候老大在火车上了，有人已经打电话统治他出问题了。老大给我打电话建议我重启一下服务器。其实他这个建议没有任何意义，重启服务器也就是将重启一下网络，而我已经做过这个操作了。重启还要担一定的风险，如果起不来，还得去机房，那服务就不是停几个小时的问题了。不过没有办法中的办法，而我之前也重启一个测试服务器，没有遇到问题，所以就给服务器重启了，这样我也是争取一点时间，好想想到底哪里的问题。<br />

此时各个小头都已经过来站在我后面了，我都能感觉手都有一点抖了。因为这台服务器是我们的主要业务之一，停几分钟就会损失不少钱，而到现在已经一个小时左右了。<br />

重启没有遇到问题，连接上去之后就是启动服务器上面的一些服务，启动服务之后再次测试，发现问题依然，这也是意料之中的。<br />

头脑发热中，发现来访问我们服务器的内网10网段的ip是10.0.0.0/8网段的，而我们服务器设置的是10.x.x.0/24，难道是这里的问题？修改了一下ip设置，重启了一下网络，然后用tcpdump查看，发现现在我们的服务器对10网段的ip访问有了回应了。一阵兴奋，让技术人员测试一下，发现他依然连不上。查看apache日志，似乎已经有10网段的访问记录了。那还是哪里的问题呢？<br />

其实修改内网网段的时候就想到了，是不是路由的设置问题？这时老大提示了一下，看看之前管理服务器的技术人员留下的文档，我也突然想起来，我之前刚好对这台服务器的设置做过仔细检查，并做了备份，包括ifconfig信息，route信息，dns信息等，查看了一下，发现确实是路由表出问题了，新旧路由表不同。<br />

★ 解决新的问题<br />

发现问题所在就好了，接下来就是修改路由表。先修改内网ip的网段，改回10.x.x.0/24，然后修改10.0.0.0/8网段的ip的路由。修改的时候出现了对route命令不熟悉的问题，route add default gw添加了默认路由，发现不行，改来改去，手一抖，在只剩一条默认路由的情况下，执行了route del default gw命令，这样把服务器的网络给废掉了。。。<br />

赶紧打电话联系深圳机房，花了十几二十分钟，最终联系到了机房的工作人员，可是新的问题又来了，我这里的信息没有机架位置，服务器编号等，只有ip又不能确定是哪台，还好工作人员比较好，根据我提供的服务器牌子等一些信息，找到了一台服务器。接上显示器之后，他说没有任何显示。然后说给重启了吧。其实这里他也要担一定的风险，如果这台不是我们的，他也得等着被别人投诉（不过他倒是可以有推脱的理由，可以说对方服务器莫名重启）。启动的过程很让人焦心，现在离已经过去快2个小时了，如果还不能尽快解决，恐怕我留在这个公司的时间也不多了，呵呵。<br />

启动还算顺利，我能登陆服务器了。先启动各服务，测试发现依然连不上。然后我就查看路由，添加了255.0.0.0/8的默认路由，然后tcpdump查看，收发包正常，查看apache日志，记录也正常。让技术人员测试，也正常了。<br />

至此，问题总算解决了。时间已经过去2个多小时了，才发现自己口干舌噪。<br />

★ 总结一下<br />

1) 各服务器配置情况比较混乱，一些特殊设置没有写明，这是导致服务器问题的一个原因。<br />
2) 管理员应该及时对各服务器配置情况做备份，这样即使服务器挂了，也可以参考备份立刻恢复之前的情况。<br />
3) 要相信系统。比如从B服务器rsync连接A服务器的时候，提示连接被拒绝。“被拒绝”说明B服务器的rsync和目的服务器进行了交流，对方不允许你连接，和连接没有响应等是有区别的。而从A服务器的tcpdump中也可以看到根本就没有对方过来的数据包，你也不要怀疑是不是被防火墙挡住了，防火墙挡住tcpdump也可以查看的。<br />
4) 管理员应该对一些常用的命令的所有参数都比较熟悉。比如route，tcpdump，ls，tar，find等等，真正出问题的时候，你觉得还有时间让你去看man来查看某个命令是否能实现某个功能呢？你也不想当着一堆人的面现看吧。<br />
5) 做某个操作前最好先确认一下会不会有问题，尤其是网络和防火墙相关的命令。因为要是设置出了问题，远程控制不了了，你哭都没地哭。但是工作总得做，不能因为怕出问题就不作吧，呵呵，我之前写了一篇如何给系统加防火墙的帖子，可以参考下里面的想法。<br />
6) 压力肯定是有的，就看你怎么面对了，呵呵。平时多花些功夫，出问题了就不会手忙脚乱了。<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/178-accident/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/use-rsa-and-dsa/">使用ssh的rsa和dsa验证登陆linux</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-04-24T00:00:00.000&#43;00:00' itemprop="datePublished">2006-04-24</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>

<a href="/tags/ssh">ssh</a>


</div>
    </div>
        参考地址：http://www.5ilinux.com/ssh01.html<br />

按照文档中的方法，使用SecureCRT生成公匙密匙，然后上传公匙，没问题。<br />

用putty使用这个密匙的时候就出问题了，验证不了。<br />

然后用putty生成公匙密匙，上传公匙，验证不了。<br />

后来用openssh自带的ssh-keygen生成了公匙密匙，然后用putty的keygen转换了一下，用putty登陆就可以了。<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/use-rsa-and-dsa/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/limite-ssh-access-ip/">限制ssh访问的ip</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-04-24T00:00:00.000&#43;00:00' itemprop="datePublished">2006-04-24</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>

<a href="/tags/ssh">ssh</a>


</div>
    </div>
        ★ 需求<br />

最近公司服务器上面某个用户的帐号密码被修改了好几次。查看了一下，确实有人用他的帐号从外网ip（国外的ip）登陆过，猜想可能是他自己的电脑中木马或者什么病毒了。用户自己没有安全意识是很头痛的一个问题，其实给他们新建帐号的时候使用的都是简单密码，但是似乎都没有人上服务器自己修改，但是你又不能要求你的用户如何如何（比如给自己电脑装防火墙、杀毒软件etc），因为那是人家自己的事情。那么我就想，有没有一个方法可以限制某个用户只能从某个ip（或者ip列表）登陆呢？下面是一些解决方法。<br />

<br><!--more-->★ 解决方案<br />

1) 通过修改/etc/ssh/sshd_config文件，让sshd只监听内网ip。这样只有内网ip才能登陆ssh。但是这样的话就不能远程维护服务器了，有点得不偿失得感觉。<br />

2) 通过修改/etc/hosts.allow和/etc/hosts.deny来限制某个ip的登陆。这个方式其实和上面得类似，你也不知道hacker会从哪个ip登陆，所以你没办法deny他得ip，deny他得时候可能连你自己也deny了。<br />

3) 可以通过/etc/ssh/sshd_config文件来实现。<br />

 &nbsp; &nbsp; AllowUsers<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; This keyword can be followed by a list of user name patterns,<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; separated by spaces.&nbsp; If specified, login is allowed only for us-<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; er names that match one of the patterns.&nbsp; Only user names are<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; valid; a numerical user ID is not recognized.&nbsp; By default, login<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; is allowed for all users.&nbsp; If the pattern takes the form US-<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ER@HOST then USER and HOST are separately checked, restricting<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; logins to particular users from particular hosts.&nbsp; The allow/deny<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; directives are processed in the following order: DenyUsers,<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AllowUsers, DenyGroups, and finally AllowGroups.<br />

PATTERNS<br />
 &nbsp; &nbsp; A pattern consists of zero or more non-whitespace characters, `*' (a<br />
 &nbsp; &nbsp; wildcard that matches zero or more characters), or `?' (a wildcard that<br />
 &nbsp; &nbsp; matches exactly one character).&nbsp; For example, to specify a set of decla-<br />
 &nbsp; &nbsp; rations for any host in the ``.co.uk'' set of domains, the following pat-<br />
 &nbsp; &nbsp; tern could be used:<br />

 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Host *.co.uk<br />

 &nbsp; &nbsp; The following pattern would match any host in the 192.168.0.[0-9] network<br />
 &nbsp; &nbsp; range:<br />

 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Host 192.168.0.?<br />

 &nbsp; &nbsp; A pattern-list is a comma-separated list of patterns.&nbsp; Patterns within<br />
 &nbsp; &nbsp; pattern-lists may be negated by preceding them with an exclamation mark<br />
 &nbsp; &nbsp; (`!').&nbsp; For example, to allow a key to be used from anywhere within an<br />
 &nbsp; &nbsp; organisation except from the ``dialup'' pool, the following entry (in au-<br />
 &nbsp; &nbsp; thorized_keys) could be used:<br />

 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from="!*.dialup.example.com,*.example.com"<br />

比如不允许test用户从192.168.0.x登陆，那么可以添加一行<br />

denyusers test@192.168.0.<br />

按照上面的PATTERNS说明，似乎可以加叹号来排除某个ip，但是尝试过没有成功，不知道什么原因了。<br />

按照文档，deny是级别最高的，而设置了allow之后，就只能allow的用户访问了，所以如果想限制某个用户只能从某个ip段登陆，用这个似乎实现不了。<br />

4) 使用ssh得RSA/DSA key。<br />

参考地址:http://www.5ilinux.com/ssh01.html <br />

用ssh-keygen命令生成一对公匙密匙，然后把密匙给用户，并且限制ssh只能通过RSA方式认证。这样会导致所有ssh用户都得用这种方式登陆了，会更加郁闷。<br />

这种方式可以在用户得authorized_keys2文件中，加入from="!192.168.1.158,*"来让用户只能通过158登陆。（这个没有做过验证）<br />


PATTERNS<br />
 &nbsp; &nbsp; A pattern consists of zero or more non-whitespace characters, `*' (a<br />
 &nbsp; &nbsp; wildcard that matches zero or more characters), or `?' (a wildcard that<br />
 &nbsp; &nbsp; matches exactly one character).&nbsp; For example, to specify a set of decla-<br />
 &nbsp; &nbsp; rations for any host in the ``.co.uk'' set of domains, the following pat-<br />
 &nbsp; &nbsp; tern could be used:<br />

 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Host *.co.uk<br />

 &nbsp; &nbsp; The following pattern would match any host in the 192.168.0.[0-9] network<br />
 &nbsp; &nbsp; range:<br />

 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Host 192.168.0.?<br />

 &nbsp; &nbsp; A pattern-list is a comma-separated list of patterns.&nbsp; Patterns within<br />
 &nbsp; &nbsp; pattern-lists may be negated by preceding them with an exclamation mark<br />
 &nbsp; &nbsp; (`!').&nbsp; For example, to allow a key to be used from anywhere within an<br />
 &nbsp; &nbsp; organisation except from the ``dialup'' pool, the following entry (in au-<br />
 &nbsp; &nbsp; thorized_keys) could be used:<br />

 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from="!*.dialup.example.com,*.example.com"<br />



5) 用pam。<br />

参考地址:http://www.linuxmine.com/1078.html <br />

看看/etc/pam.d/login文件，有没有pam_access.so的设置。我的debian系统中，ssh相关的都在/etc/pam.d/ssh文件中设置。加入一行<br />

account&nbsp; required &nbsp; &nbsp; &nbsp; pam_access.so<br />

然后修改他的配置文件/etc/security/access.conf文件。加入一行<br />

-:wd:192.168.1. EXCEPT 192.168.1.158<br />

这样，wd用户从192.168.1.x（192.168.1.158除外）的登陆权限被去掉了。也就是说，wd这个用户就只能从158这个ip以及外网ip登陆了。<br />

大功告成。 :)<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/limite-ssh-access-ip/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/iptables-on-remote-server/">为远程服务器设置防火墙</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-04-20T00:00:00.000&#43;00:00' itemprop="datePublished">2006-04-20</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/iptables">iptables</a>

<a href="/tags/other">other</a>


</div>
    </div>
        如果服务器不在本地，又需要对防火墙做设置的时候，操作一定要注意，<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/iptables-on-remote-server/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/search-in-vim/">VIM查找替换归纳总结zz</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-04-18T00:00:00.000&#43;00:00' itemprop="datePublished">2006-04-18</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>

<a href="/tags/vim">vim</a>


</div>
    </div>
        <p><a href="http://spaces.msn.com/dingy/blog/cns!2F24B9E66A542581!327.entry">http://spaces.msn.com/dingy/blog/cns!2F24B9E66A542581!327.entry</a><br />

VIM中常用的替换模式总结。</p><p>1，简单替换表达式</p><p>替换命令可以在全文中用一个单词替换另一个单词：</p><p>:%s/four/4/g</p><br><!--more--><p>"%" 范围前缀表示在所有行中执行替换。最后的 "g" 标记表示替换行中的所有匹配点。如果仅仅对当前行进行操作，那么只要去掉%即可</p><p>&nbsp; 如果你有一个象 "thirtyfour" 这样的单词，上面的命令会出错。这种情况下，这个单词会被替换成"thirty4"。要解决这个问题，用 "\&lt;" 来指定匹配单词开头：</p><p>&nbsp; &nbsp; &nbsp;&nbsp; :%s/\&lt;four/4/g</p><br />
<p>显然，这样在处理 "fourty" 的时候还是会出错。用 "\&gt;" 来解决这个问题：</p><p>&nbsp; &nbsp; &nbsp;&nbsp; :%s/\&lt;four\&gt;/4/g</p><br />
<p>如果你在编码，你可能只想替换注释中的 "four"，而保留代码中的。由于这很难指定，可以在替换命令中加一个 "c" 标记，这样，Vim 会在每次替换前提示你：</p><p>&nbsp; &nbsp; &nbsp;&nbsp; :%s/\&lt;four\&gt;/4/gc</p><br />
<p>2，删除多余的空格</p><p>要删除这些每行后面多余的空格，可以执行如下命令：</p><p>&nbsp; &nbsp; &nbsp;&nbsp; :%s/\s\+$//</p><br />
<p>命令前面指明范围是 "%"，所以这会作用于整个文件。"substitute" 命令的匹配模式是</p><p>"\s\+$"。这表示行末（$）前的一个或者多个（\+）空格（\s）。替换命令的 "to" 部分是空的："//"。这样就会删除那些匹配的空白字符。</p><br />
<p>3，匹配重复性模式</p><p>星号项 "*" 规定在它前面的项可以重复任意次。因此:</p><p>&nbsp; &nbsp; &nbsp;&nbsp; /a*</p><p>匹配 "a"，"aa"，"aaa"，等等。但也匹配 "" (空字串)，因为零次也包含在内。星号 "*" 仅仅应用于那个紧邻在它前面的项。因此 "ab*" 匹配 "a"，"ab"，"abb","abbb"，等等。如要多次重复整个字符串，那么该字符串必须被组成一个项。组成一项的方法就是在它前面加 "\("，后面加 "\)"。因此这个命令:</p><p>&nbsp; &nbsp; &nbsp;&nbsp; /\(ab\)*</p><br />
<p>匹配: "ab"，"abab"，"ababab"，等等。而且也匹配 ""。</p><br />
<p>要避免匹配空字串，使用 "\+"。这表示前面一项可以被匹配一次或多次。</p><p>&nbsp; &nbsp; &nbsp;&nbsp; /ab\+</p><p>匹配 "ab"，"abb"，"abbb"，等等。它不匹配 后面没有跟随 "b" 的 "a"。</p><br />
<p>要匹配一个可选项，用 "\="。 例如:</p><p>&nbsp; &nbsp; &nbsp;&nbsp; /folders\=</p><p>匹配 "folder" 和 "folders"。</p><br />
<p>4，指定重复次数</p><p>要匹配某一项的特定次数重复，使用 "\{n,m}" 这样的形式。其中 "n" 和 "m" 都是数字。在它前面的那个项将被重复 "n" 到 "m" 次 (|inclusive| 包含 "n" 和 "m")。例如:</p><p>&nbsp; &nbsp; &nbsp;&nbsp; /ab\{3,5}</p><p>匹配 "abbb"，"abbbb" 以及 "abbbbb"。</p><p>&nbsp; 当 "n" 省略时，被默认为零。当 "m" 省略时，被默认为无限大。当 ",m" 省略时，就表示重复正好 "n" 次。例如:</p><p>&nbsp; &nbsp; &nbsp;&nbsp; 模式 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 匹配次数 </p><p>&nbsp; &nbsp; &nbsp;&nbsp; \{,4} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0，1，2，3 或 4</p><p>&nbsp; &nbsp; &nbsp;&nbsp; \{3,} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3，4，5，等等</p><p>&nbsp; &nbsp; &nbsp;&nbsp; \{0,1} &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 0 或 1，同 \=</p><p>&nbsp; &nbsp; &nbsp;&nbsp; \{0,} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 或 更多，同 *</p><p>&nbsp; &nbsp; &nbsp;&nbsp; \{1,} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 或 更多，同 \+</p><p>&nbsp; &nbsp; &nbsp;&nbsp; \{3} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 3</p><br />
<p>5，多选一匹配</p><p>在一个查找模式中，"或" 运算符是 "\|"。例如:</p><p>&nbsp; &nbsp; &nbsp;&nbsp; /foo\|bar</p><p>这个命令匹配了 "foo" 或 "bar"。更多的抉择可以连在后面:</p><p>&nbsp; &nbsp; &nbsp;&nbsp; /one\|two\|three</p><p>匹配 "one"，"two" 或 "three"。</p><br />
<p>&nbsp; 如要匹配其多次重复，那么整个抉择结构须置于 "\(" 和 "\)" 之间:</p><p>&nbsp; &nbsp; &nbsp;&nbsp; /\(foo\|bar\)\+</p><p>这个命令匹配 "foo"，"foobar"，"foofoo"，"barfoobar"，等等。</p><br />
<p>&nbsp; 再举个例子:</p><p>&nbsp; &nbsp; &nbsp;&nbsp; /end\(if\|while\|for\)</p><p>这个命令匹配 "endif"，"endwhile" 和 "endfor"。</p><br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/search-in-vim/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/man-in-debian/">debian中man不能翻页的解决方法</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-04-18T00:00:00.000&#43;00:00' itemprop="datePublished">2006-04-18</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/debian">debian</a>


</div>
    </div>
        安装debian基本系统之后会发现man的时候往下翻页可以用ctrl＋F，可是怎么都翻不上去。包括方向键也都不起作用。<br />

解决方法其实非常简单，只要安装less就可以了。呵呵。<br />
#apt-get install less<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/man-in-debian/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/iptables-in-debian/">debian下面的防火墙设置</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-04-17T00:00:00.000&#43;00:00' itemprop="datePublished">2006-04-17</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/debian">debian</a>


</div>
    </div>
        <p>rh下面的防火墙设置是保存在/etc/sysconfig/iptables文件中的，这样每次重启都会恢复防火墙设置。<br />

debian木有这个文件，但是他提供了更加灵活的方式。<br />
<a href="http://www.debian.org/doc/manuals/securing-debian-howto/ch-sec-services.en.html#s-firewall-setup">http://www.debian.org/doc/manuals/securing-debian-howto/ch-sec-services.en.html#s-firewall-setup</a><br />

看了下，似乎比较简单的就是设置interfaces文件了。<br />

5.14.3.3 Configuring firewall rules through ifup<br />
You can use also the network configuration in /etc/network/interfaces to setup your firewall rules. For this you will need to: </p><p>Create your firewalling ruleset for when the interface is active. <br />
Save your ruleset with iptables-save to a file in /etc, for example /etc/iptables.up.rules <br />
Configure etc/network/interfaces to use the configured ruleset: <br />
 &nbsp; &nbsp; iface eth0 inet static<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; address x.x.x.x<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [.. interface configuration ..]<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pre-up iptables-restore &lt; /etc/iptables.up.rules<br />
You can optionally also setup a set of rules to be applied when the network interface is down creating a set of rules, saving it in /etc/iptables.down.rules and adding this directive to the interface configuration: </p><p> &nbsp; &nbsp; &nbsp; &nbsp; post-down iptables-restore &lt; /etc/iptables.down.rules<br />
For more advanced firewall configuration scripts through ifupdown you can use the hooks available to each interface as in the *.d/ directories called with run-parts (see run-parts(8)). </p><p>可以去<a href="http://easyfwgen.morizot.net/gen/">http://easyfwgen.morizot.net/gen/</a> 在线生成一个防火墙脚本，然后pre-up指定一下。</p><br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/iptables-in-debian/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/manage-route/">添加删除路由</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-04-17T00:00:00.000&#43;00:00' itemprop="datePublished">2006-04-17</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>


</div>
    </div>
        #route add -net 192.168.0.0/24<br />
#route add -host 192.168.0.23<br />
#route del -net 192.168.0.0/24<br />

#route add default gw 192.168.0.1<br />
#route del default gw 192.168.0.1<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/manage-route/#disqus_thread">Comments</a></span>
    
</div>
</article>



  <nav id="pagenavi">
    
        <a href="/page/36/" class="prev">Prev</a>
    
    
        <a href="/page/38/" class="next">Next</a>
    
  <div class="center"><a href="/archives/index.html">Blog Archives</a></div>
  </nav>


    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2017
    
    wd
    . Powered by <a href="http://gohugo.io" target="_blank">Hugo</a> |
    Theme is <a href="https://github.com/wd/hugo-fabric">hugo-fabric</a>, fork from <a href="https://github.com/wd/hexo-fabric">hexo-fabric</a> by <a href="https://wdicc.com">me</a>
</div>

    </footer>
    <script src="/js/fabric.js"></script>


</div>
</div>
<script src="/js/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
 
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery);
 
</script>
</body>
</html>
