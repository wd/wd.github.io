<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>wd and cc</title>
    <meta name="author" content="wd">
    
	<meta name="description" content="undefined"> <!-- TODO: truncate -->
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="wd and cc" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='//fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    

</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        wd and cc
    </div>
</h1>
<span class="subtitle">happy everyday</span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/wd" class="github" title="Github"></a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/wd" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload -->
    <div id="content" class="inner">
        

    
        <script id="dsq-count-scr" src="//wdicc.disqus.com/count.js" async></script>
    



  <article class="post">
	<h2 class="title">
		<a href="intro-openresty/">介绍下 openresty</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-10-22T16:00:00.000Z" itemprop="datePublished">Oct 23, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/web/">web</a> <a href="../tags/linux/">linux</a> <a href="../tags/javascript/">javascript</a> <a href="../tags/openresty/">openresty</a>
</div>
    </div>
      
        一直没有时间使用 ngx_lua，上周算是真正使用了下，总结下，也算是帮忙推广下 openresty。
<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">什么是 openresty</h2>
<div id="text-1" class="outline-text-2">

openresty 的主力作者是 <a href="http://weibo.com/agentzh" target="_blank" rel="external">@agentzh</a> 它的网页在 <a href="http://openresty.org" target="_blank" rel="external">这里</a>，上面有介绍。按我的理解，他是介于客户端浏览器 js 和数据库之间的一层。

在 ajex 还没有盛行的时代，数据库的数据需要展现在浏览器的时候，一般都是使用 php/jsp 之类读取数据，然后拼表格/图表这些。在客户端机器越来越牛逼之后，把部分运算放在浏览器里面开始盛行，ajex 也越来越流行。这个时候通常还需要有个服务器端的程序来配合从数据库获取并提供数据，应该也有不少类似的程序来提供这个数据。

老版本的 openresty 是基于 perl 做的，可以上 cpan 上面 <a href="http://search.cpan.org/~agent/OpenResty-0.5.12/lib/OpenResty/Spec/REST_cn.pod" target="_blank" rel="external">搜到</a> (不知道为啥这页面我打不开了)。agentzh 还专门为他写了一个 admin site，纯 js + oprensty 来实现的，可以直接在上面配置接口，很方便。目前老版本应该没人用了。

新版本的 openresty 基本上等于是 nginx 和一些 nginx 模块的集合，大部分模块都是 agentzh 和 <a href="https://github.com/chaoslawful" target="_blank" rel="external">chaoslawful</a> 完成的，目前 agentzh 离职在家全职开发 openresty 相关，chaoslawful 还在淘宝 <a href="http://linezing.com" target="_blank" rel="external">量子统计</a> 。

这大概就是我了解的 openresty 的起源和目前的情况。写的比较简单，里面的曲折就不多说了，可以找上面提到的大牛聊天。

</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">怎么使用 openresty</h2>
<div id="text-2" class="outline-text-2">

我下面用一个简单的例子来描述下，我是怎么使用 openresty 的，从中应该能看出来 openresty 能干啥，怎么用。

</div>
<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1">需求</h3>
<div id="text-2-1" class="outline-text-3">

在 postgresql 数据库有张网站日访问流量表，包含两个字段 thedate 和 pv。需要把里面的数据展现出来，画出来流量曲线。

<dl><dt>注意</dt><dd>下面的代码大都从现有程序里面扒出来的，所以不一定直接就能用，只是个示意而已。</dd></dl></div>
</div>
<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2">安装 openresty</h3>
<div id="text-2-2" class="outline-text-3">

首先需要安装 openresty。从 <a href="http://openresty.org" target="_blank" rel="external">openresty.org</a> 下载当前的 stable 版本 ngx_openresty-1.0.6.22.tar.gz。
<pre class="prettyprint lang-bash">
$ cd ngx_openresty-1.0.6.22
$ ./configure --with-http_drizzle_module --with-http_postgres_module --with-pg_config=/opt/pg90/bin/pg_config --prefix=/usr/local/openresty --with-libdrizzle=/usr/local/libdrizzle/ --with-luajit --with-http_iconv_module # 这是我用到的参数，按照需要加减
$ make
# make install</pre>
configure 的时候 postgres_module 是必须的，其他的 drizzle_module 是用来支持从 mysql 获取数据的，iconv_module 是用来做编码转换的，luajit 据说可以提升不少性能。

不出问题的话，在 /usr/local/openresty 目录下面就安装好了。其实更合理的方式应该是提供一个 rpm 或者 deb 包的。

</div>
</div>
<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3">启动 nginx</h3>
<div id="text-2-3" class="outline-text-3">

openresty 给提供了简单可用的 nginx.conf，所以现在可以先尝试启动下 /usr/local/openresty/nginx/sbin/nginx 了，如果启动没问题，那就 ok 了。

配置文件在 /usr/local/openresty/nginx/conf/nginx.conf。

</div>
</div>
<div id="outline-container-2-4" class="outline-3">
<h3 id="sec-2-4">配置 nginx</h3>
<div id="text-2-4" class="outline-text-3">

主要就是配置 /usr/local/openresty/nginx/conf/nginx.conf，以后很多事情都会在这里面来完成，说是 nginx.conf 编程也不为过，呵呵。

增加下面的配置
<pre class="prettyprint lang-conf">

    upstream pgsql {
        postgres_server server_ip:5432 dbname=test password=123 user=test;
        #postgres_keepalive  max=2 mode=single overflow=reject;
        postgres_keepalive off;
    }

# server 里面增加一个 location

       location /=/pv {
            postgres_query 'select thedate, pv from pv';
            postgres_pass pgsql;

            rds_json on;
            rds_json_format compact;

            xss_get on;
            xss_callback_arg '_c';
        }</pre>
<ol>
	<li>其中关于 upstream postgres 用来定义需要连接的数据库信息，和发送 sql 到数据库，可以参考 <a href="https://github.com/FRiCKLE/ngx_postgres/" target="_blank" rel="external">这里</a>。</li>
	<li>rds_json 用来将数据库的输出变成 json 格式，可以参考 <a href="https://github.com/agentzh/rds-json-nginx-module" target="_blank" rel="external">这里</a> 。</li>
	<li>xss_get 用来支持跨域，jquery 默认使用的 callback 参数是 _c，可以参考 <a href="https://github.com/agentzh/xss-nginx-module" target="_blank" rel="external">这里</a>。</li>
</ol>
这样配置好之后，重启下。结果应该很清晰了，请求 <a href="http://your_ip/=/pv" target="_blank" rel="external">http://your\_ip/=/pv</a> 应该就可以得到数据库里面的数据了，可以使用 curl 看看结果，应该类似下面的
<pre class="prettyprint lang-json">
</pre></div>
</div>
<div id="outline-container-2-5" class="outline-3">
<h3 id="sec-2-5">js 画图</h3>
<div id="text-2-5" class="outline-text-3">

挑一个画图程序，比如我用过的 <a href="http://highcharts.com" target="_blank" rel="external">highcharts</a>, <a href="http://www.amcharts.com/" target="_blank" rel="external">amcharts</a> 这些都不错，amcharts 是使用 flash 画图，兼容各种浏览器，highcharts 号称也支持，不过我弄出来的图在 chrome/firefox 下面没问题，ie 不支持，他用的是 svg 标签。

就写几行代码来示意下吧
<pre class="prettyprint lang-javascript">
    $.ajax({
        url : 'http://your_ip/=/pv',
        success: function (data) {
            renderPvCharts(data);
        }
    });

    function renderPvCharts(data) {
        $('body').append('</pre>
<pre class="prettyprint lang-javascript">
        var result = Utils.getSplineChartSeries( data ); # 将 nginx 返回的 json 格式数据转化为 highcharts 需要的格式
        var options = {
			chart: {
                zoomType: 'xy',
				renderTo: 'pv', # div 的 id
				defaultSeriesType: 'spline'
			},
			title: {
                text: '每日 pv'
            },
			xAxis: {
                type: 'datetime'
			},
			tooltip: {
				formatter: function() {
			        return '<strong>'+ this.series.name +'</strong>
'+
						Highcharts.dateFormat('%e. %b', this.x) +': '+ this.y;
				}
			},
			legend: {
				layout: 'vertical',
				align: 'right',
				verticalAlign: 'top',
				x: -10,
				y: 100,
				borderWidth: 0
			},
            series : result.y
        };

        var chart = new Highcharts.Chart( options );
    };

} );</pre>
简单解释下
<ol>
	<li>在页面 readay 的时候，使用 ajex 设置回调函数并请求接口。</li>
	<li>回调函数里面使用 Utils.getSplineChartSeries 转换一下数据，方便直接给 options 里面数据赋值，具体需要的数据格式，看 highcharts 的 spline 的 demo 就可以。</li>
	<li>回调函数里面显示图表。</li>
</ol>
这样就完事了，数据就展现出来了。

</div>
</div>
<div id="outline-container-2-6" class="outline-3">
<h3 id="sec-2-6">其他</h3>
<div id="text-2-6" class="outline-text-3">

从上面可以看到整个数据流是怎么回事。openresty 可以做的事情远比上面描述的复杂，上面只是个最简单的应用了。
<ol>
	<li>比如使用 <a href="https://github.com/agentzh/rds-csv-nginx-module" target="_blank" rel="external">rds_csv</a> 来直接得到 csv 格式的数据提供给用户，而不是 json。</li>
	<li>可以使用 <a href="https://github.com/chaoslawful/lua-nginx-module" target="_blank" rel="external">ngx_lua</a> 在 nginx.conf 里面使用 lua 来在服务器端对数据做一些处理再丢给浏览器。
大家都知道 js 处理的数据太大的时候，会导致浏览器卡死，所以如果不方便通过 sql 控制输出的时候，可以使用 lua 来处理下。当然 这只是其中一个应用，使用 ngx_lua 你可以干很多事情，比如上面那个使用 js 来生成 spline 数据的函数就可以用 lua 来实现，lua 还可以和 c 结合来做一些事情。对于 location 的参数，在 ngx_lua 里面也是可以访问的，比如 ngx.var.arg_c 这样。具体还是看 wiki 吧，写不完的。
<ol>
	<li>openresty 还能直接访问 redis 和 memcached。</li>
</ol>
本篇只能算是一个入门而已，openresty 在淘宝量子统计的应用非常广泛。另外在 <a href="http://qunar.com" target="_blank" rel="external">去哪网</a> 也有不少应用，比如我知道的安全过滤模块，和一些数据报表，都是基于 openresty 的。

附一个 highcarts 画的图

<img class="alignnone" title="流量情况" src="http://wdicc.com/images/2011-10-24-171245_1100x312_scrot.png" alt="" width="1100" height="312"></li>
</ol>
</div>
</div>
</div>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/intro-openresty/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="generate_series-function-in-postgresql/">postgresql 里面的 generate_series</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-10-13T16:00:00.000Z" itemprop="datePublished">Oct 14, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/linux/">linux</a> <a href="../tags/postgresql/">postgresql</a>
</div>
    </div>
      
        
<p>有个报表需要把几天的记录按照小时 join 起来，最开始的作法是通过 js 来 join 数据。后来遇到了问题，就是某天某个小时可能会没有记录，然后想破头了，在 js 里面循环的时候设置每天循环到的当前的小时。可崩溃的是还会出现有的是这两小时没有，有的是另外的，用 js 搞不定了，就尝试用 sql 搞定。
</p>
<p>
sql 开始的方法是简单的使用 full join。然后发现没法保证主表在所有的小时都有记录。后来就发现了这个 generate_series 函数，发现很有意思。地址在这里 <a href="http://www.postgresql.org/docs/9.0/static/functions-srf.html" target="_blank" rel="external">http://www.postgresql.org/docs/9.0/static/functions-srf.html</a> 。这里还有个 generate_scripts 的函数，可以用来遍历数组产生一个表格的。
</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/generate_series-function-in-postgresql/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="intro-hbase/">了解了下 hbase</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-08-01T16:00:00.000Z" itemprop="datePublished">Aug 2, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/linux/">linux</a> <a href="../tags/hbase/">hbase</a>
</div>
    </div>
      
        <p>很早就知道 hbase 了，但是一直没有仔细去了解 hbase 是怎么回事。今天了解了下他的表结构。
</p>
<p>
这篇文章 <a href="http://www.searchtb.com/2011/01/understanding-hbase.html" target="_blank" rel="external">http://www.searchtb.com/2011/01/understanding-hbase.html</a> 其实写的挺清楚，下面这个是个例子
</p>
<p>
<pre class="prettyprint">
hbase(main):007:0&gt; scan 'test'                         
ROW                                 COLUMN+CELL                                                                                            
 row1                               column=cf:a, timestamp=1312258784360, value=value3                                                     
 row1                               column=cf:b, timestamp=1312258795425, value=value3                                                     
 row2                               column=cf:b, timestamp=1312257616099, value=value2                                                     
 row3                               column=cf:c, timestamp=1312257621344, value=value3
</pre>
</p>
<p>
在 hbase 里面访问数据都是通过 row key + column，其实也就是哪行哪列，不过不是通过数字定位。
</p>
<p>
在 hbase 里面看不到传统数据库的表格形式的数据列表，可以看到上面这种。传统数据库里面，每行的列数是一样的，如果那列没值，那也得填一个 null 之类。
</p>
<p>
hbase 就不一定了，可以看到上面的 row1 行，有两列 cf:a, cf:b，而 row2，row3 就只有一列。
</p>
<p>
所以 hbase 作为 key-value 系统的时候，row key + column 就是所谓的 key。
</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/intro-hbase/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="alarm-signal-in-perl/">alarm 使用不当遇到的问题</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-05-07T16:00:00.000Z" itemprop="datePublished">May 8, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/linux/">linux</a> <a href="../tags/perl/">perl</a>
</div>
    </div>
      
        <p>前段时间发现有个程序总是运行一段时间就挂掉，看各种日志里面都没有错误信息，感觉就是莫名其妙突然进程就没了。
</p>
<p>
大概流程是有个 perl 程序 a.pl
</p>

<pre class="prettyprint">
.....
my $pid = fork();
if ( !$pid ) {
   my $cmdRet = `b.pl 2>&1`;
   print FILE $cmdRet;
   if ( $status ) {
       warn "task failed";
   } else {
      warn "task success";
   }
   exit;
}

waitpid ........
</pre>
<p>
b.pl 里面会执行 rsync 去获取一些文件，他会循环到几个机器上面去 rsync
<pre class="prettyprint">
for ( @hosts ) {
    my $result = `rsync xxxxx 2>&1`;
    if ( $? ) {
        log($result);
        log("failed");
    } else {
        log($result);
        log("success");
    }
}

sub log {
    my $msg = shift;
    print $msg;
    # 然后通过 IO::Socket::INET 发送给另外一个 server  a
}
</pre>

现象是，时不时的， b.pl 会只 rsync 了某几台(不确定是几台)机器上面的文件，然后就不继续了，从 server a 上面能收到他发日志，最后一条是 success 的信息
</p>
<p>
从 a.pl 记录的日志那里看, FILE 里面记录的内容丢失了 server a 收到的最后一部分的数据，多少数据不一定，不过肯定是没有那个 success 信息。 这个文件里面也没有任何的错误信息。
</p>
<p>
程序代码啥的都不动，rsync 的文件数不是总是一样的，也有文件多的时候没出错的时候,同时也设置了打开文件数为 65536.
</p>
<p>
后来发现问题就在 b.pl 里面的 log 里面。因为要发送到其他机器，怕挂住影响后续程序，所以设置了一个 alarm。
</p>

<pre class="prettyprint">
eval {
    alarm 5;
    xxxxxxx;
    alarm 0;
};

if ( $@ ) {
    print "error when send";
}
</pre>

<p>
这个 alarm 没有设置 handle 的函数，这样就会导致 alarm 到期的时候，会直接让整个 perl 程序挂掉，并显示 "Alarm clock"，而且这个输出不在标准错误和标准输出里面。
</p>
<p>
修复也简单，alarm 前设置一个 handler 就好了。
</p>
<p>
另外，还有个问题，一个 alarm 会中断前一个 alarm，所以类似 sleep 的使用，可以这样
</p>

<pre class="prettyprint">
my $previousAlarm = 0;
eval {
    local $SIG{ALRM} = sub { die 'alarm'; };
    $previousAlarm = alarm 5;
     xxxx
     alarm 0;
};
alarm 0;

if ( $@ ) {
    xxxxx;
}

alarm $previousAlarm;
</pre>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/alarm-signal-in-perl/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="about-svn-merge/">svn merge</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-05-07T16:00:00.000Z" itemprop="datePublished">May 8, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/linux/">linux</a> <a href="../tags/svn/">svn</a>
</div>
    </div>
      
        <p>svn merge 的 help 信息
<pre class="prettyprint">
usage: 1. merge sourceURL1[@N] sourceURL2[@M] [WCPATH]
       2. merge sourceWCPATH1@N sourceWCPATH2@M [WCPATH]
       3. merge [-c M[,N...] | -r N:M ...] SOURCE[@REV] [WCPATH]
</pre>

svn 的 merge 的本质其实就是在两个版本之间生成 diff，然后把这个 diff 再应用到另外一个版本里面。
</p>
<p>
所以可以看到 merge 和最后的那个 WCPATH 之间，通常都需要指定两个版本。WCPATH 可以是其中的一个，这个没关系。
</p>
<p>
一般都是把新多出来的部分 merge 到另一个版本，所以通常是 svn merge old_ver new_ver working_ver 其中那个 working_ver 可以是 old_ver。
</p>
<p>
最好在 merge 之前加一个 &ndash;dry-run 看看他会修改哪些文件。 
</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/about-svn-merge/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="cant-drop-table-in-hive/">hive 里面不能 drop table</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-05-02T16:00:00.000Z" itemprop="datePublished">May 3, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/linux/">linux</a> <a href="../tags/hive/">hive</a> <a href="../tags/postgress/">postgress</a>
</div>
    </div>
      
        <p>之前部署 hive 0.6 的时候，发现用 postgress 存 metadb 的时候，不能 drop table，一执行就卡住了。当时试过 mysql，好像是有个什么问题，就没用了，后来只好用 hive 0.5 完事。
</p>
<p>
前几天有个别的事情工作不正常，以为可能是版本的问题，毕竟现在都 0.7 了。所以尝试了下直接升级到 0.7。在 0.6 版本的 hive 里面，自带了一个 postgress 用的升级 sql，但是 0.7 的没有。执行这个 sql 后，hive 0.7 能查询，但是同样的，也遇到了不能 drop table 的问题。
</p>
<p>
后来发现 drop table 的时候，hive 在尝试去查一个不存在的表，然后就卡在了这个 sql 上面，也不报错，也不超时，不知道是不是 jdbc 的问题。
</p>
<p>
然后把 mysql 用的升级 sql 迁移到了 postgress，这样 hive 0.7 在 postgress 里面也没问题了。
</p>
<p>
升级 sql 和邮件列表的主题在 <a href="http://www.mail-archive.com/user@hive.apache.org/msg01293.html" target="_blank" rel="external">http://www.mail-archive.com/user@hive.apache.org/msg01293.html</a> 。升级的时候要注意，新建的表的 owner 需要是 hive 使用的用户。
</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/cant-drop-table-in-hive/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="udf-in-hive/">hive 里面的 UDTF</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-04-23T16:00:00.000Z" itemprop="datePublished">Apr 24, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/hive/">hive</a>
</div>
    </div>
      
        hive 支持 UDF， UDAF， UDTF，这几个让你使用 hive 更加便捷。
<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">UDF</h2>
<div id="text-1" class="outline-text-2">

udf 就是一个自定义的 function，输入一个或多个参数，返回一个返回值，类似 substr/trim 之类。写起来比较简单，重构 UDF 类的 evaluate 方法就可以了。可以参考 <a href="http://richiehu.blog.51cto.com/2093113/386112" target="_blank" rel="external">http://richiehu.blog.51cto.com/2093113/386112</a> 。

这是一个 urldecode 函数。
<pre class="prettyprint lang-java">

import org.apache.hadoop.hive.ql.exec.UDF;
import java.net.URLDecoder;

public final class urldecode extends UDF {

    public String evaluate(final String s) {
        if (s == null) { return null; }
        return getString(s);
    }

    public static String getString(String s) {
        String a;
        try {
            a = URLDecoder.decode(s);
        } catch ( Exception e) {
            a = "";
        }
        return a;
    }

    public static void main(String args[]) {
        String t = "%E5%A4%AA%E5%8E%9F-%E4%B8%89%E4%BA%9A";
        System.out.println( getString(t) );
    }
}</pre>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">UDAF</h2>
<div id="text-2" class="outline-text-2">

udaf 就是自定义的聚合函数，类似 sum/avg 这类，输入多行的一个或多个参数，返回一个返回值。这个还没写过，可以参考 <a href="http://richiehu.blog.51cto.com/2093113/386113" target="_blank" rel="external">http://richiehu.blog.51cto.com/2093113/386113</a> 。

&nbsp;

</div>
&nbsp;

</div>
<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">UDTF</h2>
<div id="text-3" class="outline-text-2">

udtf 是针对输入一行，输出多行的需求来的，类似 explode 函数。可以参考 <a href="http://www.linezing.com/blog/?p=323" target="_blank" rel="external">http://www.linezing.com/blog/?p=323</a> 。

这个是输入数组字段，输出两列，一列是数组元素的位置，一列是数组元素。比 explode 多了一列位置，不过数组元素只能是 String 类型的。
<pre class="prettyprint lang-java">

import java.util.ArrayList;
import java.util.List;

//import org.apache.hadoop.io.Text;

import org.apache.hadoop.hive.ql.udf.generic.GenericUDTF;

import org.apache.hadoop.hive.ql.exec.UDFArgumentException;
import org.apache.hadoop.hive.ql.exec.description;
import org.apache.hadoop.hive.ql.metadata.HiveException;
import org.apache.hadoop.hive.serde2.objectinspector.ListObjectInspector;
import org.apache.hadoop.hive.serde2.objectinspector.ObjectInspector;
import org.apache.hadoop.hive.serde2.objectinspector.ObjectInspectorFactory;
import org.apache.hadoop.hive.serde2.objectinspector.StructObjectInspector;

import org.apache.hadoop.hive.serde2.objectinspector.primitive.PrimitiveObjectInspectorFactory;

@description(
        name = "explodeWithPos",
        value = "_FUNC_(a) - separates the elements of array a into multiple rows with pos as first col "
        )

public class explodeWithPos extends GenericUDTF {

    ListObjectInspector listOI = null;

    @Override
        public void close() throws HiveException{
        }

    @Override
        public StructObjectInspector initialize(ObjectInspector [] args) throws UDFArgumentException {

            if (args.length != 1) {
                throw new UDFArgumentException("explodeWithPos() takes only one argument");
            }

            if (args[0].getCategory() != ObjectInspector.Category.LIST) {
                throw new UDFArgumentException("explodeWithPos() takes an array as a parameter");
            }

            listOI = (ListObjectInspector)args[0];

            ArrayList fieldNames = new ArrayList();
            ArrayList fieldOIs = new ArrayList();

            fieldNames.add("col1");
            //fieldOIs.add(listOI.getListElementObjectInspector());
            fieldOIs.add(PrimitiveObjectInspectorFactory.javaStringObjectInspector);

            fieldNames.add("col2");
            //fieldOIs.add(listOI.getListElementObjectInspector());
            fieldOIs.add(PrimitiveObjectInspectorFactory.javaStringObjectInspector);

            return ObjectInspectorFactory.getStandardStructObjectInspector(fieldNames, fieldOIs);
        }

        //Object forwardObj[] = new Object[2];
        Object forwardObj[] = new String[2];

    @Override
        public void process(Object [] o) throws HiveException {

            List list = listOI.getList(o[0]);

            if ( list == null ) {
                return;
            }

            int i =0;
            for (Object r : list) {
                forwardObj[0] = String.valueOf(i);
                forwardObj[1] = r.toString();
                this.forward(forwardObj);
                i++;
            }
        }

    @Override
        public String toString() {
            return "explodeWithPos";
        }
}</pre>
</div>
</div>
</div>
</div>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/udf-in-hive/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="rsync-files-from-option/">rsync files-from 参数</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-04-15T16:00:00.000Z" itemprop="datePublished">Apr 16, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/linux/">linux</a> <a href="../tags/rsync/">rsync</a> <a href="../tags/org2blog/">org2blog</a>
</div>
    </div>
      
        <div id="outline-container-1" class="outline-2">
<h2 id="sec-1">rsync</h2>
<div id="outline-container-1_1" class="outline-3">
<h3 id="sec-1_1">include/exclude</h3>
<div id="text-1_1" class="outline-text-3">

rsync 支持使用 include/exclude 来过滤要同步的文件，使用这两个参数的时候，需要注意下面的这个问题
<pre class="prettyprint">
Note that, when using the –recursive (-r) option (which is implied by -a), every subcomponent of every path  is  vis‐
        ited  from the top down, so include/exclude patterns get applied recursively to each subcomponent’s full name (e.g. to
        include "/foo/bar/baz" the subcomponents "/foo" and "/foo/bar" must not be excluded).  The exclude  patterns  actually
        short-circuit  the  directory  traversal stage when rsync finds the files to send.  If a pattern excludes a particular
        parent directory, it can render a deeper include pattern ineffectual  because  rsync  did  not  descend  through  that
        excluded section of the hierarchy.  This is particularly important when using a trailing ’*’ rule.  For instance, this
        won’t work: 

/some/path/this-file-will-not-be-found
/file-is-included 
*</pre>
rsync 使用 -r 来遍历子目录的时候，如果还想用 exclude include 来过滤文件，那么要注意 一个目录如果满足了 exclude，而且还没有对应的 include，那这个目录下面的子目录也会被 exclude，就算你对这个子目录写了 include 。

虽然能解决问题，可实在很费劲，直到无意中发现了 files-from 参数。

</div>
</div>
<div id="outline-container-1_2" class="outline-3">
<h3 id="sec-1_2">files-from</h3>
<div id="text-1_2" class="outline-text-3">

files-from 是通过指定一个本地/远程的文件来定义需要同步的文件。这个文件生成方法可就多了，你可以用 find/sed/awk/xxxxx 等搭配来得到你这个文件，一行命令不够还可以多行，是不是爽多了？
<pre class="prettyprint">
如果是远程文件，那就 –files-from=:/path/to/files。

</pre></div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">写在后面</h2>
<div id="text-2" class="outline-text-2">

顺便测试一下 org2blog，这帖子是用 org2blog 写的，给作者提了个建议，加上 permlink 的支持，没几天居然给加上了，刚好测试一下，呵呵。

</div>
</div>
</div>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/rsync-files-from-option/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="twittering-mode/">emacs 上推神器 twittering-mode</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-04-02T16:00:00.000Z" itemprop="datePublished">Apr 3, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/emacs/">emacs</a>
</div>
    </div>
      
        emacs 里面可以干很多事情，包括上 twitter。 在 @xwl 的努力下，还能上 sina 微博。。。

emacswiki 地址在这里 http://www.emacswiki.org/emacs/TwitteringMode， xwl 的 fork 在这里 https://github.com/xwl/twittering-mode/，增加了 sina 微博的支持，好像最近还增加了 douban 的支持。

我的配置在这里 https://github.com/wd/emacs.d/blob/master/site-lisp/config/wd-twitter.el，里面 twitter 使用的是代理。

我用到的 twmod 的按键设置:
推上面 <ret> 回复
j/k/h/l 类似 vim 里面
h 到第一条
C-c C-s 发推
C-u M-x twittering-update-status-interactive 可以选择同时更新两个
M-x twittering-switch-to-unread-timeline 切换到未读的 timeline，可以绑定到一个按键上面

其他的看 C-h m 里面的说明吧，效果在这里 http://flic.kr/p/9vy96G
</ret>
      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/twittering-mode/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="parse-qqwry-dat/">解析纯真 ip 库</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-03-09T16:00:00.000Z" itemprop="datePublished">Mar 10, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/linux/">linux</a> <a href="../tags/perl/">perl</a>
</div>
    </div>
      
        纯真的 ip 库应用比较广泛，就那个 qqwry.dat。以前尝试过解析，死活弄不明白那写地址和 pack/unpack 啥的，晕的不行。这两天需要解析下，就尝试用 perl 写一个。

开始用 sysread/sysseek 很多都读不出来，看了n遍程序，没觉得有啥问题。后来全部改成了 read/seek 就好了，也不知道怎么回事。画了一个图说明下，参考了 http://lumaqq.linuxsir.org/article/qqwry_format_detail.html 。

<table style="width:auto;"><tr><td><a href="https://picasaweb.google.com/lh/photo/f83_NZhjf6QchgG9gGRueg?feat=embedwebsite" target="_blank" rel="external"><img src="https://lh6.googleusercontent.com/_7OB6ilikjVs/TXie-yreH2I/AAAAAAAAAKY/fTPMq-pkuqU/s640/qqwry.png" height="640" width="269"></a></td></tr><tr><td style="font-family:arial,sans-serif; font-size:11px; text-align:right">发件人 <a href="https://picasaweb.google.com/wdicc0/2011310?feat=embedwebsite" target="_blank" rel="external">2011-3-10</a></td></tr></table>

读来的3字节地址需要加 "\0" 才能 unpack，不知道怎么回事，对这些问题弄不明白。对了，网上还有个 perl 版的，也能用，需要的话可以搜一下。

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/parse-qqwry-dat/#disqus_thread">Comments</a></span>
	
</div>
</article>


  <nav id="pagenavi">
    
        <a href="/page/4/" class="prev">Prev</a>
    
    
        <a href="/page/6/" class="next">Next</a>
    
  <div class="center"><a href="/archives/index.html">Blog Archives</a></div>
  </nav>


    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2016

    wd
. Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> |
    Theme is <a href="https://github.com/wd/hexo-fabric">hexo-fabric</a>, fork from <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
