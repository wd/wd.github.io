<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>wd and cc</title>
    <meta name="author" content="wd">
    
	<meta name="description" content="undefined"> <!-- TODO: truncate -->
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="wd and cc" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='//fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    

</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        wd and cc
    </div>
</h1>
<span class="subtitle">happy everyday</span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/wd" class="github" title="Github"></a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/wd" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
	<li id="ajax"><a href="/tags/index.html">Tags</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form action="//www.google.com.hk/search" method="get" accept-charset="UTF-8" id="search">
            <input type="hidden" name="sitesearch" value="https://wdicc.com" />
            <input type="text" name="q" results="0" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload -->
    <div id="content" class="inner">
        

    
        <script id="dsq-count-scr" src="//wdicc.disqus.com/count.js" async></script>
    



  <article class="post">
	<h2 class="title">
		<a href="auto-archive-task-for-org-mode/">org-mode 里面自动归档任务</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2012-04-07T16:00:00.000Z" itemprop="datePublished">Apr 8, 2012</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/linux/">linux</a> <a href="/tags/emacs/">emacs</a> <a href="/tags/org-mode/">org-mode</a>
</div>
    </div>
      
        <p>我想应该有不少人在使用 emacs 的 org-mode 来做笔记，任务管理等。我使用 org-mode 比较多的情况是使用他做一些提纲，类似思维导图一样，以及用它来管理 todo list。
</p>
<p>
org-mode 本身提供了 remember 来创建 todo list。
</p>
<p>
新建一个 org 文件 ~/org/todo.org，包含两行内容如下
</p>


<pre class="prettyprint lang-text">
* Tasks
* Done
</pre>

<p>
然后设置下面的内容
</p>


<pre class="prettyprint lang-lisp">
(define-key global-map "\C-ca" 'org-agenda)
(global-set-key (kbd "C-c m r") 'org-capture)
(setq org-capture-templates
      '(("t" "Todo" entry (file+headline "~/org/todo.org" "Tasks")
         "* TODO %?\nCREATED: %U")
        ("j" "Journal" entry (file+datetree "~/org/journal.org")
         "* %?\nEntered on %U\n  %i\n  %a")))
(defun wd-move-done-task-to-done-cats ( task-pos )
  "move done task to *DONE cats"
  (let* ((entry (org-get-entry))
        (title (org-get-heading))
        (task (format "** %s\n%s\n" title entry))
        )
    (goto-char (point-min))
    (when (search-forward-regexp "^* Tasks$latex ")
      (goto-char (point-min))
      (when (search-forward-regexp "^* Done$")
        (goto-char (match-beginning 0))
        (forward-line)      
        (insert task)
        (goto-char task-pos)
        (delete-region (org-entry-beginning-position) (org-entry-end-position))      
        )
      )
    )
  )

(defun wd-track-task-status ( changes-plist )
   "Track task status, and move it to '* Done' cats if it is stats change from to to done
1 TODO 文件至少需要包含两个标题 * Tasks 和 * Done
2 * Tasks 里面的 TODO 内容变成 DONE 的时候，会自动把这个条目移动到 * Done
3 org-todo-keywords 的设置里面不能包含自动增加时间等的设置，否则增加的内容不能正确加到这个条目
"
   ;; (interactive)
   (let ((type (plist-get change-plist :type))
          (pos (plist-get change-plist :position))
          (from (plist-get change-plist :from))
          (to (plist-get change-plist :to))
          )
     (when (and (string= from "TODO")
                (string= to "DONE"))
       ;; (let ((answer (read-char "Move this entry to *DONE ? Y/N (Y)")))
       ;;   (when (or (= answer (string-to-char "y"))
       ;;             (= answer (string-to-char "Y"))
       ;;             (= answer (string-to-char "
"))
       ;;             )
           (wd-move-done-task-to-done-cats pos)
         ;; ))
       )
     )
   )

(add-hook 'org-trigger-hook 'wd-track-task-status)

;; (setq org-todo-keywords
;;       '((sequence "TODO(t)" "WAIT(w@/!)" "|" "DONE(d!)" "CANCELED(c@)")))
(setq org-todo-keywords
      '((sequence "TODO(t)" "WAIT(w)" "|" "DONE(d)" "CANCELED(c)")))
</pre>

<p>
在任何地方按一下 C-c m r，会出来一个 window 让你选择要创建 todo 还是 journal。选 t，然后输入内容就会自动插入到 ~/org/todo.org 的 * Tasks 里面。
</p>
<p>
此后，如果任务完成的时候，打开 todo.org，然后在任务上面 C-c C-t，会提示输入状态。如果是从 TODO 变成了 DONE，那这条任务会被转移到 * Done 里面。
</p>
<p>
因为里面都有时间，所以在 agenda list 里面，可以用 L 看到任务完成时间等。也将就用了。
</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/auto-archive-task-for-org-mode/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="emacs-settings-in-mac/">mac 里面的 emacs 的几个设置</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2012-03-05T16:00:00.000Z" itemprop="datePublished">Mar 6, 2012</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/linux/">linux</a> <a href="/tags/emacs/">emacs</a> <a href="/tags/macos/">macos</a>
</div>
    </div>
      
        
<p>刚开始在 mac 里面使用 emacs 简直就是自虐，因为那个反人类的 command 按键。一般 pc 上面的 alt 是在 space 旁边的，macbook 的 space 旁边是 command，对于一个需要经常在 mac 里面按的键，不是一般的郁闷。这个问题有两个方法解决。
</p>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">mac 自带的解决方法</h2>
<div class="outline-text-2" id="text-1">


<p>
就是在键盘设置里面，把修饰键里面的 command 和 alt 替换一下。这个方法会很不爽，因为 mac 里面的复制粘贴是 command + c/v，以后要按 alt + c/v 的话，距离有点远。
</p>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">KeyRemap4MacBook</h2>
<div class="outline-text-2" id="text-2">


<p>
这个是个 mac 上面的软件，地址在 <a href="http://pqrs.org/macosx/keyremap4macbook/document.html" target="_blank" rel="external">这里</a> 。里面的设置实在太多了，这里要用到的一个就是只在 emacs 里面把 command 和 alt 替换一下，这样就解决了上面提到的问题，还算完美。可是这个时候会发现，在 emacs 界面激活的情况下，command 开头的系统级别的快捷键都不好用了，比如 command + tab，这也很郁闷。
</p>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">emacs 自带的完美解决方法</h2>
<div class="outline-text-2" id="text-3">


<p>
只说 emacs23，emacs24。早期的好像有 mac-pass-command-to-system 之类的设置，可我在 emacs24 里面没看到这个变量。
</p>
<p>
具体设置参考<a href="http://www.emacswiki.org/emacs/EmacsForMacOS#toc23" target="_blank" rel="external">这里</a> ，主要是下面这些设置。
</p>


<pre class="prettyprint lang-lisp">
;; key bindings
(when (eq system-type 'darwin) ;; mac specific settings
  (setq mac-option-modifier 'alt)
  (setq mac-command-modifier 'meta)
  (global-set-key [kp-delete] 'delete-char) ;; sets fn-delete to be right-delete
  )
</pre>

<p>
现在就很爽了，按 command + x 和 alt + x 效果一样，按 command + tab 也能切换窗口。算是完美了。
</p></div>
</div>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/emacs-settings-in-mac/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="analyse-and-vacuum-in-postgres/">postgres sql 调优一例</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2012-03-02T16:00:00.000Z" itemprop="datePublished">Mar 3, 2012</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/linux/">linux</a> <a href="/tags/postgres/">postgres</a> <a href="/tags/sql/">sql</a>
</div>
    </div>
      
        <p>前几天发现有个 sql 跑的超慢，第一次拿到 sql 大家简单分析了一下，觉得是写的有问题，里面有对一个大表的查询，数据量大概 800 万，结果还和好几个小表做了 join，而且还是 left join，速度可想而知了。单独对那个大表查询，其实也就是几分钟的事情。
</p>
<p>
所以建议就是先对小表做 join，然后再和大表做一次 join。不过结果并不理想，时间依然还是那么长。这个时候就得仔细看执行计划了，如下。
</p>
<p>
能看到虽然人肉对 sql 做了一些优化，但是 sql 并没有按照我们的期望去执行，执行计划里面还是首选去查 fact_tuan_rank_detail 这个大表，速度肯定慢了。
</p>


<pre class="prettyprint lang-text">
 Nested Loop Left Join  (cost=447.90..1003.43 rows=2 width=620)
   Join Filter: (team.id = team_arrive_city.team_id)
   ->  Nested Loop  (cost=77.62..85.98 rows=1 width=588)
         ->  HashAggregate  (cost=77.62..77.68 rows=1 width=71)
               ->  Index Scan using date_idx on fact_tuan_rank_detail  (cost=0.00..77.60 rows=1 width=71)
                     Index Cond: ((thedate >= '2012-02-25'::date) AND (thedate <= '2012-02-27'::date))="" filter:="" (((source)::text="" ~~="" '%team%'::text)="" and="" ((source)::text="" !~~="" '%today%'::text)="" '%ongoing%'::text)="" ((s="" ource)::text="" '%special%'::text))="" -="">  Index Scan using team_pkey on team  (cost=0.00..8.28 rows=1 width=32)
               Index Cond: (team.id = fact_tuan_rank_detail.team_id)
               Filter: ((to_timestamp((team.end_time)::double precision))::date > '2012-02-27'::date)
   ->  HashAggregate  (cost=370.29..589.15 rows=14591 width=15)
         ->  Seq Scan on team_arrive_city  (cost=0.00..288.19 rows=16419 width=15)
(12 rows)
</=></pre>

<p>
仔细研究之后，发现了 rows=1 这个信息。这就是为什么查询分析器先对这个表做查询了，因为他认为这个表最小。
</p>
<p>
此后对这个表执行了一下 <a href="http://www.postgresql.org/docs/9.1/static/sql-analyze.html" target="_blank" rel="external">analyse</a> 命令，更新了一些统计信息。然后再看执行计划如下。
</p>


<pre class="prettyprint lang-text">
 Hash Join  (cost=1210761.12..1326052.45 rows=2282704 width=620)
   Hash Cond: (fact_tuan_rank_detail.team_id = team.id)
   ->  HashAggregate  (cost=1203912.40..1265555.26 rows=1027381 width=71)
         ->  Index Scan using date_idx on fact_tuan_rank_detail  (cost=0.00..1075489.81 rows=10273807 width=71)
               Index Cond: ((thedate >= '2012-02-25'::date) AND (thedate <= '2012-02-27'::date))="" filter:="" (((source)::text="" ~~="" '%team%'::text)="" and="" ((source)::text="" !~~="" '%today%'::text)="" '%ongoing%'::text)="" ((source)="" ::text="" '%special%'::text))="" -="">  Hash  (cost=6666.33..6666.33 rows=14591 width=64)
         ->  Merge Left Join  (cost=6414.63..6666.33 rows=14591 width=64)
               Merge Cond: (team.id = b.team_id)
               ->  Sort  (cost=4670.40..4686.82 rows=6567 width=32)
                     Sort Key: team.id
                     ->  Seq Scan on team  (cost=0.00..4254.02 rows=6567 width=32)
                           Filter: ((to_timestamp((end_time)::double precision))::date > '2012-02-27'::date)
               ->  Sort  (cost=1744.23..1780.71 rows=14591 width=40)
                     Sort Key: b.team_id
                     ->  Subquery Scan on b  (cost=370.29..735.06 rows=14591 width=40)
                           ->  HashAggregate  (cost=370.29..589.15 rows=14591 width=15)
                                 ->  Seq Scan on team_arrive_city  (cost=0.00..288.19 rows=16419 width=15)
(18 rows)
</=></pre>

<p>
可以看到执行计划已经变了，先做其他表的 join，最后再和大表 join。并且提示的执行时间也大致靠谱。
</p>
<p>
从这里面引申一下，时常会听到有人说 explain 命令执行后得出的执行时间不靠谱，需要使用 explain analyse。可是为什么不靠谱呢，其实 explain analyse 需要的时间和实际执行时间一样，explain 不靠谱的原因是因为数据库对那个表的统计信息不及时导致的。
</p>
<p>
再进一步了解，postgres 里面这个统计信息为什么不靠谱呢？难道还总是需要我维护这些信息啊？
</p>
<p>
其实 postgres 里面有个 autovacuum 进程就是做这个事情的。autovacuum 进程默认是启用的。他会在数据库空闲的时候，对数据库做 vavcuum 和 analyse。具体多久执行一次，<a href="http://www.postgresql.org/docs/9.1/static/routine-vacuuming.html" target="_blank" rel="external">文档</a> 里面都有写，建议多看看这个页面里面的信息。
</p>
<p>
此外，还发现 postgres 还提供了很多 <a href="http://www.postgresql.org/docs/9.1/static/monitoring-stats.html" target="_blank" rel="external">数据库状态查询函数</a> ，使用这里面函数可以查到每个表最后一次 analyse 的时间，vacuum 的时
间，里面索引被使用的情况等等，好多信息。
</p>

ps: 使用 analyse 之后，那个 sql 好用了，可是发现过两天又不行了，查看 explain select * from t1 好像没问题，那怎么回事呢？开始没想明白，只好继续 analyse 一下，又好了。可过了两天又不行了。这次得细看了。最后发现是因为真实的 sql 是有 where 条件的，日期条件限定的那部分数据查询分析器认为很少导致了问题。没办法后面只好每次导数都 analyse 一下了。发现 pg_bulkload 导数的方式有点问题。

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/analyse-and-vacuum-in-postgres/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="emacs-in-mac/">总算是将就同步好了 gentoo 和 mac 的 emacs</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2012-02-19T16:00:00.000Z" itemprop="datePublished">Feb 20, 2012</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/heart/">heart</a>
</div>
    </div>
      
        mac 里面居然自带了一个 emacs，，版本是 22.1.1，有够老的反正是。因为 gentoo 用的是 emacs24，所以按照不知道哪里推荐的，去下载了一个 emacs24。然后就是尝试在 mac 下面配置好我的 emacs 了，配置好才好通过 org2blog 写 blog。。。

老早就随大流把 .emacs.d 放到了 github，所以这部分比较简单，只要 clone 一下就可以了。

之前没想到的是我的一部分 elisp 包是通过 gentoo 管理的，这样只有 .emacs.d 显然是不行的。然后使用了 dropbox 这个方案，把 gentoo 里面的 site-lisp 部分也同步过来。主要是 <em>usr/share/emacs/etc</em> 和 <em>usr/share/emacs/site-lisp</em> 两个目录。把 gentoo里面的这两个目录转移到 dropbox 里面，然后做个软链。mac 里面也从 dropbox 里面做好软链，要注意路径位置不能变化，变化的话 gentoo 里面的 site-gentoo.el 里面写死的路径就不能用了。不过不变化那个路径的话，其实是会影响系统自带的 emacs22.1.1 的使用的，不过不管了，爱咋匝地吧，反正我也不用那个。

接下来就是在 .emacs 里面加 load-path 就可以了。gentoo 是不需要的，所以用下面的代码
<pre class="prettyprint lang-lisp">
    (setq load-path
        (cons "/usr/share/emacs/site-lisp/" load-path)))</pre>
mac 里面用 emacs 一个郁闷的问题是，command 键挤在了 alt 和 space 中间，和普通键盘不一样，导致习惯了普通键盘的我经常按错。很郁闷，不知道能不能把那个 command 弄成 alt，反正好像 command 在 emacs 里面没用。。。

可以用上面类似的方法处理一些两个系统的特例。

顺便再吐槽下 mac 的输入法，装了个 sogou，发现这小子启动慢，经常切换过去后打了几个字母了都，他还没反应，字母就上屏了。fit的词库又不行，词频调整也有问题。‘在’我这半天输入 n 个了都，还是处在‘再’的后面，很讨厌。不知道有没有其他靠谱的。。。

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/emacs-in-mac/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="wine-in-mac/">mac 上面安装 wine</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2012-02-12T16:00:00.000Z" itemprop="datePublished">Feb 13, 2012</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/mac/">mac</a>
</div>
    </div>
      
        买了 mbp 之后，就尝试安装 wine。想用它搞定 rtx 来着。

我用的 homebrew，感觉还不错。之前尝试过 gentoo prefix，我的妈，要编译的包太多了。homebrew 好很多。

wine 使用 llvm-gcc 编译不过去，需要先安装 gcc，gcc 在 xcode 低版本好像是自带的，高于 4.2.x 好像就不带了。

gcc 也有几个选择，可以参考<a href="https://github.com/mxcl/homebrew/issues/9925" target="_blank" rel="external">这里</a>，我用的第一个。
<pre class="prettyprint lang-bash">
brew install --use-gcc wine</pre>
基本上就没问题了，参考了 <a href="https://github.com/mxcl/homebrew/issues/9925" target="_blank" rel="external">这里</a>。

对了，brew 里面还有 winetricks，可以直接安装使用。还没有尝试安装 rtx，不知道这玩意能不能装上。。

ps: 感觉这片文章好水。。一点含量都没有。。

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/wine-in-mac/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="use-davmail-to-access-exchange-server-better-in-thunderbird/">thunderbird 和 davmail 配合连接 exchange</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2012-01-31T16:00:00.000Z" itemprop="datePublished">Feb 1, 2012</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/linux/">linux</a> <a href="/tags/thunderbird/">thunderbird</a> <a href="/tags/davmail/">davmail</a> <a href="/tags/exchange/">exchange</a> <a href="/tags/outlook/">outlook</a>
</div>
    </div>
      
        
<p>exchange 是个恶心玩意，虽然提供了 imap 接口，但是速度巨慢，发送接收都慢。davmail 可以解决这个问题。
</p>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">davmail 能干啥</h2>
<div class="outline-text-2" id="text-1">


<p>
<a href="http://davmail.sourceforge.net/" target="_blank" rel="external">davmail</a> 可以理解为就是一个 proxy，他负责和 exchange 通讯，其他邮件客户端连接 davmail 来获取邮件什么的。网站上面有图，看
着更加直观一点。
</p>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">安装配置 davmail</h2>
<div class="outline-text-2" id="text-2">


<p>
ubuntu 里面好像直接就有，apt-get 安装就可以了。gentoo 里面没有，我在 overlay 里面找到一个 ebuild，自己修了一下，放到我的
<a href="https://github.com/wd/overlay" target="_blank" rel="external">overlay</a> 了，在 net-mail/davmail-bin 下面。启用 server 这个 use。
</p>
<p>
安装后会创建一个 davmail 用户，需要建立一个 /var/log/davmail 的目录，给 davmail 写权限。
</p>
<p>
然后手动运行 <i>opt/davmail/davmail.sh，有界面，配置好 exchange owa 的地址，保存，会生成 ~</i>.davmail.properties 文件。
</p>
<p>
这里有个问题，如果 owa 地址是 http 的，那直接继续下面的就可以了，如果是 https 的，那还需要配置对应的 ssl 相关参数。我是
直接在 thunderbird 里面配置好之后，收了一下邮件，然后会提示一个什么证书的东西，这之后再继续下面的事情就可以了，这个时候
他会给你配置好里面 ssl 相关的东西。
</p>
<p>
复制到 /etc/davmail.properties，把里面的 davmail.server=fales 改成 true，设置好 log 为 /var/log/davmail/davmail.log，级
别先使用 debug，测试好了之后改成 warn。
</p>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">配置 thunderbird</h2>
<div class="outline-text-2" id="text-3">


<p>
参考 davmail 网站上面关于 thunderbird 的配置就好了。
</p>
<p>
可配置的有接收，发送，地址簿，日历。
</p>
<p>
排错就看看 /var/log/davmail/davmail.log 把，信息很详细。  
</p></div>
</div>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/use-davmail-to-access-exchange-server-better-in-thunderbird/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="about-mao/">老文一篇，关于小毛</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-12-04T16:00:00.000Z" itemprop="datePublished">Dec 5, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/heart/">heart</a>
</div>
    </div>
      
        一个老文，从 buaa bbs 翻出来，贴这里吧
<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">无题(1)</h2>
<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1">序曲</h3>
<div id="text-1-1" class="outline-text-3">

好久以前就想养只猫了，可是条件不允许。没法子，只能看看别人pp的小猫过过瘾了。

去年冬天的时候，养猫的欲望越来越严重，以至于那个时候就找robomm定了一个，其间小叶子还和我说要是想养的话可以给我找人抱一只。呵呵，不过后来robomm的大猫好像没有怀孕，结果空欢喜一场。再后来就要过年了，因为照顾起来也不方便，所以就放弃了。过年来了我就在打算抱只小猫了。开始本来打算找宠物市场买一只，可是robomm的那片文章，让我放弃了这个念头，trademark一只在怂恿我去买一只，不过还好我能顶得住，呵呵。平时也不去什么猫的论坛，那就只好让robomm给我留意一下啦，呵呵。

</div>
</div>
<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2">联系</h3>
<div id="text-1-2" class="outline-text-3">

robomm给我介绍的我联系过两个，其中有一个只是发email问了问相片，不过他好久才给我回的，他给我回信时，我都已经和另外一个谈好了，呵呵，那个就是万晓飞。我介绍了我的情况之后，她说可以给我，不过有个条件，就是要送她的大猫一些猫粮，说为了让我付出点代价，这样我至少不会随便处理掉猫猫，我想都没想说没问题，然后就这么说定了。第一眼看到这些小猫的相片的时候，他们还不点大，其实也比现在大不了多少，非常可爱。而我尤其喜欢那个头上有点黑毛的小猫，之后的联系中她也同意给我那只了。高兴中，我就在bbs上面发了帖子，给大家看，那个就是我要的猫。:p

</div>
</div>
<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3">郁闷之初</h3>
<div id="text-1-3" class="outline-text-3">

因为没有满月，所以要等1，2个星期才行。上周一我给他发了个mail问小猫的事情，周二他给我打电话，说我可以过去拿了，不过告诉我那只说好了留给我的给她姐姐了，当时我很郁闷。后来一想，还不都一样啊，呵呵，我说那就拿起他的吧，没关系。然后就说起送大猫什么猫粮的事情来，然后他就说周一有个小mm花了80多块钱的猫粮，其实也就值40多，被骗了。所以让我买罐头好了，7块钱一听。也差不了那么多。期间我也没有问我需要买多少，因为我想，既然都这么联系好了，那多少还不是一个形式而已？而她也一再表示她不是要卖钱。从后来接触中听她的口气，她确实应该不缺钱，北京的有钱人。

没有订到我想要的那个，多少也有点郁闷吧，不过这还好。

</div>
</div>
<div id="outline-container-1-4" class="outline-3">
<h3 id="sec-1-4">郁闷之中</h3>
<div id="text-1-4" class="outline-text-3">

周二她说我工作日晚上都可以过去吧，我说我还没有准备好猫用的东西，所以周三我需要去买点东西，周四吧，她说可以。周二晚上我来bbs问好了robomm，然后周三下午请假去买了猫粮，和一些猫用的东西。周四，我和她联系，问我晚上什么时候过去，让我郁闷的是，她说今天晚上不行。。。。。。

</div>
</div>
<div id="outline-container-1-5" class="outline-3">
<h3 id="sec-1-5">郁闷之极</h3>
<div id="text-1-5" class="outline-text-3">

既然不行，我说那就周五吧，而且我想周五也刚好，抱回来是周末，也好照顾一下她。周五也就是今天了。今天我们部门搬到楼上，从早上9点开始，一直忙到下午6点，还有一些东西没有搞定，不过只能周一了。中午吃完饭我给他发短信问我什么时候过去，后来我就去忙了，结果他给我发的消息我没有看到，后来他给我打电话，然后我们说好了过去的时间，不过中间她问我给大猫买了多少东西，我说6听。然后他就表现出很失望的样子，我立刻郁闷了。。。

我说如果你觉得我买的少了，不够诚心的话，那就算了，我也就不过去了。后来反正两个人jjww了半天，还是说好过去了。

</div>
</div>
<div id="outline-container-1-6" class="outline-3">
<h3 id="sec-1-6">喜悦之初</h3>
<div id="text-1-6" class="outline-text-3">

没想到搬家忙到了6点，这一天我就中午吃饭的时候喝了口水，而且一直搬桌子柜子，脚都疼死了，连坐一下都没有时间，不过总算是忙完了。

站在地铁里面，我的脚一直在疼，想相还要走那么远，稍有点不爽。

到了她家，门口有只黄色的大猫，跑来跑去的，据说他们有三只大猫。还有两只就是现在丁丁（我听他们喊他丁丁，我觉得也挺好听的，而且他确实很小不点，wy还说像只老鼠，呵呵，就这么叫吧 :p）的父母了。

万晓飞给我在沙发下面摸了半天，把丁丁给我摸了出来，呵呵，小不点，然后头顶有点淡黄色的毛，非常可爱。我看到这只小猫，之前的郁闷全都没有啦，哈哈。据说这只猫的眼睛是鸳鸯眼，反正我也不懂了。。。(to be continued…)

</div>
</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">无题(2)</h2>
<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1">说在前面的话</h3>
<div id="text-2-1" class="outline-text-3">

偶得小丁丁的名字在我叫了两天之后，终于没有能顶得住大家的压力，改名叫毛毛啦，小名就叫小毛好了，赫赫。事情是这样的，小猫抱回来之后，大家就开始给她起名字了，如下：小白、小黑、毛球、小红，我一看这可不行啊，而且关键是丁丁大家都不大同意阿，没法子，就叫毛毛吧，其实我一开始就打算叫这个的。这个名字好歹赢得了几个人的同意，赫赫。

</div>
</div>
<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2">继续上次的话题</h3>
<div id="text-2-2" class="outline-text-3">

把小毛塞到包里，我就急急忙忙的出来了。小毛一到包里，就开始喵喵叫个不停，声音很细，可是一直叫，我抱着包，然后赶紧跑出来打了个车就杀回来了。跑上楼，打开包，小毛不叫了，开始环视周围环境，哈哈，肯定吓了一跳。

</div>
</div>
<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3">家有小毛</h3>
<div id="text-2-3" class="outline-text-3">

赶紧给他准备猫粮、猫砂、水、小窝什么的，准备妥当之后，才想起来，我还没有吃饭呢，搬家搬了一天，脚后跟都疼死了。烧水煮了点面，吃完面发现小家伙不见了，喊了半天也没有反映，想想可能钻床地了。床下好多东西，掏了半天才看到，摸出来后，小家伙一溜烟，又跑到下面去了，呵呵，把我郁闷的，再次摸出来后，我就把东西都靠里面的墙边放，这样他就算再跑进去也容易够了。后来还是xh给猫的小窝上面盖了一件衣服，放进去之后小毛才算老实了，在里面呆着，哈哈，原来他是害羞阿。刚抱回来的时候给她拍了几张相片，不过没敢用闪光灯，怕吓着他，所以比较模糊，呵呵，感兴趣的可以到我的ftp上面下。

</div>
</div>
<div id="outline-container-2-4" class="outline-3">
<h3 id="sec-2-4">一个星期左右</h3>
<div id="text-2-4" class="outline-text-3">

现在小毛抱回来大概一个星期左右了吧，刚开始那两天天气比较冷，我这里暖气不是很足，我担心他冻着，所以就把他抱到被子里面呆了两个晚上。后来那几天转暖和了，而且我发现她的眼屎特别严重，怀疑是晚上太热所致，所以后来几天就没有让他钻了。晚上她老是要从被子的边角往里面跑，往往是我每次醒来都会发现他已经在被子里了，然后就把他抱出去，下一次醒来就又来了，呵呵，一点办法都没有。不过这几天发现小家伙懂事多了，困了会爬到你的腿上睡一会，玩一会，要不然就会爬到自己的窝里面睡，晚上也比较少钻被子了。呵呵。

</div>
</div>
<div id="outline-container-2-5" class="outline-3">
<h3 id="sec-2-5">尾声</h3>
<div id="text-2-5" class="outline-text-3">

就说这些了吧，我觉得养一只小猫也没有说的那么恐怖了，你只要让他找到了吃饭喝水方便的地方，基本上就不用你管了，他要是什么找不到，就会和你喵喵的叫得，你要是听到了就把他抱到吃饭喝水的地方，他自己就会去解决了。至于洗澡、打针、剪指甲之类的事情也不是天天都有，所以还是比较省心的，呵呵。

</div>
</div>
<div id="outline-container-2-6" class="outline-3">
<h3 id="sec-2-6">说在后面的话</h3>
<div id="text-2-6" class="outline-text-3">

就是既然上一次的标题用丁丁历险记了，这次还是继续吧，哈哈。

</div>
</div>
</div>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/about-mao/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="about-org2blog/">介绍下 org2blog</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-10-23T16:00:00.000Z" itemprop="datePublished">Oct 24, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/linux/">linux</a> <a href="/tags/emacs/">emacs</a> <a href="/tags/org2blog/">org2blog</a>
</div>
    </div>
      
        <div id="outline-container-1" class="outline-2">
<h2 id="sec-1">org2blog 是什么</h2>
<div id="text-1" class="outline-text-2">

<a href="https://github.com/punchagan/org2blog" target="_blank" rel="external">org2blog</a> 是用来把 org-mode 格式的文章发布到 wordpress 的工具。其实之前使用 webloger.el 也可以发布到 wordpress，不过是
webloger.el 已经基本没人维护了，这个 org2blog 作者支持还很积极，另外 org-mode 还提供了一些额外的方便编辑的方法，所以其实
是个不错的东东。

</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">安装</h2>
<div id="text-2" class="outline-text-2">

其实按照上面地址的内容，安装很简单。
<pre class="prettyprint">
(setq load-path (cons "~/.emacs.d/org2blog/" load-path))
(require 'org2blog-autoloads)</pre>
<ol>
	<li>依赖 <a href="http://launchpad.net/xml-rpc-el" target="_blank" rel="external">xml-rpc</a> ，添加到 load-path</li>
	<li>需要最新版本的 org-mode，我使用的是 emacs 24 里面的 7.7，之前使用 7.5(?) 的时候，遇到了发布的时候会在文章结尾附加
&lt;/body&gt;&lt;/html&gt; 导致 blog 的展现挂掉的问题。</li>
</ol>
</div>
</div>
<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">使用</h2>
<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1">配置</h3>
<div id="text-3-1" class="outline-text-3">
<pre class="prettyprint">
;; org2blog
;;

(require 'org2blog-autoloads)
(setq org2blog/wp-blog-alist
      `(("abc"
         :url "http://abc.com/xmlrpc.php"
         :username "admin"
         :password PWD
         :keep-new-lines t
         :confirm t
         :wp-code nil
         :tags-as-categories nil)
        ))

(setq org2blog/wp-buffer-template
  "#+DATE: %s
#+OPTIONS: toc:nil num:nil todo:nil pri:nil tags:nil ^:nil TeX:nil 
#+CATEGORY: Heart
#+TAGS: 
#+PERMALINK: 
#+TITLE:
\n")</pre>
我不使用 wordpress 的 code 格式，所以设置了 wp-code 为 nil。可以定义多个 blog。

</div>
</div>
<div id="outline-container-3-2" class="outline-3">
<h3 id="sec-3-2">登陆，发帖</h3>
<div id="text-3-2" class="outline-text-3">

M-x org2blog/wp-login 会提示你要登陆哪个 blog
M-x org2blog/wp-new-entry 会使用设置的 template 打开一个 buffer
M-x org2blog/wp-post-buffer 保存成 draft
M-x org2blog/wp-post-buffer-and-publish 真实发布

另外，还可以发布一个 tree 而不是整个 org 文件，以及一些其他的操作就不多说了。

发布源代码可以使用 BEGIN_SRC END_SRC 块，或者冒号开头的行会被当作源代码。

我使用的是 wp-syntax，所以发布源代码使用 BEGIN_HTML 在里面使用 pre 标签
<pre class="prettyprint">
&lt;pre lang="lisp"&gt;
(setq a 1)
&lt;/pre&gt;
#+END_HTML</pre>
</div>
</div>
<div id="outline-container-3-3" class="outline-3">
<h3 id="sec-3-3">其他</h3>
<div id="text-3-3" class="outline-text-3">

使用 org2blog 只能从 org 发布到 wordpress，不能从 wordpress 回到 org 文件再进行编辑，不过我看到有人已经提供了一个解决方
法，或许将来也会支持这个功能。

使用 org2blog 发布很讨厌的一点是，他会把你的 org 加上很多的 html 代码，再编辑的时候比较讨厌。

org2blog 在 github 的页面 <a href="https://github.com/punchagan/org2blog" target="_blank" rel="external">https://github.com/punchagan/org2blog</a> 上面有不少有用的东西，建议看看。

</div>
</div>
</div>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/about-org2blog/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="intro-openresty/">介绍下 openresty</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-10-22T16:00:00.000Z" itemprop="datePublished">Oct 23, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/web/">web</a> <a href="/tags/linux/">linux</a> <a href="/tags/javascript/">javascript</a> <a href="/tags/openresty/">openresty</a>
</div>
    </div>
      
        一直没有时间使用 ngx_lua，上周算是真正使用了下，总结下，也算是帮忙推广下 openresty。
<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">什么是 openresty</h2>
<div id="text-1" class="outline-text-2">

openresty 的主力作者是 <a href="http://weibo.com/agentzh" target="_blank" rel="external">@agentzh</a> 它的网页在 <a href="http://openresty.org" target="_blank" rel="external">这里</a>，上面有介绍。按我的理解，他是介于客户端浏览器 js 和数据库之间的一层。

在 ajex 还没有盛行的时代，数据库的数据需要展现在浏览器的时候，一般都是使用 php/jsp 之类读取数据，然后拼表格/图表这些。在客户端机器越来越牛逼之后，把部分运算放在浏览器里面开始盛行，ajex 也越来越流行。这个时候通常还需要有个服务器端的程序来配合从数据库获取并提供数据，应该也有不少类似的程序来提供这个数据。

老版本的 openresty 是基于 perl 做的，可以上 cpan 上面 <a href="http://search.cpan.org/~agent/OpenResty-0.5.12/lib/OpenResty/Spec/REST_cn.pod" target="_blank" rel="external">搜到</a> (不知道为啥这页面我打不开了)。agentzh 还专门为他写了一个 admin site，纯 js + oprensty 来实现的，可以直接在上面配置接口，很方便。目前老版本应该没人用了。

新版本的 openresty 基本上等于是 nginx 和一些 nginx 模块的集合，大部分模块都是 agentzh 和 <a href="https://github.com/chaoslawful" target="_blank" rel="external">chaoslawful</a> 完成的，目前 agentzh 离职在家全职开发 openresty 相关，chaoslawful 还在淘宝 <a href="http://linezing.com" target="_blank" rel="external">量子统计</a> 。

这大概就是我了解的 openresty 的起源和目前的情况。写的比较简单，里面的曲折就不多说了，可以找上面提到的大牛聊天。

</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">怎么使用 openresty</h2>
<div id="text-2" class="outline-text-2">

我下面用一个简单的例子来描述下，我是怎么使用 openresty 的，从中应该能看出来 openresty 能干啥，怎么用。

</div>
<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1">需求</h3>
<div id="text-2-1" class="outline-text-3">

在 postgresql 数据库有张网站日访问流量表，包含两个字段 thedate 和 pv。需要把里面的数据展现出来，画出来流量曲线。

<dl><dt>注意</dt><dd>下面的代码大都从现有程序里面扒出来的，所以不一定直接就能用，只是个示意而已。</dd></dl></div>
</div>
<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2">安装 openresty</h3>
<div id="text-2-2" class="outline-text-3">

首先需要安装 openresty。从 <a href="http://openresty.org" target="_blank" rel="external">openresty.org</a> 下载当前的 stable 版本 ngx_openresty-1.0.6.22.tar.gz。
<pre class="prettyprint lang-bash">
$ cd ngx_openresty-1.0.6.22
$ ./configure --with-http_drizzle_module --with-http_postgres_module --with-pg_config=/opt/pg90/bin/pg_config --prefix=/usr/local/openresty --with-libdrizzle=/usr/local/libdrizzle/ --with-luajit --with-http_iconv_module # 这是我用到的参数，按照需要加减
$ make
# make install</pre>
configure 的时候 postgres_module 是必须的，其他的 drizzle_module 是用来支持从 mysql 获取数据的，iconv_module 是用来做编码转换的，luajit 据说可以提升不少性能。

不出问题的话，在 /usr/local/openresty 目录下面就安装好了。其实更合理的方式应该是提供一个 rpm 或者 deb 包的。

</div>
</div>
<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3">启动 nginx</h3>
<div id="text-2-3" class="outline-text-3">

openresty 给提供了简单可用的 nginx.conf，所以现在可以先尝试启动下 /usr/local/openresty/nginx/sbin/nginx 了，如果启动没问题，那就 ok 了。

配置文件在 /usr/local/openresty/nginx/conf/nginx.conf。

</div>
</div>
<div id="outline-container-2-4" class="outline-3">
<h3 id="sec-2-4">配置 nginx</h3>
<div id="text-2-4" class="outline-text-3">

主要就是配置 /usr/local/openresty/nginx/conf/nginx.conf，以后很多事情都会在这里面来完成，说是 nginx.conf 编程也不为过，呵呵。

增加下面的配置
<pre class="prettyprint lang-conf">

    upstream pgsql {
        postgres_server server_ip:5432 dbname=test password=123 user=test;
        #postgres_keepalive  max=2 mode=single overflow=reject;
        postgres_keepalive off;
    }

# server 里面增加一个 location

       location /=/pv {
            postgres_query 'select thedate, pv from pv';
            postgres_pass pgsql;

            rds_json on;
            rds_json_format compact;

            xss_get on;
            xss_callback_arg '_c';
        }</pre>
<ol>
	<li>其中关于 upstream postgres 用来定义需要连接的数据库信息，和发送 sql 到数据库，可以参考 <a href="https://github.com/FRiCKLE/ngx_postgres/" target="_blank" rel="external">这里</a>。</li>
	<li>rds_json 用来将数据库的输出变成 json 格式，可以参考 <a href="https://github.com/agentzh/rds-json-nginx-module" target="_blank" rel="external">这里</a> 。</li>
	<li>xss_get 用来支持跨域，jquery 默认使用的 callback 参数是 _c，可以参考 <a href="https://github.com/agentzh/xss-nginx-module" target="_blank" rel="external">这里</a>。</li>
</ol>
这样配置好之后，重启下。结果应该很清晰了，请求 <a href="http://your_ip/=/pv" target="_blank" rel="external">http://your\_ip/=/pv</a> 应该就可以得到数据库里面的数据了，可以使用 curl 看看结果，应该类似下面的
<pre class="prettyprint lang-json">
</pre></div>
</div>
<div id="outline-container-2-5" class="outline-3">
<h3 id="sec-2-5">js 画图</h3>
<div id="text-2-5" class="outline-text-3">

挑一个画图程序，比如我用过的 <a href="http://highcharts.com" target="_blank" rel="external">highcharts</a>, <a href="http://www.amcharts.com/" target="_blank" rel="external">amcharts</a> 这些都不错，amcharts 是使用 flash 画图，兼容各种浏览器，highcharts 号称也支持，不过我弄出来的图在 chrome/firefox 下面没问题，ie 不支持，他用的是 svg 标签。

就写几行代码来示意下吧
<pre class="prettyprint lang-javascript">
    $.ajax({
        url : 'http://your_ip/=/pv',
        success: function (data) {
            renderPvCharts(data);
        }
    });

    function renderPvCharts(data) {
        $('body').append('</pre>
<pre class="prettyprint lang-javascript">
        var result = Utils.getSplineChartSeries( data ); # 将 nginx 返回的 json 格式数据转化为 highcharts 需要的格式
        var options = {
			chart: {
                zoomType: 'xy',
				renderTo: 'pv', # div 的 id
				defaultSeriesType: 'spline'
			},
			title: {
                text: '每日 pv'
            },
			xAxis: {
                type: 'datetime'
			},
			tooltip: {
				formatter: function() {
			        return '<strong>'+ this.series.name +'</strong>
'+
						Highcharts.dateFormat('%e. %b', this.x) +': '+ this.y;
				}
			},
			legend: {
				layout: 'vertical',
				align: 'right',
				verticalAlign: 'top',
				x: -10,
				y: 100,
				borderWidth: 0
			},
            series : result.y
        };

        var chart = new Highcharts.Chart( options );
    };

} );</pre>
简单解释下
<ol>
	<li>在页面 readay 的时候，使用 ajex 设置回调函数并请求接口。</li>
	<li>回调函数里面使用 Utils.getSplineChartSeries 转换一下数据，方便直接给 options 里面数据赋值，具体需要的数据格式，看 highcharts 的 spline 的 demo 就可以。</li>
	<li>回调函数里面显示图表。</li>
</ol>
这样就完事了，数据就展现出来了。

</div>
</div>
<div id="outline-container-2-6" class="outline-3">
<h3 id="sec-2-6">其他</h3>
<div id="text-2-6" class="outline-text-3">

从上面可以看到整个数据流是怎么回事。openresty 可以做的事情远比上面描述的复杂，上面只是个最简单的应用了。
<ol>
	<li>比如使用 <a href="https://github.com/agentzh/rds-csv-nginx-module" target="_blank" rel="external">rds_csv</a> 来直接得到 csv 格式的数据提供给用户，而不是 json。</li>
	<li>可以使用 <a href="https://github.com/chaoslawful/lua-nginx-module" target="_blank" rel="external">ngx_lua</a> 在 nginx.conf 里面使用 lua 来在服务器端对数据做一些处理再丢给浏览器。
大家都知道 js 处理的数据太大的时候，会导致浏览器卡死，所以如果不方便通过 sql 控制输出的时候，可以使用 lua 来处理下。当然 这只是其中一个应用，使用 ngx_lua 你可以干很多事情，比如上面那个使用 js 来生成 spline 数据的函数就可以用 lua 来实现，lua 还可以和 c 结合来做一些事情。对于 location 的参数，在 ngx_lua 里面也是可以访问的，比如 ngx.var.arg_c 这样。具体还是看 wiki 吧，写不完的。
<ol>
	<li>openresty 还能直接访问 redis 和 memcached。</li>
</ol>
本篇只能算是一个入门而已，openresty 在淘宝量子统计的应用非常广泛。另外在 <a href="http://qunar.com" target="_blank" rel="external">去哪网</a> 也有不少应用，比如我知道的安全过滤模块，和一些数据报表，都是基于 openresty 的。

附一个 highcarts 画的图

<img class="alignnone" title="流量情况" src="http://wdicc.com/images/2011-10-24-171245_1100x312_scrot.png" alt="" width="1100" height="312"></li>
</ol>
</div>
</div>
</div>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/intro-openresty/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="generate_series-function-in-postgresql/">postgresql 里面的 generate_series</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2011-10-13T16:00:00.000Z" itemprop="datePublished">Oct 14, 2011</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/linux/">linux</a> <a href="/tags/postgresql/">postgresql</a>
</div>
    </div>
      
        
<p>有个报表需要把几天的记录按照小时 join 起来，最开始的作法是通过 js 来 join 数据。后来遇到了问题，就是某天某个小时可能会没有记录，然后想破头了，在 js 里面循环的时候设置每天循环到的当前的小时。可崩溃的是还会出现有的是这两小时没有，有的是另外的，用 js 搞不定了，就尝试用 sql 搞定。
</p>
<p>
sql 开始的方法是简单的使用 full join。然后发现没法保证主表在所有的小时都有记录。后来就发现了这个 generate_series 函数，发现很有意思。地址在这里 <a href="http://www.postgresql.org/docs/9.0/static/functions-srf.html" target="_blank" rel="external">http://www.postgresql.org/docs/9.0/static/functions-srf.html</a> 。这里还有个 generate_scripts 的函数，可以用来遍历数组产生一个表格的。
</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/generate_series-function-in-postgresql/#disqus_thread">Comments</a></span>
	
</div>
</article>


  <nav id="pagenavi">
    
        <a href="/page/4/" class="prev">Prev</a>
    
    
        <a href="/page/6/" class="next">Next</a>
    
  <div class="center"><a href="/archives/index.html">Blog Archives</a></div>
  </nav>


    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2017

    wd
. Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> |
    Theme is <a href="https://github.com/wd/hexo-fabric">hexo-fabric</a>, fork from <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
