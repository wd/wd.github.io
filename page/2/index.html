<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>wd and cc</title>
    <meta name="author" content="wd">
    
	<meta name="description" content="undefined"> <!-- TODO: truncate -->
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="wd and cc" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='//fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    

</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        wd and cc
    </div>
</h1>
<span class="subtitle">happy everyday</span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/wd" class="github" title="Github"></a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/wd" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload -->
    <div id="content" class="inner">
        

    
        <script id="dsq-count-scr" src="//wdicc.disqus.com/count.js" async></script>
    



  <article class="post">
	<h2 class="title">
		<a href="lua-metatable/">lua metatable</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-03-27T02:48:26.000Z" itemprop="datePublished">Mar 27, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/lua/">lua</a>
</div>
    </div>
      
        <figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">t = <span class="built_in">setmetatable</span>(&#123; bar = <span class="number">4</span>, foo = <span class="number">7</span> &#125;, &#123; __index = &#123; foo = <span class="number">3</span> &#125; &#125;)</div><div class="line"></div><div class="line"><span class="built_in">print</span>(t.foo)  <span class="comment">-- 7</span></div><div class="line"><span class="built_in">print</span>(t.bar)  <span class="comment">-- 4</span></div><div class="line"></div><div class="line">t = <span class="built_in">setmetatable</span>(&#123;  &#125;, &#123; __index = &#123; foo = <span class="number">3</span>&#125; &#125;)</div><div class="line"></div><div class="line"><span class="built_in">print</span>(t.foo)  <span class="comment">-- 3</span></div><div class="line"><span class="built_in">print</span>(t.bar)  <span class="comment">-- nil</span></div><div class="line"></div><div class="line">fuc = <span class="function"><span class="keyword">function</span> <span class="params">(t,k)</span></span></div><div class="line">    <span class="keyword">if</span> k == <span class="string">'foo'</span> <span class="keyword">then</span></div><div class="line">        <span class="keyword">return</span> <span class="built_in">rawget</span>(t, <span class="string">'bar'</span>)</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">t = <span class="built_in">setmetatable</span>(&#123;   &#125;, &#123; __index = fuc &#125;)</div><div class="line"></div><div class="line"><span class="built_in">print</span>(t.foo)  <span class="comment">-- 3</span></div><div class="line"><span class="built_in">print</span>(t.bar)  <span class="comment">-- nil</span></div><div class="line"><span class="built_in">print</span>(t.ff)</div></pre></td></tr></table></figure>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/lua-metatable/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="Across-the-Great-Wall-we-can-reach-every-corner-in-the-world/">Across the Great Wall, we can reach every corner in the world</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-03-20T12:39:53.000Z" itemprop="datePublished">Mar 20, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/gfw/">gfw</a>
</div>
    </div>
      
        <p>科学上网估计是每个搞 IT 的人必须要掌握的知识了。简单讲讲我目前使用的一些方法。</p>
<h2 id="国外服务"><a href="#国外服务" class="headerlink" title="国外服务"></a>国外服务</h2><p>首先肯定需要先有个国外的资源，比如买专业的 vpn ss 服务等。数据经过第三方都不一定那么可靠，我的主力邮箱在 gmail，可不想被攻破，所以我选择了自己购买和搭建服务。</p>
<p>我买的是 linode 的服务，最便宜的是 10$ 一个月。也可以买一些美国的 kvm 或者 zen 的虚拟机，有比较便宜的一个月可能才不到 1$，当然这种便宜的一般很快就会卖没，得看运气。我的 linode 是和 3 个基友一起合租的，这样大家每个人一年也就 300 来块钱，也就一顿海底捞（我这两年非常喜欢用饭钱来衡量消费，吃饭可是天天都有的，但是有些消费，比如买软件，买服务这些一般都是一年或者几年才一次，比起吃饭真的便宜多了），一般都能承担的吧。</p>
<p>早期我买过一些 ssh 服务，速度不稳定，因为很难限制超售。后来还买过云梯，他们提供的节点比较多速度还不错。</p>
<p>有了 vps 搭一个 ssserver 就是很简单的了，就不多说了。服务器上面我还配置了 ocserv 这个支持 cisco 客户端的 vpn 服务。当然并不是所有 vps 都支持，有的 vps 没有 tun 设备，跑不起来，买的时候要注意。</p>
<h2 id="ssh-方式"><a href="#ssh-方式" class="headerlink" title="ssh 方式"></a>ssh 方式</h2><p>使用 ssh 方式的时候，最早是直接 ssh 链接弄一个 socks 端口给本地，然后本地使用 pac 配合。</p>
<p>后来有段时间被断的不行，就试了 stunnel，可以把 ssh 转为 https 服务，这样就可以跑在 443 端口了，和其他 https 服务比较难区分。可以起点作用。</p>
<p>这个方式没法支持手机。</p>
<h2 id="使用-ngx"><a href="#使用-ngx" class="headerlink" title="使用 ngx"></a>使用 ngx</h2><p>有段时间还使用 hosts 文件加 ngx 反向代理还翻墙。ngx 上面配置 google.com 和 twitter.com 的反向代理，然后手机或者电脑上面配置 hosts 指向 ngx。就可以实现翻墙了。不过因为都是 https 的网站，所以服务器上面得配置 https 的服务，证书得弄到电脑或者手机上面信任才行。</p>
<p>这个手机想要支持的话，ios 比较麻烦，必须得越狱。</p>
<h2 id="vpn-方式"><a href="#vpn-方式" class="headerlink" title="vpn 方式"></a>vpn 方式</h2><p>早期用 vpn 方式的时候，pptp 可以搭配 <a href="https://github.com/fivesheep/chnroutes" target="_blank" rel="external">chnrouts</a> 来实现国外和国内走不同的路由。用起来也不错，不过问题是全局的有时候切换也不方便，并且有时候还需要连公司的 vpn 路由一乱就麻烦了。</p>
<p>pc 上面选择比较多。手机上面，试过 anyconnect，缺点就是全局翻墙（我试过让 server 只 push fb twitter 的路由，但是维护麻烦，效果也不好）。anyconnect 比较赞的地方是他的链接 cookie 可以设置比较长的有效期，这样网络切换什么的临时断开之后自动重连也不需要输入密码。哦，当然，我的 anyconnect 和后面提到的 openvpn 都是通过自己签的证书来认证的，也不需要输入密码。</p>
<p>后来用过 openvpn，openvpn 是基友维护的。他的思路很赞。</p>
<p>他买了一台 server 放家里，家里是联通 adsl 24h 联机，然后 server 上面跑一个 openvpn 的服务器端给手机连接用，服务器上面再通过 vpn 和 vps 的 vpn 链接，同时这机器配置只有国外路由才走 vps，国内都是直接链接。大概链路就是  手机 -&gt; 家里的 server -&gt; vps。如果是国内的网站，就直接通过家里的 server 访问了，比国外的 vps 访问速度快。</p>
<p>这个方法还有好处是有时候一些公开的场合链接一些 wifi 的时候，很不安全，而通过 vpn 之后，数据都是加密的，就安全多了。我在 surge 之前，在 hosts 不能用之后，基本都是用这个和 anyconnect。</p>
<h2 id="使用-ss"><a href="#使用-ss" class="headerlink" title="使用 ss"></a>使用 ss</h2><p>开始使用 ss 的时候，是使用 goagentx （貌似已经比较难找到下载了）的，这个工具异常好用，支持切换全局还是使用 pac 非常方便。pac 推荐使用 <a href="https://github.com/JinnLynn/genpac" target="_blank" rel="external">genpac</a> 来维护 pac，放到 dropbox 里面就可以四处用了。</p>
<p>我有相当长一段时间都是这么翻墙的。直到后面 ios 9 放开网络权限之后，出来了 surge。surge 现在卖的太贵了，不建议购买，最近好像看到有一些新的软件也在出现，可以考虑。</p>
<p>surge 出来之后，ios 基本就是用这个了。</p>
<p>surge 也有 mac 版本。如果没有，使用 ss mac 版本也可以，搭配 pac 可以做到透明。</p>
<h2 id="应对不稳定的网络情况"><a href="#应对不稳定的网络情况" class="headerlink" title="应对不稳定的网络情况"></a>应对不稳定的网络情况</h2><p>家里是联通 adsl，链接我的 linode 一直都比较稳定，速度不错也没有丢包。公司访问 linode 有时候丢包比较严重，不过也将就用了。去年去长沙出差，那边完全访问不能把我搞的很痛苦。回来就开始琢磨怎么搞。</p>
<p>上面基友的思路提醒了我，就是自己家里一台 server 建长链接，然后在外面翻墙先连家里。但是家里的路由器完全不能定制，后来发现我的群晖的 nas 可以装 haproxy，就搞定这个事情了。在路由器上面映射一个端口给群晖，群晖上面跑 haproxy 转发到 linode。给路由器弄了个 ddns，在外面翻墙都连接这个 dns。</p>
<p>群晖上面跑 haproxy 还不影响硬盘休眠，还挺不错。这样就彻底解决了我翻墙的问题了。</p>
<p>但是遇到家里停电断网就虾米了。。</p>
<h2 id="家里的全局翻墙方案"><a href="#家里的全局翻墙方案" class="headerlink" title="家里的全局翻墙方案"></a>家里的全局翻墙方案</h2><p>前段时间换了 Netgear R6300v2，才发现我之前错过了好多好玩的东西。刷了个国内论坛定制的梅林 rom，自带了 ss 客户端，并且配置的非常完美，支持多种翻墙策略，具体就不细说了。就说现在的效果吧。</p>
<p>直接映射了端口到 linode 的 ss，并且也支持 ddns（我用的 3322 的），这样 nas 上面的 haproxy 就彻底可以不用了。</p>
<p>路由器跑了 ss 客户端，加 redsocks2 和 dns2proxy，实现了国内网站直连，国外根据域名匹配到列表里面的服务器通过 ss 链接。这样家里所有的终端，不需要跑任何服务，就可以无缝翻墙了。我的 ps4，apple tv，ipad 上面的 yotube 都可以访问了。然后还支持黑名单，我把 nas 加进去了，防止使用 bt 下载的时候跑到国外流量。</p>
<p>这样我目前手机和 mac 都是直接通过 surge，国外流量通过 3322 的 dns 先链接到路由器，然后转发到 linode 实现翻墙。</p>
<h2 id="目前唯一的问题"><a href="#目前唯一的问题" class="headerlink" title="目前唯一的问题"></a>目前唯一的问题</h2><p>mac 版本的 surge，还不能自己配置网络，这样临时想关掉代理的时候，就比较麻烦，得去网络配置里面关。也不能很简单的配置让全部流量走 proxy，有时候需要测试下什么的，就比较麻烦。所以我现在有时候还会使用 goagentx 辅助一下。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/Across-the-Great-Wall-we-can-reach-every-corner-in-the-world/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="setup-proxy-for-emacs/">setup proxy for emacs</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-02-27T13:55:20.000Z" itemprop="datePublished">Feb 27, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/emacs/">emacs</a> <a href="../tags/osx/">osx</a>
</div>
    </div>
      
        <p>我在 mac 上面使用 emacs 都是使用 daemon + emacsclient 模式。使用 <code>paradox</code> 包管理(其实就是比 <code>list-package</code> 稍微多了一点功能’)，但是因为那些包什么的信息都在国外的网站，还有 github 什么的，导致速度巨慢甚至连不上，关键 emacs 单线程还得卡着别的操作，所以挺讨厌的(其实 paradox 提供了异步更新的方式，不会阻塞现在进程，但是有时候会不知道进度…)。</p>
<p>思路就是使用 <code>proxychains</code>。</p>
<p>新建一个 <code>/Library/LaunchAgents/gnu.emacs.daemon.plist</code> 文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="meta">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"</span></div><div class="line">    "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</div><div class="line"> <span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">dict</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>Label<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>gnu.emacs.daemon<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>ProgramArguments<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">array</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>/usr/local/bin/proxychains4<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>-f<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>/Users/wd/.proxychains/proxychains.conf<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>/usr/local/opt/emacs-mac/bin/emacs<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>--daemon<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">key</span>&gt;</span>RunAtLoad<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">true</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">key</span>&gt;</span>ServiceDescription<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">string</span>&gt;</span>Gnu Emacs Daemon<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">key</span>&gt;</span>UserName<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">string</span>&gt;</span>wd<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></div></pre></td></tr></table></figure>
<p>其中 <code>/Users/wd/.proxychains/proxychains.conf</code> 文件的内容如下</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">strict_chain</div><div class="line">proxy_dns</div><div class="line">remote_dns_subnet <span class="number">224</span></div><div class="line">tcp_read_time_out <span class="number">15000</span></div><div class="line">tcp_connect_time_out <span class="number">8000</span></div><div class="line">localnet <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.0</span><span class="number">.0</span><span class="number">.0</span></div><div class="line">localnet <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.0</span><span class="number">.0</span><span class="number">.0</span></div><div class="line">localnet <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.240</span><span class="number">.0</span><span class="number">.0</span></div><div class="line">localnet <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span></div><div class="line">quiet_mode</div><div class="line"></div><div class="line">[ProxyList]</div><div class="line">#socks5 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">1080</span></div><div class="line">http <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">6152</span></div></pre></td></tr></table></figure>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/setup-proxy-for-emacs/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="use-gearman-to-distribute-you-nagios-check/">use gearman to distribute you nagios check</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-01-18T07:14:36.000Z" itemprop="datePublished">Jan 18, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/nagios/">nagios</a> <a href="../tags/gearman/">gearman</a>
</div>
    </div>
      
        <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="gearman"><a href="#gearman" class="headerlink" title="gearman"></a>gearman</h2><p>需要 boost &gt; 1.39, libevent-devel, libuuid-devel, gperf<br>需要 gcc &gt;= 4.2</p>
<p>export CC=gcc44<br>export CC=g++44</p>
<h2 id="mod-gearman"><a href="#mod-gearman" class="headerlink" title="mod-gearman"></a>mod-gearman</h2><p>libtool-ltdl-devel ncurses-devel<br>–with-gearman</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>gearman 分为几个模块</p>
<ul>
<li>mod_gearman: 负责把 nagios 中的检查任务发给 gearmand job server</li>
<li>gearmand: 负责接收任务，分配给 worker 执行。这个是个通用的队列管理服务。</li>
<li>gearman_workder: 负责消费 gearmand 中的 job。</li>
</ul>
<p>其中 <code>mod_gearman</code> 的代码里面包括了上面提到的 mod_gearman 和 gearman_workder。</p>
<p>所以规划好 gearmand 启动的机器，以及你的 worker 机器。其中要注意 worker 机器上面是会执行所有[1] nagios 监控</p>
<p>需要配置的文件有几个</p>
<ul>
<li>nagios.cfg 增加 broker</li>
<li>mod-gearman/etc/mod_gearman/mod_gearman_neb.conf broker 的配置文件</li>
<li>mod-gearman/etc/mod_gearman/mod_gearman_worker.conf workder 的配置文件</li>
</ul>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><ul>
<li>先启动 gearmand 使用 mod-gearman/etc/init.d/gearmand 这个脚本。</li>
<li>启动 worker 使用 mod-gearman/etc/init.d/mod_gearman_worker 这个脚本。启动之后可以用 gearman_top 看到多了一些队列。</li>
<li>重启 nagios</li>
</ul>
<p>确认 nagios.log 里面正常加载了 gearman，然后看 gearman_top 里面开始有一些 run 的 job 了。</p>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><p>基本上使用 gearman 还算是对用户透明，需要配置的东西不多，默认配置就可以跑。</p>
<p>一般使用 gearman 的时候都是现有 nagios 遇到瓶颈了，这个时候扩展的时候需要注意下，第一步可以在 nagios 机器上面（或者弄一台新的机器）做 gearman 的 job server，然后在 nagios 的机器上面跑一个 worker，这样基本就是 0 配置都可以跑起来，不会有任何问题。</p>
<p>第一步完成之后就会需要增加 worker，这个时候就要注意了，新的 worker 机器上面，需要在相同的路径下面包括所有你用到的 nagios plugin（包括自己写的，也包括这些 plugin 依赖的其他内容，比如临时文件路径，配置文件等），否则分发过来的 job 会执行不成功。</p>
<p>这个时候有个办法，就是把原来机器的 nagios 相关目录通过 nfs 共享给其他机器（但是得注意二进制程序是兼容的）。</p>
<p>另外如果需要测试一下新的 worker，也可以通过配置只让 worker 执行某些 servicegroup 或者 hostgroup 的任务。要注意这个时候需要配置 service, eventhandler, host 都为 no，然后配置 servicegroups 或者 hostgroups。</p>
<h1 id="Footnotes"><a href="#Footnotes" class="headerlink" title="Footnotes"></a>Footnotes</h1><p>[1] 其实 worker 是可以被配置为只处理某些监控的，这个后面会讲。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/use-gearman-to-distribute-you-nagios-check/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="use-ivy-to-replace-isearch/">use ivy to replace isearch</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-01-10T11:22:20.000Z" itemprop="datePublished">Jan 10, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/emacs/">emacs</a>
</div>
    </div>
      
        <p>之前习惯使用 <code>isearch</code> 来搜索了，最近看别人使用 <code>ivy</code> 看着心痒痒的，就想试试看。其实 ivy 的效果和 <code>swoop</code> 很像，不过区别是 ivy 是在 minibuffer 来显示可选信息的，swoop 是在一个 buffer 显示的。有洁癖的可能稍微计较一下。</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">;; ivy swiper</span></div><div class="line">(<span class="name">defun</span> wd-swiper-at-point ()</div><div class="line">  <span class="string">"Pull next word from buffer into search string."</span></div><div class="line">  (<span class="name">interactive</span>)</div><div class="line">  (<span class="name"><span class="builtin-name">let</span></span> (<span class="name">query</span>)</div><div class="line">    (<span class="name">with-ivy-window</span></div><div class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">tmp</span> (<span class="name">symbol-at-point</span>)))</div><div class="line">        (<span class="name">setq</span> query tmp)))</div><div class="line">    (<span class="name"><span class="builtin-name">when</span></span> query</div><div class="line">      (<span class="name">insert</span> (<span class="name">format</span> <span class="string">"%s"</span> query))</div><div class="line">      )))</div><div class="line"></div><div class="line">(<span class="name">use-package</span> ivy</div><div class="line">  :config</div><div class="line">  (<span class="name">ivy-mode</span> <span class="number">1</span>)</div><div class="line">  (<span class="name">setq</span> ivy-use-virtual-buffers t)</div><div class="line">  (<span class="name">set-variable</span> <span class="symbol">'ivy-on-del-error-function</span> '(lambda()))</div><div class="line">  )</div><div class="line"></div><div class="line">(<span class="name">use-package</span> swiper</div><div class="line">  :config</div><div class="line">  (<span class="name">global-set-key</span> <span class="string">"\C-s"</span> <span class="symbol">'swiper</span>)</div><div class="line">  (<span class="name">define-key</span> swiper-map (<span class="name">kbd</span> <span class="string">"C-w"</span>) <span class="symbol">'wd-swiper-at-point</span>)</div><div class="line">  (<span class="name">define-key</span> swiper-map (<span class="name">kbd</span> <span class="string">"C-f"</span>) <span class="symbol">'swiper-avy</span>)</div><div class="line">  )</div></pre></td></tr></table></figure>
<p>我大致做了上面几个设定，<code>\C-s</code> 绑定了 swiper，启动 swiper 之后用 <code>\C-w</code> 可以快速把光标位置的 symbol 放到 minibuffer 来搜索。然后 swiper 和 isearch 有个区别是，默认情况下，swiper 如果 minibuffer 没有内容，按 backspace 会退出，这个和 isearch 的习惯不一样，把 <code>ivy-on-del-error-function</code> 重新绑定一下就可以了。</p>
<p>ivy 默认会绑定一个快捷键是在你 minibuffer 输入一些内容之后，会出来很多匹配结果，这个时候可以按 <code>C-&#39;</code> 调用 <code>swiper-avy</code> 方便你快速定位，也挺好用的。不过我这里不好用，不知道怎么回事，只好重新绑定了一下。</p>
<p>还可以在 swiper 查询阶段按 <code>M-q</code> 进入替换模式。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/use-ivy-to-replace-isearch/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="libmcrypt-ffi-module/">基于 ffi 的 libmcrypt 加密模块</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2015-07-05T12:55:11.000Z" itemprop="datePublished">Jul 5, 2015</time>
</div>
      <div class="tags">Tags: 


</div>
    </div>
      
        <p>openresty 提供了 luajit 的支持，luajit 又提供了 ffi 库的支持。通过 ffi 可以很方便的调用 c 库的一些方法。</p>
<p>我在项目里面用到了加解密，因为需要各语言支持，使用了 libmcrypt 库。之前通过 c 模块完成了在 lua 里面加密，在 perl 里面解密。有了 ffi 就可以使用纯 lua 模块搞定了。</p>
<p>代码写的比较丑，有使用加解密的需求的可以参考下，另外计划写其他模块的也可以参考下。如下</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> ffi = <span class="built_in">require</span> <span class="string">'ffi'</span></div><div class="line"><span class="keyword">local</span> ffi_new = ffi.new</div><div class="line"><span class="keyword">local</span> ffi_str = ffi.<span class="built_in">string</span></div><div class="line"><span class="keyword">local</span> ffi_copy = ffi.copy</div><div class="line"><span class="keyword">local</span> <span class="built_in">setmetatable</span> = <span class="built_in">setmetatable</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> _M = &#123; &#125;</div><div class="line"><span class="keyword">local</span> mt = &#123; __index = _M &#125;</div><div class="line"></div><div class="line">ffi.cdef<span class="string">[[</span></div><div class="line">struct CRYPT_STREAM;</div><div class="line">typedef struct CRYPT_STREAM *MCRYPT;</div><div class="line"></div><div class="line">MCRYPT mcrypt_module_open(char *algorithm,</div><div class="line">                          char *a_directory, char *mode,</div><div class="line">                          char *m_directory);</div><div class="line"></div><div class="line">int mcrypt_generic_init(const MCRYPT td, void *key, int lenofkey,</div><div class="line">                        void *IV);</div><div class="line"></div><div class="line">int mcrypt_generic_deinit(const MCRYPT td);</div><div class="line">int mcrypt_generic_end(const MCRYPT td);</div><div class="line">int mdecrypt_generic(MCRYPT td, void *plaintext, int len);</div><div class="line">int mcrypt_generic(MCRYPT td, void *plaintext, int len);</div><div class="line">int mcrypt_module_close(MCRYPT td);</div><div class="line"></div><div class="line">]]</div><div class="line"></div><div class="line"><span class="keyword">local</span> mcrypt = ffi.<span class="built_in">load</span>(<span class="string">'libmcrypt.so.4'</span>)</div><div class="line"></div><div class="line">_M.new = <span class="function"><span class="keyword">function</span> <span class="params">(self)</span></span></div><div class="line">    <span class="keyword">local</span> cipher = <span class="string">'blowfish'</span></div><div class="line">    <span class="keyword">local</span> mode = <span class="string">'cbc'</span></div><div class="line"></div><div class="line">    <span class="keyword">local</span> c_cipher = ffi_new(<span class="string">"char[9]"</span>, cipher)</div><div class="line">    <span class="keyword">local</span> c_mode = ffi_new(<span class="string">"char[4]"</span>, mode)</div><div class="line"></div><div class="line">    <span class="keyword">local</span> td = mcrypt.mcrypt_module_open(c_cipher, <span class="keyword">nil</span>, c_mode, <span class="keyword">nil</span>)</div><div class="line">    <span class="keyword">return</span> <span class="built_in">setmetatable</span>( &#123; _td = td &#125;, mt )</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">_M.encrypt = <span class="function"><span class="keyword">function</span><span class="params">(self, key, raw)</span></span></div><div class="line">    <span class="keyword">local</span> iv_len = <span class="number">8</span></div><div class="line">    <span class="keyword">local</span> td = self._td</div><div class="line"></div><div class="line">    <span class="keyword">local</span> c_key = ffi_new(<span class="string">"char[?]"</span>, #key+<span class="number">1</span>, key)</div><div class="line">    <span class="keyword">local</span> c_iv = ffi_new(<span class="string">"char[9]"</span>, key)</div><div class="line">    <span class="keyword">local</span> c_raw = ffi_new(<span class="string">"char[?]"</span>, #raw+<span class="number">1</span>, raw)</div><div class="line"></div><div class="line">    mcrypt.mcrypt_generic_init(td, c_key, #key, c_iv)</div><div class="line">    mcrypt.mcrypt_generic(td, c_raw, #raw )</div><div class="line">    mcrypt.mcrypt_generic_deinit(td)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ffi_str(c_raw, ffi.sizeof(c_raw)<span class="number">-1</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">_M.decrypt = <span class="function"><span class="keyword">function</span><span class="params">(self, key, raw)</span></span></div><div class="line">    <span class="keyword">local</span> iv_len = <span class="number">8</span></div><div class="line">    <span class="keyword">local</span> td = self._td</div><div class="line"></div><div class="line">    <span class="keyword">local</span> c_key = ffi_new(<span class="string">"char[?]"</span>, #key+<span class="number">1</span>, key)</div><div class="line">    <span class="keyword">local</span> c_iv = ffi_new(<span class="string">"char[9]"</span>, key)</div><div class="line">    <span class="keyword">local</span> c_raw = ffi_new(<span class="string">"char[?]"</span>, #raw+<span class="number">1</span>, raw)</div><div class="line"></div><div class="line">    mcrypt.mcrypt_generic_init(td, c_key, #key, c_iv)</div><div class="line">    mcrypt.mdecrypt_generic(td, c_raw, #raw )</div><div class="line">    mcrypt.mcrypt_generic_deinit(td)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ffi_str(c_raw, ffi.sizeof(c_raw)<span class="number">-1</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">_M.close = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></div><div class="line">    <span class="keyword">local</span> td = self._td</div><div class="line">    <span class="keyword">if</span> td <span class="keyword">then</span></div><div class="line">        mcrypt.mcrypt_module_close(td)</div><div class="line">     <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> _M</div></pre></td></tr></table></figure>
<p>使用方法比较简单，代码里面写死了是 <code>blowfish</code> 的 <code>cbc</code> 模式，并且 iv 使用 key 的前 8 个字符<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">local</span> mcrypt = <span class="keyword">require</span> <span class="string">"mcrypt"</span></div><div class="line"><span class="built_in">local</span> m = mcrypt:<span class="literal">new</span>()</div><div class="line"></div><div class="line">-- 一系列加解密</div><div class="line"><span class="built_in">local</span> en = m:encrypt(<span class="string">'xxx'</span>,<span class="string">'yyyy'</span>)</div><div class="line"><span class="attr">...</span></div><div class="line"><span class="built_in">local</span> de = m:decrypt(<span class="string">'xxx'</span>, yyyy<span class="string">')</span></div><div class="line"></div><div class="line">-- 最后关闭</div><div class="line">m:close()</div></pre></td></tr></table></figure></p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/libmcrypt-ffi-module/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="postgresql-transaction-isolation/">postgresql transaction isolation</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2015-05-10T15:20:49.000Z" itemprop="datePublished">May 10, 2015</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/postgresql/">postgresql</a>
</div>
    </div>
      
        <p>翻译自 <a href="http://www.postgresql.org/docs/current/static/transaction-iso.html，" target="_blank" rel="external">http://www.postgresql.org/docs/current/static/transaction-iso.html，</a> 内容没翻译全，供参考。</p>
<h2 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h2><h3 id="13-2-事务隔离级别"><a href="#13-2-事务隔离级别" class="headerlink" title="13.2 事务隔离级别"></a>13.2 事务隔离级别</h3><p>SQL 标准定义了四个事务隔离级别。最严格的就是串行化(Serializable)，根据标准定义，任何并发的串行化事务如果在相同的时间使用相同的顺序执行，那么需要有相同的执行结果。其他的三个隔离级别，都定义了在并发事务互相影响的情况下，在各隔离级别下不允许出现的一些现象。根据标准，这些现象都不允许出现在串行化这个级别。(这并不令人惊讶 – 如果为了事务的结果一致只允许同时运行一个事务，那怎么可能会出现因为事务互相影响产生的现象)。</p>
<p>在各级别禁止的一些现象如下：</p>
<p>脏读(dirty read)</p>
<pre><code>一个事务读取到另一个并发的事务还没有提交的数据。
</code></pre><p>不可重复读(nonrepeatable read)</p>
<pre><code>一个事务重复读取之前读过的数据的时候，发现数据已经被其他事务修改（就是在第一次读取之后做的提交)。
</code></pre><p>幻读(phantom read)</p>
<pre><code>一个事务重新执行一个查找符合条件的数据的查询的时候，发现返回的数据因为这期间别的事务做了提交而发生了变化。
</code></pre><p>四个事务隔离级别和对应的行为在表 13-1 中进行了描述。</p>
<p>表 13-1 SQL 标准定义的事务隔离级别</p>
<p>| 事务隔离级别               | 脏读   | 不可重复读 | 幻读   |<br>|—————————-+——–+————+——–|<br>| 读未提交(read uncommitted) | 可能   | 可能       | 可能   |<br>| 读已提交(read committed)   | 不可能 | 可能       | 可能   |<br>| 可重复读(repeatable read)  | 不可能 | 不可能     | 可能   |<br>| 串行化(serializable)       | 不可能 | 不可能     | 不可能 |</p>
<p>（译者注：这个表格是个很大的迷惑，要注意他描述的只是标准定义的，而不是 PostgreSQL 里面的情况，在 PostgreSQL 中的实际情况和上面表格标记的不一致，下面的译文里面也多次会提到。）</p>
<p>在 PostgreSQl 中，你可以使用任意的四个隔离级别。但是，在内部其实只有三个，分别对应到读已提交、可重复读和串行化。当使用读未提交这个级别的时候，实际上和读已提交是一样的，而幻读在 PostgresSQL 的可重复读级别是不可能出现的，所以在 PostgreSQL 中实际的隔离级别可能比你选的更加严格一点。这个是 SQL 标准允许的：标准里面的四个隔离级别只定义了哪种现象不能出现，没有定义哪种现象一定会出现。PostgreSQL 只提供了三个隔离级别，是因为这是唯一比较合理的把标准定义的隔离级别映射到多版本并发控制架构上面的办法。在下面的章节里面会详细讲解各个隔离级别。</p>
<p>设置事务隔离级别的语句是 set transaction。</p>
<pre><code>重要提示：有些 PostgreSQL 的数据类型和函数在事务里面有特别的表现。特别的，对于序列(sequence)(以及定义为 serial 类型的列对应的序列)的修改会立刻对所有事务有效，并且在事务回滚的时候也不会被回滚。请参考 9.16 和 8.1.4。
</code></pre><h4 id="13-2-1-读已提交事务隔离级别"><a href="#13-2-1-读已提交事务隔离级别" class="headerlink" title="13.2.1 读已提交事务隔离级别"></a>13.2.1 读已提交事务隔离级别</h4><p>读已提交是 PostgreSQL 里面默认的事务隔离级别。当一个事务使用此级别的时候，一个 select 查询(不带 for update/share 字句)只可以查到当前查询开始前已经提交的数据，(在此查询执行的过程中)永远不会查到其他并发事务执行时的未提交数据和已提交的修改。事实上，一个 select 查询可以”看“到执行开始瞬间的数据库的一个快照。不过，select 查询可以”看“到当前事务里面已经完成更新的数据，即使他们还没有被提交。同时也要注意，如果有其他事务在一个事务的第一个 select 执行之后提交了修改，那么那个事务里面的前后成功的两个 select 查询也有可能得到不同的结果。</p>
<p>update, delete, select for update, 和 select for share 这些语句在查找目标数据的时候的时候，表现和 select 是一样的：都是只能查找到在语句执行开始的时候就已经提交的数据。然而，这些目标数据可能就已经被其他并发事务修改（或者删除、加锁(locked))了。在这种情况下，即将执行更新的事务将会等待第一个执行了更新的事务的提交或者回滚（如果他仍然在执行中）。如果第一个更新事务执行了回滚，那么它的执行结果会取消，后续的更新事务会处理所有之前查找到的数据。如果第一个更新事务执行了提交，那么后续的更新事务会忽略第一个事务删除的行，然后针对已经更新过的数据上面执行它自己的操作。语句里面的查询条件（where 语句）会重新被执行来查看已经更新的数据是否还满足条件。如果满足，那后续的更新事务会在已经更新过的数据上面执行他自己的操作。如果执行的是 select for update 和 select for share 语句，那会返回或者锁定更新后的数据给客户端。</p>
<p>基于以上规则，一个更新语句可能会得到一个“不稳定”的快照。它会“看”到其他并发事务对它将要更新的数据的修改，但是“看”不到其他并发事务对其他数据的修改。这个行为会导致读已提交事务隔离级别不适用于一些复杂的查询，只适用于简单的情况。例如，想象一下在事务里面更新银行账户余额：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">BEGIN</span>;</div><div class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance = balance + <span class="number">100.00</span> <span class="keyword">WHERE</span> acctnum = <span class="number">12345</span>;</div><div class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> balance = balance - <span class="number">100.00</span> <span class="keyword">WHERE</span> acctnum = <span class="number">7534</span>;</div><div class="line"><span class="keyword">COMMIT</span>;</div></pre></td></tr></table></figure>
<p>如果有两个类似的事务要更新 12345 这个帐号的余额，我们显然是希望第二个更新事务是基于第一个的结果来更新。因为每个语句都是更新既定的数据，所以只能“看”到更新的数据不会造成不一致。</p>
<p>在读已提交事务隔离级别里面，复杂一点的情况可能会得到预期之外的结果。例如，想象一下一个 delete 语句操作的数据被其他语句从他的限制条件里面增加或者移除。例如，假设 website 是一个包含两行数据的表，其中 website.hits 字段分别等于 9 和 10。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">BEGIN</span>;</div><div class="line"><span class="keyword">UPDATE</span> website <span class="keyword">SET</span> hits = hits + <span class="number">1</span>;</div><div class="line"><span class="comment">-- run from another session:  DELETE FROM website WHERE hits = 10;</span></div><div class="line"><span class="keyword">COMMIT</span>;</div></pre></td></tr></table></figure>
<p>虽然在执行 update 前后，都有 website.hits = 10 的数据，但是那个 delete 语句将没有任何效果。这是因为未执行成功 update 前，9 这行数据是被 delete 忽略的，当 update 执行完毕，delete 得到锁之后，新的数据的值已经不是 10 而是 11 了，已经不再符合 delete 的条件了。</p>
<p>读已提交事务隔离级别在事务开始的时候会创建一个包含了在那个瞬间所有已提交的事务的数据的快照，同一个事务里面的后续语句会“看”到其他并发事务提交的数据。前面的问题的关键点是，单个语句是否可以得到一个持续一致的数据库。</p>
<p>读已提交事务隔离级别对于很多程序来说就已经足够了，使用起来快速简单。显然，它并不适用于所有情况。对于使用了复杂查询和更新的程序，或许需要对数据一致性要求比读已提交更加严格的事务隔离级别。</p>
<h4 id="13-2-2-可重复读事务隔离级别"><a href="#13-2-2-可重复读事务隔离级别" class="headerlink" title="13.2.2 可重复读事务隔离级别"></a>13.2.2 可重复读事务隔离级别</h4><p>可重复读事务隔离级别只能“看”到在事务开始前已经提交的数据，并且永远也“看”不到未提交的或者在事务执行期间被其他并发事务更新的数据。（当然，查询语句是可以“看”到在当前事务里面的已经执行的更新的，即使他们还没有被提交。）这么做比 SQL 标准里面针对这个隔离级别的要求严格，在表 13-1 里面表述的现象都不能发生。如前面所说，这么做标准是允许的，标准只描述了各隔离级别最低的要求。</p>
<p>这个隔离级别不同于读已提交隔离级别，在可重复读事务隔离级别里面一个查询可以“看”到事务开始的时候的一个快照，不是当前事务里面当前查询开始的时候的快照。因此，一个事务里面成功执行的 select 语句会得到相同的结果，也就是说，他们都”看“不到在事务开始之后其他事务提交的修改。</p>
<p>使用这个隔离级别的应用，应该在遇到序列化失败(serialization failures)的时候准备好重试。</p>
<p>update, delete, select for update, 和 select for share 这些语句在查找目标数据的时候的时候，表现和 select 是一样的：都是只能查找到在事务执行开始的时候就已经提交的数据。然而，这些目标数据可能就已经被其他并发事务修改（或者删除、加锁(locked))了。在这种情况下，可重复读事务将会等待第一个执行了更新的事务的提交或者回滚（如果他仍然在执行中）。如果第一个更新事务执行了回滚，那么它的执行结果会取消，后续的更新事务会处理所有之前查找到的数据。如果第一个更新事务执行了提交（真的对数据执行了更新或者删除，不是只是加了锁），那么可重复读事务会执行回滚，并且报错</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">ERROR</span>:  could <span class="keyword">not</span> serialize access due <span class="keyword">to</span> concurrent update</div></pre></td></tr></table></figure>
<p>因为可重复读事务在事务开始后不能对被其他事务做了修改的数据做修改或者锁定。</p>
<p>当应用程序得到这个错误信息的时候，应该立刻中止当前事务，重新从事务开始再次执行。再次执行的时候，这个事务就可以”看“到之前被其他事务提交的修改了，所以使用新版本数据作为新事务的起点的时候，就不会再有逻辑冲突了。</p>
<p>要注意只有有更新操作的事务才需要重试，只读的事务是永远不会有序列化冲突的。</p>
<p>读已提交事务隔离机制严格保证了每个事务都得到一个完整稳定的数据库快照。However, this view will not necessarily always be consistent with some serial (one at a time) execution of concurrent transactions of the same level. For example, even a read only transaction at this level may see a control record updated to show that a batch has been completed but not see one of the detail records which is logically part of the batch because it read an earlier revision of the control record. Attempts to enforce business rules by transactions running at this isolation level are not likely to work correctly without careful use of explicit locks to block conflicting transactions.</p>
<p>提示：在 PostgreSQL 9.1 以前，序列化事务隔离级别的情况和前面描述的信息是一样的。如果需要以前的序列化事务隔离级别，那可以使用现在的可重复读隔离级别。</p>
<h4 id="13-2-3-序列化隔离级别"><a href="#13-2-3-序列化隔离级别" class="headerlink" title="13.2.3 序列化隔离级别"></a>13.2.3 序列化隔离级别</h4><p>序列化事务隔离级别是最严格的事务隔离级别。这个级别把所有已经提交的事务模为拟序列化执行，就像是事务执行完一个执行另一个，顺序的，而不是并发的。当然，类似于可重复读事务隔离级别，应用程序在序列化失败的情况下必须要准备好重试。事实上，这个级别和可重复读事务隔离级别是一模一样的，除了会监控 except that it monitors for conditions which could make execution of a concurrent set of serializable transactions behave in a manner inconsistent with all possible serial (one at a time) executions of those transactions. This monitoring does not introduce any blocking beyond that present in repeatable read, but there is some overhead to the monitoring, and detection of the conditions which could cause a serialization anomaly will trigger a serialization failure.</p>
<p>举个例子，比如有表 mytab，初始的时候如下：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="section"> class | value</span></div><div class="line">-------+-------</div><div class="line"><span class="code">     1 |    10</span></div><div class="line"><span class="code">     1 |    20</span></div><div class="line"><span class="code">     2 |   100</span></div><div class="line"><span class="code">     2 |   200</span></div></pre></td></tr></table></figure>
<p>假设在序列化事务 A 里面执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">SUM</span>(<span class="keyword">value</span>) <span class="keyword">FROM</span> mytab <span class="keyword">WHERE</span> <span class="keyword">class</span> = <span class="number">1</span>;</div></pre></td></tr></table></figure>
<p>然后把结果（30）作为 value 字段，class = 2 作为新行插入回去。同时，序列化事务 B 里面执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">SUM</span>(<span class="keyword">value</span>) <span class="keyword">FROM</span> mytab <span class="keyword">WHERE</span> <span class="keyword">class</span> = <span class="number">2</span>;</div></pre></td></tr></table></figure>
<p>得到结果 300,并把结果和 class = 1 作为新行插入回去。然后两个事务都尝试提交。如果任意事务执行在可重复读级别，那么两个事务都可以提交; but since there is no serial order of execution consistent with the result, 使用序列化事务隔离级别的话，会允许其中一个事务提交，而回滚另一个事务，并且报如下错误信息：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ERROR:  could <span class="keyword">not</span> serialize access due <span class="built_in">to</span> <span class="built_in">read</span>/<span class="built_in">write</span> dependencies <span class="keyword">among</span> transactions</div></pre></td></tr></table></figure>
<p>这是因为如果 A 在 B 之前执行的话，B 的计算结果就会是 330 而不是 300,类似的，其他顺序会导致 A 得到不同的结果。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/postgresql-transaction-isolation/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="upgrade-myself/">成长</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2015-02-19T10:05:55.000Z" itemprop="datePublished">Feb 19, 2015</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/heart/">heart</a>
</div>
    </div>
      
        <p>刚开始参加工作，通常都是钱多少，户口给不给，安逸不安逸等等这种单一原因决定去哪里工作。一般都还没那个能力综合考虑一家公司。</p>
<p>那么选择大公司？选择初创公司？还是选择业界有影响力的公司？思考了很久，最后发现，这个时候选择什么公司不重要，重要的是自己，要选择自己感兴趣的，能保留自己强烈的求知欲的公司，最好公司的业务方向就是自己感兴趣的。</p>
<p>刚进入公司这二年很重要，在此期间能学习到大量的学校学习不到的技能，比如和同事相处，怎么理解需求，代码怎么写更好，工程如何组织等等。而这些东西，通常都是靠自己学习来搞定的，通过公司的一些培训（如果有的话），通过自己的观察，通过自己从互联网等资料学习的。这个期间你要强迫自己不停的学习，不停的思考。</p>
<p>在一个公司呆大概一年到二年左右，逐渐参与几个项目之后，应该已经可以独立承担负责一些小的事情了，这个时候一般会开始遇到瓶颈，可以学习的似乎都学的差不多了，一般都会开始思考”这家公司是否适合我”，或者”自己是否考虑换个工作经历一下”，要不然就是”你看有的同学换了一个工作工资涨了50%”，这些原因加起来，可能就会考虑是不是要换个公司了。</p>
<p>那么要不要换呢？从开拓眼见上面来讲，换是有一定意义的。各公司通常有各公司的一些运作方式，有一些包括一些很好的经验。通过换工作，可以学习到不少项目运作，分工合作的方式。</p>
<p>当然通常这些事情并非一定要换工作才能学习到，通过社交也能了解一部分。另外还有一个情况，别的公司的一些成功经验，也并非一定会适用你的团队。</p>
<p>一般来讲，技术工程师有两个方向的发展。一个是资深的技术大拿，一个是管理方面的 leader。两个方向不冲突，有些人可以兼顾。技术大拿指的是那些代码能力极强，很能专研技术，对管人没有兴趣，只对自己研究的技术有兴趣的人。管理方面指的不是技术一点都不行的，一般也得对技术有一定的了解，但是更多的精力会花在组建打理团队上面，对业务比较熟悉，能很好的把业务方向和技术结合起来的人。</p>
<p>为什么讲这个呢？和换工作有关系么？首先看你的方向是哪个。如果是专研技术，那么关注的应该是这个公司是否可以提供给你一个专心专研技术的氛围。有些技术是和业务结合比较紧密的，这种倒还好，但是有些是离业务比较远的，比如研究内核。一般业务团队都不乐意养一个研究和业务方向无关的人。</p>
<p>如果是搞管理，那应该关注的是你的业务是不是有前景，你的老大负责的业务是不是有前景，你所在的公司搞的业务是不是有前景。当然，在视野比较小的时候，可能很难判断。简单点，就看看你的老大是不是让你觉得他很牛逼吧。如果你对他都不崇拜不佩服，那可能就得仔细考虑下了。</p>
<p>需要关心公司的前景吗？刚工作没两年的人可能会觉得，公司再赚钱也不会多给我发多少，反正我就赚那么多，好像和我没关系。其实是有关系的。只有公司前景好，才有能力去养活更多的人，才有更多的业务方向给大家去尝试，才有机会创造更大的财富，大家也才有机会获得更多的回报。只有不断成长的公司，你的技术能力才有机会体现，才有机会负责更多更重要的事情，也就是所谓的有更多的机会。</p>
<p>当然，可能前提是你得进入一个正常的公司，有一个正常的领导。 :D</p>
<p>两年之后，一般就会有一些事情让你负责了，不管是重要的技术还是团队或者业务。这个时候就开始考验你的 leader 能力了。领导技术研究方向来支持业务，领导团队拿到更好的成绩。</p>
<p>有时候跟着牛逼人物混会产生一种自己也很牛逼的错觉。当牛逼人物不在的时候，会猛然发现，离开人家之后自己好像啥都搞不太好。所以其实最重要的是学习牛逼人物的一些思考问题的方法，以及培养适合自己的学习思考和工作的方式。这些才是自己后面受用不尽的东西。</p>
<p>两年之后的继续发展，全看你自己的能力了。思考自己后面的路的时候，你可以给自己设想一下，如果给你5个人，你能把现在的业务做成什么样子，或者你能搞出来什么引导潮流的什么牛逼技术？</p>
<p>如果给你 20 个人呢？50 个呢？你打算怎么办？</p>
<p>这就是所谓的成长。回答不了这些问题，说明你还没有成长。如果你能答好后面那个问题，能把 20 个人的事情安排到很好，那我估计你已经不需要看这篇文章啦。:D</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/upgrade-myself/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="notes-for-hackers-and-painters/">《黑客与画家》读书笔记</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2014-12-28T08:45:45.000Z" itemprop="datePublished">Dec 28, 2014</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/readings/">readings</a> <a href="../tags/lisp/">lisp</a>
</div>
    </div>
      
        <pre><code>如果某一天你想要去赚大钱，那么请记住这一点，因为这是创业公司能够成功的原因之一。大公司为了避免设计上的灾难，选择了减少设计结果的标准差。但是当你排斥差异的时候，你不仅将失败的可能性排除在外，也将获得高利润的可能性排除在外。这对大公司来说不是问题，因为生产特别优秀的产品不是它们的获胜手段。大公司只要做大不太烂，就能赢。
</code></pre><p>公司大到一定程度之后，更加希望稳定的可重复的产出，慢慢大家都会趋于稳定，不改变现有的系统。通常来说，创新和稳定肯定是冲突的，一旦选择的稳定，创新的积极性慢慢就会丧失。</p>
<pre><code>所以，viaweb 的开发人员总是与客服人员保持密切联系。客服人员坐在离程序员只有 9 米的地方，知道自己可以随时打断程序员的工作，提交新证实的 bug 的报告。遇到重大 bug，我们就算在开董事会，也会马上回来修改程序。
我们这种方式让所有人都感到满意。客户很高兴，拨打厂商服务热线是免费的，而且还被当做通风报信的人，受到郑重对待。客服人员也喜欢这样，因为这使得他们可以帮助用户，而不是对着用户读操作手册。程序员也喜欢这样，因为他们能够再现 bug，而不是通过模糊不清的二手报告了解 bug。
...... 客户支持实际上就是质量监控，也是某种程度上面的市场营销。除了记录 bug，客服人员还必须了解相关知识，回答与 bug 相关的一些问题，解释令使用者迷惑不解的功能等。有时，他们也扮演了使用者的代理人，我们会问他们哪个新功能是用户更想要的，他们总是能做出正确的回答。
</code></pre><p>短线沟通，及时响应的重要性。程序员的成就感，有时候不一定是来自于程序写的多好，能帮人解决问题有时候也会有成就感。短线能增加成就感。</p>
<pre><code>提高软件开发质量的关键在于开发的时候全身贯注，而不是降低开发速度。
</code></pre><p>这个和现代的敏捷开发做的事情类似，保证开发人员专注。</p>
<pre><code>&quot;帕金森定律&quot; 后来成为这些表现形式的代名词，它包括很多内容，其中有一条就是『因为你必须做到，所以你能够做到』。
可测量性和可放大性......如果你有一个令你感到安全的工作，你是不会致富的，因为没有危险，就几乎等于没有可放大性。
</code></pre><p>可测量和可放大性，一种衡量工作重要性的指标。</p>
<pre><code>假定软件有两个候选的新功能，它们创造的商业价值完全相同，那么我们总是选择较困难的那个功能。不是因为这个功能能带来更多的收入，而是因为它比较难。我们很乐于迫使那些又大又慢的竞争对手跟着我们一起走进沼泽地。 
创业公司就像游击队一样，喜欢选择不易生存的深山老林作为根据地，政府的正规军无法追到那种地方。我还记得创业初期我们是多么筋疲力尽，整天都为一些可怕的技术难题绞尽脑汁。但是，我还是感到相当高兴，因为那些问题连我们都觉得这么困难，那么竞争对手就更会认为是不可能解决的。
</code></pre><p>难才是体现价值的地方。</p>
<pre><code>注意，我说的是“用户需要的设计”，而不是“用户要求的设计”。我不想让读者产生一种印象，认为设计师就像厨师一样，顾客点什么菜就一模一样做出来。艺术的各个领域有着巨大的差别，但是我觉得任何一个领域的最佳作品都不可能由对用户言听计从的人做出来。
</code></pre><p>所谓的产品设计。应该是设计用户需要的，而不是用户要求的。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/notes-for-hackers-and-painters/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="how-to-take-care-of-diabetic-cats/">如何照顾糖尿病猫猫</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2014-01-19T14:16:09.000Z" itemprop="datePublished">Jan 19, 2014</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/cats/">cats</a> <a href="../tags/diabetic/">diabetic</a>
</div>
    </div>
      
        <p>注1： 最前面先公布个群，名字叫做“糖猫猫”，号码是 143834033。里面好多糖尿病猫猫的主人，可以交流，大家都很热心。</p>
<p>注2：再在前面说点，本文最初是基于宠物医院使用的稀释的办法给猫打胰岛素的，不过后面发现了一个更好的办法，使用 bd 针管，具体看最后补充的吧。</p>
<p>猫的糖尿病其实和人的是类似的，估计哺乳动物都这样。和人一样，猫猫上了年纪也容易得各种老年病，糖尿病就是其中一种。好像看到资料说做过绝育的母猫的得病几率更加大。</p>
<p>我理解糖尿病应该是一种慢性病，遇到得糖尿病的猫如果救助及时，应该是可以恢复的。好的话，甚至可以恢复胰岛素的分泌，摆脱胰岛素注射。</p>
<blockquote><p>動物吃下去的食物在身體裡被轉換成葡萄糖，隨著血液在身體裡流動，提供細胞養分，並且製造能量。身體裡的胰島素則是幫助細胞從血液裡取得所需能量的媒介。在正常的情況下，葡萄糖進入身體後，胰腺細胞開始釋放胰島素，並將之分配至身體的細胞，以使他們能夠”捕獲”他們所需的葡萄糖。</p>
<p>胰腺負責製造足夠的胰島素，細心的平衡血液中的葡萄糖濃度以避免濃度過高(血醣過高症)或者過低 (血醣過低症)。然而，罹患二型糖尿病的動物，身體的細胞對於胰島素無法正確反應(亦即不會”捕獲”他們所需的葡萄糖)，加上身體無法自行處理過多的葡萄糖而導致體內葡萄糖濃度異常的高。</p>
<footer><strong>[http://catmaid.wordpress.com/2009/01/12/diabeticcat/] [如何照顧糖尿病貓?]</strong></footer></blockquote>
<h2 id="糖尿病症状的前期表现"><a href="#糖尿病症状的前期表现" class="headerlink" title="糖尿病症状的前期表现"></a>糖尿病症状的前期表现</h2><blockquote><p>糖尿病貓的早期症狀為體重減輕，食慾會明顯增加或是變的很貪吃，喝水量增加而且頻尿 ( 譯者註: 三多…吃的多、喝的多、尿的多 )。當身體無法處理葡萄糖，大腦開始釋放”多吃”的訊息以帶進更多的葡萄糖。此時，體內的葡萄糖濃度開始上升，但是因為胰島素缺乏而無法被利用，身體裡飢餓的細胞開始消耗脂肪及肌肉蛋白質以轉換為肝醣。由於這樣的過程不斷循環，血液中的葡萄糖滲入尿液中，並且將水分從細胞中帶出，導致貓咪不斷的感覺口渴,而大量喝水，而不論貓咪喝了多少水，身體仍然會一直處於脫水狀態。</p>
</blockquote>
<p>我看到的早期猫猫会表现出来，口渴，喝水多，同时尿多，饥饿，开始变瘦这些症状。</p>
<p>你会发现水碗空的很快，经常看到猫猫在喝水。同时猫砂盆里面会发现尿的也多了，经常会发现超大的猫砂球，同时猫砂也用的变多了，以前可能两天不收拾也没问题，现在一天一次都感觉很多。会发现猫砂球变粘了，不容易铲，这是因为尿里面含糖量太高。老表现出来饥饿，对以前没兴趣的东西也变的感兴趣。</p>
<p>上面总体就是我家猫初期的表现。如果能注意到，那及时把猫送宠物医院查查吧，血糖试纸验血很便宜。不过因为猫猫也不会说话，一般都会注意不到，注意到了也一般不会重视。</p>
<p>上面表现之后，就会发现猫慢慢的没精神，吃的少了，水到是还是经常喝，像我家猫总呆在饭盆水盆前面发呆，尤其是水盆，经常趴在水盆前面睡觉。这个时候猫猫症状就已经比较严重了，一般得到医院输液救治了。下面这段引用说的就是这个情况。酮酸中毒产生之后，猫猫就基本没精神加没胃口了。并且酮酸中毒之后，可能肾，肝这些部位也会开始产生问题，出现衰竭。</p>
<blockquote><p>最後由於身體不能利用葡萄糖做為能量來源，而使用體內的脂肪來取代，這些脂肪代謝產生的酮體，在體內累積過多後便產生酮酸中毒。酮酸中毒可以迅速發生或是在幾天內慢慢產生，如果不立即治療的話，則可能導致昏迷甚至死亡。</p>
</blockquote>
<h2 id="如何治疗"><a href="#如何治疗" class="headerlink" title="如何治疗"></a>如何治疗</h2><p>我总结的。不一定适合所有猫，供参考。</p>
<p>我家猫送医院的时候，就已经是酮酸中毒的症状了。中间<a href="http://wdicc.com/diabetic-cat-maomao/">几经周折</a>，久病成医，多少也可以讲讲，呵呵。</p>
<p>因为猫已经不吃东西了，所以肯定是需要输液，补各种微量元素（大夫关注的好像是钾和纳，钾元素不足就会出现没精神的状态），用短效胰岛素降血糖，让血糖持续稳定在 10 以下，不过要注意也不能太低，到 2 以下可能就会引发低血糖症状了，低血糖是比高血糖更可怕的情况。我家猫当时打的是 0.6 单位（有的地方用 u 标识单位） 的短效，我看到有网站提示说是按照体重每公斤 0.25u，我家猫当时是 2.3 kg，所以 0.6 差不多。</p>
<p>上面的目的是保持血糖数值的同时，补充身体电解质，补充体力。期间如果有了精神可以尝试喂 A/D 罐头，如果能吃东西，那我看基本就有救了。看情况可能会需要持续几天的重症监护，具体到什么时候看医生的安排吧，我感觉是看他的精神如果比较好了，就可以回家吃钾片，钾镁片等药恢复，也不用老输液，输液多也会导致血管堵塞等。</p>
<p>回家之后一个事情就是需要持续打胰岛素。那么自己验血糖，配胰岛素，打针就是不可避免的了。这三项技能我们分开说。</p>
<h3 id="验血糖"><a href="#验血糖" class="headerlink" title="验血糖"></a>验血糖</h3><p>验血糖和给人操作差不多，仪器也是和人通用的。我用的是怡成的jps7，国产的。有些进口的比如拜耳之类，机器比较贵的，试纸也贵。试纸是消耗品，像开始的时候，我家猫一天测个十几次的（2小时一次），进口的试纸就有点接受不了了。也有人进口的国产的都买，进口的几天测一次这种，平时用国产的。我觉得其实没啥必要，看个相对数就好，一般关注的就是下面几个范围。</p>
<ol>
<li>3 以下。有低血糖怀疑，如果表现出来低血糖的症状，要感觉处理。</li>
<li>3 到 7。正常的范围。</li>
<li>7 到 15。稍微有点高，但是问题不严重</li>
<li>15 到 25。有点高。</li>
<li>25 以上。很高。</li>
</ol>
<p>这上面是我总结的，那些边界不一定就是个定死的，理解大意就好。也可以参考<a href="http://petdiabetes.wikia.com/wiki/Blood_sugar_guidelines" target="_blank" rel="external">这里</a>写的，这里的专业。</p>
<p>顺便说下低血糖的症状。低血糖的表现在人就是头晕无力。猫不会说话，表现是无力，软趴趴的，你扶起来他会继续趴着，像块布一样，怎么摆布都没反应，那基本就是低血糖了，这个时候要赶紧送医院，看情况是输液，打针还是喝水补充葡萄糖。但是如果血糖低于 3，但是猫没有低血糖的症状，也不用着急，喂点吃的应该就会好起来，不要着急补充葡萄糖。低血糖是很致命的，会导致脑部缺能量，导致脑部出问题什么的，所以要慎重。</p>
<p>给猫采血一般可以是耳朵采血或者脚垫采血。据说脚垫采血如果弄不好的话，容易发生感染（大概是因为脚比较容易接触到脏东西），所以一般都是耳朵采。买血糖仪一般会带一个采血的笔，那个玩意很好用。可以参考下<a href="http://www.youtube.com/watch?v=4CDew2sNOcI&amp;list=WLocLdlbhE3tvtQuJjfqU5tUwWrucncUWR" target="_blank" rel="external">这个视频</a>。如果猫耳朵毛长可以剃一下，那个凡士林可以用红梅素膏代替，都是不太贵的东西。扎之前如果用酒精处理过的话，要定酒精干了才能扎。扎的时候如果不容易出血，可以调整一下笔的针头的位置，不过别调多了把猫耳朵扎穿。。。</p>
<h3 id="配胰岛素"><a href="#配胰岛素" class="headerlink" title="配胰岛素"></a>配胰岛素</h3><p>胰岛素我买的是来得时的长效，大概 180 一支，3ml 300个单位。还有短效可以选，不过一般是说长效的控制的好一点。短效和配合长效用，长期还是靠长效控制。</p>
<p>目前我家猫是每次 1.5u 每天 3 次，8 小时一次。早期的时候是每次 0.5u，后来慢慢调整涨上来的。我看有人每次 6u 每天 2 次的。还有每天 4 次的，猫有区别，不能照搬，得找到适合自己和自己猫的方法。看到一个说法是是按照体重来打，每公斤 0.25u，不过如果控制不住也没办法，只能加量。</p>
<p>就是说先得确认个自己猫的胰岛素的量是多少，这可能有个调整的过程，所以掌握算法还是有必要的，呵呵。</p>
<p>然后针管，因为每次打的量也不多，所以买 1ml 的那种就可以，淘宝上面便宜的几分钱一个，要注意针头不要太粗，否则猫可能会疼。只是要注意，针头里面其实是有空间的，那些是不算到刻度里面的。但是打针的时候那里面的其实是打不出来的。但是用它做度量的时候要注意是否需要算上针头里面的。</p>
<p>接下来买注射用水，就是稀释胰岛素的。因为 0.1ml 就是 10 个单位，所以一般需要稀释才能用。这个东西也不贵，我买到的是 2ml 装的。</p>
<p>万事俱备，就差公式了。胰岛素 1ml 是 100 个单位。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="number">100</span>x<span class="regexp">/(k+x) = y/</span>m</div><div class="line"></div><div class="line">其中的变量如下，前三个单位是 ml</div><div class="line"><span class="string">k:</span> 计划使用的注射用水的总量</div><div class="line"><span class="string">x:</span> 计划使用的胰岛素的总量</div><div class="line"><span class="string">m:</span> 每针计划注射的总量</div><div class="line"><span class="string">y:</span> 每针要注射的胰岛素的量，单位是单位 u</div></pre></td></tr></table></figure>
<p>上面公式的四个变量，确定三个就可以算第四个了。举几个例子。</p>
<p>比如计划每针 1 个单位（y=1），为了节省注射用水，每针计划注射总量 0.05ml（m=0.05）。还差 2 个变量，先简单演算下，比如计划 2ml 注射用水都用掉，那么 k 就是 2ml，算一下胰岛素是多少。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">100</span>x/(<span class="number">2</span>+x) = <span class="number">1</span>/<span class="number">0.05</span> = <span class="number">20</span>/<span class="number">1</span></div><div class="line">x = <span class="number">0.5</span>ml</div></pre></td></tr></table></figure>
<p>胰岛素是 0.5ml。两方面抽出来之后，还需要有混合的地方，一般就选注射用水的瓶子就可以，所以根据结果只需要简单的抽 0.5ml 胰岛素，打入注射用水里面，得到的就是 0.05 含 1u 胰岛素的混合液。</p>
<p>再来一个例子，比如计划多打点 y=1.5, m=0.05, k=2ml，看看胰岛素应该是多少。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">100</span>x/(<span class="number">2</span>+x) = <span class="number">1.5</span>/<span class="number">0.05</span> = <span class="number">30</span>/<span class="number">1</span></div><div class="line">x=<span class="number">60</span>/<span class="number">70</span>=<span class="number">0.86</span></div></pre></td></tr></table></figure>
<p>胰岛素是 0.86ml。虽然 0.06 不太好抽，但是似乎勉强也可以。不过难点是，2ml 的注射用水的瓶子里面，是放不进去 0.86ml 的，放 0.5ml 就差不多满了。。。。所以这样是不行的。那怎么办？</p>
<p>也简单，我们先确定胰岛素的量，既然 0.86ml 放不下，我们定个 0.7ml 试试看能不能放下。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">100</span>x0<span class="number">.7</span>/(k+<span class="number">0.7</span>) = <span class="number">1.5</span>/<span class="number">0.05</span> = <span class="number">30</span>/<span class="number">1</span></div><div class="line">k= <span class="number">49</span>/<span class="number">30</span> = <span class="number">1.63</span></div></pre></td></tr></table></figure>
<p>这样，注射用水是 1.63ml ，然后胰岛素 0.7ml，混合后是 2.33ml，是可以放的下的。注射用水里面需要抽出来 2-1.63=0.37ml，然后就可以把胰岛素打进去了。要注意的是，抽出来的时候，针头里面是有空间的，那里面的量是不算到刻度里面的，把针头留空抽大概 0.37ml 就可以了。</p>
<h3 id="打针"><a href="#打针" class="headerlink" title="打针"></a>打针</h3><p>第一次打针可能会比较紧张，其实这是个非常简单的事情。可以在喂食的时候打针，糖尿病猫一般都是饿死鬼一样，根本不会理会你打针的。打针的位置是肋骨那里，或者大腿根部上面。把皮揪起来，在皮的中部靠下的位置，可以参考<a href="http://petdiabetes.wikia.com/wiki/Syringe" target="_blank" rel="external">这里</a>，左侧的正确的图，扎进去，推药就可以了，要注意不要扎穿了。。。。如果觉得有需要可以先用酒精擦拭，不过要等酒精干了再打。</p>
<h2 id="后期保养"><a href="#后期保养" class="headerlink" title="后期保养"></a>后期保养</h2><p>这块我还没有太多经验，因为我家猫还没有脱离胰岛素，只能是讲讲道听途说的一些。</p>
<p>猫的状态比较稳定之后，就进入长期和糖尿病斗争的阶段了。可以喂糖尿病猫粮，淘宝不让搜糖尿病，可以搜 “wd 猫粮”。不过是，喂干粮容易让血糖起来，我看有些人常年喂罐头，不过感觉有点贵，而且，湿粮吃多了会得口炎。。。。据说也可以喂蒸鸡胸，但是又说鸡肉含磷多，吃多了也不好。。。。所以我也不清楚。目前在尝试喂鸡肉看看，也不敢多喂。</p>
<p>现在情况就是一天三针，每次打针后喂干粮，两针期间饿了就喂点鸡肉，没鸡肉就少吃点干粮。大致就这样了。等我有了经验再来补充。</p>
<h2 id="update-2014-1-31"><a href="#update-2014-1-31" class="headerlink" title="update 2014.1.31"></a>update 2014.1.31</h2><p>翻了一些资料，看到<a href="http://petdiabetes.wikia.com/wiki/Low-carb_diet" target="_blank" rel="external">低碳水化合物疗法</a>。讲人吃低碳的食物有助于糖尿病恢复，那理论上猫也可以。并且<a href="http://petdiabetes.wikia.com/wiki/Category:Feline_regulated_cases" target="_blank" rel="external">这里</a>有一些低碳疗法的实例。</p>
<h2 id="update-2014-2-2"><a href="#update-2014-2-2" class="headerlink" title="update 2014.2.2"></a>update 2014.2.2</h2><p>低碳疗法的主要理论支持是讲猫可以把脂肪转化成葡萄糖，举例说野猫只吃老鼠，但是也可以活的很好。干粮得依靠碳水化合物形成最后的形状，所以干粮离不开碳水化合物。这里有个<a href="http://web.archive.org/web/20060616054707/www.geocities.com/jmpeerson/dryfood.html" target="_blank" rel="external">列表</a>，列出来了各种干粮的碳水化合物含量，里面最低的就是 Innova EVO Cat &amp; Kitten，这个在淘宝有卖，不过据群里人说，这个好像有点油也不太好，但是脂肪含量高了，肯定就油了啊，我也不清楚了。我现在喂的是 hills W/D 猫粮，这个倒是不油，不过感觉好像应该喂 M/D 才对……</p>
<h2 id="update-2014-2-9"><a href="#update-2014-2-9" class="headerlink" title="update 2014.2.9"></a>update 2014.2.9</h2><p>目前找到的靠谱一点的干粮有下面这些。</p>
<ul>
<li>innova evo 英诺华（凌采露华）evo</li>
<li>hills m/d 希尔斯 m/d</li>
<li>Royal Canin Veterinary DS46 皇家 DS46</li>
</ul>
<p>这几个都不便宜，淘宝上面差不多一公斤 70 - 100 块钱。</p>
<h2 id="update-2014-3-1"><a href="#update-2014-3-1" class="headerlink" title="update 2014.3.1"></a>update 2014.3.1</h2><p>这几天 hills md 和 evo 都断货了，只好开发新的。今天翻了一下，发现 <a href="http://www.petcurean.com/for-cats/go/" target="_blank" rel="external">petcurean</a> 的 go 品牌的猫粮似乎也可以，查了紫色包装的 FIT + FREE Chicken, Turkey + Duck （淘宝上面关键字是七种肉）和绿色包装的三种鱼，碳水化合物含量都是 13% 左右。今天买了2斤似乎效果还行，试试看。</p>
<h2 id="update-2014-6-16"><a href="#update-2014-6-16" class="headerlink" title="update 2014.6.16"></a>update 2014.6.16</h2><p>好久没有更新了。再次更新下。</p>
<p>饮食上面，自上次开始使用七种肉之后，一直到今天都在喂这个。一天打几次针喂几次。中间饿了就喂点蒸鸡胸肉。开始的时候食量很大，总是表现出很饿的样子，后来随着体重增加，慢慢的就吃的少了。</p>
<p>打针上面，开始打的是 1 个单位，后来改成 1.5 个单位，但是还是发现会有 20 多血糖的情况，就增加了一次打针，一天三次打针。后来持续了一段时间之后，血糖降到了 10 几，就把打针改回了一天 2 次，每次 2 单位。持续了一段时间之后，出现了小于 10 的血糖，大于 10 的情况比较少了，就开始减量到 1.5 了。目前是 1.5 单位一天两次。这两天测试很多时间都是 10 以下了，可能需要考虑再减量了。</p>
<p>要注意猫吃完干粮血糖肯定会增加，这个时候别着急加量，最好过个 1,2 个小时再看，如果还是高，那可能是需要加量了。</p>
<p>我家猫现在吃的变少了，尿的也明显变少了，目前感觉恢复的还可以。正在考虑减量或者减打针次数。</p>
<h2 id="收集到的一些参考资料"><a href="#收集到的一些参考资料" class="headerlink" title="收集到的一些参考资料"></a>收集到的一些参考资料</h2><ul>
<li>关于胰岛素剂量调整的一些经验 <a href="http://blog.sina.com.cn/s/blog_59c48f3f0102eedw.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_59c48f3f0102eedw.html</a></li>
<li>一些详细的照顾猫猫的经验 <a href="http://bbs.movshow.com/thread-412475-1-1.html" target="_blank" rel="external">http://bbs.movshow.com/thread-412475-1-1.html</a></li>
</ul>
<h2 id="update-2014-11-30"><a href="#update-2014-11-30" class="headerlink" title="update 2014.11.30"></a>update 2014.11.30</h2><p>在群里朋友的推荐下，已经使用了一段时间的 bd 针管了。bd 针管和普通针管主要的区别如下：</p>
<ul>
<li>bd 针管没有针头，这样打针的时候就不会损失针头里面的药。也不用担心隐藏的气泡什么的。</li>
<li>bd 针管没有的刻度和来得时搭配之后，刚好可以理解成是单位，一个刻度是 0.5u。</li>
<li>可以不用提前稀释配药了，用的时候从来得时抽就可以。</li>
<li>bd 针管针头更加细，猫没有感觉。</li>
</ul>
<p>好处可能还不止这些了，用起来还不错，推荐使用。购买的话，在群里面有人卖，一次买一大盒，然后可以用好久。我目前在重复使用，基本是一周换一个。用的时间长了会发现针头变钝，最好多换。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/how-to-take-care-of-diabetic-cats/#disqus_thread">Comments</a></span>
	
</div>
</article>


  <nav id="pagenavi">
    
        <a href="/" class="prev">Prev</a>
    
    
        <a href="/page/3/" class="next">Next</a>
    
  <div class="center"><a href="/archives/index.html">Blog Archives</a></div>
  </nav>


    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2016

    wd
. Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> |
    Theme is <a href="https://github.com/wd/hexo-fabric">hexo-fabric</a>, fork from <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
