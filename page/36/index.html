<!DOCTYPE HTML>
<html>
<head>
	<meta name="generator" content="Hugo 0.19" />
	<meta charset="utf-8">
    
    
    <title>wd and cc</title>
    <meta name="author" content="wd">
    <meta name="description" content="">
    <meta name="keywords" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link href="https://wdicc.com/index.xml" rel="alternate" title="wd and cc" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/css/custom.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='//fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    

    <script type="text/javascript" src="/js/jquery-tapir.js"></script>

    

    <link rel="stylesheet" href="/css/hljs.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>


<body>
    <div id="wrapper">
        <header id="header" class="inner">
<h1 class="animated bounceInDown">
    <div id="headerbg">
        wd and cc
    </div>
</h1>

<span class="subtitle">happy every day</span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
    
    
    <li>
    <a href="https://github.com/wd" class="github" title="Github"></a>
    </li>
    
    
    
    
    
    <li>
    <a href="http://www.twitter.com/wd" class="twitter" title="Twitter"></a>
    </li>
    
    
    
    
    
</ul>


<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
	<li id="ajax"><a href="/tags/index.html">Tags</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    <li>
    <div id="dark">
        <form action="//www.google.com.hk/search" method="get" accept-charset="UTF-8" id="search">
            <input type="hidden" name="sitesearch" value="https://wdicc.com/" />
            <input type="text" name="q" results="0" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
</ul>

</header>

<div id="toload">

    <div id="content" class="inner">
        




    
    <script id="dsq-count-scr" src="//wdicc.disqus.com/count.js" async></script>
    




  <article class="post">
    <h2 class="title"> 
        <a href="/split-and-cat/">用split分割备份文件，和用cat恢复备份</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-05-22T00:00:00.000&#43;00:00' itemprop="datePublished">2006-05-22</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>


</div>
    </div>
        split命令的使用格式如下：<br />
$split --help<br />
Usage: split [OPTION] [INPUT [PREFIX]]<br />
Output fixed-size pieces of INPUT to PREFIXaa, PREFIXab, ...; default<br />
PREFIX is `x'.&nbsp; With no INPUT, or when INPUT is -, read standard input.<br />

Mandatory arguments to long options are mandatory for short options too.<br />
&nbsp; -a, --suffix-length=N &nbsp; use suffixes of length N (default 2)<br />
&nbsp; -b, --bytes=SIZE &nbsp; &nbsp; &nbsp;&nbsp; put SIZE bytes per output file<br />
&nbsp; -C, --line-bytes=SIZE &nbsp; put at most SIZE bytes of lines per output file<br />
&nbsp; -d, --numeric-suffixes&nbsp; use numeric suffixes instead of alphabetic<br />
&nbsp; -l, --lines=NUMBER &nbsp; &nbsp;&nbsp; put NUMBER lines per output file<br />
 &nbsp; &nbsp;&nbsp; --verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print a diagnostic to standard error just<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; before each output file is opened<br />
 &nbsp; &nbsp;&nbsp; --help &nbsp; &nbsp; display this help and exit<br />
 &nbsp; &nbsp;&nbsp; --version&nbsp; output version information and exit<br />

SIZE may have a multiplier suffix: b for 512, k for 1K, m for 1 Meg.<br />


通常使用的都是-b参数指定分割之后的文件的大小。<br />

我们先建立一个测试文件。<br />
#dd if=/dev/zero of=./test bs=1M count=512<br />
就是以1M为单位，重复512次，也就是建立一个512M的文件。<br />

$split -b 200m test test_back<br />
执行这个命令之后，等执行完毕会看到目录下面多了几个文件<br />
$ls<br />
test test_backaa test_backab test_backac<br />

这样就完成了文件的分割。如果对于文本文件，还可以使用split的-l参数针对行数进行分割。<br />

这样分割传输之后，还需要重新合并才能使用，可以使用cat命令来完成。<br />
$cat test_backa* &gt; test_back<br />

执行完毕之后，可以看一下恢复的test_back文件和test文件的md5。<br />
$md5sum test test_back<br />
返回值应该是一样的。<br />

使用tar备份的时候有时也需要对大的备份文件进行分割。<br />
$tar czvf - /data | split -b 1024m - data<br />


    </div>

<div class="meta">
    
    <span class="comments"><a href="/split-and-cat/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/cacti-snmp/">使用cacti获取snmp发送的自定义信息</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-05-19T00:00:00.000&#43;00:00' itemprop="datePublished">2006-05-19</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>


</div>
    </div>
        ★ 需求<br />

服务器运行了weblogic和apache，可是有时weblogic进程会莫名crash，业务都在这上面，所以需要能监控程序的运行。我在服务器端写了一个脚本，使用curl检测这两个服务的状态，返回一个数字来确定是哪个服务down了，然后远程通过cacti采集数据画图。<br />

<br><!--more-->★ 解决方法<br />

snmp提供了发送自定义信息的功能。查看snmpd.conf会看到有一个小节是关于外部脚本的，Executables/scripts。这个小节里面也举了例子，告诉你怎么通过snmp发送信息。我的做法如下（下面假定你已经配置好了snmp，通过cacti已经能采集到信息了）。<br />

在任意位置添加一行：<br />
exec .1.3.6.1.4.1.2021.51 wlsapache /root/wlsapache status<br />
其中wlsapache是命令的名称，后面是命令以及参数。命令的名称可以随便起。脚本执行的结果类似下面：<br />
# ./wlsapache status<br />
3<br />
ALL ok.<br />
我这个脚本的“ALL ok”其实是副产品，对于采集数据没有用。<br />

重启snmpd，然后远程通过snmpwalk接收一下数据看看：<br />
# snmpwalk -v 1 192.168.1.201 -c public .1.3.6.1.4.1.2021.51 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />
UCD-SNMP-MIB::ucdavis.51.1.1 = INTEGER: 1<br />
UCD-SNMP-MIB::ucdavis.51.2.1 = STRING: "wlsapache"<br />
UCD-SNMP-MIB::ucdavis.51.3.1 = STRING: "/root/wlsapache status"<br />
UCD-SNMP-MIB::ucdavis.51.100.1 = INTEGER: 0<br />
UCD-SNMP-MIB::ucdavis.51.101.1 = STRING: "3"<br />
UCD-SNMP-MIB::ucdavis.51.101.2 = STRING: "ALL ok."<br />
UCD-SNMP-MIB::ucdavis.51.102.1 = INTEGER: 0<br />

其中我们需要的是UCD-SNMP-MIB::ucdavis.51.101.1 = STRING: "3"这一行：<br />
# snmpwalk -v 1 192.168.1.201 -c public .1.3.6.1.4.1.2021.51.101.1<br />
UCD-SNMP-MIB::ucdavis.51.101.1 = STRING: "3"<br />

能采集到数据之后，就可以配置cacti来接收了。在cacti界面中console-&gt;Templates-&gt;Data Templates，然后点击右上角的Add，Data Templates中的name是给这个数据模板的命名，Data Source中的name将来显示在Data Sources中，我这里添加“|host_description| - Network - wlsapache”，选get snmp data，Internal Data Source Name也可以随便添，这个用来给rrd文件命名。设置完后就可以save了，save之后会发现下面多了一些选项，在最下面那个添上我们需要的数据的OID“.1.3.6.1.4.1.2021.51.101.1”，可以保存了。<br />

此后需要创建一个Graph Templates，好让cacti生成图片。在cacti界面中console-&gt;Templates-&gt;Graph Templates，然后点击右上角的Add，Templates中的name是给这个数据模板的命名，Graph Template中的name是将来显示在图片上面中间的内容，我这里添加“|host_description| - wlsapache status”，其他保持默认，保存之后上面会出来一些选项。<br />

在Graph Template Items中添加一个item，Data Source选之前添加的，color选择一个图片的颜色，Graph Item Type选AREA，也就是区域，也可以选其他的线条，Text Format设置说明。然后再添加一个，Graph Item Type选GPRINT，Consolidation Function选LAST，也就是当前的值，Text Format输入current。你还可以添加一些Graph Item Type为COMMENT的注释说明等。<br />
现在只要为host添加这个画图模板就可以看到画出来的图了。<br />

<center><img src="/wordpress/wp-content/uploads/1320809656.png" width="576" height="212" alt=""></center><br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/cacti-snmp/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/a-file-root-cant-modify/">root用户无法修改的一个文件</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-05-15T00:00:00.000&#43;00:00' itemprop="datePublished">2006-05-15</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>


</div>
    </div>
        # ls -al xx<br />
-rwxr-xr-x &nbsp; &nbsp;1 root &nbsp; &nbsp; root &nbsp; &nbsp; &nbsp; &nbsp; 2647 Dec &nbsp;8 16:47 xx<br />

# stat -c %a startWebLogic.sh<br />
755<br />

# mv xx xx.ss<br />
mv: cannot move `xx' to `xx.ss': Operation not permitted<br />

这是怎么回事呢？上bbs问了一下才知道。<br />

# lsattr xx<br />
----i-------- xx<br />

只需要执行如下命令即可<br />
#chattr -i xx<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/a-file-root-cant-modify/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/ldap-samba/">ldap samba实现windows域管理</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-05-14T00:00:00.000&#43;00:00' itemprop="datePublished">2006-05-14</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>


</div>
    </div>
        0 准备工作<br />

1) 一个全新安装的debian sarge。1台或者多台Win 2k/xp测试电脑。<br />
2) 至少懂一些LDAP和Samba。<br />
3) 假设服务器的域名是abc.com，服务器的名称为test-server。<br />

1 安装web服务器<br />

# apt-get install apache2 php4 libapache2-mod-php4<br />

等待安装完毕之后，用浏览器连接服务器的域名或者ip试试看。能显示web页就说明apache2没问题了。apache2的web的根目录在/var/www，配置文件在/etc/apache2。<br />

此后需要验证php4是否安装妥当。在/var/www目录新建一个index.php文件，内容如下。<br />

&lt;?<br />
 &nbsp; &nbsp;phpinfo();<br />
?&gt;<br />

保存之后，再次连接服务器的 http://abc.com/index.php ，会看到一个php信息的网页，表示php安装成功。<br />
<br><!--more-->2 安装Openldap和phpldapadmin<br />

debian里面的openldap的名字是slapd。ldap-utils包里包括了一些ldap有用的命令（都是以ldap开头的）。phpldapadmin是ldap的一个web管理界面。de4.2-util是Berkeley V4.2 数据库工具包，ldap需要用到。<br />

#apt-get install slapd ldap-utils phpldapadmin db4.2-util<br />

下载完毕包之后，开始安装之前，会出来一些设置界面（请注意这里出现问题的数目和安装系统时的某个设置有关系）。<br />

slapd的设置<br />
1) DNS domain nam填写你的服务器的域名，此后会作为基准DN。例如我输入abc.com，此后的基准DN就是dc=abc,dc=com。<br />
2) Name of your organization填写你的组织的名称，或者公司的名称。我输入test-org。<br />
3) Admin password填写管理员的密码，这个用户是ldap最高权限的拥有者。<br />
4) 确认密码。<br />
5) Allow LDAPv2 protocol询问你是否允许LDAPv2协议。如果是新装选否就可以了。如果需要兼容以前的系统，选是。<br />

phpldapadmin的设置<br />
1) LDAP服务器的ip或者主机名。因为是管理本机的LDAP服务器，所以默认的127.0.0.1就可以。<br />
2) 是否启用TLS，也就是是否使用加密协议。加密的话可能需要apache2也做配置支持。这里选择否。<br />
3) 基准DN。根据你的情况输入，这里我输入dc=abc,dc=com。<br />
4) 这一步选择phpldapadmin的认证方式，安装过phpmysqladmin的应该会比较熟悉。选择session是最保险的方式。<br />
5) 输入登陆服务器的dn，默认即可。这里还要注意，默认的行字也就是最后登陆phpldapadmin的管理员的用户名，比较长。<br />
6) 需要配置的服务器，这里只需要选择apache2就可以了。<br />
7) 选择是，重启apache。<br />

此后即开始安装。slapd的配置文件都在/etc/ldap。phpldapadmin的配置文件在/etc/phpldapadmin。用浏览器打开 http://abc.com/phpldapadmin ，会看到phpldapadmin的界面，使用cn=admin,dc=abc,dc=com登陆。<br />

###如果是etch，phpldapadmin 0.8.8.1，登陆的时候会提示用户名或密码错误，不知道是不是phpldapadmin 0.9.8.1版本的bug。此版本还有一个问题就是登陆之后，不能新建entry。0.9.8.2版本就没有这个问题了。所以如果你也是0.9.8.1版本的话，最好还是去http://phpldapadmin.sf.net下载一个新的版本，然后把其中的phpldapadmin/htdocs/template_engine.php覆盖 /usr/share/phpldapadmin/htdocs/template_engine.php 即可，或者也可以直接全部覆盖，要注意保留config/config.php。<br />

如果提示用户名密码错误，不用担心，还可以修改/etc/ldap/slapd.conf文件，在index后面添加两行<br />

rootdn "cn=admin,dc=abc,dc=com"<br />
rootpw pw<br />

之后重启slapd（/etc/init.d/slapd restart）之后即可用密码pw登陆，登陆之后可以修改密码，修改之后可以去掉上面添加的两行（当然，不删也可以）。<br />

debian中的admin的密码是存储在数据库里面的，而不是/etc/ldap/slapd.conf文件中，所以可以不需要rootdn和rootpw的设置。<br />

使用下面的命令可以查看ldap中所有的条目<br />

#ldapsearch -x -b 'dc=abc,dc=com' '(objectclass=*)'<br />

修改/etc/syslog.conf，增加下面一行。<br />

local4.* &nbsp; &nbsp; &nbsp; &nbsp; /var/log/ldap.log<br />

这样ldap生成的日志就会在/var/log/ldap.log里面出现。此外还需要设置/etc/ldap/slapd.conf的loglevel。<br />

3 安装samba<br />

samba-doc包含了和ldap一起工作的samba schema，这个是我们需要的。<br />

#apt-get install samba samba-doc<br />

samba的设置<br />
1) Workgroup/Domain Name这里输入工作组名称或者域名称。我这里输入test-domain。<br />
2) 是否使用加密密码。windows默认都是这个。选是。<br />
3) 修改smb.conf使用DHCP设置的WINS。选否。<br />
4) 选daemons。<br />
5) 是否建立samba密码数据库，选是。<br />

复制ldap需要的samba的schema。<br />

#cp /usr/share/doc/samba-doc/examples/LDAP/samba.schema.gz /etc/ldap/schema<br />
#cd /etc/ldap/schema/<br />
#gzip -d samba.schema.gz<br />

修改/etc/ldap/slapd.conf，在include后面加上一行。<br />

include &nbsp; &nbsp; &nbsp; &nbsp; /etc/ldap/schema/samba.schema<br />

重启slapd。配置samba使用ldap来验证。修改/etc/samba/smb.conf文件。<br />

找到passdb backend = tdbsam，将其替换为下面内容。<br />

passdb backend = ldapsam:ldap://127.0.0.1<br />
ldap suffix = dc=abc,dc=com<br />
ldap machine suffix = ou=machines<br />
ldap user suffix = ou=users<br />
ldap group suffix = ou=groups<br />
ldap admin dn = cn=admin,dc=abc,dc=com<br />
ldap delete dn = no<br />

# 服务器配置为主域控制器<br />
domain logons = yes<br />

# allow user privileges<br />
enable privileges = yes<br />


设置之后可以使用testparm命令测试。<br />

为samba提供LDAP rootdn的密码。<br />

# smbpasswd -w your_passwd<br />
Setting stored password for "cn=admin,dc=abc,dc=com" in secrets.tdb<br />

重启samba。打开phpldapadmin看看，可以看到dc=abc,dc=com下面已经多出来一个entry。我这里是sambaDomainName=TEST-DOMAIN。查看其属性，可以看到最下面的sambaSID，这个后面的操作会用到。也可以使用net getlocalsid命令得到。<br />


4 安装smbldap-tools<br />

perl脚本，用来更加方便管理用户。主要使用他来初始化LDAP中samba中的部分。<br />

#apt-get install smbldap-tools<br />

配置smbldap-tools。<br />

#cd /etc/smbldap-tools<br />
#cp /usr/share/doc/smbldap-tools/examples/smbldap{.conf.gz,_bind.conf} ./<br />
#gzip -d smbldap.conf.gz<br />

之后修改下面几个文件以符合你的情况。<br />

/etc/smbldap-tools/smbldap.conf<br />

SID="S-1-5-21-3248317815-3353503310-553435137" <br />
suffix="dc=abc,dc=com" <br />
usersdn="ou=users,${suffix}" <br />
computersdn="ou=machines,${suffix}" <br />
groupsdn="ou=groups,${suffix}" <br />
sambaUnixIdPooldn="sambaDomainName=TEST-DOMAIN,${suffix}" <br />
hash_encrypt="MD5"<br />

/etc/smbldap-tools/smbldap_bind.conf:<br />

slaveDN="cn=admin,dc=abc,dc=com" <br />
slavePw="password" <br />
masterDN="cn=admin,dc=abc,dc=com" <br />
masterPw="password"<br />

要注意这个文件里面的密码要添明文，所以最好为这个文件设置合适的权限。<br />

执行smbldap-populate命令<br />

# smbldap-populate<br />
Using workgroup name from sambaUnixIdPooldn (smbldap.conf): sambaDomainName=TEST-DOMAIN<br />
Using builtin directory structure<br />
entry dc=abc,dc=com already exist.<br />
adding new entry: ou=Users,dc=abc,dc=com<br />
adding new entry: ou=Groups,dc=abc,dc=com<br />
adding new entry: ou=Computers,dc=abc,dc=com<br />
adding new entry: ou=Idmap,dc=abc,dc=com<br />
entry sambaDomainName=TEST-DOMAIN,dc=abc,dc=com already exist. Updating it...<br />
adding new entry: uid=Administrator,ou=Users,dc=abc,dc=com<br />
adding new entry: uid=nobody,ou=Users,dc=abc,dc=com<br />
adding new entry: cn=Domain Admins,ou=Groups,dc=abc,dc=com<br />
adding new entry: cn=Domain Users,ou=Groups,dc=abc,dc=com<br />
adding new entry: cn=Domain Guests,ou=Groups,dc=abc,dc=com<br />
adding new entry: cn=Domain Computers,ou=Groups,dc=abc,dc=com<br />
adding new entry: cn=Administrators,ou=Groups,dc=abc,dc=com<br />
adding new entry: cn=Print Operators,ou=Groups,dc=abc,dc=com<br />
adding new entry: cn=Backup Operators,ou=Groups,dc=abc,dc=com<br />
adding new entry: cn=Replicators,ou=Groups,dc=abc,dc=com<br />

此后，可以查看一下phpldapadmin，已经新加了几个entry。<br />

5 安装mkntpwd<br />

phpldapadmin需要使用这个程序来生成samba的加密密码。debian没有这个包，需要自己编译，编译之前可能需要安装make，gcc和libc-dev包。<br />

#apt-get install make gcc libc-dev<br />
#wget http://www.nomis52.net/data/mkntpwd.tar.gz <br />
#tar -zxf mkntpwd.tar.gz<br />
#cd mkntpwd<br />
#make<br />
#cp mkntpwd /usr/local/bin <br />

修改/usr/share/phpldapadmin/templates/template_config.php文件。<br />

查找<br />

// uncomment to set the base dn of posix groups<br />
// default is set to the base dn of the server<br />
//$base_posix_groups="ou=People,dc=example,dc=com";<br />

$samba3_domains[] =<br />
array(&nbsp; 'name' &nbsp; =&gt; 'My Samba domain Name',<br />
 &nbsp; &nbsp; &nbsp;&nbsp; 'sid' =&gt; 'S-1-5-21-4147564533-719371898-3834029857' );<br />

// The base dn of samba group. (CUSTOMIZE)<br />
//$samba_base_groups = "ou=Groups,ou=samba,dc=example,dc=org";<br />

修改为<br />

// uncomment to set the base dn of posix groups<br />
// default is set to the base dn of the server<br />
$base_posix_groups="ou=groups,dc=nomis52,dc=net";<br />

$samba3_domains[] =<br />
array(&nbsp; 'name' &nbsp; =&gt; 'TEST-DOMAIN',<br />
 &nbsp; &nbsp; &nbsp;&nbsp; 'sid' =&gt; 'S-1-5-21-3248317815-3353503310-553435137' );<br />

// The base dn of samba group. (CUSTOMIZE)<br />
$samba_base_groups = "ou=groups,dc=abc,dc=com"<br />

6 安装libnss-ldap<br />

用来做linux验证。使得LDAP用户就像普通linux帐号一样。<br />

#apt-get install libnss-ldap<br />

libnss-ldap设置<br />
1) 默认。<br />
2) 查找基准。输入dc=abc,dc=com。<br />
3) 选3。<br />
4) 选否。<br />
5) 选是。<br />
6) 确定。<br />

修改/etc/nsswitch.conf。<br />

passwd: &nbsp; &nbsp; &nbsp; &nbsp; compat ldap<br />
group: &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; compat ldap<br />
shadow: &nbsp; &nbsp; &nbsp; &nbsp; compat ldap<br />

这样验证密码的时候会先搜索/etc/passwd，然后才是ldap。<br />

使用getent命令查看一下计算机上面的用户组，在最后会看到ldap的。<br />

#getent group<br />
.....<br />
Domain Admins:x:512:Administrator<br />
Domain Users:x:513:<br />
Domain Guests:x:514:<br />
Domain Computers:x:515:<br />
Administrators:x:544:<br />
Print Operators:x:550:<br />
Backup Operators:x:551:<br />
Replicators:x:552:<br />

7 安装libpam-ldap<br />

#apt-get install libpam-ldap<br />

libpam-ldap设置<br />
1) 使root成为数据库的管理员？选是。<br />
2) 选否。<br />
3) 输入admin的dn，cm=admin,dc=abc,dc=com。<br />
4) 输入root使用的密码，留空使用原来的root密码。<br />
5) 选md5。<br />

修改 /etc/pam-ldap.conf。<br />

pam_filter !(uidNumber=0)<br />

设置不允许root通过ldap登陆linux。<br />

修改下面文件使得pam使用ldap。<br />

/etc/pam.d/common-account<br />

# 注释掉这行 <br />
#account &nbsp; &nbsp; &nbsp;&nbsp; required &nbsp; &nbsp; &nbsp;&nbsp; pam_unix.so<br />

# 添加下面两行<br />
account &nbsp; &nbsp; &nbsp; &nbsp; sufficient &nbsp; &nbsp;&nbsp; pam_ldap.so<br />
account &nbsp; &nbsp; &nbsp; &nbsp; required &nbsp; &nbsp; &nbsp;&nbsp; pam_unix.so try_first_pass<br />

/etc/pam.d/common-auth<br />

# 注释掉这行 <br />
#auth &nbsp; required &nbsp; &nbsp; &nbsp;&nbsp; pam_unix.so nullok_secure<br />

# 添加下面两行<br />
auth &nbsp;&nbsp; sufficient &nbsp; &nbsp;&nbsp; pam_ldap.so<br />
auth &nbsp;&nbsp; required &nbsp; &nbsp; &nbsp;&nbsp; pam_unix.so nullok_secure use_first_pass<br />

/etc/pam.d/common-password<br />

# 注释掉这行<br />
#password &nbsp; required &nbsp; pam_unix.so nullok obscure min=4 max=8 md5<br />

# 添加下面两行<br />
password &nbsp; sufficient pam_ldap.so<br />
password &nbsp; required &nbsp; pam_unix.so nullok obscure min=4 max=8 md5 use_first_pass<br />

重启ssh和samba。<br />

安装nscd。<br />

#apt-get install nscd<br />

8 添加用户<br />

smbldap-useradd : to add an user account (by default a posixAccount. Using '-a' option for a sambaSAMAccount, '-w' option for a machine sambaAccount), <br />
smbldap-userdel : to delete an existing user account <br />
smbldap-usermod : to modify an user account. <br />
smbldap-userinfo : to allow users to modify some informations themselves<br />

修改/etc/samba/smb.conf。<br />

guest account = nobody<br />
add user script = /usr/sbin/smbldap-useradd -m "%u"<br />
#delete user script = /usr/sbin/smbldap-userdel "%u"<br />
add machine script = /usr/sbin/smbldap-useradd -w "%u"<br />
add group script = /usr/sbin/smbldap-groupadd -p "%g"<br />
#delete group script = /usr/sbin/smbldap-groupdel "%g"<br />
add user to group script = /usr/sbin/smbldap-groupmod -m "%u" "%g"<br />
delete user from group script = /usr/sbin/smbldap-groupmod -x "%u" "%g"<br />
set primary group script = /usr/sbin/smbldap-usermod -g "%g" "%u"<br />
ldap passwd sync = yes<br />


添加一个测试用户。<br />

#smbldap-useradd -a -m testuser<br />
#smbldap-passwd testuser<br />
#smbldap-passwd Administrator<br />

重启一下电脑，然后使用下面的命令。<br />

#net rpc -U Administrator rights grant testuser SeMachineAccountPrivilege<br />

然后使用这个用户登陆一下域看看。<br />



$ smbcontrol smbd reload-config<br />

and grant the necessary rights to Administrator:<br />

$ net -U Administrator rpc rights list<br />
 &nbsp; &nbsp; SeMachineAccountPrivilege&nbsp; Add machines to domain<br />
 &nbsp; &nbsp;&nbsp; SePrintOperatorPrivilege&nbsp; Manage printers<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SeAddUsersPrivilege&nbsp; Add users and groups to the domain<br />
 &nbsp; &nbsp; SeRemoteShutdownPrivilege&nbsp; Force shutdown from a remote system<br />
 &nbsp; &nbsp; &nbsp; SeDiskOperatorPrivilege&nbsp; Manage disk shares<br />

$ net -U Administrator rpc rights list Administrator<br />

$ net -U Administrator rpc rights grant Administrator SeMachineAccountPrivilege<br />
Successfully granted rights.<br />




9 登陆脚本<br />

创建网络共享<br />
# mkdir -p /data/samba/netlogon<br />
# chgrp "Domain Admins" /data/samba/netlogon<br />

修改/etc/samba/smb.conf<br />

# put this in the main section<br />
logon script = logon.bat<br />

# share for the logon scripts<br />
[netlogon]<br />
 comment = Network logon service<br />
 path = /data/samba/netlogon<br />
 write list = "@Domain Admins"<br />
 guest ok = Yes<br />
 <br />
 下载KiXtart，解压到/data/samba/netlogon。<br />
 <br />
 #cd /data/samba/netlogon<br />
 #wget "http://www.adminscripteditor.com/downloads.asp?act=v&amp;id=39"<br />
 #apt-get install unzip<br />
 #unzip KiX2010_451.zip<br />
 #cp ./KiX2010.451/{KIX32.EXE,KX32.dll} ./<br />
 <br />
 创建logon.bat。<br />
 <br />
 \\debian\netlogon\kix32 \\debian\netlogon\logon.kix /f<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/ldap-samba/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/del-30-day-old-file/">find命令查找删除30天之前的文件</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-05-09T00:00:00.000&#43;00:00' itemprop="datePublished">2006-05-09</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/find">find</a>

<a href="/tags/other">other</a>


</div>
    </div>
        find /data -name "xxx.*" -follow -ctime +30 -exec rm -rf {} \;<br />

删除30天之前的文件。<br />
-follow表示跟随链接。<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/del-30-day-old-file/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/install-mysql/">mysql 安装</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-05-09T00:00:00.000&#43;00:00' itemprop="datePublished">2006-05-09</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/mysql">mysql</a>

<a href="/tags/other">other</a>


</div>
    </div>
        下面的内容大部分来自mysql的readme<br />

1 download mysql5.0<br />
2<br />
shell&gt; groupadd mysql<br />
shell&gt; useradd -g mysql mysql<br />
shell&gt; cd /usr/local<br />
shell&gt; gunzip &lt; /PATH/TO/MYSQL-VERSION-OS.tar.gz | tar xvf -<br />
shell&gt; ln -s FULL-PATH-TO-MYSQL-VERSION-OS mysql<br />
shell&gt; cd mysql<br />
shell&gt; scripts/mysql_install_db --user=mysql<br />

如下提示信息:<br />

Installing all prepared tables<br />
Fill help tables<br />

To start mysqld at boot time you have to copy support-files/mysql.server<br />
to the right place for your system<br />

PLEASE REMEMBER TO SET A PASSWORD FOR THE MySQL root USER !<br />
To do so, start the server, then issue the following commands:<br />
./bin/mysqladmin -u root password 'new-password'<br />
./bin/mysqladmin -u root -h czhand password 'new-password'<br />
See the manual for more instructions.<br />

You can start the MySQL daemon with:<br />
cd . ; ./bin/mysqld_safe &amp;<br />

You can test the MySQL daemon with the benchmarks in the 'sql-bench' directory:<br />
cd sql-bench ; perl run-all-tests<br />

Please report any problems with the ./bin/mysqlbug script!<br />

The latest information about MySQL is available on the web at<br />
http://www.mysql.com<br />
Support MySQL by buying support/licenses at https://order.mysql.com<br />

shell&gt; chown -R root  .<br />
shell&gt; chown -R mysql data<br />
shell&gt; chgrp -R mysql .<br />

/home/my.cnf<br />

basedir=/usr/local/mysql<br />
datadir=/usr/local/mysql/data<br />
socket=/usr/local/mysql/data/mysql.sock<br />
#err-log=/var/log/mysqld.log<br />
pid-file=/usr/local/mysql/data/mysqld.pid<br />

shell&gt; bin/mysqld_safe --user=mysql &amp;<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/install-mysql/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/rsync-script/">rsync脚本的一个例子</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-05-09T00:00:00.000&#43;00:00' itemprop="datePublished">2006-05-09</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>

<a href="/tags/rsync">rsync</a>


</div>
    </div>
        <pre class="prettyprint lang-bash">

SYNCLOGFILE="/var/log/rsync-201.log"
SYNCLOCKFILE="/var/lock/rsync-201.lock"

if [[ -f $SYNCLOCKFILE ]]; then
  # lock file already present, bail
  exit 1
fi

echo -n ">>> Sync log for " >> $SYNCLOGFILE
date >> $SYNCLOGFILE

touch $SYNCLOCKFILE
rsync -vzrtopg  --delete 192.168.0.201::www /backup  >> $SYNCLOGFILE 2>&1
rm -f $SYNCLOCKFILE
</pre><br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/rsync-script/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/stop-and-start-script-for-apache-and-weblogic/">启动停止weblogic和apache的脚本</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-05-09T00:00:00.000&#43;00:00' itemprop="datePublished">2006-05-09</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>


</div>
    </div>
        apache和weblogic做桥接之后，启动的时候要先启动weblogic，后启动apache，停止的时候要先停止apache，后停止weblogic，这<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/stop-and-start-script-for-apache-and-weblogic/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/portmap/">端口映射</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-05-09T00:00:00.000&#43;00:00' itemprop="datePublished">2006-05-09</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/iptables">iptables</a>

<a href="/tags/other">other</a>


</div>
    </div>
        ★ 需求<br />

1 只有一个ip，怎么让多台电脑上网？<br />

只讲一下主机是双网卡的时候怎么解决。windows下面可以使用winroute、wingate或者系统自带的共享网络连接的功能，都可以实现共享上网。linux下面使用iptables一句话就可以实现。<br />

至于主机是单网卡怎么解决，自己研究研究吧。我只在win下面尝试过用wingate，可是及其不稳定。<br />

2 怎么将某个端口映射给内网？<br />

内网某台电脑提供了服务，怎么让外网的用户可以访问呢？某些对外的服务可能会在内网的多台电脑上面提供，这时就需要做端口映射来让这些服务器让外网可以访问。<br />

<br><!--more-->★ 解决方法<br />

1 共享上网<br />

1) 按照下图连接电脑。<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;isp<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gw(用来做网关的电脑，双网卡)<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hub(or switch)<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---------------------------<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;&nbsp; | ........ | &nbsp; &nbsp; &nbsp; |<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pc1 &nbsp; pc2 ......&nbsp; pcx &nbsp;&nbsp; pcy<br />

gw一个网卡接isp，ip设置为isp告诉你的。另外一个网卡接hub，ip设置为一个内网ip，例如192.168.0.1。<br />

2) 在gw上面执行如下脚本。<br />
#------------script start--------<br />
#!/bin/sh<br />

IPT="/sbin/iptables"<br />

# Internet Interface<br />
INET_IFACE="ethx"<br />
INET_ADDRESS="x.x.x.x"<br />

# Local Interface Information<br />
LOCAL_IFACE="ethy"<br />
LOCAL_IP="192.168.0.1"<br />
LOCAL_NET="192.168.0.0/24"<br />
LOCAL_BCAST="192.168.0.255"<br />

#修改从外网网卡出去的包的源地址，好让外网返回的包能正确回来。<br />
$IPT -t nat -A POSTROUTING -o $INET_IFACE -j SNAT --to-source $INET_ADDRESS<br />

#打开系统的转发功能<br />
echo "1" &gt; /proc/sys/net/ipv4/ip_forward<br />

#----------script end----------<br />

这样内网的电脑做如下设置后就应该可以上网了。<br />

ip：&nbsp; 192.168.0.x<br />
网关: 192.168.0.1<br />
dns:&nbsp; 和gw的设置一样<br />

这时的服务器已经具备一个网关的功能，不过内网的电脑想要上网，都必须手动设置ip，想做到自动获取，可以<br />

2 端口映射<br />

端口映射需要做的其实就是修改对方发过来包的目的地址和端口，然后帮忙转发一下，并且转发的同时修改一下源地址，好让被转发的电脑认为是gw发的包，处理完毕之后好能正常返回gw，然后由gw在负责转发给外网的ip。端口转发需要用到iptables的nat表，上面这些操作是在PREROUTING和POSTROUTING链之间完成的。<br />

1) 映射到外网ip<br />
整个过程可以参考下图。<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;eth0(外网网卡) &nbsp; &nbsp;<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;________________________<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|<br />
 &nbsp; &nbsp;&nbsp; gw的80端口 &nbsp; &nbsp; &nbsp;&nbsp; 修改目标地址(DNAT) &nbsp; &nbsp; &nbsp; 修改源地址(SNAT)<br />
外网ip----------&gt;PREROUTING------------&gt;POSTROUTING------------&gt;外网ip<br />

所以，例如我们要将对gw 80端口的访问都转发到外网的202.202.202.202这台电脑上面，只需要在上面的脚本中添加下面的语句即可。<br />

# 修改从外网进来的对80端口访问的数据包的目的地址<br />
$IPT -t nat -A PREROUTING -p tcp -i $INET_IFACE --destination-port 80 \<br />
 &nbsp; &nbsp; -j DNAT --to-destination 202.202.202.202<br />

那么，你可能要问，按照上面的说法，这样只修改了目的地址，还要修改源地址啊，这样包才能正确返回到gw。问的好，不过其实我们已经做了这个设置了，聪明的你可能已经想到了，就是上面让内网ip可以上网的那个脚本里的一句语句已经实现了这个功能。<br />

#修改从外网网卡出去的包的源地址，好让外网返回的包能正确回来。<br />
$IPT -t nat -A POSTROUTING -o $INET_IFACE -j SNAT --to-source $INET_ADDRESS<br />

就是上面这句，他把所有从外网网卡出去的包的源地址都修改了，当然也包括去往202.202.202.202的80端口的包。<br />

2) 映射到内网ip<br />
整个过程可以参考下图。<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;eth0(外网网卡) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;eth0(内网网卡)<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;________________________ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_______________________<br />
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; |<br />
 &nbsp; &nbsp;&nbsp; gw的80端口 &nbsp; &nbsp; &nbsp;&nbsp; 修改目标地址(DNAT) &nbsp; &nbsp; &nbsp; 修改源地址(SNAT) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 修改源地址(SNAT)<br />
外网ip----------&gt;PREROUTING------------&gt;POSTROUTING------------&gt;PREROUTING-----------&gt;POSTROUTING-----------&gt;内网ip<br />

所以，例如我们要映射80端口到内网的192.168.1.80这台电脑上面，只需要在上面的脚本中添加下面的语句即可。<br />

# 修改从外网进来的对80端口访问的数据包的目的地址<br />
$IPT -t nat -A PREROUTING -p tcp -i $INET_IFACE --destination-port 80 \<br />
 &nbsp; &nbsp; -j DNAT --to-destination 192.168.1.80<br />
 &nbsp; &nbsp; <br />
# 修改从内网网卡出去的所有数据包源地址<br />
$IPT -t nat -A POSTROUTING -o $LOCAL_IFACE \<br />
 &nbsp; &nbsp; -j SNAT --to-source $LOCAL_IP<br />

这个比上面多了一句，意思相信你已经明白了吧。因为访问内网ip的时候走了内网网卡，所以还需要对从内网网卡出去的包修改一下源地址。<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/portmap/#disqus_thread">Comments</a></span>
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="/178-accident/">178事故</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2006-04-30T00:00:00.000&#43;00:00' itemprop="datePublished">2006-04-30</time>
</div>
        <div class="tags">Tags: 

<a href="/tags/other">other</a>

<a href="/tags/route">route</a>

<a href="/tags/%E8%B7%AF%E7%94%B1">路由</a>


</div>
    </div>
        ★ 由来<br />

做服务器间相互备份的时候，到某两台服务器的时候，暂且称为A、B吧，发现他们之间不能互通，查看了ip，内网ip都是一个网段的，查看防火墙，端口也都是打开的，更加离奇的是，通过rsync从B访问A的时候，提示对方拒绝连接，同时在A上面用tcpdump监听相应端口，发现没有任何数据来往，而在A上面同时用tcpdump监听，却发现发出的请求对方都有回应。这个就太离奇了，到底是怎么回事呢？在A上面查看ip设置，注意到A有三个网卡，一个公网，两个内网ip，两个内网ip分别是10.x.x.0/24网段和192.168.0.0/24网段的，而B上面只有两块网卡，一个公网ip，一个内网ip，内网是192.168.0.0/24网段的，此时突然想起来A上面有snmpd监控，查看了一下，发现A的192.168.0.0/24 网段根本从来就没有任何流量，所以就断定肯定是网线插错了。打电话给机房也不太可能，就想着自己修改一下服务器的ip好了，反正是内网ip，即使修改出问题也不会出现连不上的情况，这样至少我远程还可以继续维护。这样，恶梦开始了。。。。<br />

<br><!--more-->★ 解决问题<br />

修改ip是比较简单的，rh下面/etc/sysconfig/network-scripts下面几个文件修改了就好，虽然是修改内网ip，我还是对旧的配置文件做了备份，修改之后，重启了一下网络。<br />

#service network restart<br />

这里也有个小问题，不知道ssh怎么做到重启网络居然可以不掉线的。<br />

重启网络之后，查看了一下ip，已经修改过来了，然后重新查看监控，发现192.168网段的网卡也有流量了，说明修改好了。再次尝试从B执行rsync从A同步数据，发现仍然连不上，A上的tcpdump仍然没有数据，B上面的仍然有回应，rsync的出错提示依然没变。这个问题太奇怪了，无意中发现在B上面监听的时候发现返回数据的主机名似乎不是A的，查看之后发现确实不是，再看同机房的服务器，发现有一台的内网ip和A的192网段的ip一样，B访问的其实是那台电脑的，那台没有开rsyc服务，所以连不上了。至此B访问A有回应的问题知道原因，那么就尝试修改一下A的192网段的ip看看。修改到另外一个ip之后，连接B，发现仍然连不上，从B也连不到A，都提示no route，可是查看route表，似乎没问题啊。到底怎么回事呢？此时突然想起来一个问题，他们不会不在一个机房吧。。。赶紧查看服务器托管信息，确定他们确实不在一起，所以访问不通是正常的。这样问题算找到原因了。<br />

★ 新的问题<br />

上面问题解决大概也没用多少时间，10多分钟的样子吧。正准备休息一下的时候，其他技术人员过来抱怨，说有客户反映A服务器连不上了。我看了一下我的监控，没发现问题。通过沟通之后才知道，客户访问的时候是通过内网ip来访问的，也就是10网段的ip（我的监控只能监控外网ip）。而我因为不知道情况不是刚刚修改了ip么，这也简单，改回去不就行了，况且我修改之前还做了备份呢，这里还庆幸了一下我自己想的周到。<br />

覆盖回去，重启了一下网络，然后让他去测试一下。测试发现依然连不上，我开始觉得有点奇怪了，不是都改回去了么，想起来之前还修改过防火墙，就去恢复了防火墙设置，发现还是不行。用tcpdump监控发现似乎有10网段的ip过来访问，但是似乎没有反馈回去的数据，检查apache的日志发现没有相关的记录。而apache用公网ip访问没有任何问题。<br />

此时就陷入了一个困境，因为我没有办法测试内网是不是还通了。其实这是我经验不足造成的，tcpdump既然能看到10网段过来的ip，那么就说明外面的内网ip连接我们这里是没问题的，那也就说明是我们服务器的问题，不会是网络的问题。<br />

此后将防火墙清空也没有效果，tcpdump监控也一直是只有进来的，没有出去的。其实多次强调只有进来的没有出去的，我也在怀疑是不是服务器拒绝连接了？但是我手里只有这一台服务器，没有办法测试使用内网ip通过别的服务器是否能正常登陆，通过本地访问外网ip是一切正常的，可以看到apache中的日志。<br />

这个时候老大在火车上了，有人已经打电话统治他出问题了。老大给我打电话建议我重启一下服务器。其实他这个建议没有任何意义，重启服务器也就是将重启一下网络，而我已经做过这个操作了。重启还要担一定的风险，如果起不来，还得去机房，那服务就不是停几个小时的问题了。不过没有办法中的办法，而我之前也重启一个测试服务器，没有遇到问题，所以就给服务器重启了，这样我也是争取一点时间，好想想到底哪里的问题。<br />

此时各个小头都已经过来站在我后面了，我都能感觉手都有一点抖了。因为这台服务器是我们的主要业务之一，停几分钟就会损失不少钱，而到现在已经一个小时左右了。<br />

重启没有遇到问题，连接上去之后就是启动服务器上面的一些服务，启动服务之后再次测试，发现问题依然，这也是意料之中的。<br />

头脑发热中，发现来访问我们服务器的内网10网段的ip是10.0.0.0/8网段的，而我们服务器设置的是10.x.x.0/24，难道是这里的问题？修改了一下ip设置，重启了一下网络，然后用tcpdump查看，发现现在我们的服务器对10网段的ip访问有了回应了。一阵兴奋，让技术人员测试一下，发现他依然连不上。查看apache日志，似乎已经有10网段的访问记录了。那还是哪里的问题呢？<br />

其实修改内网网段的时候就想到了，是不是路由的设置问题？这时老大提示了一下，看看之前管理服务器的技术人员留下的文档，我也突然想起来，我之前刚好对这台服务器的设置做过仔细检查，并做了备份，包括ifconfig信息，route信息，dns信息等，查看了一下，发现确实是路由表出问题了，新旧路由表不同。<br />

★ 解决新的问题<br />

发现问题所在就好了，接下来就是修改路由表。先修改内网ip的网段，改回10.x.x.0/24，然后修改10.0.0.0/8网段的ip的路由。修改的时候出现了对route命令不熟悉的问题，route add default gw添加了默认路由，发现不行，改来改去，手一抖，在只剩一条默认路由的情况下，执行了route del default gw命令，这样把服务器的网络给废掉了。。。<br />

赶紧打电话联系深圳机房，花了十几二十分钟，最终联系到了机房的工作人员，可是新的问题又来了，我这里的信息没有机架位置，服务器编号等，只有ip又不能确定是哪台，还好工作人员比较好，根据我提供的服务器牌子等一些信息，找到了一台服务器。接上显示器之后，他说没有任何显示。然后说给重启了吧。其实这里他也要担一定的风险，如果这台不是我们的，他也得等着被别人投诉（不过他倒是可以有推脱的理由，可以说对方服务器莫名重启）。启动的过程很让人焦心，现在离已经过去快2个小时了，如果还不能尽快解决，恐怕我留在这个公司的时间也不多了，呵呵。<br />

启动还算顺利，我能登陆服务器了。先启动各服务，测试发现依然连不上。然后我就查看路由，添加了255.0.0.0/8的默认路由，然后tcpdump查看，收发包正常，查看apache日志，记录也正常。让技术人员测试，也正常了。<br />

至此，问题总算解决了。时间已经过去2个多小时了，才发现自己口干舌噪。<br />

★ 总结一下<br />

1) 各服务器配置情况比较混乱，一些特殊设置没有写明，这是导致服务器问题的一个原因。<br />
2) 管理员应该及时对各服务器配置情况做备份，这样即使服务器挂了，也可以参考备份立刻恢复之前的情况。<br />
3) 要相信系统。比如从B服务器rsync连接A服务器的时候，提示连接被拒绝。“被拒绝”说明B服务器的rsync和目的服务器进行了交流，对方不允许你连接，和连接没有响应等是有区别的。而从A服务器的tcpdump中也可以看到根本就没有对方过来的数据包，你也不要怀疑是不是被防火墙挡住了，防火墙挡住tcpdump也可以查看的。<br />
4) 管理员应该对一些常用的命令的所有参数都比较熟悉。比如route，tcpdump，ls，tar，find等等，真正出问题的时候，你觉得还有时间让你去看man来查看某个命令是否能实现某个功能呢？你也不想当着一堆人的面现看吧。<br />
5) 做某个操作前最好先确认一下会不会有问题，尤其是网络和防火墙相关的命令。因为要是设置出了问题，远程控制不了了，你哭都没地哭。但是工作总得做，不能因为怕出问题就不作吧，呵呵，我之前写了一篇如何给系统加防火墙的帖子，可以参考下里面的想法。<br />
6) 压力肯定是有的，就看你怎么面对了，呵呵。平时多花些功夫，出问题了就不会手忙脚乱了。<br />

    </div>

<div class="meta">
    
    <span class="comments"><a href="/178-accident/#disqus_thread">Comments</a></span>
    
</div>
</article>



  <nav id="pagenavi">
    
        <a href="/page/35/" class="prev">Prev</a>
    
    
        <a href="/page/37/" class="next">Next</a>
    
  <div class="center"><a href="/archives/index.html">Blog Archives</a></div>
  </nav>


    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2017
    
    wd
    . Powered by <a href="http://gohugo.io" target="_blank">Hugo</a> |
    Theme is <a href="https://github.com/wd/hugo-fabric">hugo-fabric</a>, fork from <a href="https://github.com/wd/hexo-fabric">hexo-fabric</a> by <a href="https://wdicc.com">me</a>
</div>

    </footer>
    <script src="/js/fabric.js"></script>


</div>
</div>
<script src="/js/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
 
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery);
 
</script>
</body>
</html>
