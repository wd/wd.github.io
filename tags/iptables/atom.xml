<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Iptables on wd and cc</title>
    <link>https://wdicc.com/tags/iptables/atom/index.xml</link>
    <description>Recent content in Iptables on wd and cc</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <atom:link href="https://wdicc.com/tags/iptables/atom/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>端口映射</title>
      <link>https://wdicc.com/portmap/</link>
      <pubDate>Tue, 09 May 2006 00:00:00 +0000</pubDate>
      
      <guid>https://wdicc.com/portmap/</guid>
      <description>★ 需求&lt;br /&gt;

1 只有一个ip，怎么让多台电脑上网？&lt;br /&gt;

只讲一下主机是双网卡的时候怎么解决。windows下面可以使用winroute、wingate或者系统自带的共享网络连接的功能，都可以实现共享上网。linux下面使用iptables一句话就可以实现。&lt;br /&gt;

至于主机是单网卡怎么解决，自己研究研究吧。我只在win下面尝试过用wingate，可是及其不稳定。&lt;br /&gt;

2 怎么将某个端口映射给内网？&lt;br /&gt;

内网某台电脑提供了服务，怎么让外网的用户可以访问呢？某些对外的服务可能会在内网的多台电脑上面提供，这时就需要做端口映射来让这些服务器让外网可以访问。&lt;br /&gt;

&lt;br&gt;&lt;!--more--&gt;★ 解决方法&lt;br /&gt;

1 共享上网&lt;br /&gt;

1) 按照下图连接电脑。&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;isp&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; |&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;gw(用来做网关的电脑，双网卡)&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; |&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;hub(or switch)&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; |&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;---------------------------&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;| &amp;nbsp; &amp;nbsp;&amp;nbsp; | ........ | &amp;nbsp; &amp;nbsp; &amp;nbsp; |&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;pc1 &amp;nbsp; pc2 ......&amp;nbsp; pcx &amp;nbsp;&amp;nbsp; pcy&lt;br /&gt;

gw一个网卡接isp，ip设置为isp告诉你的。另外一个网卡接hub，ip设置为一个内网ip，例如192.168.0.1。&lt;br /&gt;

2) 在gw上面执行如下脚本。&lt;br /&gt;
#------------script start--------&lt;br /&gt;
#!/bin/sh&lt;br /&gt;

IPT=&#34;/sbin/iptables&#34;&lt;br /&gt;

# Internet Interface&lt;br /&gt;
INET_IFACE=&#34;ethx&#34;&lt;br /&gt;
INET_ADDRESS=&#34;x.x.x.x&#34;&lt;br /&gt;

# Local Interface Information&lt;br /&gt;
LOCAL_IFACE=&#34;ethy&#34;&lt;br /&gt;
LOCAL_IP=&#34;192.168.0.1&#34;&lt;br /&gt;
LOCAL_NET=&#34;192.168.0.0/24&#34;&lt;br /&gt;
LOCAL_BCAST=&#34;192.168.0.255&#34;&lt;br /&gt;

#修改从外网网卡出去的包的源地址，好让外网返回的包能正确回来。&lt;br /&gt;
$IPT -t nat -A POSTROUTING -o $INET_IFACE -j SNAT --to-source $INET_ADDRESS&lt;br /&gt;

#打开系统的转发功能&lt;br /&gt;
echo &#34;1&#34; &amp;gt; /proc/sys/net/ipv4/ip_forward&lt;br /&gt;

#----------script end----------&lt;br /&gt;

这样内网的电脑做如下设置后就应该可以上网了。&lt;br /&gt;

ip：&amp;nbsp; 192.168.0.x&lt;br /&gt;
网关: 192.168.0.1&lt;br /&gt;
dns:&amp;nbsp; 和gw的设置一样&lt;br /&gt;

这时的服务器已经具备一个网关的功能，不过内网的电脑想要上网，都必须手动设置ip，想做到自动获取，可以&lt;br /&gt;

2 端口映射&lt;br /&gt;

端口映射需要做的其实就是修改对方发过来包的目的地址和端口，然后帮忙转发一下，并且转发的同时修改一下源地址，好让被转发的电脑认为是gw发的包，处理完毕之后好能正常返回gw，然后由gw在负责转发给外网的ip。端口转发需要用到iptables的nat表，上面这些操作是在PREROUTING和POSTROUTING链之间完成的。&lt;br /&gt;

1) 映射到外网ip&lt;br /&gt;
整个过程可以参考下图。&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;eth0(外网网卡) &amp;nbsp; &amp;nbsp;&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;________________________&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp; | &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;|&lt;br /&gt;
 &amp;nbsp; &amp;nbsp;&amp;nbsp; gw的80端口 &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp; 修改目标地址(DNAT) &amp;nbsp; &amp;nbsp; &amp;nbsp; 修改源地址(SNAT)&lt;br /&gt;
外网ip----------&amp;gt;PREROUTING------------&amp;gt;POSTROUTING------------&amp;gt;外网ip&lt;br /&gt;

所以，例如我们要将对gw 80端口的访问都转发到外网的202.202.202.202这台电脑上面，只需要在上面的脚本中添加下面的语句即可。&lt;br /&gt;

# 修改从外网进来的对80端口访问的数据包的目的地址&lt;br /&gt;
$IPT -t nat -A PREROUTING -p tcp -i $INET_IFACE --destination-port 80 \&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; -j DNAT --to-destination 202.202.202.202&lt;br /&gt;

那么，你可能要问，按照上面的说法，这样只修改了目的地址，还要修改源地址啊，这样包才能正确返回到gw。问的好，不过其实我们已经做了这个设置了，聪明的你可能已经想到了，就是上面让内网ip可以上网的那个脚本里的一句语句已经实现了这个功能。&lt;br /&gt;

#修改从外网网卡出去的包的源地址，好让外网返回的包能正确回来。&lt;br /&gt;
$IPT -t nat -A POSTROUTING -o $INET_IFACE -j SNAT --to-source $INET_ADDRESS&lt;br /&gt;

就是上面这句，他把所有从外网网卡出去的包的源地址都修改了，当然也包括去往202.202.202.202的80端口的包。&lt;br /&gt;

2) 映射到内网ip&lt;br /&gt;
整个过程可以参考下图。&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;eth0(外网网卡) &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;eth0(内网网卡)&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;________________________ &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;_______________________&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp; | &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;| &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;| &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp; |&lt;br /&gt;
 &amp;nbsp; &amp;nbsp;&amp;nbsp; gw的80端口 &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp; 修改目标地址(DNAT) &amp;nbsp; &amp;nbsp; &amp;nbsp; 修改源地址(SNAT) &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp; 修改源地址(SNAT)&lt;br /&gt;
外网ip----------&amp;gt;PREROUTING------------&amp;gt;POSTROUTING------------&amp;gt;PREROUTING-----------&amp;gt;POSTROUTING-----------&amp;gt;内网ip&lt;br /&gt;

所以，例如我们要映射80端口到内网的192.168.1.80这台电脑上面，只需要在上面的脚本中添加下面的语句即可。&lt;br /&gt;

# 修改从外网进来的对80端口访问的数据包的目的地址&lt;br /&gt;
$IPT -t nat -A PREROUTING -p tcp -i $INET_IFACE --destination-port 80 \&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; -j DNAT --to-destination 192.168.1.80&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; &lt;br /&gt;
# 修改从内网网卡出去的所有数据包源地址&lt;br /&gt;
$IPT -t nat -A POSTROUTING -o $LOCAL_IFACE \&lt;br /&gt;
 &amp;nbsp; &amp;nbsp; -j SNAT --to-source $LOCAL_IP&lt;br /&gt;

这个比上面多了一句，意思相信你已经明白了吧。因为访问内网ip的时候走了内网网卡，所以还需要对从内网网卡出去的包修改一下源地址。&lt;br /&gt;
</description>
    </item>
    
    <item>
      <title>为远程服务器设置防火墙</title>
      <link>https://wdicc.com/iptables-on-remote-server/</link>
      <pubDate>Thu, 20 Apr 2006 00:00:00 +0000</pubDate>
      
      <guid>https://wdicc.com/iptables-on-remote-server/</guid>
      <description>如果服务器不在本地，又需要对防火墙做设置的时候，操作一定要注意，&lt;br /&gt;
</description>
    </item>
    
  </channel>
</rss>