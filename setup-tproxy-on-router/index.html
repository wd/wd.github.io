<!doctype html><html lang=en><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://wdicc.com/favicon.ico><title>Setup Tproxy on Router | wd and cc</title><meta name=title content="Setup Tproxy on Router"><meta name=description content="使用了一段时间的 wireguard 之后，使用的时候时不时总是会断一会，我感觉体验不是很好。所以想换回使用 v2ray 了。当然 wireguard 还是继续作为国内回家使用。和国外的 tunnel 就换 v2ray 了。

首先需要做的就是调整原来的那套方案里面的出国线路。

把 ipset/dnsmasq/iptables 相关的配置删掉。
把 hotplug 里面关于 ip rule add fwmark 的部分删掉。相关 route 还是需要留着，因为我还需要在家之外的网络连回家。
吧 wireguard 里面和 VPS 的连接也去掉。

这一顿操作之后，出国应该就挂了。接下来就配置透明代理。"><meta name=keywords content="gfw,router,tproxy,"><meta property="og:url" content="https://wdicc.com/setup-tproxy-on-router/"><meta property="og:site_name" content="wd and cc"><meta property="og:title" content="Setup Tproxy on Router"><meta property="og:description" content="使用了一段时间的 wireguard 之后，使用的时候时不时总是会断一会，我感觉体验不是很好。所以想换回使用 v2ray 了。当然 wireguard 还是继续作为国内回家使用。和国外的 tunnel 就换 v2ray 了。
首先需要做的就是调整原来的那套方案里面的出国线路。
把 ipset/dnsmasq/iptables 相关的配置删掉。 把 hotplug 里面关于 ip rule add fwmark 的部分删掉。相关 route 还是需要留着，因为我还需要在家之外的网络连回家。 吧 wireguard 里面和 VPS 的连接也去掉。 这一顿操作之后，出国应该就挂了。接下来就配置透明代理。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-28T12:00:46+08:00"><meta property="article:modified_time" content="2023-05-28T12:00:46+08:00"><meta property="article:tag" content="Gfw"><meta property="article:tag" content="Router"><meta property="article:tag" content="Tproxy"><meta name=twitter:card content="summary"><meta name=twitter:title content="Setup Tproxy on Router"><meta name=twitter:description content="使用了一段时间的 wireguard 之后，使用的时候时不时总是会断一会，我感觉体验不是很好。所以想换回使用 v2ray 了。当然 wireguard 还是继续作为国内回家使用。和国外的 tunnel 就换 v2ray 了。
首先需要做的就是调整原来的那套方案里面的出国线路。
把 ipset/dnsmasq/iptables 相关的配置删掉。 把 hotplug 里面关于 ip rule add fwmark 的部分删掉。相关 route 还是需要留着，因为我还需要在家之外的网络连回家。 吧 wireguard 里面和 VPS 的连接也去掉。 这一顿操作之后，出国应该就挂了。接下来就配置透明代理。"><meta itemprop=name content="Setup Tproxy on Router"><meta itemprop=description content="使用了一段时间的 wireguard 之后，使用的时候时不时总是会断一会，我感觉体验不是很好。所以想换回使用 v2ray 了。当然 wireguard 还是继续作为国内回家使用。和国外的 tunnel 就换 v2ray 了。
首先需要做的就是调整原来的那套方案里面的出国线路。
把 ipset/dnsmasq/iptables 相关的配置删掉。 把 hotplug 里面关于 ip rule add fwmark 的部分删掉。相关 route 还是需要留着，因为我还需要在家之外的网络连回家。 吧 wireguard 里面和 VPS 的连接也去掉。 这一顿操作之后，出国应该就挂了。接下来就配置透明代理。"><meta itemprop=datePublished content="2023-05-28T12:00:46+08:00"><meta itemprop=dateModified content="2023-05-28T12:00:46+08:00"><meta itemprop=wordCount content="870"><meta itemprop=keywords content="Gfw,Router,Tproxy"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--code-background-color:#f2f2f2;--code-color:#222;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--code-background-color:#000;--code-color:#ddd;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px}blockquote{border-left:1px solid #999;color:var(--code-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto !important}.highlight,.code{padding:1px 15px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>wd and cc</h2></a><p>-- Good good study, day day up!</p><nav><a href=/>Home</a>
<a href=/posts/>Posts</a>
<a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a>
<a href=/tags/>Tags</a>
<a href=/atom.xml>subscribe</a></nav></header><main><h1>Setup Tproxy on Router</h1><p><i><time datetime=2023-05-28>28 May, 2023
</time></i><a href=https://wdicc.com/tags/gfw/>#Gfw</a>
<a href=https://wdicc.com/tags/router/>#Router</a>
<a href=https://wdicc.com/tags/tproxy/>#Tproxy</a></p><content><p>使用了一段时间的 <a href=/setup-policy-route-on-openwrt-x86-with-wireguard/>wireguard</a> 之后，使用的时候时不时总是会断一会，我感觉体验不是很好。所以想换回使用 v2ray 了。当然 wireguard 还是继续作为国内回家使用。和国外的 tunnel 就换 v2ray 了。</p><p>首先需要做的就是调整原来的那套方案里面的出国线路。</p><ol><li>把 ipset/dnsmasq/iptables 相关的配置删掉。</li><li>把 hotplug 里面关于 ip rule add fwmark 的部分删掉。相关 route 还是需要留着，因为我还需要在家之外的网络连回家。</li><li>吧 wireguard 里面和 VPS 的连接也去掉。</li></ol><p>这一顿操作之后，出国应该就挂了。接下来就配置透明代理。</p><p>> 如果是想要新配置一台，那按说不需要参考那个文章。如果想要配置 wireguard 给手机什么的使用，可以参考那个。</p><p>透明代理的思路主要就是通过 iptables 劫持所有流量转发给 v2ray，然后 v2ray 对流量进行分发。实现思路放到了 <a href=https://github.com/wd/f-k-g-f-w/tree/master/router-tproxy>Github</a>，router 要注意这个实现下 router 本机并不能翻墙。解释下实现。</p><p>对于 <code class=verbatim>run.sh</code></p><ol><li>L16, L17 增加一条策略，把 iptables 打了 fwmark 1 的流量能让他路由到 v2ray。这条很重要，否则 v2ray 收不到 TCP 流量。</li><li>L28, L29 不处理非 53 端口的本地流量，需要把 DNS 请求也让 v2ray 处理。也可以选择不转发 DNS 流量。而是通过另外的 DNS 程序来解决污染问题，如果这样那可能会需要实现本机翻墙的问题。</li><li>L35，L36 只处理从 lan 和 wg0 进来的流量。这个在其他的文档里面一般并没有 <code class=verbatim>-i</code> 这个参数。我这里加上这个参数主要是避免花时间折腾可能存在环形流量。</li></ol><p>对于 <code class=verbatim>config.json</code></p><ol><li>Inbound 部分没啥好说的。</li><li><p>DNS 部分很重要。因为之前把 DNS 流量都导入到了 v2ray，所以需要 v2ray 能处理好 dns 请求。</p><ol><li>我全都设置了只返回 IPV4 的 ip，因为 iptables 里面没有处理 ipv6 的流量。</li><li>国外 dns 使用 DoH，使用 udp 会遇到不能正常解析的问题。我换 DoH 之后就稳定多了。</li><li>L71 需要配置为自己的 vps 的 domain。如果是使用 https 之类的 transport 就会需要使用域名，这里配置好这个域名走国内的 dns。</li></ol></li><li><p>Outbound 部分除了正常的 proxy 之外，还需要配置一个 dns-out。</p><ol><li>对于 dns-out，流量大概是 iptables -> inbound(dokodemo-door) -> routing L113 -> outbound(dns-out) -> 内置 DNS L46 -> routing。整个就是会走两遍 routing。</li><li>dns-out 配置使用 proxy。dns-out 默认只会把 A 和 AAAA 的请求做转发，其他流量会放走。所以如果不配置 proxy，这些类型的 dns 请求会发送给你的 isp。</li></ol></li><li>routing 走的是白名单模式。最后一条兜底的是 L181 把流量都转发给 proxy。</li></ol></content></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>