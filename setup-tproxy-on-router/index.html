<!doctype html><html lang=en><head><title>Setup Tproxy on Router &ndash; wd and cc</title>
<meta name=description content="Good good study, day day up!"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://wdicc.com/css/palettes/base16-dark.css><link rel=stylesheet href=https://wdicc.com/css/risotto.css><link rel=stylesheet href=https://wdicc.com/css/custom.css><link rel=icon href=https://wdicc.com/favicon.ico></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><h1 class=page__logo><a href=https://wdicc.com/ class=page__logo-inner>wd and cc</a></h1><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/posts/ title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=" title>Search</a></li><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/atom.xml title>subscribe</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Setup Tproxy on Router</h1></header><div class=content__body><p>使用了一段时间的 <a href=/setup-policy-route-on-openwrt-x86-with-wireguard/>wireguard</a> 之后，使用的时候时不时总是会断一会，我感觉体验不是很好。所以想换回使用 v2ray 了。当然 wireguard 还是继续作为国内回家使用。和国外的 tunnel 就换 v2ray 了。</p><p>首先需要做的就是调整原来的那套方案里面的出国线路。</p><ol><li>把 ipset/dnsmasq/iptables 相关的配置删掉。</li><li>把 hotplug 里面关于 ip rule add fwmark 的部分删掉。相关 route 还是需要留着，因为我还需要在家之外的网络连回家。</li><li>吧 wireguard 里面和 VPS 的连接也去掉。</li></ol><p>这一顿操作之后，出国应该就挂了。接下来就配置透明代理。</p><p>> 如果是想要新配置一台，那按说不需要参考那个文章。如果想要配置 wireguard 给手机什么的使用，可以参考那个。</p><p>透明代理的思路主要就是通过 iptables 劫持所有流量转发给 v2ray，然后 v2ray 对流量进行分发。实现思路放到了 <a href=https://github.com/wd/f-k-g-f-w/tree/master/router-tproxy>Github</a>，router 要注意这个实现下 router 本机并不能翻墙。解释下实现。</p><p>对于 <code class=verbatim>run.sh</code></p><ol><li>L16, L17 增加一条策略，把 iptables 打了 fwmark 1 的流量能让他路由到 v2ray。这条很重要，否则 v2ray 收不到 TCP 流量。</li><li>L28, L29 不处理非 53 端口的本地流量，需要把 DNS 请求也让 v2ray 处理。也可以选择不转发 DNS 流量。而是通过另外的 DNS 程序来解决污染问题，如果这样那可能会需要实现本机翻墙的问题。</li><li>L35，L36 只处理从 lan 和 wg0 进来的流量。这个在其他的文档里面一般并没有 <code class=verbatim>-i</code> 这个参数。我这里加上这个参数主要是避免花时间折腾可能存在环形流量。</li></ol><p>对于 <code class=verbatim>config.json</code></p><ol><li>Inbound 部分没啥好说的。</li><li><p>DNS 部分很重要。因为之前把 DNS 流量都导入到了 v2ray，所以需要 v2ray 能处理好 dns 请求。</p><ol><li>我全都设置了只返回 IPV4 的 ip，因为 iptables 里面没有处理 ipv6 的流量。</li><li>国外 dns 使用 DoH，使用 udp 会遇到不能正常解析的问题。我换 DoH 之后就稳定多了。</li><li>L71 需要配置为自己的 vps 的 domain。如果是使用 https 之类的 transport 就会需要使用域名，这里配置好这个域名走国内的 dns。</li></ol></li><li><p>Outbound 部分除了正常的 proxy 之外，还需要配置一个 dns-out。</p><ol><li>对于 dns-out，流量大概是 iptables -> inbound(dokodemo-door) -> routing L113 -> outbound(dns-out) -> 内置 DNS L46 -> routing。整个就是会走两遍 routing。</li><li>dns-out 配置使用 proxy。dns-out 默认只会把 A 和 AAAA 的请求做转发，其他流量会放走。所以如果不配置 proxy，这些类型的 dns 请求会发送给你的 isp。</li></ol></li><li>routing 走的是白名单模式。最后一条兜底的是 L181 把流量都转发给 proxy。</li></ol></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://wdicc.com/favicon.ico alt=Logo><h1 class=about__title>Happy every day!</h1><p class=about__description>Good good study, day day up!</p></div><ul class=aside__social-links><li><a href=https://github.com/wd rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2023-05-28</p></div></section><footer class=page__footer><p><br><span class=active>$ echo $LANG<br><b>zh_CN</b></span><br></p><br><br><p class=copyright>wd © 2025</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>