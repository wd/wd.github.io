<!doctype html><html lang=en><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://wdicc.com/favicon.ico><title>Django Testing | wd and cc</title><meta name=title content="Django Testing"><meta name=description content="Django 自己的 unittest 支持的挺好，一般只需要在 app 下面加一个 tests.py 在里面写 case 就可以了。case 对应的类继承 django.test.TestCase 就好。

这个 django.test.TestCase 继承自 unittest.TestCase ，django 这个多了一个自动使用事务的功能，所以用 django 这个的话，每个测试用例执行前后会自动回滚数据库操作，这样不用你自己 cleanup 数据，还比较方便。"><meta name=keywords content="django,"><meta property="og:url" content="https://wdicc.com/django-testing/"><meta property="og:site_name" content="wd and cc"><meta property="og:title" content="Django Testing"><meta property="og:description" content="Django 自己的 unittest 支持的挺好，一般只需要在 app 下面加一个 tests.py 在里面写 case 就可以了。case 对应的类继承 django.test.TestCase 就好。
这个 django.test.TestCase 继承自 unittest.TestCase ，django 这个多了一个自动使用事务的功能，所以用 django 这个的话，每个测试用例执行前后会自动回滚数据库操作，这样不用你自己 cleanup 数据，还比较方便。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-06-19T15:38:56+08:00"><meta property="article:modified_time" content="2019-06-19T15:38:56+08:00"><meta property="article:tag" content="Django"><meta name=twitter:card content="summary"><meta name=twitter:title content="Django Testing"><meta name=twitter:description content="Django 自己的 unittest 支持的挺好，一般只需要在 app 下面加一个 tests.py 在里面写 case 就可以了。case 对应的类继承 django.test.TestCase 就好。
这个 django.test.TestCase 继承自 unittest.TestCase ，django 这个多了一个自动使用事务的功能，所以用 django 这个的话，每个测试用例执行前后会自动回滚数据库操作，这样不用你自己 cleanup 数据，还比较方便。"><meta itemprop=name content="Django Testing"><meta itemprop=description content="Django 自己的 unittest 支持的挺好，一般只需要在 app 下面加一个 tests.py 在里面写 case 就可以了。case 对应的类继承 django.test.TestCase 就好。
这个 django.test.TestCase 继承自 unittest.TestCase ，django 这个多了一个自动使用事务的功能，所以用 django 这个的话，每个测试用例执行前后会自动回滚数据库操作，这样不用你自己 cleanup 数据，还比较方便。"><meta itemprop=datePublished content="2019-06-19T15:38:56+08:00"><meta itemprop=dateModified content="2019-06-19T15:38:56+08:00"><meta itemprop=wordCount content="1506"><meta itemprop=keywords content="Django"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--code-background-color:#f2f2f2;--code-color:#222;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--code-background-color:#000;--code-color:#ddd;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px}blockquote{border-left:1px solid #999;color:var(--code-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{padding:1px 15px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>wd and cc</h2></a><p>-- Good good study, day day up!</p><nav><a href=/>Home</a>
<a href=/posts/>Posts</a>
<a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a>
<a href=/tags/>Tags</a>
<a href=/atom.xml>subscribe</a></nav></header><main><h1>Django Testing</h1><p><i><time datetime=2019-06-19>19 Jun, 2019
</time></i><a href=https://wdicc.com/tags/django/>#Django</a></p><content><p>Django 自己的 unittest 支持的挺好，一般只需要在 app 下面加一个 tests.py 在里面写 case 就可以了。case 对应的类继承 <code class=verbatim>django.test.TestCase</code> 就好。</p><p>这个 <code class=verbatim>django.test.TestCase</code> 继承自 <code class=verbatim>unittest.TestCase</code> ，django 这个多了一个自动使用事务的功能，所以用 django 这个的话，每个测试用例执行前后会自动回滚数据库操作，这样不用你自己 cleanup 数据，还比较方便。</p><div id=outline-container-headline-1 class=outline-3><h3 id=headline-1>setUp 和 tearDown</h3><div id=outline-text-headline-1 class=outline-text-3><p>每一个测试类里面，都可以有一个 <code class=verbatim>setUp</code> 方法，是在 case 方法执行前执行，例如一些准备工作，和一个 <code class=verbatim>tearDown</code> 方法，在 case 执行之后执行，例如一些清理工作。还可以有若干个使用 <code class=verbatim>test_</code> 开头的测试用例，这些 <code class=verbatim>setUp</code> 其实类似于把每个测试用例里面共同的部分提取出来一样，不过是不用你在每个 case 里面单独调用了，会自动处理。</p></div></div><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>setUpClass 和 tearDownClass</h3><div id=outline-text-headline-2 class=outline-text-3><p>django 还提供了 <code class=verbatim>setUpClass</code> 和 <code class=verbatim>tearDownClass</code> ，类似上面的 <code class=verbatim>setUp</code> 方法，不过这个是每个 class 只会执行一次。另外按照<a href=https://medium.com/@nhatcuong/django-test-fixture-setup-setupclass-and-setuptestdata-72b6d944cdef>这里</a>的说法， <code class=verbatim>setUpClass</code> 不会使用事务，不过我看源码(django 2.1.4) 好像是会的，我没测试。。</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>    <span style=color:#555;font-weight:700>@classmethod</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>setUpClass</span>(<span style=color:#007020>cls</span>):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#007020>super</span>()<span style=color:#666>.</span>setUpClass()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#007020;font-weight:700>if</span> <span style=color:#007020;font-weight:700>not</span> connections_support_transactions():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            <span style=color:#007020;font-weight:700>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#007020>cls</span><span style=color:#666>.</span>cls_atomics <span style=color:#666>=</span> <span style=color:#007020>cls</span><span style=color:#666>.</span>_enter_atomics()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#007020;font-weight:700>if</span> <span style=color:#007020>cls</span><span style=color:#666>.</span>fixtures:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            <span style=color:#007020;font-weight:700>for</span> db_name <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>cls</span><span style=color:#666>.</span>_databases_names(include_mirrors<span style=color:#666>=</span><span style=color:#007020;font-weight:700>False</span>):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                <span style=color:#007020;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>                    call_command(<span style=color:#4070a0>&#39;loaddata&#39;</span>, <span style=color:#666>*</span><span style=color:#007020>cls</span><span style=color:#666>.</span>fixtures, <span style=color:#666>**</span>{<span style=color:#4070a0>&#39;verbosity&#39;</span>: <span style=color:#40a070>0</span>, <span style=color:#4070a0>&#39;database&#39;</span>: db_name})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>                <span style=color:#007020;font-weight:700>except</span> <span style=color:#007020>Exception</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                    <span style=color:#007020>cls</span><span style=color:#666>.</span>_rollback_atomics(<span style=color:#007020>cls</span><span style=color:#666>.</span>cls_atomics)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>                    <span style=color:#007020;font-weight:700>raise</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#007020;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            <span style=color:#007020>cls</span><span style=color:#666>.</span>setUpTestData()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#007020;font-weight:700>except</span> <span style=color:#007020>Exception</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            <span style=color:#007020>cls</span><span style=color:#666>.</span>_rollback_atomics(<span style=color:#007020>cls</span><span style=color:#666>.</span>cls_atomics)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#007020;font-weight:700>raise</span></span></span></code></pre></div></div><p>代码可以看到，还有一个 <code class=verbatim>setUpTestData</code> 可以用。如果只是准备数据库数据的话，感觉后面这个更精准一点。</p></div></div><div id=outline-container-headline-3 class=outline-3><h3 id=headline-3>测试用例</h3><div id=outline-text-headline-3 class=outline-text-3><p>case 我觉得一般可以分两种，方法测试，和接口测试。</p><p>方法测试指针对一些工具方法什么的测试，当然这个说法并不严谨，将就理解吧。我把这些归类为不涉及到数据库操作的测试。</p><p>接口测试，一般会涉及到数据库操作，需要验证登录啊，参数什么的。</p><p>Django 里面，每个测试用例之间是通过事务互相隔离的，所以不用担心互相之间会有影响。</p><p>接口测试可以通过 <code class=verbatim>django.test.Client</code> 来访问你的接口，然后比对返回结果，或者比对数据库的数据来验证。</p></div></div><div id=outline-container-headline-4 class=outline-3><h3 id=headline-4>fixtures</h3><div id=outline-text-headline-4 class=outline-text-3><p>有时候一些接口是依赖已有数据的，比如一个返回所有用户的接口，那测试的时候数据库是需要有用户才能返回的。这个可以通过 fixture 来 moke 数据。</p><p><code class=verbatim>fixture</code> 就是一些 json 文件，里面放的是和 model 的数据，这样一个测试如果需要某几个 model 对应的表里面事先有数据，那可以把他们放到 fixture 文件里面，让 django 在运行之前先 load 到数据库就可以了。</p><p>这些 json 文件自己编写会死，Django 提供了 <code class=verbatim>manage.py dumpdata --indent 4 [app_label[.ModelName] [app_label[.ModelName]</code> 功能，可以方便你导出数据库里面已有的数据。不指定 app_label 和 modelname 就会导出全部的，一般只导出自己需要的就好。注意 json 文件是可以支持缩进的。</p><p>如果从比如开发库之类的倒数据，会觉得数据有点乱，从测试库倒数据似乎比较清净，因为每次测试都是一个空的数据库。有一个方法是在测试用例里面创建依赖的数据，但是测试执行完了再执行 <code class=verbatim>manage.py dumpdata</code> 已经什么数据都没有了。这个时候可以在测试用例里面使用 <code class=verbatim>django.core.management.call_command</code> 来执行 dump，例如</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>call_command(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#4070a0>&#39;dumpdata&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#4070a0>&#39;--indent&#39;</span>, <span style=color:#4070a0>&#39;4&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#4070a0>&#39;app_label&#39;</span>, <span style=color:#4070a0>&#39;ModelName&#39;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#4070a0>&#39;app_label&#39;</span>, <span style=color:#4070a0>&#39;ModelName&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>)</span></span></code></pre></div></div><p>这个其实类似前面 <code class=verbatim>setUpClass</code> 里面的加载 fixtures 的代码用了类似的方法 <code class=verbatim>call_command('loaddata', *cls.fixtures, **{'verbosity': 0, 'database': db_name})</code> 。</p><p>命令行执行测试的时候，会打印出来 dump 出来的数据，把他们存到一个 json 文件然后引入就可以了。</p></div></div><div id=outline-container-headline-5 class=outline-3><h3 id=headline-5>给测试提速</h3><div id=outline-text-headline-5 class=outline-text-3><p>有一个提升测试速度的方法，是使用 <code class=verbatim>-k</code> 参数，这个参数会保留测试的数据库，不会每次都删除重建，这样节省一些时间。</p><p>还可以使用 <code class=verbatim>--parallel N</code> 参数来增加并行数量。如果你用 coverage 那整个命令是类似这样的 <code class=verbatim>coverage run --parallel-mode --concurrency=multiprocessing manage.py test -k --parallel 3</code> 。使用并行之后，会发现 coverage 不工作了，这是因为并行的时候，每个线程都会单独写一个 coverage 结果文件，所以执行 <code class=verbatim>coverage report</code> 之前，执行一下 <code class=verbatim>coverage combine</code> 合并到一个文件就可以了。</p><p>Django 还是做的挺不错的。测试这么方便，实际很适合使用 TDD 方式开发。</p></div></div><div id=outline-container-headline-6 class=outline-3><h3 id=headline-6>其他</h3><div id=outline-text-headline-6 class=outline-text-3><p>看到<a href=https://adamj.eu/tech/2019/07/15/djangos-test-case-classes-and-a-three-times-speed-up/>一篇文章</a>，从 <code>TransactionTestCase</code> 替换到 <code>TestCase</code> 速度提升了 3 倍。</p><p>Django 里面有三个测试类</p><ol><li><code>SimpleTestCase</code> 是最简单的。提供 <code>unittest.TestCase</code> 基础的功能。默认屏蔽了数据库的访问，因为对数据库里面的修改没有隔离，所以应该在没有数据库操作的时候使用他。</li><li><code>TransactionTestCase</code> 继承自 <code>SimpleTestCase</code> ，允许数据库操作，测试完毕之后会删除数据库里面的所有数据。会比较慢。</li><li><code>TestCase</code> 是我们平时用的。继承自 <code>TransactionTestCase</code> ，使用事务来回滚所有操作，这样比遍历所有表快一点，这样你的操作也不能真实的提交，但是我们跑测试的时候一般也不需要提交。</li></ol><p><code>TransactionTestCase</code> 允许你的代码自己使用和管理事务， <code>TestCase</code> 自己使用了事务。</p></div></div></content><div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//wdicc.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>