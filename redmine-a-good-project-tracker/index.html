<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>redmine-a-good-project-tracker - wd and cc</title>
    <meta name="author" content="wd">
    
	<meta name="description" content="&lt;p&gt;其实很早，大概2，3年前就听说了 redmine 了，不过他环境是 ruby 的，一直没有勇气去搭一个环境。现在项目人多了，bug 阿 feature 阿，就需要记录一下了，因为有些事情不记录下来总是会忘记。之前是尝试通过 wiki ＋ bugfree 来记录的，bugfree 记录在提测之后的一些问题，wiki 记录一些 feature request 什么的。bugfree 我们没权限管理，wiki 记录又不方便，然后我就又想起来 redmine 了。&lt;/p&gt;
&lt;p&gt;哦对，其实公司还提供了一个 jira 给大家用，我用了几次我觉得那玩意太难用了，和那个 confluence 的 wiki 一样难用。&lt;/p&gt;
&lt;p&gt;本身搭建没什么难度，编译一个 ruby，然后 gem 安装几个包，下载 redmine，使用 rake 命令操作就好了。启动他的 server 之后，就可以访问了。下面几个东西是我花了一些时间配置的。&lt;/p&gt;
&lt;h2 id=&quot;和-ldap-集成&quot;&gt;&lt;a href=&quot;#和-ldap-集成&quot; class=&quot;headerlink&quot; title=&quot;和 ldap 集成&quot;&gt;&lt;/a&gt;和 ldap 集成&lt;/h2&gt;&lt;p&gt;在 redmine 的设置里面，本身是有一项和 redmine 集成的功能的，设置 basedn，和下面的 attributes 内容（sAMAccountName,givenName,sN,mail)就可以了。点测试，得能通过。&lt;/p&gt;
&lt;p&gt;在我这里，光设置这个还不行，还需要 hack 一段代码。注意下面的那个 &lt;code&gt;@xxxx.com&lt;/code&gt;，这个对应你自己的。&lt;/p&gt;
&lt;figure class=&quot;highlight diff&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;ndex: app/models/auth_source_ldap.rb&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;===================================================================&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;--- app/models/auth_source_ldap.rb	(版本 10947)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;+++ app/models/auth_source_ldap.rb	(工作副本)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@@ -135,11 +135,12 @@&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   # Get the user&#39;s dn and any attributes for them, given their login&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   def get_user_dn(login, password)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ldap_con = nil&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-    if self.account &amp;amp;&amp;amp; self.account.include?(&quot;$login&quot;)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-      ldap_con = initialize_ldap_con(self.account.sub(&quot;$login&quot;, Net::LDAP::DN.escape(login)), password)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-    else&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-      ldap_con = initialize_ldap_con(self.account, self.account_password)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-    end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+    ldap_con = initialize_ldap_con(login + &#39;@xxxxx.com&#39;, password)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+    #if self.account &amp;amp;&amp;amp; self.account.include?(&quot;$login&quot;)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+    #  ldap_con = initialize_ldap_con(self.account.sub(&quot;$login&quot;, Net::LDAP::DN.escape(login)), password)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+    #else&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+    #  ldap_con = initialize_ldap_con(self.account, self.account_password)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+    #end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     login_filter = Net::LDAP::Filter.eq( self.attr_login, login )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     object_filter = Net::LDAP::Filter.eq( &quot;objectClass&quot;, &quot;*&quot; )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     attrs = &amp;#123;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@@ -149,6 +150,8 @@&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;       search_filter = search_filter &amp;amp; f&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     end&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+    logger.debug &quot;------------get_user_dn #&amp;#123;login&amp;#125; #&amp;#123;self.base_dn&amp;#125; #&amp;#123;search_filter&amp;#125; #&amp;#123;search_attributes&amp;#125;&quot; if logger &amp;amp;&amp;amp; logger.debug?&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     ldap_con.search( :base =&amp;gt; self.base_dn,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                      :filter =&amp;gt; search_filter,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                      :attributes=&amp;gt; search_attributes) do |entry|&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;总之登陆验证的代码关键就在这里了，可以自己做尝试，建议先写最简单的代码测试。比如&lt;/p&gt;
&lt;figure class=&quot;highlight ruby&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;rubygems&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;net/ldap&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ldap = Net::LDAP.new &lt;span class=&quot;symbol&quot;&gt;:host&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&#39;qunarldap.corp.qunar.com&#39;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &lt;span class=&quot;symbol&quot;&gt;:port&lt;/span&gt; =&amp;gt; &lt;span class=&quot;number&quot;&gt;389&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &lt;span class=&quot;symbol&quot;&gt;:auth&lt;/span&gt; =&amp;gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &lt;span class=&quot;symbol&quot;&gt;:method&lt;/span&gt; =&amp;gt; &lt;span class=&quot;symbol&quot;&gt;:simple&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &lt;span class=&quot;symbol&quot;&gt;:username&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;wd@xxxx.com&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           &lt;span class=&quot;symbol&quot;&gt;:password&lt;/span&gt; =&amp;gt; &lt;span class=&quot;string&quot;&gt;&quot;pwd&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;filter = Net::LDAP::Filter.eq(&lt;span class=&quot;string&quot;&gt;&quot;sAMAccountName&quot;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&quot;wd*&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;object_filter = Net::LDAP::Filter.eq( &lt;span class=&quot;string&quot;&gt;&quot;objectClass&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;*&quot;&lt;/span&gt; )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;search_filter = filter &amp;amp; object_filter&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;treebase = &lt;span class=&quot;string&quot;&gt;&quot;你的 basedn&quot;&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;#&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;attr = [&lt;span class=&quot;string&quot;&gt;&quot;dn&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;givenName&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;sN&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;mail&quot;&lt;/span&gt;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ldap.search(&lt;span class=&quot;symbol&quot;&gt;:base&lt;/span&gt; =&amp;gt; treebase, &lt;span class=&quot;symbol&quot;&gt;:filter&lt;/span&gt; =&amp;gt; search_filter, &lt;span class=&quot;symbol&quot;&gt;:attributes&lt;/span&gt; =&amp;gt; attr ) &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;|entry|&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  puts &lt;span class=&quot;string&quot;&gt;&quot;DN: &lt;span class=&quot;subst&quot;&gt;#&amp;#123;entry.dn&amp;#125;&lt;/span&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  entry.each &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;|attribute, values|&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    puts &lt;span class=&quot;string&quot;&gt;&quot;   &lt;span class=&quot;subst&quot;&gt;#&amp;#123;attribute&amp;#125;&lt;/span&gt;:&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    values.each &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;|value|&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      puts &lt;span class=&quot;string&quot;&gt;&quot;      ---&amp;gt;&lt;span class=&quot;subst&quot;&gt;#&amp;#123;value&amp;#125;&lt;/span&gt;&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;p ldap.get_operation_result&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;搞定这块，就可以通过 ldap 用户直接登陆了，登陆会自动创建用户。&lt;/p&gt;
&lt;h2 id=&quot;通过回复邮件自动创建和更新-issue&quot;&gt;&lt;a href=&quot;#通过回复邮件自动创建和更新-issue&quot; class=&quot;headerlink&quot; title=&quot;通过回复邮件自动创建和更新 issue&quot;&gt;&lt;/a&gt;通过回复邮件自动创建和更新 issue&lt;/h2&gt;&lt;p&gt;用过 bugzilla 的都知道，可以通过邮件回复的方式来 comment issue。redmine 也提供了这个功能。我这种对 mail 服务器无权的用户，只能申请一个邮箱专门做这个事情了。公司邮箱是 exchange 的，没有打开 imap。redmine 只提供了 imap，pop 之类的方式。好在还有 davmail。先配置好一个 davmail，然后通过 imap 来做这个事情，imap 比 pop 好处多很多，比如可以指定 inbox，可以 move 到 read 之类，就不多说了。&lt;/p&gt;
&lt;p&gt;crontab 指令大概如下。&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;LOG=/&lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt;/redmine/&lt;span class=&quot;built_in&quot;&gt;log&lt;/span&gt;/mail_recieve.log&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;start &lt;span class=&quot;variable&quot;&gt;$(date)&lt;/span&gt;&quot;&lt;/span&gt; &amp;gt;&amp;gt; &lt;span class=&quot;variable&quot;&gt;$LOG&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;/usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/ruby/bin/rake --silent &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; /&lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt;/redmine/Rakefile redmine:email:receive_imap RAILS_ENV=&lt;span class=&quot;string&quot;&gt;&quot;production&quot;&lt;/span&gt; host=localhost username=abc password=def port=1143 move_on_success=&lt;span class=&quot;built_in&quot;&gt;read&lt;/span&gt; move_on_failure=failed unknown_user=accept &amp;gt;&amp;gt; &lt;span class=&quot;variable&quot;&gt;$LOG&lt;/span&gt; 2&amp;gt;&amp;amp;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;end &lt;span class=&quot;variable&quot;&gt;$(date)&lt;/span&gt;&quot;&lt;/span&gt; &amp;gt;&amp;gt; &lt;span class=&quot;variable&quot;&gt;$LOG&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;不过如果 redmine 就这么简单就搞定的话，那我也没必要单独拿出来掰了。关键是，通过 imap 死活就是不行。只好又看了一下代码。&lt;/p&gt;
&lt;figure class=&quot;highlight diff&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;Index: lib/redmine/imap.rb&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;===================================================================&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;--- lib/redmine/imap.rb	(版本 10947)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;+++ lib/redmine/imap.rb	(工作副本)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@@ -30,8 +30,9 @@&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         imap.login(imap_options[:username], imap_options[:password]) unless imap_options[:username].nil?&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         imap.select(folder)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         imap.search([&#39;NOT&#39;, &#39;SEEN&#39;]).each do |message_id|&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-          msg = imap.fetch(message_id,&#39;RFC822&#39;)[0].attr[&#39;RFC822&#39;]&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-          logger.debug &quot;Receiving message #&amp;#123;message_id&amp;#125;&quot; if logger &amp;amp;&amp;amp; logger.debug?&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+          #msg = imap.fetch(message_id,&#39;RFC822&#39;)[0].attr[&#39;RFC822&#39;]&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+          msg = imap.fetch(message_id,&#39;BODY[]&#39;)[0].attr[&#39;BODY[]&#39;]&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+          logger.debug &quot;Receiving message #&amp;#123;message_id&amp;#125;, msg:\n#&amp;#123;msg&amp;#125;&quot; if logger &amp;amp;&amp;amp; logger.debug?&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           if MailHandler.receive(msg, options)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;             logger.debug &quot;Message #&amp;#123;message_id&amp;#125; successfully received&quot; if logger &amp;amp;&amp;amp; logger.debug?&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;             if imap_options[:move_on_success]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里把那个 RFC822 改成 BODY[] 就好了，入丝般润滑。。。&lt;/p&gt;
&lt;h2 id=&quot;过滤掉邮件回复的垃圾内容&quot;&gt;&lt;a href=&quot;#过滤掉邮件回复的垃圾内容&quot; class=&quot;headerlink&quot; title=&quot;过滤掉邮件回复的垃圾内容&quot;&gt;&lt;/a&gt;过滤掉邮件回复的垃圾内容&lt;/h2&gt;&lt;p&gt;邮件回复 ok 之后，紧跟着问题就是，他会把整封邮件都作为回复记录进去，这个太恶心了。还好他提供了设置，在 email notification 选项里面，配置一个 email header &lt;code&gt;--Reply above this line--&lt;/code&gt;，在 incoming mail 里面配置一个 Truncate emails after one of these lines &lt;code&gt;--Reply above this line--&lt;/code&gt;，他就会截取这个字符前面的内容了。&lt;/p&gt;
&lt;p&gt;不过还有问题就是，一般邮件回复都开头都是个 &lt;code&gt;On xxxx xxx wrote:&lt;/code&gt;，这个他不会截掉，那就再 hack 一下。。&lt;/p&gt;
&lt;figure class=&quot;highlight diff&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;--- app/models/mail_handler.rb	(版本 10947)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;+++ app/models/mail_handler.rb	(工作副本)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@@ -463,9 +464,12 @@&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   # Removes the email body of text after the truncation configurations.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   def cleanup_body(body)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-    delimiters = Setting.mail_handler_body_delimiters.to_s.split(/[\r\n]+/).reject(&amp;amp;:blank?).map &amp;#123;|s| Regexp.escape(s)&amp;#125;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+    #delimiters = Setting.mail_handler_body_delimiters.to_s.split(/[\r\n]+/).reject(&amp;amp;:blank?).map &amp;#123;|s| Regexp.escape(s)&amp;#125;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+    delimiters = Setting.mail_handler_body_delimiters.to_s.split(/[\r\n]+/).reject(&amp;amp;:blank?).map &amp;#123;|s| s&amp;#125;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     unless delimiters.empty?&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;       regex = Regexp.new(&quot;^[&amp;gt; ]*(#&amp;#123; delimiters.join(&#39;|&#39;) &amp;#125;)\s*[\r\n].*&quot;, Regexp::MULTILINE)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+      #regex = Regexp.new(&quot;(^[&amp;gt; ]*(#&amp;#123; delimiters.join(&#39;|&#39;) &amp;#125;)\s*[\r\n].*)|(On (.*)wrote:[\r\n].*)&quot;, Regexp::MULTILINE)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;       body = body.gsub(regex, &#39;&#39;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     end&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     body.strip&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;这里搞定之后，在那个 Truncate emails after one of these lines 里面就可以写正则了，增加一行 &lt;code&gt;On (.*)wrote:&lt;/code&gt;，然后就可以了。&lt;/p&gt;
&lt;h2 id=&quot;code-review&quot;&gt;&lt;a href=&quot;#code-review&quot; class=&quot;headerlink&quot; title=&quot;code review&quot;&gt;&lt;/a&gt;code review&lt;/h2&gt;&lt;p&gt;增加了一个 code review 插件，已有项目需要在项目的模块里面启用。并且需要 admin 在角色配置里面，给相应角色增加 code review 的权限。不过貌似这插件不太好用，只能一行一行来。&lt;/p&gt;
"> <!-- TODO: truncate -->
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="wd and cc" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='//fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    

</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        wd and cc
    </div>
</h1>
<span class="subtitle">happy everyday</span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/wd" class="github" title="Github"></a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/wd" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload -->
    <div id="content" class="inner">
        <article class="post">
	<h2 class="title">redmine-a-good-project-tracker</h2>
	<div class="entry-content"><p>其实很早，大概2，3年前就听说了 redmine 了，不过他环境是 ruby 的，一直没有勇气去搭一个环境。现在项目人多了，bug 阿 feature 阿，就需要记录一下了，因为有些事情不记录下来总是会忘记。之前是尝试通过 wiki ＋ bugfree 来记录的，bugfree 记录在提测之后的一些问题，wiki 记录一些 feature request 什么的。bugfree 我们没权限管理，wiki 记录又不方便，然后我就又想起来 redmine 了。</p>
<p>哦对，其实公司还提供了一个 jira 给大家用，我用了几次我觉得那玩意太难用了，和那个 confluence 的 wiki 一样难用。</p>
<p>本身搭建没什么难度，编译一个 ruby，然后 gem 安装几个包，下载 redmine，使用 rake 命令操作就好了。启动他的 server 之后，就可以访问了。下面几个东西是我花了一些时间配置的。</p>
<h2 id="和-ldap-集成"><a href="#和-ldap-集成" class="headerlink" title="和 ldap 集成"></a>和 ldap 集成</h2><p>在 redmine 的设置里面，本身是有一项和 redmine 集成的功能的，设置 basedn，和下面的 attributes 内容（sAMAccountName,givenName,sN,mail)就可以了。点测试，得能通过。</p>
<p>在我这里，光设置这个还不行，还需要 hack 一段代码。注意下面的那个 <code>@xxxx.com</code>，这个对应你自己的。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">ndex: app/models/auth_source_ldap.rb</div><div class="line"><span class="comment">===================================================================</span></div><div class="line"><span class="comment">--- app/models/auth_source_ldap.rb	(版本 10947)</span></div><div class="line"><span class="comment">+++ app/models/auth_source_ldap.rb	(工作副本)</span></div><div class="line"><span class="meta">@@ -135,11 +135,12 @@</span></div><div class="line">   # Get the user's dn and any attributes for them, given their login</div><div class="line">   def get_user_dn(login, password)</div><div class="line">     ldap_con = nil</div><div class="line"><span class="deletion">-    if self.account &amp;&amp; self.account.include?("$login")</span></div><div class="line"><span class="deletion">-      ldap_con = initialize_ldap_con(self.account.sub("$login", Net::LDAP::DN.escape(login)), password)</span></div><div class="line"><span class="deletion">-    else</span></div><div class="line"><span class="deletion">-      ldap_con = initialize_ldap_con(self.account, self.account_password)</span></div><div class="line"><span class="deletion">-    end</span></div><div class="line"><span class="addition">+    ldap_con = initialize_ldap_con(login + '@xxxxx.com', password)</span></div><div class="line"><span class="addition">+    #if self.account &amp;&amp; self.account.include?("$login")</span></div><div class="line"><span class="addition">+    #  ldap_con = initialize_ldap_con(self.account.sub("$login", Net::LDAP::DN.escape(login)), password)</span></div><div class="line"><span class="addition">+    #else</span></div><div class="line"><span class="addition">+    #  ldap_con = initialize_ldap_con(self.account, self.account_password)</span></div><div class="line"><span class="addition">+    #end</span></div><div class="line">     login_filter = Net::LDAP::Filter.eq( self.attr_login, login )</div><div class="line">     object_filter = Net::LDAP::Filter.eq( "objectClass", "*" )</div><div class="line">     attrs = &#123;&#125;</div><div class="line"><span class="meta">@@ -149,6 +150,8 @@</span></div><div class="line">       search_filter = search_filter &amp; f</div><div class="line">     end</div><div class="line"> </div><div class="line"><span class="addition">+    logger.debug "------------get_user_dn #&#123;login&#125; #&#123;self.base_dn&#125; #&#123;search_filter&#125; #&#123;search_attributes&#125;" if logger &amp;&amp; logger.debug?</span></div><div class="line"><span class="addition">+</span></div><div class="line">     ldap_con.search( :base =&gt; self.base_dn,</div><div class="line">                      :filter =&gt; search_filter,</div><div class="line">                      :attributes=&gt; search_attributes) do |entry|</div></pre></td></tr></table></figure>
<p>总之登陆验证的代码关键就在这里了，可以自己做尝试，建议先写最简单的代码测试。比如</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="string">'rubygems'</span></div><div class="line"><span class="keyword">require</span> <span class="string">'net/ldap'</span></div><div class="line"></div><div class="line">ldap = Net::LDAP.new <span class="symbol">:host</span> =&gt; <span class="string">'qunarldap.corp.qunar.com'</span>,</div><div class="line">     <span class="symbol">:port</span> =&gt; <span class="number">389</span>,</div><div class="line">     <span class="symbol">:auth</span> =&gt; &#123;</div><div class="line">           <span class="symbol">:method</span> =&gt; <span class="symbol">:simple</span>,</div><div class="line">           <span class="symbol">:username</span> =&gt; <span class="string">"wd@xxxx.com"</span>,</div><div class="line">           <span class="symbol">:password</span> =&gt; <span class="string">"pwd"</span></div><div class="line">     &#125;</div><div class="line"></div><div class="line">filter = Net::LDAP::Filter.eq(<span class="string">"sAMAccountName"</span>,<span class="string">"wd*"</span>)</div><div class="line">object_filter = Net::LDAP::Filter.eq( <span class="string">"objectClass"</span>, <span class="string">"*"</span> )</div><div class="line">search_filter = filter &amp; object_filter</div><div class="line"></div><div class="line">treebase = <span class="string">"你的 basedn"</span> <span class="comment">#</span></div><div class="line"></div><div class="line">attr = [<span class="string">"dn"</span>, <span class="string">"givenName"</span>, <span class="string">"sN"</span>, <span class="string">"mail"</span>]</div><div class="line"></div><div class="line">ldap.search(<span class="symbol">:base</span> =&gt; treebase, <span class="symbol">:filter</span> =&gt; search_filter, <span class="symbol">:attributes</span> =&gt; attr ) <span class="keyword">do</span> <span class="params">|entry|</span></div><div class="line">  puts <span class="string">"DN: <span class="subst">#&#123;entry.dn&#125;</span>"</span></div><div class="line">  entry.each <span class="keyword">do</span> <span class="params">|attribute, values|</span></div><div class="line">    puts <span class="string">"   <span class="subst">#&#123;attribute&#125;</span>:"</span></div><div class="line">    values.each <span class="keyword">do</span> <span class="params">|value|</span></div><div class="line">      puts <span class="string">"      ---&gt;<span class="subst">#&#123;value&#125;</span>"</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">p ldap.get_operation_result</div></pre></td></tr></table></figure>
<p>搞定这块，就可以通过 ldap 用户直接登陆了，登陆会自动创建用户。</p>
<h2 id="通过回复邮件自动创建和更新-issue"><a href="#通过回复邮件自动创建和更新-issue" class="headerlink" title="通过回复邮件自动创建和更新 issue"></a>通过回复邮件自动创建和更新 issue</h2><p>用过 bugzilla 的都知道，可以通过邮件回复的方式来 comment issue。redmine 也提供了这个功能。我这种对 mail 服务器无权的用户，只能申请一个邮箱专门做这个事情了。公司邮箱是 exchange 的，没有打开 imap。redmine 只提供了 imap，pop 之类的方式。好在还有 davmail。先配置好一个 davmail，然后通过 imap 来做这个事情，imap 比 pop 好处多很多，比如可以指定 inbox，可以 move 到 read 之类，就不多说了。</p>
<p>crontab 指令大概如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">LOG=/<span class="built_in">export</span>/redmine/<span class="built_in">log</span>/mail_recieve.log</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"start <span class="variable">$(date)</span>"</span> &gt;&gt; <span class="variable">$LOG</span></div><div class="line"></div><div class="line">/usr/<span class="built_in">local</span>/ruby/bin/rake --silent <span class="_">-f</span> /<span class="built_in">export</span>/redmine/Rakefile redmine:email:receive_imap RAILS_ENV=<span class="string">"production"</span> host=localhost username=abc password=def port=1143 move_on_success=<span class="built_in">read</span> move_on_failure=failed unknown_user=accept &gt;&gt; <span class="variable">$LOG</span> 2&gt;&amp;1</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"end <span class="variable">$(date)</span>"</span> &gt;&gt; <span class="variable">$LOG</span></div></pre></td></tr></table></figure>
<p>不过如果 redmine 就这么简单就搞定的话，那我也没必要单独拿出来掰了。关键是，通过 imap 死活就是不行。只好又看了一下代码。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">Index: lib/redmine/imap.rb</span></div><div class="line"><span class="comment">===================================================================</span></div><div class="line"><span class="comment">--- lib/redmine/imap.rb	(版本 10947)</span></div><div class="line"><span class="comment">+++ lib/redmine/imap.rb	(工作副本)</span></div><div class="line"><span class="meta">@@ -30,8 +30,9 @@</span></div><div class="line">         imap.login(imap_options[:username], imap_options[:password]) unless imap_options[:username].nil?</div><div class="line">         imap.select(folder)</div><div class="line">         imap.search(['NOT', 'SEEN']).each do |message_id|</div><div class="line"><span class="deletion">-          msg = imap.fetch(message_id,'RFC822')[0].attr['RFC822']</span></div><div class="line"><span class="deletion">-          logger.debug "Receiving message #&#123;message_id&#125;" if logger &amp;&amp; logger.debug?</span></div><div class="line"><span class="addition">+          #msg = imap.fetch(message_id,'RFC822')[0].attr['RFC822']</span></div><div class="line"><span class="addition">+          msg = imap.fetch(message_id,'BODY[]')[0].attr['BODY[]']</span></div><div class="line"><span class="addition">+          logger.debug "Receiving message #&#123;message_id&#125;, msg:\n#&#123;msg&#125;" if logger &amp;&amp; logger.debug?</span></div><div class="line">           if MailHandler.receive(msg, options)</div><div class="line">             logger.debug "Message #&#123;message_id&#125; successfully received" if logger &amp;&amp; logger.debug?</div><div class="line">             if imap_options[:move_on_success]</div></pre></td></tr></table></figure>
<p>这里把那个 RFC822 改成 BODY[] 就好了，入丝般润滑。。。</p>
<h2 id="过滤掉邮件回复的垃圾内容"><a href="#过滤掉邮件回复的垃圾内容" class="headerlink" title="过滤掉邮件回复的垃圾内容"></a>过滤掉邮件回复的垃圾内容</h2><p>邮件回复 ok 之后，紧跟着问题就是，他会把整封邮件都作为回复记录进去，这个太恶心了。还好他提供了设置，在 email notification 选项里面，配置一个 email header <code>--Reply above this line--</code>，在 incoming mail 里面配置一个 Truncate emails after one of these lines <code>--Reply above this line--</code>，他就会截取这个字符前面的内容了。</p>
<p>不过还有问题就是，一般邮件回复都开头都是个 <code>On xxxx xxx wrote:</code>，这个他不会截掉，那就再 hack 一下。。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--- app/models/mail_handler.rb	(版本 10947)</span></div><div class="line"><span class="comment">+++ app/models/mail_handler.rb	(工作副本)</span></div><div class="line"><span class="meta">@@ -463,9 +464,12 @@</span></div><div class="line"> </div><div class="line">   # Removes the email body of text after the truncation configurations.</div><div class="line">   def cleanup_body(body)</div><div class="line"><span class="deletion">-    delimiters = Setting.mail_handler_body_delimiters.to_s.split(/[\r\n]+/).reject(&amp;:blank?).map &#123;|s| Regexp.escape(s)&#125;</span></div><div class="line"><span class="addition">+    #delimiters = Setting.mail_handler_body_delimiters.to_s.split(/[\r\n]+/).reject(&amp;:blank?).map &#123;|s| Regexp.escape(s)&#125;</span></div><div class="line"><span class="addition">+    delimiters = Setting.mail_handler_body_delimiters.to_s.split(/[\r\n]+/).reject(&amp;:blank?).map &#123;|s| s&#125;</span></div><div class="line"><span class="addition">+</span></div><div class="line">     unless delimiters.empty?</div><div class="line">       regex = Regexp.new("^[&gt; ]*(#&#123; delimiters.join('|') &#125;)\s*[\r\n].*", Regexp::MULTILINE)</div><div class="line"><span class="addition">+      #regex = Regexp.new("(^[&gt; ]*(#&#123; delimiters.join('|') &#125;)\s*[\r\n].*)|(On (.*)wrote:[\r\n].*)", Regexp::MULTILINE)</span></div><div class="line">       body = body.gsub(regex, '')</div><div class="line">     end</div><div class="line">     body.strip</div></pre></td></tr></table></figure>
<p>这里搞定之后，在那个 Truncate emails after one of these lines 里面就可以写正则了，增加一行 <code>On (.*)wrote:</code>，然后就可以了。</p>
<h2 id="code-review"><a href="#code-review" class="headerlink" title="code review"></a>code review</h2><p>增加了一个 code review 插件，已有项目需要在项目的模块里面启用。并且需要 admin 在角色配置里面，给相应角色增加 code review 的权限。不过貌似这插件不太好用，只能一行一行来。</p>
</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/redmine-a-good-project-tracker/#disqus_thread">Comments</a></span>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=null"></script>
</div>





    
      <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = 'http://wdicc.com/redmine-a-good-project-tracker/';
            this.page.identifier = 'http://wdicc.com/redmine-a-good-project-tracker/';
        };

        (function() {
          var d = document, s = d.createElement('script');
          s.src = '//wdicc.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    


<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>


    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2016

    wd
. Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> |
    Theme is <a href="https://github.com/wd/hexo-fabric">hexo-fabric</a>, fork from <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
