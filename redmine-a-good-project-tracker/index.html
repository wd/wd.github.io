<!doctype html><html lang=zh-CN><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>redmine-a-good-project-tracker | wd and cc</title>
<link rel=canonical href=https://wdicc.com/redmine-a-good-project-tracker/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://wdicc.com/redmine-a-good-project-tracker/"><meta property="og:site_name" content="wd and cc"><meta property="og:title" content="redmine-a-good-project-tracker"><meta property="og:description" content="其实很早，大概2，3年前就听说了 redmine 了，不过他环境是 ruby 的，一直没有勇气去搭一个环境。现在项目人多了，bug 阿 feature 阿，就需要记录一下了，因为有些事情不记录下来总是会忘记。之前是尝试通过 wiki ＋ bugfree 来记录的，bugfree 记录在提测之后的一些问题，wiki 记录一些 feature request 什么的。bugfree 我们没权限管理，wiki 记录又不方便，然后我就又想起来 redmine 了。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2012-12-11T14:53:00+08:00"><meta property="article:modified_time" content="2012-12-11T14:53:00+08:00"><meta property="article:tag" content="Linux"><meta name=twitter:card content="summary"><meta name=twitter:title content="redmine-a-good-project-tracker"><meta name=twitter:description content="其实很早，大概2，3年前就听说了 redmine 了，不过他环境是 ruby 的，一直没有勇气去搭一个环境。现在项目人多了，bug 阿 feature 阿，就需要记录一下了，因为有些事情不记录下来总是会忘记。之前是尝试通过 wiki ＋ bugfree 来记录的，bugfree 记录在提测之后的一些问题，wiki 记录一些 feature request 什么的。bugfree 我们没权限管理，wiki 记录又不方便，然后我就又想起来 redmine 了。"><link rel=stylesheet href=https://wdicc.com/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><link rel=stylesheet href=https://wdicc.com/wdicc.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://wdicc.com/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://wdicc.com/some-tips-on-bash-scripting/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=https://wdicc.com/postgresql-explain/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&text=redmine-a-good-project-tracker" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&title=redmine-a-good-project-tracker" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&is_video=false&description=redmine-a-good-project-tracker" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=redmine-a-good-project-tracker&body=Check out this article: https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&title=redmine-a-good-project-tracker" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&title=redmine-a-good-project-tracker" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&name=redmine-a-good-project-tracker&description=%3cp%3e%e5%85%b6%e5%ae%9e%e5%be%88%e6%97%a9%ef%bc%8c%e5%a4%a7%e6%a6%822%ef%bc%8c3%e5%b9%b4%e5%89%8d%e5%b0%b1%e5%90%ac%e8%af%b4%e4%ba%86%20redmine%20%e4%ba%86%ef%bc%8c%e4%b8%8d%e8%bf%87%e4%bb%96%e7%8e%af%e5%a2%83%e6%98%af%20ruby%20%e7%9a%84%ef%bc%8c%e4%b8%80%e7%9b%b4%e6%b2%a1%e6%9c%89%e5%8b%87%e6%b0%94%e5%8e%bb%e6%90%ad%e4%b8%80%e4%b8%aa%e7%8e%af%e5%a2%83%e3%80%82%e7%8e%b0%e5%9c%a8%e9%a1%b9%e7%9b%ae%e4%ba%ba%e5%a4%9a%e4%ba%86%ef%bc%8cbug%20%e9%98%bf%20feature%20%e9%98%bf%ef%bc%8c%e5%b0%b1%e9%9c%80%e8%a6%81%e8%ae%b0%e5%bd%95%e4%b8%80%e4%b8%8b%e4%ba%86%ef%bc%8c%e5%9b%a0%e4%b8%ba%e6%9c%89%e4%ba%9b%e4%ba%8b%e6%83%85%e4%b8%8d%e8%ae%b0%e5%bd%95%e4%b8%8b%e6%9d%a5%e6%80%bb%e6%98%af%e4%bc%9a%e5%bf%98%e8%ae%b0%e3%80%82%e4%b9%8b%e5%89%8d%e6%98%af%e5%b0%9d%e8%af%95%e9%80%9a%e8%bf%87%20wiki%20%ef%bc%8b%20bugfree%20%e6%9d%a5%e8%ae%b0%e5%bd%95%e7%9a%84%ef%bc%8cbugfree%20%e8%ae%b0%e5%bd%95%e5%9c%a8%e6%8f%90%e6%b5%8b%e4%b9%8b%e5%90%8e%e7%9a%84%e4%b8%80%e4%ba%9b%e9%97%ae%e9%a2%98%ef%bc%8cwiki%20%e8%ae%b0%e5%bd%95%e4%b8%80%e4%ba%9b%20feature%20request%20%e4%bb%80%e4%b9%88%e7%9a%84%e3%80%82bugfree%20%e6%88%91%e4%bb%ac%e6%b2%a1%e6%9d%83%e9%99%90%e7%ae%a1%e7%90%86%ef%bc%8cwiki%20%e8%ae%b0%e5%bd%95%e5%8f%88%e4%b8%8d%e6%96%b9%e4%be%bf%ef%bc%8c%e7%84%b6%e5%90%8e%e6%88%91%e5%b0%b1%e5%8f%88%e6%83%b3%e8%b5%b7%e6%9d%a5%20redmine%20%e4%ba%86%e3%80%82%3c%2fp%3e" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&t=redmine-a-good-project-tracker" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">redmine-a-good-project-tracker</h1><div class=meta><span class=author itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>wd and cc</span></span><div class=postdate><time datetime="2012-12-11 14:53:00 +0800 +0800" itemprop=datePublished>2012-12-11</time></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/linux rel=tag>linux</a></div></div></header><div id=toc><nav id=TableOfContents><ul><li><a href=#和-ldap-集成>和 ldap 集成</a></li><li><a href=#通过回复邮件自动创建和更新-issue>通过回复邮件自动创建和更新 issue</a></li><li><a href=#过滤掉邮件回复的垃圾内容>过滤掉邮件回复的垃圾内容</a></li><li><a href=#code-review>code review</a></li></ul></nav></div><div class=content itemprop=articleBody><p>其实很早，大概2，3年前就听说了 redmine 了，不过他环境是 ruby 的，一直没有勇气去搭一个环境。现在项目人多了，bug 阿 feature 阿，就需要记录一下了，因为有些事情不记录下来总是会忘记。之前是尝试通过 wiki ＋ bugfree 来记录的，bugfree 记录在提测之后的一些问题，wiki 记录一些 feature request 什么的。bugfree 我们没权限管理，wiki 记录又不方便，然后我就又想起来 redmine 了。</p><p>哦对，其实公司还提供了一个 jira 给大家用，我用了几次我觉得那玩意太难用了，和那个 confluence 的 wiki 一样难用。</p><p>本身搭建没什么难度，编译一个 ruby，然后 gem 安装几个包，下载 redmine，使用 rake 命令操作就好了。启动他的 server 之后，就可以访问了。下面几个东西是我花了一些时间配置的。</p><h2 id=和-ldap-集成>和 ldap 集成</h2><p>在 redmine 的设置里面，本身是有一项和 redmine 集成的功能的，设置 basedn，和下面的 attributes 内容（sAMAccountName,givenName,sN,mail)就可以了。点测试，得能通过。</p><p>在我这里，光设置这个还不行，还需要 hack 一段代码。注意下面的那个 <code>@xxxx.com</code>，这个对应你自己的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>ndex: app/models/auth_source_ldap.rb
</span></span><span style=display:flex><span>===================================================================
</span></span><span style=display:flex><span><span style=color:#f92672>--- app/models/auth_source_ldap.rb	(版本 10947)
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ app/models/auth_source_ldap.rb	(工作副本)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -135,11 +135,12 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   # Get the user&#39;s dn and any attributes for them, given their login
</span></span><span style=display:flex><span>   def get_user_dn(login, password)
</span></span><span style=display:flex><span>     ldap_con = nil
</span></span><span style=display:flex><span><span style=color:#f92672>-    if self.account &amp;&amp; self.account.include?(&#34;$login&#34;)
</span></span></span><span style=display:flex><span><span style=color:#f92672>-      ldap_con = initialize_ldap_con(self.account.sub(&#34;$login&#34;, Net::LDAP::DN.escape(login)), password)
</span></span></span><span style=display:flex><span><span style=color:#f92672>-    else
</span></span></span><span style=display:flex><span><span style=color:#f92672>-      ldap_con = initialize_ldap_con(self.account, self.account_password)
</span></span></span><span style=display:flex><span><span style=color:#f92672>-    end
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+    ldap_con = initialize_ldap_con(login + &#39;@xxxxx.com&#39;, password)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    #if self.account &amp;&amp; self.account.include?(&#34;$login&#34;)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    #  ldap_con = initialize_ldap_con(self.account.sub(&#34;$login&#34;, Net::LDAP::DN.escape(login)), password)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    #else
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    #  ldap_con = initialize_ldap_con(self.account, self.account_password)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    #end
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>     login_filter = Net::LDAP::Filter.eq( self.attr_login, login )
</span></span><span style=display:flex><span>     object_filter = Net::LDAP::Filter.eq( &#34;objectClass&#34;, &#34;*&#34; )
</span></span><span style=display:flex><span>     attrs = {}
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -149,6 +150,8 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       search_filter = search_filter &amp; f
</span></span><span style=display:flex><span>     end
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#a6e22e>+    logger.debug &#34;------------get_user_dn #{login} #{self.base_dn} #{search_filter} #{search_attributes}&#34; if logger &amp;&amp; logger.debug?
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>     ldap_con.search( :base =&gt; self.base_dn,
</span></span><span style=display:flex><span>                      :filter =&gt; search_filter,
</span></span><span style=display:flex><span>                      :attributes=&gt; search_attributes) do |entry|
</span></span></code></pre></div><p>总之登陆验证的代码关键就在这里了，可以自己做尝试，建议先写最简单的代码测试。比如</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;rubygems&#39;</span>
</span></span><span style=display:flex><span>require <span style=color:#e6db74>&#39;net/ldap&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ldap <span style=color:#f92672>=</span> <span style=color:#66d9ef>Net</span><span style=color:#f92672>::</span><span style=color:#66d9ef>LDAP</span><span style=color:#f92672>.</span>new <span style=color:#e6db74>:host</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;qunarldap.corp.qunar.com&#39;</span>,
</span></span><span style=display:flex><span>     <span style=color:#e6db74>:port</span> <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>389</span>,
</span></span><span style=display:flex><span>     <span style=color:#e6db74>:auth</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>           <span style=color:#e6db74>:method</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>:simple</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>:username</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;wd@xxxx.com&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>:password</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#34;pwd&#34;</span>
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>filter <span style=color:#f92672>=</span> <span style=color:#66d9ef>Net</span><span style=color:#f92672>::</span><span style=color:#66d9ef>LDAP</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Filter</span><span style=color:#f92672>.</span>eq(<span style=color:#e6db74>&#34;sAMAccountName&#34;</span>,<span style=color:#e6db74>&#34;wd*&#34;</span>)
</span></span><span style=display:flex><span>object_filter <span style=color:#f92672>=</span> <span style=color:#66d9ef>Net</span><span style=color:#f92672>::</span><span style=color:#66d9ef>LDAP</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Filter</span><span style=color:#f92672>.</span>eq( <span style=color:#e6db74>&#34;objectClass&#34;</span>, <span style=color:#e6db74>&#34;*&#34;</span> )
</span></span><span style=display:flex><span>search_filter <span style=color:#f92672>=</span> filter <span style=color:#f92672>&amp;</span> object_filter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>treebase <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;你的 basedn&#34;</span> <span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>attr</span> <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;dn&#34;</span>, <span style=color:#e6db74>&#34;givenName&#34;</span>, <span style=color:#e6db74>&#34;sN&#34;</span>, <span style=color:#e6db74>&#34;mail&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ldap<span style=color:#f92672>.</span>search(<span style=color:#e6db74>:base</span> <span style=color:#f92672>=&gt;</span> treebase, <span style=color:#e6db74>:filter</span> <span style=color:#f92672>=&gt;</span> search_filter, <span style=color:#e6db74>:attributes</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>attr</span> ) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>entry<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  puts <span style=color:#e6db74>&#34;DN: </span><span style=color:#e6db74>#{</span>entry<span style=color:#f92672>.</span>dn<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>  entry<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>attribute, values<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>    puts <span style=color:#e6db74>&#34;   </span><span style=color:#e6db74>#{</span>attribute<span style=color:#e6db74>}</span><span style=color:#e6db74>:&#34;</span>
</span></span><span style=display:flex><span>    values<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>value<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>      puts <span style=color:#e6db74>&#34;      ---&gt;</span><span style=color:#e6db74>#{</span>value<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p ldap<span style=color:#f92672>.</span>get_operation_result
</span></span></code></pre></div><p>搞定这块，就可以通过 ldap 用户直接登陆了，登陆会自动创建用户。</p><h2 id=通过回复邮件自动创建和更新-issue>通过回复邮件自动创建和更新 issue</h2><p>用过 bugzilla 的都知道，可以通过邮件回复的方式来 comment issue。redmine 也提供了这个功能。我这种对 mail 服务器无权的用户，只能申请一个邮箱专门做这个事情了。公司邮箱是 exchange 的，没有打开 imap。redmine 只提供了 imap，pop 之类的方式。好在还有 davmail。先配置好一个 davmail，然后通过 imap 来做这个事情，imap 比 pop 好处多很多，比如可以指定 inbox，可以 move 到 read 之类，就不多说了。</p><p>crontab 指令大概如下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>LOG<span style=color:#f92672>=</span>/export/redmine/log/mail_recieve.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;start </span><span style=color:#66d9ef>$(</span>date<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> &gt;&gt; $LOG
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/usr/local/ruby/bin/rake --silent -f /export/redmine/Rakefile redmine:email:receive_imap RAILS_ENV<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;production&#34;</span> host<span style=color:#f92672>=</span>localhost username<span style=color:#f92672>=</span>abc password<span style=color:#f92672>=</span>def port<span style=color:#f92672>=</span><span style=color:#ae81ff>1143</span> move_on_success<span style=color:#f92672>=</span>read move_on_failure<span style=color:#f92672>=</span>failed unknown_user<span style=color:#f92672>=</span>accept &gt;&gt; $LOG 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;end </span><span style=color:#66d9ef>$(</span>date<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> &gt;&gt; $LOG
</span></span></code></pre></div><p>不过如果 redmine 就这么简单就搞定的话，那我也没必要单独拿出来掰了。关键是，通过 imap 死活就是不行。只好又看了一下代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>Index: lib/redmine/imap.rb
</span></span><span style=display:flex><span>===================================================================
</span></span><span style=display:flex><span><span style=color:#f92672>--- lib/redmine/imap.rb	(版本 10947)
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ lib/redmine/imap.rb	(工作副本)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -30,8 +30,9 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         imap.login(imap_options[:username], imap_options[:password]) unless imap_options[:username].nil?
</span></span><span style=display:flex><span>         imap.select(folder)
</span></span><span style=display:flex><span>         imap.search([&#39;NOT&#39;, &#39;SEEN&#39;]).each do |message_id|
</span></span><span style=display:flex><span><span style=color:#f92672>-          msg = imap.fetch(message_id,&#39;RFC822&#39;)[0].attr[&#39;RFC822&#39;]
</span></span></span><span style=display:flex><span><span style=color:#f92672>-          logger.debug &#34;Receiving message #{message_id}&#34; if logger &amp;&amp; logger.debug?
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+          #msg = imap.fetch(message_id,&#39;RFC822&#39;)[0].attr[&#39;RFC822&#39;]
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+          msg = imap.fetch(message_id,&#39;BODY[]&#39;)[0].attr[&#39;BODY[]&#39;]
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+          logger.debug &#34;Receiving message #{message_id}, msg:\n#{msg}&#34; if logger &amp;&amp; logger.debug?
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>           if MailHandler.receive(msg, options)
</span></span><span style=display:flex><span>             logger.debug &#34;Message #{message_id} successfully received&#34; if logger &amp;&amp; logger.debug?
</span></span><span style=display:flex><span>             if imap_options[:move_on_success]
</span></span></code></pre></div><p>这里把那个 RFC822 改成 BODY[] 就好了，入丝般润滑。。。</p><h2 id=过滤掉邮件回复的垃圾内容>过滤掉邮件回复的垃圾内容</h2><p>邮件回复 ok 之后，紧跟着问题就是，他会把整封邮件都作为回复记录进去，这个太恶心了。还好他提供了设置，在 email notification 选项里面，配置一个 email header <code>--Reply above this line--</code>，在 incoming mail 里面配置一个 Truncate emails after one of these lines <code>--Reply above this line--</code>，他就会截取这个字符前面的内容了。</p><p>不过还有问题就是，一般邮件回复都开头都是个 <code>On xxxx xxx wrote:</code>，这个他不会截掉，那就再 hack 一下。。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>--- app/models/mail_handler.rb	(版本 10947)
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ app/models/mail_handler.rb	(工作副本)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -463,9 +464,12 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 
</span></span><span style=display:flex><span>   # Removes the email body of text after the truncation configurations.
</span></span><span style=display:flex><span>   def cleanup_body(body)
</span></span><span style=display:flex><span><span style=color:#f92672>-    delimiters = Setting.mail_handler_body_delimiters.to_s.split(/[\r\n]+/).reject(&amp;:blank?).map {|s| Regexp.escape(s)}
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+    #delimiters = Setting.mail_handler_body_delimiters.to_s.split(/[\r\n]+/).reject(&amp;:blank?).map {|s| Regexp.escape(s)}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    delimiters = Setting.mail_handler_body_delimiters.to_s.split(/[\r\n]+/).reject(&amp;:blank?).map {|s| s}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>     unless delimiters.empty?
</span></span><span style=display:flex><span>       regex = Regexp.new(&#34;^[&gt; ]*(#{ delimiters.join(&#39;|&#39;) })\s*[\r\n].*&#34;, Regexp::MULTILINE)
</span></span><span style=display:flex><span><span style=color:#a6e22e>+      #regex = Regexp.new(&#34;(^[&gt; ]*(#{ delimiters.join(&#39;|&#39;) })\s*[\r\n].*)|(On (.*)wrote:[\r\n].*)&#34;, Regexp::MULTILINE)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>       body = body.gsub(regex, &#39;&#39;)
</span></span><span style=display:flex><span>     end
</span></span><span style=display:flex><span>     body.strip
</span></span></code></pre></div><p>这里搞定之后，在那个 Truncate emails after one of these lines 里面就可以写正则了，增加一行 <code>On (.*)wrote:</code>，然后就可以了。</p><h2 id=code-review>code review</h2><p>增加了一个 code review 插件，已有项目需要在项目的模块里面启用。并且需要 admin 在角色配置里面，给相应角色增加 code review 的权限。不过貌似这插件不太好用，只能一行一行来。</p></div></article><div class=blog-post-comments>&amp;page.siteWrapper{s:(*hugolib.Site)(0xc00030e300)}<div id=disqus_thread><script type=text/javascript>(function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="wdicc",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&text=redmine-a-good-project-tracker" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&title=redmine-a-good-project-tracker" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&is_video=false&description=redmine-a-good-project-tracker" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=redmine-a-good-project-tracker&body=Check out this article: https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&title=redmine-a-good-project-tracker" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&title=redmine-a-good-project-tracker" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&name=redmine-a-good-project-tracker&description=%3cp%3e%e5%85%b6%e5%ae%9e%e5%be%88%e6%97%a9%ef%bc%8c%e5%a4%a7%e6%a6%822%ef%bc%8c3%e5%b9%b4%e5%89%8d%e5%b0%b1%e5%90%ac%e8%af%b4%e4%ba%86%20redmine%20%e4%ba%86%ef%bc%8c%e4%b8%8d%e8%bf%87%e4%bb%96%e7%8e%af%e5%a2%83%e6%98%af%20ruby%20%e7%9a%84%ef%bc%8c%e4%b8%80%e7%9b%b4%e6%b2%a1%e6%9c%89%e5%8b%87%e6%b0%94%e5%8e%bb%e6%90%ad%e4%b8%80%e4%b8%aa%e7%8e%af%e5%a2%83%e3%80%82%e7%8e%b0%e5%9c%a8%e9%a1%b9%e7%9b%ae%e4%ba%ba%e5%a4%9a%e4%ba%86%ef%bc%8cbug%20%e9%98%bf%20feature%20%e9%98%bf%ef%bc%8c%e5%b0%b1%e9%9c%80%e8%a6%81%e8%ae%b0%e5%bd%95%e4%b8%80%e4%b8%8b%e4%ba%86%ef%bc%8c%e5%9b%a0%e4%b8%ba%e6%9c%89%e4%ba%9b%e4%ba%8b%e6%83%85%e4%b8%8d%e8%ae%b0%e5%bd%95%e4%b8%8b%e6%9d%a5%e6%80%bb%e6%98%af%e4%bc%9a%e5%bf%98%e8%ae%b0%e3%80%82%e4%b9%8b%e5%89%8d%e6%98%af%e5%b0%9d%e8%af%95%e9%80%9a%e8%bf%87%20wiki%20%ef%bc%8b%20bugfree%20%e6%9d%a5%e8%ae%b0%e5%bd%95%e7%9a%84%ef%bc%8cbugfree%20%e8%ae%b0%e5%bd%95%e5%9c%a8%e6%8f%90%e6%b5%8b%e4%b9%8b%e5%90%8e%e7%9a%84%e4%b8%80%e4%ba%9b%e9%97%ae%e9%a2%98%ef%bc%8cwiki%20%e8%ae%b0%e5%bd%95%e4%b8%80%e4%ba%9b%20feature%20request%20%e4%bb%80%e4%b9%88%e7%9a%84%e3%80%82bugfree%20%e6%88%91%e4%bb%ac%e6%b2%a1%e6%9d%83%e9%99%90%e7%ae%a1%e7%90%86%ef%bc%8cwiki%20%e8%ae%b0%e5%bd%95%e5%8f%88%e4%b8%8d%e6%96%b9%e4%be%bf%ef%bc%8c%e7%84%b6%e5%90%8e%e6%88%91%e5%b0%b1%e5%8f%88%e6%83%b3%e8%b5%b7%e6%9d%a5%20redmine%20%e4%ba%86%e3%80%82%3c%2fp%3e" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwdicc.com%2fredmine-a-good-project-tracker%2f&t=redmine-a-good-project-tracker" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2025 wd and cc</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>