<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>基于 ffi 的 libmcrypt 加密模块 - wd and cc</title>
    <meta name="author" content="wd">
    
	<meta name="description" content="&lt;p&gt;openresty 提供了 luajit 的支持，luajit 又提供了 ffi 库的支持。通过 ffi 可以很方便的调用 c 库的一些方法。&lt;/p&gt;
&lt;p&gt;我在项目里面用到了加解密，因为需要各语言支持，使用了 libmcrypt 库。之前通过 c 模块完成了在 lua 里面加密，在 perl 里面解密。有了 ffi 就可以使用纯 lua 模块搞定了。&lt;/p&gt;
&lt;p&gt;代码写的比较丑，有使用加解密的需求的可以参考下，另外计划写其他模块的也可以参考下。如下&lt;/p&gt;
&lt;figure class=&quot;highlight lua&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;62&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;65&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;66&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;67&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;68&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;69&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;70&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;71&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;72&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;73&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;74&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;75&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;76&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;77&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;78&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;79&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; ffi = &lt;span class=&quot;built_in&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;ffi&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; ffi_new = ffi.new&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; ffi_str = ffi.&lt;span class=&quot;built_in&quot;&gt;string&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; ffi_copy = ffi.copy&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;setmetatable&lt;/span&gt; = &lt;span class=&quot;built_in&quot;&gt;setmetatable&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; _M = &amp;#123; &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; mt = &amp;#123; __index = _M &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ffi.cdef&lt;span class=&quot;string&quot;&gt;[[&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;struct CRYPT_STREAM;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;typedef struct CRYPT_STREAM *MCRYPT;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;MCRYPT mcrypt_module_open(char *algorithm,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                          char *a_directory, char *mode,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                          char *m_directory);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;int mcrypt_generic_init(const MCRYPT td, void *key, int lenofkey,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;                        void *IV);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;int mcrypt_generic_deinit(const MCRYPT td);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;int mcrypt_generic_end(const MCRYPT td);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;int mdecrypt_generic(MCRYPT td, void *plaintext, int len);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;int mcrypt_generic(MCRYPT td, void *plaintext, int len);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;int mcrypt_module_close(MCRYPT td);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;]]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; mcrypt = ffi.&lt;span class=&quot;built_in&quot;&gt;load&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&#39;libmcrypt.so.4&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;_M.new = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;params&quot;&gt;(self)&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; cipher = &lt;span class=&quot;string&quot;&gt;&#39;blowfish&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; mode = &lt;span class=&quot;string&quot;&gt;&#39;cbc&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; c_cipher = ffi_new(&lt;span class=&quot;string&quot;&gt;&quot;char[9]&quot;&lt;/span&gt;, cipher)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; c_mode = ffi_new(&lt;span class=&quot;string&quot;&gt;&quot;char[4]&quot;&lt;/span&gt;, mode)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; td = mcrypt.mcrypt_module_open(c_cipher, &lt;span class=&quot;keyword&quot;&gt;nil&lt;/span&gt;, c_mode, &lt;span class=&quot;keyword&quot;&gt;nil&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;setmetatable&lt;/span&gt;( &amp;#123; _td = td &amp;#125;, mt )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;_M.encrypt = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(self, key, raw)&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; iv_len = &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; td = self._td&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; c_key = ffi_new(&lt;span class=&quot;string&quot;&gt;&quot;char[?]&quot;&lt;/span&gt;, #key+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, key)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; c_iv = ffi_new(&lt;span class=&quot;string&quot;&gt;&quot;char[9]&quot;&lt;/span&gt;, key)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; c_raw = ffi_new(&lt;span class=&quot;string&quot;&gt;&quot;char[?]&quot;&lt;/span&gt;, #raw+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, raw)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mcrypt.mcrypt_generic_init(td, c_key, #key, c_iv)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mcrypt.mcrypt_generic(td, c_raw, #raw )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mcrypt.mcrypt_generic_deinit(td)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; ffi_str(c_raw, ffi.sizeof(c_raw)&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;_M.decrypt = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(self, key, raw)&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; iv_len = &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; td = self._td&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; c_key = ffi_new(&lt;span class=&quot;string&quot;&gt;&quot;char[?]&quot;&lt;/span&gt;, #key+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, key)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; c_iv = ffi_new(&lt;span class=&quot;string&quot;&gt;&quot;char[9]&quot;&lt;/span&gt;, key)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; c_raw = ffi_new(&lt;span class=&quot;string&quot;&gt;&quot;char[?]&quot;&lt;/span&gt;, #raw+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, raw)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mcrypt.mcrypt_generic_init(td, c_key, #key, c_iv)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mcrypt.mdecrypt_generic(td, c_raw, #raw )&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mcrypt.mcrypt_generic_deinit(td)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; ffi_str(c_raw, ffi.sizeof(c_raw)&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;_M.close = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(self)&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;local&lt;/span&gt; td = self._td&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; td &lt;span class=&quot;keyword&quot;&gt;then&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        mcrypt.mcrypt_module_close(td)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     &lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;end&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; _M&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;使用方法比较简单，代码里面写死了是 &lt;code&gt;blowfish&lt;/code&gt; 的 &lt;code&gt;cbc&lt;/code&gt; 模式，并且 iv 使用 key 的前 8 个字符&lt;br&gt;&lt;figure class=&quot;highlight lasso&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; mcrypt = &lt;span class=&quot;keyword&quot;&gt;require&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;mcrypt&quot;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; m = mcrypt:&lt;span class=&quot;literal&quot;&gt;new&lt;/span&gt;()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;-- 一系列加解密&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; en = m:encrypt(&lt;span class=&quot;string&quot;&gt;&#39;xxx&#39;&lt;/span&gt;,&lt;span class=&quot;string&quot;&gt;&#39;yyyy&#39;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;...&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; de = m:decrypt(&lt;span class=&quot;string&quot;&gt;&#39;xxx&#39;&lt;/span&gt;, yyyy&lt;span class=&quot;string&quot;&gt;&#39;)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;-- 最后关闭&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;m:close()&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
"> <!-- TODO: truncate -->
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="wd and cc" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='//fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    

</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        wd and cc
    </div>
</h1>
<span class="subtitle">happy everyday</span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/wd" class="github" title="Github"></a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/wd" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload -->
    <div id="content" class="inner">
        <article class="post">
	<h2 class="title">基于 ffi 的 libmcrypt 加密模块</h2>
	<div class="entry-content"><p>openresty 提供了 luajit 的支持，luajit 又提供了 ffi 库的支持。通过 ffi 可以很方便的调用 c 库的一些方法。</p>
<p>我在项目里面用到了加解密，因为需要各语言支持，使用了 libmcrypt 库。之前通过 c 模块完成了在 lua 里面加密，在 perl 里面解密。有了 ffi 就可以使用纯 lua 模块搞定了。</p>
<p>代码写的比较丑，有使用加解密的需求的可以参考下，另外计划写其他模块的也可以参考下。如下</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> ffi = <span class="built_in">require</span> <span class="string">'ffi'</span></div><div class="line"><span class="keyword">local</span> ffi_new = ffi.new</div><div class="line"><span class="keyword">local</span> ffi_str = ffi.<span class="built_in">string</span></div><div class="line"><span class="keyword">local</span> ffi_copy = ffi.copy</div><div class="line"><span class="keyword">local</span> <span class="built_in">setmetatable</span> = <span class="built_in">setmetatable</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> _M = &#123; &#125;</div><div class="line"><span class="keyword">local</span> mt = &#123; __index = _M &#125;</div><div class="line"></div><div class="line">ffi.cdef<span class="string">[[</span></div><div class="line">struct CRYPT_STREAM;</div><div class="line">typedef struct CRYPT_STREAM *MCRYPT;</div><div class="line"></div><div class="line">MCRYPT mcrypt_module_open(char *algorithm,</div><div class="line">                          char *a_directory, char *mode,</div><div class="line">                          char *m_directory);</div><div class="line"></div><div class="line">int mcrypt_generic_init(const MCRYPT td, void *key, int lenofkey,</div><div class="line">                        void *IV);</div><div class="line"></div><div class="line">int mcrypt_generic_deinit(const MCRYPT td);</div><div class="line">int mcrypt_generic_end(const MCRYPT td);</div><div class="line">int mdecrypt_generic(MCRYPT td, void *plaintext, int len);</div><div class="line">int mcrypt_generic(MCRYPT td, void *plaintext, int len);</div><div class="line">int mcrypt_module_close(MCRYPT td);</div><div class="line"></div><div class="line">]]</div><div class="line"></div><div class="line"><span class="keyword">local</span> mcrypt = ffi.<span class="built_in">load</span>(<span class="string">'libmcrypt.so.4'</span>)</div><div class="line"></div><div class="line">_M.new = <span class="function"><span class="keyword">function</span> <span class="params">(self)</span></span></div><div class="line">    <span class="keyword">local</span> cipher = <span class="string">'blowfish'</span></div><div class="line">    <span class="keyword">local</span> mode = <span class="string">'cbc'</span></div><div class="line"></div><div class="line">    <span class="keyword">local</span> c_cipher = ffi_new(<span class="string">"char[9]"</span>, cipher)</div><div class="line">    <span class="keyword">local</span> c_mode = ffi_new(<span class="string">"char[4]"</span>, mode)</div><div class="line"></div><div class="line">    <span class="keyword">local</span> td = mcrypt.mcrypt_module_open(c_cipher, <span class="keyword">nil</span>, c_mode, <span class="keyword">nil</span>)</div><div class="line">    <span class="keyword">return</span> <span class="built_in">setmetatable</span>( &#123; _td = td &#125;, mt )</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">_M.encrypt = <span class="function"><span class="keyword">function</span><span class="params">(self, key, raw)</span></span></div><div class="line">    <span class="keyword">local</span> iv_len = <span class="number">8</span></div><div class="line">    <span class="keyword">local</span> td = self._td</div><div class="line"></div><div class="line">    <span class="keyword">local</span> c_key = ffi_new(<span class="string">"char[?]"</span>, #key+<span class="number">1</span>, key)</div><div class="line">    <span class="keyword">local</span> c_iv = ffi_new(<span class="string">"char[9]"</span>, key)</div><div class="line">    <span class="keyword">local</span> c_raw = ffi_new(<span class="string">"char[?]"</span>, #raw+<span class="number">1</span>, raw)</div><div class="line"></div><div class="line">    mcrypt.mcrypt_generic_init(td, c_key, #key, c_iv)</div><div class="line">    mcrypt.mcrypt_generic(td, c_raw, #raw )</div><div class="line">    mcrypt.mcrypt_generic_deinit(td)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ffi_str(c_raw, ffi.sizeof(c_raw)<span class="number">-1</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">_M.decrypt = <span class="function"><span class="keyword">function</span><span class="params">(self, key, raw)</span></span></div><div class="line">    <span class="keyword">local</span> iv_len = <span class="number">8</span></div><div class="line">    <span class="keyword">local</span> td = self._td</div><div class="line"></div><div class="line">    <span class="keyword">local</span> c_key = ffi_new(<span class="string">"char[?]"</span>, #key+<span class="number">1</span>, key)</div><div class="line">    <span class="keyword">local</span> c_iv = ffi_new(<span class="string">"char[9]"</span>, key)</div><div class="line">    <span class="keyword">local</span> c_raw = ffi_new(<span class="string">"char[?]"</span>, #raw+<span class="number">1</span>, raw)</div><div class="line"></div><div class="line">    mcrypt.mcrypt_generic_init(td, c_key, #key, c_iv)</div><div class="line">    mcrypt.mdecrypt_generic(td, c_raw, #raw )</div><div class="line">    mcrypt.mcrypt_generic_deinit(td)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ffi_str(c_raw, ffi.sizeof(c_raw)<span class="number">-1</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">_M.close = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></div><div class="line">    <span class="keyword">local</span> td = self._td</div><div class="line">    <span class="keyword">if</span> td <span class="keyword">then</span></div><div class="line">        mcrypt.mcrypt_module_close(td)</div><div class="line">     <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> _M</div></pre></td></tr></table></figure>
<p>使用方法比较简单，代码里面写死了是 <code>blowfish</code> 的 <code>cbc</code> 模式，并且 iv 使用 key 的前 8 个字符<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">local</span> mcrypt = <span class="keyword">require</span> <span class="string">"mcrypt"</span></div><div class="line"><span class="built_in">local</span> m = mcrypt:<span class="literal">new</span>()</div><div class="line"></div><div class="line">-- 一系列加解密</div><div class="line"><span class="built_in">local</span> en = m:encrypt(<span class="string">'xxx'</span>,<span class="string">'yyyy'</span>)</div><div class="line"><span class="attr">...</span></div><div class="line"><span class="built_in">local</span> de = m:decrypt(<span class="string">'xxx'</span>, yyyy<span class="string">')</span></div><div class="line"></div><div class="line">-- 最后关闭</div><div class="line">m:close()</div></pre></td></tr></table></figure></p>
</div>

<div class="meta">
	
		<span class="comments"><a href="http://wdicc.com/libmcrypt-ffi-module/#disqus_thread">Comments</a></span>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=null"></script>
</div>





    
      <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = 'http://wdicc.com/libmcrypt-ffi-module/';
            this.page.identifier = 'http://wdicc.com/libmcrypt-ffi-module/';
        };

        (function() {
          var d = document, s = d.createElement('script');
          s.src = '//wdicc.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    


<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>


    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2016

    wd
. Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> |
    Theme is <a href="https://github.com/wd/hexo-fabric">hexo-fabric</a>, fork from <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
