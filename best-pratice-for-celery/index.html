<!doctype html><html lang=en><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://wdicc.com/favicon.ico><title>Best Pratice for Celery | wd and cc</title><meta name=title content="Best Pratice for Celery"><meta name=description content="

Celery beat and worker



Celery works with two separate parts, the beat and the worker. The beat is the control center which determine when and where to send the tasks, there should be only one beat in each celery network. The worker is the one who runs the tasks and send the results back to the beat, there could be lots of works in each network.




Result backend



Result backend is the place where task results stored. By default, celery support many storage types, like PostgreSQL, Redis, etc. If you store the results in the database, you may need to clean the old data from the database periodically. I use Redis as the result backend, it will expire the old data automatically."><meta name=keywords content="celery,django,"><meta property="og:url" content="https://wdicc.com/best-pratice-for-celery/"><meta property="og:site_name" content="wd and cc"><meta property="og:title" content="Best Pratice for Celery"><meta property="og:description" content="Celery beat and worker Celery works with two separate parts, the beat and the worker. The beat is the control center which determine when and where to send the tasks, there should be only one beat in each celery network. The worker is the one who runs the tasks and send the results back to the beat, there could be lots of works in each network.
Result backend Result backend is the place where task results stored. By default, celery support many storage types, like PostgreSQL, Redis, etc. If you store the results in the database, you may need to clean the old data from the database periodically. I use Redis as the result backend, it will expire the old data automatically."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-07-17T15:27:48+08:00"><meta property="article:modified_time" content="2019-07-17T15:27:48+08:00"><meta property="article:tag" content="Celery"><meta property="article:tag" content="Django"><meta name=twitter:card content="summary"><meta name=twitter:title content="Best Pratice for Celery"><meta name=twitter:description content="Celery beat and worker Celery works with two separate parts, the beat and the worker. The beat is the control center which determine when and where to send the tasks, there should be only one beat in each celery network. The worker is the one who runs the tasks and send the results back to the beat, there could be lots of works in each network.
Result backend Result backend is the place where task results stored. By default, celery support many storage types, like PostgreSQL, Redis, etc. If you store the results in the database, you may need to clean the old data from the database periodically. I use Redis as the result backend, it will expire the old data automatically."><meta itemprop=name content="Best Pratice for Celery"><meta itemprop=description content="Celery beat and worker Celery works with two separate parts, the beat and the worker. The beat is the control center which determine when and where to send the tasks, there should be only one beat in each celery network. The worker is the one who runs the tasks and send the results back to the beat, there could be lots of works in each network.
Result backend Result backend is the place where task results stored. By default, celery support many storage types, like PostgreSQL, Redis, etc. If you store the results in the database, you may need to clean the old data from the database periodically. I use Redis as the result backend, it will expire the old data automatically."><meta itemprop=datePublished content="2019-07-17T15:27:48+08:00"><meta itemprop=dateModified content="2019-07-17T15:27:48+08:00"><meta itemprop=wordCount content="420"><meta itemprop=keywords content="Celery,Django"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--code-background-color:#f2f2f2;--code-color:#222;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--code-background-color:#000;--code-color:#ddd;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px}blockquote{border-left:1px solid #999;color:var(--code-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto !important}.highlight,.code{padding:1px 15px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>wd and cc</h2></a><p>-- Good good study, day day up!</p><nav><a href=/>Home</a>
<a href=/posts/>Posts</a>
<a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a>
<a href=/tags/>Tags</a>
<a href=/atom.xml>subscribe</a></nav></header><main><h1>Best Pratice for Celery</h1><p><i><time datetime=2019-07-17>17 Jul, 2019
</time></i><a href=https://wdicc.com/tags/celery/>#Celery</a>
<a href=https://wdicc.com/tags/django/>#Django</a></p><content><div id=outline-container-headline-1 class=outline-3><h3 id=headline-1>Celery beat and worker</h3><div id=outline-text-headline-1 class=outline-text-3><p>Celery works with two separate parts, the beat and the worker. The beat is the control center which determine when and where to send the tasks, there should be only one beat in each celery network. The worker is the one who runs the tasks and send the results back to the beat, there could be lots of works in each network.</p></div></div><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>Result backend</h3><div id=outline-text-headline-2 class=outline-text-3><p>Result backend is the place where task results stored. By default, celery support many storage types, like PostgreSQL, Redis, etc. If you store the results in the database, you may need to clean the old data from the database periodically. I use Redis as the result backend, it will expire the old data automatically.</p></div></div><div id=outline-container-headline-3 class=outline-3><h3 id=headline-3>Broker</h3><div id=outline-text-headline-3 class=outline-text-3><p>Broker is used to communicate among the workers and the beta. Celery support Redis, RabbitMQ, etc. as it’s broker. I use Redis too, in a different database with the result backend.</p></div></div><div id=outline-container-headline-4 class=outline-3><h3 id=headline-4>Scheduler</h3><div id=outline-text-headline-4 class=outline-text-3><p>Scheduler is the place where you can add periodically tasks. The tasks store in a local database file by default. You can specify the file by <code>-s /home/celery/var/run/celerybeat-schedule</code>, you also can use a custom scheduler like a <a href=http://docs.celeryproject.org/en/master/userguide/periodic-tasks.html#id8>database table</a>, but I think the default method is more simple and convenient to use. The only problem is when you want to migrate the scheduler to an other server, you may also need to transfer the database file.</p></div></div><div id=outline-container-headline-5 class=outline-3><h3 id=headline-5>Running commands</h3><div id=outline-text-headline-5 class=outline-text-3><p>You can run the worker like:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ celery -A proj beat</span></span></code></pre></div></div><p>And also can run the beat with the worker:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ celery -A proj worker —beat</span></span></code></pre></div></div><p>Or run the beat separately like:</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ celery -A proj beat -s /home/celery/var/run/celerybeat-schedule</span></span></code></pre></div></div></div></div><div id=outline-container-headline-6 class=outline-3><h3 id=headline-6>Monitoring</h3><div id=outline-text-headline-6 class=outline-text-3><p>Celery has provided some command to show it's running status.</p><div class="src src-shell"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>// List active nodes in this cluster
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>$ celery -A proj status
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>// inspect tasks
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>$ celery -A proj inspect active
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>$ celery -A proj inspect scheduled
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>$ celery -A proj inspect reserved
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>$ celery -A proj inspect revoked
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>// Curses Celery task monitor
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>$ celery -A proj events</span></span></code></pre></div></div><p>Also, there is a web-monitor named <a href=https://flower.readthedocs.io/en/latest/>Flower</a>. It can connect to the broker and inspect the task status in real-time.</p></div></div><div id=outline-container-headline-7 class=outline-3><h3 id=headline-7>It's better to not mix configurations with django</h3><div id=outline-text-headline-7 class=outline-text-3><p>You maybe want to check my <a href=/logging-in-celery-and-django/>last post for celery and django</a>, the log files will be both processed by django and celery but by different process, this may cause some problems.</p><p>You can put some common settings like redis, database in a sperate file, and import in django and celery, but don't import django settings into celery.</p></div></div></content><div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//wdicc.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>