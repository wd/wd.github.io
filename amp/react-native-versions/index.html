<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,viewport-fit=cover,initial-scale=1"><title>React Native Versions | wd and cc</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><header><nav><ul><li class=pull-left><a href=https://wdicc.com/>/home/wd and cc</a></li><li class=pull-left><a href=/tags/>~/tags</a></li><li class=pull-left><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&q=">~/search</a></li><li class=pull-right><a href=/atom.xml>~/subscribe</a></li></ul></nav></header></head><body><br><div class=article-meta><h1><span class=title>React Native Versions</span></h1><h2 class=date>2019/07/26</h2><p class=terms>Tags: <a href=/tags/react-native>react-native</a></p></div><div id=TOC></div><main><p>RN 里面有很多个个版本号</p><ol><li><p><code>package.json</code> 里面定义的 <code>version</code> 。</p></li><li><p><code>android/app/build.gradle</code> 里面定义的 <code>versionName</code> 和 <code>versionCode</code> 。</p></li><li><p><code>ios/YOURAPP/Info.plist</code> 里面定义的 <code>CFBundleShortVersionString</code> 和 <code>CFBundleVersion</code> 。</p></li><li><p>如果你使用 code-push 的话，还有一个 code-push 自己的版本号，叫做 <code>Label</code> 一般是 <code>v</code> 开头的。</p></li></ol><p>这几个版本号都有用，需要有规划的使用。我的经验如下。</p><ol><li><p>统一 <code>version</code>, <code>versionName</code>, <code>CFBundleShortVersionString</code> ，使用类似 <code>x.y.z</code> 这样的格式，升级的时候都一起升级，每次发布这个版本前都会在 git 打一个 tag。这个是用来表示用户看到的 native 的版本。这样你的 app 在 ios 和 android 的市场里面，同一个版本的，一般就是同一套代码打包的，</p></li><li><p><code>versionCode</code> 和 <code>CFBundleVersion</code> 各自表示各平台软件的真实版本，可能会出现同一个 1 里面的版本的情况下，这个有多个的情况。一般的应用市场发布的时候，也是认这个版本号的。这个编号只增不减，原则上每次打包都增加，不管代码有无变更。</p></li><li><p>如果使用了 code-push，那还 1 里面的版本号还需要遵守一个原则：</p><ol><li><p>如果 native 代码有变更，那需要增加 <code>x.y</code> ，比如可以从 <code>1.0</code> 变成 <code>1.1</code> 也可以是变成 <code>2.0</code> 。</p></li><li><p>如果只是 js 代码更新，那只增加 <code>z</code> ，其他不变，同时 code-push 发布的时候，使用 <code>-t</code> 指定 target version 为 <code>x.y.0 ~ x.y.z</code> 这样的形式。</p></li></ol></li></ol><p>基于上面的设置，实际一个 app 的版本号就是类似于 <code>1.2.2(111)-v23</code> 或者 <code>1.2.2(111)-un</code> 这样的形式。 <code>1.2.2</code> 表示 native 版本， <code>111</code> 是编译版本， <code>v23</code> 是 codepush 的版本，如果没更新 codepush 那可能是 <code>un</code> 。 <code>1.2.2(111)</code> 部分可以通过 RN 模块或者程序启动时候注入到 js 里面来， <code>v23</code> 部分可以使用 codepush 的 api 取。</p><p>一般我们以 <code>package.json</code> 里面的版本为准，android 可以让 gradle 读取这个文件自动变更版本， ios 需要自己写一个程序。</p><div class="src src-groovy"><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=color:#339;font-weight:700>def</span> <span style=color:#06b;font-weight:700>getNpmVersion</span><span style=color:#333>()</span> <span style=color:#333>{</span>
    <span style=color:#339;font-weight:700>def</span> inputFile <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> File<span style=color:#333>(</span><span style=background-color:#fff0f0>&#34;../package.json&#34;</span><span style=color:#333>)</span>
    <span style=color:#339;font-weight:700>def</span> packageJson <span style=color:#333>=</span> <span style=color:#080;font-weight:700>new</span> JsonSlurper<span style=color:#333>().</span><span style=color:#00c>parseText</span><span style=color:#333>(</span>inputFile<span style=color:#333>.</span><span style=color:#00c>text</span><span style=color:#333>)</span>
    <span style=color:#080;font-weight:700>return</span> packageJson<span style=color:#333>[</span><span style=background-color:#fff0f0>&#34;version&#34;</span><span style=color:#333>]</span>
<span style=color:#333>}</span>

<span style=color:#339;font-weight:700>def</span> <span style=color:#06b;font-weight:700>getNpmVersionArray</span><span style=color:#333>()</span> <span style=color:#333>{</span> <span style=color:#888>// major [0], minor [1], patch [2]
</span><span style=color:#888></span>    <span style=color:#339;font-weight:700>def</span> <span style=color:#333>(</span>major<span style=color:#333>,</span> minor<span style=color:#333>,</span> patch<span style=color:#333>)</span> <span style=color:#333>=</span> getNpmVersion<span style=color:#333>().</span><span style=color:#00c>tokenize</span><span style=color:#333>(</span><span style=background-color:#fff0f0>&#39;.&#39;</span><span style=color:#333>)</span>
    <span style=color:#080;font-weight:700>return</span> <span style=color:#333>[</span>Integer<span style=color:#333>.</span><span style=color:#00c>parseInt</span><span style=color:#333>(</span>major<span style=color:#333>),</span> Integer<span style=color:#333>.</span><span style=color:#00c>parseInt</span><span style=color:#333>(</span>minor<span style=color:#333>),</span> Integer<span style=color:#333>.</span><span style=color:#00c>parseInt</span><span style=color:#333>(</span>patch<span style=color:#333>)]</span> <span style=color:#080;font-weight:700>as</span> <span style=color:#339;font-weight:700>int</span><span style=color:#333>[]</span>
<span style=color:#333>}</span>

versionName <span style=background-color:#fff0f0>&#34;${versionMajor}.${versionMinor}.${versionPatch}&#34;</span></code></pre></td></tr></table></div></div></div><p>ios 写程序用类似命令改 <code>/usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${PACKAGE_VERSION}" "ios/YOURAPP/Info.plist"</code> 就可以。可以修改 package.json 增加 <code>version</code></p><div class="src src-javascript"><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>    <span style=background-color:#fff0f0>&#34;scripts&#34;</span><span style=color:#333>:</span> {
        <span style=background-color:#fff0f0>&#34;start&#34;</span><span style=color:#333>:</span> <span style=background-color:#fff0f0>&#34;node node_modules/react-native/local-cli/cli.js start&#34;</span>,
        <span style=background-color:#fff0f0>&#34;test&#34;</span><span style=color:#333>:</span> <span style=background-color:#fff0f0>&#34;jest&#34;</span>,
        <span style=background-color:#fff0f0>&#34;lint&#34;</span><span style=color:#333>:</span> <span style=background-color:#fff0f0>&#34;node_modules/.bin/eslint app&#34;</span>,
        <span style=background-color:#fff0f0>&#34;version&#34;</span><span style=color:#333>:</span> <span style=background-color:#fff0f0>&#34;./version-ios.sh&#34;</span>,
        <span style=background-color:#fff0f0>&#34;precommit&#34;</span><span style=color:#333>:</span> <span style=background-color:#fff0f0>&#34;./pre-commit&#34;</span>,
        <span style=background-color:#fff0f0>&#34;postinstall&#34;</span><span style=color:#333>:</span> <span style=background-color:#fff0f0>&#34;patch-package&#34;</span>
    },
</code></pre></td></tr></table></div></div></div><p>使用 npm version 的时候就可以自动同步修改 ios，android 的版本号了。</p></main><section id=comment><h2 class=title>Comments</h2><div id=disqus_thread aria-live=polite><noscript>Please enable JavaScript to view the <a href=//disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></section><script type=text/javascript>var disqus_config=function(){this.page.url='';this.page.identifier='';};(function(){var d=document,s=d.createElement('script');s.src='//wdicc.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><footer style=clear:both><hr>Theme from <a href=https://github.com/wd/hugo-classic>hugo-classic</a> fork from <a href=https://github.com/goodroot/hugo-classic>Github</a></footer></body></html>