<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Best Practice for React-Native and Redux - wd and cc</title><link rel=icon type=image/png href=/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Best Practice for React-Native and Redux"><meta property="og:description" content="从 6 月到现在，在 RN 上面摸爬滚打了一段时间了，目前总算找到了一个适合我们自我感觉还可以的开发模式。 一开"><meta property="og:type" content="article"><meta property="og:url" content="https://wdicc.com/amp/best-practice-for-react-native-redux/"><meta property="article:published_time" content="2017-11-26T09:19:11+08:00"><meta property="article:modified_time" content="2017-11-26T09:19:11+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Best Practice for React-Native and Redux"><meta name=twitter:description content="从 6 月到现在，在 RN 上面摸爬滚打了一段时间了，目前总算找到了一个适合我们自我感觉还可以的开发模式。 一开"><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://wdicc.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://wdicc.com/css/main.css><link rel=stylesheet type=text/css href=https://wdicc.com//light-syntax.css media="(prefers-color-scheme: light)"><link rel=stylesheet type=text/css href=https://wdicc.com/css/dark.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=https://wdicc.com//dark-syntax.css media="(prefers-color-scheme: dark)"><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=https://wdicc.com/js/main.js></script></head><body><div class="container wrapper post"><div class=header><base href=https://wdicc.com/><h1 class=site-title><a href=https://wdicc.com/>wd and cc</a></h1><div class=site-description><h2>&mdash; Happy every day</h2><nav class="nav social"><ul class=flat><a href=https://github.com/wd title=Github><i data-feather=github></i></a><a href=https://twitter.com/wd title=Twitter><i data-feather=twitter></i></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/post>All posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></nav></div><div class=post-header><h1 class=title>Best Practice for React-Native and Redux</h1><div class=meta>Posted at &mdash; Nov 26, 2017</div></div><div class=post-header><nav id=TableOfContents><ul><li><a href=#headline-1>目录结构安排</a></li><li><a href=#headline-2>给页面设计一个基类</a></li><li><a href=#headline-3>一个 app 一个统一的 store</a></li><li><a href=#headline-4>store 设计和页面无关</a></li><li><a href=#headline-5>每个页面都使用自己的 props</a></li><li><a href=#headline-6>shouldComponentUpdate</a></li><li><a href=#headline-7>使用 reselect</a></li><li><a href=#headline-8>适当使用页面的 state</a></li><li><a href=#headline-9>Android 的返回按钮处理</a></li><li><a href=#headline-10>表单的弹出页面，不一定需要使用 store</a></li><li><a href=#headline-11>参考文章</a></li></ul></nav></div><div class=markdown><p>从 6 月到现在，在 RN 上面摸爬滚打了一段时间了，目前总算找到了一个适合我们自我感觉还可以的开发模式。</p><p>一开始，我们使用的是传统的 React 的模式，然后一个 app 页面一个文件，通过 StackNavigator 组合到一起。这么做在我们的第一个 app 里面没觉得有什么问题，每个页面维护自己的数据，页面之间需要数据共享或者通讯的时候（比如从 list 到详情页面的时候，详情里面有一个改变状态的按钮，状态改变之后希望 list 的状态也跟着变化，这样用户返回之后能看到正确的数据）有 2 个方式。</p><ul><li><p>通过 DeviceEventEmitter。
需要数据的页面订阅，然后在其他页面 emit event 之后前面的页面就可以收到。这个时候可以只通知改变的数据的字段，前一个页面直接去修改，这样可以避免重新刷新页面。也可以发一个简单的通知让其他页面去自己获取数据。</p></li><li><p>通过 navigator 提供的 params 属性。
StatckNavigator 提供了一个 params 属性。就是 <code class=verbatim>this.props.navigation.state.params</code> ，可以通过 setParams 来改变，或者通过类似 <code class=verbatim>this.props.navigation.navigate('Login', {goBackToHome: true})</code> 的方式给，那个 <code class=verbatim>goBackToHome</code> 将来就会在 params 里面。</p></li></ul><p>直到我们开始做第二个 app。</p><p>第二个 app 是一个单页面 app，登录之后就只有一个页面了，有一个大地图，有左侧 sidebar，sidebar 里面的按钮点击还会出其他页面。这个肯定不能按照我们前面的思路来做了，我们按照组件，拆分了不同的文件，然后组合起来。这个时候更加会需要页面之间的通讯，并且这个时候可选项只有第一个了 <code class=verbatim>DeviceEventEmitter</code> ，因为都没有 navigate 什么事情。</p><p>这个时候就发现一个问题，event 太多了，开始有点混乱了。emit event 之后，慢慢会发现不知道哪里有订阅，不好管理。这个 app 做完之后，就仔细研究了一下 redux。</p><p>其实写第一个 app 的时候就知道 redux，但是很多概念看的云里雾里的，当时在 react 还没有吃透的情况下，根本没有能力把 redux 搞好。所以当时放弃了 redux。</p><p>了解 redux 之后，感觉这个东西是我们的药。统一的 state 管理，这不就不用考虑状态传递了么？所以一门心思开始研究 redux。刚好我们第一个 app 需要全新改版，我们就借机把我们的第一个 app 也重构到了 redux 实现。整体过程还是蛮舒服的，自己也总结了几条我们自己的使用的思路。</p><div id=outline-container-headline-1 class=outline-4><h4 id=headline-1>目录结构安排</h4><div id=outline-text-headline-1 class=outline-text-4><p>先大概看看我们 app 的目录结构。我们把所有的 js 文件都放到了 app 目录下面。</p><div class="src src-text"><div class=highlight><pre class=chroma><code class=language-text data-lang=text>app
ios
android
index.js</code></pre></div></div><p>然后 app 目录下面，分了 <code class=verbatim>actions</code> ， <code class=verbatim>reducers</code> ， <code class=verbatim>sagas</code> ， <code class=verbatim>selector</code> 几个目录。</p><div class="src src-text"><div class=highlight><pre class=chroma><code class=language-text data-lang=text>actions
images
index.js
reducers
sagas
screens
selectors
utility</code></pre></div></div><ul><li><p>actions 里面放的是 mapDispatchToProps 这个逻辑对应的东西。</p></li><li><p>reducers 里面放的是 reducers。</p></li><li><p>sagas 里面放的是所有网络请求相关的 actions 的处理逻辑。</p></li><li><p>seelctor 里面放的是 mapStateToProps 这个逻辑对应的东西。</p></li></ul><p>每个目录里面也都有一个自己的 index.js 把本目录里面的内容组合起来。通过最外面的 index.js 把这几个目录的逻辑组合起来。</p></div></div><div id=outline-container-headline-2 class=outline-4><h4 id=headline-2>给页面设计一个基类</h4><div id=outline-text-headline-2 class=outline-text-4><p>这样会比较方便你去做一些所有页面都需要做的事情。</p></div></div><div id=outline-container-headline-3 class=outline-4><h4 id=headline-3>一个 app 一个统一的 store</h4><div id=outline-text-headline-3 class=outline-text-4><p>我们 app 还不大，所以这么设计也还好，如果页面比较复杂，我看也有组件使用自己的 store 的例子，这个还没有经验。这么做唯一一个问题就是，那个 store 里面的数据一直都在，多少会占用一些内存。不过我是觉得没啥了，其实这点内存占用不算啥。</p></div></div><div id=outline-container-headline-4 class=outline-4><h4 id=headline-4>store 设计和页面无关</h4><div id=outline-text-headline-4 class=outline-text-4><p>Store 参考了一个文章统一设计，和页面无关。比如我们设计了 user, orders, orderDetail 这些 state，数据所有页面共享。否则如果按照页面来划分的话，某些页面之间如果有用到共享数据就要么多复制一份，那有点浪费了，要么就是会有点乱。</p></div></div><div id=outline-container-headline-5 class=outline-4><h4 id=headline-5>每个页面都使用自己的 props</h4><div id=outline-text-headline-5 class=outline-text-4><p>不在页面间交叉使用 props ，这样不会乱。并且因为我们是一个统一的 store，所以其实每次 props 变化，所有页面都会 render。这个我使用下面的一个思路来解决了。</p></div></div><div id=outline-container-headline-6 class=outline-4><h4 id=headline-6>shouldComponentUpdate</h4><div id=outline-text-headline-6 class=outline-text-4><p>这个就是在页面的基类里面，通过比较判断本页面的 props 是否有变化来解决前面那个 render 问题。</p></div></div><div id=outline-container-headline-7 class=outline-4><h4 id=headline-7>使用 reselect</h4><div id=outline-text-headline-7 class=outline-text-4><p>因为只要 state 发生变化 redux 就会调用 mapStateToProps 来计算 props，这个计算有一些消耗，毕竟一般也就其中一个页面的 props 需要计算。我们用这个 reselect 解决这个问题，一个页面的 props 需要的 state 没变化的时候，reselect 就可以把 cache 的数据直接返回就好了。</p></div></div><div id=outline-container-headline-8 class=outline-4><h4 id=headline-8>适当使用页面的 state</h4><div id=outline-text-headline-8 class=outline-text-4><p>redux 的理念是所有页面的 state 都放到了 store 里面，你不需要做 setState 动作了。但是实际上有些时候适当使用 state 会让你的开发更加方便。比如表单验证，用户输入数据之后点击提交 ，如果通过发送 action 改变 state 然后再通过 selector 返回页面，那就有点太费劲了。而直接通过 setState 设定页面 state，然后在提交表单的时候读出来做验证就简单多了。</p><p>有时候页面的一些 state 是和 props 有关系的，这个时候可以使用 <code class=verbatim>componentWillReceiveProps(nextProps)</code> 来判定，然后和 state 同步。</p></div></div><div id=outline-container-headline-9 class=outline-4><h4 id=headline-9>Android 的返回按钮处理</h4><div id=outline-text-headline-9 class=outline-text-4><p>android 有一个实体的返回按钮，StackNavigator 给出的<a href=https://reactnavigation.org/docs/guides/redux#Handling-the-Hardware-Back-Button-in-Android>方案</a>是监听一个 <code class=verbatim>hardwareBackPress</code> 事件，然后 <code class=verbatim>dispatch(NavigationActions.back())</code> ，但是有一个问题是，有时候我们返回的时候还需要做一些自己的动作。比如清理 store 的数据，或者判断一下往哪里返什么的，比如用户刚提交了订单之后，给了一个按钮可以看订单详情，这个时候从详情返回就希望直接到首页，不要又返回新建订单的页面。</p><p>我们通过下面的思路做的</p><div class="src src-javascript"><div class=highlight><pre class=chroma><code class=language-javascript data-lang=javascript>    <span class=nx>onBackPress</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
        <span class=kr>const</span> <span class=p>{</span> <span class=nx>dispatch</span><span class=p>,</span> <span class=nx>nav</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>;</span>

        <span class=k>if</span> <span class=p>(</span><span class=nx>nav</span><span class=p>.</span><span class=nx>index</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=kr>const</span> <span class=p>{</span><span class=nx>routes</span><span class=p>}</span> <span class=o>=</span> <span class=nx>nav</span><span class=p>;</span>
        <span class=kr>const</span> <span class=p>{</span><span class=nx>params</span><span class=p>}</span> <span class=o>=</span> <span class=nx>routes</span><span class=p>[</span><span class=nx>routes</span><span class=p>.</span><span class=nx>length</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>

        <span class=k>if</span><span class=p>(</span><span class=nx>params</span> <span class=o>&amp;&amp;</span> <span class=nx>params</span><span class=p>.</span><span class=nx>goBack</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>params</span><span class=p>.</span><span class=nx>goBack</span><span class=p>();</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=nx>dispatch</span><span class=p>(</span><span class=nx>NavigationActions</span><span class=p>.</span><span class=nx>back</span><span class=p>());</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
    <span class=p>};</span>
</code></pre></div></div><p>然后在页面的基类里面</p><div class="src src-javascript"><div class=highlight><pre class=chroma><code class=language-javascript data-lang=javascript>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>props</span><span class=p>)</span> <span class=p>{</span>
        <span class=kr>super</span><span class=p>(</span><span class=nx>props</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>goBack</span><span class=p>)</span>
            <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>navigation</span><span class=p>.</span><span class=nx>setParams</span><span class=p>({</span> <span class=nx>goBack</span><span class=o>:</span> <span class=p>()=&gt;</span><span class=k>this</span><span class=p>.</span><span class=nx>goBack</span><span class=p>()</span> <span class=p>})</span>
    <span class=p>}</span>
</code></pre></div></div><p>然后页面里面如果有自己的特殊逻辑，那就实现一个 <code class=verbatim>goBack</code> 方法就好了。</p></div></div><div id=outline-container-headline-10 class=outline-4><h4 id=headline-10>表单的弹出页面，不一定需要使用 store</h4><div id=outline-text-headline-10 class=outline-text-4><p>比如一个下单页面，需要填联系人信息，这个时候我们一般会到一个联系人的页面来选择联系人。这个时候在这个页面选择的联系人，如何传递给上一个页面呢？有两个类型的方法。</p><p>第一个方法自然就是 redux 的方法，在选择页面点确定的时候，触发 action 通过 reducer 设置这个页面的 store，然后通过 selector 修改上一个页面的 props，这样就达到了传递的目的。</p><p>第二个方法是在新页面打开的时候，通过 navigater 传一个 callback 过去，那边选择好的时候，调用这个回调方法把数据传回来。</p><p>第一个方法贴合 redux 的做法，但是存在一个问题，如果这个新的选择页面在多个地方出现，那么就需要有一个区分，当前这个选择是给哪个地方服务的(因为必须得在 redux 的 store 里面做好区分，否则两个页面总是相同的状态)。另外还有一个数据清理的问题，否则下次在别的页面打开这个页面，会有上次的数据残留。</p><p>第二个方法土一点，但是没有上面的问题。不过要注意的是，如果新的页面有网络请求，那这个时候还需要和 saga thunk 这些关联，那么就总是会走到 redux 的 store，所以这个方法就不适用了。</p></div></div><div id=outline-container-headline-11 class=outline-4><h4 id=headline-11>参考文章</h4><div id=outline-text-headline-11 class=outline-text-4><ul><li><p><a href=https://wdicc.com/11-mistakes-during-use-react-native/>11-mistakes-during-use-react-native</a></p></li></ul></div></div></div><div class=post-tags><nav class="nav tags"><ul class=flat><li><a href=/tags/react-native>react-native</a></li><li><a href=/tags/redux>redux</a></li><li><a href=/tags/app>app</a></li></ul></nav></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")
return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='wdicc';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by
Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div class="footer wrapper"><nav class=nav><div>Copyright © 2020 wd. All Rights Reserved | <a href=https://github.com/vividvilla/ezhil>Ezhil theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></nav></div><script>feather.replace()</script></body></html>