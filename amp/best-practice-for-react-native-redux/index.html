<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Best Practice for React-Native and Redux | wd and cc</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <header>

  
  

  <link rel="stylesheet" href="https://wdicc.com//css/hljs.css">
  <script src="https://wdicc.com//js/hljs.js"></script>

  <script>hljs.initHighlightingOnLoad();</script>
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://wdicc.com/">/home/wd and cc</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/tags/">~/tags</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/resume/">~/resume</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">~/search</a>
      </li>
      

      
      
      <li class="pull-right">
        <a href="/atom.xml">~/subscribe</a>
      </li>
      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">Best Practice for React-Native and Redux</span></h1>

<h2 class="date">2017/11/26</h2>
<p class="terms">
  
  
  
  
  Tags: <a href="/tags/react-native">react-native</a> <a href="/tags/redux">redux</a> <a href="/tags/app">app</a> 
  
  
</p>
</div>









<div id="TOC">
    
    <h4 class="text-muted">Table of Contents</h4>
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                    <ul class="toc-h2">
                
                    <ul class="toc-h3">
                
                
                
                
                <li>
                    <a href="/best-practice-for-react-native-redux/#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84%e5%ae%89%e6%8e%92"> 目录结构安排 </a>
                </li>
                
                
                    </ul>
                
                    </ul>
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                    <ul class="toc-h2">
                
                    <ul class="toc-h3">
                
                
                
                
                <li>
                    <a href="/best-practice-for-react-native-redux/#%e7%bb%99%e9%a1%b5%e9%9d%a2%e8%ae%be%e8%ae%a1%e4%b8%80%e4%b8%aa%e5%9f%ba%e7%b1%bb"> 给页面设计一个基类 </a>
                </li>
                
                
                    </ul>
                
                    </ul>
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                    <ul class="toc-h2">
                
                    <ul class="toc-h3">
                
                
                
                
                <li>
                    <a href="/best-practice-for-react-native-redux/#%e4%b8%80%e4%b8%aa-app-%e4%b8%80%e4%b8%aa%e7%bb%9f%e4%b8%80%e7%9a%84-store"> 一个 app 一个统一的 store </a>
                </li>
                
                
                    </ul>
                
                    </ul>
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                    <ul class="toc-h2">
                
                    <ul class="toc-h3">
                
                
                
                
                <li>
                    <a href="/best-practice-for-react-native-redux/#store-%e8%ae%be%e8%ae%a1%e5%92%8c%e9%a1%b5%e9%9d%a2%e6%97%a0%e5%85%b3"> store 设计和页面无关 </a>
                </li>
                
                
                    </ul>
                
                    </ul>
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                    <ul class="toc-h2">
                
                    <ul class="toc-h3">
                
                
                
                
                <li>
                    <a href="/best-practice-for-react-native-redux/#%e6%af%8f%e4%b8%aa%e9%a1%b5%e9%9d%a2%e9%83%bd%e4%bd%bf%e7%94%a8%e8%87%aa%e5%b7%b1%e7%9a%84-props"> 每个页面都使用自己的 props </a>
                </li>
                
                
                    </ul>
                
                    </ul>
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                    <ul class="toc-h2">
                
                    <ul class="toc-h3">
                
                
                
                
                <li>
                    <a href="/best-practice-for-react-native-redux/#shouldcomponentupdate"> shouldComponentUpdate </a>
                </li>
                
                
                    </ul>
                
                    </ul>
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                    <ul class="toc-h2">
                
                    <ul class="toc-h3">
                
                
                
                
                <li>
                    <a href="/best-practice-for-react-native-redux/#%e4%bd%bf%e7%94%a8-reselect"> 使用 reselect </a>
                </li>
                
                
                    </ul>
                
                    </ul>
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                    <ul class="toc-h2">
                
                    <ul class="toc-h3">
                
                
                
                
                <li>
                    <a href="/best-practice-for-react-native-redux/#%e9%80%82%e5%bd%93%e4%bd%bf%e7%94%a8%e9%a1%b5%e9%9d%a2%e7%9a%84-state"> 适当使用页面的 state </a>
                </li>
                
                
                    </ul>
                
                    </ul>
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                    <ul class="toc-h2">
                
                    <ul class="toc-h3">
                
                
                
                
                <li>
                    <a href="/best-practice-for-react-native-redux/#android-%e7%9a%84%e8%bf%94%e5%9b%9e%e6%8c%89%e9%92%ae%e5%a4%84%e7%90%86"> Android 的返回按钮处理 </a>
                </li>
                
                
                    </ul>
                
                    </ul>
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                    <ul class="toc-h2">
                
                    <ul class="toc-h3">
                
                
                
                
                <li>
                    <a href="/best-practice-for-react-native-redux/#%e8%a1%a8%e5%8d%95%e7%9a%84%e5%bc%b9%e5%87%ba%e9%a1%b5%e9%9d%a2%e4%b8%8d%e4%b8%80%e5%ae%9a%e9%9c%80%e8%a6%81%e4%bd%bf%e7%94%a8-store"> 表单的弹出页面，不一定需要使用 store </a>
                </li>
                
                
                    </ul>
                
                    </ul>
                
                    </ul>
                
            
        
    
        
        
            
                
                
                
                    <ul class="toc-h1">
                
                    <ul class="toc-h2">
                
                    <ul class="toc-h3">
                
                
                
                
                <li>
                    <a href="/best-practice-for-react-native-redux/#%e5%8f%82%e8%80%83%e6%96%87%e7%ab%a0"> 参考文章 </a>
                </li>
                
                
                    </ul>
                
                    </ul>
                
                    </ul>
                
            
        
    
</div>




<main>
<p>从 6 月到现在，在 RN 上面摸爬滚打了一段时间了，目前总算找到了一个适合我们自我感觉还可以的开发模式。</p>

<p>一开始，我们使用的是传统的 React 的模式，然后一个 app 页面一个文件，通过 StackNavigator 组合到一起。这么做在我们的第一个 app 里面没觉得有什么问题，每个页面维护自己的数据，页面之间需要数据共享或者通讯的时候（比如从 list 到详情页面的时候，详情里面有一个改变状态的按钮，状态改变之后希望 list 的状态也跟着变化，这样用户返回之后能看到正确的数据）有 2 个方式。</p>

<ul>
<li>通过 DeviceEventEmitter。</li>
  需要数据的页面订阅，然后在其他页面 emit event 之后前面的页面就可以收到。这个时候可以只通知改变的数据的字段，前一个页面直接去修改，这样可以避免重新刷新页面。也可以发一个简单的通知让其他页面去自己获取数据。
</ul>

<ul>
<li>通过 navigator 提供的 params 属性。</li>
  StatckNavigator 提供了一个 params 属性。就是 <code>this.props.navigation.state.params</code> ，可以通过 setParams 来改变，或者通过类似 <code>this.props.navigation.navigate('Login', {goBackToHome: true})</code> 的方式给，那个 <code>goBackToHome</code> 将来就会在 params 里面。
</ul>

<p>直到我们开始做第二个 app。</p>

<p>第二个 app 是一个单页面 app，登录之后就只有一个页面了，有一个大地图，有左侧 sidebar，sidebar 里面的按钮点击还会出其他页面。这个肯定不能按照我们前面的思路来做了，我们按照组件，拆分了不同的文件，然后组合起来。这个时候更加会需要页面之间的通讯，并且这个时候可选项只有第一个了 <code>DeviceEventEmitter</code> ，因为都没有 navigate 什么事情。</p>

<p>这个时候就发现一个问题，event 太多了，开始有点混乱了。emit event 之后，慢慢会发现不知道哪里有订阅，不好管理。这个 app 做完之后，就仔细研究了一下 redux。</p>

<p>其实写第一个 app 的时候就知道 redux，但是很多概念看的云里雾里的，当时在 react 还没有吃透的情况下，根本没有能力把 redux 搞好。所以当时放弃了 redux。</p>

<p>了解 redux 之后，感觉这个东西是我们的药。统一的 state 管理，这不就不用考虑状态传递了么？所以一门心思开始研究 redux。刚好我们第一个 app 需要全新改版，我们就借机把我们的第一个 app 也重构到了 redux 实现。整体过程还是蛮舒服的，自己也总结了几条我们自己的使用的思路。</p>

<h3 id="目录结构安排">目录结构安排</h3>

<p>先大概看看我们 app 的目录结构。我们把所有的 js 文件都放到了 app 目录下面。</p>

<pre><code>app
ios
android
index.js
</code></pre>

<p>然后 app 目录下面，分了 <code>actions</code> ， <code>reducers</code> ， <code>sagas</code> ， <code>selector</code> 几个目录。</p>

<pre><code>actions
images
index.js
reducers
sagas
screens
selectors
utility
</code></pre>

<ul>
<li>actions 里面放的是 mapDispatchToProps 这个逻辑对应的东西。</li>
<li>reducers 里面放的是 reducers。</li>
<li>sagas 里面放的是所有网络请求相关的 actions 的处理逻辑。</li>
<li>seelctor 里面放的是 mapStateToProps 这个逻辑对应的东西。</li>
</ul>

<p>每个目录里面也都有一个自己的 index.js 把本目录里面的内容组合起来。通过最外面的 index.js 把这几个目录的逻辑组合起来。</p>

<h3 id="给页面设计一个基类">给页面设计一个基类</h3>

<p>这样会比较方便你去做一些所有页面都需要做的事情。</p>

<h3 id="一个-app-一个统一的-store">一个 app 一个统一的 store</h3>

<p>我们 app 还不大，所以这么设计也还好，如果页面比较复杂，我看也有组件使用自己的 store 的例子，这个还没有经验。这么做唯一一个问题就是，那个 store 里面的数据一直都在，多少会占用一些内存。不过我是觉得没啥了，其实这点内存占用不算啥。</p>

<h3 id="store-设计和页面无关">store 设计和页面无关</h3>

<p>Store 参考了一个文章统一设计，和页面无关。比如我们设计了 user, orders, orderDetail 这些 state，数据所有页面共享。否则如果按照页面来划分的话，某些页面之间如果有用到共享数据就要么多复制一份，那有点浪费了，要么就是会有点乱。</p>

<h3 id="每个页面都使用自己的-props">每个页面都使用自己的 props</h3>

<p>不在页面间交叉使用 props ，这样不会乱。并且因为我们是一个统一的 store，所以其实每次 props 变化，所有页面都会 render。这个我使用下面的一个思路来解决了。</p>

<h3 id="shouldcomponentupdate">shouldComponentUpdate</h3>

<p>这个就是在页面的基类里面，通过比较判断本页面的 props 是否有变化来解决前面那个 render 问题。</p>

<h3 id="使用-reselect">使用 reselect</h3>

<p>因为只要 state 发生变化 redux 就会调用 mapStateToProps 来计算 props，这个计算有一些消耗，毕竟一般也就其中一个页面的 props 需要计算。我们用这个 reselect 解决这个问题，一个页面的 props 需要的 state 没变化的时候，reselect 就可以把 cache 的数据直接返回就好了。</p>

<h3 id="适当使用页面的-state">适当使用页面的 state</h3>

<p>redux 的理念是所有页面的 state 都放到了 store 里面，你不需要做 setState 动作了。但是实际上有些时候适当使用 state 会让你的开发更加方便。比如表单验证，用户输入数据之后点击提交 ，如果通过发送 action 改变 state 然后再通过 selector 返回页面，那就有点太费劲了。而直接通过 setState 设定页面 state，然后在提交表单的时候读出来做验证就简单多了。</p>

<p>有时候页面的一些 state 是和 props 有关系的，这个时候可以使用 <code>componentWillReceiveProps(nextProps)</code> 来判定，然后和 state 同步。</p>

<h3 id="android-的返回按钮处理">Android 的返回按钮处理</h3>

<p>android 有一个实体的返回按钮，StackNavigator 给出的<a href="https://reactnavigation.org/docs/guides/redux#Handling-the-Hardware-Back-Button-in-Android" title="方案">方案</a>是监听一个 <code>hardwareBackPress</code> 事件，然后 <code>dispatch(NavigationActions.back())</code> ，但是有一个问题是，有时候我们返回的时候还需要做一些自己的动作。比如清理 store 的数据，或者判断一下往哪里返什么的，比如用户刚提交了订单之后，给了一个按钮可以看订单详情，这个时候从详情返回就希望直接到首页，不要又返回新建订单的页面。</p>

<p>我们通过下面的思路做的</p>

<pre><code class="language-javascript">    onBackPress = () =&gt; {
        const { dispatch, nav } = this.props;

        if (nav.index === 0) {
            return false;
        }
        const {routes} = nav;
        const {params} = routes[routes.length-1]

        if(params &amp;&amp; params.goBack) {
            params.goBack();
        } else {
            dispatch(NavigationActions.back());
        }
        return true;
    };
</code></pre>

<p>然后在页面的基类里面</p>

<pre><code class="language-javascript">    constructor(props) {
        super(props);
        if (this.goBack)
            this.props.navigation.setParams({ goBack: ()=&gt;this.goBack() })
    }
</code></pre>

<p>然后页面里面如果有自己的特殊逻辑，那就实现一个 <code>goBack</code> 方法就好了。</p>

<h3 id="表单的弹出页面-不一定需要使用-store">表单的弹出页面，不一定需要使用 store</h3>

<p>比如一个下单页面，需要填联系人信息，这个时候我们一般会到一个联系人的页面来选择联系人。这个时候在这个页面选择的联系人，如何传递给上一个页面呢？有两个类型的方法。</p>

<p>第一个方法自然就是 redux 的方法，在选择页面点确定的时候，触发 action 通过 reducer 设置这个页面的 store，然后通过 selector 修改上一个页面的 props，这样就达到了传递的目的。</p>

<p>第二个方法是在新页面打开的时候，通过 navigater 传一个 callback 过去，那边选择好的时候，调用这个回调方法把数据传回来。</p>

<p>第一个方法贴合 redux 的做法，但是存在一个问题，如果这个新的选择页面在多个地方出现，那么就需要有一个区分，当前这个选择是给哪个地方服务的(因为必须得在 redux 的 store 里面做好区分，否则两个页面总是相同的状态)。另外还有一个数据清理的问题，否则下次在别的页面打开这个页面，会有上次的数据残留。</p>

<p>第二个方法土一点，但是没有上面的问题。不过要注意的是，如果新的页面有网络请求，那这个时候还需要和 saga thunk 这些关联，那么就总是会走到 redux 的 store，所以这个方法就不适用了。</p>

<h3 id="参考文章">参考文章</h3>

<ul>
<li><a href="https://wdicc.com/11-mistakes-during-use-react-native/" title="11-mistakes-during-use-react-native">11-mistakes-during-use-react-native</a></li>
</ul>

</main>


<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</section>



    
     <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = '';
            this.page.identifier = '';
        };

        (function() {
          var d = document, s = d.createElement('script');
          s.src = '//wdicc.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
     </script>
    



    <footer style="clear:both">
      
<script async src="//yihui.name/js/center-img.js"></script>

      
      <hr/>
      Theme from <a href="https://github.com/goodroot/hugo-classic">Github</a>
      
    </footer>
  </body>
</html>

