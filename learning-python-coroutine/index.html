<!doctype html><html lang=en><head><title>Learning Python Coroutine &ndash; wd and cc</title>
<meta name=description content="Good good study, day day up!"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://wdicc.com/css/palettes/base16-dark.css><link rel=stylesheet href=https://wdicc.com/css/risotto.css><link rel=stylesheet href=https://wdicc.com/css/custom.css><link rel=icon href=https://wdicc.com/favicon.ico></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><h1 class=page__logo><a href=https://wdicc.com/ class=page__logo-inner>wd and cc</a></h1><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/posts/ title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=" title>Search</a></li><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/atom.xml title>subscribe</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Learning Python Coroutine</h1></header><div class=content__body><p>看了一个视频 <a href="https://www.youtube.com/watch?time_continue=1780&amp;v=GSk0tIjDT10">OSB 2015 - How Do Python Coroutines Work?</a>，从头开始讲 coroutine 是怎么抽象出来的，感觉好厉害。自己写了一点程序学习了一下。之前写的关于 <a href=https://wdicc.com/python-coroutine/>coroutine</a> 的帖子。</p><p>先准备一个 <code>server.py</code> ，可以接受客户端请求。要注意的是要使用 <code>Threading</code> ，或者 <code>fork</code> 的 server，要不服务端执行并不支持并发，需要处理完一个才能处理下一个，这样会发现虽然客户端那边请求是并发的，但是返回结果的时候是顺序的。</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> socketserver
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> time <span style=color:#f92672>import</span> sleep
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>PORT <span style=color:#f92672>=</span> <span style=color:#ae81ff>2045</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyTCPHandler</span>(socketserver<span style=color:#f92672>.</span>BaseRequestHandler):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle</span>(self):
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>request<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>1024</span>)
</span></span><span style=display:flex><span>        sleep(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>request<span style=color:#f92672>.</span>sendall(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74> ok&#39;</span><span style=color:#f92672>.</span>format(data<span style=color:#f92672>.</span>decode())<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>():
</span></span><span style=display:flex><span>    server <span style=color:#f92672>=</span> socketserver<span style=color:#f92672>.</span>ThreadingTCPServer((HOST, PORT), MyTCPHandler)
</span></span><span style=display:flex><span>    server<span style=color:#f92672>.</span>serve_forever()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    run()</span></span></code></pre></div></div><p>然后是 <code>client.py</code> ，可以比较下里面 <code>sync_call</code> 和 <code>async_call</code> 的区别。</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> socket
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> time <span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> asyncio
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;127.0.0.1&#39;</span>
</span></span><span style=display:flex><span>PORT <span style=color:#f92672>=</span> <span style=color:#ae81ff>2045</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>start <span style=color:#f92672>=</span> time()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get</span>(path):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;get </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(path))
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket()
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>connect((HOST, PORT))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>sendall(path<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    chunk <span style=color:#f92672>=</span> s<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;get </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(chunk<span style=color:#f92672>.</span>decode()))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>sync_call</span>():
</span></span><span style=display:flex><span>    get(<span style=color:#e6db74>&#39;/bar&#39;</span>)
</span></span><span style=display:flex><span>    get(<span style=color:#e6db74>&#39;/foo&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>async_get</span>(path):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;get </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(path))
</span></span><span style=display:flex><span>    reader, writer <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> asyncio<span style=color:#f92672>.</span>open_connection(HOST, PORT)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    writer<span style=color:#f92672>.</span>write(path<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> writer<span style=color:#f92672>.</span>drain()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    chunk <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> reader<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;get </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(chunk<span style=color:#f92672>.</span>decode()))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>async_call</span>():
</span></span><span style=display:flex><span>    loop <span style=color:#f92672>=</span> asyncio<span style=color:#f92672>.</span>get_event_loop()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    t1 <span style=color:#f92672>=</span> loop<span style=color:#f92672>.</span>create_task(async_get(<span style=color:#e6db74>&#39;/bar&#39;</span>))
</span></span><span style=display:flex><span>    t2 <span style=color:#f92672>=</span> loop<span style=color:#f92672>.</span>create_task(async_get(<span style=color:#e6db74>&#39;/foo&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    loop<span style=color:#f92672>.</span>run_until_complete(asyncio<span style=color:#f92672>.</span>gather(t1, t2))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e>#sync_call()</span>
</span></span><span style=display:flex><span>    async_call()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;total </span><span style=color:#e6db74>{:.2f}</span><span style=color:#e6db74> seconds&#39;</span><span style=color:#f92672>.</span>format(time() <span style=color:#f92672>-</span> start))</span></span></code></pre></div></div><p>这里网络请求也需要使用非阻塞的库。创建 task 实际有挺多方法的，这里随便用了一个。</p></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://wdicc.com/favicon.ico alt=Logo><h1 class=about__title>Happy every day!</h1><p class=about__description>Good good study, day day up!</p></div><ul class=aside__social-links><li><a href=https://github.com/wd rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2019-10-17</p></div></section><footer class=page__footer><p><br><span class=active>$ echo $LANG<br><b>zh_CN</b></span><br></p><br><br><p class=copyright>wd © 2025</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>