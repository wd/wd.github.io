<!doctype html><html lang=en><head><title>Typescript for React Native &ndash; wd and cc</title>
<meta name=description content="Good good study, day day up!"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://wdicc.com/css/palettes/base16-dark.css><link rel=stylesheet href=https://wdicc.com/css/risotto.css><link rel=stylesheet href=https://wdicc.com/css/custom.css><link rel=icon href=https://wdicc.com/favicon.ico></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><h1 class=page__logo><a href=https://wdicc.com/ class=page__logo-inner>wd and cc</a></h1><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/posts/ title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=" title>Search</a></li><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/atom.xml title>subscribe</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Typescript for React Native</h1></header><div class=content__body><p>前几天研究 settimeout 的问题的时候，发现 <a href=https://github.com/ocetnik/react-native-background-timer>react-native-background-timer</a> 自己没有 typescript 的 type 文件，但是有人给写了一个 <a href=https://www.npmjs.com/package/@types/react-native-background-timer>@types/react-native-background-timer</a>，这个包算偏门了，都有人写了 type 文件，我感觉是时候试试看 typescript 了。</p><p>搜了一下，发现没有多少在 rn 里面使用 ts 的，有一些关于 react 的，又很奇怪，大都基于 webpack 的。后来找到一篇<a href=https://facebook.github.io/react-native/blog/2018/05/07/using-typescript-with-react-native>官方的 blog 上面的</a>，然后结合自己的研究，找到了思路。我是基于已有项目来做的，那个 blog 是基于新项目，大同小异。</p><p>首先装几个包，这几个包里面， <code class=verbatim>=typescript</code> 提供 typescript 的编译器， <code class=verbatim>react-native-typescript-transformer</code> 提供了从 ts 代码到 js 代码的转换支持， @types 的两个包提供了 react 和 react-native 的 type 文件。</p><div class="src src-bash"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ yarn add -D typescript react-native-typescript-transformer @types/react @types/react-native</span></span></code></pre></div></div><p>在项目的根目录还需要准几个文件。 tsconfig.json，你的目录里面可能已经有一个 <code class=verbatim>jsconfig.json</code> 了，那个是给 eslint 用的。tsconfig.json 同时给 typescript 和 tslint 使用。</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;compilerOptions&#34;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;target&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;es2015&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;module&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;es2015&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;lib&#34;</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;es2015&#34;</span>
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;jsx&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;react&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;noEmit&#34;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;moduleResolution&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;node&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;strict&#34;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;esModuleInterop&#34;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;types&#34;</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#34;react&#34;</span>,
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#34;react-native&#34;</span>
</span></span><span style=display:flex><span>     ],
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;allowSyntheticDefaultImports&#34;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;include&#34;</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>     <span style=color:#e6db74>&#34;./app/**/*&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;exclude&#34;</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;node_modules&#34;</span>
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>这里面的 include/exclude 按照需要调整，注意里面没有 output，我们并不需要 typescript 输出 js 文件。（当然，也可以用输出 js 文件的方式来做这个事情，但是这样就不太好自动化了，细节不说了）</p><p>然后还需要一个 rn-cli.config.js，这个是给 <code class=verbatim>react-native-typescript-transformer</code> 用的。</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getTransformModulePath</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>require</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#e6db74>&#39;react-native-typescript-transformer&#39;</span>);
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getSourceExts</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [<span style=color:#e6db74>&#39;ts&#39;</span>, <span style=color:#e6db74>&#39;tsx&#39;</span>];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>然后就可以写一些 <code class=verbatim>.ts</code> 文件了。 <code class=verbatim>.ts</code> 文件表示只有 js 代码， <code class=verbatim>.tsx</code> 文件表示里面有 react 代码。写完之后可以执行一下 <code class=verbatim>yarn tsc</code> 看看，是否有错误。没有错误的话，也可以在模拟器里面看看自己的 ts 代码是不是确实可以执行。</p><p>你的代码可以在模拟器里面执行，主要是下面这段代码的作用。 <code class=verbatim>ts.transpileModule</code> 会把 ts 代码转换成 js 代码，最终执行的是 js 代码。这里有一个需要注意的地方就是这里不管 ts 的语法错误，也就是你比如定义了一个 type 是 string 类型的变量，你给他做了 number 类型的赋值，这个在 js 里面是可以的，ts 是不允许的，但是这里并不会看到错误。执行 <code class=verbatim>yarn tsc</code> 可以看到错误提示。</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>transform</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>filename</span>, <span style=color:#a6e22e>options</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>src</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;object&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// handle RN &gt;= 0.46
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ;({ <span style=color:#a6e22e>src</span>, <span style=color:#a6e22e>filename</span>, <span style=color:#a6e22e>options</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>src</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>filename</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#39;.ts&#39;</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>filename</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#39;.tsx&#39;</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tsCompileResult</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ts</span>.<span style=color:#a6e22e>transpileModule</span>(<span style=color:#a6e22e>src</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>compilerOptions</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>fileName</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>filename</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reportDiagnostics</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>errors</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tsCompileResult</span>.<span style=color:#a6e22e>diagnostics</span>.<span style=color:#a6e22e>filter</span>(
</span></span><span style=display:flex><span>      ({ <span style=color:#a6e22e>category</span> }) =&gt; <span style=color:#a6e22e>category</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>ts</span>.<span style=color:#a6e22e>DiagnosticCategory</span>.Error
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>.....</span></span></code></pre></div></div><p>所以保证代码符合 typescript 有下面几个方法：</p><ul><li>使用支持 typescript 的编辑器，依靠编辑器的提示。vs code 配合 tslint 可以做到这个。</li><li>提交代码之前执行 <code class=verbatim>yarn tsc</code> 验证代码没问题之后再提交。</li><li>在 git 的 commit-hook 里面增加一个 hook 自动执行 <code class=verbatim>yarn tsc</code> 检查。git 也可以在 server 端做这个检查。</li></ul><p>为了保证这个，我在 git 的 commit-hook 里面增加了一个 hook。放到 <code class=verbatim>.git/hooks/pre-commit</code> 就可以。</p><div class="src src-bash"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>has_ts_file<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>git diff --cached --name-status | awk <span style=color:#e6db74>&#39;$1 != &#34;D&#34; { print $2 }&#39;</span> | grep <span style=color:#e6db74>&#39;.ts$&#39;</span> |wc -l<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exec 1&gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$has_ts_file<span style=color:#e6db74>&#34;</span> -ge <span style=color:#e6db74>&#39;1&#39;</span> <span style=color:#f92672>]</span>;<span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    yarn tsc
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span></span></span></code></pre></div></div><p>但是 git 的 hooks 文件并不是 repo 的一部份，如何保证大家都是一样的配置呢？有一个 npm 包可以做这个事情。。 <code class=verbatim>yarn add -D pre-commit</code> ，然后在 package.json 里面增加一些配置。</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    <span style=color:#e6db74>&#34;scripts&#34;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;start&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;node node_modules/react-native/local-cli/cli.js start&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;test&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;jest&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;lint&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;node_modules/.bin/eslint app&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;version&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;./version-ios.sh&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;precommit&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;./pre-commit&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;pre-commit&#34;</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;precommit&#34;</span>
</span></span><span style=display:flex><span>    ],</span></span></code></pre></div></div><p>scripts 里面的 precommit 和 pre-commit 是新加的。那个 pre-commit 就是上面的那个脚本，放到项目目录一起管理就可以。</p></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://wdicc.com/favicon.ico alt=Logo><h1 class=about__title>Happy every day!</h1><p class=about__description>Good good study, day day up!</p></div><ul class=aside__social-links><li><a href=https://github.com/wd rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2018-09-16</p></div></section><footer class=page__footer><p><br><span class=active>$ echo $LANG<br><b>zh_CN</b></span><br></p><br><br><p class=copyright>wd © 2025</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>