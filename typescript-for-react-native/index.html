<!doctype html><html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>Typescript for React Native - wd and cc</title><link rel=icon type=image/png href=/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="Typescript for React Native">
<meta property="og:description" content="前几天研究 settimeout 的问题的时候，发现 react-native-background-timer 自己没有 typescript 的 type 文件，但是有人给写了一个 @types/react-na">
<meta property="og:type" content="article">
<meta property="og:url" content="https://wdicc.com/typescript-for-react-native/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2018-09-16T16:36:17+08:00">
<meta property="article:modified_time" content="2018-09-16T16:36:17+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Typescript for React Native">
<meta name=twitter:description content="前几天研究 settimeout 的问题的时候，发现 react-native-background-timer 自己没有 typescript 的 type 文件，但是有人给写了一个 @types/react-na">
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel=stylesheet>
<link rel=stylesheet type=text/css media=screen href=https://wdicc.com/css/normalize.css>
<link rel=stylesheet type=text/css media=screen href=https://wdicc.com/css/main.css>
<link rel=stylesheet type=text/css href=https://wdicc.com//light-syntax.css media="(prefers-color-scheme: light)"><link rel=stylesheet type=text/css href=https://wdicc.com/css/dark.css media="(prefers-color-scheme: dark)">
<link rel=stylesheet type=text/css href=https://wdicc.com//dark-syntax.css media="(prefers-color-scheme: dark)">
<script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script>
<script src=https://wdicc.com/js/main.js></script>
</head>
<body>
<div class="container wrapper post">
<div class=header>
<h1 class=site-title><a href=https://wdicc.com/>wd and cc</a></h1>
<div class=site-description><h2>&mdash; Happy every day</h2><nav class="nav social">
<ul class=flat><a href=https://github.com/wd title=Github><i data-feather=github></i></a><a href=https://twitter.com/wdicc1413 title=Twitter><i data-feather=twitter></i></a></ul>
</nav>
</div>
<nav class=nav>
<ul class=flat>
<li>
<a href=/>Home</a>
</li>
<li>
<a href=/post>All posts</a>
</li>
<li>
<a href=/tags>Tags</a>
</li>
<li>
<a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&q=">Search</a>
</li>
<li>
<a href=/atom.xml>Subscribe</a>
</li>
</ul>
</nav>
</div>
<div class=post-header>
<h1 class=title>Typescript for React Native</h1>
<div class=meta>Posted at &mdash; Sep 16, 2018</div>
</div>
<div class=post-header>
</div>
<div class=markdown>
<p>前几天研究 settimeout 的问题的时候，发现 <a href=https://github.com/ocetnik/react-native-background-timer>react-native-background-timer</a> 自己没有 typescript 的 type 文件，但是有人给写了一个 <a href=https://www.npmjs.com/package/@types/react-native-background-timer>@types/react-native-background-timer</a>，这个包算偏门了，都有人写了 type 文件，我感觉是时候试试看 typescript 了。</p>
<p>
搜了一下，发现没有多少在 rn 里面使用 ts 的，有一些关于 react 的，又很奇怪，大都基于 webpack 的。后来找到一篇<a href=https://facebook.github.io/react-native/blog/2018/05/07/using-typescript-with-react-native>官方的 blog 上面的</a>，然后结合自己的研究，找到了思路。我是基于已有项目来做的，那个 blog 是基于新项目，大同小异。</p>
<p>
首先装几个包，这几个包里面， <code class=verbatim>=typescript</code> 提供 typescript 的编译器， <code class=verbatim>react-native-typescript-transformer</code> 提供了从 ts 代码到 js 代码的转换支持， @types 的两个包提供了 react 和 react-native 的 type 文件。</p>
<div class="src src-bash">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ yarn add -D typescript react-native-typescript-transformer @types/react @types/react-native</code></pre></div>
</div>
<p>
在项目的根目录还需要准几个文件。 tsconfig.json，你的目录里面可能已经有一个 <code class=verbatim>jsconfig.json</code> 了，那个是给 eslint 用的。tsconfig.json 同时给 typescript 和 tslint 使用。</p>
<div class="src src-javascript">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=p>{</span>
  <span class=s2>&#34;compilerOptions&#34;</span><span class=o>:</span> <span class=p>{</span>
    <span class=s2>&#34;target&#34;</span><span class=o>:</span> <span class=s2>&#34;es2015&#34;</span><span class=p>,</span>
    <span class=s2>&#34;module&#34;</span><span class=o>:</span> <span class=s2>&#34;es2015&#34;</span><span class=p>,</span>
    <span class=s2>&#34;lib&#34;</span><span class=o>:</span> <span class=p>[</span>
      <span class=s2>&#34;es2015&#34;</span>
    <span class=p>],</span>
    <span class=s2>&#34;jsx&#34;</span><span class=o>:</span> <span class=s2>&#34;react&#34;</span><span class=p>,</span>
    <span class=s2>&#34;noEmit&#34;</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
    <span class=s2>&#34;moduleResolution&#34;</span><span class=o>:</span> <span class=s2>&#34;node&#34;</span><span class=p>,</span>
    <span class=s2>&#34;strict&#34;</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
    <span class=s2>&#34;esModuleInterop&#34;</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
    <span class=s2>&#34;types&#34;</span><span class=o>:</span> <span class=p>[</span>
       <span class=s2>&#34;react&#34;</span><span class=p>,</span>
       <span class=s2>&#34;react-native&#34;</span>
     <span class=p>],</span>
    <span class=s2>&#34;allowSyntheticDefaultImports&#34;</span><span class=o>:</span> <span class=kc>true</span>
  <span class=p>},</span>
  <span class=s2>&#34;include&#34;</span><span class=o>:</span> <span class=p>[</span>
     <span class=s2>&#34;./app/**/*&#34;</span>
  <span class=p>],</span>
  <span class=s2>&#34;exclude&#34;</span><span class=o>:</span> <span class=p>[</span>
    <span class=s2>&#34;node_modules&#34;</span>
  <span class=p>]</span>
<span class=p>}</span></code></pre></div>
</div>
<p>
这里面的 include/exclude 按照需要调整，注意里面没有 output，我们并不需要 typescript 输出 js 文件。（当然，也可以用输出 js 文件的方式来做这个事情，但是这样就不太好自动化了，细节不说了）</p>
<p>
然后还需要一个 rn-cli.config.js，这个是给 <code class=verbatim>react-native-typescript-transformer</code> 用的。</p>
<div class="src src-javascript">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>getTransformModulePath</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>require</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=s1>&#39;react-native-typescript-transformer&#39;</span><span class=p>);</span>
  <span class=p>},</span>
  <span class=nx>getSourceExts</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=p>[</span><span class=s1>&#39;ts&#39;</span><span class=p>,</span> <span class=s1>&#39;tsx&#39;</span><span class=p>];</span>
  <span class=p>}</span>
<span class=p>}</span></code></pre></div>
</div>
<p>
然后就可以写一些 <code class=verbatim>.ts</code> 文件了。 <code class=verbatim>.ts</code> 文件表示只有 js 代码， <code class=verbatim>.tsx</code> 文件表示里面有 react 代码。写完之后可以执行一下 <code class=verbatim>yarn tsc</code> 看看，是否有错误。没有错误的话，也可以在模拟器里面看看自己的 ts 代码是不是确实可以执行。</p>
<p>
你的代码可以在模拟器里面执行，主要是下面这段代码的作用。 <code class=verbatim>ts.transpileModule</code> 会把 ts 代码转换成 js 代码，最终执行的是 js 代码。这里有一个需要注意的地方就是这里不管 ts 的语法错误，也就是你比如定义了一个 type 是 string 类型的变量，你给他做了 number 类型的赋值，这个在 js 里面是可以的，ts 是不允许的，但是这里并不会看到错误。执行 <code class=verbatim>yarn tsc</code> 可以看到错误提示。</p>
<div class="src src-javascript">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>transform</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>src</span><span class=p>,</span> <span class=nx>filename</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>src</span> <span class=o>===</span> <span class=s1>&#39;object&#39;</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// handle RN &gt;= 0.46
</span><span class=c1></span>    <span class=p>;({</span> <span class=nx>src</span><span class=p>,</span> <span class=nx>filename</span><span class=p>,</span> <span class=nx>options</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>src</span><span class=p>)</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=nx>filename</span><span class=p>.</span><span class=nx>endsWith</span><span class=p>(</span><span class=s1>&#39;.ts&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=nx>filename</span><span class=p>.</span><span class=nx>endsWith</span><span class=p>(</span><span class=s1>&#39;.tsx&#39;</span><span class=p>))</span> <span class=p>{</span>
    <span class=kr>const</span> <span class=nx>tsCompileResult</span> <span class=o>=</span> <span class=nx>ts</span><span class=p>.</span><span class=nx>transpileModule</span><span class=p>(</span><span class=nx>src</span><span class=p>,</span> <span class=p>{</span>
      <span class=nx>compilerOptions</span><span class=p>,</span>
      <span class=nx>fileName</span><span class=o>:</span> <span class=nx>filename</span><span class=p>,</span>
      <span class=nx>reportDiagnostics</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
    <span class=p>})</span>

    <span class=kr>const</span> <span class=nx>errors</span> <span class=o>=</span> <span class=nx>tsCompileResult</span><span class=p>.</span><span class=nx>diagnostics</span><span class=p>.</span><span class=nx>filter</span><span class=p>(</span>
      <span class=p>({</span> <span class=nx>category</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=nx>category</span> <span class=o>===</span> <span class=nx>ts</span><span class=p>.</span><span class=nx>DiagnosticCategory</span><span class=p>.</span><span class=nb>Error</span>
    <span class=p>)</span>
<span class=p>.....</span></code></pre></div>
</div>
<p>
所以保证代码符合 typescript 有下面几个方法：</p>
<ul>
<li>
<p>使用支持 typescript 的编辑器，依靠编辑器的提示。vs code 配合 tslint 可以做到这个。</p>
</li>
<li>
<p>提交代码之前执行 <code class=verbatim>yarn tsc</code> 验证代码没问题之后再提交。</p>
</li>
<li>
<p>在 git 的 commit-hook 里面增加一个 hook 自动执行 <code class=verbatim>yarn tsc</code> 检查。git 也可以在 server 端做这个检查。</p>
</li>
</ul>
<p>为了保证这个，我在 git 的 commit-hook 里面增加了一个 hook。放到 <code class=verbatim>.git/hooks/pre-commit</code> 就可以。</p>
<div class="src src-bash">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/sh
</span><span class=cp></span>
<span class=nv>has_ts_file</span><span class=o>=</span><span class=sb>`</span>git diff --cached --name-status <span class=p>|</span> awk <span class=s1>&#39;$1 != &#34;D&#34; { print $2 }&#39;</span> <span class=p>|</span> grep <span class=s1>&#39;.ts$&#39;</span> <span class=p>|</span>wc -l<span class=sb>`</span>

<span class=nb>exec</span> 1&gt;<span class=p>&amp;</span><span class=m>2</span>

<span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$has_ts_file</span><span class=s2>&#34;</span> -ge <span class=s1>&#39;1&#39;</span> <span class=o>]</span><span class=p>;</span><span class=k>then</span>
    yarn tsc
<span class=k>fi</span></code></pre></div>
</div>
<p>
但是 git 的 hooks 文件并不是 repo 的一部份，如何保证大家都是一样的配置呢？有一个 npm 包可以做这个事情。。 <code class=verbatim>yarn add -D pre-commit</code> ，然后在 package.json 里面增加一些配置。</p>
<div class="src src-javascript">
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript>    <span class=s2>&#34;scripts&#34;</span><span class=o>:</span> <span class=p>{</span>
        <span class=s2>&#34;start&#34;</span><span class=o>:</span> <span class=s2>&#34;node node_modules/react-native/local-cli/cli.js start&#34;</span><span class=p>,</span>
        <span class=s2>&#34;test&#34;</span><span class=o>:</span> <span class=s2>&#34;jest&#34;</span><span class=p>,</span>
        <span class=s2>&#34;lint&#34;</span><span class=o>:</span> <span class=s2>&#34;node_modules/.bin/eslint app&#34;</span><span class=p>,</span>
        <span class=s2>&#34;version&#34;</span><span class=o>:</span> <span class=s2>&#34;./version-ios.sh&#34;</span><span class=p>,</span>
        <span class=s2>&#34;precommit&#34;</span><span class=o>:</span> <span class=s2>&#34;./pre-commit&#34;</span>
    <span class=p>},</span>
    <span class=s2>&#34;pre-commit&#34;</span><span class=o>:</span> <span class=p>[</span>
        <span class=s2>&#34;precommit&#34;</span>
    <span class=p>],</span></code></pre></div>
</div>
<p>
scripts 里面的 precommit 和 pre-commit 是新加的。那个 pre-commit 就是上面的那个脚本，放到项目目录一起管理就可以。</p>
</div>
<div class=post-tags>
<nav class="nav tags">
<ul class=flat>
<li><a href=/tags/typescript>typescript</a></li>
<li><a href=/tags/react-native>react-native</a></li>
</ul>
</nav>
</div>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='wdicc',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by
Disqus.</a></noscript>
<a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<div class="footer wrapper">
<nav class=nav>
<div> Copyright © 2020 wd. All Rights Reserved | <a href=https://github.com/vividvilla/ezhil>Ezhil theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div>
</nav>
</div>
<script>feather.replace()</script>
</body>
</html>