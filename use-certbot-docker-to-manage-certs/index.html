<!doctype html><html lang=zh-cn>
<head>
<link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title> Use Certbot Docker to Manage Certs | wd and cc</title>
<link rel=canonical href=https://wdicc.com/use-certbot-docker-to-manage-certs/>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="all,follow">
<meta name=googlebot content="index,follow,snippet,archive">
<meta property="og:title" content="Use Certbot Docker to Manage Certs">
<meta property="og:description" content="I think everyone knows Let's Encrypt these days. I use letsencrypt for some of my personal services.
 I was using the system shipped certs at the beginning, and using systemd jobs to auto renew the certs. I was using the HTTP-01 challenge mode at first, and using the certbot standalone mode to achieve that.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://wdicc.com/use-certbot-docker-to-manage-certs/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-07-19T16:58:03+08:00">
<meta property="article:modified_time" content="2020-07-19T16:58:03+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Use Certbot Docker to Manage Certs">
<meta name=twitter:description content="I think everyone knows Let's Encrypt these days. I use letsencrypt for some of my personal services.
 I was using the system shipped certs at the beginning, and using systemd jobs to auto renew the certs. I was using the HTTP-01 challenge mode at first, and using the certbot standalone mode to achieve that.">
<link rel=stylesheet href=https://wdicc.com/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q==">
<link rel=stylesheet href=https://wdicc.com/wdicc.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]-->
<link rel=icon type=image/png href=https://wdicc.com/favicon.ico>
</head>
<body class="max-width mx-auto px3 ltr">
<div class="content index py4">
<div id=header-post>
<a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast')" style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu>
<span id=nav>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>Posts</a></li>
<li><a href=/tags>Tags</a></li>
<li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&q=">Search</a></li>
<li><a href=/atom.xml>Subscribe</a></li>
</ul>
</span>
<br>
<span id=actions>
<ul>
<li>
<a class=icon href=https://wdicc.com/to-be-a-terraform-expert/ aria-label=Previous>
<i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle()" onmouseout="$('#i-prev').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=https://wdicc.com/use-datadog-to-monitor-your-cluster-build-by-rke/ aria-label=Next>
<i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle()" onmouseout="$('#i-next').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page">
<i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle()" onmouseout="$('#i-top').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=# aria-label=Share>
<i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle()" onmouseout="$('#i-share').toggle()" onclick="return $('#share').toggle(),!1"></i>
</a>
</li>
</ul>
<span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span>
</span>
<br>
<div id=share style=display:none>
<ul>
<li>
<a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f" aria-label=Facebook>
<i class="fab fa-facebook" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&text=Use%20Certbot%20Docker%20to%20Manage%20Certs" aria-label=Twitter>
<i class="fab fa-twitter" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&title=Use%20Certbot%20Docker%20to%20Manage%20Certs" aria-label=Linkedin>
<i class="fab fa-linkedin" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&is_video=false&description=Use%20Certbot%20Docker%20to%20Manage%20Certs" aria-label=Pinterest>
<i class="fab fa-pinterest" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="mailto:?subject=Use%20Certbot%20Docker%20to%20Manage%20Certs&body=Check out this article: https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f" aria-label=Email>
<i class="fas fa-envelope" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&title=Use%20Certbot%20Docker%20to%20Manage%20Certs" aria-label=Pocket>
<i class="fab fa-get-pocket" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&title=Use%20Certbot%20Docker%20to%20Manage%20Certs" aria-label=reddit>
<i class="fab fa-reddit" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&name=Use%20Certbot%20Docker%20to%20Manage%20Certs&description=I%20think%20everyone%20knows%20Let%26%2339%3bs%20Encrypt%20these%20days.%20I%20use%20letsencrypt%20for%20some%20of%20my%20personal%20services.%0a%20I%20was%20using%20the%20system%20shipped%20certs%20at%20the%20beginning%2c%20and%20using%20systemd%20jobs%20to%20auto%20renew%20the%20certs.%20I%20was%20using%20the%20HTTP-01%20challenge%20mode%20at%20first%2c%20and%20using%20the%20certbot%20standalone%20mode%20to%20achieve%20that." aria-label=Tumblr>
<i class="fab fa-tumblr" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&t=Use%20Certbot%20Docker%20to%20Manage%20Certs" aria-label="Hacker News">
<i class="fab fa-hacker-news" aria-hidden=true></i>
</a>
</li>
</ul>
</div>
</span>
</div>
<article class=post itemscope itemtype=http://schema.org/BlogPosting>
<header>
<h1 class=posttitle itemprop="name headline">
Use Certbot Docker to Manage Certs
</h1>
<div class=meta>
<span class=author itemprop=author itemscope itemtype=http://schema.org/Person>
<span itemprop=name>
wd
</span>
</span>
<div class=postdate>
<time datetime="2020-07-19 16:58:03 +0800 +0800" itemprop=datePublished>2020-07-19</time>
</div>
<div class=article-tag>
<i class="fas fa-tag"></i>
<a class=tag-link href=/tags/certbot rel=tag>certbot</a>
,
<a class=tag-link href=/tags/letsencrypt rel=tag>letsencrypt</a>
,
<a class=tag-link href=/tags/docker rel=tag>docker</a>
</div>
</div>
</header>
<div id=toc>
<nav id=TableOfContents>
<ul>
<li><a href=#headline-1>Use certbot docker to apply certs</a>
</li>
<li><a href=#headline-2>Renew certs</a>
</li>
</ul>
</nav>
</div>
<div class=content itemprop=articleBody>
<p>I think everyone knows <a href=https://letsencrypt.org/>Let's Encrypt</a> these days. I use letsencrypt for some of my personal services.</p>
<p>
I was using the system shipped certs at the beginning, and using systemd jobs to auto renew the certs. I was using the HTTP-01 challenge mode at first, and using the certbot standalone mode to achieve that. Certbot will need to run a webserver at 443/80 to finish the challenge, so we have to add pre/post hook to certbot to stop/start our nginx servers. If certbot can't stop your webserver, it will fail the challenge. After failed many times, I decide to change to Caddy.</p>
<p>
Caddy was a modern webserver, it can automatically apply and extend your letsencrypt certs which is very convenient. But after some time, I found that I only can use these certs inside Caddy, if I want to add certs to an other service, I have to use Caddy as the reverse proxy, that wasn't what I want. So I have to found a new way.</p>
<p>
After some research, I decide to use a certbot docker to apply the certs.</p>
<div id=outline-container-headline-1 class=outline-3>
<h3 id=headline-1>
Use certbot docker to apply certs
</h3>
<div id=outline-text-headline-1 class=outline-text-3>
<p>
As I mentioned early, the HTTP-01 challenge method has some problems, I try to use DNS-01 this time.</p>
<p>
My domain was managed by Cloudflare, which already supported by certbot. First create a API token with DNS zone edit permission at Cloudflare, create a file named <code class=verbatim>cloudflare.ini</code> .</p>
<div class="src src-ini">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#a6e22e>dns_cloudflare_api_token</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>YOUR_TOKEN</span></code></pre></div>
</div>
<p>
Run command bellow to apply certs, the certs will be placed at <code class=verbatim>./certs</code> .</p>
<div class="src src-bash">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -it --rm --name certbot <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>-v <span style=color:#e6db74>&#34;./certs:/etc/letsencrypt&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>-v <span style=color:#e6db74>&#34;./cloudflare.ini:/cloudflare.ini&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>certbot/dns-cloudflare certonly --dns-cloudflare --dns-cloudflare-credentials /cloudflare.ini <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>-m YOUR_EMAIL --agree-tos --no-eff-email <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--dns-cloudflare-propagation-seconds <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>-d my.wdicc.com</code></pre></div>
</div>
<p>
Then you can mount <code class=verbatim>./certs</code> to other containers to use the certs.</p>
</div>
</div>
<div id=outline-container-headline-2 class=outline-3>
<h3 id=headline-2>
Renew certs
</h3>
<div id=outline-text-headline-2 class=outline-text-3>
<p>
Certs renew is easy, and after renew the certs, we also need to reload our webserver or applications to use the new certs, it's very important.</p>
<p>
Certbot didn't provide a way to run a daemon in docker container to renew the certs. After some research, I decide to use <a href=https://github.com/willfarrell/docker-crontab>docker-crontab</a> finally.</p>
<p>
Create <code class=verbatim>crontab/config.json</code> as bellow, alter <code class=verbatim>/path/to</code> to absolute path on the host.</p>
<div class="src src-javascript">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>[{
    <span style=color:#e6db74>&#34;comment&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;renew certs&#34;</span>,
    <span style=color:#e6db74>&#34;onstart&#34;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
    <span style=color:#e6db74>&#34;schedule&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;0 0 * * 1&#34;</span>,
    <span style=color:#e6db74>&#34;command&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;renew --dns-cloudflare --dns-cloudflare-credentials /cloudflare.ini&#34;</span>,
    <span style=color:#e6db74>&#34;dockerargs&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;--rm -v /path/to/certs:/etc/letsencrypt -v /path/to/cloudflare.ini:/cloudflare.ini&#34;</span>,
    <span style=color:#e6db74>&#34;image&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;certbot/dns-cloudflare&#34;</span>,
    <span style=color:#e6db74>&#34;trigger&#34;</span><span style=color:#f92672>:</span>[
        {
            <span style=color:#e6db74>&#34;command&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;echo &#39;restart trojan&#39; &amp;&amp; docker restart nginx&#34;</span>,
            <span style=color:#e6db74>&#34;container&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;cron&#34;</span>
        },
        {
            <span style=color:#e6db74>&#34;command&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;echo &#39;restart caddy&#39; &amp;&amp; docker restart caddy&#34;</span>,
            <span style=color:#e6db74>&#34;container&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;cron&#34;</span>
        }
    ]
 }]</code></pre></div>
</div>
<p>
Create the crontab container.</p>
<div class="src src-bash">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -d --name crontab <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -v /var/run/docker.sock:/var/run/docker.sock:ro <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -v ./crontab:/opt/crontab:rw <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    willfarrell/crontab</code></pre></div>
</div>
<p>
As you can see, I use <code class=verbatim>docker restart container</code> to reload the certs in the <code class=verbatim>config.json</code> , you can change it to a better version like bellow to avoid downtime for you website.</p>
<div class="src src-javascript">
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#e6db74>&#34;trigger&#34;</span><span style=color:#f92672>:</span>[{
 		<span style=color:#e6db74>&#34;command&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;sh -c &#39;/usr/sbin/nginx -t &amp;&amp; /usr/sbin/nginx -s reload&#39;&#34;</span>,
 		<span style=color:#e6db74>&#34;container&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;nginx&#34;</span>
 	}]</code></pre></div>
</div>
<p>
You can use <code class=verbatim>docker logs crontab</code> to check the logs, with <code class=verbatim>"onstart": true,</code> in <code class=verbatim>config.json</code> , the task will run when the container starts.</p>
</div>
</div>
</div>
</article>
<div id=footer-post-container>
<div id=footer-post>
<div id=nav-footer style=display:none>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>Posts</a></li>
<li><a href=/tags>Tags</a></li>
<li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&q=">Search</a></li>
<li><a href=/atom.xml>Subscribe</a></li>
</ul>
</div>
<div id=share-footer style=display:none>
<ul>
<li>
<a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f" aria-label=Facebook>
<i class="fab fa-facebook fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&text=Use%20Certbot%20Docker%20to%20Manage%20Certs" aria-label=Twitter>
<i class="fab fa-twitter fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&title=Use%20Certbot%20Docker%20to%20Manage%20Certs" aria-label=Linkedin>
<i class="fab fa-linkedin fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&is_video=false&description=Use%20Certbot%20Docker%20to%20Manage%20Certs" aria-label=Pinterest>
<i class="fab fa-pinterest fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="mailto:?subject=Use%20Certbot%20Docker%20to%20Manage%20Certs&body=Check out this article: https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f" aria-label=Email>
<i class="fas fa-envelope fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&title=Use%20Certbot%20Docker%20to%20Manage%20Certs" aria-label=Pocket>
<i class="fab fa-get-pocket fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&title=Use%20Certbot%20Docker%20to%20Manage%20Certs" aria-label=reddit>
<i class="fab fa-reddit fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&name=Use%20Certbot%20Docker%20to%20Manage%20Certs&description=I%20think%20everyone%20knows%20Let%26%2339%3bs%20Encrypt%20these%20days.%20I%20use%20letsencrypt%20for%20some%20of%20my%20personal%20services.%0a%20I%20was%20using%20the%20system%20shipped%20certs%20at%20the%20beginning%2c%20and%20using%20systemd%20jobs%20to%20auto%20renew%20the%20certs.%20I%20was%20using%20the%20HTTP-01%20challenge%20mode%20at%20first%2c%20and%20using%20the%20certbot%20standalone%20mode%20to%20achieve%20that." aria-label=Tumblr>
<i class="fab fa-tumblr fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwdicc.com%2fuse-certbot-docker-to-manage-certs%2f&t=Use%20Certbot%20Docker%20to%20Manage%20Certs" aria-label="Hacker News">
<i class="fab fa-hacker-news fa-lg" aria-hidden=true></i>
</a>
</li>
</ul>
</div>
<div id=actions-footer>
<a id=menu-toggle class=icon href=# onclick="return $('#nav-footer').toggle(),!1" aria-label=Menu>
<i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick="return $('#share-footer').toggle(),!1" aria-label=Share>
<i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page">
<i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a>
</div>
</div>
</div>
<footer id=footer>
<div class=footer-left>
Copyright &copy; 2022 wd and cc
</div>
<div class=footer-right>
<nav>
<ul>
<li><a href=/>Home</a></li>
<li><a href=/posts>Posts</a></li>
<li><a href=/tags>Tags</a></li>
<li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&q=">Search</a></li>
<li><a href=/atom.xml>Subscribe</a></li>
</ul>
</nav>
</div>
</footer>
</div>
</body>
<link rel=stylesheet href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>
</html>