<!doctype html><html lang=en><head><title>Emacs as python IDE &ndash; wd and cc</title>
<meta name=description content="Good good study, day day up!"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://wdicc.com/css/palettes/base16-dark.css><link rel=stylesheet href=https://wdicc.com/css/risotto.css><link rel=stylesheet href=https://wdicc.com/css/custom.css><link rel=icon href=https://wdicc.com/favicon.ico></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><h1 class=page__logo><a href=https://wdicc.com/ class=page__logo-inner>wd and cc</a></h1><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/posts/ title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=" title>Search</a></li><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/atom.xml title>subscribe</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Emacs as python IDE</h1></header><div class=content__body><p>最近 python 写的比较多，比较了几个编辑器，最后还是留下了 emacs。</p><p>主要比较了 emacs 和 pycharm。pycharm 绝对是一个很强的 IDE，几乎可以补全任何东西，写代码各种提示。比如 Django 里面定义一个 model User 之后，就可以 <code class=verbatim>User.</code> 之后提示 <code class=verbatim>objects</code> ，这个是依据 metaclass 来补全的。另外还有比如写 <code class=verbatim>User.objects.get(|)</code> 的时候，光标在竖线那个位置，会提示 <code class=verbatim>User</code> 的字段，这个相当好用。这两个只是皮毛，实在是太好用了。</p><p>但是为什么还要用 emacs 呢？emacs 的编辑器功能太好用了。比如 <code class=verbatim>&lt;</code> 到页首， <code class=verbatim>></code> 到页尾， <code class=verbatim>C-x b</code> 切换 buffer，还有切换 frame，等等快捷键非常舒服，完全不用鼠标。不过也可能是我习惯了 emacs 的快捷键了。在 pycharm 里面时不时就不行，比如选择一段文字，纯键盘需要按 <code class=verbatim>-></code> 配合才可以，那还不如用鼠标算了。</p><p>其实如果一上手就用 pycharm，那绝对会觉得很爽。</p><p>emacs 写 python 在原生的 <code class=verbatim>python-mode</code> 基础上有两个好用的选择，一个是 <a href=https://github.com/proofit404/anaconda-mode>anaconda-mode</a>，一个是 <a href=https://github.com/jorgenschaefer/elpy>elpy</a>。 <code class=verbatim>anaconda-mode</code> 相对来说比较简陋一点，但是补全什么的没问题，缺少重构功能。两个的工作模式都是会启动一个补全用的进程，然后通过 lisp 和这个进程交互获取补全信息。</p><div id=outline-container-headline-1 class=outline-3><h3 id=headline-1>anaconda-mode 遇到的问题和解决</h3><div id=outline-text-headline-1 class=outline-text-3><p><code class=verbatim>anaconda-mode</code> 我遇到一个问题，为了下载 emacs 的 package 方便，我设置了代理，这个代理导致 <code class=verbatim>anaconda-mode</code> 和补全进程交互的时候，连接不能断开，就会不停的新建连接，一会就打开文件数满了，可以参观这个 <a href=https://github.com/proofit404/anaconda-mode/issues/255>issue</a>。主要是设置了 <code class=verbatim>no_proxy</code> 解决。</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span> (setq url-proxy-services
</span></span><span style=display:flex><span>       &#39;((&#34;no_proxy&#34; . &#34;^\\(127.0.0.1\\|localhost\\|10.*\\)&#34;)
</span></span><span style=display:flex><span>         (&#34;http&#34; . &#34;127.0.0.1:6152&#34;)
</span></span><span style=display:flex><span>         (&#34;https&#34; . &#34;127.0.0.1:6152&#34;)))</span></span></code></pre></div></div></div></div><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>auto-virtualenv</h3><div id=outline-text-headline-2 class=outline-text-3><p>我的 python 项目使用了 <code class=verbatim>virtualenv</code> ，会在项目目录下面建一个 <code class=verbatim>.venv</code> 的目录，把虚拟环境放进去。 <code class=verbatim>anaconda-mode</code> 提供了 <code class=verbatim>pythonic-activate</code> 命令， <code class=verbatim>elpy</code> 提供了 <code class=verbatim>pyvenv-activate</code> 来切换环境。但是每次打开项目都需要搞一下就挺恶心了。</p><p>然后找到了 <a href=https://github.com/marcwebbie/auto-virtualenv>auto-virtualenv</a> 这个工具。安装之后，他会自动查找你的项目里面的可能的虚拟环境。项目根目录识别是通过 <code class=verbatim>.git</code> ， <code class=verbatim>.hg</code> 等一些逻辑来判定的，具体可以看代码。然后虚拟环境识别是通过根目录下面的 <code class=verbatim>.python-version</code> <code class=verbatim>.venv</code> 等来识别的。</p><p>我的项目是建了一个 <code class=verbatim>.venv</code> 目录，所以每次打开一个 python 文件，会自动配置好 virtualenv 的环境，这样 <code class=verbatim>elpy</code> 在 django 自带的 model 上面也可以查找 defination。</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>(use-package auto-virtualenv
</span></span><span style=display:flex><span>  :ensure t
</span></span><span style=display:flex><span>  :config
</span></span><span style=display:flex><span>  (add-hook &#39;python-mode-hook &#39;auto-virtualenv-set-virtualenv)
</span></span><span style=display:flex><span>)</span></span></code></pre></div></div></div></div><div id=outline-container-headline-3 class=outline-3><h3 id=headline-3>elpy</h3><div id=outline-text-headline-3 class=outline-text-3><p><code class=verbatim>elpy</code> 其实没有什么好配置的，主要注意的是，因为我们用了 virtualenv 环境，所以需要他依赖的包都装在 <code class=verbatim>.venv</code> 环境或者装在 python 自己的目录下面应该都可以。启动 emacs 之后可以使用 <code class=verbatim>M-x elpy-config</code> 看看还有什么没配置好。</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>(use-package elpy
</span></span><span style=display:flex><span>  :ensure t
</span></span><span style=display:flex><span>  :init
</span></span><span style=display:flex><span>  (setq elpy-rpc-backend &#34;jedi&#34;)
</span></span><span style=display:flex><span>  (elpy-enable)
</span></span><span style=display:flex><span>  :config
</span></span><span style=display:flex><span>  (add-hook &#39;python-mode-hook &#39;elpy-mode)
</span></span><span style=display:flex><span>  (with-eval-after-load &#39;elpy
</span></span><span style=display:flex><span>  (add-hook &#39;elpy-mode-hook &#39;elpy-use-ipython))
</span></span><span style=display:flex><span>  :bind ((&#34;M-*&#34; . pop-tag-mark))
</span></span><span style=display:flex><span>  )</span></span></code></pre></div></div><p><code class=verbatim>elpy-rpc-backend</code> 有两个选择，一个 <code class=verbatim>jedi</code> ，一个 <code class=verbatim>rope</code> ，我试了感觉区别不大，另外 rope 感觉要死了。所以我用了 <code class=verbatim>jedi</code> 。</p></div></div><div id=outline-container-headline-4 class=outline-3><h3 id=headline-4>flycheck</h3><div id=outline-text-headline-4 class=outline-text-3><p><a href=https://github.com/flycheck/flycheck>flycheck</a> 可以配合 <code class=verbatim>flake8</code> 实时显示出来你的代码有不符合 flake8 要求的地方，很方便。这个工具我也遇到一个坑 <a href=https://github.com/flycheck/flycheck/issues/1228#issuecomment-311706873>issue</a>，有兴趣可以看看。主要原因是 flycheck 是使用 <code class=verbatim>flake8 &lt; xxx.py</code> 这种方式检查的，而这种方式下 flake8 不会考虑文件头部的 <code class=verbatim>coding</code> 设置，来识别文件编码，而是根据 <code class=verbatim>LC_CTYPE</code> 环境变量来的，所以只要正确设置这个变量就可以了。 issue 里面提到的设置 emacs 的编码屁用么有的。</p><p>flycheck 可以配合 flake8 和 pylint 来做 python 代码的检查，如果装了前者，就不会考虑后者了。我试过 pylint，这货默认要求有点高，比如 class 和 method 没有 doc string 也会提示，代码一堆问题，我就赶紧换掉了。。。</p></div></div><div id=outline-container-headline-5 class=outline-3><h3 id=headline-5>python outline</h3><div id=outline-text-headline-5 class=outline-text-3><p>好处是打开 python 文件的时候，会把代码都折叠起来，按照需要你自己打开就好。elpa 里面没有，网上搜到的。</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>(use-package python-magic
</span></span><span style=display:flex><span>  :ensure outline-magic
</span></span><span style=display:flex><span>  :config
</span></span><span style=display:flex><span>  (add-hook &#39;python-mode-hook &#39;my-python-outline-hook)
</span></span><span style=display:flex><span>  (add-hook &#39;python-mode-hook
</span></span><span style=display:flex><span>            (lambda ()
</span></span><span style=display:flex><span>              (setq outline-regexp &#34;def\\|class &#34;)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  )</span></span></code></pre></div></div></div></div><div id=outline-container-headline-6 class=outline-3><h3 id=headline-6>indent-tools</h3><div id=outline-text-headline-6 class=outline-text-3><p>这个工具是用来锁进 python 代码和浏览代码用的。搜一下有动图，看看就知道了。</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>(use-package indent-tools
</span></span><span style=display:flex><span>  :ensure t
</span></span><span style=display:flex><span>  :init
</span></span><span style=display:flex><span>  (add-hook &#39;python-mode-hook
</span></span><span style=display:flex><span>            (lambda () (define-key python-mode-map (kbd &#34;C-c i&#34;) &#39;indent-tools-hydra/body))
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>  )</span></span></code></pre></div></div></div></div><div id=outline-container-headline-7 class=outline-3><h3 id=headline-7>yasnippet 和 company</h3><div id=outline-text-headline-7 class=outline-text-3><p>elpy 是使用这两个补全的。有几个有用的配置， <code class=verbatim>C-s</code> 那个，可以在补全候选菜单出来的时候，用关键词过滤结果。</p><p>我没搞定在 company 里面直接显示出来 yasnippet 可用的 snippet，只好设置了一个快捷键 <code class=verbatim>C-c y</code> 来提示。可以提示出来一大堆。比如我经常写错的 <code class=verbatim>-*- coding:utf8 -*-</code> 有一个 snippet 叫做 <code class=verbatim>utf8</code> ，直接输入之后 tab 就可以了。</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>(use-package company
</span></span><span style=display:flex><span>  :ensure t
</span></span><span style=display:flex><span>  :init
</span></span><span style=display:flex><span>  (setq company-minimum-prefix-length 2)
</span></span><span style=display:flex><span>  (setq company-dabbrev-ignore-case t)
</span></span><span style=display:flex><span>  :config
</span></span><span style=display:flex><span>  (add-hook &#39;after-init-hook &#39;global-company-mode)
</span></span><span style=display:flex><span>  (define-key company-active-map (kbd &#34;C-n&#34;) #&#39;company-select-next)
</span></span><span style=display:flex><span>  (define-key company-active-map (kbd &#34;C-p&#34;) #&#39;company-select-previous)
</span></span><span style=display:flex><span>  (define-key company-active-map (kbd &#34;C-s&#34;) #&#39;company-filter-candidates)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  (global-set-key (kbd &#34;C-c y&#34;) &#39;company-yasnippet)
</span></span><span style=display:flex><span>  )</span></span></code></pre></div></div></div></div></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://wdicc.com/favicon.ico alt=Logo><h1 class=about__title>Happy every day!</h1><p class=about__description>Good good study, day day up!</p></div><ul class=aside__social-links><li><a href=https://github.com/wd rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2017-06-30</p></div></section><footer class=page__footer><p><br><span class=active>$ echo $LANG<br><b>zh_CN</b></span><br></p><br><br><p class=copyright>wd © 2025</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>