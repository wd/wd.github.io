<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, viewport-fit=cover, initial-scale=1">
    <title>Emacs as python IDE | wd and cc</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <header>

  
  
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://wdicc.com/">/home/wd and cc</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/tags/">~/tags</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/resume/">~/resume</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">~/search</a>
      </li>
      

      
      
      <li class="pull-right">
        <a href="/atom.xml">~/subscribe</a>
      </li>
      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">Emacs as python IDE</span></h1>

<h2 class="date">2017/06/30</h2>
<p class="terms">
  
  
  
  
  Tags: <a href="/tags/emacs">emacs</a> <a href="/tags/python">python</a> 
  
  
</p>
</div>












<main>

<p>
最近 python 写的比较多，比较了几个编辑器，最后还是留下了 emacs。
</p>
<p>
主要比较了 emacs 和 pycharm。pycharm 绝对是一个很强的 IDE，几乎可以补全任何东西，写代码各种提示。比如 Django 里面定义一个 model User 之后，就可以 <code class="verbatim">User.</code> 之后提示 <code class="verbatim">objects</code> ，这个是依据 metaclass 来补全的。另外还有比如写 <code class="verbatim">User.objects.get(|)</code> 的时候，光标在竖线那个位置，会提示 <code class="verbatim">User</code> 的字段，这个相当好用。这两个只是皮毛，实在是太好用了。
</p>
<p>
但是为什么还要用 emacs 呢？emacs 的编辑器功能太好用了。比如 <code class="verbatim">&lt;</code> 到页首， <code class="verbatim">&gt;</code> 到页尾， <code class="verbatim">C-x b</code> 切换 buffer，还有切换 frame，等等快捷键非常舒服，完全不用鼠标。不过也可能是我习惯了 emacs 的快捷键了。在 pycharm 里面时不时就不行，比如选择一段文字，纯键盘需要按 <code class="verbatim">-&gt;</code> 配合才可以，那还不如用鼠标算了。
</p>
<p>
其实如果一上手就用 pycharm，那绝对会觉得很爽。
</p>
<p>
emacs 写 python 在原生的 <code class="verbatim">python-mode</code> 基础上有两个好用的选择，一个是 <a href="https://github.com/proofit404/anaconda-mode">anaconda-mode</a>，一个是 <a href="https://github.com/jorgenschaefer/elpy">elpy</a>。 <code class="verbatim">anaconda-mode</code> 相对来说比较简陋一点，但是补全什么的没问题，缺少重构功能。两个的工作模式都是会启动一个补全用的进程，然后通过 lisp 和这个进程交互获取补全信息。
</p>
<h2 id="headline-1">
anaconda-mode 遇到的问题和解决
</h2>
<p>
<code class="verbatim">anaconda-mode</code> 我遇到一个问题，为了下载 emacs 的 package 方便，我设置了代理，这个代理导致 <code class="verbatim">anaconda-mode</code> 和补全进程交互的时候，连接不能断开，就会不停的新建连接，一会就打开文件数满了，可以参观这个 <a href="https://github.com/proofit404/anaconda-mode/issues/255">issue</a>。主要是设置了 <code class="verbatim">no_proxy</code> 解决。
</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"> (setq url-proxy-services
       &#39;((&#34;no_proxy&#34; . &#34;^\\(127.0.0.1\\|localhost\\|10.*\\)&#34;)
         (&#34;http&#34; . &#34;127.0.0.1:6152&#34;)
         (&#34;https&#34; . &#34;127.0.0.1:6152&#34;)))</code></pre></td></tr></table>
</div>
</div>
<h2 id="headline-2">
auto-virtualenv
</h2>
<p>
我的 python 项目使用了 <code class="verbatim">virtualenv</code> ，会在项目目录下面建一个 <code class="verbatim">.venv</code> 的目录，把虚拟环境放进去。 <code class="verbatim">anaconda-mode</code> 提供了 <code class="verbatim">pythonic-activate</code> 命令， <code class="verbatim">elpy</code> 提供了 <code class="verbatim">pyvenv-activate</code> 来切换环境。但是每次打开项目都需要搞一下就挺恶心了。
</p>
<p>
然后找到了 <a href="https://github.com/marcwebbie/auto-virtualenv">auto-virtualenv</a> 这个工具。安装之后，他会自动查找你的项目里面的可能的虚拟环境。项目根目录识别是通过 <code class="verbatim">.git</code> ， <code class="verbatim">.hg</code> 等一些逻辑来判定的，具体可以看代码。然后虚拟环境识别是通过根目录下面的 <code class="verbatim">.python-version</code> <code class="verbatim">.venv</code> 等来识别的。
</p>
<p>
我的项目是建了一个 <code class="verbatim">.venv</code> 目录，所以每次打开一个 python 文件，会自动配置好 virtualenv 的环境，这样 <code class="verbatim">elpy</code> 在 django 自带的 model 上面也可以查找 defination。
</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">(use-package auto-virtualenv
  :ensure t
  :config
  (add-hook &#39;python-mode-hook &#39;auto-virtualenv-set-virtualenv)
)</code></pre></td></tr></table>
</div>
</div>
<h2 id="headline-3">
elpy
</h2>
<p>
<code class="verbatim">elpy</code> 其实没有什么好配置的，主要注意的是，因为我们用了 virtualenv 环境，所以需要他依赖的包都装在 <code class="verbatim">.venv</code> 环境或者装在 python 自己的目录下面应该都可以。启动 emacs 之后可以使用 <code class="verbatim">M-x elpy-config</code> 看看还有什么没配置好。
</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">(use-package elpy
  :ensure t
  :init
  (setq elpy-rpc-backend &#34;jedi&#34;)
  (elpy-enable)
  :config
  (add-hook &#39;python-mode-hook &#39;elpy-mode)
  (with-eval-after-load &#39;elpy
  (add-hook &#39;elpy-mode-hook &#39;elpy-use-ipython))
  :bind ((&#34;M-*&#34; . pop-tag-mark))
  )</code></pre></td></tr></table>
</div>
</div>
<p>
<code class="verbatim">elpy-rpc-backend</code> 有两个选择，一个 <code class="verbatim">jedi</code> ，一个 <code class="verbatim">rope</code> ，我试了感觉区别不大，另外 rope 感觉要死了。所以我用了 <code class="verbatim">jedi</code> 。
</p>
<h2 id="headline-4">
flycheck
</h2>
<p>
<a href="https://github.com/flycheck/flycheck">flycheck</a> 可以配合 <code class="verbatim">flake8</code> 实时显示出来你的代码有不符合 flake8 要求的地方，很方便。这个工具我也遇到一个坑 <a href="https://github.com/flycheck/flycheck/issues/1228#issuecomment-311706873">issue</a>，有兴趣可以看看。主要原因是 flycheck 是使用 <code class="verbatim">flake8 &lt; xxx.py</code> 这种方式检查的，而这种方式下 flake8 不会考虑文件头部的 <code class="verbatim">coding</code> 设置，来识别文件编码，而是根据 <code class="verbatim">LC_CTYPE</code> 环境变量来的，所以只要正确设置这个变量就可以了。 issue 里面提到的设置 emacs 的编码屁用么有的。
</p>
<p>
flycheck 可以配合 flake8 和 pylint 来做 python 代码的检查，如果装了前者，就不会考虑后者了。我试过 pylint，这货默认要求有点高，比如 class 和 method 没有 doc string 也会提示，代码一堆问题，我就赶紧换掉了。。。
</p>
<h2 id="headline-5">
python outline
</h2>
<p>
好处是打开 python 文件的时候，会把代码都折叠起来，按照需要你自己打开就好。elpa 里面没有，网上搜到的。
</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">(use-package python-magic
  :ensure outline-magic
  :config
  (add-hook &#39;python-mode-hook &#39;my-python-outline-hook)
  (add-hook &#39;python-mode-hook
            (lambda ()
              (setq outline-regexp &#34;def\\|class &#34;)))

  )</code></pre></td></tr></table>
</div>
</div>
<h2 id="headline-6">
indent-tools
</h2>
<p>
这个工具是用来锁进 python 代码和浏览代码用的。搜一下有动图，看看就知道了。
</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">(use-package indent-tools
  :ensure t
  :init
  (add-hook &#39;python-mode-hook
            (lambda () (define-key python-mode-map (kbd &#34;C-c i&#34;) &#39;indent-tools-hydra/body))
            )
  )</code></pre></td></tr></table>
</div>
</div>
<h2 id="headline-7">
yasnippet 和 company
</h2>
<p>
elpy 是使用这两个补全的。有几个有用的配置， <code class="verbatim">C-s</code> 那个，可以在补全候选菜单出来的时候，用关键词过滤结果。
</p>
<p>
我没搞定在 company 里面直接显示出来 yasnippet 可用的 snippet，只好设置了一个快捷键 <code class="verbatim">C-c y</code> 来提示。可以提示出来一大堆。比如我经常写错的 <code class="verbatim">-*- coding:utf8 -*-</code> 有一个 snippet 叫做 <code class="verbatim">utf8</code> ，直接输入之后 tab 就可以了。
</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">(use-package company
  :ensure t
  :init
  (setq company-minimum-prefix-length 2)
  (setq company-dabbrev-ignore-case t)
  :config
  (add-hook &#39;after-init-hook &#39;global-company-mode)
  (define-key company-active-map (kbd &#34;C-n&#34;) #&#39;company-select-next)
  (define-key company-active-map (kbd &#34;C-p&#34;) #&#39;company-select-previous)
  (define-key company-active-map (kbd &#34;C-s&#34;) #&#39;company-filter-candidates)

  (global-set-key (kbd &#34;C-c y&#34;) &#39;company-yasnippet)
  )</code></pre></td></tr></table>
</div>
</div>

</main>


<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</section>


    
     <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = '';
            this.page.identifier = '';
        };

        (function() {
          var d = document, s = d.createElement('script');
          s.src = '//wdicc.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
     </script>
    





    <footer style="clear:both">
      
      <hr/>
      Theme from <a href="https://github.com/wd/hugo-classic">hugo-classic</a> fork from <a href="https://github.com/goodroot/hugo-classic">Github</a>
      
    </footer>
  </body>
</html>

