<!doctype html><html lang=zh-CN><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Setup Policy Route on Openwrt X86 With Wireguard | wd and cc</title>
<link rel=canonical href=https://wdicc.com/setup-policy-route-on-openwrt-x86-with-wireguard/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Setup Policy Route on Openwrt X86 With Wireguard"><meta property="og:description" content="刷系统 选择 image，我用的是 x86_64 的硬件。如果你不确定，可以选择 generic 的试试看，如果你能用 64 的，启动的时候"><meta property="og:type" content="article"><meta property="og:url" content="https://wdicc.com/setup-policy-route-on-openwrt-x86-with-wireguard/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-06T15:07:32+08:00"><meta property="article:modified_time" content="2021-11-06T15:07:32+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Setup Policy Route on Openwrt X86 With Wireguard"><meta name=twitter:description content="刷系统 选择 image，我用的是 x86_64 的硬件。如果你不确定，可以选择 generic 的试试看，如果你能用 64 的，启动的时候"><link rel=stylesheet href=https://wdicc.com/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><link rel=stylesheet href=https://wdicc.com/wdicc.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://wdicc.com/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://wdicc.com/an-incomplete-list-of-skills-senior-engineers-need-beyond-coding/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=https://wdicc.com/dns-request-in-alpine-image/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&text=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&title=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&is_video=false&description=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard&body=Check out this article: https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&title=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&title=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&name=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard&description=%e5%88%b7%e7%b3%bb%e7%bb%9f%20%e9%80%89%e6%8b%a9%20image%ef%bc%8c%e6%88%91%e7%94%a8%e7%9a%84%e6%98%af%20x86_64%20%e7%9a%84%e7%a1%ac%e4%bb%b6%e3%80%82%e5%a6%82%e6%9e%9c%e4%bd%a0%e4%b8%8d%e7%a1%ae%e5%ae%9a%ef%bc%8c%e5%8f%af%e4%bb%a5%e9%80%89%e6%8b%a9%20generic%20%e7%9a%84%e8%af%95%e8%af%95%e7%9c%8b%ef%bc%8c%e5%a6%82%e6%9e%9c%e4%bd%a0%e8%83%bd%e7%94%a8%2064%20%e7%9a%84%ef%bc%8c%e5%90%af%e5%8a%a8%e7%9a%84%e6%97%b6%e5%80%99" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&t=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Setup Policy Route on Openwrt X86 With Wireguard</h1><div class=meta><span class=author itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>wd</span></span><div class=postdate><time datetime="2021-11-06 15:07:32 +0800 +0800" itemprop=datePublished>2021-11-06</time></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/ rel=tag></a></div></div></header><div id=toc><nav id=TableOfContents><ul><li><a href=#规划下-wireguard-各个节点的-ip>规划下 wireguard 各个节点的 ip</a></li><li><a href=#安装配置-wireguard>安装配置 wireguard</a></li><li><a href=#配置-firewall>配置 firewall</a></li><li><a href=#配置-wireguard-peers>配置 wireguard peers</a></li></ul><ul><li><a href=#配置-ipset>配置 ipset</a></li><li><a href=#配置-dnsmasq>配置 dnsmasq</a></li><li><a href=#配置匹配-ipset-的包走-wg>配置匹配 ipset 的包走 wg</a></li><li><a href=#配置-hotplug>配置 hotplug</a></li></ul><ul><li><a href=#iptv>iptv</a></li><li><a href=#ddns>ddns</a></li><li><a href=#穷人的防屏蔽措施>穷人的防屏蔽措施</a></li><li><a href=#其他-1>其他</a></li><li><a href=#todo>TODO</a></li></ul></nav></div><div class=content itemprop=articleBody><h1 id=刷系统>刷系统</h1><p>选择 image，我用的是 x86_64 的硬件。如果你不确定，可以选择 generic 的试试看，如果你能用 64 的，启动的时候提示你用 64 位的性能更好。</p><p>然后需要选择不同的包，主要是在下面两个里面选。</p><ul><li>squashfs-combined：类似传统路由器，可以任意重置路由器。但是磁盘大小也是固定大小。</li><li>ext4-combined：磁盘可以 resize，如果你有超过 50G 的磁盘，都想要在路由器里面用，那就选这个。否则上面那个更好，毕竟有问题的时候重置很方便。这个恐怕只能重新刷系统了，麻烦多了。</li></ul><p>准备两个 u 盘。如果你能有一个 u 盘可以启动加存放那个 img 那就更好了。</p><ul><li>一个刷 debian live cd，启动的时候选择 live</li><li>一个里面放 openwrt 的 img <code>openwrt-21.02.0-x86-64-generic-ext4-combined.img</code>.</li></ul><p>连接显示器，键盘。</p><p>先使用 livecd 启动之后，先确认下盘符。一般 /dev/sda 是内置的磁盘，/dev/sdb 是 livecd。确认后插入另外一个 u 盘，这个的盘符应该是 /dev/sdc。</p><pre tabindex=0><code>mount /dev/sdc1 /mnt
cd /mnt
dd if=openwrt-21.02.0-x86-64-generic-ext4-combined.img of=/dev/sda
</code></pre><p>使用 cfdisk resize 下 /dev/sda2 并写到分区表。然后使用 <code>resize2fs /dev/sda2</code> 命令应用到文件系统。这个时候就可以使用路由器自带的 openwrt 启动了。</p><h1 id=初始化>初始化</h1><p>system -> system</p><ul><li>hostname</li><li>timezone</li></ul><p>system -> administration</p><ul><li>set password</li><li>ssh access:<ul><li>interface: lan</li><li>uncheck all the boxes</li></ul></li><li>ssh-keys<ul><li>add your pub keys</li></ul></li></ul><p><code>ssh root@192.168.1.1</code> 测试连接。</p><h1 id=调整网络配置>调整网络配置</h1><p>调整的主要原因是</p><ul><li>192.168.x.x 容易和某些 vpn 什么的冲突</li><li>把 eth0 改成 wan 口，其他都是 lan 口，比较符合直观的感受。</li></ul><p>调整内容</p><ul><li>network<ul><li>interfaces -> lan<ul><li>ip address: 10.10.10.1</li></ul></li><li>interfaces -> wan 和 wan6<ul><li>device: eth0</li></ul></li><li>devices -> br-lan<ul><li>把 eth0 之外都选上
这个操作之后，需要把线改接第二个口了。我遇到情况是 apply 之后部分修改没生效，别慌，把接口接回去应该还能继续配置。</li></ul></li></ul></li></ul><h1 id=使用-dnsmasq-full-替换-dnsmasq>使用 dnsmasq-full 替换 dnsmasq</h1><p>这一步需要通过 ssh 操作。这一步放最前面是为了避免丢失配置，因为为了省事（解决配置冲突）需要删除 <code>/etc/config/dhcp</code>。</p><pre tabindex=0><code>opkg update
opkg remove dnsmasq # 这一步可能会导致 dns 丢失，如果出现问题可以去 /etc/resolve.conf 里面重新配置下 dns
rm /etc/config/dhcp
opkg install dnsmasq-full
</code></pre><h1 id=网络拓扑>网络拓扑</h1><p>openwrt -> wifi router -> pc/mac/iphone
10.10.10.1/24 -> 10.10.10.2/10.10.8.1/24 -> 10.10.8.x</p><p>这样的结构下，如果 openwrt 出问题，可以随时把外网接 wifi router 上面继续用，其他设备都不用动。等稳定之后，可以把 wifi router 改成桥接模式。</p><h1 id=配置-wireguard>配置 wireguard</h1><p>参考文档：https://openwrt.org/docs/guide-user/services/vpn/wireguard/server</p><h2 id=规划下-wireguard-各个节点的-ip>规划下 wireguard 各个节点的 ip</h2><p>这里需要提前规划下 wireguard 网络，我的目的是通过远端的 vps 上网，所以我的设置如下</p><ul><li>network: 10.10.20.1/24</li><li>vps: 10.10.20.1</li><li>openwrt: 10.10.20.11</li><li>其他设备: 10.10.20.21(mac),22(iphone)</li></ul><h2 id=安装配置-wireguard>安装配置 wireguard</h2><ul><li>system -> software<ul><li>update lists</li><li>install: wireguard-tools(必须) luci-proto-wireguard(通过配置 luci 配置 wireguard 必须) luci-app-wireguard(显示一些连接信息，不是必须)</li></ul></li></ul><p>这个时候可能需要重启下路由器才能继续，否则可能在菜单里面看不到 wireguard 这个选项</p><ul><li>network -> interfaces<ul><li>Add new interface<ul><li>name: wg0</li><li>protocal: wireguard vpn</li><li>create interface<ul><li>private key: 可以点那个 generate key</li><li>listen port: 54321</li><li>ip address: 10.10.20.11</li></ul></li><li>save</li></ul></li><li>save and apply</li></ul></li></ul><p>这个时候执行 wg 命令应该可以看到 wg 设备的情况了。在 status -> wireguard 也可以看到。如果想要在这里支持 qr/code ，还需要安装一些 qrcode 相关的包。</p><h2 id=配置-firewall>配置 firewall</h2><p>单独为 wg 创建一个 zone。允许通过 wg 访问 wan 和 lan。</p><ul><li>network -> firewall -> zones<ul><li>add<ul><li>name: wireguard</li><li>forward: accept</li><li>mss clamping</li><li>masquerading</li><li>covered networks: wg0</li><li>allow forward to dest zone: lan, wan, wan6，也可以设置只允许访问 wan。</li><li><em>allow forward from source zone: lan</em>(这个好像是需要的)</li><li>save</li></ul></li><li>save and apply</li></ul></li></ul><p>允许通过 wan 访问 54321</p><ul><li>network -> firewall -> traffic rule<ul><li>add<ul><li>name: Allow-wireguard-from-wan</li><li>protocol: udp</li><li>dest zone: input</li><li>dest port: 54321</li><li>save</li></ul></li><li>save and apply</li></ul></li></ul><h2 id=配置-wireguard-peers>配置 wireguard peers</h2><ul><li>network -> interfaces -> wg0 -> edit -> peers<ul><li>add peer(客户端 peer)<ul><li>description: Mac</li><li>pub key:</li><li>allowed ips: 10.10.20.21/32</li></ul></li><li>add peer(vps server)<ul><li>description: vps</li><li>endpoint host: <code>vps ip</code></li><li>endpoint port: <code>vps port</code></li><li>allowed ips: 0.0.0.0/0</li></ul></li><li>save</li><li>save and apply</li><li>restart interface</li></ul></li></ul><p>这个时候执行 wg 命令或者去 status -> wireguard 应该能看到更多信息了。比较关键的是确认下 vps 那个有没有连接成功，看 <code>latest handshake</code> 是什么时候。</p><pre tabindex=0><code>peer: &lt;pub_key&gt;
  endpoint: &lt;ip:port&gt;
  allowed ips: 0.0.0.0/0
  latest handshake: 45 seconds ago
  transfer: 92 B received, 212 B sent
  persistent keepalive: every 25 seconds
</code></pre><p>也可以测试下是不是可以通过电脑或者手机连接这个 openwrt 上面的 wireguard。这个时候应该只能 handshake 成功，但是不能通过这个连接访问任何网站，因为还没有配置相关的路由。DNS 也不通。</p><h1 id=配置路由>配置路由</h1><p>配置针对 10.10.20.0/24 网段的路由，配置之后就可以通过 wg 访问路由器的ip 10.10.10.1 了。</p><pre tabindex=0><code>route add -net 10.10.20.0 netmask 255.255.255.0 dev wg0
</code></pre><p>如果你还想通过 wg 访问内网的设备(10.10.8.x)，还需要配置一条路由</p><p>network -> dhcp and dns -> static leases</p><ul><li>找到 wifi router 的设备，给它设置为固定 ip</li></ul><p>network -> static routes -> add</p><ul><li>interface: lan</li><li>target: 10.10.8.0</li><li>netmask: 255.255.255.0</li><li>gateway: 10.10.10.2(这个是 wifi router 的固定 ip)</li></ul><p>注意几点</p><ul><li>需要关闭 wifi 的防火墙，因为路由器一般默认不允许从 wan 连接。</li><li>wireguard 客户端的路由配置里面，增加 10.10.8.1/24，默认是没有的。</li></ul><h1 id=增加-route-table>增加 route table</h1><p>编辑 <code>/etc/iproute2/rt_tables</code>，增加一行</p><pre tabindex=0><code>200 gfw
</code></pre><h1 id=配置-dnsmasq-和-ipset>配置 dnsmasq 和 ipset</h1><h2 id=配置-ipset>配置 ipset</h2><p>安装 ipset</p><p>创建 <code>/etc/gfw.ip.ipset</code> 文件。里面存放需要通过 wg 访问的 ip。</p><pre tabindex=0><code>8.8.8.8
1.1.1.1
</code></pre><p>创建 <code>/etc/gfw.net.ipset</code> 文件。里面存放需要通过 wg 访问的 cidr</p><pre tabindex=0><code># telegram
67.198.55.0/24
91.108.4.0/22
91.108.8.0/22
91.108.12.0/22
91.108.16.0/22
91.108.56.0/22
109.239.140.0/24
149.154.160.0/20
149.154.164.0/22
149.154.168.0/22
149.154.172.0/22
205.172.60.0/22
</code></pre><p>修改 <code>/etc/config/firewall</code> 文件。增加下面的内容</p><pre tabindex=0><code>config ipset
    option name &#39;gfw&#39;
    option match &#39;ip&#39;
    option storage &#39;hash&#39;
    option enabled &#39;1&#39;
    option loadfile &#39;/etc/gfw.ip.ipset&#39;
	
config ipset
    option name &#39;gfwnet&#39;
    option match &#39;net&#39;
    option storage &#39;hash&#39;
    option enabled &#39;1&#39;
    option loadfile &#39;/etc/gfw.net.ipset&#39;
</code></pre><p>重启 firewall <code>/etc/init.d/firewall restart</code>. 执行 <code>ipset list</code> 查看结果</p><pre tabindex=0><code>Name: gfwip
Type: hash:ip
Revision: 4
Header: family inet hashsize 1024 maxelem 65536
Size in memory: 200
References: 0
Number of entries: 0
Members:
1.1.1.1
8.8.8.8

Name: gfwnet
Type: hash:net
Revision: 6
Header: family inet hashsize 1024 maxelem 65536
Size in memory: 1216
References: 0
Number of entries: 12
Members:
149.154.172.0/22
109.239.140.0/24
91.108.8.0/22
67.198.55.0/24
149.154.168.0/22
149.154.160.0/20
91.108.12.0/22
91.108.16.0/22
149.154.164.0/22
91.108.56.0/22
91.108.4.0/22
205.172.60.0/22
</code></pre><p><strong>日后这两个文件 <code>/etc/gfw.net.ipset</code> 和 <code>/etc/gfw.ip.ipset</code> 就是管理静态的需要走 wg 的 ip 的文件。</strong></p><h2 id=配置-dnsmasq>配置 dnsmasq</h2><p>network -> dhcp and dns</p><ul><li>Listen interfaces: lan, wg</li></ul><p>这个配置之后应该可以通过 wg 访问 openwrt 的 dns 了。</p><p>创建 <code>/etc/dnsmasq.d/gfw.conf</code> 文件，可以根据需要自己写，也可以使用别人写好的。格式如下</p><pre tabindex=0><code>server=/twitter.com/8.8.8.8
ipset=/twitter.com/gfwip
</code></pre><p>也可以使用我整理好的 <a href=https://github.com/wd/gfwlist-ipset/blob/main/gfwlist-ipset.conf>https://github.com/wd/gfwlist-ipset/blob/main/gfwlist-ipset.conf</a></p><p>修改 <code>/etc/config/dhcp</code> 文件，增加一行</p><pre tabindex=0><code>config dnsmasq
	...
	option confdir &#39;/etc/dnsmasq.d&#39;
</code></pre><p>重启 dnsmasq, <code>/etc/init.d/dnsmasq restart</code>. 测试下</p><pre tabindex=0><code># dig twitter.com

; &lt;&lt;&gt;&gt; DiG 9.17.13 &lt;&lt;&gt;&gt; twitter.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 13344
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;twitter.com.                   IN      A

;; ANSWER SECTION:
twitter.com.            1227    IN      A       104.244.42.193
twitter.com.            1227    IN      A       104.244.42.1

;; Query time: 0 msec
;; SERVER: 127.0.0.1#53(127.0.0.1) (UDP)
;; WHEN: Sun Oct 24 22:38:47 CST 2021
;; MSG SIZE  rcvd: 72

# ipset list gfwip
Name: gfwip
Type: hash:ip
Revision: 4
Header: family inet hashsize 1024 maxelem 65536
Size in memory: 392
References: 0
Number of entries: 4
Members:
8.8.8.8
104.244.42.193
1.1.1.1
104.244.42.1
</code></pre><p>能看到 twitter ip 已经加入到了 ipset 里面。（这个测试里面不一定能返回正确的 twitter 的 ip，只是测试 dnsmasq + ipset 是正常工作的）。</p><p><strong>以后需要翻墙的域名就在这个 <code>/etc/dnsmasq.d/gfw.conf</code> 文件里面维护。也可以在这个目录放多个文件。</strong></p><h2 id=配置匹配-ipset-的包走-wg>配置匹配 ipset 的包走 wg</h2><p>network -> firewall -> custom rules</p><pre tabindex=0><code>iptables -t mangle -N fwmark
iptables -t mangle -A PREROUTING -j fwmark
iptables -t mangle -A OUTPUT -j fwmark

iptables -t mangle -A fwmark -m set --match-set gfwip dst -j MARK --set-mark 1
iptables -t mangle -A fwmark -m set --match-set gfwnet dst -j MARK --set-mark 1
</code></pre><p>路由规则</p><pre tabindex=0><code># 有 0x1 标记的，都走 gfw 这个 table
ip rule add fwmark 0x1 table gfw

# gfw 这个 table 默认都从 10.10.20.1 出去
ip route add default via 10.10.20.1 dev wg0 table gfw
</code></pre><h2 id=配置-hotplug>配置 hotplug</h2><p>上面的路由规则目前都是通过手动配置的，重启设备就没有了。需要配置一个自动添加的脚本。</p><p>创建一个文件 <code>/etc/hotplug.d/iface/50-wg</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;ifup&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span>$ACTION<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$INTERFACE<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;wg0&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        ip route add 10.10.20.0/24 dev wg0
</span></span><span style=display:flex><span>        ip rule|grep -q <span style=color:#e6db74>&#39;fwmark 0x1 lookup gfw&#39;</span> <span style=color:#f92672>||</span> ip rule add fwmark 0x1 table gfw
</span></span><span style=display:flex><span>        ip route add default via 10.10.20.1 dev wg0 table gfw
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><h1 id=排查错误>排查错误</h1><p>在全部配置好之后，最好重启下 openwrt，确保重启后依然是可以上网的。如果有问题，可以参考下面的步骤。</p><p>确保 ipset ok，应该有两个set <code>gfwip</code> 和 <code>gfwnet</code>。查询一个被屏蔽的 dns 之后能在 ipset 列表里面看到。</p><pre tabindex=0><code># ipset list
</code></pre><p>确保路由规则都在</p><pre tabindex=0><code># ip route show table gfw
default via 10.10.20.1 dev wg0

# ip rule|grep fwmark
32765:  from all fwmark 0x1 lookup gfw

# ip route |grep wg
10.10.20.0/24 dev wg0 scope link
</code></pre><p>iptables 规则 ok</p><pre tabindex=0><code># iptables -t mangle -nvL PREROUTING
Chain PREROUTING (policy ACCEPT 26721 packets, 5880K bytes)
 pkts bytes target     prot opt in     out     source               destination
  27M   31G fwmark     all  --  *      *       0.0.0.0/0            0.0.0.0/0
 
# iptables -t mangle -nvL OUTPUT
Chain OUTPUT (policy ACCEPT 6295 packets, 2828K bytes)
 pkts bytes target     prot opt in     out     source               destination
 307K   86M fwmark     all  --  *      *       0.0.0.0/0            0.0.0.0/0

# iptables -t mangle -nvL fwmark
Chain fwmark (2 references)
 pkts bytes target     prot opt in     out     source               destination
 188K   29M MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            match-set gfwip dst MARK set 0x1
 1417  157K MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            match-set gfwnet dst MARK set 0x1
</code></pre><p>启用 log
system -> logging</p><ul><li>write system log to file: /tmp/system.log</li></ul><p>通过看 FORWARD 和 POSTROUTING 的日志来判断可能是哪里有问题。</p><pre tabindex=0><code>DEST=8.8.8.8
iptables -t filter -A FORWARD -d $DEST -j LOG --log-prefix &#39;FWD:&#39;
iptables -t mangle -A POSTROUTING -d $DEST -j LOG --log-prefix &#39;POST:&#39;

DEST=10.10.8.1
iptables -t filter -D FORWARD -d $DEST -j LOG --log-prefix &#39;FWD:&#39;
iptables -t mangle -D POSTROUTING -d $DEST -j LOG --log-prefix &#39;POST:&#39;
</code></pre><p>如果只有 FORWARD 没有 POSTROUTING，那就是包被 drop 了。同时也观察包是否有正确的 src dst 和 mark。</p><h1 id=其他>其他</h1><h2 id=iptv>iptv</h2><p>network -> interfaces -> add</p><ul><li>name: iptv</li><li>protocal: dhcp</li><li>device: eth0</li><li>advanced settings<ul><li>use default geteway: 去掉选择</li></ul></li></ul><p>安装 luci-app-udpxy</p><p>services -> udpxy</p><ul><li>enabled 选上</li><li>status 选上</li><li>port 4022</li><li>source ip/interface: eth0</li><li>其他都留空</li><li>save and apply</li></ul><p>访问 http://10.10.10.1:4022/status 能看到 <code>Multicast address</code> 是 192.168.1.x 这样的 ip。可以找一个地址测试下是不是可以用吧。</p><h2 id=ddns>ddns</h2><p>安装 ddns-scripts-cloudflare ca-certificates</p><p>services -> ddns -> add</p><ul><li>hostname: x.abc.com</li><li>ddns service provider: cloudflare.com-v4</li><li>domain: <a href=mailto:x@abc.com>x@abc.com</a></li><li>username: Bearer</li><li>password: token from cloudflare</li><li>path to ca certs: /etc/ssl/certs</li><li>save</li></ul><p>点击那个 reload 可以重复执行。点击 edit 可以看 log，如果遇到 ssl 错误，可能需要安装 <code>libwolfssl4.8.1.66253b90</code>，openwrt 默认使用 <a href=https://openwrt.org/releases/21.02/notes-21.02.0-rc1#tls_and_https_support_included_by_default>wolfssl</a> 。</p><h2 id=穷人的防屏蔽措施>穷人的防屏蔽措施</h2><p>wireguard 连不上也很稀松平常，一方面 UDP 被 Qos，另外一方面就是 GFW 作怪。我在 twitter 上面无意中看到一个措施感觉还有点用。思路就是在服务器端开 N 个 wireguard 端口，客户端连接有问题的时候就换一个。</p><p>当然实际上在服务器端也不用真的开 N 个，只需要用 iptables 转发到真实的端口就行。就是类似下面这句，把其中的几个端口改改就行。</p><pre tabindex=0><code>iptables -t nat -A PREROUTING -p udp --destination-port 20011:23344 -j REDIRECT --to-ports 1234
</code></pre><p>然后在 openwrt 里面，增加一个 crontab 定期检查网络是不是通的就行。这里面几个端口可能需要改改，以及 wg 设备的名字。 crontab 项目类似这个 <code>* * * * * /etc/wg/change-wg-port.sh</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>LOG<span style=color:#f92672>=</span>/tmp/check_gfw.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>date +%F_%T<span style=color:#66d9ef>)</span><span style=color:#e6db74> </span>$1<span style=color:#e6db74>&#34;</span> &gt;&gt; $LOG
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>check_gfw<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    code<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl -s -o /dev/null -w <span style=color:#e6db74>&#34;%{http_code}&#34;</span> google.com<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$code<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;301&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;google.com is ok&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        log <span style=color:#e6db74>&#34;google.com is not ok </span>$code<span style=color:#e6db74>, switch port&#34;</span>
</span></span><span style=display:flex><span>        switch_port
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>switch_port<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    current_port<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>uci get network.@wireguard_wg0<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span>.endpoint_port<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    new_port<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>expr $current_port + 1<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$new_port<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;23344&#34;</span> <span style=color:#f92672>]</span>;<span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>      new_port<span style=color:#f92672>=</span><span style=color:#ae81ff>20011</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    log <span style=color:#e6db74>&#34;new port is </span>$new_port<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    uci set network.@wireguard_wg0<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span>.endpoint_port<span style=color:#f92672>=</span>$new_port
</span></span><span style=display:flex><span>    uci commit network
</span></span><span style=display:flex><span>    ifup wg0
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>check_gfw
</span></span></code></pre></div><p>这个是我的一些检查日志，8.5 断了九分钟，8.7 断了三分钟。这个因为是 1 分钟检查一次，所以可能会有点慢，但是，总归比什么都不做强。。</p><pre tabindex=0><code>2022-08-02_12:53:05 google.com is not ok 000, switch port
2022-08-05_22:24:05 google.com is not ok 000, switch port
2022-08-05_22:25:05 google.com is not ok 000, switch port
2022-08-05_22:26:05 google.com is not ok 000, switch port
2022-08-05_22:27:05 google.com is not ok 000, switch port
2022-08-05_22:28:05 google.com is not ok 000, switch port
2022-08-05_22:29:05 google.com is not ok 000, switch port
2022-08-05_22:30:05 google.com is not ok 000, switch port
2022-08-05_22:31:05 google.com is not ok 000, switch port
2022-08-05_22:32:05 google.com is not ok 000, switch port
2022-08-07_02:11:15 google.com is not ok 000, switch port
2022-08-07_02:12:05 google.com is not ok 000, switch port
2022-08-07_02:13:05 google.com is not ok 000, switch port
2022-08-07_02:14:05 google.com is not ok 000, switch port
</code></pre><h2 id=其他-1>其他</h2><ul><li>通过配置 port-foward -> router 开放 router 下面客户端的端口。例如 NAS bt 下载用的 p2p 端口。注意还需要在 router 里面也做这个映射。当然也可以直接把 nas 接到 openwrt。</li><li>如果在路由配置好之前发生了针对被污染的域名的 dns 查询，那很可能会缓存被污染的结果，目前没想到什么好办法。不过好在一般等 dns 过期之后就正常了。</li></ul><h2 id=todo>TODO</h2><ul><li>ipv6 支持：因为这个方案目前不支持 ipv6，所以如果有 app 优先使用 ipv6 查询的话，那么返回的 ipv6 地址是不会走 wg 的，这个时候就会出现不能用。解决方法就是关闭这个设备的 ipv6，或者直接关闭 openwrt 的 ipv6 支持。</li></ul></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&text=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&title=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&is_video=false&description=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard&body=Check out this article: https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&title=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&title=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&name=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard&description=%e5%88%b7%e7%b3%bb%e7%bb%9f%20%e9%80%89%e6%8b%a9%20image%ef%bc%8c%e6%88%91%e7%94%a8%e7%9a%84%e6%98%af%20x86_64%20%e7%9a%84%e7%a1%ac%e4%bb%b6%e3%80%82%e5%a6%82%e6%9e%9c%e4%bd%a0%e4%b8%8d%e7%a1%ae%e5%ae%9a%ef%bc%8c%e5%8f%af%e4%bb%a5%e9%80%89%e6%8b%a9%20generic%20%e7%9a%84%e8%af%95%e8%af%95%e7%9c%8b%ef%bc%8c%e5%a6%82%e6%9e%9c%e4%bd%a0%e8%83%bd%e7%94%a8%2064%20%e7%9a%84%ef%bc%8c%e5%90%af%e5%8a%a8%e7%9a%84%e6%97%b6%e5%80%99" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwdicc.com%2fsetup-policy-route-on-openwrt-x86-with-wireguard%2f&t=Setup%20Policy%20Route%20on%20Openwrt%20X86%20With%20Wireguard" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2024 wd and cc</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>