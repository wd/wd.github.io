<!doctype html><html lang=en><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://wdicc.com/favicon.ico><title>Setup Policy Route on Openwrt X86 With Wireguard | wd and cc</title><meta name=title content="Setup Policy Route on Openwrt X86 With Wireguard"><meta name=description content="刷系统
选择 image，我用的是 x86_64 的硬件。如果你不确定，可以选择 generic 的试试看，如果你能用 64 的，启动的时候提示你用 64 位的性能更好。
然后需要选择不同的包，主要是在下面两个里面选。

squashfs-combined：类似传统路由器，可以任意重置路由器。但是磁盘大小也是固定大小。
ext4-combined：磁盘可以 resize，如果你有超过 50G 的磁盘，都想要在路由器里面用，那就选这个。否则上面那个更好，毕竟有问题的时候重置很方便。这个恐怕只能重新刷系统了，麻烦多了。

准备两个 u 盘。如果你能有一个 u 盘可以启动加存放那个 img 那就更好了。"><meta name=keywords content=","><meta property="og:url" content="https://wdicc.com/setup-policy-route-on-openwrt-x86-with-wireguard/"><meta property="og:site_name" content="wd and cc"><meta property="og:title" content="Setup Policy Route on Openwrt X86 With Wireguard"><meta property="og:description" content="刷系统 选择 image，我用的是 x86_64 的硬件。如果你不确定，可以选择 generic 的试试看，如果你能用 64 的，启动的时候提示你用 64 位的性能更好。
然后需要选择不同的包，主要是在下面两个里面选。
squashfs-combined：类似传统路由器，可以任意重置路由器。但是磁盘大小也是固定大小。 ext4-combined：磁盘可以 resize，如果你有超过 50G 的磁盘，都想要在路由器里面用，那就选这个。否则上面那个更好，毕竟有问题的时候重置很方便。这个恐怕只能重新刷系统了，麻烦多了。 准备两个 u 盘。如果你能有一个 u 盘可以启动加存放那个 img 那就更好了。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-06T15:07:32+08:00"><meta property="article:modified_time" content="2021-11-06T15:07:32+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Setup Policy Route on Openwrt X86 With Wireguard"><meta name=twitter:description content="刷系统 选择 image，我用的是 x86_64 的硬件。如果你不确定，可以选择 generic 的试试看，如果你能用 64 的，启动的时候提示你用 64 位的性能更好。
然后需要选择不同的包，主要是在下面两个里面选。
squashfs-combined：类似传统路由器，可以任意重置路由器。但是磁盘大小也是固定大小。 ext4-combined：磁盘可以 resize，如果你有超过 50G 的磁盘，都想要在路由器里面用，那就选这个。否则上面那个更好，毕竟有问题的时候重置很方便。这个恐怕只能重新刷系统了，麻烦多了。 准备两个 u 盘。如果你能有一个 u 盘可以启动加存放那个 img 那就更好了。"><meta itemprop=name content="Setup Policy Route on Openwrt X86 With Wireguard"><meta itemprop=description content="刷系统 选择 image，我用的是 x86_64 的硬件。如果你不确定，可以选择 generic 的试试看，如果你能用 64 的，启动的时候提示你用 64 位的性能更好。
然后需要选择不同的包，主要是在下面两个里面选。
squashfs-combined：类似传统路由器，可以任意重置路由器。但是磁盘大小也是固定大小。 ext4-combined：磁盘可以 resize，如果你有超过 50G 的磁盘，都想要在路由器里面用，那就选这个。否则上面那个更好，毕竟有问题的时候重置很方便。这个恐怕只能重新刷系统了，麻烦多了。 准备两个 u 盘。如果你能有一个 u 盘可以启动加存放那个 img 那就更好了。"><meta itemprop=datePublished content="2021-11-06T15:07:32+08:00"><meta itemprop=dateModified content="2021-11-06T15:07:32+08:00"><meta itemprop=wordCount content="3728"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--code-background-color:#f2f2f2;--code-color:#222;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--code-background-color:#000;--code-color:#ddd;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px}blockquote{border-left:1px solid #999;color:var(--code-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto !important}.highlight,.code{padding:1px 15px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>wd and cc</h2></a><p>-- Good good study, day day up!</p><nav><a href=/>Home</a>
<a href=/posts/>Posts</a>
<a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a>
<a href=/tags/>Tags</a>
<a href=/atom.xml>subscribe</a></nav></header><main><h1>Setup Policy Route on Openwrt X86 With Wireguard</h1><p><i><time datetime=2021-11-06>06 Nov, 2021</time></i></p><content><h1 id=刷系统>刷系统</h1><p>选择 image，我用的是 x86_64 的硬件。如果你不确定，可以选择 generic 的试试看，如果你能用 64 的，启动的时候提示你用 64 位的性能更好。</p><p>然后需要选择不同的包，主要是在下面两个里面选。</p><ul><li>squashfs-combined：类似传统路由器，可以任意重置路由器。但是磁盘大小也是固定大小。</li><li>ext4-combined：磁盘可以 resize，如果你有超过 50G 的磁盘，都想要在路由器里面用，那就选这个。否则上面那个更好，毕竟有问题的时候重置很方便。这个恐怕只能重新刷系统了，麻烦多了。</li></ul><p>准备两个 u 盘。如果你能有一个 u 盘可以启动加存放那个 img 那就更好了。</p><ul><li>一个刷 debian live cd，启动的时候选择 live</li><li>一个里面放 openwrt 的 img <code>openwrt-21.02.0-x86-64-generic-ext4-combined.img</code>.</li></ul><p>连接显示器，键盘。</p><p>先使用 livecd 启动之后，先确认下盘符。一般 /dev/sda 是内置的磁盘，/dev/sdb 是 livecd。确认后插入另外一个 u 盘，这个的盘符应该是 /dev/sdc。</p><pre tabindex=0><code>mount /dev/sdc1 /mnt
cd /mnt
dd if=openwrt-21.02.0-x86-64-generic-ext4-combined.img of=/dev/sda
</code></pre><p>使用 cfdisk resize 下 /dev/sda2 并写到分区表。然后使用 <code>resize2fs /dev/sda2</code> 命令应用到文件系统。这个时候就可以使用路由器自带的 openwrt 启动了。</p><h1 id=初始化>初始化</h1><p>system -> system</p><ul><li>hostname</li><li>timezone</li></ul><p>system -> administration</p><ul><li>set password</li><li>ssh access:<ul><li>interface: lan</li><li>uncheck all the boxes</li></ul></li><li>ssh-keys<ul><li>add your pub keys</li></ul></li></ul><p><code>ssh root@192.168.1.1</code> 测试连接。</p><h1 id=调整网络配置>调整网络配置</h1><p>调整的主要原因是</p><ul><li>192.168.x.x 容易和某些 vpn 什么的冲突</li><li>把 eth0 改成 wan 口，其他都是 lan 口，比较符合直观的感受。</li></ul><p>调整内容</p><ul><li>network<ul><li>interfaces -> lan<ul><li>ip address: 10.10.10.1</li></ul></li><li>interfaces -> wan 和 wan6<ul><li>device: eth0</li></ul></li><li>devices -> br-lan<ul><li>把 eth0 之外都选上
这个操作之后，需要把线改接第二个口了。我遇到情况是 apply 之后部分修改没生效，别慌，把接口接回去应该还能继续配置。</li></ul></li></ul></li></ul><h1 id=使用-dnsmasq-full-替换-dnsmasq>使用 dnsmasq-full 替换 dnsmasq</h1><p>这一步需要通过 ssh 操作。这一步放最前面是为了避免丢失配置，因为为了省事（解决配置冲突）需要删除 <code>/etc/config/dhcp</code>。</p><pre tabindex=0><code>opkg update
opkg remove dnsmasq # 这一步可能会导致 dns 丢失，如果出现问题可以去 /etc/resolve.conf 里面重新配置下 dns
rm /etc/config/dhcp
opkg install dnsmasq-full
</code></pre><h1 id=网络拓扑>网络拓扑</h1><p>openwrt -> wifi router -> pc/mac/iphone
10.10.10.1/24 -> 10.10.10.2/10.10.8.1/24 -> 10.10.8.x</p><p>这样的结构下，如果 openwrt 出问题，可以随时把外网接 wifi router 上面继续用，其他设备都不用动。等稳定之后，可以把 wifi router 改成桥接模式。</p><h1 id=配置-wireguard>配置 wireguard</h1><p>参考文档：https://openwrt.org/docs/guide-user/services/vpn/wireguard/server</p><h2 id=规划下-wireguard-各个节点的-ip>规划下 wireguard 各个节点的 ip</h2><p>这里需要提前规划下 wireguard 网络，我的目的是通过远端的 vps 上网，所以我的设置如下</p><ul><li>network: 10.10.20.1/24</li><li>vps: 10.10.20.1</li><li>openwrt: 10.10.20.11</li><li>其他设备: 10.10.20.21(mac),22(iphone)</li></ul><h2 id=安装配置-wireguard>安装配置 wireguard</h2><ul><li>system -> software<ul><li>update lists</li><li>install: wireguard-tools(必须) luci-proto-wireguard(通过配置 luci 配置 wireguard 必须) luci-app-wireguard(显示一些连接信息，不是必须)</li></ul></li></ul><p>这个时候可能需要重启下路由器才能继续，否则可能在菜单里面看不到 wireguard 这个选项</p><ul><li>network -> interfaces<ul><li>Add new interface<ul><li>name: wg0</li><li>protocal: wireguard vpn</li><li>create interface<ul><li>private key: 可以点那个 generate key</li><li>listen port: 54321</li><li>ip address: 10.10.20.11</li></ul></li><li>save</li></ul></li><li>save and apply</li></ul></li></ul><p>这个时候执行 wg 命令应该可以看到 wg 设备的情况了。在 status -> wireguard 也可以看到。如果想要在这里支持 qr/code ，还需要安装一些 qrcode 相关的包。</p><h2 id=配置-firewall>配置 firewall</h2><p>单独为 wg 创建一个 zone。允许通过 wg 访问 wan 和 lan。</p><ul><li>network -> firewall -> zones<ul><li>add<ul><li>name: wireguard</li><li>forward: accept</li><li>mss clamping</li><li>masquerading</li><li>covered networks: wg0</li><li>allow forward to dest zone: lan, wan, wan6，也可以设置只允许访问 wan。</li><li><em>allow forward from source zone: lan</em>(这个好像是需要的)</li><li>save</li></ul></li><li>save and apply</li></ul></li></ul><p>允许通过 wan 访问 54321</p><ul><li>network -> firewall -> traffic rule<ul><li>add<ul><li>name: Allow-wireguard-from-wan</li><li>protocol: udp</li><li>dest zone: input</li><li>dest port: 54321</li><li>save</li></ul></li><li>save and apply</li></ul></li></ul><h2 id=配置-wireguard-peers>配置 wireguard peers</h2><ul><li>network -> interfaces -> wg0 -> edit -> peers<ul><li>add peer(客户端 peer)<ul><li>description: Mac</li><li>pub key:</li><li>allowed ips: 10.10.20.21/32</li></ul></li><li>add peer(vps server)<ul><li>description: vps</li><li>endpoint host: <code>vps ip</code></li><li>endpoint port: <code>vps port</code></li><li>allowed ips: 0.0.0.0/0</li></ul></li><li>save</li><li>save and apply</li><li>restart interface</li></ul></li></ul><p>这个时候执行 wg 命令或者去 status -> wireguard 应该能看到更多信息了。比较关键的是确认下 vps 那个有没有连接成功，看 <code>latest handshake</code> 是什么时候。</p><pre tabindex=0><code>peer: &lt;pub_key&gt;
  endpoint: &lt;ip:port&gt;
  allowed ips: 0.0.0.0/0
  latest handshake: 45 seconds ago
  transfer: 92 B received, 212 B sent
  persistent keepalive: every 25 seconds
</code></pre><p>也可以测试下是不是可以通过电脑或者手机连接这个 openwrt 上面的 wireguard。这个时候应该只能 handshake 成功，但是不能通过这个连接访问任何网站，因为还没有配置相关的路由。DNS 也不通。</p><h1 id=配置路由>配置路由</h1><p>配置针对 10.10.20.0/24 网段的路由，配置之后就可以通过 wg 访问路由器的ip 10.10.10.1 了。</p><pre tabindex=0><code>route add -net 10.10.20.0 netmask 255.255.255.0 dev wg0
</code></pre><p>如果你还想通过 wg 访问内网的设备(10.10.8.x)，还需要配置一条路由</p><p>network -> dhcp and dns -> static leases</p><ul><li>找到 wifi router 的设备，给它设置为固定 ip</li></ul><p>network -> static routes -> add</p><ul><li>interface: lan</li><li>target: 10.10.8.0</li><li>netmask: 255.255.255.0</li><li>gateway: 10.10.10.2(这个是 wifi router 的固定 ip)</li></ul><p>注意几点</p><ul><li>需要关闭 wifi 的防火墙，因为路由器一般默认不允许从 wan 连接。</li><li>wireguard 客户端的路由配置里面，增加 10.10.8.1/24，默认是没有的。</li></ul><h1 id=增加-route-table>增加 route table</h1><p>编辑 <code>/etc/iproute2/rt_tables</code>，增加一行</p><pre tabindex=0><code>200 gfw
</code></pre><h1 id=配置-dnsmasq-和-ipset>配置 dnsmasq 和 ipset</h1><h2 id=配置-ipset>配置 ipset</h2><p>安装 ipset</p><p>创建 <code>/etc/gfw.ip.ipset</code> 文件。里面存放需要通过 wg 访问的 ip。</p><pre tabindex=0><code>8.8.8.8
1.1.1.1
</code></pre><p>创建 <code>/etc/gfw.net.ipset</code> 文件。里面存放需要通过 wg 访问的 cidr</p><pre tabindex=0><code># telegram
67.198.55.0/24
91.108.4.0/22
91.108.8.0/22
91.108.12.0/22
91.108.16.0/22
91.108.56.0/22
109.239.140.0/24
149.154.160.0/20
149.154.164.0/22
149.154.168.0/22
149.154.172.0/22
205.172.60.0/22
</code></pre><p>修改 <code>/etc/config/firewall</code> 文件。增加下面的内容</p><pre tabindex=0><code>config ipset
    option name &#39;gfw&#39;
    option match &#39;ip&#39;
    option storage &#39;hash&#39;
    option enabled &#39;1&#39;
    option loadfile &#39;/etc/gfw.ip.ipset&#39;
	
config ipset
    option name &#39;gfwnet&#39;
    option match &#39;net&#39;
    option storage &#39;hash&#39;
    option enabled &#39;1&#39;
    option loadfile &#39;/etc/gfw.net.ipset&#39;
</code></pre><p>重启 firewall <code>/etc/init.d/firewall restart</code>. 执行 <code>ipset list</code> 查看结果</p><pre tabindex=0><code>Name: gfwip
Type: hash:ip
Revision: 4
Header: family inet hashsize 1024 maxelem 65536
Size in memory: 200
References: 0
Number of entries: 0
Members:
1.1.1.1
8.8.8.8

Name: gfwnet
Type: hash:net
Revision: 6
Header: family inet hashsize 1024 maxelem 65536
Size in memory: 1216
References: 0
Number of entries: 12
Members:
149.154.172.0/22
109.239.140.0/24
91.108.8.0/22
67.198.55.0/24
149.154.168.0/22
149.154.160.0/20
91.108.12.0/22
91.108.16.0/22
149.154.164.0/22
91.108.56.0/22
91.108.4.0/22
205.172.60.0/22
</code></pre><p><strong>日后这两个文件 <code>/etc/gfw.net.ipset</code> 和 <code>/etc/gfw.ip.ipset</code> 就是管理静态的需要走 wg 的 ip 的文件。</strong></p><h2 id=配置-dnsmasq>配置 dnsmasq</h2><p>network -> dhcp and dns</p><ul><li>Listen interfaces: lan, wg</li></ul><p>这个配置之后应该可以通过 wg 访问 openwrt 的 dns 了。</p><p>创建 <code>/etc/dnsmasq.d/gfw.conf</code> 文件，可以根据需要自己写，也可以使用别人写好的。格式如下</p><pre tabindex=0><code>server=/twitter.com/8.8.8.8
ipset=/twitter.com/gfwip
</code></pre><p>也可以使用我整理好的 <a href=https://github.com/wd/gfwlist-ipset/blob/main/gfwlist-ipset.conf>https://github.com/wd/gfwlist-ipset/blob/main/gfwlist-ipset.conf</a></p><p>修改 <code>/etc/config/dhcp</code> 文件，增加一行</p><pre tabindex=0><code>config dnsmasq
	...
	option confdir &#39;/etc/dnsmasq.d&#39;
</code></pre><p>重启 dnsmasq, <code>/etc/init.d/dnsmasq restart</code>. 测试下</p><pre tabindex=0><code># dig twitter.com

; &lt;&lt;&gt;&gt; DiG 9.17.13 &lt;&lt;&gt;&gt; twitter.com
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 13344
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;twitter.com.                   IN      A

;; ANSWER SECTION:
twitter.com.            1227    IN      A       104.244.42.193
twitter.com.            1227    IN      A       104.244.42.1

;; Query time: 0 msec
;; SERVER: 127.0.0.1#53(127.0.0.1) (UDP)
;; WHEN: Sun Oct 24 22:38:47 CST 2021
;; MSG SIZE  rcvd: 72

# ipset list gfwip
Name: gfwip
Type: hash:ip
Revision: 4
Header: family inet hashsize 1024 maxelem 65536
Size in memory: 392
References: 0
Number of entries: 4
Members:
8.8.8.8
104.244.42.193
1.1.1.1
104.244.42.1
</code></pre><p>能看到 twitter ip 已经加入到了 ipset 里面。（这个测试里面不一定能返回正确的 twitter 的 ip，只是测试 dnsmasq + ipset 是正常工作的）。</p><p><strong>以后需要翻墙的域名就在这个 <code>/etc/dnsmasq.d/gfw.conf</code> 文件里面维护。也可以在这个目录放多个文件。</strong></p><h2 id=配置匹配-ipset-的包走-wg>配置匹配 ipset 的包走 wg</h2><p>network -> firewall -> custom rules</p><pre tabindex=0><code>iptables -t mangle -N fwmark
iptables -t mangle -A PREROUTING -j fwmark
iptables -t mangle -A OUTPUT -j fwmark

iptables -t mangle -A fwmark -m set --match-set gfwip dst -j MARK --set-mark 1
iptables -t mangle -A fwmark -m set --match-set gfwnet dst -j MARK --set-mark 1
</code></pre><p>路由规则</p><pre tabindex=0><code># 有 0x1 标记的，都走 gfw 这个 table
ip rule add fwmark 0x1 table gfw

# gfw 这个 table 默认都从 10.10.20.1 出去
ip route add default via 10.10.20.1 dev wg0 table gfw
</code></pre><h2 id=配置-hotplug>配置 hotplug</h2><p>上面的路由规则目前都是通过手动配置的，重启设备就没有了。需要配置一个自动添加的脚本。</p><p>创建一个文件 <code>/etc/hotplug.d/iface/50-wg</code></p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#007020>#!/bin/sh
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#007020></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#007020;font-weight:700>if</span> <span style=color:#666>[</span> <span style=color:#4070a0>&#34;ifup&#34;</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$ACTION</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>]</span> <span style=color:#666>&amp;&amp;</span> <span style=color:#666>[</span> <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$INTERFACE</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#34;wg0&#34;</span> <span style=color:#666>]</span>; <span style=color:#007020;font-weight:700>then</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>        ip route add 10.10.20.0/24 dev wg0
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>        ip rule|grep -q <span style=color:#4070a0>&#39;fwmark 0x1 lookup gfw&#39;</span> <span style=color:#666>||</span> ip rule add fwmark 0x1 table gfw
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>        ip route add default via 10.10.20.1 dev wg0 table gfw
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#007020;font-weight:700>fi</span>
</span></span></code></pre></div><h1 id=排查错误>排查错误</h1><p>在全部配置好之后，最好重启下 openwrt，确保重启后依然是可以上网的。如果有问题，可以参考下面的步骤。</p><p>确保 ipset ok，应该有两个set <code>gfwip</code> 和 <code>gfwnet</code>。查询一个被屏蔽的 dns 之后能在 ipset 列表里面看到。</p><pre tabindex=0><code># ipset list
</code></pre><p>确保路由规则都在</p><pre tabindex=0><code># ip route show table gfw
default via 10.10.20.1 dev wg0

# ip rule|grep fwmark
32765:  from all fwmark 0x1 lookup gfw

# ip route |grep wg
10.10.20.0/24 dev wg0 scope link
</code></pre><p>iptables 规则 ok</p><pre tabindex=0><code># iptables -t mangle -nvL PREROUTING
Chain PREROUTING (policy ACCEPT 26721 packets, 5880K bytes)
 pkts bytes target     prot opt in     out     source               destination
  27M   31G fwmark     all  --  *      *       0.0.0.0/0            0.0.0.0/0
 
# iptables -t mangle -nvL OUTPUT
Chain OUTPUT (policy ACCEPT 6295 packets, 2828K bytes)
 pkts bytes target     prot opt in     out     source               destination
 307K   86M fwmark     all  --  *      *       0.0.0.0/0            0.0.0.0/0

# iptables -t mangle -nvL fwmark
Chain fwmark (2 references)
 pkts bytes target     prot opt in     out     source               destination
 188K   29M MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            match-set gfwip dst MARK set 0x1
 1417  157K MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            match-set gfwnet dst MARK set 0x1
</code></pre><p>启用 log
system -> logging</p><ul><li>write system log to file: /tmp/system.log</li></ul><p>通过看 FORWARD 和 POSTROUTING 的日志来判断可能是哪里有问题。</p><pre tabindex=0><code>DEST=8.8.8.8
iptables -t filter -A FORWARD -d $DEST -j LOG --log-prefix &#39;FWD:&#39;
iptables -t mangle -A POSTROUTING -d $DEST -j LOG --log-prefix &#39;POST:&#39;

DEST=10.10.8.1
iptables -t filter -D FORWARD -d $DEST -j LOG --log-prefix &#39;FWD:&#39;
iptables -t mangle -D POSTROUTING -d $DEST -j LOG --log-prefix &#39;POST:&#39;
</code></pre><p>如果只有 FORWARD 没有 POSTROUTING，那就是包被 drop 了。同时也观察包是否有正确的 src dst 和 mark。</p><h1 id=其他>其他</h1><h2 id=iptv>iptv</h2><p>network -> interfaces -> add</p><ul><li>name: iptv</li><li>protocal: dhcp</li><li>device: eth0</li><li>advanced settings<ul><li>use default geteway: 去掉选择</li></ul></li></ul><p>安装 luci-app-udpxy</p><p>services -> udpxy</p><ul><li>enabled 选上</li><li>status 选上</li><li>port 4022</li><li>source ip/interface: eth0</li><li>其他都留空</li><li>save and apply</li></ul><p>访问 http://10.10.10.1:4022/status 能看到 <code>Multicast address</code> 是 192.168.1.x 这样的 ip。可以找一个地址测试下是不是可以用吧。</p><h2 id=ddns>ddns</h2><p>安装 ddns-scripts-cloudflare ca-certificates</p><p>services -> ddns -> add</p><ul><li>hostname: x.abc.com</li><li>ddns service provider: cloudflare.com-v4</li><li>domain: <a href=mailto:x@abc.com>x@abc.com</a></li><li>username: Bearer</li><li>password: token from cloudflare</li><li>path to ca certs: /etc/ssl/certs</li><li>save</li></ul><p>点击那个 reload 可以重复执行。点击 edit 可以看 log，如果遇到 ssl 错误，可能需要安装 <code>libwolfssl4.8.1.66253b90</code>，openwrt 默认使用 <a href=https://openwrt.org/releases/21.02/notes-21.02.0-rc1#tls_and_https_support_included_by_default>wolfssl</a> 。</p><h2 id=穷人的防屏蔽措施>穷人的防屏蔽措施</h2><p>wireguard 连不上也很稀松平常，一方面 UDP 被 Qos，另外一方面就是 GFW 作怪。我在 twitter 上面无意中看到一个措施感觉还有点用。思路就是在服务器端开 N 个 wireguard 端口，客户端连接有问题的时候就换一个。</p><p>当然实际上在服务器端也不用真的开 N 个，只需要用 iptables 转发到真实的端口就行。就是类似下面这句，把其中的几个端口改改就行。</p><pre tabindex=0><code>iptables -t nat -A PREROUTING -p udp --destination-port 20011:23344 -j REDIRECT --to-ports 1234
</code></pre><p>然后在 openwrt 里面，增加一个 crontab 定期检查网络是不是通的就行。这里面几个端口可能需要改改，以及 wg 设备的名字。 crontab 项目类似这个 <code>* * * * * /etc/wg/change-wg-port.sh</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#bb60d5>LOG</span><span style=color:#666>=</span>/tmp/check_gfw.log
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>log<span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;</span><span style=color:#007020;font-weight:700>$(</span>date +%F_%T<span style=color:#007020;font-weight:700>)</span><span style=color:#4070a0> </span><span style=color:#bb60d5>$1</span><span style=color:#4070a0>&#34;</span> &gt;&gt; <span style=color:#bb60d5>$LOG</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>check_gfw<span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#bb60d5>code</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span>curl -s -o /dev/null -w <span style=color:#4070a0>&#34;%{http_code}&#34;</span> google.com<span style=color:#007020;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>[</span> <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$code</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#34;301&#34;</span> <span style=color:#666>]</span>; <span style=color:#007020;font-weight:700>then</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        log <span style=color:#4070a0>&#34;google.com is ok&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        log <span style=color:#4070a0>&#34;google.com is not ok </span><span style=color:#bb60d5>$code</span><span style=color:#4070a0>, switch port&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        switch_port
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#007020;font-weight:700>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>switch_port<span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#bb60d5>current_port</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span>uci get network.@wireguard_wg0<span style=color:#666>[</span>2<span style=color:#666>]</span>.endpoint_port<span style=color:#007020;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#bb60d5>new_port</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span>expr <span style=color:#bb60d5>$current_port</span> + 1<span style=color:#007020;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>[</span> <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$new_port</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#34;23344&#34;</span> <span style=color:#666>]</span>;<span style=color:#007020;font-weight:700>then</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>      <span style=color:#bb60d5>new_port</span><span style=color:#666>=</span><span style=color:#40a070>20011</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#007020;font-weight:700>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    log <span style=color:#4070a0>&#34;new port is </span><span style=color:#bb60d5>$new_port</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    uci <span style=color:#007020>set</span> network.@wireguard_wg0<span style=color:#666>[</span>2<span style=color:#666>]</span>.endpoint_port<span style=color:#666>=</span><span style=color:#bb60d5>$new_port</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    uci commit network
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    ifup wg0
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>check_gfw
</span></span></code></pre></div><p>这个是我的一些检查日志，8.5 断了九分钟，8.7 断了三分钟。这个因为是 1 分钟检查一次，所以可能会有点慢，但是，总归比什么都不做强。。</p><pre tabindex=0><code>2022-08-02_12:53:05 google.com is not ok 000, switch port
2022-08-05_22:24:05 google.com is not ok 000, switch port
2022-08-05_22:25:05 google.com is not ok 000, switch port
2022-08-05_22:26:05 google.com is not ok 000, switch port
2022-08-05_22:27:05 google.com is not ok 000, switch port
2022-08-05_22:28:05 google.com is not ok 000, switch port
2022-08-05_22:29:05 google.com is not ok 000, switch port
2022-08-05_22:30:05 google.com is not ok 000, switch port
2022-08-05_22:31:05 google.com is not ok 000, switch port
2022-08-05_22:32:05 google.com is not ok 000, switch port
2022-08-07_02:11:15 google.com is not ok 000, switch port
2022-08-07_02:12:05 google.com is not ok 000, switch port
2022-08-07_02:13:05 google.com is not ok 000, switch port
2022-08-07_02:14:05 google.com is not ok 000, switch port
</code></pre><h2 id=其他-1>其他</h2><ul><li>通过配置 port-foward -> router 开放 router 下面客户端的端口。例如 NAS bt 下载用的 p2p 端口。注意还需要在 router 里面也做这个映射。当然也可以直接把 nas 接到 openwrt。</li><li>如果在路由配置好之前发生了针对被污染的域名的 dns 查询，那很可能会缓存被污染的结果，目前没想到什么好办法。不过好在一般等 dns 过期之后就正常了。</li></ul><h2 id=todo>TODO</h2><ul><li>ipv6 支持：因为这个方案目前不支持 ipv6，所以如果有 app 优先使用 ipv6 查询的话，那么返回的 ipv6 地址是不会走 wg 的，这个时候就会出现不能用。解决方法就是关闭这个设备的 ipv6，或者直接关闭 openwrt 的 ipv6 支持。</li></ul></content><div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//wdicc.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>