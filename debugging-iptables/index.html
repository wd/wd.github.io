<!doctype html><html lang=en><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://wdicc.com/favicon.ico><title>Debugging Iptables | wd and cc</title><meta name=title content="Debugging Iptables"><meta name=description content="
iptables 是个很有用的工具。可以可以方便的操纵包的走向，作为 ops 不可避免的需要了解如何 debug 一些问题。

首先肯定是需要对 iptables 的包在各个 table 和 chain 的走向需要有了解。这个随便一搜就有很多的图片，不过各个图可能还是有些许差别，另外有些理解起来没那么好懂。不过想要了解 iptables 还是需要硬着头皮去看看。"><meta name=keywords content="iptables,debugging,"><meta property="og:url" content="https://wdicc.com/debugging-iptables/"><meta property="og:site_name" content="wd and cc"><meta property="og:title" content="Debugging Iptables"><meta property="og:description" content="iptables 是个很有用的工具。可以可以方便的操纵包的走向，作为 ops 不可避免的需要了解如何 debug 一些问题。
首先肯定是需要对 iptables 的包在各个 table 和 chain 的走向需要有了解。这个随便一搜就有很多的图片，不过各个图可能还是有些许差别，另外有些理解起来没那么好懂。不过想要了解 iptables 还是需要硬着头皮去看看。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-15T14:30:46+08:00"><meta property="article:modified_time" content="2022-04-15T14:30:46+08:00"><meta property="article:tag" content="Iptables"><meta property="article:tag" content="Debugging"><meta name=twitter:card content="summary"><meta name=twitter:title content="Debugging Iptables"><meta name=twitter:description content="iptables 是个很有用的工具。可以可以方便的操纵包的走向，作为 ops 不可避免的需要了解如何 debug 一些问题。
首先肯定是需要对 iptables 的包在各个 table 和 chain 的走向需要有了解。这个随便一搜就有很多的图片，不过各个图可能还是有些许差别，另外有些理解起来没那么好懂。不过想要了解 iptables 还是需要硬着头皮去看看。"><meta itemprop=name content="Debugging Iptables"><meta itemprop=description content="iptables 是个很有用的工具。可以可以方便的操纵包的走向，作为 ops 不可避免的需要了解如何 debug 一些问题。
首先肯定是需要对 iptables 的包在各个 table 和 chain 的走向需要有了解。这个随便一搜就有很多的图片，不过各个图可能还是有些许差别，另外有些理解起来没那么好懂。不过想要了解 iptables 还是需要硬着头皮去看看。"><meta itemprop=datePublished content="2022-04-15T14:30:46+08:00"><meta itemprop=dateModified content="2022-04-15T14:30:46+08:00"><meta itemprop=wordCount content="887"><meta itemprop=keywords content="Iptables,Debugging"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--code-background-color:#f2f2f2;--code-color:#222;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--code-background-color:#000;--code-color:#ddd;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px}blockquote{border-left:1px solid #999;color:var(--code-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto !important}.highlight,.code{padding:1px 15px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>wd and cc</h2></a><p>-- Good good study, day day up!</p><nav><a href=/>Home</a>
<a href=/posts/>Posts</a>
<a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a>
<a href=/tags/>Tags</a>
<a href=/atom.xml>subscribe</a></nav></header><main><h1>Debugging Iptables</h1><p><i><time datetime=2022-04-15>15 Apr, 2022
</time></i><a href=https://wdicc.com/tags/iptables/>#Iptables</a>
<a href=https://wdicc.com/tags/debugging/>#Debugging</a></p><content><p>iptables 是个很有用的工具。可以可以方便的操纵包的走向，作为 ops 不可避免的需要了解如何 debug 一些问题。</p><p>首先肯定是需要对 iptables 的包在各个 table 和 chain 的走向需要有了解。这个随便一搜就有很多的图片，不过各个图可能还是有些许差别，另外有些理解起来没那么好懂。不过想要了解 iptables 还是需要硬着头皮去看看。</p><p><a href=img:https://stuffphilwrites.com/wp-content/uploads/2014/09/FW-IDS-iptables-Flowchart-v2019-04-30-1.png>img:https://stuffphilwrites.com/wp-content/uploads/2014/09/FW-IDS-iptables-Flowchart-v2019-04-30-1.png</a></p><p>对于理解这些图，有一些 tips。</p><ol><li>iptables 有几个 table：raw，mangle，nat，filter，加上几个默认的 chain：PREROUTING，FORWARD，INPUT，OUTPUT，POSTROUTING。</li><li>各种图里面一般都是这几个东西的笛卡尔积，当然有的组合可能不存在，但是大致是这个意思。</li><li>一个 host 一般会有很多个网卡，简单区分开这些网卡为 lo 和其他。lo 的流量就是图里面 localhost 相关的。其他网卡的，就是都是外部的流量。例如 docker 会创建一些网卡，那么 docker container 里面的流量进入系统的时候也是外部流量。</li><li>所以并不是只有通过外网网卡进入的才是外部流量，即使本机也可以产生这样的流量。</li></ol><p>这样就非常好理解了。一个 docker container 里面，需要访问外网的时候，可能需要经过如下的路径：container 内部自己的网卡，host 上面对应的网桥网卡，host 的外网网卡。这个过程里面，进入 host 上面对应的网桥网卡的时候就需要进入 host 的 raw PREROUTING 这个 chain 了。</p><p>需要 debug 一个规则的匹配情况的时候，可以在那条规则前面增加一条规则，使用 <code class=verbatim>-J log --log-prefix xx</code> 会把匹配情况记录到日志，一般是会记录的 syslog 里面。</p><p>如果需要追踪一个包的整体流向的时候，可以在 raw PREROUTING chain 增加一条 <code class=verbatim>-J trace</code> 的记录。这个会记录所有进入系统的包到 syslog 里面。要注意这个记录会非常多。</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Feb  7 12:13:39 Host1 kernel: [4319670.459630] TRACE: filter:cali-pro-kns.sandbox:rule:1 IN=cali289ea3d6da9 OUT=ens5 MAC=ee:ee:ee:ee:ee:ee:a2:3a:07:e5:58:f3:08:00 SRC=10.42.87.16 DST=142.250.190.78 LEN=60 TOS=0x00 PREC=0x00 TTL=63 ID=17395 DF PROTO=TCP SPT=36738 DPT=80 SEQ=1138025950 ACK=0 WINDOW=35764 RES=0x00 SYN URGP=0 OPT (020422ED0402080AFCAC930C0000000001030309)</span></span></code></pre></div></div><p>日志大概如上面，会记录经过的 table（filter）chain（cali-pro-kns.sandbox）和 rule（1 表示是第一条 rule）。IN 和 OUT 分别表示出入的网卡。OUT 一般是在经过 nat 表之后才会有。其他的就不多说了，有一个比较重要的 ID 需要注意，这个可以标记一个包。所以如果想看一个包的情况，可以根据 id 过滤下。把这些数据按照顺序整理到表格里面的话，就会更加清晰了。</p><p>我为了分析 iptables 的规则，还写了一个小工具 <a href=https://github.com/wd/iptables-parser.>https://github.com/wd/iptables-parser.</a></p></content></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>