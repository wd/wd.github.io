<!doctype html><html lang=en><head><title>Debugging Iptables &ndash; wd and cc</title>
<meta name=description content="Good good study, day day up!"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://wdicc.com/css/palettes/base16-dark.css><link rel=stylesheet href=https://wdicc.com/css/risotto.css><link rel=stylesheet href=https://wdicc.com/css/custom.css><link rel=icon href=https://wdicc.com/favicon.ico></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><h1 class=page__logo><a href=https://wdicc.com/ class=page__logo-inner>wd and cc</a></h1><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/posts/ title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=" title>Search</a></li><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/atom.xml title>subscribe</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Debugging Iptables</h1></header><div class=content__body><p>iptables 是个很有用的工具。可以可以方便的操纵包的走向，作为 ops 不可避免的需要了解如何 debug 一些问题。</p><p>首先肯定是需要对 iptables 的包在各个 table 和 chain 的走向需要有了解。这个随便一搜就有很多的图片，不过各个图可能还是有些许差别，另外有些理解起来没那么好懂。不过想要了解 iptables 还是需要硬着头皮去看看。</p><p><a href=img:https://stuffphilwrites.com/wp-content/uploads/2014/09/FW-IDS-iptables-Flowchart-v2019-04-30-1.png>img:https://stuffphilwrites.com/wp-content/uploads/2014/09/FW-IDS-iptables-Flowchart-v2019-04-30-1.png</a></p><p>对于理解这些图，有一些 tips。</p><ol><li>iptables 有几个 table：raw，mangle，nat，filter，加上几个默认的 chain：PREROUTING，FORWARD，INPUT，OUTPUT，POSTROUTING。</li><li>各种图里面一般都是这几个东西的笛卡尔积，当然有的组合可能不存在，但是大致是这个意思。</li><li>一个 host 一般会有很多个网卡，简单区分开这些网卡为 lo 和其他。lo 的流量就是图里面 localhost 相关的。其他网卡的，就是都是外部的流量。例如 docker 会创建一些网卡，那么 docker container 里面的流量进入系统的时候也是外部流量。</li><li>所以并不是只有通过外网网卡进入的才是外部流量，即使本机也可以产生这样的流量。</li></ol><p>这样就非常好理解了。一个 docker container 里面，需要访问外网的时候，可能需要经过如下的路径：container 内部自己的网卡，host 上面对应的网桥网卡，host 的外网网卡。这个过程里面，进入 host 上面对应的网桥网卡的时候就需要进入 host 的 raw PREROUTING 这个 chain 了。</p><p>需要 debug 一个规则的匹配情况的时候，可以在那条规则前面增加一条规则，使用 <code class=verbatim>-J log --log-prefix xx</code> 会把匹配情况记录到日志，一般是会记录的 syslog 里面。</p><p>如果需要追踪一个包的整体流向的时候，可以在 raw PREROUTING chain 增加一条 <code class=verbatim>-J trace</code> 的记录。这个会记录所有进入系统的包到 syslog 里面。要注意这个记录会非常多。</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Feb  7 12:13:39 Host1 kernel: [4319670.459630] TRACE: filter:cali-pro-kns.sandbox:rule:1 IN=cali289ea3d6da9 OUT=ens5 MAC=ee:ee:ee:ee:ee:ee:a2:3a:07:e5:58:f3:08:00 SRC=10.42.87.16 DST=142.250.190.78 LEN=60 TOS=0x00 PREC=0x00 TTL=63 ID=17395 DF PROTO=TCP SPT=36738 DPT=80 SEQ=1138025950 ACK=0 WINDOW=35764 RES=0x00 SYN URGP=0 OPT (020422ED0402080AFCAC930C0000000001030309)</span></span></code></pre></div></div><p>日志大概如上面，会记录经过的 table（filter）chain（cali-pro-kns.sandbox）和 rule（1 表示是第一条 rule）。IN 和 OUT 分别表示出入的网卡。OUT 一般是在经过 nat 表之后才会有。其他的就不多说了，有一个比较重要的 ID 需要注意，这个可以标记一个包。所以如果想看一个包的情况，可以根据 id 过滤下。把这些数据按照顺序整理到表格里面的话，就会更加清晰了。</p><p>我为了分析 iptables 的规则，还写了一个小工具 <a href=https://github.com/wd/iptables-parser.>https://github.com/wd/iptables-parser.</a></p></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://wdicc.com/favicon.ico alt=Logo><h1 class=about__title>Happy every day!</h1><p class=about__description>Good good study, day day up!</p></div><ul class=aside__social-links><li><a href=https://github.com/wd rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2022-04-15</p></div></section><footer class=page__footer><p><br><span class=active>$ echo $LANG<br><b>zh_CN</b></span><br></p><br><br><p class=copyright>wd © 2025</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>