<!doctype html><html lang=en><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://wdicc.com/favicon.ico><title>Istio Multi Cluster | wd and cc</title><meta name=title content="Istio Multi Cluster"><meta name=description content="istio 对于多集群的支持方式有很多不同的方式。取决于组网模式，controlplane 模式。可以参考这篇文章理解具体不同。

single or multiple cluster
single or multiple network
single or multiple control plane
single or multiple mesh

网络模式，主要是关注集群之间是否可以直接连接。主要是指多个集群之间的 pod 是否可以直接互相访问。这主要是考虑是否用了 VPC-cni。例如 EKS 里面使用 vpc-cni 之后 pod 获取的 ip 和节点获取的 ip 是同一个子网的。只要是在一个互相做了连接的 vpc 中就可以互相访问。
如果集群间 pod 可以互联，那就是 single network。如果不能互联，那就是 multiple network。"><meta name=keywords content="istio,multi-cluster,"><meta property="og:url" content="https://wdicc.com/istio-multi-cluster/"><meta property="og:site_name" content="wd and cc"><meta property="og:title" content="Istio Multi Cluster"><meta property="og:description" content="istio 对于多集群的支持方式有很多不同的方式。取决于组网模式，controlplane 模式。可以参考这篇文章理解具体不同。
single or multiple cluster single or multiple network single or multiple control plane single or multiple mesh 网络模式，主要是关注集群之间是否可以直接连接。主要是指多个集群之间的 pod 是否可以直接互相访问。这主要是考虑是否用了 VPC-cni。例如 EKS 里面使用 vpc-cni 之后 pod 获取的 ip 和节点获取的 ip 是同一个子网的。只要是在一个互相做了连接的 vpc 中就可以互相访问。 如果集群间 pod 可以互联，那就是 single network。如果不能互联，那就是 multiple network。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-07T18:39:44-07:00"><meta property="article:modified_time" content="2025-08-07T18:39:44-07:00"><meta property="article:tag" content="Istio"><meta property="article:tag" content="Multi-Cluster"><meta name=twitter:card content="summary"><meta name=twitter:title content="Istio Multi Cluster"><meta name=twitter:description content="istio 对于多集群的支持方式有很多不同的方式。取决于组网模式，controlplane 模式。可以参考这篇文章理解具体不同。
single or multiple cluster single or multiple network single or multiple control plane single or multiple mesh 网络模式，主要是关注集群之间是否可以直接连接。主要是指多个集群之间的 pod 是否可以直接互相访问。这主要是考虑是否用了 VPC-cni。例如 EKS 里面使用 vpc-cni 之后 pod 获取的 ip 和节点获取的 ip 是同一个子网的。只要是在一个互相做了连接的 vpc 中就可以互相访问。 如果集群间 pod 可以互联，那就是 single network。如果不能互联，那就是 multiple network。"><meta itemprop=name content="Istio Multi Cluster"><meta itemprop=description content="istio 对于多集群的支持方式有很多不同的方式。取决于组网模式，controlplane 模式。可以参考这篇文章理解具体不同。
single or multiple cluster single or multiple network single or multiple control plane single or multiple mesh 网络模式，主要是关注集群之间是否可以直接连接。主要是指多个集群之间的 pod 是否可以直接互相访问。这主要是考虑是否用了 VPC-cni。例如 EKS 里面使用 vpc-cni 之后 pod 获取的 ip 和节点获取的 ip 是同一个子网的。只要是在一个互相做了连接的 vpc 中就可以互相访问。 如果集群间 pod 可以互联，那就是 single network。如果不能互联，那就是 multiple network。"><meta itemprop=datePublished content="2025-08-07T18:39:44-07:00"><meta itemprop=dateModified content="2025-08-07T18:39:44-07:00"><meta itemprop=wordCount content="1196"><meta itemprop=keywords content="Istio,Multi-Cluster"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--code-background-color:#f2f2f2;--code-color:#222;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--code-background-color:#000;--code-color:#ddd;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px}blockquote{border-left:1px solid #999;color:var(--code-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{padding:1px 15px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>wd and cc</h2></a><p>-- Good good study, day day up!</p><nav><a href=/>Home</a>
<a href=/posts/>Posts</a>
<a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a>
<a href=/tags/>Tags</a>
<a href=/atom.xml>subscribe</a></nav></header><main><h1>Istio Multi Cluster</h1><p><i><time datetime=2025-08-07>07 Aug, 2025
</time></i><a href=https://wdicc.com/tags/istio/>#Istio</a>
<a href=https://wdicc.com/tags/multi-cluster/>#Multi-Cluster</a></p><content><p>istio 对于多集群的支持方式有很多不同的方式。取决于组网模式，controlplane 模式。可以参考<a href=https://istio.io/latest/docs/ops/deployment/deployment-models/#network-models>这篇文章</a>理解具体不同。</p><ul><li>single or multiple cluster</li><li>single or multiple network</li><li>single or multiple control plane</li><li>single or multiple mesh</li></ul><p>网络模式，主要是关注集群之间是否可以直接连接。主要是指多个集群之间的 pod 是否可以直接互相访问。这主要是考虑是否用了 VPC-cni。例如 EKS 里面使用 vpc-cni 之后 pod 获取的 ip 和节点获取的 ip 是同一个子网的。只要是在一个互相做了连接的 vpc 中就可以互相访问。
如果集群间 pod 可以互联，那就是 single network。如果不能互联，那就是 multiple network。</p><p>我感觉在这个大的 mesh 里面，比较重要的主要是两个问题</p><ul><li>pod 网络如何互通：因为 mesh 直接的互相请求需要 pod 之间能互通才可以。</li><li>如何做 service discovery: mesh 中的所有服务都应该能被任何其他服务发现。这个不止是知道那个服务的名字，还涉及到针对那个服务的配置，什么的得需要也能下发到请求方的 istio proxy 配置里面。</li></ul><p>然后 network + mesh 可以搭配出来几种情况。</p><ul><li>single network + single mesh: 这个估计是大部分人的起步配置，一个集群一个 mesh。</li><li>single network + multiple mesh：同一个 network 其实并不一定是相同的 vpc，可以想象如果两个 vpc 通过某种方式连接起来（例如 aws vpc peering）之后，他们两个 network 中的 ip 间是可以互相访问的。所以连接之后的多 vpc 实际上也适用这个情况。当然有的 CNI 分配的 pod 的 ip 实际上并不能和外部的网络互通，那这样的情况下，也得看成是 multiple network 的情况。</li><li>multiple network + single mesh: 这似乎是一种不可能存在。</li><li>multiple network + multiple mesh: 这个是非常常见的一种情况。</li></ul><p>在 multiple network 的情况下，pod 之间需要找到方法互通。其中一种方法就是通过 istio gateway。请求发送给对方 network 中的 istio gateway，然后再转发给对应的 pod。当然很明显通过其他的 ingress 理论上也能做到。 想要做 service discovery，还需要各自的 istiod 能连接到对方的 controlplane。这个可以通过使用 ingress 来 expose 这个 controlplane。</p><p>当具备上面的条件之后，参考文档给 istiod pilot 做配置就可以了。其中有一个步骤是需要更新 ca 证书，这个是为了能让 mTLS 能在两个集群中继续发挥作用的。</p><p>但是实际上还有一个潜在的 dns 问题。当一个 service 在两个集群都存在的时候，istio 会自动 merge 两个集群的 pod，并且还能自动通过 gateway 把请求转发到另外一个集群（当然我们肯定会配置 location aware 的配置，本集群的请求只发本集群，只有在本集群的服务不可用的时候才发送到另外集群）。当一个 service 只在一个集群里面存在的时候，可以看到另外集群的 istio proxy 的配置里面是包含这个 service 的，但是给这个 service 发送请求会失败。这是因为另外那个集群就不存在这个 service 的 dns，那个集群的服务给这个 service 发请求的时候，第一步 dns 解析就会失败。</p><p>解决这个 dns 问题有几个办法，例如不做 dns 解析，随意发送给一个任意 ip。istio proxy 会根据你请求的 dns 自动路由给正确的 pod ip。</p><p>也可以使用 annotation 来让 istio proxy 来 capture dns 请求，这样 istio proxy 就能够返回一个虚拟的 ip，然后后续把请求路由到正确的 pod。</p><p>技术方面的解释差不多就这些了。理解了这些之后遇到问题就会比较清楚应该怎么去 debug 了。</p></content><div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//wdicc.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>