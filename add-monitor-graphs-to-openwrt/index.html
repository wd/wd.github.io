<!doctype html><html lang=zh-CN><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Add Monitor Graphs to Openwrt | wd and cc</title>
<link rel=canonical href=https://wdicc.com/add-monitor-graphs-to-openwrt/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://wdicc.com/add-monitor-graphs-to-openwrt/"><meta property="og:site_name" content="wd and cc"><meta property="og:title" content="Add Monitor Graphs to Openwrt"><meta property="og:description" content="According to the docs here https://openwrt.org/docs/guide-user/luci/luci_app_statistics, OpenWrt supports us using the Collectd to collect metrics and the Rrdtool draw the graph later.
Install opkg update opkg install luci-app-statistics We can run the command opkg list | grep collectd-mod to see what mertics we can collect. I have installed these modules"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-11T19:38:12+08:00"><meta property="article:modified_time" content="2021-12-11T19:38:12+08:00"><meta property="article:tag" content="Openwrt"><meta property="article:tag" content="Graph"><meta name=twitter:card content="summary"><meta name=twitter:title content="Add Monitor Graphs to Openwrt"><meta name=twitter:description content="According to the docs here https://openwrt.org/docs/guide-user/luci/luci_app_statistics, OpenWrt supports us using the Collectd to collect metrics and the Rrdtool draw the graph later.
Install opkg update opkg install luci-app-statistics We can run the command opkg list | grep collectd-mod to see what mertics we can collect. I have installed these modules"><link rel=stylesheet href=https://wdicc.com/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><link rel=stylesheet href=https://wdicc.com/wdicc.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://wdicc.com/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://wdicc.com/dns-request-in-alpine-image/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=https://wdicc.com/expand-yourself/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&text=Add%20Monitor%20Graphs%20to%20Openwrt" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&title=Add%20Monitor%20Graphs%20to%20Openwrt" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&is_video=false&description=Add%20Monitor%20Graphs%20to%20Openwrt" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Add%20Monitor%20Graphs%20to%20Openwrt&body=Check out this article: https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&title=Add%20Monitor%20Graphs%20to%20Openwrt" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&title=Add%20Monitor%20Graphs%20to%20Openwrt" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&name=Add%20Monitor%20Graphs%20to%20Openwrt&description=%3cp%3e%0aAccording%20to%20the%20docs%20here%20%3ca%20href%3d%22https%3a%2f%2fopenwrt.org%2fdocs%2fguide-user%2fluci%2fluci_app_statistics%2c%22%3ehttps%3a%2f%2fopenwrt.org%2fdocs%2fguide-user%2fluci%2fluci_app_statistics%2c%3c%2fa%3e%20OpenWrt%20supports%20us%20using%20the%20Collectd%20to%20collect%20metrics%20and%20the%20Rrdtool%20draw%20the%20graph%20later.%3c%2fp%3e%0a%3cdiv%20id%3d%22outline-container-headline-1%22%20class%3d%22outline-3%22%3e%0a%3ch3%20id%3d%22headline-1%22%3e%0aInstall%0a%3c%2fh3%3e%0a%3cdiv%20id%3d%22outline-text-headline-1%22%20class%3d%22outline-text-3%22%3e%0a%3cdiv%20class%3d%22src%20src-text%22%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-text%22%20data-lang%3d%22text%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3eopkg%20update%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3eopkg%20install%20luci-app-statistics%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%0a%3c%2fdiv%3e%0a%3cp%3e%0aWe%20can%20run%20the%20command%20%3ccode%20class%3d%22verbatim%22%3eopkg%20list%20%7c%20grep%20collectd-mod%3c%2fcode%3e%20to%20see%20what%20mertics%20we%20can%20collect.%20I%20have%20installed%20these%20modules%3c%2fp%3e" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&t=Add%20Monitor%20Graphs%20to%20Openwrt" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Add Monitor Graphs to Openwrt</h1><div class=meta><span class=author itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>wd and cc</span></span><div class=postdate><time datetime="2021-12-11 19:38:12 +0800 +0800" itemprop=datePublished>2021-12-11</time></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/openwrt rel=tag>openwrt</a>
,
<a class=tag-link href=/tags/graph rel=tag>graph</a></div></div></header><div id=toc><nav id=TableOfContents><ul><li><a href=#headline-1>Install</a></li><li><a href=#headline-2>Create a script for the exec plugin</a><ul><li><a href=#headline-3>Create a cron job to collect the data</a></li><li><a href=#headline-4>Create the file script for the exec plugin</a></li><li><a href=#headline-5>Add graph to the OpenWrt graph page</a></li></ul></li><li><a href=#headline-6>Refs</a></li></ul></nav></div><div class=content itemprop=articleBody><p>According to the docs here <a href=https://openwrt.org/docs/guide-user/luci/luci_app_statistics,>https://openwrt.org/docs/guide-user/luci/luci_app_statistics,</a> OpenWrt supports us using the Collectd to collect metrics and the Rrdtool draw the graph later.</p><div id=outline-container-headline-1 class=outline-3><h3 id=headline-1>Install</h3><div id=outline-text-headline-1 class=outline-text-3><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>opkg update
</span></span><span style=display:flex><span>opkg install luci-app-statistics</span></span></code></pre></div></div><p>We can run the command <code class=verbatim>opkg list | grep collectd-mod</code> to see what mertics we can collect. I have installed these modules</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>collectd-mod-cpu
</span></span><span style=display:flex><span>collectd-mod-curl
</span></span><span style=display:flex><span>collectd-mod-dns
</span></span><span style=display:flex><span>collectd-mod-exec
</span></span><span style=display:flex><span>collectd-mod-interface
</span></span><span style=display:flex><span>collectd-mod-iwinfo
</span></span><span style=display:flex><span>collectd-mod-load
</span></span><span style=display:flex><span>collectd-mod-memory
</span></span><span style=display:flex><span>collectd-mod-network
</span></span><span style=display:flex><span>collectd-mod-ping
</span></span><span style=display:flex><span>collectd-mod-rrdtool
</span></span><span style=display:flex><span>collectd-mod-thermal</span></span></code></pre></div></div><p>Most of the plugins work out of the box, such as the <code class=verbatim>cpu</code> one. And some of them need some configurations on the UI, such as the <code class=verbatim>curl</code> one. You have to tell the plugin the URL you want to monitor.</p><p>The <code class=verbatim>exec</code> plugin is a special one. It needs you to write some codes to get it work.</p></div></div><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>Create a script for the exec plugin</h3><div id=outline-text-headline-2 class=outline-text-3><p>On the UI settings page of the <code class=verbatim>exec</code> plugin, we can set several scripts path for that plugin to execute. We have to create the scripts by ourselves.</p><p>For example, I will create a graph for the last handshake time of the Wireguard VPN. The command and the output for getting the last handshake time are below.</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>wg show all latest-handshakes
</span></span><span style=display:flex><span>wg0     L8yns9ycPwd5/gxIm02zGifWfnMCg5f0hGqdya8pAxg=    0
</span></span><span style=display:flex><span>wg0     7fR3QgAwgW/jMKWNtrnrXlxYxXc0mQA1YVv0VMz+dSg=    1639203670
</span></span><span style=display:flex><span>wg0     cgCozSFbCG6SvENpITD5n6SF9vWyYO0J6jOuziy3tyU=    1639282576
</span></span><span style=display:flex><span>wg1     wFyXEweIGqzB3Keg/bBmxGfBcKpp222/YMyNwvjRgiQ=    1639282486</span></span></code></pre></div></div><ul><li><code class=verbatim>wg0</code> is the device name</li><li><code class=verbatim>L8yns9ycPwd5/gxIm02zGifWfnMCg5f0hGqdya8pAxg</code> is the public key.</li><li><code class=verbatim>1639282486</code> is the timestamp when the last handshake happened.</li></ul><p>The command needs the root permission to execute. However, the <code class=verbatim>exec</code> plugin can be running as root. So we have to take a detour. There are three pieces of work to do.</p><div id=outline-container-headline-3 class=outline-4><h4 id=headline-3>Create a cron job to collect the data</h4><div id=outline-text-headline-3 class=outline-text-4><p>To run the command with the root permission, we must create this script first, which will collect the data and write the data to <code class=verbatim>/tmp</code> folder.</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>mkdir /etc/wg</span></span></code></pre></div></div><div class="src src-bash"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>output<span style=color:#f92672>=</span>/tmp/wg.collect
</span></span><span style=display:flex><span>rm -f $output <span style=color:#f92672>&amp;&amp;</span> touch $output <span style=color:#f92672>&amp;&amp;</span> chmod <span style=color:#ae81ff>666</span> $output
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>current<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%s<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>conf<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cgCozSFbCG6SvENpITD5n6SF9vWyYO0J6jOuziy3tyU= wg0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>wFyXEweIGqzB3Keg/bBmxGfBcKpp222/YMyNwvjRgiQ= wg1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wg show all latest-handshakes | <span style=color:#66d9ef>while</span> read line; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        device<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $line | awk -F <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#e6db74>&#39;{print $1}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        peer<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $line | awk -F <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        dt<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $line | awk -F <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#e6db74>&#39;{print $3}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        name<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$conf<span style=color:#e6db74>&#34;</span> | grep <span style=color:#e6db74>&#34;</span>$peer<span style=color:#e6db74>&#34;</span> | awk -F <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$dt<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>||</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$name<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        diff<span style=color:#f92672>=</span><span style=color:#66d9ef>$((</span>$current <span style=color:#f92672>-</span> $dt<span style=color:#66d9ef>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;PUTVAL \&#34;HOSTNAME/exec-wireguard/gauge-last_handshake_</span>$name<span style=color:#e6db74>\&#34; interval=INTERVAL N:</span>$diff<span style=color:#e6db74>&#34;</span> &gt;&gt; $output
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span></span></span></code></pre></div></div><p>The script will write the outputs to the <code class=verbatim>/tmp/wg.collect</code> file. You may want to change the conf settings. It will help us filter which peer we want to monitor and the alias for that peer.</p><p>The output is defined here <code class=verbatim>"PUTVAL \"HOSTNAME/exec-wireguard/gauge-last_handshake_$name\" interval=INTERVAL N:$diff"</code>. The output format is critical.</p><ul><li>First of all, the <code class=verbatim>HOSTNAME</code> and <code class=verbatim>INTERVAL</code> are placeholders. They will be replaced with the correct value later.</li><li>For the <code class=verbatim>exec-wireguard</code>, <code class=verbatim>exec</code> is the plugin name, the <code class=verbatim>wireguard</code> is the plugin instance name.</li><li>For the <code class=verbatim>gauge-last_handshake_$name</code>, <code class=verbatim>gauge</code> is the metric type. It must be inclued in the <code class=verbatim>/usr/share/collectd/types.db</code> file. You also can use one of the existed type from there. <code class=verbatim>last_handshake_$name</code> is the metric name.</li></ul><p>Add the script to the <code class=verbatim>system -> Scheduled Tasks</code>. <code class=verbatim>* * * * * /etc/wg/wg.sh</code>.</p><p>Check whether the file <code class=verbatim>/tmp/wg.collect</code> has been created and updated after adding it to the crontab.</p></div></div><div id=outline-container-headline-4 class=outline-4><h4 id=headline-4>Create the file script for the exec plugin</h4><div id=outline-text-headline-4 class=outline-text-4><p>Create a file <code class=verbatim>/etc/wg/exec-wg.sh</code></p><div class="src src-bash"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>HOSTNAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>COLLECTD_HOSTNAME<span style=color:#66d9ef>:-</span>Tux<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>INTERVAL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>COLLECTD_INTERVAL<span style=color:#66d9ef>:-</span>60<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>INTERVAL<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>awk -v i<span style=color:#f92672>=</span>$INTERVAL <span style=color:#e6db74>&#39;BEGIN{print int(i)}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>input<span style=color:#f92672>=</span>/tmp/wg.collect
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> sleep <span style=color:#e6db74>&#34;</span>$INTERVAL<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        cat $input | sed <span style=color:#e6db74>&#34;s/HOSTNAME/</span>$HOSTNAME<span style=color:#e6db74>/g&#34;</span> | sed <span style=color:#e6db74>&#34;s/INTERVAL/</span>$INTERVAL<span style=color:#e6db74>/g&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span></span></span></code></pre></div></div><p>This script will run and loop forever, read and print the file content. There is nothing special here.</p><p>After adding the file to the exec plugin settings UI, run these commands to check if it works.</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># ps |grep exec-wg
</span></span><span style=display:flex><span> 4001 nobody    1088 SN   /bin/sh /etc/wg/exec-wg.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># ls &lt;path-to-rrd-data-directory&gt;/exec-wireguard/
</span></span><span style=display:flex><span>gauge-last_handshake_wg0.rrd  gauge-last_handshake_wg1.rrd</span></span></code></pre></div></div></div></div><div id=outline-container-headline-5 class=outline-4><h4 id=headline-5>Add graph to the OpenWrt graph page</h4><div id=outline-text-headline-5 class=outline-text-4><p>Create the file <code class=verbatim>/www/luci-static/resources/statistics/rrdtool/definitions/exec.js</code> as bellow.</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;require baseclass&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> <span style=color:#a6e22e>baseclass</span>.<span style=color:#a6e22e>extend</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>_</span>(<span style=color:#e6db74>&#39;Exec&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rrdargs</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>graph</span>, <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>plugin</span>, <span style=color:#a6e22e>plugin_instance</span>, <span style=color:#a6e22e>dtype</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// host: Tux
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// plugin: exec
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// plugin_instance: wireguard
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// dtype: null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wireguard_last_handshake_time</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;%H: wireguard last handshake time&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vlabel</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;seconds&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>alt_autoscale_max</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>types</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;gauge&#34;</span>],
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>options</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>gauge_last_handshake_wg0</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>color</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ff0000&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// noavg: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#a6e22e>noarea</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// overlay: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// flip: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;wg0&#34;</span>
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>gauge_last_handshake_wg1</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>color</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;0000ff&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// noavg: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#a6e22e>noarea</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;wg1&#34;</span>
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>wireguard_last_handshake_time</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div><p>The important thing in the file</p><ul><li><code class=verbatim>title: _('Exec'),</code>: define the graph title.</li><li><code class=verbatim>types: ["gauge"],</code>: define the source data type.</li><li><code class=verbatim>gauge_last_handshake_wg0</code> and <code class=verbatim>gauge_last_handshake_wg1</code>: this is optional. I want to rename the metrics name and set the color for the graph. Please notice the <code class=verbatim>_</code> after the <code class=verbatim>gauge</code> is very important. Don't use <code class=verbatim>-</code> here.</li></ul></div></div></div></div><div id=outline-container-headline-6 class=outline-3><h3 id=headline-6>Refs</h3><div id=outline-text-headline-6 class=outline-text-3><ul><li><a href=https://gist.github.com/squarewf/82a9535b6aae64430991f4e56f2513a9>https://gist.github.com/squarewf/82a9535b6aae64430991f4e56f2513a9</a></li><li><a href=http://flux242.blogspot.com/2011/01/collectd-mod-exec-part-5.html>http://flux242.blogspot.com/2011/01/collectd-mod-exec-part-5.html</a></li></ul></div></div></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&text=Add%20Monitor%20Graphs%20to%20Openwrt" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&title=Add%20Monitor%20Graphs%20to%20Openwrt" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&is_video=false&description=Add%20Monitor%20Graphs%20to%20Openwrt" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Add%20Monitor%20Graphs%20to%20Openwrt&body=Check out this article: https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&title=Add%20Monitor%20Graphs%20to%20Openwrt" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&title=Add%20Monitor%20Graphs%20to%20Openwrt" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&name=Add%20Monitor%20Graphs%20to%20Openwrt&description=%3cp%3e%0aAccording%20to%20the%20docs%20here%20%3ca%20href%3d%22https%3a%2f%2fopenwrt.org%2fdocs%2fguide-user%2fluci%2fluci_app_statistics%2c%22%3ehttps%3a%2f%2fopenwrt.org%2fdocs%2fguide-user%2fluci%2fluci_app_statistics%2c%3c%2fa%3e%20OpenWrt%20supports%20us%20using%20the%20Collectd%20to%20collect%20metrics%20and%20the%20Rrdtool%20draw%20the%20graph%20later.%3c%2fp%3e%0a%3cdiv%20id%3d%22outline-container-headline-1%22%20class%3d%22outline-3%22%3e%0a%3ch3%20id%3d%22headline-1%22%3e%0aInstall%0a%3c%2fh3%3e%0a%3cdiv%20id%3d%22outline-text-headline-1%22%20class%3d%22outline-text-3%22%3e%0a%3cdiv%20class%3d%22src%20src-text%22%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-text%22%20data-lang%3d%22text%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3eopkg%20update%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3eopkg%20install%20luci-app-statistics%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%0a%3c%2fdiv%3e%0a%3cp%3e%0aWe%20can%20run%20the%20command%20%3ccode%20class%3d%22verbatim%22%3eopkg%20list%20%7c%20grep%20collectd-mod%3c%2fcode%3e%20to%20see%20what%20mertics%20we%20can%20collect.%20I%20have%20installed%20these%20modules%3c%2fp%3e" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwdicc.com%2fadd-monitor-graphs-to-openwrt%2f&t=Add%20Monitor%20Graphs%20to%20Openwrt" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2025 wd and cc</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>