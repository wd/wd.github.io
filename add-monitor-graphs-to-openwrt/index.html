<!doctype html><html lang=en><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://wdicc.com/favicon.ico><title>Add Monitor Graphs to Openwrt | wd and cc</title><meta name=title content="Add Monitor Graphs to Openwrt"><meta name=description content="
According to the docs here https://openwrt.org/docs/guide-user/luci/luci_app_statistics, OpenWrt supports us using the Collectd to collect metrics and the Rrdtool draw the graph later.


Install



1opkg update
2opkg install luci-app-statistics


We can run the command opkg list | grep collectd-mod to see what mertics we can collect. I have installed these modules

 1collectd-mod-cpu
 2collectd-mod-curl
 3collectd-mod-dns
 4collectd-mod-exec
 5collectd-mod-interface
 6collectd-mod-iwinfo
 7collectd-mod-load
 8collectd-mod-memory
 9collectd-mod-network
10collectd-mod-ping
11collectd-mod-rrdtool
12collectd-mod-thermal


Most of the plugins work out of the box, such as the cpu one. And some of them need some configurations on the UI, such as the curl one. You have to tell the plugin the URL you want to monitor."><meta name=keywords content="openwrt,graph,"><meta property="og:url" content="https://wdicc.com/add-monitor-graphs-to-openwrt/"><meta property="og:site_name" content="wd and cc"><meta property="og:title" content="Add Monitor Graphs to Openwrt"><meta property="og:description" content="According to the docs here https://openwrt.org/docs/guide-user/luci/luci_app_statistics, OpenWrt supports us using the Collectd to collect metrics and the Rrdtool draw the graph later.
Install 1opkg update 2opkg install luci-app-statistics We can run the command opkg list | grep collectd-mod to see what mertics we can collect. I have installed these modules
1collectd-mod-cpu 2collectd-mod-curl 3collectd-mod-dns 4collectd-mod-exec 5collectd-mod-interface 6collectd-mod-iwinfo 7collectd-mod-load 8collectd-mod-memory 9collectd-mod-network 10collectd-mod-ping 11collectd-mod-rrdtool 12collectd-mod-thermal Most of the plugins work out of the box, such as the cpu one. And some of them need some configurations on the UI, such as the curl one. You have to tell the plugin the URL you want to monitor."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-11T19:38:12+08:00"><meta property="article:modified_time" content="2021-12-11T19:38:12+08:00"><meta property="article:tag" content="Openwrt"><meta property="article:tag" content="Graph"><meta name=twitter:card content="summary"><meta name=twitter:title content="Add Monitor Graphs to Openwrt"><meta name=twitter:description content="According to the docs here https://openwrt.org/docs/guide-user/luci/luci_app_statistics, OpenWrt supports us using the Collectd to collect metrics and the Rrdtool draw the graph later.
Install 1opkg update 2opkg install luci-app-statistics We can run the command opkg list | grep collectd-mod to see what mertics we can collect. I have installed these modules
1collectd-mod-cpu 2collectd-mod-curl 3collectd-mod-dns 4collectd-mod-exec 5collectd-mod-interface 6collectd-mod-iwinfo 7collectd-mod-load 8collectd-mod-memory 9collectd-mod-network 10collectd-mod-ping 11collectd-mod-rrdtool 12collectd-mod-thermal Most of the plugins work out of the box, such as the cpu one. And some of them need some configurations on the UI, such as the curl one. You have to tell the plugin the URL you want to monitor."><meta itemprop=name content="Add Monitor Graphs to Openwrt"><meta itemprop=description content="According to the docs here https://openwrt.org/docs/guide-user/luci/luci_app_statistics, OpenWrt supports us using the Collectd to collect metrics and the Rrdtool draw the graph later.
Install 1opkg update 2opkg install luci-app-statistics We can run the command opkg list | grep collectd-mod to see what mertics we can collect. I have installed these modules
1collectd-mod-cpu 2collectd-mod-curl 3collectd-mod-dns 4collectd-mod-exec 5collectd-mod-interface 6collectd-mod-iwinfo 7collectd-mod-load 8collectd-mod-memory 9collectd-mod-network 10collectd-mod-ping 11collectd-mod-rrdtool 12collectd-mod-thermal Most of the plugins work out of the box, such as the cpu one. And some of them need some configurations on the UI, such as the curl one. You have to tell the plugin the URL you want to monitor."><meta itemprop=datePublished content="2021-12-11T19:38:12+08:00"><meta itemprop=dateModified content="2021-12-11T19:38:12+08:00"><meta itemprop=wordCount content="816"><meta itemprop=keywords content="Openwrt,Graph"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--code-background-color:#f2f2f2;--code-color:#222;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--code-background-color:#000;--code-color:#ddd;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px}blockquote{border-left:1px solid #999;color:var(--code-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto !important}.highlight,.code{padding:1px 15px;background-color:var(--code-background-color);color:var(--code-color);border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style></head><body><header><a href=/ class=title><h2>wd and cc</h2></a><p>-- Good good study, day day up!</p><nav><a href=/>Home</a>
<a href=/posts/>Posts</a>
<a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a>
<a href=/tags/>Tags</a>
<a href=/atom.xml>subscribe</a></nav></header><main><h1>Add Monitor Graphs to Openwrt</h1><p><i><time datetime=2021-12-11>11 Dec, 2021
</time></i><a href=https://wdicc.com/tags/openwrt/>#Openwrt</a>
<a href=https://wdicc.com/tags/graph/>#Graph</a></p><content><p>According to the docs here <a href=https://openwrt.org/docs/guide-user/luci/luci_app_statistics,>https://openwrt.org/docs/guide-user/luci/luci_app_statistics,</a> OpenWrt supports us using the Collectd to collect metrics and the Rrdtool draw the graph later.</p><div id=outline-container-headline-1 class=outline-3><h3 id=headline-1>Install</h3><div id=outline-text-headline-1 class=outline-text-3><div class="src src-text"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>opkg update
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>opkg install luci-app-statistics</span></span></code></pre></div></div><p>We can run the command <code class=verbatim>opkg list | grep collectd-mod</code> to see what mertics we can collect. I have installed these modules</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>collectd-mod-cpu
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>collectd-mod-curl
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>collectd-mod-dns
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>collectd-mod-exec
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>collectd-mod-interface
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>collectd-mod-iwinfo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>collectd-mod-load
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>collectd-mod-memory
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>collectd-mod-network
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>collectd-mod-ping
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>collectd-mod-rrdtool
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>collectd-mod-thermal</span></span></code></pre></div></div><p>Most of the plugins work out of the box, such as the <code class=verbatim>cpu</code> one. And some of them need some configurations on the UI, such as the <code class=verbatim>curl</code> one. You have to tell the plugin the URL you want to monitor.</p><p>The <code class=verbatim>exec</code> plugin is a special one. It needs you to write some codes to get it work.</p></div></div><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>Create a script for the exec plugin</h3><div id=outline-text-headline-2 class=outline-text-3><p>On the UI settings page of the <code class=verbatim>exec</code> plugin, we can set several scripts path for that plugin to execute. We have to create the scripts by ourselves.</p><p>For example, I will create a graph for the last handshake time of the Wireguard VPN. The command and the output for getting the last handshake time are below.</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>wg show all latest-handshakes
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>wg0     L8yns9ycPwd5/gxIm02zGifWfnMCg5f0hGqdya8pAxg=    0
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>wg0     7fR3QgAwgW/jMKWNtrnrXlxYxXc0mQA1YVv0VMz+dSg=    1639203670
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>wg0     cgCozSFbCG6SvENpITD5n6SF9vWyYO0J6jOuziy3tyU=    1639282576
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>wg1     wFyXEweIGqzB3Keg/bBmxGfBcKpp222/YMyNwvjRgiQ=    1639282486</span></span></code></pre></div></div><ul><li><code class=verbatim>wg0</code> is the device name</li><li><code class=verbatim>L8yns9ycPwd5/gxIm02zGifWfnMCg5f0hGqdya8pAxg</code> is the public key.</li><li><code class=verbatim>1639282486</code> is the timestamp when the last handshake happened.</li></ul><p>The command needs the root permission to execute. However, the <code class=verbatim>exec</code> plugin can be running as root. So we have to take a detour. There are three pieces of work to do.</p><div id=outline-container-headline-3 class=outline-4><h4 id=headline-3>Create a cron job to collect the data</h4><div id=outline-text-headline-3 class=outline-text-4><p>To run the command with the root permission, we must create this script first, which will collect the data and write the data to <code class=verbatim>/tmp</code> folder.</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>mkdir /etc/wg</span></span></code></pre></div></div><div class="src src-bash"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#007020>#!/bin/sh
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#007020></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bb60d5>output</span><span style=color:#666>=</span>/tmp/wg.collect
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>rm -f <span style=color:#bb60d5>$output</span> <span style=color:#666>&amp;&amp;</span> touch <span style=color:#bb60d5>$output</span> <span style=color:#666>&amp;&amp;</span> chmod <span style=color:#40a070>666</span> <span style=color:#bb60d5>$output</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bb60d5>current</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span>date +%s<span style=color:#007020;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bb60d5>conf</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;cgCozSFbCG6SvENpITD5n6SF9vWyYO0J6jOuziy3tyU= wg0
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#4070a0>wFyXEweIGqzB3Keg/bBmxGfBcKpp222/YMyNwvjRgiQ= wg1&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>wg show all latest-handshakes | <span style=color:#007020;font-weight:700>while</span> <span style=color:#007020>read</span> line; <span style=color:#007020;font-weight:700>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#bb60d5>device</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span><span style=color:#007020>echo</span> <span style=color:#bb60d5>$line</span> | awk -F <span style=color:#4070a0>&#39; &#39;</span> <span style=color:#4070a0>&#39;{print $1}&#39;</span><span style=color:#007020;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#bb60d5>peer</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span><span style=color:#007020>echo</span> <span style=color:#bb60d5>$line</span> | awk -F <span style=color:#4070a0>&#39; &#39;</span> <span style=color:#4070a0>&#39;{print $2}&#39;</span><span style=color:#007020;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#bb60d5>dt</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span><span style=color:#007020>echo</span> <span style=color:#bb60d5>$line</span> | awk -F <span style=color:#4070a0>&#39; &#39;</span> <span style=color:#4070a0>&#39;{print $3}&#39;</span><span style=color:#007020;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#bb60d5>name</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span><span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$conf</span><span style=color:#4070a0>&#34;</span> | grep <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$peer</span><span style=color:#4070a0>&#34;</span> | awk -F <span style=color:#4070a0>&#39; &#39;</span> <span style=color:#4070a0>&#39;{print $2}&#39;</span><span style=color:#007020;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>[</span> <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$dt</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#34;0&#34;</span> <span style=color:#666>]</span> <span style=color:#666>||</span> <span style=color:#666>[</span> -z <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$name</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>]</span>; <span style=color:#007020;font-weight:700>then</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>                <span style=color:#007020;font-weight:700>continue</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#007020;font-weight:700>fi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#bb60d5>diff</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$((</span><span style=color:#bb60d5>$current</span> <span style=color:#666>-</span> <span style=color:#bb60d5>$dt</span><span style=color:#007020;font-weight:700>))</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;PUTVAL \&#34;HOSTNAME/exec-wireguard/gauge-last_handshake_</span><span style=color:#bb60d5>$name</span><span style=color:#4070a0>\&#34; interval=INTERVAL N:</span><span style=color:#bb60d5>$diff</span><span style=color:#4070a0>&#34;</span> &gt;&gt; <span style=color:#bb60d5>$output</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#007020;font-weight:700>done</span></span></span></code></pre></div></div><p>The script will write the outputs to the <code class=verbatim>/tmp/wg.collect</code> file. You may want to change the conf settings. It will help us filter which peer we want to monitor and the alias for that peer.</p><p>The output is defined here <code class=verbatim>"PUTVAL \"HOSTNAME/exec-wireguard/gauge-last_handshake_$name\" interval=INTERVAL N:$diff"</code>. The output format is critical.</p><ul><li>First of all, the <code class=verbatim>HOSTNAME</code> and <code class=verbatim>INTERVAL</code> are placeholders. They will be replaced with the correct value later.</li><li>For the <code class=verbatim>exec-wireguard</code>, <code class=verbatim>exec</code> is the plugin name, the <code class=verbatim>wireguard</code> is the plugin instance name.</li><li>For the <code class=verbatim>gauge-last_handshake_$name</code>, <code class=verbatim>gauge</code> is the metric type. It must be inclued in the <code class=verbatim>/usr/share/collectd/types.db</code> file. You also can use one of the existed type from there. <code class=verbatim>last_handshake_$name</code> is the metric name.</li></ul><p>Add the script to the <code class=verbatim>system -> Scheduled Tasks</code>. <code class=verbatim>* * * * * /etc/wg/wg.sh</code>.</p><p>Check whether the file <code class=verbatim>/tmp/wg.collect</code> has been created and updated after adding it to the crontab.</p></div></div><div id=outline-container-headline-4 class=outline-4><h4 id=headline-4>Create the file script for the exec plugin</h4><div id=outline-text-headline-4 class=outline-text-4><p>Create a file <code class=verbatim>/etc/wg/exec-wg.sh</code></p><div class="src src-bash"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#007020>#!/bin/sh
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#007020></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bb60d5>HOSTNAME</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;</span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>COLLECTD_HOSTNAME</span><span style=color:#007020;font-weight:700>:-</span><span style=color:#bb60d5>Tux</span><span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bb60d5>INTERVAL</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;</span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>COLLECTD_INTERVAL</span><span style=color:#007020;font-weight:700>:-</span><span style=color:#bb60d5>60</span><span style=color:#70a0d0>}</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bb60d5>INTERVAL</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span>awk -v <span style=color:#bb60d5>i</span><span style=color:#666>=</span><span style=color:#bb60d5>$INTERVAL</span> <span style=color:#4070a0>&#39;BEGIN{print int(i)}&#39;</span><span style=color:#007020;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bb60d5>input</span><span style=color:#666>=</span>/tmp/wg.collect
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#007020;font-weight:700>while</span> sleep <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$INTERVAL</span><span style=color:#4070a0>&#34;</span>; <span style=color:#007020;font-weight:700>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        cat <span style=color:#bb60d5>$input</span> | sed <span style=color:#4070a0>&#34;s/HOSTNAME/</span><span style=color:#bb60d5>$HOSTNAME</span><span style=color:#4070a0>/g&#34;</span> | sed <span style=color:#4070a0>&#34;s/INTERVAL/</span><span style=color:#bb60d5>$INTERVAL</span><span style=color:#4070a0>/g&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#007020;font-weight:700>done</span></span></span></code></pre></div></div><p>This script will run and loop forever, read and print the file content. There is nothing special here.</p><p>After adding the file to the exec plugin settings UI, run these commands to check if it works.</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span># ps |grep exec-wg
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span> 4001 nobody    1088 SN   /bin/sh /etc/wg/exec-wg.sh
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span># ls &lt;path-to-rrd-data-directory&gt;/exec-wireguard/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>gauge-last_handshake_wg0.rrd  gauge-last_handshake_wg1.rrd</span></span></code></pre></div></div></div></div><div id=outline-container-headline-5 class=outline-4><h4 id=headline-5>Add graph to the OpenWrt graph page</h4><div id=outline-text-headline-5 class=outline-text-4><p>Create the file <code class=verbatim>/www/luci-static/resources/statistics/rrdtool/definitions/exec.js</code> as bellow.</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#4070a0>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#4070a0>&#39;require baseclass&#39;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#007020;font-weight:700>return</span> baseclass.extend({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    title<span style=color:#666>:</span> _(<span style=color:#4070a0>&#39;Exec&#39;</span>),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    rrdargs<span style=color:#666>:</span> <span style=color:#007020;font-weight:700>function</span>(graph, host, plugin, plugin_instance, dtype) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#60a0b0;font-style:italic>// host: Tux
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#60a0b0;font-style:italic></span>        <span style=color:#60a0b0;font-style:italic>// plugin: exec
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#60a0b0;font-style:italic></span>        <span style=color:#60a0b0;font-style:italic>// plugin_instance: wireguard
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#60a0b0;font-style:italic></span>        <span style=color:#60a0b0;font-style:italic>// dtype: null
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#60a0b0;font-style:italic></span>        <span style=color:#007020;font-weight:700>var</span> wireguard_last_handshake_time <span style=color:#666>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            title<span style=color:#666>:</span> <span style=color:#4070a0>&#34;%H: wireguard last handshake time&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            vlabel<span style=color:#666>:</span> <span style=color:#4070a0>&#34;seconds&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            alt_autoscale_max<span style=color:#666>:</span> <span style=color:#007020;font-weight:700>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            data<span style=color:#666>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>                types<span style=color:#666>:</span> [<span style=color:#4070a0>&#34;gauge&#34;</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>                options<span style=color:#666>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>                    gauge_last_handshake_wg0<span style=color:#666>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>                        color<span style=color:#666>:</span> <span style=color:#4070a0>&#34;ff0000&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>                        <span style=color:#60a0b0;font-style:italic>// noavg: true,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#60a0b0;font-style:italic></span>                        noarea<span style=color:#666>:</span> <span style=color:#007020;font-weight:700>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>                        <span style=color:#60a0b0;font-style:italic>// overlay: true,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#60a0b0;font-style:italic></span>                        <span style=color:#60a0b0;font-style:italic>// flip: true,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#60a0b0;font-style:italic></span>                        title<span style=color:#666>:</span> <span style=color:#4070a0>&#34;wg0&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>                    },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>                    gauge_last_handshake_wg1<span style=color:#666>:</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>                        color<span style=color:#666>:</span> <span style=color:#4070a0>&#34;0000ff&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>                        <span style=color:#60a0b0;font-style:italic>// noavg: true,
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#60a0b0;font-style:italic></span>                        noarea<span style=color:#666>:</span> <span style=color:#007020;font-weight:700>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>                        title<span style=color:#666>:</span> <span style=color:#4070a0>&#34;wg1&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        <span style=color:#007020;font-weight:700>return</span> wireguard_last_handshake_time;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>});</span></span></code></pre></div></div><p>The important thing in the file</p><ul><li><code class=verbatim>title: _('Exec'),</code>: define the graph title.</li><li><code class=verbatim>types: ["gauge"],</code>: define the source data type.</li><li><code class=verbatim>gauge_last_handshake_wg0</code> and <code class=verbatim>gauge_last_handshake_wg1</code>: this is optional. I want to rename the metrics name and set the color for the graph. Please notice the <code class=verbatim>_</code> after the <code class=verbatim>gauge</code> is very important. Don't use <code class=verbatim>-</code> here.</li></ul></div></div></div></div><div id=outline-container-headline-6 class=outline-3><h3 id=headline-6>Refs</h3><div id=outline-text-headline-6 class=outline-text-3><ul><li><a href=https://gist.github.com/squarewf/82a9535b6aae64430991f4e56f2513a9>https://gist.github.com/squarewf/82a9535b6aae64430991f4e56f2513a9</a></li><li><a href=http://flux242.blogspot.com/2011/01/collectd-mod-exec-part-5.html>http://flux242.blogspot.com/2011/01/collectd-mod-exec-part-5.html</a></li></ul></div></div></content></main><footer>Made with <a href=https://github.com/janraasch/hugo-bearblog/>Hugo ʕ•ᴥ•ʔ Bear</a></footer></body></html>