<!doctype html><html lang=en><head><title>Add Monitor Graphs to Openwrt &ndash; wd and cc</title>
<meta name=description content="Good good study, day day up!"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://wdicc.com/css/palettes/base16-dark.css><link rel=stylesheet href=https://wdicc.com/css/risotto.css><link rel=stylesheet href=https://wdicc.com/css/custom.css><link rel=icon href=https://wdicc.com/favicon.ico></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><h1 class=page__logo><a href=https://wdicc.com/ class=page__logo-inner>wd and cc</a></h1><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/posts/ title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=" title>Search</a></li><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/atom.xml title>subscribe</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Add Monitor Graphs to Openwrt</h1></header><div class=content__body><p>According to the docs here <a href=https://openwrt.org/docs/guide-user/luci/luci_app_statistics,>https://openwrt.org/docs/guide-user/luci/luci_app_statistics,</a> OpenWrt supports us using the Collectd to collect metrics and the Rrdtool draw the graph later.</p><div id=outline-container-headline-1 class=outline-3><h3 id=headline-1>Install</h3><div id=outline-text-headline-1 class=outline-text-3><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>opkg update
</span></span><span style=display:flex><span>opkg install luci-app-statistics</span></span></code></pre></div></div><p>We can run the command <code class=verbatim>opkg list | grep collectd-mod</code> to see what mertics we can collect. I have installed these modules</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>collectd-mod-cpu
</span></span><span style=display:flex><span>collectd-mod-curl
</span></span><span style=display:flex><span>collectd-mod-dns
</span></span><span style=display:flex><span>collectd-mod-exec
</span></span><span style=display:flex><span>collectd-mod-interface
</span></span><span style=display:flex><span>collectd-mod-iwinfo
</span></span><span style=display:flex><span>collectd-mod-load
</span></span><span style=display:flex><span>collectd-mod-memory
</span></span><span style=display:flex><span>collectd-mod-network
</span></span><span style=display:flex><span>collectd-mod-ping
</span></span><span style=display:flex><span>collectd-mod-rrdtool
</span></span><span style=display:flex><span>collectd-mod-thermal</span></span></code></pre></div></div><p>Most of the plugins work out of the box, such as the <code class=verbatim>cpu</code> one. And some of them need some configurations on the UI, such as the <code class=verbatim>curl</code> one. You have to tell the plugin the URL you want to monitor.</p><p>The <code class=verbatim>exec</code> plugin is a special one. It needs you to write some codes to get it work.</p></div></div><div id=outline-container-headline-2 class=outline-3><h3 id=headline-2>Create a script for the exec plugin</h3><div id=outline-text-headline-2 class=outline-text-3><p>On the UI settings page of the <code class=verbatim>exec</code> plugin, we can set several scripts path for that plugin to execute. We have to create the scripts by ourselves.</p><p>For example, I will create a graph for the last handshake time of the Wireguard VPN. The command and the output for getting the last handshake time are below.</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>wg show all latest-handshakes
</span></span><span style=display:flex><span>wg0     L8yns9ycPwd5/gxIm02zGifWfnMCg5f0hGqdya8pAxg=    0
</span></span><span style=display:flex><span>wg0     7fR3QgAwgW/jMKWNtrnrXlxYxXc0mQA1YVv0VMz+dSg=    1639203670
</span></span><span style=display:flex><span>wg0     cgCozSFbCG6SvENpITD5n6SF9vWyYO0J6jOuziy3tyU=    1639282576
</span></span><span style=display:flex><span>wg1     wFyXEweIGqzB3Keg/bBmxGfBcKpp222/YMyNwvjRgiQ=    1639282486</span></span></code></pre></div></div><ul><li><code class=verbatim>wg0</code> is the device name</li><li><code class=verbatim>L8yns9ycPwd5/gxIm02zGifWfnMCg5f0hGqdya8pAxg</code> is the public key.</li><li><code class=verbatim>1639282486</code> is the timestamp when the last handshake happened.</li></ul><p>The command needs the root permission to execute. However, the <code class=verbatim>exec</code> plugin can be running as root. So we have to take a detour. There are three pieces of work to do.</p><div id=outline-container-headline-3 class=outline-4><h4 id=headline-3>Create a cron job to collect the data</h4><div id=outline-text-headline-3 class=outline-text-4><p>To run the command with the root permission, we must create this script first, which will collect the data and write the data to <code class=verbatim>/tmp</code> folder.</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>mkdir /etc/wg</span></span></code></pre></div></div><div class="src src-bash"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>output<span style=color:#f92672>=</span>/tmp/wg.collect
</span></span><span style=display:flex><span>rm -f $output <span style=color:#f92672>&amp;&amp;</span> touch $output <span style=color:#f92672>&amp;&amp;</span> chmod <span style=color:#ae81ff>666</span> $output
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>current<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%s<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>conf<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cgCozSFbCG6SvENpITD5n6SF9vWyYO0J6jOuziy3tyU= wg0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>wFyXEweIGqzB3Keg/bBmxGfBcKpp222/YMyNwvjRgiQ= wg1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wg show all latest-handshakes | <span style=color:#66d9ef>while</span> read line; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        device<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $line | awk -F <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#e6db74>&#39;{print $1}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        peer<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $line | awk -F <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        dt<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo $line | awk -F <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#e6db74>&#39;{print $3}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        name<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$conf<span style=color:#e6db74>&#34;</span> | grep <span style=color:#e6db74>&#34;</span>$peer<span style=color:#e6db74>&#34;</span> | awk -F <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#e6db74>&#39;{print $2}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$dt<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>||</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$name<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        diff<span style=color:#f92672>=</span><span style=color:#66d9ef>$((</span>$current <span style=color:#f92672>-</span> $dt<span style=color:#66d9ef>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>&#34;PUTVAL \&#34;HOSTNAME/exec-wireguard/gauge-last_handshake_</span>$name<span style=color:#e6db74>\&#34; interval=INTERVAL N:</span>$diff<span style=color:#e6db74>&#34;</span> &gt;&gt; $output
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span></span></span></code></pre></div></div><p>The script will write the outputs to the <code class=verbatim>/tmp/wg.collect</code> file. You may want to change the conf settings. It will help us filter which peer we want to monitor and the alias for that peer.</p><p>The output is defined here <code class=verbatim>"PUTVAL \"HOSTNAME/exec-wireguard/gauge-last_handshake_$name\" interval=INTERVAL N:$diff"</code>. The output format is critical.</p><ul><li>First of all, the <code class=verbatim>HOSTNAME</code> and <code class=verbatim>INTERVAL</code> are placeholders. They will be replaced with the correct value later.</li><li>For the <code class=verbatim>exec-wireguard</code>, <code class=verbatim>exec</code> is the plugin name, the <code class=verbatim>wireguard</code> is the plugin instance name.</li><li>For the <code class=verbatim>gauge-last_handshake_$name</code>, <code class=verbatim>gauge</code> is the metric type. It must be inclued in the <code class=verbatim>/usr/share/collectd/types.db</code> file. You also can use one of the existed type from there. <code class=verbatim>last_handshake_$name</code> is the metric name.</li></ul><p>Add the script to the <code class=verbatim>system -> Scheduled Tasks</code>. <code class=verbatim>* * * * * /etc/wg/wg.sh</code>.</p><p>Check whether the file <code class=verbatim>/tmp/wg.collect</code> has been created and updated after adding it to the crontab.</p></div></div><div id=outline-container-headline-4 class=outline-4><h4 id=headline-4>Create the file script for the exec plugin</h4><div id=outline-text-headline-4 class=outline-text-4><p>Create a file <code class=verbatim>/etc/wg/exec-wg.sh</code></p><div class="src src-bash"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>HOSTNAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>COLLECTD_HOSTNAME<span style=color:#66d9ef>:-</span>Tux<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>INTERVAL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>COLLECTD_INTERVAL<span style=color:#66d9ef>:-</span>60<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>INTERVAL<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>awk -v i<span style=color:#f92672>=</span>$INTERVAL <span style=color:#e6db74>&#39;BEGIN{print int(i)}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>input<span style=color:#f92672>=</span>/tmp/wg.collect
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> sleep <span style=color:#e6db74>&#34;</span>$INTERVAL<span style=color:#e6db74>&#34;</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        cat $input | sed <span style=color:#e6db74>&#34;s/HOSTNAME/</span>$HOSTNAME<span style=color:#e6db74>/g&#34;</span> | sed <span style=color:#e6db74>&#34;s/INTERVAL/</span>$INTERVAL<span style=color:#e6db74>/g&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span></span></span></code></pre></div></div><p>This script will run and loop forever, read and print the file content. There is nothing special here.</p><p>After adding the file to the exec plugin settings UI, run these commands to check if it works.</p><div class="src src-text"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># ps |grep exec-wg
</span></span><span style=display:flex><span> 4001 nobody    1088 SN   /bin/sh /etc/wg/exec-wg.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># ls &lt;path-to-rrd-data-directory&gt;/exec-wireguard/
</span></span><span style=display:flex><span>gauge-last_handshake_wg0.rrd  gauge-last_handshake_wg1.rrd</span></span></code></pre></div></div></div></div><div id=outline-container-headline-5 class=outline-4><h4 id=headline-5>Add graph to the OpenWrt graph page</h4><div id=outline-text-headline-5 class=outline-text-4><p>Create the file <code class=verbatim>/www/luci-static/resources/statistics/rrdtool/definitions/exec.js</code> as bellow.</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#e6db74>&#39;use strict&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;require baseclass&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> <span style=color:#a6e22e>baseclass</span>.<span style=color:#a6e22e>extend</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>_</span>(<span style=color:#e6db74>&#39;Exec&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rrdargs</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>graph</span>, <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>plugin</span>, <span style=color:#a6e22e>plugin_instance</span>, <span style=color:#a6e22e>dtype</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// host: Tux
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// plugin: exec
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// plugin_instance: wireguard
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// dtype: null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wireguard_last_handshake_time</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;%H: wireguard last handshake time&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>vlabel</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;seconds&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>alt_autoscale_max</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>types</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;gauge&#34;</span>],
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>options</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>gauge_last_handshake_wg0</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>color</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ff0000&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// noavg: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#a6e22e>noarea</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// overlay: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>// flip: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;wg0&#34;</span>
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>gauge_last_handshake_wg1</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>color</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;0000ff&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#75715e>// noavg: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#a6e22e>noarea</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;wg1&#34;</span>
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>wireguard_last_handshake_time</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div><p>The important thing in the file</p><ul><li><code class=verbatim>title: _('Exec'),</code>: define the graph title.</li><li><code class=verbatim>types: ["gauge"],</code>: define the source data type.</li><li><code class=verbatim>gauge_last_handshake_wg0</code> and <code class=verbatim>gauge_last_handshake_wg1</code>: this is optional. I want to rename the metrics name and set the color for the graph. Please notice the <code class=verbatim>_</code> after the <code class=verbatim>gauge</code> is very important. Don't use <code class=verbatim>-</code> here.</li></ul></div></div></div></div><div id=outline-container-headline-6 class=outline-3><h3 id=headline-6>Refs</h3><div id=outline-text-headline-6 class=outline-text-3><ul><li><a href=https://gist.github.com/squarewf/82a9535b6aae64430991f4e56f2513a9>https://gist.github.com/squarewf/82a9535b6aae64430991f4e56f2513a9</a></li><li><a href=http://flux242.blogspot.com/2011/01/collectd-mod-exec-part-5.html>http://flux242.blogspot.com/2011/01/collectd-mod-exec-part-5.html</a></li></ul></div></div></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://wdicc.com/favicon.ico alt=Logo><h1 class=about__title>Happy every day!</h1><p class=about__description>Good good study, day day up!</p></div><ul class=aside__social-links><li><a href=https://github.com/wd rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2021-12-11</p><hr>On this page:<nav id=TableOfContents><ul><li><a href=#headline-1>Install</a></li><li><a href=#headline-2>Create a script for the exec plugin</a><ul><li><a href=#headline-3>Create a cron job to collect the data</a></li><li><a href=#headline-4>Create the file script for the exec plugin</a></li><li><a href=#headline-5>Add graph to the OpenWrt graph page</a></li></ul></li><li><a href=#headline-6>Refs</a></li></ul></nav></div></section><footer class=page__footer><p><br><span class=active>$ echo $LANG<br><b>zh_CN</b></span><br></p><br><br><p class=copyright>wd © 2025</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>