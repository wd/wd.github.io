<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Use Ansible Synchronize Module to Sync Files Include Templates - wd and cc</title><link rel=icon type=image/png href=/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Use Ansible Synchronize Module to Sync Files Include Templates"><meta property="og:description" content="Inspired by this post, I finally find the way to sync a directory include template files to remote.
 Put you files in {{ role_path }}/files/, if you need to put in another directory, please replace all the role_path variable.
- name:&#34;Create temporary directory&#34;local_action:tempfile state=directoryregister:temp_file_path- name:&#34;Find j2 files&#34;local_action:module:findpaths:&#34;{{ role_path }}/files/&#34;patterns:&#34;*.j2&#34;file_type:fileuse_regex:norecurse:yesregister:files_j2- name:&#34;Find normal files&#34;local_action:module:findpaths:&#34;{{ role_path }}/files/&#34;excludes:&#34;*."><meta property="og:type" content="article"><meta property="og:url" content="https://wdicc.com/use-ansible-synchronize-module-to-sync-files-include-templates/"><meta property="article:published_time" content="2020-07-27T16:34:23+08:00"><meta property="article:modified_time" content="2020-07-27T16:34:23+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Use Ansible Synchronize Module to Sync Files Include Templates"><meta name=twitter:description content="Inspired by this post, I finally find the way to sync a directory include template files to remote.
 Put you files in {{ role_path }}/files/, if you need to put in another directory, please replace all the role_path variable.
- name:&#34;Create temporary directory&#34;local_action:tempfile state=directoryregister:temp_file_path- name:&#34;Find j2 files&#34;local_action:module:findpaths:&#34;{{ role_path }}/files/&#34;patterns:&#34;*.j2&#34;file_type:fileuse_regex:norecurse:yesregister:files_j2- name:&#34;Find normal files&#34;local_action:module:findpaths:&#34;{{ role_path }}/files/&#34;excludes:&#34;*."><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://wdicc.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://wdicc.com/css/main.css><link rel=stylesheet type=text/css href=https://wdicc.com//light-syntax.css media="(prefers-color-scheme: light)"><link rel=stylesheet type=text/css href=https://wdicc.com/css/dark.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=https://wdicc.com//dark-syntax.css media="(prefers-color-scheme: dark)"><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=https://wdicc.com/js/main.js></script></head><body><div class="container wrapper post"><div class=header><base href=https://wdicc.com/><h1 class=site-title><a href=https://wdicc.com/>wd and cc</a></h1><div class=site-description><h2>&mdash; Happy every day</h2><nav class="nav social"><ul class=flat><a href=https://github.com/wd title=Github><i data-feather=github></i></a><a href=https://twitter.com/wd title=Twitter><i data-feather=twitter></i></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/post>All posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></nav></div><div class=post-header><h1 class=title>Use Ansible Synchronize Module to Sync Files Include Templates</h1><div class=meta>Posted at &mdash; Jul 27, 2020</div></div><div class=post-header></div><div class=markdown><p>Inspired by <a href=https://stackoverflow.com/questions/51486767/use-ansible-templating-but-rysnc-to-move-files/51612544>this post</a>, I finally find the way to sync a directory include template files to remote.</p><p>Put you files in <code class=verbatim>{{ role_path }}/files/</code>, if you need to put in another directory, please replace all the <code class=verbatim>role_path</code> variable.</p><div class="src src-yaml"><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Create temporary directory&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>local_action</span><span class=p>:</span><span class=w> </span><span class=l>tempfile state=directory</span><span class=w>
</span><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>temp_file_path</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Find j2 files&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>local_action</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=l>find</span><span class=w>
</span><span class=w>    </span><span class=nt>paths</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ role_path }}/files/&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>patterns</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*.j2&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>file_type</span><span class=p>:</span><span class=w> </span><span class=l>file</span><span class=w>
</span><span class=w>    </span><span class=nt>use_regex</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span><span class=w>    </span><span class=nt>recurse</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>files_j2</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Find normal files&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>local_action</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=l>find</span><span class=w>
</span><span class=w>    </span><span class=nt>paths</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ role_path }}/files/&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>excludes</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*.j2&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>file_type</span><span class=p>:</span><span class=w> </span><span class=l>file</span><span class=w>
</span><span class=w>    </span><span class=nt>use_regex</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span><span class=w>    </span><span class=nt>recurse</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>files_normal</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Ensure directory exists&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>local_action</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=l>file</span><span class=w>
</span><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.path | replace(role_path + &#39;/files&#39;, temp_file_path.path) | dirname }}&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>directory</span><span class=w>
</span><span class=w>  </span><span class=nt>with_items</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;{{ files_j2.files }}&#34;</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;{{ files_normal.files }}&#34;</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Copy templates files&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>local_action</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.path }}&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;preserve&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.path | replace(role_path + &#39;/files&#39;, temp_file_path.path) | regex_replace(&#39;.j2$&#39;, &#39;&#39;) }}&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ files_j2.files }}&#34;</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Copy normal  files to temp directory&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>local_action</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>module</span><span class=p>:</span><span class=w> </span><span class=l>template</span><span class=w>
</span><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.path }}&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;preserve&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.path | replace(role_path + &#39;/files&#39;, temp_file_path.path) }}&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ files_normal.files }}&#34;</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Sync these to the destination&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>synchronize</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ temp_file_path.path }}/&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ config_root }}/&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>delete</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span><span class=w>      </span><span class=nt>rsync_opts</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=s2>&#34;--chown=root:root&#34;</span></code></pre></div></div></div><div class=post-tags><nav class="nav tags"><ul class=flat><li><a href=/tags/ansible>ansible</a></li><li><a href=/tags/synchronize>synchronize</a></li></ul></nav></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")
return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='wdicc';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by
Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div class="footer wrapper"><nav class=nav><div>Copyright © 2020 wd. All Rights Reserved | <a href=https://github.com/vividvilla/ezhil>Ezhil theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></nav></div><script>feather.replace()</script></body></html>