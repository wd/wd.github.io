<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,viewport-fit=cover,initial-scale=1"><title>Background Task in React Native | wd and cc</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><header><nav><ul><li class=pull-left><a href=https://wdicc.com/>/home/wd and cc</a></li><li class=pull-left><a href=/tags/>~/tags</a></li><li class=pull-left><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&q=">~/search</a></li><li class=pull-right><a href=/atom.xml>~/subscribe</a></li></ul></nav></header></head><body><br><div class=article-meta><h1><span class=title>Background Task in React Native</span></h1><h2 class=date>2018/09/08</h2><p class=terms>Tags: <a href=/tags/react-native>react-native</a></p></div><main><p>react-native 支持 <code class=verbatim>setTimeout</code> 和 <code class=verbatim>setInterval</code> 这些 js 的方法来设置 timer 执行一些任务。但是对于长时间执行的任务，比如你想每 1 分钟都执行一下网络请求看看是不是有新的数据，这个时候会有一个黄条警告和你说不要这么做。</p><p>我们有类似需求，就找到了 <a href=https://github.com/ocetnik/react-native-background-timer>react-native-background-timer</a> 这个包。这个用起来和 js 的 setTimeout 的方法一样，可以一直运行。</p><p>我们另外还使用了 websocket 来和服务器保持数据同步。这样就必须要保证有网络问题的时候，可以自动重连保证链接。我们找到了 <a href=https://github.com/pladaria/reconnecting-websocket>reconnecting-websocket</a> 这个包，他提供了自动重连功能。这个包是基于 js 写的，没有任何的 native 代码。我们用的过程中发现时不时会出现断开的情况，因为并不能稳定复现，我们一开始也没有太多时间研究这个问题，所以这个 bug 几乎是持续了几个月。另外，也主要是因为我们还有 pc 设备，也用了 websocket，但是那边表现就很稳定，所以基本可以确定是 android 的问题。</p><p>我们试过自己手动断网，和手动重启服务器的方式断开 websocket，然后发现他都会重连。出现 bug 的时候，都是比如放了一个晚上，第二天来了之后，发现断开了。或者有时候似乎又不会断，总之是不很好的稳定可以复现。</p><p>一开始怀疑是 android 进入省电模式之后，应用会出问题，把设备一直接着电源之后，似乎发现好像好了，但是实际上还是会出现断开的情况。后来给 app 增加了 <code class=verbatim>REQUEST_IGNORE_BATTERY_OPTIMIZATIONS</code> 权限，试图解决，发现也不行。</p><p>最近一个月总算有时间看看了，仔细研究了一下。给 app 增加了更多的 log，记录一下 websocket 的链接和断开的情况。发现一个情况，似乎整整 24h 的时候，会出现一个断开。断开之后有时候会连不上，有时候可以。因为是整整 24h，所以这个断开基本上可以肯定是 server 那边问题，但是断开不能重连依然是用户端这边的问题。</p><p>后来我们找到了 24h 断开的原因，我们 websocket server 用的是 channel redis，<a href=https://github.com/django/channels_redis/blob/master/channels_redis/core.py#L149>里面默认是 24h 会断开</a>。这个案子破了，定期倒是没问题，现在就是为啥不会重连的问题了。</p><div class="src src-python"><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python> <span style=color:#080;font-weight:700>def</span> __init__(
        self,
        hosts<span style=color:#333>=</span>None,
        prefix<span style=color:#333>=</span><span style=background-color:#fff0f0>&#34;asgi:&#34;</span>,
        expiry<span style=color:#333>=</span><span style=color:#00d;font-weight:700>60</span>,
        group_expiry<span style=color:#333>=</span><span style=color:#00d;font-weight:700>86400</span>,
        capacity<span style=color:#333>=</span><span style=color:#00d;font-weight:700>100</span>,
        channel_capacity<span style=color:#333>=</span>None,
        symmetric_encryption_keys<span style=color:#333>=</span>None,
    ):</code></pre></td></tr></table></div></div></div><p>通过分析 websocket 的日志，发现断开之后，执行重连的时候，reconnect-websocket 避免过度重连，会增加一个延时，调用 <a href=https://github.com/pladaria/reconnecting-websocket/blob/master/reconnecting-websocket.ts#L326>this._wait()</a>，问题就出在了这里，我们发现这个 promise 会卡住不能 resolve，这里面调用的就是 <code class=verbatim>setTimeout</code> 。结合一开始说的，比较怀疑 rn 自己的 setTimeout 有问题，就试了一下使用 react-native-background-timer 来实现。改了之后运行了几天发现问题解决了。</p><div class="src src-javascript"><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript>    <span style=color:#080;font-weight:700>private</span> _wait()<span style=color:#333>:</span> <span style=color:#007020>Promise</span><span style=color:#333>&lt;</span><span style=color:#080;font-weight:700>void</span><span style=color:#333>&gt;</span> {
        <span style=color:#080;font-weight:700>return</span> <span style=color:#080;font-weight:700>new</span> <span style=color:#007020>Promise</span>(resolve =&gt; {
            setTimeout(resolve, <span style=color:#080;font-weight:700>this</span>._getNextDelay());
        });
    }
</code></pre></td></tr></table></div></div></div><p>继续看看为啥 rn 自己的 timer 有问题。</p><p>找到了 <a href=https://github.com/facebook/react-native/blob/master/Libraries/Core/Timers/JSTimers.js>JSTimers.js</a>，这里面通过调用 <code class=verbatim>Timing.createTimer</code> 来创建 timer 的。Timing.createTimer 这个 native 模块的代码在<a href=https://github.com/facebook/react-native/blob/master/ReactAndroid/src/main/java/com/facebook/react/modules/core/Timing.java#L324>这里</a>。这代码里面用到的包不熟悉，看了半天觉得看不明白，但是看到了这些。</p><div class="src src-java"><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#555;font-weight:700>@Override</span>
  <span style=color:#080;font-weight:700>public</span> <span style=color:#339;font-weight:700>void</span> <span style=color:#06b;font-weight:700>onHostPause</span><span style=color:#333>()</span> <span style=color:#333>{</span>
    isPaused<span style=color:#333>.</span><span style=color:#00c>set</span><span style=color:#333>(</span><span style=color:#080;font-weight:700>true</span><span style=color:#333>);</span>
    clearFrameCallback<span style=color:#333>();</span>
    maybeIdleCallback<span style=color:#333>();</span>
  <span style=color:#333>}</span>

  <span style=color:#555;font-weight:700>@Override</span>
  <span style=color:#080;font-weight:700>public</span> <span style=color:#339;font-weight:700>void</span> <span style=color:#06b;font-weight:700>onHostResume</span><span style=color:#333>()</span> <span style=color:#333>{</span>
    isPaused<span style=color:#333>.</span><span style=color:#00c>set</span><span style=color:#333>(</span><span style=color:#080;font-weight:700>false</span><span style=color:#333>);</span>
    <span style=color:#888>// TODO(5195192) Investigate possible problems related to restarting all tasks at the same
</span><span style=color:#888></span>    <span style=color:#888>// moment
</span><span style=color:#888></span>    setChoreographerCallback<span style=color:#333>();</span>
    maybeSetChoreographerIdleCallback<span style=color:#333>();</span>
  <span style=color:#333>}</span></code></pre></td></tr></table></div></div></div><p>那个 <code class=verbatim>onHostPause</code> 很可疑，我们知道 android 黑屏的时候，是会调用 app 的 onPause 的。继续找这个类实现了 <a href=https://github.com/facebook/react-native/blob/master/ReactAndroid/src/main/java/com/facebook/react/bridge/LifecycleEventListener.java>LifecycleEventListener</a> 这个接口，里面注释写和 active 切换有关系，实际就是和 onPause 这些 activity 的生命周期挂钩的。</p><p>app 放到后台之后，会调用 onHostPause，然后 timer 就都不执行了，所以那个 promise 一直不能 resolve，然后 reconnect-websocket 就不会连接。</p><p>RN 提供了 <a href=https://facebook.github.io/react-native/docs/headless-js-android.html>Headless JS</a> 来执行后台任务。我们就是改造了一下 reconnect-websocket 用 react-native-background-timer 就解决问题了。有需要可以用这个 <a href=https://github.com/wd/reconnecting-websocket>https://github.com/wd/reconnecting-websocket</a> 。</p></main><section id=comment><h2 class=title>Comments</h2><div id=disqus_thread aria-live=polite><noscript>Please enable JavaScript to view the <a href=//disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></section><script type=text/javascript>var disqus_config=function(){this.page.url='';this.page.identifier='';};(function(){var d=document,s=d.createElement('script');s.src='//wdicc.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><footer style=clear:both><hr>Theme from <a href=https://github.com/wd/hugo-classic>hugo-classic</a> fork from <a href=https://github.com/goodroot/hugo-classic>Github</a></footer></body></html>