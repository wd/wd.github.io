<!doctype html><html lang=zh-CN><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Background Task in React Native | wd and cc</title>
<link rel=canonical href=https://wdicc.com/background-task-in-react-native/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://wdicc.com/background-task-in-react-native/"><meta property="og:site_name" content="wd and cc"><meta property="og:title" content="Background Task in React Native"><meta property="og:description" content="react-native 支持 setTimeout 和 setInterval 这些 js 的方法来设置 timer 执行一些任务。但是对于长时间执行的任务，比如你想每 1 分钟都执行一下网"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-09-08T16:06:18+08:00"><meta property="article:modified_time" content="2018-09-08T16:06:18+08:00"><meta property="article:tag" content="React-Native"><meta name=twitter:card content="summary"><meta name=twitter:title content="Background Task in React Native"><meta name=twitter:description content="react-native 支持 setTimeout 和 setInterval 这些 js 的方法来设置 timer 执行一些任务。但是对于长时间执行的任务，比如你想每 1 分钟都执行一下网"><link rel=stylesheet href=https://wdicc.com/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><link rel=stylesheet href=https://wdicc.com/wdicc.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://wdicc.com/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://wdicc.com/react-native-deeplink/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=https://wdicc.com/typescript-for-react-native/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&text=Background%20Task%20in%20React%20Native" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&title=Background%20Task%20in%20React%20Native" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&is_video=false&description=Background%20Task%20in%20React%20Native" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Background%20Task%20in%20React%20Native&body=Check out this article: https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&title=Background%20Task%20in%20React%20Native" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&title=Background%20Task%20in%20React%20Native" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&name=Background%20Task%20in%20React%20Native&description=react-native%20%e6%94%af%e6%8c%81%20setTimeout%20%e5%92%8c%20setInterval%20%e8%bf%99%e4%ba%9b%20js%20%e7%9a%84%e6%96%b9%e6%b3%95%e6%9d%a5%e8%ae%be%e7%bd%ae%20timer%20%e6%89%a7%e8%a1%8c%e4%b8%80%e4%ba%9b%e4%bb%bb%e5%8a%a1%e3%80%82%e4%bd%86%e6%98%af%e5%af%b9%e4%ba%8e%e9%95%bf%e6%97%b6%e9%97%b4%e6%89%a7%e8%a1%8c%e7%9a%84%e4%bb%bb%e5%8a%a1%ef%bc%8c%e6%af%94%e5%a6%82%e4%bd%a0%e6%83%b3%e6%af%8f%201%20%e5%88%86%e9%92%9f%e9%83%bd%e6%89%a7%e8%a1%8c%e4%b8%80%e4%b8%8b%e7%bd%91" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&t=Background%20Task%20in%20React%20Native" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Background Task in React Native</h1><div class=meta><span class=author itemprop=author itemscope itemtype=http://schema.org/Person><span itemprop=name>wd</span></span><div class=postdate><time datetime="2018-09-08 16:06:18 +0800 +0800" itemprop=datePublished>2018-09-08</time></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/react-native rel=tag>react-native</a></div></div></header><div id=toc></div><div class=content itemprop=articleBody><p>react-native 支持 <code class=verbatim>setTimeout</code> 和 <code class=verbatim>setInterval</code> 这些 js 的方法来设置 timer 执行一些任务。但是对于长时间执行的任务，比如你想每 1 分钟都执行一下网络请求看看是不是有新的数据，这个时候会有一个黄条警告和你说不要这么做。</p><p>我们有类似需求，就找到了 <a href=https://github.com/ocetnik/react-native-background-timer>react-native-background-timer</a> 这个包。这个用起来和 js 的 setTimeout 的方法一样，可以一直运行。</p><p>我们另外还使用了 websocket 来和服务器保持数据同步。这样就必须要保证有网络问题的时候，可以自动重连保证链接。我们找到了 <a href=https://github.com/pladaria/reconnecting-websocket>reconnecting-websocket</a> 这个包，他提供了自动重连功能。这个包是基于 js 写的，没有任何的 native 代码。我们用的过程中发现时不时会出现断开的情况，因为并不能稳定复现，我们一开始也没有太多时间研究这个问题，所以这个 bug 几乎是持续了几个月。另外，也主要是因为我们还有 pc 设备，也用了 websocket，但是那边表现就很稳定，所以基本可以确定是 android 的问题。</p><p>我们试过自己手动断网，和手动重启服务器的方式断开 websocket，然后发现他都会重连。出现 bug 的时候，都是比如放了一个晚上，第二天来了之后，发现断开了。或者有时候似乎又不会断，总之是不很好的稳定可以复现。</p><p>一开始怀疑是 android 进入省电模式之后，应用会出问题，把设备一直接着电源之后，似乎发现好像好了，但是实际上还是会出现断开的情况。后来给 app 增加了 <code class=verbatim>REQUEST_IGNORE_BATTERY_OPTIMIZATIONS</code> 权限，试图解决，发现也不行。</p><p>最近一个月总算有时间看看了，仔细研究了一下。给 app 增加了更多的 log，记录一下 websocket 的链接和断开的情况。发现一个情况，似乎整整 24h 的时候，会出现一个断开。断开之后有时候会连不上，有时候可以。因为是整整 24h，所以这个断开基本上可以肯定是 server 那边问题，但是断开不能重连依然是用户端这边的问题。</p><p>后来我们找到了 24h 断开的原因，我们 websocket server 用的是 channel redis，<a href=https://github.com/django/channels_redis/blob/master/channels_redis/core.py#L149>里面默认是 24h 会断开</a>。这个案子破了，定期倒是没问题，现在就是为啥不会重连的问题了。</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span> <span style=color:#66d9ef>def</span> __init__(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        hosts<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>        prefix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;asgi:&#34;</span>,
</span></span><span style=display:flex><span>        expiry<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>,
</span></span><span style=display:flex><span>        group_expiry<span style=color:#f92672>=</span><span style=color:#ae81ff>86400</span>,
</span></span><span style=display:flex><span>        capacity<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>        channel_capacity<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>        symmetric_encryption_keys<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>    ):</span></span></code></pre></div></div><p>通过分析 websocket 的日志，发现断开之后，执行重连的时候，reconnect-websocket 避免过度重连，会增加一个延时，调用 <a href=https://github.com/pladaria/reconnecting-websocket/blob/master/reconnecting-websocket.ts#L326>this._wait()</a>，问题就出在了这里，我们发现这个 promise 会卡住不能 resolve，这里面调用的就是 <code class=verbatim>setTimeout</code> 。结合一开始说的，比较怀疑 rn 自己的 setTimeout 有问题，就试了一下使用 react-native-background-timer 来实现。改了之后运行了几天发现问题解决了。</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>_wait</span>()<span style=color:#f92672>:</span> Promise<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>resolve</span> =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>resolve</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_getNextDelay</span>());
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }</span></span></code></pre></div></div><p>继续看看为啥 rn 自己的 timer 有问题。</p><p>找到了 <a href=https://github.com/facebook/react-native/blob/master/Libraries/Core/Timers/JSTimers.js>JSTimers.js</a>，这里面通过调用 <code class=verbatim>Timing.createTimer</code> 来创建 timer 的。Timing.createTimer 这个 native 模块的代码在<a href=https://github.com/facebook/react-native/blob/master/ReactAndroid/src/main/java/com/facebook/react/modules/core/Timing.java#L324>这里</a>。这代码里面用到的包不熟悉，看了半天觉得看不明白，但是看到了这些。</p><div class="src src-java"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onHostPause</span>() {
</span></span><span style=display:flex><span>    isPaused.<span style=color:#a6e22e>set</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    clearFrameCallback();
</span></span><span style=display:flex><span>    maybeIdleCallback();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onHostResume</span>() {
</span></span><span style=display:flex><span>    isPaused.<span style=color:#a6e22e>set</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO(5195192) Investigate possible problems related to restarting all tasks at the same</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// moment</span>
</span></span><span style=display:flex><span>    setChoreographerCallback();
</span></span><span style=display:flex><span>    maybeSetChoreographerIdleCallback();
</span></span><span style=display:flex><span>  }</span></span></code></pre></div></div><p>那个 <code class=verbatim>onHostPause</code> 很可疑，我们知道 android 黑屏的时候，是会调用 app 的 onPause 的。继续找这个类实现了 <a href=https://github.com/facebook/react-native/blob/master/ReactAndroid/src/main/java/com/facebook/react/bridge/LifecycleEventListener.java>LifecycleEventListener</a> 这个接口，里面注释写和 active 切换有关系，实际就是和 onPause 这些 activity 的生命周期挂钩的。</p><p>app 放到后台之后，会调用 onHostPause，然后 timer 就都不执行了，所以那个 promise 一直不能 resolve，然后 reconnect-websocket 就不会连接。</p><p>RN 提供了 <a href=https://facebook.github.io/react-native/docs/headless-js-android.html>Headless JS</a> 来执行后台任务。我们就是改造了一下 reconnect-websocket 用 react-native-background-timer 就解决问题了。有需要可以用这个 <a href=https://github.com/wd/reconnecting-websocket>https://github.com/wd/reconnecting-websocket</a> 。</p></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&text=Background%20Task%20in%20React%20Native" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&title=Background%20Task%20in%20React%20Native" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&is_video=false&description=Background%20Task%20in%20React%20Native" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=Background%20Task%20in%20React%20Native&body=Check out this article: https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&title=Background%20Task%20in%20React%20Native" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&title=Background%20Task%20in%20React%20Native" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&name=Background%20Task%20in%20React%20Native&description=react-native%20%e6%94%af%e6%8c%81%20setTimeout%20%e5%92%8c%20setInterval%20%e8%bf%99%e4%ba%9b%20js%20%e7%9a%84%e6%96%b9%e6%b3%95%e6%9d%a5%e8%ae%be%e7%bd%ae%20timer%20%e6%89%a7%e8%a1%8c%e4%b8%80%e4%ba%9b%e4%bb%bb%e5%8a%a1%e3%80%82%e4%bd%86%e6%98%af%e5%af%b9%e4%ba%8e%e9%95%bf%e6%97%b6%e9%97%b4%e6%89%a7%e8%a1%8c%e7%9a%84%e4%bb%bb%e5%8a%a1%ef%bc%8c%e6%af%94%e5%a6%82%e4%bd%a0%e6%83%b3%e6%af%8f%201%20%e5%88%86%e9%92%9f%e9%83%bd%e6%89%a7%e8%a1%8c%e4%b8%80%e4%b8%8b%e7%bd%91" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwdicc.com%2fbackground-task-in-react-native%2f&t=Background%20Task%20in%20React%20Native" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2024 wd and cc</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/tags>Tags</a></li><li><a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">Search</a></li><li><a href=/atom.xml>Subscribe</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>