<!doctype html><html lang=en><head><title>Background Task in React Native &ndash; wd and cc</title>
<meta name=description content="Good good study, day day up!"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://wdicc.com/css/palettes/base16-dark.css><link rel=stylesheet href=https://wdicc.com/css/risotto.css><link rel=stylesheet href=https://wdicc.com/css/custom.css><link rel=icon href=https://wdicc.com/favicon.ico></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><h1 class=page__logo><a href=https://wdicc.com/ class=page__logo-inner>wd and cc</a></h1><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/posts/ title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=" title>Search</a></li><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/atom.xml title>subscribe</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Background Task in React Native</h1></header><div class=content__body><p>react-native 支持 <code class=verbatim>setTimeout</code> 和 <code class=verbatim>setInterval</code> 这些 js 的方法来设置 timer 执行一些任务。但是对于长时间执行的任务，比如你想每 1 分钟都执行一下网络请求看看是不是有新的数据，这个时候会有一个黄条警告和你说不要这么做。</p><p>我们有类似需求，就找到了 <a href=https://github.com/ocetnik/react-native-background-timer>react-native-background-timer</a> 这个包。这个用起来和 js 的 setTimeout 的方法一样，可以一直运行。</p><p>我们另外还使用了 websocket 来和服务器保持数据同步。这样就必须要保证有网络问题的时候，可以自动重连保证链接。我们找到了 <a href=https://github.com/pladaria/reconnecting-websocket>reconnecting-websocket</a> 这个包，他提供了自动重连功能。这个包是基于 js 写的，没有任何的 native 代码。我们用的过程中发现时不时会出现断开的情况，因为并不能稳定复现，我们一开始也没有太多时间研究这个问题，所以这个 bug 几乎是持续了几个月。另外，也主要是因为我们还有 pc 设备，也用了 websocket，但是那边表现就很稳定，所以基本可以确定是 android 的问题。</p><p>我们试过自己手动断网，和手动重启服务器的方式断开 websocket，然后发现他都会重连。出现 bug 的时候，都是比如放了一个晚上，第二天来了之后，发现断开了。或者有时候似乎又不会断，总之是不很好的稳定可以复现。</p><p>一开始怀疑是 android 进入省电模式之后，应用会出问题，把设备一直接着电源之后，似乎发现好像好了，但是实际上还是会出现断开的情况。后来给 app 增加了 <code class=verbatim>REQUEST_IGNORE_BATTERY_OPTIMIZATIONS</code> 权限，试图解决，发现也不行。</p><p>最近一个月总算有时间看看了，仔细研究了一下。给 app 增加了更多的 log，记录一下 websocket 的链接和断开的情况。发现一个情况，似乎整整 24h 的时候，会出现一个断开。断开之后有时候会连不上，有时候可以。因为是整整 24h，所以这个断开基本上可以肯定是 server 那边问题，但是断开不能重连依然是用户端这边的问题。</p><p>后来我们找到了 24h 断开的原因，我们 websocket server 用的是 channel redis，<a href=https://github.com/django/channels_redis/blob/master/channels_redis/core.py#L149>里面默认是 24h 会断开</a>。这个案子破了，定期倒是没问题，现在就是为啥不会重连的问题了。</p><div class="src src-python"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span> <span style=color:#66d9ef>def</span> __init__(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        hosts<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>        prefix<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;asgi:&#34;</span>,
</span></span><span style=display:flex><span>        expiry<span style=color:#f92672>=</span><span style=color:#ae81ff>60</span>,
</span></span><span style=display:flex><span>        group_expiry<span style=color:#f92672>=</span><span style=color:#ae81ff>86400</span>,
</span></span><span style=display:flex><span>        capacity<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>        channel_capacity<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>        symmetric_encryption_keys<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>    ):</span></span></code></pre></div></div><p>通过分析 websocket 的日志，发现断开之后，执行重连的时候，reconnect-websocket 避免过度重连，会增加一个延时，调用 <a href=https://github.com/pladaria/reconnecting-websocket/blob/master/reconnecting-websocket.ts#L326>this._wait()</a>，问题就出在了这里，我们发现这个 promise 会卡住不能 resolve，这里面调用的就是 <code class=verbatim>setTimeout</code> 。结合一开始说的，比较怀疑 rn 自己的 setTimeout 有问题，就试了一下使用 react-native-background-timer 来实现。改了之后运行了几天发现问题解决了。</p><div class="src src-javascript"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>_wait</span>()<span style=color:#f92672>:</span> Promise<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>resolve</span> =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>resolve</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_getNextDelay</span>());
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }</span></span></code></pre></div></div><p>继续看看为啥 rn 自己的 timer 有问题。</p><p>找到了 <a href=https://github.com/facebook/react-native/blob/master/Libraries/Core/Timers/JSTimers.js>JSTimers.js</a>，这里面通过调用 <code class=verbatim>Timing.createTimer</code> 来创建 timer 的。Timing.createTimer 这个 native 模块的代码在<a href=https://github.com/facebook/react-native/blob/master/ReactAndroid/src/main/java/com/facebook/react/modules/core/Timing.java#L324>这里</a>。这代码里面用到的包不熟悉，看了半天觉得看不明白，但是看到了这些。</p><div class="src src-java"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onHostPause</span>() {
</span></span><span style=display:flex><span>    isPaused.<span style=color:#a6e22e>set</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    clearFrameCallback();
</span></span><span style=display:flex><span>    maybeIdleCallback();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onHostResume</span>() {
</span></span><span style=display:flex><span>    isPaused.<span style=color:#a6e22e>set</span>(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO(5195192) Investigate possible problems related to restarting all tasks at the same</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// moment</span>
</span></span><span style=display:flex><span>    setChoreographerCallback();
</span></span><span style=display:flex><span>    maybeSetChoreographerIdleCallback();
</span></span><span style=display:flex><span>  }</span></span></code></pre></div></div><p>那个 <code class=verbatim>onHostPause</code> 很可疑，我们知道 android 黑屏的时候，是会调用 app 的 onPause 的。继续找这个类实现了 <a href=https://github.com/facebook/react-native/blob/master/ReactAndroid/src/main/java/com/facebook/react/bridge/LifecycleEventListener.java>LifecycleEventListener</a> 这个接口，里面注释写和 active 切换有关系，实际就是和 onPause 这些 activity 的生命周期挂钩的。</p><p>app 放到后台之后，会调用 onHostPause，然后 timer 就都不执行了，所以那个 promise 一直不能 resolve，然后 reconnect-websocket 就不会连接。</p><p>RN 提供了 <a href=https://facebook.github.io/react-native/docs/headless-js-android.html>Headless JS</a> 来执行后台任务。我们就是改造了一下 reconnect-websocket 用 react-native-background-timer 就解决问题了。有需要可以用这个 <a href=https://github.com/wd/reconnecting-websocket>https://github.com/wd/reconnecting-websocket</a> 。</p></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://wdicc.com/favicon.ico alt=Logo><h1 class=about__title>Happy every day!</h1><p class=about__description>Good good study, day day up!</p></div><ul class=aside__social-links><li><a href=https://github.com/wd rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2018-09-08</p></div></section><footer class=page__footer><p><br><span class=active>$ echo $LANG<br><b>zh_CN</b></span><br></p><br><br><p class=copyright>wd © 2025</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>