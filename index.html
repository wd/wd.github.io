<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>wd and cc</title>
    <meta name="author" content="wd">
    
	<meta name="description" content="undefined"> <!-- TODO: truncate -->
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="wd and cc" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='//fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    

</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        wd and cc
    </div>
</h1>
<span class="subtitle">happy everyday</span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/wd" class="github" title="Github"></a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/wd" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
	<li id="ajax"><a href="/tags/index.html">Tags</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form action="//www.google.com.hk/search" method="get" accept-charset="UTF-8" id="search">
            <input type="hidden" name="sitesearch" value="https://wdicc.com" />
            <input type="text" name="q" results="0" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload -->
    <div id="content" class="inner">
        

    
        <script id="dsq-count-scr" src="//wdicc.disqus.com/count.js" async></script>
    



  <article class="post">
	<h2 class="title">
		<a href="Python-inherit-and-super/">Python inherit and super</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2017-01-16T03:53:04.000Z" itemprop="datePublished">Jan 16, 2017</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/python/">python</a> <a href="/tags/super/">super</a> <a href="/tags/inherit/">inherit</a>
</div>
    </div>
      
        <p>又学习了一个 python 的继承。有很多帖子都有介绍，比如<a href="https://laike9m.com/blog/li-jie-python-super,70/" target="_blank" rel="external">理解 Python super</a>，<a href="http://www.cnblogs.com/lovemo1314/archive/2011/05/03/2035005.html" target="_blank" rel="external">python super()</a>。</p>
<p>先看一个例子，这个是第一个文章里面的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Root</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"this is Root"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(Root)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter B"</span>)</div><div class="line">        super(B, self).__init__()</div><div class="line">        print(<span class="string">"leave B"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(Root)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter C"</span>)</div><div class="line">        super(C, self).__init__()</div><div class="line">        print(<span class="string">"leave C"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(C)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter D"</span>)</div><div class="line">        super(D, self).__init__()</div><div class="line">        print(<span class="string">"leave D"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span><span class="params">(D, B)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter E"</span>)</div><div class="line">        super(E, self).__init__()</div><div class="line">        print(<span class="string">"leave E"</span>)</div><div class="line"></div><div class="line">e = E()</div><div class="line">print(e.__class__.mro())</div><div class="line"></div><div class="line"><span class="comment"># results:</span></div><div class="line"><span class="comment"># enter E</span></div><div class="line"><span class="comment"># enter D</span></div><div class="line"><span class="comment"># enter C</span></div><div class="line"><span class="comment"># enter B</span></div><div class="line"><span class="comment"># this is Root</span></div><div class="line"><span class="comment"># leave B</span></div><div class="line"><span class="comment"># leave C</span></div><div class="line"><span class="comment"># leave D</span></div><div class="line"><span class="comment"># leave E</span></div><div class="line"><span class="comment"># [&lt;class '__main__.E'&gt;, &lt;class '__main__.D'&gt;, &lt;class '__main__.C'&gt;, &lt;class '__main__.B'&gt;, &lt;class '__main__.Root'&gt;, &lt;class 'object'&gt;]</span></div></pre></td></tr></table></figure>
<p>没有什么问题，所有的类都做了初始化，很完美。接着再看一个例子，这个例子其实是上面第二篇文章里面的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter A"</span>)</div><div class="line">        print(<span class="string">"leave A"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter B"</span>)</div><div class="line">        print(<span class="string">"leave B"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(A)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter C"</span>)</div><div class="line">        super(C, self).__init__()</div><div class="line">        print(<span class="string">"leave C"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(A)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter D"</span>)</div><div class="line">        super(D, self).__init__()</div><div class="line">        print(<span class="string">"leave D"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span><span class="params">(B, C)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter E"</span>)</div><div class="line">        super(E, self).__init__()</div><div class="line">        print(<span class="string">"leave E"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">F</span><span class="params">(E, D)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter F"</span>)</div><div class="line">        super(F, self).__init__()</div><div class="line">        print(<span class="string">"leave F"</span>)</div><div class="line"></div><div class="line"></div><div class="line">f = F()</div><div class="line">print(f.__class__.mro())</div><div class="line"></div><div class="line"><span class="comment"># results:</span></div><div class="line"><span class="comment"># enter F</span></div><div class="line"><span class="comment"># enter E</span></div><div class="line"><span class="comment"># enter B</span></div><div class="line"><span class="comment"># leave B</span></div><div class="line"><span class="comment"># leave E</span></div><div class="line"><span class="comment"># leave F</span></div><div class="line"><span class="comment"># [&lt;class '__main__.F'&gt;, &lt;class '__main__.E'&gt;, &lt;class '__main__.B'&gt;, &lt;class '__main__.C'&gt;, &lt;class '__main__.D'&gt;, &lt;class '__main__.A'&gt;, &lt;class 'object'&gt;]</span></div></pre></td></tr></table></figure>
<p>我发现和文章里面贴的结果不一样，里面缺少对 C，D，A 的初始化。琢磨半天才弄明白，主要原因就是，<code>A</code>，<code>B</code> 其实也是继承自 <code>object</code>，然而我们并没有调用 <code>super</code> 来初始化，所以只需要加上就可以了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter A"</span>)</div><div class="line">        super(A, self).__init__()</div><div class="line">        print(<span class="string">"leave A"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter B"</span>)</div><div class="line">        super(B, self).__init__()</div><div class="line">        print(<span class="string">"leave B"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(A)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter C"</span>)</div><div class="line">        super(C, self).__init__()</div><div class="line">        print(<span class="string">"leave C"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(A)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter D"</span>)</div><div class="line">        super(D, self).__init__()</div><div class="line">        print(<span class="string">"leave D"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span><span class="params">(B, C)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter E"</span>)</div><div class="line">        super(E, self).__init__()</div><div class="line">        print(<span class="string">"leave E"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">F</span><span class="params">(E, D)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"enter F"</span>)</div><div class="line">        super(F, self).__init__()</div><div class="line">        print(<span class="string">"leave F"</span>)</div><div class="line"></div><div class="line"></div><div class="line">f = F()</div><div class="line">print(f.__class__.mro())</div><div class="line"></div><div class="line"><span class="comment"># results:</span></div><div class="line"><span class="comment"># enter F</span></div><div class="line"><span class="comment"># enter E</span></div><div class="line"><span class="comment"># enter B</span></div><div class="line"><span class="comment"># enter C</span></div><div class="line"><span class="comment"># enter D</span></div><div class="line"><span class="comment"># enter A</span></div><div class="line"><span class="comment"># leave A</span></div><div class="line"><span class="comment"># leave D</span></div><div class="line"><span class="comment"># leave C</span></div><div class="line"><span class="comment"># leave B</span></div><div class="line"><span class="comment"># leave E</span></div><div class="line"><span class="comment"># leave F</span></div><div class="line"><span class="comment"># [&lt;class '__main__.F'&gt;, &lt;class '__main__.E'&gt;, &lt;class '__main__.B'&gt;, &lt;class '__main__.C'&gt;, &lt;class '__main__.D'&gt;, &lt;class '__main__.A'&gt;, &lt;class 'object'&gt;]</span></div></pre></td></tr></table></figure>
<p>这样就完美了。目测这个会是一个隐藏的坑。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/Python-inherit-and-super/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="Python-metaclass/">Python metaclass</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2017-01-12T10:26:22.000Z" itemprop="datePublished">Jan 12, 2017</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/python/">python</a>
</div>
    </div>
      
        <p>又理解了一下 python 的 metaclass 可以做什么，尝试记录一下。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span><span class="params">(type)</span>:</span></div><div class="line">    register = []</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, class_name, parrent_class, params)</span>:</span></div><div class="line">        print(<span class="string">"In meta new: &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;"</span>.format(cls, class_name, parrent_class, params))</div><div class="line">        cls.register.append(class_name)</div><div class="line">        params[<span class="string">'test_prop'</span>] = <span class="keyword">True</span></div><div class="line">        <span class="comment"># return super(Meta, cls).__new__(cls, class_name, parrent_class, params)</span></div><div class="line">        <span class="comment"># return type.__new__(cls, class_name, parrent_class, params)</span></div><div class="line">        <span class="comment"># return super(Meta, cls).__new__(type, class_name, parrent_class, params)</span></div><div class="line">        <span class="comment"># return type.__new__(type, class_name, parrent_class, params)</span></div><div class="line">        <span class="keyword">return</span> type(class_name, parrent_class, params)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, class_name, parrent_class, params)</span>:</span></div><div class="line">        print(<span class="string">"In meta init: &#123;&#125;, &#123;&#125;, &#123;&#125;"</span>.format(class_name, parrent_class, params))</div><div class="line">        super(Meta, self).__init__(class_name, parrent_class, params)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(object, metaclass=Meta)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line">print(<span class="string">"register: &#123;&#125;"</span>.format(Meta.register))</div><div class="line">print(<span class="string">"prop: &#123;&#125;"</span>.format(A.test_prop))</div><div class="line">print(<span class="string">"register: &#123;&#125;"</span>.format(A.register))  <span class="comment"># Error</span></div><div class="line"></div><div class="line"><span class="comment"># outputs:</span></div><div class="line"><span class="comment"># In meta new: &lt;class '__main__.Meta'&gt;, A, (&lt;class 'object'&gt;,), &#123;'__module__': '__main__', '__qualname__': 'A'&#125;</span></div><div class="line"><span class="comment"># In meta init: A, (&lt;class 'object'&gt;,), &#123;'__module__': '__main__', '__qualname__': 'A'&#125;</span></div><div class="line"><span class="comment"># register: ['A']</span></div><div class="line"><span class="comment"># prop: True</span></div><div class="line"><span class="comment"># AttributeError: type object 'A' has no attribute 'register'</span></div></pre></td></tr></table></figure>
<p>可以看到，在构造 <code>A</code> 的时候，<code>Meta</code> 这个类里面，<code>__new__</code> 和 <code>__init__</code> 都会被调用到。上面代码往 <code>A</code> 里面塞了一个属性。</p>
<p>在 <code>__new__</code> 里面，有几个注释，可以去掉注释看看不同的效果。目前还有点疑惑，传给 <code>__new__</code> 第一个参数到底是什么。另外，开始对 <code>super</code> 也有点疑惑了，还在学习。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/Python-metaclass/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="Reinvent-the-wheel/">Reinvent the wheel</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2017-01-12T08:16:20.000Z" itemprop="datePublished">Jan 12, 2017</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/heart/">heart</a> <a href="/tags/tech/">tech</a>
</div>
    </div>
      
        <p><a href="https://en.wikipedia.org/wiki/Reinventing_the_wheel" target="_blank" rel="external">Reinvent the wheel</a> 估计技术人员都知道这个典故。</p>
<p>刚才突然想谈这个，是看到图拉鼎参加 <a href="https://weex-project.io/" target="_blank" rel="external">weex</a> 的聚会有感而发。我要是没理解错，这个应该是类似于 React native 的一套实现，我没有仔细看过他的实现，不过说他重复造轮子应该也不为过，毕竟，大家普遍赞成的是在已有的轮子上面添砖加瓦，而不是另起一套。</p>
<p>重复造轮子到底应该不应该支持？</p>
<p>之前我司来了一个发明了 avalon 框架的牛人，之后我看好像就在很多的推介这个，新人来了先学习这个。后来还有很多这种框架，新人来了都是先学习这些框架。</p>
<p>这个事情上面，我看有几个好处</p>
<ul>
<li>发明的人可以在公司内部得到很高的地位，以及相应的奖励。不管好用不好用，推行一版，一波人升天。后人再升级一版，又一波人升天。</li>
<li>学会了使用这些框架的人，如果自己本身不太灵活，到了其他公司会发现无法干活，因为使用多了会有一个很深的烙印。这样离职起来就没那么方便。</li>
<li>比较好规范和控制公司内部的技术方向。</li>
</ul>
<p>坏处</p>
<ul>
<li>和最新的技术方向可能有割裂，因为并不一定能及时更新适应。</li>
<li>问题解决只能依赖内部的这些人来解决，这种东西想要推广出去毕竟还是难。</li>
<li>浪费人力做基础建设。</li>
</ul>
<p>其实看起来，对于基层员工来看好处还是大于坏处的。毕竟如果老板不关心这个成本或者不清楚可以节约这个成本的话，那些好处还是实实在在的，牛逼有的吹。</p>
<p>在老板关心的方面，可能还有一个点，就是创新有时候是比较难的，但是所谓的微创新其实是简单一些，造轮子的时候，一般多少都会有一些微创新。如果搞的人确实有能力，避免一些原来设计里面的鸡肋冗余的部分，让新的设计更加轻快，其实也算是有好处。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/Reinvent-the-wheel/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="Beansdb-merge-tools/">Beansdb merge tools</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-12-26T10:36:11.000Z" itemprop="datePublished">Dec 26, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/beansdb/">beansdb</a>
</div>
    </div>
      
        <p>Beansdb 是豆瓣开源出来的一个高效的支持 memcached 协议的文件存储 db。按 key 查找的时候，会有索引定位到磁盘位置。不过貌似前段时间看到说他们搞了一个新的替代这个，我找了一下没找到链接。</p>
<p>使用 beansdb 的时候，有 2 个问题需要解决</p>
<ul>
<li>冗余问题</li>
<li>数据过期删除问题</li>
</ul>
<h2 id="数据冗余问题"><a href="#数据冗余问题" class="headerlink" title="数据冗余问题"></a>数据冗余问题</h2><p>先说第一个问题。beansdb 本身不提供分布式 hash 逻辑，它就是个单机的程序。冗余需要你自己搞定，如果你使用标准的 memcache 协议，可以有多 server 的配置，读的时候其中一个失败会自动找下一个 server，写的时候就不会了，需要你自己写到多个 server。如果你所有的 server 都是一模一样的，那多写就可以了。如果不一样，你还需要考虑自己的 hash 策略。</p>
<p>豆瓣提供了一个 python 的<a href="https://github.com/douban/beansdb/blob/master/python/dbclient.py" target="_blank" rel="external">客户端</a>，这个客户端里面其实包含了 hash 策略。通过把 key 和 server 分桶来做 hash。摘一点代码如下</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">BEANSDBCFG = &#123;</div><div class="line">    <span class="string">"localhost:7901"</span>: range(16),</div><div class="line">    <span class="string">"localhost:7902"</span>: range(16),</div><div class="line">    <span class="string">"localhost:7903"</span>: range(16),</div><div class="line">&#125;</div><div class="line"></div><div class="line">db = Beansdb(BEANSDBCFG, 16)</div></pre></td></tr></table></figure>
<p>上面定义了三个 server，每个包含 16 个桶（你可以根据你的需求比如定义第一个 server 只包含某些桶）。</p>
<pre><code>def __init__(self, servers, buckets_count=16, N=3, W=1, R=1):
</code></pre><p>这里是定义写入数据的时候的逻辑，那个 <code>buckets_count</code> 是桶的数量，<code>N</code> 和 <code>R</code> 貌似没用。。。，<code>W</code> 是改动的时候要求成功的最小 server 数量，包括删除和写入的时候。</p>
<p>读取的时候，会循环从包含这个 key 的桶的 server 列表里面循环读取，这里还有一个「自愈」的逻辑，循环读取直到遇到一个成功的 server，会同时把前面失败的 server 都写入一份数据。</p>
<p>这样下来基本就解决了读写分布式和故障恢复的逻辑了，非常巧妙。</p>
<p>其实针对这个问题，豆瓣还开源了个 <a href="https://github.com/douban/beanseye" target="_blank" rel="external">beanseye</a>，具体功能没有仔细研究，不过应该是上面需要客户端处理的事情都不需要考虑了。</p>
<p>我们开始用的时候，不知道有 beanseye，我的场景是在 perl 环境下面使用，把 python 的客户端翻译了一个 perl 的版本出来。[1] 有兴趣可以看看。</p>
<h2 id="数据过期删除问题"><a href="#数据过期删除问题" class="headerlink" title="数据过期删除问题"></a>数据过期删除问题</h2><p>beansdb 设计之初写入用的是 append 模式，就是说，遇到删除也是写入一条新的记录，并不会返回去修改原来的数据，所以能达到合理的 IO 速度。如果场景是大量不会删除的小文件，那么 beansdb 使用起来非常合适。</p>
<p>如果有数据过期或者删除的需求，就需要想办法处理这些数据了，否则的话，beandb 的数据文件里面会慢慢的有大量的无用数据，浪费磁盘空间。</p>
<p>这个删除过期数据的过程，我看豆瓣叫做 merge。思路其实就是把所有数据遍历一次，把有效的数据写入一个新的 data 文件，然后旧的删掉，就可以了。beansdb 的数据文件有 2 种，一种是 <code>xxx.data</code>，这种文件是数据文件，另外一种是 <code>xxx.hint.qlz</code> 这种是索引文件。</p>
<p>针对这个需求，我写了两版程序，第一版就是单纯的解读一下数据文件，把其中的数据的信息读出来，主要是版本号和创建时间，然后根据版本号只写入高版本的，根据创建时间把过期的数据丢弃。生成新的 data 文件之后，要删除 hint 文件，启动的时候会自动产生 hint 文件。然后在 beansdb 的机器上面定期跑这个脚本就好了，注意跑之前应该先关闭 beansdb。</p>
<p>第一个版本的程序只是解读了每个块的数据头，程序用起来也勉强还行，但是主要问题是，每次启动都需要重新产生 hint 文件，导致启动到提供服务很慢，所以就有了第二版程序。第二版包含了第一版的全部功能，还提供了按照文件大小来定义删除时限的功能。</p>
<p>第二个版本程序基本把 data 和 hint 文件产生的逻辑都用 perl 实现了（不过还没有经过太多测试）。下面简单讲讲逻辑。</p>
<h3 id="data-文件"><a href="#data-文件" class="headerlink" title="data 文件"></a>data 文件</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">‌<span class="keyword">typedef</span> <span class="keyword">struct</span> data_record</div><div class="line">&#123;</div><div class="line">    <span class="keyword">char</span> *value;</div><div class="line">    <span class="keyword">union</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">bool</span> free_value;    <span class="comment">// free value or not</span></div><div class="line">        <span class="keyword">uint32_t</span> crc;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">int32_t</span> tstamp;</div><div class="line">    <span class="keyword">int32_t</span> flag;</div><div class="line">    <span class="keyword">int32_t</span> version;</div><div class="line">    <span class="keyword">uint32_t</span> ksz;</div><div class="line">    <span class="keyword">uint32_t</span> vsz;</div><div class="line">    <span class="keyword">char</span> key[<span class="number">0</span>];</div><div class="line">‌&#125; DataRecord;</div></pre></td></tr></table></figure>
<p>数据文件里面，每个 key 对应的数据的长度是 <code>4*6 + key_size + value_size + padding</code>。</p>
<pre><code>read($fh, my $header, 4*6);
my ( $crc, $tstamp, $flag, $ver, $ksz, $vsz ) = unpack(&apos;I i i i I I&apos;, $header);
</code></pre><p>头部是 24 个字节，依次包括校验数据，写入时间戳，标记位，版本号，key 的长度，value 的长度。上面 <code>unpack</code> 方法第一个参数里面的含义，可以参考<a href="http://perldoc.perl.org/functions/pack.html" target="_blank" rel="external">perl 的文档</a>。每个 4 字节，32bit 整数。</p>
<p>然后是读取 <code>$ksz</code> 的长度的 key，读取 <code>$vsz</code> 长度 value。如果 <code>$flag</code> 标记表明 value 有压缩，压缩用的是 QLZ 算法，真实的值需要用 qlz 解压缩之后才能得到。</p>
<p>最后是 padding 部分，整个数据长度需要是 256 的整数倍。不足的部分，会写入 <code>\0</code> 做 padding。</p>
<p>merge 的过程不关心 value 的真实值，所以不需要解压缩，把读取到的原样写回去就可以了。另外就是 merge 的时候遇到同一个 key 多个 version 出现的时候，只保留大的那个就可以了。这样操作之后 data 文件会变小。</p>
<h3 id="hint-文件"><a href="#hint-文件" class="headerlink" title="hint 文件"></a>hint 文件</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">‌<span class="keyword">typedef</span> <span class="keyword">struct</span> hint_record</div><div class="line">&#123;</div><div class="line">    <span class="keyword">uint32_t</span> ksize:<span class="number">8</span>;</div><div class="line">    <span class="keyword">uint32_t</span> pos:<span class="number">24</span>;</div><div class="line">    <span class="keyword">int32_t</span> version;</div><div class="line">    <span class="keyword">uint16_t</span> hash;</div><div class="line">    <span class="keyword">char</span> key[NAME_IN_RECORD]; <span class="comment">// allign</span></div><div class="line">‌&#125; HintRecord;</div></pre></td></tr></table></figure>
<p>hint 文件比 data 文件稍微复杂一点，每一条记录是 <code>key_size + data_pos + ver + hash + key + padding</code>。</p>
<pre><code>my ( $ksz, $datapos, $ver, $hash ) = unpack(&quot;B8 B24 i B16&quot;, $header);

$ksz = unpack(&quot;I&quot;, pack(&quot;B32&quot;, $ksz));
$datapos = unpack(&quot;I&quot;, pack(&quot;B32&quot;, $datapos));
$datapos = $datapos &lt;&lt; 8;
$hash = unpack(&quot;I&quot;, pack(&quot;B32&quot;, $hash));
</code></pre><p>头部的 10 个字节如上面代码，第一个 8 bit 是 key 的长度，接下来 24 个 bit 是这个 key 对应数据在 data 文件里面的位置。然后是 4 字节版本，16 bit 的 hash。</p>
<p>padding 和上面 data 里面的逻辑一样，按照 256 的倍数补全。</p>
<p>hint 文件结尾有个 <code>.qlz</code>，表示整个 hint 里面的数据是压缩的，所以在处理前需要先解压缩一下。（不过我看到我代码里面在读取 hint 的时候，是全部数据解压，写入的时候，是按照 record 压缩的，很奇怪）。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/Beansdb-merge-tools/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="release-some-staff-at-github/">Release some staff at github</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-12-13T09:00:31.000Z" itemprop="datePublished">Dec 13, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/lua/">lua</a> <a href="/tags/hexo/">hexo</a> <a href="/tags/ngx-lua/">ngx_lua</a> <a href="/tags/mcrypt/">mcrypt</a>
</div>
    </div>
      
        <p>把 blog 用到的模板整理了一下，放到了 <a href="https://github.com/wd/hexo-fabric" target="_blank" rel="external">https://github.com/wd/hexo-fabric</a> ，这个最开始是 fork 别人的代码改的，后来发现原来那个人已经不用了，就整理一下，增加了一个 tag 支持，修改了一下字体和背景色，还有代码颜色等，都是一些小修改。同时也提交到了官方的 theme 库，不过 pull request 还没有通过。。</p>
<p>另外，还把之前写的一个给 ngx-lua 用的一个使用 mcrypt 加密解密的库 <a href="https://github.com/wd/lua-resty-mcrypt" target="_blank" rel="external">https://github.com/wd/lua-resty-mcrypt</a> ，整理出来单独弄了一个模块。代码其实非常简单，这个也能看出来 ngx_lua 里面使用 ffi 调用 C 模块开发多舒服，不过因为 C 知识有限，可能还是会有一些问题，不过至少自己测试是 ok 的，也在线上跑了好久，只能遇到有问题的再说了。这个同时也提交到了春哥的 opm 仓库，那个倒没有审核，提交就被索引了，使用的话应该可以用 opm 命令直接安装。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/release-some-staff-at-github/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="Bloat-and-Query-Speed-in-PostgreSQL/">Bloat and Query Speed in PostgreSQL</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-12-09T04:12:21.000Z" itemprop="datePublished">Dec 9, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/postgresql/">postgresql</a>
</div>
    </div>
      
        <p>内容反义自 <a href="https://www.citusdata.com/blog/2016/11/04/autovacuum-not-the-enemy/" target="_blank" rel="external">https://www.citusdata.com/blog/2016/11/04/autovacuum-not-the-enemy/</a></p>
<p>pg 的 mvcc 会导致表索引的 bloat 就不多说了。说一下不合理处理这种 bloat 害处是啥。</p>
<p>首先肯定是会浪费空间。然后也会影响查询速度。表和索引存储的时候都是 8kB 一个 page，如果一个查询一些行，数据库会加载这些 pages 到内存。一个 page 里面的 dead rows 越多，在加载的时候就越浪费 I/O。例如全表扫描会加载所有的 dead rows。</p>
<p>Bloat 还会导致热门的查询会一下塞满内存。会导致相同的 live rows 需要更多 pages。This causes swapping and makes certain query plans and algorithms ineligible for execution.</p>
<p>还有一个影响是，pg 的系统表也会有可能 bloat，因为他们也是表。导致这个的一种情况是频繁的创建和删除临时表。这个进一步会导致一些管理命令执行变慢，甚至比如 <code>\d</code> 这种命令。</p>
<p>索引也有可能会 bloat。索引是 tuple 标识和数据之间的一个映射。这些标识指向的是某个 page 里面的 offset。每个 tuple 都是一个独立的对象，需要自己的索引条目。更新一行的时候总是会创建这行的新的索引条目。</p>
<p>索引的 bloat 的影响比 table 小一点。索引里面指向 dead tuple 的可以直接标记为 dead. 这会使得索引膨胀，但是不会导致不必要的堆查找。同时更新堆中的 tuples 不影响已经索引的列，使用一种叫做 HOT 的技术来把指向 dead tuples 的指针指向新的。这允许查询可以通过这些指针复用旧的索引条目。(Also updates to tuples in the heap that do not affect the indexed column(s) use a technique called HOT to provide pointers from the dead tuple to its replacement. This allows queries to reuses old index entries by following pointers across the heap.) (没太看明白.)</p>
<p>索引 bloat 的问题还是应该需要重视。例如 btree 索引是由二叉树组成()。叶子节点包含值和 tuple 标识（应该是指在 data file 的 offset）。随机更新因为会重用 page，所以可以保持 btree 维持一个良好的形状。但是，如果是单侧更新，会导致大量的空页。</p>
<p>The size considerations of index bloat are still significant. For instance a btree index consists of binary tree of pages (the same sized pages as you find holding tuples in the heap). The leaf node pages contain values and tuple identifiers. Uniform random table updates tend to keep a btree index in pretty good shape because it can reuse pages. However lopsided inserts/updates affecting one side of the tree while preserving a few straggling entries can lead to lots of mostly empty pages.</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/Bloat-and-Query-Speed-in-PostgreSQL/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="Full-page-write-in-PostgreSQL/">Full page write in PostgreSQL</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-12-08T10:02:14.000Z" itemprop="datePublished">Dec 8, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/postgresql/">postgresql</a>
</div>
    </div>
      
        <p>读了一篇<a href="http://blog.2ndquadrant.com/on-the-impact-of-full-page-writes/" target="_blank" rel="external">文章</a>，简单翻译总结下。</p>
<h2 id="Partial-Writes-Torn-Pages"><a href="#Partial-Writes-Torn-Pages" class="headerlink" title="Partial Writes / Torn Pages"></a>Partial Writes / Torn Pages</h2><p>pg 默认是 8kB 一个 page。linux 文件系统一般是 4kB（x86 里面最大是 4kB)，老设备驱动一般是 512B 一个扇区，新的设备有些支持 4kB 或者 8kB。</p>
<p>当 pg 写入一个 page 8kB 的时候，系统的底层会拆分小一点块，这里涉及到写入的原子性。8kB 的 pg page，会被文件系统拆分成 4kB 的块，然后拆分成 512B 扇区大小。这个时候如果系统崩溃（比如停电，内核 bug）会发生什么？</p>
<p>即使系统的存储有针对这种情况的设计（比如 SSD 自带电容器，RAID 控制器自带电池），内核那块也是会拆分成 4kB 的 page，所以还是有一定可能性，pg 写了 8kB，但是只有部分写入成功。</p>
<p>这个时候你可能意识到这就是为啥我们要有事务日志（WAL）。所以当系统崩溃重启之后，数据库会读取 WAL（从最后一次 checkpoint），然后重新写入一遍，以保证数据文件是完整的。</p>
<p>恢复的时候，在修改一个 page 之前，还是会读取一下。</p>
<p>在 checkpoint 之后第一次修改一个 page 的时候，会把整个 page 写入 WAL。这是为了保证在恢复的时候，能保证这些被修改的 page 能完全恢复到他原有的样子。</p>
<h2 id="写放大"><a href="#写放大" class="headerlink" title="写放大"></a>写放大</h2><p>如果打开 Full page write，很显然会导致 WAL 文件增加，因为就算修改一个字节，也会导致 8kB page 的写入。因为 Full page write 只发生在 checkpoint 之后的第一次写入，所以减少 checkpoint 的发生频率是可以减少写入的。</p>
<h2 id="UUID-vs-BIGSERIAL-主键"><a href="#UUID-vs-BIGSERIAL-主键" class="headerlink" title="UUID vs BIGSERIAL 主键"></a>UUID vs BIGSERIAL 主键</h2><p>比较了一下使用 UUID 或者 bigserial 做主键对写入的影响。可以看原链接的图，会发现在 INSERT 语句的情况下 UUID 产生的 WAL 文件量比较多。主要原因是 Btree 索引的情况下，bigserial 是顺序的维护这个索引，UUID 是无顺序的，会导致维护索引产生的数据量不同。</p>
<p>如果是使用 UPDATE 随机修改，那么会发现产生的 WAL 数量就差不多了。</p>
<h2 id="8kB-and-4kB-pages"><a href="#8kB-and-4kB-pages" class="headerlink" title="8kB and 4kB pages"></a>8kB and 4kB pages</h2><p>如果减小 pg 的 page 的大小，可以减小 WAL 数量。从 8kB 减小到 4kB，上面 UUID 那个例子，可以减少大概 35% 的量。</p>
<h2 id="需要-full-page-write-吗？"><a href="#需要-full-page-write-吗？" class="headerlink" title="需要 full-page write 吗？"></a>需要 full-page write 吗？</h2><p>首先，这个参数是 2005 年 pg 8.1 引入的，那么现代的文件系统是不是已经不用操心部分写入的情况了？作者尝试了一些测试没有测试出来部分写入的情况，当然这不表示不会存在。但是就算是存在，数据的一致性校验也会是有效的保护（虽然并不能修复这个问题，但是至少能让你知道有坏的 page）</p>
<p>其次，现在很多系统都依赖于流式同步，并不会等着有问题的服务器在有硬件问题的时候重启，并且花费很多时间恢复，一般都直接切换到热备服务器上面了。这个时候部分写就不是什么问题了。但是如果我们都推荐这么做，那么「我也不知道为啥数据损坏了，我只是设置了 full_page_writes=off」这种会是 DBA 死前最常见的言论了。(类似于「这种蛇我之前在 reddit 看见过，无毒的」)</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>对于 full-page write 你没法直接优化。大部分情况下，full-page write 都是发生在 checkpoint 之后，直到下一次 checkpoint。所以调整 checkpoint 的发生频率不要太频繁很重要。</p>
<p>有些应用层的操作，可能会导致对表或者索引的随机写入的增加，例如上面的 UUID 的值就是随机的，会让简单的 INSERT 也会导致索引的随机 update。使用 Bigserial 做主键(让 UUID 做替代键)可以减少写放大。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/Full-page-write-in-PostgreSQL/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="use-pgrepup-to-upgrade-your-postgres/">使用 pgrepup 跨版本升级 pg</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-12-08T03:55:33.000Z" itemprop="datePublished">Dec 8, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/postgres/">postgres</a>
</div>
    </div>
      
        <p><a href="http://gasparin.net/2016/11/pgrepup-upgrade-postgresql-using-logical-replication/" target="_blank" rel="external">pgrepup</a> 其实是一个支持 pg 跨版本复制的工具。而 pg 大版本升级需要停机是个比较郁闷的事情，如果能通过这个解决就实在太好了。下面测试了一下。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>需要安装 <code>pgrepup</code> 和 <code>pglogical</code>。</p>
<h3 id="安装-pgrepup"><a href="#安装-pgrepup" class="headerlink" title="安装 pgrepup"></a>安装 pgrepup</h3><p>pgrepup 官方说是支持 python &gt;= 2.7 的版本，我自己测试的结果，python 3.5 里面执行有点问题，需要修改几个地方。但是在 python 2.7 里面，不需要做任何修改，所以建议使用 python 2.7。安装很简单，执行 <code>pip install pgprepup</code> 就可以了。</p>
<h3 id="安装-pglogical"><a href="#安装-pglogical" class="headerlink" title="安装 pglogical"></a>安装 pglogical</h3><p>需要给你的 pg 安装这个扩展。高版本的和低版本的都需要安装。</p>
<p>安装也很简单，下载源码，执行 <code>PATH=/opt/pg96/bin:$PATH make USE_PGXS=1 install</code> 就好了。如果是给 pg95 装，那就把路径改成 pg95。</p>
<p>可以参考<a href="https://2ndquadrant.com/it/resources/pglogical/pglogical-installation-instructions/" target="_blank" rel="external">这里</a>。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="配置-db"><a href="#配置-db" class="headerlink" title="配置 db"></a>配置 db</h3><p>先给几个 db 定义一下角色。db1 假设为 9.5 版本，db2 假设为 9.6 版本。</p>
<p>pgrepup 允许 db1, db2 和执行 pgrepup 所在的机器分别在不同的机器，也可以在相同的机器，看机器情况。</p>
<p>对于 db，最小配置的 postgres.conf 修改如下，我测试的时候两个 db 在一台机器上面，只需要修改 port 不一样就可以了。<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="attr">listen_addresses</span> = <span class="string">'*'</span>          # what IP address(es) to listen <span class="literal">on</span>;</div><div class="line"><span class="attr">port</span> = <span class="number">5495</span></div><div class="line"><span class="attr">wal_level</span> = logical # minimal, archive, hot_standby, or logical</div><div class="line"><span class="attr">max_wal_senders</span> = <span class="number">3</span>             # max number of walsender processes</div><div class="line"><span class="attr">max_replication_slots</span> = <span class="number">3</span>       # max number of replication slots</div><div class="line"><span class="attr">shared_preload_libraries</span> = <span class="string">'pglogical'</span>          # (change requires restart)</div><div class="line"></div><div class="line"><span class="comment">## 下面几个参数不是必须设置的</span></div><div class="line"><span class="attr">logging_collector</span> = <span class="literal">on</span>          # Enable capturing of stderr and csvlog</div><div class="line"><span class="attr">log_filename</span> = <span class="string">'postgresql-%Y-%m-%d.log'</span>        # log file name pattern,</div></pre></td></tr></table></figure></p>
<p>pg_hba.conf 如下，修改其中的 client_ip 和 db_ip 为对应的真实 ip。<br><figure class="highlight q"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">host <span class="built_in">all</span> <span class="built_in">all</span> client_ip/<span class="number">32</span> <span class="built_in">md5</span></div><div class="line">host replication pgrepup_replication db_ip/<span class="number">32</span> <span class="built_in">md5</span></div><div class="line">host <span class="built_in">all</span> pgrepup_replication db_ip/<span class="number">32</span> <span class="built_in">md5</span></div></pre></td></tr></table></figure></p>
<p>配置好之后，启动 db1 和 db2 看看是不是可以正常连接。</p>
<p>还需要建立用户。如果已经存在一个 super 的用户，那也可以直接用那个用户，没有的话，就建一个。db1 和 db2 都需要建立，可以是不同的用户。</p>
<h4 id="hint"><a href="#hint" class="headerlink" title="hint"></a>hint</h4><p>当然，如果我们在生产环境里面做这个事情，那肯定会是 db1 已经是一个存在的 db，只需要增加原来没有的配置就好了。db2 会是一个全新的 db，使用 initdb 初始化，之后配置上面的配置项（当然，如果是将来要给生产用，那应该是复制 db1 的配置文件过来，修改端口就可以了，其他都一样）。</p>
<h3 id="配置-pgrepup"><a href="#配置-pgrepup" class="headerlink" title="配置 pgrepup"></a>配置 pgrepup</h3><p>执行一下 <code>pgrepup config</code><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">❯❯❯ pgrepup config</div><div class="line">Pgrepup 0.3.7</div><div class="line"><span class="keyword">Create</span> a <span class="keyword">new</span> pgrepup config</div><div class="line">Configuration filename [~/.pgrepup] ./pgrepup.config</div><div class="line"><span class="keyword">Security</span></div><div class="line"><span class="keyword">Do</span> you want <span class="keyword">to</span> <span class="keyword">encrypt</span> <span class="keyword">database</span> credentials <span class="keyword">using</span> a <span class="keyword">password</span>? [Y/n] n</div><div class="line">Folder <span class="keyword">where</span> pgrepup <span class="keyword">store</span> <span class="keyword">temporary</span> dumps <span class="keyword">and</span> pgpass <span class="keyword">file</span> [/tmp] ./tmp</div><div class="line"><span class="keyword">Source</span> <span class="keyword">Database</span> configuration</div><div class="line">Ip address <span class="keyword">or</span> Dns <span class="keyword">name</span>: db_ip</div><div class="line">Port: <span class="number">5495</span></div><div class="line"><span class="keyword">Connect</span> <span class="keyword">Database</span>: [template1]</div><div class="line">Username: wd</div><div class="line"><span class="keyword">Password</span>:</div><div class="line">Destination <span class="keyword">Database</span> configuration</div><div class="line">Ip address <span class="keyword">or</span> Dns <span class="keyword">name</span>: db_ip</div><div class="line">Port: <span class="number">5496</span></div><div class="line"><span class="keyword">Connect</span> <span class="keyword">Database</span>: [template1]</div><div class="line">Username: wd</div><div class="line"><span class="keyword">Password</span>:</div><div class="line">Configuration saved <span class="keyword">to</span> ./pgrepup.config.</div><div class="line">You can <span class="keyword">now</span> <span class="keyword">use</span> the <span class="keyword">check</span> command <span class="keyword">to</span> <span class="keyword">verify</span> setup <span class="keyword">of</span> <span class="keyword">source</span> <span class="keyword">and</span> destination <span class="keyword">databases</span></div></pre></td></tr></table></figure></p>
<p>之后会产生一个配置文件 pgrepup.config，有修改的话，可以打开再次编辑。</p>
<p>之后，可以执行一下 <code>pgrepup check</code> 来检查一下</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">❯❯❯ pgrepup <span class="attr">-c</span> pgrepup.config check</div><div class="line">Pgrepup <span class="number">0.3</span><span class="number">.7</span></div><div class="line"><span class="built_in">Global</span> checkings<span class="attr">...</span></div><div class="line"> &gt;  Folder ./tmp exists <span class="keyword">and</span> is writable <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line">Checking Source<span class="attr">...</span></div><div class="line"> &gt;  Connection PostgreSQL connection <span class="keyword">to</span> db_ip:<span class="number">5495</span> <span class="keyword">with</span> user wd OK</div><div class="line"> &gt;  pglogical installation <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.KO</div><div class="line"></div><div class="line">    Hint: Install docs at https:<span class="comment">//2ndquadrant.com/it/resources/pglogical/pglogical-installation-instructions/</span></div><div class="line"></div><div class="line"> &gt;  Needed wal_level setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  Needed max_worker_processes setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;  Needed max_replication_slots setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  Needed max_wal_senders setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  pg_hba.conf settings <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>KO</div><div class="line">    Hint: Add the following lines <span class="keyword">to</span> /home/wd/data95/pg_hba.conf:</div><div class="line">        host replication pgrepup_replication db_ip/<span class="number">32</span> md5</div><div class="line">        host <span class="literal">all</span> pgrepup_replication db_ip/<span class="number">32</span> md5</div><div class="line">    After adding the lines, remember <span class="keyword">to</span> reload postgreSQL</div><div class="line"> &gt;  <span class="built_in">Local</span> pg_dumpall version <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  Source cluster tables without primary keys</div><div class="line"> &gt;      template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;      testdb</div><div class="line"> &gt;          <span class="keyword">public</span>.t1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;      postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line">Checking Destination<span class="attr">...</span></div><div class="line"> &gt;  Connection PostgreSQL connection <span class="keyword">to</span> db_ip:<span class="number">5496</span> <span class="keyword">with</span> user wd OK</div><div class="line"> &gt;  pglogical installation <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.KO</div><div class="line"></div><div class="line">    Hint: Install docs at https:<span class="comment">//2ndquadrant.com/it/resources/pglogical/pglogical-installation-instructions/</span></div><div class="line"></div><div class="line"> &gt;  Needed wal_level setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..KO</div><div class="line">    Hint: <span class="built_in">Set</span> wal_level <span class="keyword">to</span> logical</div><div class="line"> &gt;  Needed max_worker_processes setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;  Needed max_replication_slots setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..KO</div><div class="line">    Hint: Increase max_replication_slots <span class="keyword">to</span> <span class="number">3</span></div><div class="line"> &gt;  Needed max_wal_senders setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  pg_hba.conf settings <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>KO</div><div class="line">    Hint: Add the following lines <span class="keyword">to</span> /home/wd/data96/pg_hba.conf:</div><div class="line">        host replication pgrepup_replication db_ip/<span class="number">32</span> md5</div><div class="line">        host <span class="literal">all</span> pgrepup_replication db_ip/<span class="number">32</span> md5</div><div class="line">    After adding the lines, remember <span class="keyword">to</span> reload postgreSQL</div><div class="line"> &gt;  <span class="built_in">Local</span> pg_dumpall version <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div></pre></td></tr></table></figure>
<p>上面是我第一次执行 check 的结果，可以看到很多红色的 <code>KO</code>，有些下面还有 hint 提示告诉你怎么修复，针对红色的信息进行修复就好了。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">❯❯❯ pgrepup <span class="attr">-c</span> pgrepup.config check</div><div class="line">Pgrepup <span class="number">0.3</span><span class="number">.7</span></div><div class="line"><span class="built_in">Global</span> checkings<span class="attr">...</span></div><div class="line"> &gt;  Folder ./tmp exists <span class="keyword">and</span> is writable <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line">Checking Source<span class="attr">...</span></div><div class="line"> &gt;  Connection PostgreSQL connection <span class="keyword">to</span> db_ip:<span class="number">5495</span> <span class="keyword">with</span> user wd <span class="attr">...</span>OK</div><div class="line"> &gt;  pglogical installation <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;  Needed wal_level setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  Needed max_worker_processes setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;  Needed max_replication_slots setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  Needed max_wal_senders setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  pg_hba.conf settings <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;  <span class="built_in">Local</span> pg_dumpall version <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  Source cluster tables without primary keys</div><div class="line"> &gt;      template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;      testdb</div><div class="line"> &gt;          <span class="keyword">public</span>.t1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;      postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line">Checking Destination<span class="attr">...</span></div><div class="line"> &gt;  Connection PostgreSQL connection <span class="keyword">to</span> db_ip:<span class="number">5496</span> <span class="keyword">with</span> user wd <span class="attr">...</span>OK</div><div class="line"> &gt;  pglogical installation <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;  Needed wal_level setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  Needed max_worker_processes setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;  Needed max_replication_slots setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  Needed max_wal_senders setting <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  pg_hba.conf settings <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;  <span class="built_in">Local</span> pg_dumpall version <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div></pre></td></tr></table></figure>
<p>上面是我修复之后执行的结果。其中会提示会被同步的 db（上面是 template1, testdb, postgres）。之后执行 setup</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">❯❯❯ pgrepup <span class="attr">-c</span> pgrepup.config setup</div><div class="line">Pgrepup <span class="number">0.3</span><span class="number">.7</span></div><div class="line">Check <span class="keyword">if</span> there are active subscriptions <span class="keyword">in</span> Destination nodes <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"><span class="built_in">Global</span> tasks</div><div class="line"> &gt;  Remove nodes from Destination cluster</div><div class="line"> &gt;      postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;      template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;      testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;  Create temp pgpass file <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;  Drop pg_logical extension <span class="keyword">in</span> <span class="literal">all</span> databases of Source cluster</div><div class="line"> &gt;      template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;      postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;      testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;  Drop pg_logical extension <span class="keyword">in</span> <span class="literal">all</span> databases of Destination cluster</div><div class="line"> &gt;      postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;      template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;      testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line">Setup Source</div><div class="line"> &gt;  Create user for replication <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  Dump globals <span class="keyword">and</span> schema of <span class="literal">all</span> databases <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;  Setup pglogical replication sets <span class="keyword">on</span> Source node name</div><div class="line"> &gt;      template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;      postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;      testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line">Setup Destination</div><div class="line"> &gt;  Create <span class="keyword">and</span> <span class="keyword">import</span> source globals <span class="keyword">and</span> schema <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;  Setup pglogical Destination node name</div><div class="line"> &gt;      postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;      testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;      template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line">Cleaning up</div><div class="line"> &gt;  Remove temporary pgpass file <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;  Remove other temporary files <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div></pre></td></tr></table></figure>
<p>然后执行 start</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">❯❯❯ pgrepup <span class="attr">-c</span> pgrepup.config start</div><div class="line">Pgrepup <span class="number">0.3</span><span class="number">.7</span></div><div class="line">Start replication <span class="keyword">and</span> upgrade</div><div class="line"> &gt;  postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;  template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;  testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div></pre></td></tr></table></figure>
<p>可以通过 status 看同步状态</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">❯❯❯ pgrepup <span class="attr">-c</span> pgrepup.config status</div><div class="line">Pgrepup <span class="number">0.3</span><span class="number">.7</span></div><div class="line">Configuration</div><div class="line"> &gt;  Source database cluster <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;  Destination database cluster <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line">Pglogical setup</div><div class="line"> &gt;  Source database cluster</div><div class="line"> &gt;      template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;      postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;      testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;  Destination database cluster</div><div class="line"> &gt;      postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;      testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;      template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line">Replication status</div><div class="line"> &gt;  Database postgres</div><div class="line"> &gt;      Replication status <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.replicating</div><div class="line"> &gt;  Database testdb</div><div class="line"> &gt;      Replication status <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.replicating</div><div class="line"> &gt;  Database template1</div><div class="line"> &gt;      Replication status <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.replicating</div><div class="line"> &gt;  Xlog difference (<span class="built_in">bytes</span>) <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="number">57816</span></div></pre></td></tr></table></figure>
<p>可以看到三个 db 都在同步。这个时候在 db1 上面插入数据，能在 db2 上面看到会同步过去。</p>
<p>状态有三种情况</p>
<ul>
<li>initializing: pglogical 正在 copy 数据</li>
<li>replication: 同步状态</li>
<li>down: 同步断开了，需要检查日志修复</li>
</ul>
<h2 id="需要注意的问题"><a href="#需要注意的问题" class="headerlink" title="需要注意的问题"></a>需要注意的问题</h2><h3 id="db-里面的表都需要有主键"><a href="#db-里面的表都需要有主键" class="headerlink" title="db 里面的表都需要有主键"></a>db 里面的表都需要有主键</h3><p>如果存在没有主键的表，执行 check 的时候会看到下面的信息</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt;  Source cluster tables without primary keys</div><div class="line">&gt;      template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line">&gt;      testdb</div><div class="line">&gt;          <span class="keyword">public</span>.t2 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>KO</div><div class="line">   Hint: Add a primary key <span class="keyword">or</span> unique index <span class="keyword">or</span> use the pgrepup fix command</div><div class="line">&gt;          <span class="keyword">public</span>.t1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line">&gt;      postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div></pre></td></tr></table></figure>
<p>如果不解决就执行 setup，会提示下面的信息</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Setup Source <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.Skipped, configuration problems</div><div class="line">Setup Destination</div><div class="line"> &gt;  Create <span class="keyword">and</span> <span class="keyword">import</span> source globals <span class="keyword">and</span> schema <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..Skipped</div><div class="line"> &gt;  Setup pglogical Destination node name</div><div class="line"> &gt;      postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;      template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;      testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div></pre></td></tr></table></figure>
<p>可以自己创建一个主键重新 check，也可以执行 fix 来修复，然后再次执行 setup。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> ❯❯❯ pgrepup -c pgrepup.config fix</div><div class="line">Pgrepup <span class="number">0.3</span><span class="number">.7</span></div><div class="line">Find Source cluster's databases with tables without primary <span class="type">key</span>/unique index...</div><div class="line"> &gt;  template1 ....................................................................OK</div><div class="line"> &gt;  postgres .....................................................................OK</div><div class="line"> &gt;  testdb</div><div class="line"> &gt;      Found public.t2 without primary <span class="type">key</span> ................Added __pgrepup_id field</div></pre></td></tr></table></figure>
<p>通过 fix 加的主键，在 uninstall 的时候会被删除。</p>
<h3 id="Replication-status-down"><a href="#Replication-status-down" class="headerlink" title="Replication status .. down"></a>Replication status .. down</h3><p>有时候会遇到有的 db 的状态是好的，有的 db 是 down 的情况</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Replication status</div><div class="line"> &gt;  Database postgres</div><div class="line"> &gt;      Replication status <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.replicating</div><div class="line"> &gt;  Database testdb</div><div class="line"> &gt;      Replication status <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..down</div><div class="line"> &gt;  Database template1</div><div class="line"> &gt;      Replication status <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.replicating</div><div class="line"> &gt;  Xlog difference (<span class="built_in">bytes</span>) <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..<span class="number">614096</span></div></pre></td></tr></table></figure>
<p>在同步状态下面，如果给某个 db 加一个没有主键的表，就会导致同步断掉。修复方法是先 stop，然后执行 check，按照提示修复，然后执行 setup，然后 start 就可以了。</p>
<h3 id="官方列出来的几个问题"><a href="#官方列出来的几个问题" class="headerlink" title="官方列出来的几个问题"></a>官方列出来的几个问题</h3><ul>
<li>DDL 命令。不会同步 DDL 命令，可以在 db1 试试看 <code>pglogical.replicate_ddl_command</code>。</li>
<li>seq 序列。执行 stop 命令的时候，会在目标 db 的 seq 上面加 1000。</li>
<li>有大量的 db。执行 start 命令之后，pglogical 会每个 db 启动一个 worker 来同步数据，要是 db 比较多会导致比较高的负载。</li>
</ul>
<p>因为这个是基于 pglogical 的，所以还需要关注 pglogical 列出来的一些<a href="https://2ndquadrant.com/it/resources/pglogical/pglogical-docs/" target="_blank" rel="external">限制</a> 第 4 部分 Limitations and Restrictions。</p>
<ul>
<li>4.1 Superuser is required</li>
<li>4.2 UNLOGGED and TEMPORARY not replicated</li>
<li>4.3 One database at a time</li>
<li>4.4 PRIMARY KEY or REPLICA IDENTITY required</li>
<li>4.5 Only one unique index/constraint/PK</li>
<li>4.6 DDL</li>
<li>4.7 No replication queue flush</li>
<li>4.8 FOREIGN KEYS</li>
<li>4.9 TRUNCATE</li>
<li>4.10 Sequences</li>
<li>4.11 Triggers</li>
<li>4.12 PostgreSQL Version differences</li>
<li>4.13 Doesn’t replicate DDL</li>
</ul>
<h3 id="pgrepup-uninstall"><a href="#pgrepup-uninstall" class="headerlink" title="pgrepup uninstall"></a>pgrepup uninstall</h3><p>uninstall 会清理 pgrepup 创建的一些信息，比如安装的 pglogical 扩展，创建用来同步的用户，和通过 fix 命令添加的 seq。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">❯❯❯ pgrepup <span class="attr">-c</span> pgrepup.config uninstall</div><div class="line">Pgrepup <span class="number">0.3</span><span class="number">.7</span></div><div class="line">Check active subscriptions <span class="keyword">in</span> Destination nodes</div><div class="line"> &gt;  template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>Stopped</div><div class="line"> &gt;  testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>Stopped</div><div class="line"> &gt;  postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.Stopped</div><div class="line">Uninstall operations</div><div class="line"> &gt;  Remove nodes from Destination cluster</div><div class="line"> &gt;      postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;      testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;      template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;  Drop pg_logical extension <span class="keyword">in</span> <span class="literal">all</span> databases</div><div class="line"> &gt;      Source</div><div class="line"> &gt;          template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;          postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;          testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;      Destination</div><div class="line"> &gt;          postgres <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;          testdb <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;          template1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>OK</div><div class="line"> &gt;  Drop user for replication <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>.OK</div><div class="line"> &gt;  Drop unique fields added <span class="keyword">by</span> fix command</div><div class="line"> &gt;          template1</div><div class="line"> &gt;          postgres</div><div class="line"> &gt;          testdb</div><div class="line"> &gt;              <span class="keyword">public</span>.t1 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div><div class="line"> &gt;              <span class="keyword">public</span>.t2 <span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span><span class="attr">...</span>..OK</div></pre></td></tr></table></figure>
<h2 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h2><p>如果前面配置好了同步状态，那剩下的事情就简单了。</p>
<ul>
<li>停止应用链接 db1</li>
<li>确保 db1 已经没有任何链接</li>
<li>使用 <code>pgrepup stop</code> 停止 replication</li>
<li>修改应用链接到 db2</li>
<li>启动应用</li>
<li>剩下的就是处理掉停止的 db1</li>
</ul>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="http://qiita.com/yteraoka/items/e82e4d28f6a23915d190" target="_blank" rel="external">http://qiita.com/yteraoka/items/e82e4d28f6a23915d190</a></p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/use-pgrepup-to-upgrade-your-postgres/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="Built-in-sharding-in-PostgreSQL/">Built in sharding in PostgreSQL</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-12-07T08:54:59.000Z" itemprop="datePublished">Dec 7, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/postgresql/">postgresql</a>
</div>
    </div>
      
        <p>PostgreSQL 内建 sharding 支持，粗略翻译自 <a href="https://wiki.postgresql.org/wiki/Built-in_Sharding" target="_blank" rel="external">https://wiki.postgresql.org/wiki/Built-in_Sharding</a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>内建支持 sharding 最大的挑战是，如何用最小的代码修改实现。大部分社区的 sharding 修改支持都修改了很多 PostgreSQL 的代码，这也导致这些不能被 Postgres 社区那些不需要 sharding 的人接受。有了 FDW 之后，就有了在有限代码修改情况下实现内建 sharding 支持的可能。</p>
<p>基于 FDW 的这种 sharding 设计，是基于 NTT 开发的 Postgres-XC，大概已经有 10 年了。Postgres-XL 是基于这个设计的一种更加灵活的实现。</p>
<h2 id="Enhance-Existing-Features"><a href="#Enhance-Existing-Features" class="headerlink" title="Enhance Existing Features"></a>Enhance Existing Features</h2><ul>
<li>已完成？提升 FDW 的基础设计和 postgres_fdw。特别的，好的性能要求合理的把一些操作推送到子节点(foreign shards)。在 Postgres 9.6 中，join, sort, update, delete 都可以推送到字节点了。聚合的 pushdown 将在 Postgres 10 中支持。FDW 表已经可以作为继承表出现。</li>
<li>提升分区支持有效提升 existence of shards。幸运的是，单节点的分区支持也需要重构才能提升性能和更多优化。例如，executor-based partition pruning.</li>
<li>给 FDW 请求增加并行支持。这样能允许节点并行执行，这个可能会通过多个异步的链接来实现。</li>
</ul>
<h2 id="New-Subsystems"><a href="#New-Subsystems" class="headerlink" title="New Subsystems"></a>New Subsystems</h2><p>还需要开发一些子系统：</p>
<ul>
<li>允许表可以复制到所有节点，以允许更多的 join pushdown。这个可以通过 trigger 或者逻辑复制来完成。</li>
<li>实现一个子模块，以使用新的分区系统表来提交符合提交的查询的 FDW 查询。</li>
<li>实现一个子模块收集 FDW 查询的结果返回给用户。</li>
<li>实现全局事务管理器以便更加高效的允许子节点原子的提交事务。这个可能会通过 prepared 的事务来实现，还有某种在 crash 之后清理那些 preapared 的事务的事务管理器。例如 XA。</li>
<li>实现全局快照管理器，以允许子节点可以看到一致性的快照。（是不是 serialisable 事务模式会避免跨节点快照冲突？pg_export_snapshot() 或者 hot_standby_feedback 是不是会有帮助？) 多节点的备份的一致性也需要这个支持。</li>
<li>实现支持 create, manage, report on shards 这些用户 API。</li>
</ul>
<h2 id="Use-Cases"><a href="#Use-Cases" class="headerlink" title="Use Cases"></a>Use Cases</h2><p>有四种可能的用户案例和不同的需求:</p>
<ul>
<li>跨节点在只读节点上面执行只读聚合查询，例如数据仓库<br>这种是最简单的场景，不需要全局事务管理，全局快照管理，并且因为聚合，所以子节点返回的数据量也是最小的。</li>
<li>跨节点在只读节点上面执行只读非聚合查询<br>这种会给调度节点压力，需要收集和处理很多子节点返回的数据。这种也能看到 FDW 传输机制等级。</li>
<li>跨节点在可读写节点执行只读查询<br>这个需要全局快照管理来保证子节点返回数据的一致性</li>
<li>跨节点执行读写查询<br>这个需要全局快照管理器和全局事务管理器</li>
</ul>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/Built-in-sharding-in-PostgreSQL/#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="registration-about-google-voice/">申请 google voice</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-11-14T08:02:30.000Z" itemprop="datePublished">Nov 14, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="/tags/google/">google</a>
</div>
    </div>
      
        <p>昨天晚上突然想申请一个 google voice 帐号。有了之后就可以作为国外的号码使用了，可以打电话收短信，想想好像还有点用。比如我就可以用他注册一个微博帐号用来关联一些无聊的服务了。。。</p>
<p>申请的过程网上很多，不细说了。主要注意下面几点。</p>
<ol>
<li>需要美国 ip 打开 <a href="https://www.google.com/voice" target="_blank" rel="external">https://www.google.com/voice</a> ，否则会跳转到一个帮助页面。这个从网上搜一些免费的代理就可以了。我是搜索到了一些 ss 帐号，然后配合 surge 来做的。</li>
<li>需要一个能接电话的美国号码来接受 google voice 的验证电话。这个我是通过 <a href="http://textnow.com" target="_blank" rel="external">http://textnow.com</a> 来做的。登录 textnow.com 注册一个免费的帐号，其中有一步是需要输入一个美国区号，这个要注意，我第一次注册的时候，输入的是 213 (洛杉矶地区的)，然后就不行，后来又申请了一个 517 的就可以。所以最好搜索一下别人申请成功的区号有哪些，另外还好就是只要有不同的邮箱，就可以多次注册来换号码，如果遇到不行的，可以换个邮箱重新注册一下。</li>
<li>在 google voice 里面填入电话之后。google voice 会打电话给那个号码。我用 textnow 的 ios 客户端接的电话（建议不要用他们的 web，他们的 web 必须要你的浏览器支持 flash 才行，很恶心），我遇到的情况下，前几次接到的电话没有对方的声音，自己尝试直接输入号码也不行。后来多试几次就好了。</li>
<li>后面就是选号了。选好号码之后，点提交一般都会遇到一个错误，「There was an error with your request. Please try again」, 遇到这个是正常的。需要你多次点击那个按钮提交，有人用按键精灵点了几个小时搞定了。我这是打开 chrome 的 dev tools，然后看 network 里面发的请求，每次点击都会有一个 post 请求，在上面按右键，选择 「copy as curl」，然后在命令行写一个简单的程序，<code>while true; do 这里把复制的内容贴过来 ;sleep 1.5s; done</code>，复制到命令行，不停的重试就可以了，直到收到邮件说你的号码开通了。要注意的是命令行也得设置代理，一般是通过 export。</li>
</ol>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="https://wdicc.com/registration-about-google-voice/#disqus_thread">Comments</a></span>
	
</div>
</article>


  <nav id="pagenavi">
    
    
        <a href="/page/2/" class="next">Next</a>
    
  <div class="center"><a href="/archives/index.html">Blog Archives</a></div>
  </nav>


    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2017

    wd
. Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> |
    Theme is <a href="https://github.com/wd/hexo-fabric">hexo-fabric</a>, fork from <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
