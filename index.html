<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    
	<title>wd and cc</title>
    <meta name="author" content="wd">
    
	<meta name="description" content="undefined"> <!-- TODO: truncate -->
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="atom.xml" rel="alternate" title="wd and cc" type="application/atom+xml">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="/stylesheets/hljs.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='//fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![}]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <!-- <script src="/javascripts/ajaxify.js"></script> -->

    

    

</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        wd and cc
    </div>
</h1>
<span class="subtitle">happy everyday</span>
<br>

<ul id="social-links" style="text-align:center; clear:both;">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/wd" class="github" title="Github"></a>
  </li>
  
  
  
  
  <!-- Twitter -->
  <li>
  <a href="http://www.twitter.com/wd" class="twitter" title="Twitter"></a>
  </li>
  
  
  
  
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
        
</ul>




</header>

<div id="toload">
<!-- begin toload -->
    <div id="content" class="inner">
        

    
        <script id="dsq-count-scr" src="//wdicc.disqus.com/count.js" async></script>
    



  <article class="post">
	<h2 class="title">
		<a href="LLD-in-zabbix/">LLD in zabbix</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-07-30T06:09:58.000Z" itemprop="datePublished">Jul 30, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/zabbix/">zabbix</a> <a href="../tags/monitor/">monitor</a>
</div>
    </div>
      
        <p>如果需要监控的内容比较多的时候，手动管理报警信息就已经不使用了，加一批机器就需要忙活一阵子。也不能体现我们充满智慧的大脑的作用。</p>
<p>zabbix 支持 LLD(low level discovery) 方式来自动产生监控项目，包括 item, trigger 这些都可以自动添加。大概讲解一下可以利用这个东西做什么事情。</p>
<h2 id="zabbix-收集数据的方式"><a href="#zabbix-收集数据的方式" class="headerlink" title="zabbix 收集数据的方式"></a>zabbix 收集数据的方式</h2><p>zabbix 有很多收集数据的方法，这里重点讲 2 个，一个是 <code>zabbix agent</code>，一个是 <code>zabbix traper</code>。这两个方式可以和 nagios 里面的 active 和 passive 方式做类比。traaper 方式对应的就是 passive，就是 client 主动发送数据给 server。</p>
<p>对于 zabbix agent 方式，我们可以自己定义一些 <code>userParameter</code> 来添加自定义监控，这些网上很多例子。如果使用 trapper 方式，那么原则上面可以不用做任何自定义，就可以通过 zabbix-sender 或者自己模拟 sender 的协议，通过比如 python，java 等发送自己的监控信息。通过 python 发送的例子网上也有。</p>
<h2 id="LLD"><a href="#LLD" class="headerlink" title="LLD"></a>LLD</h2><p>参考<a href="https://www.zabbix.com/documentation/3.2/manual/discovery/low_level_discovery" target="_blank" rel="external">这里</a>，LLD 主要的思路就是给服务器端发送一个 json 数据格式。例如下面这个。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"data"</span>:[</div><div class="line">  </div><div class="line">  &#123; <span class="attr">"&#123;#FSNAME&#125;"</span>:<span class="string">"/"</span>,                           <span class="attr">"&#123;#FSTYPE&#125;"</span>:<span class="string">"rootfs"</span>   &#125;,</div><div class="line">  &#123; <span class="attr">"&#123;#FSNAME&#125;"</span>:<span class="string">"/sys"</span>,                        <span class="attr">"&#123;#FSTYPE&#125;"</span>:<span class="string">"sysfs"</span>    &#125;,</div><div class="line">  &#123; <span class="attr">"&#123;#FSNAME&#125;"</span>:<span class="string">"/proc"</span>,                       <span class="attr">"&#123;#FSTYPE&#125;"</span>:<span class="string">"proc"</span>     &#125;,</div><div class="line">  &#123; <span class="attr">"&#123;#FSNAME&#125;"</span>:<span class="string">"/dev"</span>,                        <span class="attr">"&#123;#FSTYPE&#125;"</span>:<span class="string">"devtmpfs"</span> &#125;,</div><div class="line">  &#123; <span class="attr">"&#123;#FSNAME&#125;"</span>:<span class="string">"/dev/pts"</span>,                    <span class="attr">"&#123;#FSTYPE&#125;"</span>:<span class="string">"devpts"</span>   &#125;,</div><div class="line">  &#123; <span class="attr">"&#123;#FSNAME&#125;"</span>:<span class="string">"/lib/init/rw"</span>,                <span class="attr">"&#123;#FSTYPE&#125;"</span>:<span class="string">"tmpfs"</span>    &#125;,</div><div class="line">  &#123; <span class="attr">"&#123;#FSNAME&#125;"</span>:<span class="string">"/dev/shm"</span>,                    <span class="attr">"&#123;#FSTYPE&#125;"</span>:<span class="string">"tmpfs"</span>    &#125;,</div><div class="line">  &#123; <span class="attr">"&#123;#FSNAME&#125;"</span>:<span class="string">"/home"</span>,                       <span class="attr">"&#123;#FSTYPE&#125;"</span>:<span class="string">"ext3"</span>     &#125;,</div><div class="line">  &#123; <span class="attr">"&#123;#FSNAME&#125;"</span>:<span class="string">"/tmp"</span>,                        <span class="attr">"&#123;#FSTYPE&#125;"</span>:<span class="string">"ext3"</span>     &#125;,</div><div class="line">  &#123; <span class="attr">"&#123;#FSNAME&#125;"</span>:<span class="string">"/usr"</span>,                        <span class="attr">"&#123;#FSTYPE&#125;"</span>:<span class="string">"ext3"</span>     &#125;,</div><div class="line">  &#123; <span class="attr">"&#123;#FSNAME&#125;"</span>:<span class="string">"/var"</span>,                        <span class="attr">"&#123;#FSTYPE&#125;"</span>:<span class="string">"ext3"</span>     &#125;,</div><div class="line">  &#123; <span class="attr">"&#123;#FSNAME&#125;"</span>:<span class="string">"/sys/fs/fuse/connections"</span>,    <span class="attr">"&#123;#FSTYPE&#125;"</span>:<span class="string">"fusectl"</span>  &#125;</div><div class="line">  </div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个数据里面，data 是必须的，里面包含里面发现的可监控数据，这可以是任何数据。例子里面是发现了可以用来监控的磁盘分区。data 是个数组，每个可监控项是一个数组元素。还有类似下面这样的数据。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"data"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"&#123;#HOST&#125;"</span>: <span class="string">"Japan 1"</span>,</div><div class="line">            <span class="attr">"&#123;#COUNT&#125;"</span>: <span class="string">"5"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"&#123;#HOST&#125;"</span>: <span class="string">"Japan 2"</span>,</div><div class="line">            <span class="attr">"&#123;#COUNT&#125;"</span>: <span class="string">"12"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"&#123;#HOST&#125;"</span>: <span class="string">"Latvia"</span>,</div><div class="line">            <span class="attr">"&#123;#COUNT&#125;"</span>: <span class="string">"3"</span></div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个是发现了一些可监控的 host。</p>
<p>理解没有？发现是发现可监控的服务，并不是发现监控项。比如我们可以通过发现这机器上面有没有启动 ssh，发现有启动之后，我们就可以通过服务器端配置 discovery 自动添加一些监控规则。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"data"</span>: [</div><div class="line">        &#123; <span class="attr">"&#123;#SSH_PORT&#125;"</span>: <span class="string">"22"</span> &#125;,</div><div class="line">        &#123; <span class="attr">"&#123;#SSH_PORT&#125;"</span>: <span class="string">"8022"</span> &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>比如上面这个，我们发现了 2 个 ssh 进程，一个是 22 端口，一个是 8022 端口。</p>
<p>所以重点是发现有什么可监控的服务，并不是发现监控项。</p>
<p>BUT，其实并不是不能发现监控项，也是可以的。不过是，这种被发现的监控项，除非对应的 trigger 也都是一样的，否则你会发现无法分别添加不同的 trigger 规则。</p>
<h2 id="发现监控项"><a href="#发现监控项" class="headerlink" title="发现监控项"></a>发现监控项</h2><p>有了发现服务之后，就肯定需要对相应的服务的一些监控项做监控了。这个给 discovery 规则配置 item prototype 就可以了，不过这个里面有点坑需要填，后面会说，这里先不讲。</p>
<p>那么比如对于 ssh 服务，可以监控</p>
<ul>
<li>当前链接人数，conn.cnt</li>
<li>配置文件的 md5，conf.md5（配合 zabbix trigger 可以用来监控文件是不是被修改了）</li>
</ul>
<p>那监控数据就如下面</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"22.conn.cnt"</span>: <span class="number">4</span>,</div><div class="line">    <span class="attr">"22.conf.md5"</span>: <span class="string">"18492113fb263c9d0a33c9fea403eea1"</span>,</div><div class="line">    <span class="attr">"8022.conn.cnt"</span>: <span class="number">9</span>,</div><div class="line">    <span class="attr">"8022.conf.md5"</span>: <span class="string">"6cab272daa07202ccb57c4064c0dcfb8"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面就是一个 discovery 项目，filter 是 {#SSH_PORT}，和 2 个 item prototype，分别是 {#SSH_PORT}.cnn.cnt 和 {#SSH_PORT}.conf.md5。</p>
<h2 id="复杂一点的-LLD"><a href="#复杂一点的-LLD" class="headerlink" title="复杂一点的 LLD"></a>复杂一点的 LLD</h2><p>一个 LLD 还可以发现多个服务。比如下面这种。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"data"</span>: [</div><div class="line">        &#123; <span class="attr">"&#123;#SSH_PORT&#125;"</span>: <span class="string">"22"</span> &#125;,</div><div class="line">        &#123; <span class="attr">"&#123;#SSH_PORT&#125;"</span>: <span class="string">"8022"</span> &#125;,</div><div class="line">        &#123; <span class="attr">"&#123;#PG_PORT&#125;"</span>: <span class="number">5432</span> &#125;,</div><div class="line">        &#123; <span class="attr">"&#123;#PG_PORT&#125;"</span>: <span class="number">6432</span> &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个除了我们前面讲的 ssh 服务，还发现了两个 pg 的服务。在服务器端，只需要添加两个 discovery 规则就可以了，分别使用 {#SSH_PORT} 和 {#PG_PORT} 这两个宏来过滤数据。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"data"</span>: [</div><div class="line">        &#123; <span class="attr">"&#123;#SSH_PORT&#125;"</span>: <span class="string">"22"</span> &#125;,</div><div class="line">        &#123; <span class="attr">"&#123;#SSH_PORT&#125;"</span>: <span class="string">"8022"</span> &#125;,</div><div class="line">        &#123; <span class="attr">"&#123;#PG_PORT&#125;"</span>: <span class="number">5432</span> &#125;,</div><div class="line">        &#123; <span class="attr">"&#123;#PG_PORT&#125;"</span>: <span class="number">6432</span> &#125;</div><div class="line">        &#123; <span class="attr">"&#123;#MASTER_DB_PORT&#125;"</span>: <span class="number">5432</span>, <span class="attr">"&#123;#SLAVE_DB&#125;"</span>: <span class="string">"host1"</span> &#125;,</div><div class="line">        &#123; <span class="attr">"&#123;#MASTER_DB_PORT&#125;"</span>: <span class="number">5432</span>, <span class="attr">"&#123;#SLAVE_DB&#125;"</span>: <span class="string">"host2"</span> &#125;,</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面这个，除了有 2 个 db 之外，还有一个 db 是个 master，能看到他对应的 slave 有哪些。要注意，我们在新增加的这个发现项里面，不能再使用 {#PG_PORT} 这个宏了，因为如果使用了这个宏，就会和第3，4个项目无法区分了。所以我们改了一下名字。</p>
<p>到此为止，只是我们的构思，想要告诉 zabbix 我们想要监控什么。真正使用还需要走一些路。</p>
<h2 id="如何发送数据"><a href="#如何发送数据" class="headerlink" title="如何发送数据"></a>如何发送数据</h2><p>不管是 discovery 数据，还是 item 的监控数据，都可以通过 agent 和 trapper 方式发送。</p>
<p>对于 discovery 数据，使用 agent 发送就是上面讲的格式。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"data"</span>: [</div><div class="line">        &#123; <span class="attr">"&#123;#PG.OTHER&#125;"</span>: <span class="string">"0"</span> &#125;,</div><div class="line">     ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果使用 trapper 方式发送，格式如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"data"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"host"</span>: <span class="string">"HOST1"</span>,</div><div class="line">            <span class="attr">"value"</span>: <span class="string">"&#123;\"data\": [&#123;\"&#123;#PG.OTHER&#125;\": \"0\"&#125;]&#125;"</span>,</div><div class="line">            <span class="attr">"key"</span>: <span class="string">"pg.discover"</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="attr">"request"</span>: <span class="string">"sender data"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面这个数据里面，data 和 request 是 zabbix sender 的固定格式。data 里面，包含了 host, value, key 三个字段。host 是被监控的 host，和将来服务器端的 host 对应。value 是发送的监控内容，可以看到也就是我们使用 agent 发送的内容。key 就是对应的监控项，这个监控项也就是 agent 方式发送对应的那个 userParameter。</p>
<p>使用 trapper 方式发送里面，是可以伪造被监控的 host 的，所以 trapper 方式并不要求一定要在被监控机器上面执行。</p>
<p>对于 item 监控数据，使用 agent 发送是下面这种格式。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"key1"</span>: <span class="number">2</span>,</div><div class="line">    <span class="attr">"key2"</span>: <span class="string">"ok"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用 trapper 方式发送，是下面的这种格式。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"data"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"host"</span>: <span class="string">"HOST1"</span>,</div><div class="line">            <span class="attr">"value"</span>: <span class="number">1</span>,</div><div class="line">            <span class="attr">"key"</span>: <span class="string">"key1"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"host"</span>: <span class="string">"HOST1"</span>,</div><div class="line">            <span class="attr">"value"</span>: <span class="string">"ok"</span>,</div><div class="line">            <span class="attr">"key"</span>: <span class="string">"key2"</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="attr">"request"</span>: <span class="string">"sender data"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="zabbix-里面的限制"><a href="#zabbix-里面的限制" class="headerlink" title="zabbix 里面的限制"></a>zabbix 里面的限制</h2><p>上面的例子很完美，但实际上 zabbix 是有一些限制的。比如 item 定义。</p>
<p>假如对于发现的 pg 服务，有一个监控项是连接数，比如 {#PG_PORT}.conn.cnt，此时你会发现在 zabbix 新建 item 的 <code>Key</code> 那个设置里面，这么写无法提交。需要使用假装类似 userParameter 的方式来写，比如 pg.[{#PG.PORT}.conn.cnt]，假装那个 <code>pg.</code> 是个 userParameter 命令，[{#PG.PORT}.conn.cnt] 里面的内容是他的参数。当然，这个 pg. 可以基本可以是任何字符串，比如 abc，你自己觉得有意义就好了。</p>
<p>那么这个时候对于发现那块，我们基本不用动，需要动的是被发送的服务的监控项的命名上面。</p>
<p>比如以那个 ssh 的监控为例，原来发送的数据如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"22.conn.cnt"</span>: <span class="number">4</span>,</div><div class="line">    <span class="attr">"22.conf.md5"</span>: <span class="string">"18492113fb263c9d0a33c9fea403eea1"</span>,</div><div class="line">    <span class="attr">"8022.conn.cnt"</span>: <span class="number">9</span>,</div><div class="line">    <span class="attr">"8022.conf.md5"</span>: <span class="string">"6cab272daa07202ccb57c4064c0dcfb8"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们只需要修改成这样</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"ssh[22.conn.cnt]"</span>: <span class="number">4</span>,</div><div class="line">    <span class="attr">"ssh[22.conf.md5]"</span>: <span class="string">"18492113fb263c9d0a33c9fea403eea1"</span>,</div><div class="line">    <span class="attr">"ssh[8022.conn.cnt]"</span>: <span class="number">9</span>,</div><div class="line">    <span class="attr">"ssh[8022.conf.md5]"</span>: <span class="string">"6cab272daa07202ccb57c4064c0dcfb8"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对应的 2 个 item prototype，key 分别修改为 ssh[{#SSH_PORT}.cnn.cnt] 和 ssh[{#SSH_PORT}.conf.md5]。那个 ssh 可以随意起。并且其实并不一定就得是这种模式，比如叫做 ssh.conf.md5[{#SSH_PORT}] 应该也可以，当然需要你发送的数据也做对应修改。</p>
<h2 id="如何发送监控数据"><a href="#如何发送监控数据" class="headerlink" title="如何发送监控数据"></a>如何发送监控数据</h2><p>咦？好像说过一次了？这次和上面不一样，呵呵。</p>
<p>设计好并写好监控之后，选择什么方式发送监控数据呢。我选择的是 discovery 数据通过 agent 方式获取，也就是在各服务器上面定义相同的一个 key，然后执行这个 key 的时候发送发现的服务信息。</p>
<p>而对于监控项数据则通过 trapper 方式发送。通过 trapper 方式发送，需要定时执行，可以通过 crontab 发送。我选择的是建立了一个 agent 类型的 item，执行这个 item 的时候发送监控数据。这样一方面可以针对这个发送动作建立一个监控，另外一方面调整很方便，zabbix 界面修改就可以。并且我把这个 item 建立到了模板上面，只要修改应用模板就可以了。</p>
<p>监控数据也可以用 agent 方式发送，如果用 agent 方式发送，对于上面的 ssh 服务，就需要真的建立那个 ssh 的 userParameter 了，然后接受比如 <code>22.conf.md5</code> 这样的参数，去返回对应的监控数据。我没有用这种方式，是因为这样做等于有多少个 item 就需要在监控周期内执行多少次那个命令，给服务器增加负担（虽然没多少）。而使用 trapper 方式的话，就可以一次把所有的监控数据都发过去了，命令只需要执行一次。</p>
<h2 id="如何应对不同的部分"><a href="#如何应对不同的部分" class="headerlink" title="如何应对不同的部分"></a>如何应对不同的部分</h2><p>到此为止，应该可以很完美的发现服务，并且监控了。但是会发现其实并不是所有服务器的服务都是一样的，比如对于 pgsql，slow query 的界定对于不同的业务可能不一样。而因为 trigger 也是自动发现添加的，这样也有可能需要不同的机器上面的服务有不同的阈值，怎么解决呢？</p>
<p>先说监控项的阈值。因为我的监控数据其实是通过建立一个 agent 类型的 item 定期发送 trapper 数据来实现的，所以只需要在调用那个 item 的时候传送不同的阈值就可以了。实际上面我的 itme key 定义是这样的 <code>pg.sendtrap[{$PG.DISCOVER.SETTINGS}]</code> 。那个 pg.sendtrap 是对应到一个 userParameter 的 <code>UserParameter=pg.sendtrap[*],/etc/zabbix/bin/zabbix_pg.py --check --sendtrap --settings $1</code>，在 zabbix_pg.py 里面，会处理 settings 参数。如果有阈值，那就定义好 <code>{$PG.DISCOVER.SETTINGS}</code> 这个宏就可以了。template 上面可以定义默认的阈值，当然默认阈值在程序里面定义也可以。然后不同 host 可以定义 host 的阈值，会覆盖模板的配置。</p>
<p>其实 trigger 的阈值和这个思路类似，也是 template 里面定义一个宏，trigger 里面使用这个宏就可以了。如果 host 有不同的阈值，那就定义一个 host 的宏覆盖他就可以了。</p>
<h2 id="目前的情况"><a href="#目前的情况" class="headerlink" title="目前的情况"></a>目前的情况</h2><p>配合 zabbix 的 auto registration 这个 action，可以做到新机器只需要执行一个 saltstack state，安装好我们的 zabbix agent，就可以自动注册 host，自动添加监控报警。</p>
<p>相当完美。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="LLD-in-zabbix/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="all-about-lazy/">能不能成功取决于什么</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-07-09T06:21:10.000Z" itemprop="datePublished">Jul 9, 2016</time>
</div>
      <div class="tags">Tags: 


</div>
    </div>
      
        <p>随着年龄的增长，自己对一些事情的认识在改变，一直想总结一个给年轻同学的帖子，但是总是不能总结太好怎么讲，大概从想讲到现在，已经几个月了，我感觉不讲的话可能就讲不出来了，所以乱谈一下。</p>
<h2 id="从全栈讲起"><a href="#从全栈讲起" class="headerlink" title="从全栈讲起"></a>从全栈讲起</h2><p>什么是全栈？我感觉肯定不是普通人，我觉得全栈至少得是绝顶聪明的人才可以做到，对于他们来讲，有很扎实的 CS 功底，并且知识面非常广泛，还有很多产出，并且这些产出是各个方面的。</p>
<p><img src="https://pic2.zhimg.com/3c8fbae345f5a480ee55174852f392a1_b.png" alt="某种观点"></p>
<p>上面是李笑来老师对于全栈的看法，<a href="https://www.zhihu.com/question/47359997" target="_blank" rel="external">这里</a> 有知乎用户对这个的讨论。</p>
<p>我只是关注到了他那句话里面的「不太笨」，如果他的意思是很聪明的意思，那观点就和我一致了，呵呵。</p>
<p>不得不承认，智商和你能掌握的内容是有关系的，智商不够再怎么努力也很难达到某种顶峰。当然这并不是说，智商不够的就没戏了，换句话说，如果智商不够还不努力，你还是就想想老婆孩子热炕头就算了。</p>
<h2 id="学习别人"><a href="#学习别人" class="headerlink" title="学习别人"></a>学习别人</h2><p>学习别人的成功经验，似乎是一种很好的办法，至少人家那条路是走通了。</p>
<p>这几年流行健身，是吧。看着别人一个一个健身房也好，路边跑步也好，还有奥森跑步的，是不是看着眼红但是又觉得自己周边不具备环境？健身房贵，路边有觉得没有好环境，奥森还有点远，所以我得找一个满足条件的才能去进行这个事情。</p>
<p>还有比如看到有人拿 kindle 看书，是不是觉得我要是有个 kindle 带着方便，肯定可以看好多书，比如一直想学习的 iOS 开发，还有 Java 编程思想，哎呀呀，编程能力大幅增长啊。所以一定要买个 kindle。</p>
<p>等等类似的事情吧，别的不多讲了。就是我想要干什么事情，但是呢最好满足个什么条件，会让我干的更好更有动力。</p>
<p>最后通常的结果呢？步顶多跑几次就会觉得没意思了，kindle 在家里吃灰，然后开始有其他的想法，比如看着人家的 iphone 不错唉，我要是有个，看个 pdf 什么的，比 kindle 方便啊，手机可是一直带着的，所以。。。。</p>
<h2 id="听别人讲"><a href="#听别人讲" class="headerlink" title="听别人讲"></a>听别人讲</h2><p>欧洲人在放难民进来的时候，想的可是我们可怜你们让你们进来，你们应该很满足，不要闹事老实呆着。所以实际上呢？</p>
<p>父母亲戚常见的「我都是为了你好」这种说法，大家估计都听腻了吧。有用么？</p>
<p>微信朋友圈网上各种鸡汤文，比尔盖兹为什么成功，雷军马云的奋斗，这些文章看的时候让人激动人心，看完了貌似就忘记了，是不是？。。</p>
<h2 id="关键在哪里？"><a href="#关键在哪里？" class="headerlink" title="关键在哪里？"></a>关键在哪里？</h2><p>我感觉关键就是一个字「懒」。</p>
<p><img src="http://ww1.sinaimg.cn/mw690/69a2b902jw1f1nn2v6ld1j20go0aswgl.jpg" alt="懒"></p>
<p>2004 年左右在 irc 玩的时候，就有一个网站 <a href="http://lmgtfy.com/?q=%E6%87%92" target="_blank" rel="external">let me google that for you</a>。这个网站就是鄙视那些连 google 都懒得用的，稍微有点问题就问别人。知识都是别人的，把别人当 google 用。</p>
<p>很多人都有类似习惯。我们学习的时候，别人都是引进大门，如果自己不能养成自己知识持续更新的习惯，等到自己连年轻人都跟不上的时候，就很悲哀了。</p>
<p>这个都无关智商，所谓活到老学到老，别人都给你总结好了，懒字一上来，就混吃等死吧。</p>
<p>想要客服懒字，得自己给自己洗脑，让自己能坚持的下去。<a href="http://v.youku.com/v_show/id_XMTY5NTc2MzMy.html" target="_blank" rel="external">老罗的奋斗</a> 里面，老罗讲自己决定要去新东方当老师之前，学习英语的时候，隔段时间就会学不下去，学不下去的时候，看看成功学的书，给自己打打鸡血，就又活蹦乱跳了。</p>
<p>我大概总结几项提升的方向，遇事情想想，应该有好处</p>
<ul>
<li>主动思考解决问题的最佳思路</li>
<li>主动发现问题，改进承担</li>
<li>主动推进事情进展</li>
<li>不要限定自己的范围，不停挑战难点</li>
<li>积极参与到别人的有激情的项目里面</li>
<li>对技术保持强烈的好奇心</li>
</ul>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="all-about-lazy/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="how-to-create-a-blog-with-https-for-free/">如何不花钱建立一个支持 https 的 blog</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-04-10T02:18:28.000Z" itemprop="datePublished">Apr 10, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/blog/">blog</a>
</div>
    </div>
      
        <p>早年的时候要搞 blog 还得弄一个空间，现在，免费的东西越来越多了，感觉共产主义的实现还要靠资本家啊，不过羊毛出在羊身上。。。</p>
<p>要想弄一个免费的 blog，首先你的 blog 内容最好是纯静态网页，如果是类似 php 什么的，那就难找了。使用 jeklly, hexo 这些都可以把 markdown 文件渲染成 html。</p>
<p>然后注册一个 github 或者 gitcafe 等等支持 pages 服务的空间，搞定之后就能得到一个类似于 <a href="http://wd.github.io" target="_blank" rel="external">http://wd.github.io</a> 这样的地址。</p>
<p>然后你注册一个域名（发现标题没起好，这个还是要收费的。。），然后注册 cloudflare，把你的域名的 dns 使用 cloudflare 的，然后在 cloudflare 配置一个 cname 到 wd.github.io。然后建立一个 page rule，强制你的域名使用 ssl。</p>
<p>ok 拉，整个过程就是域名花钱了。可以访问下 <a href="http://wdicc.com">http://wdicc.com</a> 看看效果，会自动跳转到 <a href="https://wdicc.com">https://wdicc.com</a> :D</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="how-to-create-a-blog-with-https-for-free/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="Custom-Netgear-r6300v2-wireless-router/">Custom Netgear r6300v2 wireless router</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-03-27T03:50:38.000Z" itemprop="datePublished">Mar 27, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/linux/">linux</a> <a href="../tags/gfw/">gfw</a> <a href="../tags/router/">router</a>
</div>
    </div>
      
        <p>接 <a href="/Across-the-Great-Wall-we-can-reach-every-corner-in-the-world">科学上网</a>。买了群晖之后，一直通过群晖上面跑一个 haproxy 来做转发。不过心里总觉得有点不爽，毕竟一方面多转发了一次，另外群晖在不使用的时候，还会休眠，又或多或少担心影响休眠（经过测试应该是不影响的，但是..）。所以买了 r6300v2 之后，就琢磨通过路由器做这个事情。</p>
<p>路由器上面搞就有两个选择，一是从 iptables 入手，直接转发出去，另外一个是从软件层面做。</p>
<p>开始搞了几天的 iptables，发现原有系统 iptables 条目还是挺多的，加上路由器翻墙的功能也需要加一些条目，导致尝试了好几天之后总算能够转发过去链接了，但是数据包过不去，为了调试就开始打算在路由器安装 tcpdump。然后找到了 <a href="https://github.com/Entware/entware" target="_blank" rel="external">https://github.com/Entware/entware</a> ，配置好之后可以使用 opkg 来安装包。包列表可以参考这里 <a href="http://pkg.entware.net/binaries/armv7/Packages.html" target="_blank" rel="external">http://pkg.entware.net/binaries/armv7/Packages.html</a> ，这个路由器是 armv7 版本的 cpu。</p>
<p>安装 opkg 之前先得了解下，梅林固件分两部分存储，一部分是系统区，一部分是自定义区。系统区应该是你刷的固件所在的地方，是不能修改的，自定义区是可以存放一些自己定义的脚本的。每次系统启动的时候，你的一些自定义的东西都是存在自定义区加载的。自定义区就是 /jffs 分区。想要使用，得在 系统管理 -&gt; 系统设置 里面，打开 JFFS 的配置，允许执行上面的脚本。</p>
<p>因为系统自带的 /jffs 分区只有 60M 左右，而我们装包的时候很容易就超过这个限制了，我现在已经用了 8xM 空间。所以最好还是用一个 u 盘来做这个事情。每次想要自动加载 u 盘，启动 u 盘里面的程序的话，还需要一些自定义的脚本来做这个事情。</p>
<p>先把 opkg 配置好，需要先准备好 /opt 目录。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">mkdir</span> -<span class="keyword">p</span> /tmp/<span class="keyword">opt</span></div><div class="line">mount -t ext4 -<span class="keyword">o</span> rw,noatime /dev/sda1 /<span class="keyword">opt</span></div></pre></td></tr></table></figure>
<p>上面的 /dev/sda1 是 u 盘，ext4 是文件系统类型，按照自己的修改一下。一般 u 盘插上去就会自动挂载，df 看一下就知道是哪个名字了。系统配置里面有个 dlna 的配置记得关掉，否则他会读 u 盘导致你不能 umount 之类，或者 kill 掉一个叫做 minidlna 的进程也可以。</p>
<p>然后参考 <a href="https://github.com/Entware/entware" target="_blank" rel="external">https://github.com/Entware/entware</a> 操作就可以了，可以看到他会在 /opt 给你安装一陀东西。因为这个是 u 盘，所以东西重启也不会丢失。</p>
<p>然后参考<a href="https://github.com/RMerl/asuswrt-merlin/wiki/User-scripts" target="_blank" rel="external">梅林的 wiki</a>，它允许用户在 <code>/jffs/scripts</code> 自定义一些启动脚本，来支持我们自动挂载和启动 u 盘上面的程序。</p>
<p>post-mount 内容如下，前面几个注释的是调试用的。最后一个 if 里面内容是执行一些 opkg 安装的程序的启动脚本，这个后面说。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"></div><div class="line"><span class="comment">#echo $(date) &gt; /tmp/000service-start</span></div><div class="line"><span class="comment">#echo "$1" &gt;&gt; /tmp/000service-start</span></div><div class="line"><span class="comment">#ls /dev/sda* &gt;&gt; /tmp/000service-start</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ -b /dev/sda1 ];<span class="keyword">then</span></div><div class="line">        mkdir -p /tmp/opt</div><div class="line">        mount -t ext4 -o rw,noatime /dev/sda1 /opt</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ -x /opt/bin/opkg ];<span class="keyword">then</span></div><div class="line">        /opt/etc/init.d/rc.unslung start</div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure></p>
<p>要记得 <code>sudo chmod +x post-mount</code>，然后可以重启路由器看看是不是启动之后就能看到 /opt 有了你上次安装的程序了。</p>
<p>上面一阶段搞定之后，就可以装一些软件了，比如我装了 vim, tcpdump，bind-dig, haproxy。opkg 的命令使用可以参考这里 <a href="https://wiki.openwrt.org/doc/techref/opkg" target="_blank" rel="external">https://wiki.openwrt.org/doc/techref/opkg</a> 。</p>
<p>接着上面的话题，本来打算装好 tcpdump 来调试的，然后发现可以比较方便的启动 haproxy 之后，就打算用 haproxy 弄了，路由表太多，分析比较麻烦，还是走简单的吧。。</p>
<p><code>/opt/etc/haproxy.cfg</code> 如下，把 IP 和 PORT 改成你自己的。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">global</span></div><div class="line">        ulimit-n  <span class="number">331071</span></div><div class="line"></div><div class="line">defaults</div><div class="line">        log <span class="meta">global</span></div><div class="line">        mode    tcp</div><div class="line">        <span class="meta">option</span>  dontlognull</div><div class="line">        timeout connect <span class="number">1000</span></div><div class="line">        timeout client <span class="number">150000</span></div><div class="line">        timeout server <span class="number">150000</span></div><div class="line"></div><div class="line">frontend <span class="built_in">ss</span>-<span class="keyword">in</span></div><div class="line">        bind *:本机PORT</div><div class="line">        default_backend <span class="built_in">ss</span>-<span class="keyword">out</span></div><div class="line"></div><div class="line">backend <span class="built_in">ss</span>-<span class="keyword">out</span></div><div class="line">        server server1 <span class="built_in">IP</span>:远端PORT maxconn <span class="number">20480</span></div></pre></td></tr></table></figure>
<p><code>/opt/etc/init.d/S001haproxy.sh</code> 如下，<code>sudo chmod +x /etc/init.d/S001haproxy.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"></div><div class="line">haproxy_bin=/opt/sbin/haproxy</div><div class="line">haproxy_cfg=/opt/etc/haproxy.cfg</div><div class="line">pid=/opt/var/run/haproxy.pid</div><div class="line"></div><div class="line">action=<span class="variable">$1</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$action</span>"</span> ];<span class="keyword">then</span></div><div class="line">        <span class="built_in">printf</span> <span class="string">"Usage: <span class="variable">$0</span> &#123;start|stop|restart&#125;\n"</span> &gt;&amp;2</div><div class="line">        <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$action</span>"</span> <span class="keyword">in</span></div><div class="line">        start)</div><div class="line">                <span class="variable">$haproxy_bin</span> <span class="_">-f</span> <span class="variable">$haproxy_cfg</span> -p <span class="variable">$pid</span> -D</div><div class="line">                ;;</div><div class="line">        stop)</div><div class="line">                <span class="built_in">kill</span> $(cat <span class="variable">$pid</span>)</div><div class="line">                ;;</div><div class="line">        restart)</div><div class="line">                <span class="built_in">kill</span> $(cat <span class="variable">$pid</span>)</div><div class="line">                <span class="variable">$haproxy_bin</span> <span class="_">-f</span> <span class="variable">$haproxy_cfg</span> -p <span class="variable">$pid</span> -D</div><div class="line">                ;;</div><div class="line"><span class="keyword">esac</span></div></pre></td></tr></table></figure>
<p>因为前面在 post-mount 最后一个 if 里面的语句，这样启动路由器就会自动启动 haproxy 了。</p>
<p>想使用这个端口转发，还需要在路由器配置界面里面增加一个到路由器 ip 的映射，然后还需要一个 <code>/jffs/scripts/firewall-start</code> 如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"></div><div class="line">iptables -I INPUT -i ppp0 -p tcp --destination-port PORT -j ACCEPT</div></pre></td></tr></table></figure>
<p>我使用的过程中还发现一个问题，pkg.entware.net 貌似被墙了。。虽然配置了翻墙但是不太明白为什么路由器上面时好时坏，而我局域网内的 mac 访问总是 ok 的，很奇怪。路由器上面不能访问有个办法是通过 mac 代理一下。</p>
<p>mac 上面启动一个 ngx，配置如下，使用 nginx -p ./ -c nginx.conf 启动。<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="section">events</span> &#123;</div><div class="line">  <span class="attribute">worker_connections</span> <span class="number">1024</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="section">http</span> &#123;</div><div class="line">  <span class="section">server</span> &#123;</div><div class="line">      <span class="attribute">listen</span> <span class="number">0.0.0.0:8000</span>;</div><div class="line">      <span class="attribute">location</span> / &#123;</div><div class="line">           <span class="attribute">proxy_pass</span> http://pkg.entware.net;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后修改路由器上面 /opt/etc/opkg.conf <code>src/gz packages http://MAC_IP:8000/binaries/armv7</code>，然后就可以了。</p>
<p>写完自己看发现这不是一份操作指南，只能算是一些提示，如果有人照着做能不能成功可能还是得看自己。。。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="Custom-Netgear-r6300v2-wireless-router/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="lua-metatable/">lua metatable</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-03-27T02:48:26.000Z" itemprop="datePublished">Mar 27, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/lua/">lua</a>
</div>
    </div>
      
        <figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">t = <span class="built_in">setmetatable</span>(&#123; bar = <span class="number">4</span>, foo = <span class="number">7</span> &#125;, &#123; __index = &#123; foo = <span class="number">3</span> &#125; &#125;)</div><div class="line"></div><div class="line"><span class="built_in">print</span>(t.foo)  <span class="comment">-- 7</span></div><div class="line"><span class="built_in">print</span>(t.bar)  <span class="comment">-- 4</span></div><div class="line"></div><div class="line">t = <span class="built_in">setmetatable</span>(&#123;  &#125;, &#123; __index = &#123; foo = <span class="number">3</span>&#125; &#125;)</div><div class="line"></div><div class="line"><span class="built_in">print</span>(t.foo)  <span class="comment">-- 3</span></div><div class="line"><span class="built_in">print</span>(t.bar)  <span class="comment">-- nil</span></div><div class="line"></div><div class="line">fuc = <span class="function"><span class="keyword">function</span> <span class="params">(t,k)</span></span></div><div class="line">    <span class="keyword">if</span> k == <span class="string">'foo'</span> <span class="keyword">then</span></div><div class="line">        <span class="keyword">return</span> <span class="built_in">rawget</span>(t, <span class="string">'bar'</span>)</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">t = <span class="built_in">setmetatable</span>(&#123;   &#125;, &#123; __index = fuc &#125;)</div><div class="line"></div><div class="line"><span class="built_in">print</span>(t.foo)  <span class="comment">-- 3</span></div><div class="line"><span class="built_in">print</span>(t.bar)  <span class="comment">-- nil</span></div><div class="line"><span class="built_in">print</span>(t.ff)</div></pre></td></tr></table></figure>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="lua-metatable/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="Across-the-Great-Wall-we-can-reach-every-corner-in-the-world/">Across the Great Wall, we can reach every corner in the world</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-03-20T12:39:53.000Z" itemprop="datePublished">Mar 20, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/gfw/">gfw</a>
</div>
    </div>
      
        <p>科学上网估计是每个搞 IT 的人必须要掌握的知识了。简单讲讲我目前使用的一些方法。</p>
<h2 id="国外服务"><a href="#国外服务" class="headerlink" title="国外服务"></a>国外服务</h2><p>首先肯定需要先有个国外的资源，比如买专业的 vpn ss 服务等。数据经过第三方都不一定那么可靠，我的主力邮箱在 gmail，可不想被攻破，所以我选择了自己购买和搭建服务。</p>
<p>我买的是 linode 的服务，最便宜的是 10$ 一个月。也可以买一些美国的 kvm 或者 zen 的虚拟机，有比较便宜的一个月可能才不到 1$，当然这种便宜的一般很快就会卖没，得看运气。我的 linode 是和 3 个基友一起合租的，这样大家每个人一年也就 300 来块钱，也就一顿海底捞（我这两年非常喜欢用饭钱来衡量消费，吃饭可是天天都有的，但是有些消费，比如买软件，买服务这些一般都是一年或者几年才一次，比起吃饭真的便宜多了），一般都能承担的吧。</p>
<p>早期我买过一些 ssh 服务，速度不稳定，因为很难限制超售。后来还买过云梯，他们提供的节点比较多速度还不错。</p>
<p>有了 vps 搭一个 ssserver 就是很简单的了，就不多说了。服务器上面我还配置了 ocserv 这个支持 cisco 客户端的 vpn 服务。当然并不是所有 vps 都支持，有的 vps 没有 tun 设备，跑不起来，买的时候要注意。</p>
<h2 id="ssh-方式"><a href="#ssh-方式" class="headerlink" title="ssh 方式"></a>ssh 方式</h2><p>使用 ssh 方式的时候，最早是直接 ssh 链接弄一个 socks 端口给本地，然后本地使用 pac 配合。</p>
<p>后来有段时间被断的不行，就试了 stunnel，可以把 ssh 转为 https 服务，这样就可以跑在 443 端口了，和其他 https 服务比较难区分。可以起点作用。</p>
<p>这个方式没法支持手机。</p>
<h2 id="使用-ngx"><a href="#使用-ngx" class="headerlink" title="使用 ngx"></a>使用 ngx</h2><p>有段时间还使用 hosts 文件加 ngx 反向代理还翻墙。ngx 上面配置 google.com 和 twitter.com 的反向代理，然后手机或者电脑上面配置 hosts 指向 ngx。就可以实现翻墙了。不过因为都是 https 的网站，所以服务器上面得配置 https 的服务，证书得弄到电脑或者手机上面信任才行。</p>
<p>这个手机想要支持的话，ios 比较麻烦，必须得越狱。</p>
<h2 id="vpn-方式"><a href="#vpn-方式" class="headerlink" title="vpn 方式"></a>vpn 方式</h2><p>早期用 vpn 方式的时候，pptp 可以搭配 <a href="https://github.com/fivesheep/chnroutes" target="_blank" rel="external">chnrouts</a> 来实现国外和国内走不同的路由。用起来也不错，不过问题是全局的有时候切换也不方便，并且有时候还需要连公司的 vpn 路由一乱就麻烦了。</p>
<p>pc 上面选择比较多。手机上面，试过 anyconnect，缺点就是全局翻墙（我试过让 server 只 push fb twitter 的路由，但是维护麻烦，效果也不好）。anyconnect 比较赞的地方是他的链接 cookie 可以设置比较长的有效期，这样网络切换什么的临时断开之后自动重连也不需要输入密码。哦，当然，我的 anyconnect 和后面提到的 openvpn 都是通过自己签的证书来认证的，也不需要输入密码。</p>
<p>后来用过 openvpn，openvpn 是基友维护的。他的思路很赞。</p>
<p>他买了一台 server 放家里，家里是联通 adsl 24h 联机，然后 server 上面跑一个 openvpn 的服务器端给手机连接用，服务器上面再通过 vpn 和 vps 的 vpn 链接，同时这机器配置只有国外路由才走 vps，国内都是直接链接。大概链路就是  手机 -&gt; 家里的 server -&gt; vps。如果是国内的网站，就直接通过家里的 server 访问了，比国外的 vps 访问速度快。</p>
<p>这个方法还有好处是有时候一些公开的场合链接一些 wifi 的时候，很不安全，而通过 vpn 之后，数据都是加密的，就安全多了。我在 surge 之前，在 hosts 不能用之后，基本都是用这个和 anyconnect。</p>
<h2 id="使用-ss"><a href="#使用-ss" class="headerlink" title="使用 ss"></a>使用 ss</h2><p>开始使用 ss 的时候，是使用 goagentx （貌似已经比较难找到下载了）的，这个工具异常好用，支持切换全局还是使用 pac 非常方便。pac 推荐使用 <a href="https://github.com/JinnLynn/genpac" target="_blank" rel="external">genpac</a> 来维护 pac，放到 dropbox 里面就可以四处用了。</p>
<p>我有相当长一段时间都是这么翻墙的。直到后面 ios 9 放开网络权限之后，出来了 surge。surge 现在卖的太贵了，不建议购买，最近好像看到有一些新的软件也在出现，可以考虑。</p>
<p>surge 出来之后，ios 基本就是用这个了。</p>
<p>surge 也有 mac 版本。如果没有，使用 ss mac 版本也可以，搭配 pac 可以做到透明。</p>
<h2 id="应对不稳定的网络情况"><a href="#应对不稳定的网络情况" class="headerlink" title="应对不稳定的网络情况"></a>应对不稳定的网络情况</h2><p>家里是联通 adsl，链接我的 linode 一直都比较稳定，速度不错也没有丢包。公司访问 linode 有时候丢包比较严重，不过也将就用了。去年去长沙出差，那边完全访问不能把我搞的很痛苦。回来就开始琢磨怎么搞。</p>
<p>上面基友的思路提醒了我，就是自己家里一台 server 建长链接，然后在外面翻墙先连家里。但是家里的路由器完全不能定制，后来发现我的群晖的 nas 可以装 haproxy，就搞定这个事情了。在路由器上面映射一个端口给群晖，群晖上面跑 haproxy 转发到 linode。给路由器弄了个 ddns，在外面翻墙都连接这个 dns。</p>
<p>群晖上面跑 haproxy 还不影响硬盘休眠，还挺不错。这样就彻底解决了我翻墙的问题了。</p>
<p>但是遇到家里停电断网就虾米了。。</p>
<h2 id="家里的全局翻墙方案"><a href="#家里的全局翻墙方案" class="headerlink" title="家里的全局翻墙方案"></a>家里的全局翻墙方案</h2><p>前段时间换了 Netgear R6300v2，才发现我之前错过了好多好玩的东西。刷了个国内论坛定制的梅林 rom，自带了 ss 客户端，并且配置的非常完美，支持多种翻墙策略，具体就不细说了。就说现在的效果吧。</p>
<p>直接映射了端口到 linode 的 ss，并且也支持 ddns（我用的 3322 的），这样 nas 上面的 haproxy 就彻底可以不用了。</p>
<p>路由器跑了 ss 客户端，加 redsocks2 和 dns2proxy，实现了国内网站直连，国外根据域名匹配到列表里面的服务器通过 ss 链接。这样家里所有的终端，不需要跑任何服务，就可以无缝翻墙了。我的 ps4，apple tv，ipad 上面的 yotube 都可以访问了。然后还支持黑名单，我把 nas 加进去了，防止使用 bt 下载的时候跑到国外流量。</p>
<p>这样我目前手机和 mac 都是直接通过 surge，国外流量通过 3322 的 dns 先链接到路由器，然后转发到 linode 实现翻墙。</p>
<h2 id="目前唯一的问题"><a href="#目前唯一的问题" class="headerlink" title="目前唯一的问题"></a>目前唯一的问题</h2><p>mac 版本的 surge，还不能自己配置网络，这样临时想关掉代理的时候，就比较麻烦，得去网络配置里面关。也不能很简单的配置让全部流量走 proxy，有时候需要测试下什么的，就比较麻烦。所以我现在有时候还会使用 goagentx 辅助一下。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="Across-the-Great-Wall-we-can-reach-every-corner-in-the-world/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="setup-proxy-for-emacs/">setup proxy for emacs</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-02-27T13:55:20.000Z" itemprop="datePublished">Feb 27, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/emacs/">emacs</a> <a href="../tags/osx/">osx</a>
</div>
    </div>
      
        <p>我在 mac 上面使用 emacs 都是使用 daemon + emacsclient 模式。使用 <code>paradox</code> 包管理(其实就是比 <code>list-package</code> 稍微多了一点功能’)，但是因为那些包什么的信息都在国外的网站，还有 github 什么的，导致速度巨慢甚至连不上，关键 emacs 单线程还得卡着别的操作，所以挺讨厌的(其实 paradox 提供了异步更新的方式，不会阻塞现在进程，但是有时候会不知道进度…)。</p>
<p>思路就是使用 <code>proxychains</code>。</p>
<p>新建一个 <code>/Library/LaunchAgents/gnu.emacs.daemon.plist</code> 文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="meta">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"</span></div><div class="line">    "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</div><div class="line"> <span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">dict</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>Label<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>gnu.emacs.daemon<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>ProgramArguments<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">array</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>/usr/local/bin/proxychains4<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>-f<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>/Users/wd/.proxychains/proxychains.conf<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>/usr/local/opt/emacs-mac/bin/emacs<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>--daemon<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">key</span>&gt;</span>RunAtLoad<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">true</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">key</span>&gt;</span>ServiceDescription<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">string</span>&gt;</span>Gnu Emacs Daemon<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">key</span>&gt;</span>UserName<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">string</span>&gt;</span>wd<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></div></pre></td></tr></table></figure>
<p>其中 <code>/Users/wd/.proxychains/proxychains.conf</code> 文件的内容如下</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">strict_chain</div><div class="line">proxy_dns</div><div class="line">remote_dns_subnet <span class="number">224</span></div><div class="line">tcp_read_time_out <span class="number">15000</span></div><div class="line">tcp_connect_time_out <span class="number">8000</span></div><div class="line">localnet <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.0</span><span class="number">.0</span><span class="number">.0</span></div><div class="line">localnet <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.0</span><span class="number">.0</span><span class="number">.0</span></div><div class="line">localnet <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.240</span><span class="number">.0</span><span class="number">.0</span></div><div class="line">localnet <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">255.255</span><span class="number">.0</span><span class="number">.0</span></div><div class="line">quiet_mode</div><div class="line"></div><div class="line">[ProxyList]</div><div class="line">#socks5 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">1080</span></div><div class="line">http <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">6152</span></div></pre></td></tr></table></figure>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="setup-proxy-for-emacs/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="use-gearman-to-distribute-you-nagios-check/">use gearman to distribute you nagios check</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-01-18T07:14:36.000Z" itemprop="datePublished">Jan 18, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/nagios/">nagios</a> <a href="../tags/gearman/">gearman</a>
</div>
    </div>
      
        <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="gearman"><a href="#gearman" class="headerlink" title="gearman"></a>gearman</h2><p>需要 boost &gt; 1.39, libevent-devel, libuuid-devel, gperf<br>需要 gcc &gt;= 4.2</p>
<p>export CC=gcc44<br>export CC=g++44</p>
<h2 id="mod-gearman"><a href="#mod-gearman" class="headerlink" title="mod-gearman"></a>mod-gearman</h2><p>libtool-ltdl-devel ncurses-devel<br>–with-gearman</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>gearman 分为几个模块</p>
<ul>
<li>mod_gearman: 负责把 nagios 中的检查任务发给 gearmand job server</li>
<li>gearmand: 负责接收任务，分配给 worker 执行。这个是个通用的队列管理服务。</li>
<li>gearman_workder: 负责消费 gearmand 中的 job。</li>
</ul>
<p>其中 <code>mod_gearman</code> 的代码里面包括了上面提到的 mod_gearman 和 gearman_workder。</p>
<p>所以规划好 gearmand 启动的机器，以及你的 worker 机器。其中要注意 worker 机器上面是会执行所有[1] nagios 监控</p>
<p>需要配置的文件有几个</p>
<ul>
<li>nagios.cfg 增加 broker</li>
<li>mod-gearman/etc/mod_gearman/mod_gearman_neb.conf broker 的配置文件</li>
<li>mod-gearman/etc/mod_gearman/mod_gearman_worker.conf workder 的配置文件</li>
</ul>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><ul>
<li>先启动 gearmand 使用 mod-gearman/etc/init.d/gearmand 这个脚本。</li>
<li>启动 worker 使用 mod-gearman/etc/init.d/mod_gearman_worker 这个脚本。启动之后可以用 gearman_top 看到多了一些队列。</li>
<li>重启 nagios</li>
</ul>
<p>确认 nagios.log 里面正常加载了 gearman，然后看 gearman_top 里面开始有一些 run 的 job 了。</p>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><p>基本上使用 gearman 还算是对用户透明，需要配置的东西不多，默认配置就可以跑。</p>
<p>一般使用 gearman 的时候都是现有 nagios 遇到瓶颈了，这个时候扩展的时候需要注意下，第一步可以在 nagios 机器上面（或者弄一台新的机器）做 gearman 的 job server，然后在 nagios 的机器上面跑一个 worker，这样基本就是 0 配置都可以跑起来，不会有任何问题。</p>
<p>第一步完成之后就会需要增加 worker，这个时候就要注意了，新的 worker 机器上面，需要在相同的路径下面包括所有你用到的 nagios plugin（包括自己写的，也包括这些 plugin 依赖的其他内容，比如临时文件路径，配置文件等），否则分发过来的 job 会执行不成功。</p>
<p>这个时候有个办法，就是把原来机器的 nagios 相关目录通过 nfs 共享给其他机器（但是得注意二进制程序是兼容的）。</p>
<p>另外如果需要测试一下新的 worker，也可以通过配置只让 worker 执行某些 servicegroup 或者 hostgroup 的任务。要注意这个时候需要配置 service, eventhandler, host 都为 no，然后配置 servicegroups 或者 hostgroups。</p>
<h1 id="Footnotes"><a href="#Footnotes" class="headerlink" title="Footnotes"></a>Footnotes</h1><p>[1] 其实 worker 是可以被配置为只处理某些监控的，这个后面会讲。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="use-gearman-to-distribute-you-nagios-check/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="use-ivy-to-replace-isearch/">use ivy to replace isearch</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2016-01-10T11:22:20.000Z" itemprop="datePublished">Jan 10, 2016</time>
</div>
      <div class="tags">Tags: 

<a href="../tags/emacs/">emacs</a>
</div>
    </div>
      
        <p>之前习惯使用 <code>isearch</code> 来搜索了，最近看别人使用 <code>ivy</code> 看着心痒痒的，就想试试看。其实 ivy 的效果和 <code>swoop</code> 很像，不过区别是 ivy 是在 minibuffer 来显示可选信息的，swoop 是在一个 buffer 显示的。有洁癖的可能稍微计较一下。</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">;; ivy swiper</span></div><div class="line">(<span class="name">defun</span> wd-swiper-at-point ()</div><div class="line">  <span class="string">"Pull next word from buffer into search string."</span></div><div class="line">  (<span class="name">interactive</span>)</div><div class="line">  (<span class="name"><span class="builtin-name">let</span></span> (<span class="name">query</span>)</div><div class="line">    (<span class="name">with-ivy-window</span></div><div class="line">      (<span class="name"><span class="builtin-name">let</span></span> ((<span class="name">tmp</span> (<span class="name">symbol-at-point</span>)))</div><div class="line">        (<span class="name">setq</span> query tmp)))</div><div class="line">    (<span class="name"><span class="builtin-name">when</span></span> query</div><div class="line">      (<span class="name">insert</span> (<span class="name">format</span> <span class="string">"%s"</span> query))</div><div class="line">      )))</div><div class="line"></div><div class="line">(<span class="name">use-package</span> ivy</div><div class="line">  :config</div><div class="line">  (<span class="name">ivy-mode</span> <span class="number">1</span>)</div><div class="line">  (<span class="name">setq</span> ivy-use-virtual-buffers t)</div><div class="line">  (<span class="name">set-variable</span> <span class="symbol">'ivy-on-del-error-function</span> '(lambda()))</div><div class="line">  )</div><div class="line"></div><div class="line">(<span class="name">use-package</span> swiper</div><div class="line">  :config</div><div class="line">  (<span class="name">global-set-key</span> <span class="string">"\C-s"</span> <span class="symbol">'swiper</span>)</div><div class="line">  (<span class="name">define-key</span> swiper-map (<span class="name">kbd</span> <span class="string">"C-w"</span>) <span class="symbol">'wd-swiper-at-point</span>)</div><div class="line">  (<span class="name">define-key</span> swiper-map (<span class="name">kbd</span> <span class="string">"C-f"</span>) <span class="symbol">'swiper-avy</span>)</div><div class="line">  )</div></pre></td></tr></table></figure>
<p>我大致做了上面几个设定，<code>\C-s</code> 绑定了 swiper，启动 swiper 之后用 <code>\C-w</code> 可以快速把光标位置的 symbol 放到 minibuffer 来搜索。然后 swiper 和 isearch 有个区别是，默认情况下，swiper 如果 minibuffer 没有内容，按 backspace 会退出，这个和 isearch 的习惯不一样，把 <code>ivy-on-del-error-function</code> 重新绑定一下就可以了。</p>
<p>ivy 默认会绑定一个快捷键是在你 minibuffer 输入一些内容之后，会出来很多匹配结果，这个时候可以按 <code>C-&#39;</code> 调用 <code>swiper-avy</code> 方便你快速定位，也挺好用的。不过我这里不好用，不知道怎么回事，只好重新绑定了一下。</p>
<p>还可以在 swiper 查询阶段按 <code>M-q</code> 进入替换模式。</p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="use-ivy-to-replace-isearch/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

  <article class="post">
	<h2 class="title">
		<a href="libmcrypt-ffi-module/">基于 ffi 的 libmcrypt 加密模块</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: <time datetime="2015-07-05T12:55:11.000Z" itemprop="datePublished">Jul 5, 2015</time>
</div>
      <div class="tags">Tags: 


</div>
    </div>
      
        <p>openresty 提供了 luajit 的支持，luajit 又提供了 ffi 库的支持。通过 ffi 可以很方便的调用 c 库的一些方法。</p>
<p>我在项目里面用到了加解密，因为需要各语言支持，使用了 libmcrypt 库。之前通过 c 模块完成了在 lua 里面加密，在 perl 里面解密。有了 ffi 就可以使用纯 lua 模块搞定了。</p>
<p>代码写的比较丑，有使用加解密的需求的可以参考下，另外计划写其他模块的也可以参考下。如下</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> ffi = <span class="built_in">require</span> <span class="string">'ffi'</span></div><div class="line"><span class="keyword">local</span> ffi_new = ffi.new</div><div class="line"><span class="keyword">local</span> ffi_str = ffi.<span class="built_in">string</span></div><div class="line"><span class="keyword">local</span> ffi_copy = ffi.copy</div><div class="line"><span class="keyword">local</span> <span class="built_in">setmetatable</span> = <span class="built_in">setmetatable</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> _M = &#123; &#125;</div><div class="line"><span class="keyword">local</span> mt = &#123; __index = _M &#125;</div><div class="line"></div><div class="line">ffi.cdef<span class="string">[[</span></div><div class="line">struct CRYPT_STREAM;</div><div class="line">typedef struct CRYPT_STREAM *MCRYPT;</div><div class="line"></div><div class="line">MCRYPT mcrypt_module_open(char *algorithm,</div><div class="line">                          char *a_directory, char *mode,</div><div class="line">                          char *m_directory);</div><div class="line"></div><div class="line">int mcrypt_generic_init(const MCRYPT td, void *key, int lenofkey,</div><div class="line">                        void *IV);</div><div class="line"></div><div class="line">int mcrypt_generic_deinit(const MCRYPT td);</div><div class="line">int mcrypt_generic_end(const MCRYPT td);</div><div class="line">int mdecrypt_generic(MCRYPT td, void *plaintext, int len);</div><div class="line">int mcrypt_generic(MCRYPT td, void *plaintext, int len);</div><div class="line">int mcrypt_module_close(MCRYPT td);</div><div class="line"></div><div class="line">]]</div><div class="line"></div><div class="line"><span class="keyword">local</span> mcrypt = ffi.<span class="built_in">load</span>(<span class="string">'libmcrypt.so.4'</span>)</div><div class="line"></div><div class="line">_M.new = <span class="function"><span class="keyword">function</span> <span class="params">(self)</span></span></div><div class="line">    <span class="keyword">local</span> cipher = <span class="string">'blowfish'</span></div><div class="line">    <span class="keyword">local</span> mode = <span class="string">'cbc'</span></div><div class="line"></div><div class="line">    <span class="keyword">local</span> c_cipher = ffi_new(<span class="string">"char[9]"</span>, cipher)</div><div class="line">    <span class="keyword">local</span> c_mode = ffi_new(<span class="string">"char[4]"</span>, mode)</div><div class="line"></div><div class="line">    <span class="keyword">local</span> td = mcrypt.mcrypt_module_open(c_cipher, <span class="keyword">nil</span>, c_mode, <span class="keyword">nil</span>)</div><div class="line">    <span class="keyword">return</span> <span class="built_in">setmetatable</span>( &#123; _td = td &#125;, mt )</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">_M.encrypt = <span class="function"><span class="keyword">function</span><span class="params">(self, key, raw)</span></span></div><div class="line">    <span class="keyword">local</span> iv_len = <span class="number">8</span></div><div class="line">    <span class="keyword">local</span> td = self._td</div><div class="line"></div><div class="line">    <span class="keyword">local</span> c_key = ffi_new(<span class="string">"char[?]"</span>, #key+<span class="number">1</span>, key)</div><div class="line">    <span class="keyword">local</span> c_iv = ffi_new(<span class="string">"char[9]"</span>, key)</div><div class="line">    <span class="keyword">local</span> c_raw = ffi_new(<span class="string">"char[?]"</span>, #raw+<span class="number">1</span>, raw)</div><div class="line"></div><div class="line">    mcrypt.mcrypt_generic_init(td, c_key, #key, c_iv)</div><div class="line">    mcrypt.mcrypt_generic(td, c_raw, #raw )</div><div class="line">    mcrypt.mcrypt_generic_deinit(td)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ffi_str(c_raw, ffi.sizeof(c_raw)<span class="number">-1</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">_M.decrypt = <span class="function"><span class="keyword">function</span><span class="params">(self, key, raw)</span></span></div><div class="line">    <span class="keyword">local</span> iv_len = <span class="number">8</span></div><div class="line">    <span class="keyword">local</span> td = self._td</div><div class="line"></div><div class="line">    <span class="keyword">local</span> c_key = ffi_new(<span class="string">"char[?]"</span>, #key+<span class="number">1</span>, key)</div><div class="line">    <span class="keyword">local</span> c_iv = ffi_new(<span class="string">"char[9]"</span>, key)</div><div class="line">    <span class="keyword">local</span> c_raw = ffi_new(<span class="string">"char[?]"</span>, #raw+<span class="number">1</span>, raw)</div><div class="line"></div><div class="line">    mcrypt.mcrypt_generic_init(td, c_key, #key, c_iv)</div><div class="line">    mcrypt.mdecrypt_generic(td, c_raw, #raw )</div><div class="line">    mcrypt.mcrypt_generic_deinit(td)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ffi_str(c_raw, ffi.sizeof(c_raw)<span class="number">-1</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">_M.close = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></div><div class="line">    <span class="keyword">local</span> td = self._td</div><div class="line">    <span class="keyword">if</span> td <span class="keyword">then</span></div><div class="line">        mcrypt.mcrypt_module_close(td)</div><div class="line">     <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> _M</div></pre></td></tr></table></figure>
<p>使用方法比较简单，代码里面写死了是 <code>blowfish</code> 的 <code>cbc</code> 模式，并且 iv 使用 key 的前 8 个字符<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">local</span> mcrypt = <span class="keyword">require</span> <span class="string">"mcrypt"</span></div><div class="line"><span class="built_in">local</span> m = mcrypt:<span class="literal">new</span>()</div><div class="line"></div><div class="line">-- 一系列加解密</div><div class="line"><span class="built_in">local</span> en = m:encrypt(<span class="string">'xxx'</span>,<span class="string">'yyyy'</span>)</div><div class="line"><span class="attr">...</span></div><div class="line"><span class="built_in">local</span> de = m:decrypt(<span class="string">'xxx'</span>, yyyy<span class="string">')</span></div><div class="line"></div><div class="line">-- 最后关闭</div><div class="line">m:close()</div></pre></td></tr></table></figure></p>

      
	</div>

<div class="meta">
	
		<span class="comments"><a href="libmcrypt-ffi-module/index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


  <nav id="pagenavi">
    
    
        <a href="/page/2/" class="next">Next</a>
    
  <div class="center"><a href="/archives/index.html">Blog Archives</a></div>
  </nav>


    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2016

    wd
. Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> |
    Theme is <a href="https://github.com/wd/hexo-fabric">hexo-fabric</a>, fork from <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script>
 <!-- Delete or comment this line to disable Fancybox -->



<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
