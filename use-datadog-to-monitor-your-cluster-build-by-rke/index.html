<!doctype html><html lang=en><head><title>Use Datadog to Monitor Your Cluster Build by Rke &ndash; wd and cc</title>
<meta name=description content="Good good study, day day up!"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://wdicc.com/css/palettes/base16-dark.css><link rel=stylesheet href=https://wdicc.com/css/risotto.css><link rel=stylesheet href=https://wdicc.com/css/custom.css><link rel=icon href=https://wdicc.com/favicon.ico></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><h1 class=page__logo><a href=https://wdicc.com/ class=page__logo-inner>wd and cc</a></h1><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/posts/ title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=" title>Search</a></li><li class=main-nav__item><a class=nav-main-item href=https://wdicc.com/atom.xml title>subscribe</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Use Datadog to Monitor Your Cluster Build by Rke</h1></header><div class=content__body><p>There are many tools you can choose when you want to build your kubernetes cluster, we use Rancher Kubernetes Engine (RKE) to build our kubernetes cluster.</p><p>We run datadog as daemonset in our cluster, and datadog has auto discovery feature to discovery pods/containers need to check. When we deployed a redis database, datadog will notice that and run checks against the redis pods, we didn't need to do any configurations.</p><p>Datadog auto discovery also supports core kubernetes components, like APIServer, KubeScheduler, KubeProxy, etc. But when you setup you cluster by using RKE, you will find the auto discovery didn't work for these components.</p><p>The auto discovery feature for these core components relies on <a href=https://docs.datadoghq.com/agent/guide/ad_identifiers/>autodiscovery container identifiers(ad_identifiers)</a>, the image name or image short name need to match the default <code class=verbatim>ad_identifiers</code> settings for these components. Unfortunately, rancher uses <code class=verbatim>rancher/hyperkube</code> to build most of the core components, they all have the same image name.</p><p>The <code class=verbatim>ad_identifiers</code> also support to set to a container label, but that will need use to rebuild the container image to add the label, it's a mission impossible too. After some tests, I found the way to run checks against these containers by use annotations.</p><p>Datadog supports us to <a href="https://docs.datadoghq.com/agent/kubernetes/integrations/?tab=kubernetes#datadog-redis-integration">use annotations</a> to notify datadog that we need to run check on some urls.</p><div class="src src-yaml"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#75715e># (...)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;&lt;POD_NAME&gt;&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ad.datadoghq.com/&lt;CONTAINER_IDENTIFIER&gt;.check_names</span>: <span style=color:#e6db74>&#39;[&lt;INTEGRATION_NAME&gt;]&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ad.datadoghq.com/&lt;CONTAINER_IDENTIFIER&gt;.init_configs</span>: <span style=color:#e6db74>&#39;[&lt;INIT_CONFIG&gt;]&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ad.datadoghq.com/&lt;CONTAINER_IDENTIFIER&gt;.instances</span>: <span style=color:#e6db74>&#39;[&lt;INSTANCE_CONFIG&gt;]&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># (...)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;&lt;CONTAINER_IDENTIFIER&gt;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># (...)</span></span></span></code></pre></div></div><p>Here is an example for apache. Did you see the <code class=verbatim>"url": "http://%%host%%/website_1"</code> in the <code class=verbatim>instances</code> settings? You can imagine that what will happen if we change this url to a service exposed by kubernetes.</p><div class="src src-yaml"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>apache</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ad.datadoghq.com/apache.check_names</span>: <span style=color:#e6db74>&#39;[&#34;apache&#34;,&#34;http_check&#34;]&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ad.datadoghq.com/apache.init_configs</span>: <span style=color:#e6db74>&#39;[{},{}]&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ad.datadoghq.com/apache.instances</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;apache_status_url&#34;: &#34;http://%%host%%/server-status?auto&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;name&#34;: &#34;&lt;WEBSITE_1&gt;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;url&#34;: &#34;http://%%host%%/website_1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;timeout&#34;: 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;name&#34;: &#34;&lt;WEBSITE_2&gt;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;url&#34;: &#34;http://%%host%%/website_2&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;timeout&#34;: 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ]</span>      
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>apache</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>apache</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>httpd</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>80</span></span></span></code></pre></div></div><p>Actually, datadog didn't care about you container. It only cares about settings you put in the annotations. I use this <code class=verbatim>feature</code> to add checks to my RKE built cluster.</p><p>Here is an example for monitoring components runs on controlplan. Don't forget to allow your datadog daemonset run on your master nodes first. And please take notice about the <code class=verbatim>tolerations</code> and <code class=verbatim>nodeSelector</code> I added in the yaml.</p><div class="src src-yaml"><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>DaemonSet</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>controlplane-monitor</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>controlplane-monitor</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>controlplane-monitor</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>ad.datadoghq.com/kube-scheduler.check_names</span>: <span style=color:#e6db74>&#39;[&#34;kube_scheduler&#34;]&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ad.datadoghq.com/kube-scheduler.init_configs</span>: <span style=color:#e6db74>&#39;[{}]&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ad.datadoghq.com/kube-scheduler.instances</span>: |-<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          [{&#34;prometheus_url&#34;: &#34;http://%%host%%:10251/metrics&#34;, &#34;leader_election&#34;: &#34;true&#34;}]</span>          
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ad.datadoghq.com/kube-controller-manager.check_names</span>: <span style=color:#e6db74>&#39;[&#34;kube_controller_manager&#34;]&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ad.datadoghq.com/kube-controller-manager.init_configs</span>: <span style=color:#e6db74>&#39;[{}]&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ad.datadoghq.com/kube-controller-manager.instances</span>: |-<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          [{&#34;prometheus_url&#34;: &#34;http://%%host%%:10251/metrics&#34;, &#34;leader_election&#34;: &#34;true&#34;}]</span>          
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ad.datadoghq.com/kube-apiserver.check_names</span>: <span style=color:#e6db74>&#39;[&#34;kube_apiserver_metrics&#34;]&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ad.datadoghq.com/kube-apiserver.init_configs</span>: <span style=color:#e6db74>&#39;[{}]&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ad.datadoghq.com/kube-apiserver.instances</span>: |-<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          [{&#34;prometheus_url&#34;: &#34;https://%%host%%:6443/metrics&#34;, &#34;tls_ca_cert&#34;:&#34;/etc/kubernetes/ssl/kube-ca.pem&#34;}]</span>          
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>hostNetwork</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>nodeSelector</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;node-role.kubernetes.io/controlplane&#34;: </span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>tolerations</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>key</span>: <span style=color:#e6db74>&#34;node-role.kubernetes.io/controlplane&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>effect</span>: <span style=color:#e6db74>&#34;NoSchedule&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>restartPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>terminationGracePeriodSeconds</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>busybox</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>sleep</span>
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>infinity</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kube-scheduler</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>busybox</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>sleep</span>
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>infinity</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kube-controller-manager</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>busybox</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>sleep</span>
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>infinity</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kube-apiserver</span></span></span></code></pre></div></div></div><footer class=content__footer></footer></section><section class=page__aside><div class=aside__about><div class=aside__about><img class=about__logo src=https://wdicc.com/favicon.ico alt=Logo><h1 class=about__title>Happy every day!</h1><p class=about__description>Good good study, day day up!</p></div><ul class=aside__social-links><li><a href=https://github.com/wd rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;</li></ul></div><hr><div class=aside__content><p>2020-07-27</p></div></section><footer class=page__footer><p><br><span class=active>$ echo $LANG<br><b>zh_CN</b></span><br></p><br><br><p class=copyright>wd © 2025</p><p class=advertisement>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p></footer></div></body></html>