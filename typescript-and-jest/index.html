<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, viewport-fit=cover, initial-scale=1">
    <title>Typescript and Jest | wd and cc</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <header>

  
  
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://wdicc.com/">/home/wd and cc</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/tags/">~/tags</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/resume/">~/resume</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">~/search</a>
      </li>
      

      
      
      <li class="pull-right">
        <a href="/atom.xml">~/subscribe</a>
      </li>
      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">Typescript and Jest</span></h1>

<h2 class="date">2018/11/01</h2>
<p class="terms">
  
  
  
  
  Tags: <a href="/tags/typescript">typescript</a> <a href="/tags/jest">jest</a> 
  
  
</p>
</div>












<main>
<p>
最近在折腾 typescript，把很多项目改成了 ts 的。有一个老项目，改的过程中感觉各种不踏实，打算还是先写点测试用例，就折腾了一下 jest。各种坑。。。
</p>
<p>
首先需要加一个 <code class="verbatim">tsconfig.json</code>
</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
  <span style="background-color:#fff0f0">&#34;compilerOptions&#34;</span><span style="color:#333">:</span> {
    <span style="background-color:#fff0f0">&#34;target&#34;</span><span style="color:#333">:</span> <span style="background-color:#fff0f0">&#34;es2015&#34;</span>,
    <span style="background-color:#fff0f0">&#34;module&#34;</span><span style="color:#333">:</span> <span style="background-color:#fff0f0">&#34;es2015&#34;</span>,
    <span style="background-color:#fff0f0">&#34;lib&#34;</span><span style="color:#333">:</span> [
      <span style="background-color:#fff0f0">&#34;es2015&#34;</span>
    ],
    <span style="background-color:#fff0f0">&#34;outDir&#34;</span><span style="color:#333">:</span> <span style="background-color:#fff0f0">&#34;./lib&#34;</span>,
    <span style="background-color:#fff0f0">&#34;declaration&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,

    <span style="background-color:#fff0f0">&#34;noEmit&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,
    <span style="background-color:#fff0f0">&#34;moduleResolution&#34;</span><span style="color:#333">:</span> <span style="background-color:#fff0f0">&#34;node&#34;</span>,
    <span style="background-color:#fff0f0">&#34;esModuleInterop&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,
    <span style="background-color:#fff0f0">&#34;allowSyntheticDefaultImports&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,

    <span style="color:#888">/* Strict Type-checking */</span>
    <span style="background-color:#fff0f0">&#34;strict&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,
    <span style="background-color:#fff0f0">&#34;strictNullChecks&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,
    <span style="background-color:#fff0f0">&#34;noImplicitAny&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,
    <span style="background-color:#fff0f0">&#34;noImplicitThis&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,
    <span style="background-color:#fff0f0">&#34;alwaysStrict&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,

    <span style="color:#888">/* Additional Checks */</span>
    <span style="background-color:#fff0f0">&#34;noUnusedLocals&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,                <span style="color:#888">/* Report errors on unused locals. */</span>
    <span style="background-color:#fff0f0">&#34;noUnusedParameters&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,            <span style="color:#888">/* Report errors on unused parameters. */</span>
    <span style="background-color:#fff0f0">&#34;noImplicitReturns&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,             <span style="color:#888">/* Report error when not all code paths in function return a value. */</span>
    <span style="background-color:#fff0f0">&#34;noFallthroughCasesInSwitch&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,    <span style="color:#888">/* Report errors for fallthrough cases in switch statement. */</span>
  },
  <span style="background-color:#fff0f0">&#34;include&#34;</span><span style="color:#333">:</span> [
     <span style="background-color:#fff0f0">&#34;*.ts&#34;</span>
  ],
  <span style="background-color:#fff0f0">&#34;exclude&#34;</span><span style="color:#333">:</span> [
    <span style="background-color:#fff0f0">&#34;node_modules&#34;</span>,
    <span style="background-color:#fff0f0">&#34;__tests__&#34;</span>
  ]
}
</code></pre></td></tr></table>
</div>
</div>
<p>
然后安装一个 <code class="verbatim">typescript</code> 就可以通过 <code class="verbatim">yarn tsc</code> 命令编译了，生成的 js 在 <code class="verbatim">lib</code> 下面。
</p>
<p>
测试如果是用 js 写，那么直接装 <code class="verbatim">jest</code> 就可以了。但是我们既然项目都改成 ts 了，那么还是希望用 ts 写。那就需要用到 <code class="verbatim">ts-jest</code> 。这货的配置可以写到 <code class="verbatim">package.json</code> 里面。
</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
 <span style="background-color:#fff0f0">&#34;name&#34;</span><span style="color:#333">:</span> <span style="background-color:#fff0f0">&#39;test-projct&#39;</span>,
 <span style="background-color:#fff0f0">&#34;version&#34;</span><span style="color:#333">:</span> <span style="background-color:#fff0f0">&#34;0.0.1&#34;</span>,
 ........
 <span style="background-color:#fff0f0">&#34;jest&#34;</span><span style="color:#333">:</span> {
    <span style="background-color:#fff0f0">&#34;preset&#34;</span><span style="color:#333">:</span> <span style="background-color:#fff0f0">&#34;ts-jest&#34;</span>,
    <span style="background-color:#fff0f0">&#34;testEnvironment&#34;</span><span style="color:#333">:</span> <span style="background-color:#fff0f0">&#34;node&#34;</span>,
    <span style="background-color:#fff0f0">&#34;testMatch&#34;</span><span style="color:#333">:</span> [ <span style="background-color:#fff0f0">&#34;**/__tests__/*-test.ts&#34;</span> ],
    <span style="background-color:#fff0f0">&#34;globals&#34;</span><span style="color:#333">:</span> {
      <span style="background-color:#fff0f0">&#34;ts-jest&#34;</span><span style="color:#333">:</span> {
        <span style="background-color:#fff0f0">&#34;babelConfig&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>,
        <span style="background-color:#fff0f0">&#34;isolatedModules&#34;</span><span style="color:#333">:</span> <span style="color:#080;font-weight:bold">true</span>
      }
    }
  }
}
</code></pre></td></tr></table>
</div>
</div>
<p>
<code class="verbatim">isolatedModules</code> 表示说测试的时候先不做 type 检查。我这情况是，要改那些文件比较大一时都弄不好，可能 type 只改了部分，但是这个时候改到某个方法的时候，需要先加测试，以免改前改后不一致，所以这个时候只能忽略掉 type 检查了。
</p>
<p>
这样配置之后，就可以用 ts 写 test 了。test 文件放到 <code class="verbatim">__tests__</code> 目录里面，用 <code class="verbatim">*-test.ts</code> 命名。这样这目录也可以放一些非测试用文件了，比如测试用例用到的一些 mock 文件之类。
</p>
<p>
这样看着一切美好。直到我遇到了一个问题，我的那些需要测试的方法，有些是私有的，又不想因为这个改成 public 的，那么是不是有办法可以测试？这样就找到了 <code class="verbatim">rewire</code> ，这个可以把你的模块的内容随意替换组合，方便你做 mock。我要做的也覆盖了。这样完美了。
</p>
<p>
但是发现，rewire 不支持 typescript。在 ts 文件里面 rewire 一个模块之后，并没有多出来那些 <code class="verbatim">__get__</code> 和 <code class="verbatim">__set__</code> 方法。没仔细去研究代码，找到了 <code class="verbatim">babel-plugin-rewire</code> ，给 <code class="verbatim">package.json</code> 增加配置如下。
</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">  <span style="background-color:#fff0f0">&#34;babel&#34;</span><span style="color:#333">:</span> {
    <span style="background-color:#fff0f0">&#34;presets&#34;</span><span style="color:#333">:</span> [
      <span style="background-color:#fff0f0">&#34;env&#34;</span>
    ],
    <span style="background-color:#fff0f0">&#34;env&#34;</span><span style="color:#333">:</span> {
      <span style="background-color:#fff0f0">&#34;test&#34;</span><span style="color:#333">:</span> {
        <span style="background-color:#fff0f0">&#34;plugins&#34;</span><span style="color:#333">:</span> [
          <span style="background-color:#fff0f0">&#34;babel-plugin-rewire&#34;</span>
        ]
      }
    }
  }
</code></pre></td></tr></table>
</div>
</div>
<p>
发现还是不行，并没有什么效果。查了之后发现，是因为 ts-test 根本不会去调用 babel 的缘故，所以上面的那个 <code class="verbatim">babelConfig</code> 就是这个用途，让 ts-test 去使用 babel。
</p>
<p>
目前还有一个问题是怎么让这个 package 在别人安装使用的时候自动编译为 js，这样让 js 用户也可以用。尝试过在 <code class="verbatim">package.json</code> 里面增加 build 发现不行。
</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"> <span style="background-color:#fff0f0">&#34;scripts&#34;</span><span style="color:#333">:</span> {
    <span style="background-color:#fff0f0">&#34;build&#34;</span><span style="color:#333">:</span> <span style="background-color:#fff0f0">&#34;tsc&#34;</span>,
    <span style="background-color:#fff0f0">&#34;postinstall&#34;</span><span style="color:#333">:</span> <span style="background-color:#fff0f0">&#34;[ -f ../../node_modules/.bin/tsc ] &amp;&amp; ../../node_modules/.bin/tsc || echo &#39;no typescript found, skip build&#39;&#34;</span>,
    <span style="background-color:#fff0f0">&#34;test&#34;</span><span style="color:#333">:</span> <span style="background-color:#fff0f0">&#34;jest&#34;</span>
  },
</code></pre></td></tr></table>
</div>
</div>
<p>
安装这个模块之后在 <code class="verbatim">./node_modules/test-module/</code> 下面执行 <code class="verbatim">tsc</code> 并不会产出 <code class="verbatim">lib</code> 目录的编译文件。
</p>

</main>


<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</section>


    
     <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = '';
            this.page.identifier = '';
        };

        (function() {
          var d = document, s = d.createElement('script');
          s.src = '//wdicc.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
     </script>
    





    <footer style="clear:both">
      
      <hr/>
      Theme from <a href="https://github.com/wd/hugo-classic">hugo-classic</a> fork from <a href="https://github.com/goodroot/hugo-classic">Github</a>
      
    </footer>
  </body>
</html>

