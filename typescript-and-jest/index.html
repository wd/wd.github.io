<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, viewport-fit=cover, initial-scale=1">
    <title>Typescript and Jest | wd and cc</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <header>

  
  

  <link rel="stylesheet" href="https://wdicc.com//css/hljs.css">
  <script src="https://wdicc.com//js/hljs.js"></script>

  <script>hljs.initHighlightingOnLoad();</script>
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://wdicc.com/">/home/wd and cc</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/tags/">~/tags</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/resume/">~/resume</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="https://www.google.com.hk/search?sitesearch=https%3A%2F%2Fwdicc.com%2F&amp;q=">~/search</a>
      </li>
      

      
      
      <li class="pull-right">
        <a href="/atom.xml">~/subscribe</a>
      </li>
      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">Typescript and Jest</span></h1>

<h2 class="date">2018/11/01</h2>
<p class="terms">
  
  
  
  
  Tags: <a href="/tags/typescript">typescript</a> <a href="/tags/jest">jest</a> 
  
  
</p>
</div>












<main>
<p>最近在折腾 typescript，把很多项目改成了 ts 的。有一个老项目，改的过程中感觉各种不踏实，打算还是先写点测试用例，就折腾了一下 jest。各种坑。。。</p>

<p>首先需要加一个 <code>tsconfig.json</code></p>

<pre><code class="language-javascript">{
  &quot;compilerOptions&quot;: {
    &quot;target&quot;: &quot;es2015&quot;,
    &quot;module&quot;: &quot;es2015&quot;,
    &quot;lib&quot;: [
      &quot;es2015&quot;
    ],
    &quot;outDir&quot;: &quot;./lib&quot;,
    &quot;declaration&quot;: true,

    &quot;noEmit&quot;: true,
    &quot;moduleResolution&quot;: &quot;node&quot;,
    &quot;esModuleInterop&quot;: true,
    &quot;allowSyntheticDefaultImports&quot;: true,

    /* Strict Type-checking */
    &quot;strict&quot;: true,
    &quot;strictNullChecks&quot;: true,
    &quot;noImplicitAny&quot;: true,
    &quot;noImplicitThis&quot;: true,
    &quot;alwaysStrict&quot;: true,

    /* Additional Checks */
    &quot;noUnusedLocals&quot;: true,                /* Report errors on unused locals. */
    &quot;noUnusedParameters&quot;: true,            /* Report errors on unused parameters. */
    &quot;noImplicitReturns&quot;: true,             /* Report error when not all code paths in function return a value. */
    &quot;noFallthroughCasesInSwitch&quot;: true,    /* Report errors for fallthrough cases in switch statement. */
  },
  &quot;include&quot;: [
     &quot;*.ts&quot;
  ],
  &quot;exclude&quot;: [
    &quot;node_modules&quot;,
    &quot;__tests__&quot;
  ]
}
</code></pre>

<p>然后安装一个 <code>typescript</code> 就可以通过 <code>yarn tsc</code> 命令编译了，生成的 js 在 <code>lib</code> 下面。</p>

<p>测试如果是用 js 写，那么直接装 <code>jest</code> 就可以了。但是我们既然项目都改成 ts 了，那么还是希望用 ts 写。那就需要用到 <code>ts-jest</code> 。这货的配置可以写到 <code>package.json</code> 里面。</p>

<pre><code class="language-javascript">{
 &quot;name&quot;: 'test-projct',
 &quot;version&quot;: &quot;0.0.1&quot;,
 ........
 &quot;jest&quot;: {
    &quot;preset&quot;: &quot;ts-jest&quot;,
    &quot;testEnvironment&quot;: &quot;node&quot;,
    &quot;testMatch&quot;: [ &quot;**/__tests__/*-test.ts&quot; ],
    &quot;globals&quot;: {
      &quot;ts-jest&quot;: {
        &quot;babelConfig&quot;: true,
        &quot;isolatedModules&quot;: true
      }
    }
  }
}

</code></pre>

<p><code>isolatedModules</code> 表示说测试的时候先不做 type 检查。我这情况是，要改那些文件比较大一时都弄不好，可能 type 只改了部分，但是这个时候改到某个方法的时候，需要先加测试，以免改前改后不一致，所以这个时候只能忽略掉 type 检查了。</p>

<p>这样配置之后，就可以用 ts 写 test 了。test 文件放到 <code>__tests__</code> 目录里面，用 <code>*-test.ts</code> 命名。这样这目录也可以放一些非测试用文件了，比如测试用例用到的一些 mock 文件之类。</p>

<p>这样看着一切美好。直到我遇到了一个问题，我的那些需要测试的方法，有些是私有的，又不想因为这个改成 public 的，那么是不是有办法可以测试？这样就找到了 <code>rewire</code> ，这个可以把你的模块的内容随意替换组合，方便你做 mock。我要做的也覆盖了。这样完美了。</p>

<p>但是发现，rewire 不支持 typescript。在 ts 文件里面 rewire 一个模块之后，并没有多出来那些 <code>__get__</code> 和 <code>__set__</code> 方法。没仔细去研究代码，找到了 <code>babel-plugin-rewire</code> ，给 <code>package.json</code> 增加配置如下。</p>

<pre><code class="language-javascript">  &quot;babel&quot;: {
    &quot;presets&quot;: [
      &quot;env&quot;
    ],
    &quot;env&quot;: {
      &quot;test&quot;: {
        &quot;plugins&quot;: [
          &quot;babel-plugin-rewire&quot;
        ]
      }
    }
  }
</code></pre>

<p>发现还是不行，并没有什么效果。查了之后发现，是因为 ts-test 根本不会去调用 babel 的缘故，所以上面的那个 <code>babelConfig</code> 就是这个用途，让 ts-test 去使用 babel。</p>

<p>目前还有一个问题是怎么让这个 package 在别人安装使用的时候自动编译为 js，这样让 js 用户也可以用。尝试过在 <code>package.json</code> 里面增加 build 发现不行。</p>

<pre><code class="language-javascript"> &quot;scripts&quot;: {
    &quot;build&quot;: &quot;tsc&quot;,
    &quot;postinstall&quot;: &quot;[ -f ../../node_modules/.bin/tsc ] &amp;&amp; ../../node_modules/.bin/tsc || echo 'no typescript found, skip build'&quot;,
    &quot;test&quot;: &quot;jest&quot;
  },
</code></pre>

<p>安装这个模块之后在 <code>./node_modules/test-module/</code> 下面执行 <code>tsc</code> 并不会产出 <code>lib</code> 目录的编译文件。</p>

</main>


<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</section>


    
     <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = '';
            this.page.identifier = '';
        };

        (function() {
          var d = document, s = d.createElement('script');
          s.src = '//wdicc.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
     </script>
    





    <footer style="clear:both">
      
<script async src="//yihui.name/js/center-img.js"></script>

      
      <hr/>
      Theme from <a href="https://github.com/wd/hugo-classic">hugo-classic</a> fork from <a href="https://github.com/goodroot/hugo-classic">Github</a>
      
    </footer>
  </body>
</html>

